define("Router/Controller",["require","exports","Env/Env","Router/Data","Router/MaskResolver","Router/History","Router/UrlRewriter"],function(i,e,r,f,n,u,s){Object.defineProperty(e,"__esModule",{value:true});var c=false;function t(){return!!f.getCoreInstance()}function l(e,t,r){var n=s.get(e.state),a=e.href||e.state,o=u.getCurrentState();if(o.state===n||c)return;var i={state:n,href:a};c=true,R(i).then(function(e){if(c=false,e){if(t)t();else u.push(i);C(i,o)}else if(r)r()},function(e){c=false,r&&r(e)})}function a(e,t,r){f.getRegisteredRoutes()[e.getInstanceId()]={beforeUrlChangeCb:t,afterUrlChangeCb:r}}function o(e){delete f.getRegisteredRoutes()[e.getInstanceId()]}function d(e,t){f.getRegisteredReferences()[e.getInstanceId()]={afterUrlChangeCb:t}}function g(e){delete f.getRegisteredReferences()[e.getInstanceId()]}function v(){if("undefined"!==typeof window){var o=false;window.onpopstate=function(e){if(o)return void(o=false);var t=u.getCurrentState(),r=u.getPrevState();if(!e.state&&!r||e.state&&e.state.id<t.id){var n;l(n=h(r,e.state,e.state||r?f.getRelativeUrl():f.getVisibleRelativeUrl()),function(){return u.back()})}else{var a,n;l(n=h(u.getNextState(),e.state,f.getRelativeUrl()),function(){return u.forward()},function(){o=true,window.history.back()})}}}}function h(e,t,r){if(!e)if(t&&t.state&&t.href)return t;else return{state:s.get(r),href:r};return e}function R(a){var e=u.getCurrentState(),o=n.getAppNameByUrl(a.state),t=n.getAppNameByUrl(e.state);return p(a).then(function(e){if(o===t)return e;else return new Promise(function(r,n){i([o],function(e){if(!e)b("requirejs did not report an error, but '"+o+"' component was not loaded. "+"This could have happened because of circular dependencies or because "+"of the browser behavior. Starting default redirect",a.href),n(new Error("App component is not defined"));else{var t;if(!w(o))p(a).then(function(e){r(e)});r(true)}},function(e){b("Unable to load module '"+o+"', starting default redirect",a.href),n(e)})})})}function p(e){var t=u.getCurrentState(),r=f.getRegisteredRoutes(),n=[];for(var a in r)if(r.hasOwnProperty(a)){var o=r[a];n.push(o.beforeUrlChangeCb(e,t))}return Promise.all(n).then(function(e){return-1===e.indexOf(false)})}function C(e,t){var r=f.getRegisteredRoutes(),n=f.getRegisteredReferences();for(var a in r)if(r.hasOwnProperty(a))r[a].afterUrlChangeCb(e,t);for(var o in n)if(n.hasOwnProperty(o))n[o].afterUrlChangeCb(e,t)}function w(e){var t=f.getCoreInstance();return t&&t.changeApplicationHandler(null,e)}function b(e,t){if(r.IoC.resolve("ILogger").log("Router/Controller",e),window)window.location.href=t}return v(),e.canChangeApplication=t,e.navigate=l,e.addRoute=a,e.removeRoute=o,e.addReference=d,e.removeReference=g,e});