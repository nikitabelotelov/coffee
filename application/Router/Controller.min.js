define("Router/Controller",["require","exports","tslib","Core/Control","Core/IoC","wml!Router/Controller","Router/Registrar","Router/History","Router/Helper","Router/UrlRewriter"],function(s,e,r,t,n,i,u,l,f,d){"use strict";function p(e,t,r){if(!e)if(t&&t.url&&t.prettyUrl)return t;else return{url:d.default.get(r),prettyUrl:r};return e}var a,e;return function(t){function e(e){var a=t.call(this,e)||this;if(a._registrar=null,a._registrarLink=null,a._registrarUpdate=null,a._registrarReserving=null,a._navigateProcessed=false,a._index=0,a._template=i,a._currentRoute=0,"undefined"!==typeof window){a._registrar=new u.default,a._registrarUpdate=new u.default,a._registrarLink=new u.default,a._registrarReserving=new u.default;var o=false;window.onpopstate=function(e){if(o)return void(o=false);var t=l.default.getCurrentState();if(!e.state&&!l.default.getPrevState()||e.state&&e.state.id<t.id){var r,n=p(l.default.getPrevState(),e.state,f.default.getRelativeUrl(!e.state&&!l.default.getPrevState()));a.navigate(e,n.url,n.prettyUrl,function(){l.default.back()})}else{var i,n=p(l.default.getNextState(),e.state,f.default.getRelativeUrl());a.navigate(e,n.url,n.prettyUrl,function(){l.default.forward()},function(){o=true,history.back()})}}}return a}return r.__extends(e,t),e.prototype.applyUrl=function(){this._registrarUpdate.startAsync({},{}),this._registrarLink.startAsync({},{})},e.prototype.startAsyncUpdate=function(e,t){var r=l.default.getCurrentState();return this._registrar.startAsync({url:e,prettyUrl:t},{url:r.url,prettyUrl:r.prettyUrl}).then(function(e){return false!==e.find(function(e){return false===e})})},e.prototype.beforeApplyUrl=function(e,i){var a=this,t=l.default.getCurrentState(),o=d.default.get(e),u=f.default.getAppNameByUrl(o),r=f.default.getAppNameByUrl(t.url);return this.startAsyncUpdate(o,i).then(function(e){if(u===r)return e;else return new Promise(function(r,n){s([u],function(e){if(!e)a._handleAppRequireError("requirejs did not report an error, but '"+u+"' component was not loaded. "+"This could have happened because of circular dependencies or because "+"of the browser behavior. Starting default redirect",i),n(new Error("App component is not defined"));else{var t;if(!a._notify("changeApplication",[u],{bubbling:true}))a.startAsyncUpdate(o,i).then(function(e){r(e)});r(true)}},function(e){a._handleAppRequireError("Unable to load module '"+u+"', starting default redirect",i),n(e)})})})},e.prototype.navigate=function(e,t,r,n,i){var a=this,o=d.default.get(t),u=r||t,s;if(l.default.getCurrentState().url===o||this._navigateProcessed)return;this._navigateProcessed=true,this.beforeApplyUrl(o,u).then(function(e){if(a._navigateProcessed=false,e){if(n)n();else l.default.push(o,u);a.applyUrl()}else if(i)i()},function(e){if(a._navigateProcessed=false,i)i(e)})},e.prototype.routerCreated=function(e,r){var n=this;this._registrar.register(e,r,function(e,t){return r.beforeApplyUrl(e,t)}),this._registrarUpdate.register(e,r,function(e,t){return r.applyNewUrl()}),this._registrarReserving.register(e,r,function(e){var t=r._reserve(n._index,e);if(-1!==t)n._index=t})},e.prototype.routerDestroyed=function(e,t,r){this._registrar.unregister(e,t),this._registrarUpdate.unregister(e,t),this._registrarReserving.unregister(e,t)},e.prototype.linkCreated=function(e,t){this._registrarLink.register(e,t,function(){return t.recalcHref()})},e.prototype.linkDestroyed=function(e,t){this._registrarLink.unregister(e,t)},e.prototype._handleAppRequireError=function(e,t){if(n.resolve("ILogger").log("Router/Controller",e),window)window.location.href=t},e}(t)});