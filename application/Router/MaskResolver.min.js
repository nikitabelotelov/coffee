define("Router/MaskResolver",["require","exports","Env/Env","Router/Data","Router/UrlRewriter"],function(e,n,i,s,v){function r(e,n){return a(e),g(o(e,{},n))}function f(e,n){return a(e),O(o(e,n))}function t(e,n){var i;return a(e),n=n.clear?{}:n,d(v.get(s.getRelativeUrl()),e,n)}function u(e){return E(e=v.get(e))+"/Index"}function a(e){if(-1!==e.indexOf("/")&&-1!==e.indexOf("="))i.IoC.resolve("ILogger").error("Router.MaskResolver",'Mask "'+e+'" is invalid')}Object.defineProperty(n,"__esModule",{value:true}),n.calculateUrlParams=r,n.calculateCfgParams=f,n.calculateHref=t,n.getAppNameByUrl=u;var p="/undefined/undefined/undefined/undefined/undefined/undefined/undefined/undefined/undefined/undefined";function x(e){var n=e.match(/[?#]/);if(n){var i=n.index;return{path:e.substring(0,i).replace(/\/$/,""),misc:e.slice(i)}}return{path:e.replace(/\/$/,""),misc:""}}function o(e,n,i){var r=[],f=m(e,function(e){r.push({name:e.name,value:n[e.name]})}),t=i||s.getRelativeUrl(),u=x(t),a=u.path,l=u.misc;t=a+p+l;var c,d=v.get(t).match(f);if(d)for(var o=2;o<d.length-1;o++)if(r[o-2].urlValue=decodeURIComponent(d[o]),"undefined"===r[o-2].urlValue)r[o-2].urlValue=void 0;return r}function m(e,n){var i=l(e),r=[];c(i,function(e){r.push({prefixEnd:e.prefixEnd,suffixStart:e.suffixStart}),n&&n(e)});for(var f=r.length-1;f>=0;f--)i=i.slice(0,r[f].prefixEnd)+"([^\\/?&#]+)"+i.slice(r[f].suffixStart);return i}function l(e){var n=e;if(-1!==n.indexOf("/"))if("/"===n[0])n="([/]|.*?\\.html/)"+n.slice(1);else n="(.*?/)"+n;else if(-1!==n.indexOf("="))n="(.*?\\?|.*?&)"+n;else n="(.*?/)"+n;if(-1!==n.indexOf("="))n+="(#.*|&.+)?";else n+="(#.*|/.*|\\?.+)?";return n}function c(e,n){var i=/:(\w+)/g,r=i.exec(e);while(r)n({prefixEnd:r.index,suffixStart:r.index+r[0].length,name:r[1]}),r=i.exec(e)}function g(e){var n={};return e.forEach(function(e){n[e.name]=void 0===e.urlValue?void 0:decodeURIComponent(e.urlValue)}),n}function O(e){var n={};return e.forEach(function(e){n[e.name]=e.value}),n}function d(e,n,i){var r=o(n,i),f=O(r),t,u=h(n,g(r)),a=h(n,f),l=e;if(a&&"/"===a[0])l=a;else if(u)if(a)l=e.replace(u,a);else if(-1!==e.indexOf("/"+u))l=e.replace("/"+u,"");else if(-1!==e.indexOf("?"+u)){var c;if(-1!==e.indexOf("?"+u+"&"))l=e.replace("?"+u+"&","?");else l=e.replace("?"+u,"")}else if(-1!==e.indexOf("&"+u))l=e.replace("&"+u,"");else l=e.replace(u,"");else if(a){var d=e.indexOf("?");if("/"===a[0])l=a;else if(-1!==a.indexOf("="))if(-1!==d)l+="&"+a;else l+="?"+a;else if(-1!==d)l=R(e.slice(0,d))+a+e.slice(d);else l=R(e)+a}return l}function h(i,r){var f=0,t=0;c(i,function(e){if(f++,void 0!==r[e.name]){var n=r[e.name];if("string"!==typeof n)n=JSON.stringify(n);n=encodeURIComponent(n),i=i.replace(":"+e.name,n),t++}});var e="";if(t===f)e=i;return e}function R(e){if("/"===e[e.length-1])return e;else return e+"/"}function E(e){var n=e||"";if(-1!==n.indexOf("?"))n=n.replace(/\?.*/,"");if(-1!==n.indexOf("#"))n=n.replace(/#.*/,"");if(-1!==n.indexOf("/"))n=n.split("/")[1];return n}return n});