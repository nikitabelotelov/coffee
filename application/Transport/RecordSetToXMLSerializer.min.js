define("Transport/RecordSetToXMLSerializer",["Core/helpers/axo","Core/core-instance","Core/IoC"],function(t,E,F){var e;function _(e){if("string"==typeof e)e=e.replace(/[^\x09\x0A\x0D\x20-\uD7FF\uE000-\uFFFD\u10000-\u10FFFF]*/g,"");return e}return e={_complexFields:{"Связь":true,"Иерархия":true,"Перечисляемое":true,"Флаги":true,"Массив":true,"Запись":true,"Выборка":true},_wordsToTranslate:{"Дата":"Date","Время":"Time","Строка":"String","Текст":"Text","Логическое":"Boolean","Деньги":"Money","Двоичное":"Binary","Файл-rpc":"RPCFile","Временной интервал":"TimeInterval","Идентификатор":"ID","JSON-объект":"JSON-object"},_colNameToTag:{"Число целое":"Integer","Число вещественное":"Double","Дата и время":"DateTime"},_branchTypes:{true:"Node",false:"Leaf",null:"HiddenNode"},serialize:function(e,t,r,i){var a=this._createXMLDocument(),l=E.instanceOfModule(e,"Deprecated/Record")?[e]:e;return this._serializeObject(l,a,a),this._serializeColumns(t,l,a,r,i),a},_serializeColumns:function(e,t,r,i,a){var l="",n,o;if(e&&e instanceof Array&&e.length>0){r.documentElement.appendChild(n=r.createElement("Columns"));for(var c=0,d=e.length;c<d;c++)n.appendChild(o=r.createElement("Column")),o.setAttribute("Name",e[c].title),o.setAttribute("Field",e[c].field)}if(E.instanceOfModule(t,"Deprecated/RecordSet"))l=t.getHierarchyField();if(t instanceof Array&&E.instanceOfModule(t[0],"Deprecated/Record")&&null!==t[0].getRecordSet()){var s=t[0].getRecordSet();if(s)l=s.getHierarchyField()}if(""!==l)r.documentElement.setAttribute("HierarchyField",l),r.documentElement.setAttribute("HierarchyName",void 0===i?"":i),r.documentElement.setAttribute("Root",a?a+"":"")},_serializeObject:function(e,t,r){var i,a,l=[],n,o;if(E.instanceOfModule(e,"Deprecated/RecordSet")){t.appendChild(a=r.createElement("RecordSet")),e.rewind();while(false!==(i=e.next()))this._serializeObject(i,a,r)}else if(e instanceof Array){t.appendChild(a=r.createElement("RecordSet"));for(var c=e.length,d=0;d<c;d++)this._serializeObject(e[d],a,r)}else if(E.instanceOfModule(e,"Deprecated/Record")){t.appendChild(n=r.createElement("Record"));var s=e.getKey();if(null===s)s="null";n.setAttribute("RecordKey",_(s+"")),l=e.getColumns(),o=null===e.getRecordSet()?l[0]:l[e.getRecordSet().getPkColumnIndex()],n.setAttribute("KeyField",o);for(var p=0,u=l.length;p<u;p++)this._serializeField(l[p],e,n,r)}},_serializeField:function(e,t,r,i){var a,l,n,o,c=/[а-я]+/gi;a=t.getColumnDefinition(e),r.appendChild(l=i.createElement("Field")),l.setAttribute("Name",a.title);var d=null===t.get(a.title)?"":t.get(a.title),s="object"==typeof a.type?a.type.n:a.type;if(!this._complexFields[s]&&!a.s&&!this._complexFields[a.s]){var p;if(n=this._colNameToTag[a.type]?this._colNameToTag[a.type]:a.type,n=this._wordsToTranslate[n]?this._wordsToTranslate[n]:n,c.test(n))F.resolve("ILogger").error("XSLT",rk("Внимание! Кирилический тэг без замены:")+" "+n);if(o=i.createElement(n),d instanceof Date){if("Дата и время"==a.type)d=d.toSQL()+"T"+d.toTimeString().replace(" GMT","").replace(/\s[\w\W]*/,"");if("Дата"==a.type)d=d.toSQL();if("Время"==a.type)d=d.toTimeString().replace(" GMT","").replace(/\s[\w\W]*/,"")}d=_(d+""),o.appendChild(i.createTextNode(d)),l.appendChild(o)}else if("Связь"==s)(o=i.createElement("Link")).setAttribute("Table","object"==typeof a.type?a.type.t:a.table),o.appendChild(i.createTextNode(d)),l.appendChild(o);else if("Иерархия"==s||a.s&&"Иерархия"==a.s){var u,f;if(l.appendChild(o=i.createElement("Hierarchy")),o.appendChild(u=i.createElement("Parent")),o.appendChild(f=i.createElement("NodeType")),"object"==typeof a.type)o.setAttribute("HierarchyName",a.type.f+""),u.appendChild(i.createTextNode(d[1]+"")),f.appendChild(i.createTextNode(this._branchTypes[d[0]+""]));else if("Идентификатор"==s){if(o.setAttribute("HierarchyName",a.titleColumn+""),u.appendChild(i.createTextNode(d+"")),t.hasColumn(a.title+"@"))d=this._branchTypes[t.get(a.title+"@")+""],f.appendChild(i.createTextNode(d))}else r.removeChild(l)}else if("Перечисляемое"==s){var m;for(var h in l.appendChild(o=i.createElement("Enumerable")),(d=d.toObject()).availableValues)if(d.availableValues.hasOwnProperty(h)){o.appendChild(m=i.createElement("Variant")),m.setAttribute("Value",h);var y=d.availableValues[h];if(null===y)y="";if(m.setAttribute("Title",y),h==d.currentValue)m.setAttribute("Checked","true")}}else if("Флаги"==s){var C;if(l.appendChild(o=i.createElement("Flags")),d)for(var T in d=d.toObject())if(d.hasOwnProperty(T))o.appendChild(C=i.createElement("Flag")),C.setAttribute("Title",T),C.setAttribute("Condition",d[T]+"")}else if("Массив"==s){var b;l.appendChild(o=i.createElement("Array")),o.setAttribute("DataType","object"==typeof a.type?a.type.t:a.arrayType);for(var g=0,v=d.length;g<v;g++)o.appendChild(b=i.createElement("Value")),b.appendChild(i.createTextNode(_(d[g]+"")))}else if(E.instanceOfModule(d,"Deprecated/RecordSet")||E.instanceOfModule(d,"Deprecated/Record"))this._serializeObject(d,l,i)},_createXMLDocument:function(){var e;if(document.implementation&&document.implementation.createDocument)e=document.implementation.createDocument("","",null);if(t)e=t("Microsoft.XmlDom");return e}}});