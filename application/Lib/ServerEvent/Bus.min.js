define("Lib/ServerEvent/Bus",["require","exports","Core/Deferred","Core/constants","Core/EventBus","Core/UserInfo","Core/LocalStorageNative","Core/IoC","Lib/ServerEvent/_class/Constants","Lib/ServerEvent/_class/logger/WatchDogAggregator","Lib/ServerEvent/_class/Subscribe","Lib/ServerEvent/_class/SubscribeContainer","Lib/ServerEvent/_class/transport/ExclusiveProxy","Lib/ServerEvent/_class/Events","Lib/ServerEvent/_class/logger/ConnectWatchDog","Lib/ServerEvent/_class/logger/Bit"],function(e,r,i,s,t,n,c,o,a,b,u,h,l,f,v,d){"use strict";var C="00000003",g=n.getCurrent(),p=0===(g="string"===typeof g?g:"").indexOf(C);c.setItem("shared-bus-ack","true");var E=[a.CHANNEL_SCOPE.GLOBAL],S=function(){function e(e){if(void 0===e)e="Это приложение не имеет серверных событий";this.message=e}return e}(),D,L=new(function(){function e(){this.subscribes=new h.SubscribeContainer,this.isExclusive=false,this.watcher=new b.WatchDogAggregator([new v.ConnectWatchDog]),this.initDeferred=new i,this.subscribe=this.subscribeInit.bind(this),this.closeChannel=this.closeChannel.bind(this),this.closeTransportBehavior=this.closeTransportBehavior.bind(this)}return e.prototype.subscribe=function(e){},e.prototype.subscribeClear=function(e,r){if(this.subscribes.has(r))return;this.subscribes.add(r);try{e.subscribe(r)}catch(e){if("SubscribeExclusiveError"!==e.name)throw e;this.isExclusive=true,this.reconnect()}},e.prototype.subscribeBeforeReconnect=function(e){if(this.subscribes.has(e))return;this.subscribes.add(e)},e.prototype.subscribeDeferred=function(r){var s=this;this.initDeferred.addCallback(function(e){return s.subscribeClear(e,r),e})},e.prototype.subscribeInit=function(r){var s=this;this.subscribe=this.subscribeDeferred,this.subscribeDeferred(r);try{l.ExclusiveProxy.init(this.isExclusive||r.getDeliveryType()!==a.DELIVERY_COMMON,this.closeTransportBehavior,this.watcher).addCallback(function(e){if(s.subscribe=s.subscribeClear.bind(s,e),p&&!s.bitSensor)s.bitSensor=new d.Bit(t);s.initDeferred.callback(e)}).addErrback(function(e){if(404===e.httpError)s.initDeferred=void 0,o.resolve("ILogger").warn((new S).message),s.subscribe=function(){};o.resolve("ILogger").warn("Не удалось подписаться на "+r.getChannelName())})}catch(e){this.subscribe=function(){}}},e.prototype.addWatchDog=function(e){this.watcher.reg(e)},e.prototype.closeTransportBehavior=function(e){if(this.watcher.logDisconnect(e),e===f.EVENT_DISABLE_SEB)return;this.reInit()},e.prototype.reInit=function(){this.initDeferred=new i,this.subscribe=this.subscribeInit;var e=this.subscribes.all();this.subscribes.clear();for(var r=0,s=e;r<s.length;r++){var t=s[r];this.subscribe(t)}},e.prototype.reconnect=function(){var r=this;if(!this.initDeferred)return this.reInit();this.initDeferred.addCallbacks(function(e){return r.subscribe=r.subscribeBeforeReconnect.bind(r),e.close(),e},function(){r.reInit()})},e.prototype.closeChannel=function(n){var c=this;this.initDeferred.addCallback(function(e){for(var r,s=0,t=c.subscribes.removeByName(n);s<t.length;s++){var i=t[s];e.unsubscribe(i)}return e})},e}());function w(e,r){var i=e.toLocaleLowerCase(),s=t.channel(i),n=r||{};return setTimeout(function(){if(!n.isChanneled)return void L.subscribe(u.Subscribe.create(i,n.isChanneled,n.exclusive));if(!n.scopes)o.resolve("ILogger").error("В канализированных событиях необходимо указать options.scopes.             https://wi.sbis.ru/docs/js/Lib/ServerEvent/Bus/typedefs/ConnectOptions/?v=3.18.10");for(var e,r=0,s=n.scopes||E;r<s.length;r++){var t=s[r];L.subscribe(u.Subscribe.createRaw(i,n.isChanneled,n.exclusive,t))}},0),s}if(w["reconnect"]=function(){L.reconnect()},w["close"]=function(e){L.closeChannel(e)},w["SCOPE"]=a.CHANNEL_SCOPE,t["addWatchDog"]=function(e){L.addWatchDog(e)},s.isBrowserPlatform)t["serverChannel"]=w;else t["serverChannel"]=function(e){return t.channel(e)};return t});