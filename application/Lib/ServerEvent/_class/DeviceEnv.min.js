define("Lib/ServerEvent/_class/DeviceEnv",["require","exports","Core/Deferred","Core/IoC","Transport/XHRTransport","Lib/ServerEvent/_class/Constants","Lib/ServerEvent/_class/ConnectOptions"],function(e,t,a,i,c,u,s){"use strict";function f(){var e;return document.cookie.split("; ").filter(function(e){return"sid="==e.substr(0,4)}).map(function(e){return e.substr(4)}).pop()}Object.defineProperty(t,"__esModule",{value:true});var l=2*1e3,d=6e4,p=1e4,r=function(){function o(){}return o.getConnectData=function(t){if(!t)t=Math.round(Math.random()*p);if(t>d)t=d;var r=new a,n=Date.now();return new c({url:"/!hash/",method:"GET",dataType:"json"}).execute().addCallback(function(e){if(Date.now()-n>l)i.resolve("ILogger").warn("[STOMP][timeout] /!hash/ request to long: "+(Date.now()-n)+"ms");r.callback(e.result)}).addErrback(function(e){if(404===e.httpError)return void r.errback(e);if(0===e.httpError)t=p;setTimeout(function(){o.getConnectData(t+Math.round(1e4*Math.random())).addCallback(function(e){r.callback(e)})},t)}),r},o.getOptions=function(){var i=new a;return o.getConnectData().addCallbacks(function(e){var t=e.sid;if(!t)t=f();if(!t)throw new Error(u.ERR_MSG_EMPTY_SID);if(!e.user)return new Error(u.ERR_MSG_HASH_401);var r=e.cid;if(!r)r=t.substr(0,8);var n=e.uid,o;if(!n)n=t.substr(9,8);if(!!e.url)o=s.ConnectOptions.createForDesktop(t,e.user,e.url,r,n);var a="/stomp/";if(!!e.path)a=e.path;if(e.domain)o=new s.ConnectOptions(t,e.user,location.protocol,e.domain,a,e.exchange,r,n);if(!o)o=s.ConnectOptions.createByLocation(t,e.user,a,r,n);i.callback(o)},function(e){i.errback(e)}),i},o}();t.DeviceEnv=r});