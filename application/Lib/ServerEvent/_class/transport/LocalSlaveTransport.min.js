define("Lib/ServerEvent/_class/transport/LocalSlaveTransport",["require","exports","tslib","Lib/Tab/Message","Lib/Storage/LocalStorage","Lib/ServerEvent/_class/transport/Constants","Lib/ServerEvent/_class/transport/Transport","Lib/ServerEvent/_class/SubscribeContainer","Lib/ServerEvent/_class/Events"],function(e,t,n,r,s,a,i,o,c){"use strict";Object.defineProperty(t,"__esModule",{value:true});var l=function(i){function e(){var e=i.call(this)||this;return e.ls=new s(a.LS_PREFIX),e.taber=new r,e.subscribes=new o.SubscribeContainer,e.minInterval=2*a.CHECK_MIN_INTERVAL+Math.floor(Math.random()*a.RECONNECT_INTERVAL),e.setDisconnectHandler(function(){}),e.subMainReady=function(){if(!e.subscribes.hasChanneled())return;e.destructor("Reconnect to resubscribe")},e.taber.subscribe(a.KEY_MAINREADY,e.subMainReady),e.unloadWindow=e.unloadWindow.bind(e),window.addEventListener("unload",e.unloadWindow),e.taber.notify(a.KEY_NEW_PAGE,""),e}return n.__extends(e,i),e.prototype.getLocalName=function(){return e.getLocalName()},e.getLocalName=function(){return"LocalSlaveTransport"},e.prototype.subscribe=function(e){this.subscribes.add(e),this.taber.notify(a.KEY_SUBSCRIBE,e)},e.prototype.unsubscribe=function(e){this.subscribes.remove(e),this.taber.notify(a.KEY_UNSUBSCRIBE,e)},e.prototype.destructor=function(e,t){if(void 0===t)t=true;if(this.taber.unsubscribe(a.KEY_MAINREADY,this.subMainReady),this.mainChecker)clearInterval(this.mainChecker),this.mainChecker=void 0;this.taber=void 0,window.removeEventListener("unload",this.unloadWindow);var n=this.disconnectCallback;if(this.disconnectCallback=function(){},i.prototype.destructor.call(this),t){var r;n(e?c.create(e):void 0)}},e.prototype.setDisconnectHandler=function(e){var n=this;if(this.disconnectCallback=e,this.mainChecker)clearInterval(this.mainChecker);this.mainChecker=setInterval(function(){var e,t;if(n.ls.getItem(a.KEY_ACTUAL_DATE)+n.minInterval>Date.now())return;if((n.ls.getItem(a.KEY_TRY_CREATE_MAIN)||0)+a.RECONNECT_INTERVAL>Date.now())return;n.ls.setItem(a.KEY_TRY_CREATE_MAIN,Date.now()),n.destructor("Main is dead")},this.minInterval)},e.prototype.unloadWindow=function(){this.close(false)},e.prototype.close=function(e){if(void 0===e)e=true;for(var t=0,n=this.subscribes.all();t<n.length;t++){var r=n[t];this.taber.notify(a.KEY_UNSUBSCRIBE,r)}this.destructor("closeWindow",e)},e}(i.Transport);t.LocalSlaveTransport=l});