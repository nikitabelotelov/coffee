define("Lib/ServerEvent/_class/transport/LocalMainTransport",["require","exports","Core/UserInfo","Core/LocalStorageNative","Lib/Tab/Message","Lib/Storage/LocalStorage","Lib/ServerEvent/_class/transport/Constants","Lib/ServerEvent/_class/transport/LocalPageTransport","Lib/ServerEvent/_class/Events","Lib/ServerEvent/_class/Subscribe"],function(t,e,o,c,u,b,h,l,E,f){"use strict";Object.defineProperty(e,"__esModule",{value:true});var s=function(){function t(t,e,s,r){if(void 0===s)s=true;var i=this;this.stomp=t,this.hash=e,this.persistent=s,this.exchangeName=r,this.ls=new b(h.LS_PREFIX),this.taber=new u,this.isAloneMain=true,this.fixMain();var n=Date.now();this.taber.notify(h.KEY_MAINREADY,n),this.fnQuit=function(t,e){if(e<n)return;i.taber.unsubscribe(h.KEY_MAINREADY,i.fnQuit),i.isAloneMain=false,i.close(E.EVENT_LATER_MAIN_TRANSPORT)},this.taber.subscribe(h.KEY_MAINREADY,this.fnQuit),this.taber.subscribe(h.KEY_NEW_PAGE,function(t){if(!o.isValid())i.fnQuit(t,new Date)}),this.ls.removeItem(h.KEY_TRY_CREATE_MAIN),this.mainChecker=setInterval(function(){i.fixMain()},h.CHECK_MIN_INTERVAL);var a="true"===c.getItem("shared-bus-ack");this.transport=new l.LocalPageTransport(t,e,s,r,a),this.subFromTaber=function(t,e){i.subscribe(f.Subscribe.create(e.channelName,e.channeled,false,e.target))},this.unsubFromTaber=function(t,e){i.unsubscribe(f.Subscribe.create(e.channelName,e.channeled,false,e.target))},this.taber.subscribe(h.KEY_SUBSCRIBE,this.subFromTaber),this.taber.subscribe(h.KEY_UNSUBSCRIBE,this.unsubFromTaber),window&&window.addEventListener("unload",function(){i.close(E.EVENT_DISABLE_SEB)})}return t.prototype.fixMain=function(){this.ls.setItem(h.KEY_ACTUAL_DATE,Date.now())},t.getLocalName=function(){return"LocalMainTransport"},t.prototype.getLocalName=function(){return t.getLocalName()},t.prototype.subscribe=function(t){this.transport.subscribe(t)},t.prototype.unsubscribe=function(t){this.transport.unsubscribe(t)},t.prototype.destructor=function(t){if(this.taber)this.taber.unsubscribe(h.KEY_SUBSCRIBE,this.subFromTaber),this.taber.unsubscribe(h.KEY_UNSUBSCRIBE,this.unsubFromTaber),this.taber.unsubscribe(h.KEY_MAINREADY,this.fnQuit),this.taber=void 0;if(this.isAloneMain)this.ls.removeItem(h.KEY_ACTUAL_DATE);clearInterval(this.mainChecker);var e=this.disconnectCallback;if(this.disconnectCallback=function(){},!e)return;e(t)},t.prototype.setDisconnectHandler=function(t){var e=this;this.disconnectCallback=t,this.transport.setDisconnectHandler(function(t){e.destructor(t)})},t.prototype.close=function(t){this.transport.close(),this.destructor(t)},t.prototype.setDelivery=function(t){this.transport.setDelivery(t)},t.prototype.setWatchDog=function(t){this.transport.setWatchDog(t)},t}();e.LocalMainTransport=s});