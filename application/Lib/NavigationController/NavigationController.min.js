define("Lib/NavigationController/NavigationController",["Core/constants","Core/EventBus","Core/Deferred","Core/core-clone","Core/HashManager","Core/cookie"],function(t,e,a,o,h,n){"use strict";var s;return{_storageByStateKey:{},_waitingByStateKey:{},_luntik:null,_storage:[],_needToParseHash:false,init:function(){var n=this;if(t.saveLastState){if(this._loadLastState(),!t.$win)t.$win=$(window),t.$doc=$(document);if(t.$win.on("unload",function(){if(!window.location.search)n._saveLastState()}),t.browser.isMobileSafari)window.addEventListener("pagehide",function(){n._saveLastState()})}this._initLuntikHandler(),this._parseHash(),h.subscribe("onChange",function(){var t=true,e=h.get("ws-nc"),a,s;if((e=e?e.split(";"):[]).length==n._storage.length){t=false;for(var i=e.length-1;i>=0;i--)if(a=e[i].split("="),s=String(n._storage[i].state).replace(/;|=|%/g,function(t){return{";":":s:","=":":e:","%":":p:"}[t]}),n._storage[i].stateKey!=a[0]||s!=a[1]){t=true;break}}if(t||n._needToParseHash)n._needToParseHash=false,n._parseHash()})},_initLuntikHandler:function(){var s=this,t;e.channel("luntik").subscribe("onInit",function(t,e){var a=e.getStateKey();if(a){if(s._storageByStateKey[a]=e,s._waitingByStateKey[a]&&!s._waitingByStateKey[a].isReady())try{s._waitingByStateKey[a].callback(e)}finally{delete s._waitingByStateKey[a]}e.subscribe("onDestroy",function(){delete s._storageByStateKey[this.getStateKey()]})}})},_containsByStateKey:function(t){return!!this._storageByStateKey[t]},_getByStateKey:function(t){return this._storageByStateKey[t]},_waitByStateKey:function(t){return this._waitingByStateKey[t]=this._waitingByStateKey[t]||new a},_getHashWithoutMSID:function(){return decodeURI(window.location.hash).replace(/(&msid=s\d+)|(msid=s\d+&?)/g,"").replace(/^#*/g,"")},_saveLastState:function(){var t=decodeURI(window.location.pathname),e={},a=n.get("sid"),s=this._getHashWithoutMSID(),i=this._getLastState();if(i&&i.hasOwnProperty(a))i[a][t]=s,e=i;else(e={})[a]={},e[a][t]=s;this._setLastState(e)},_loadLastState:function(){var t=decodeURI(window.location.pathname),e=this._getHashWithoutMSID(),a=n.get("sid"),s=this._getLastState(),i;if(!window.location.search&&!e.length&&s&&s[a]&&(i=s[a][t]))h.setHash([window.location.hash.replace(/^#/,""),i].join(window.location.hash.length?"&":""),true)},_getLastState:function(){try{return JSON.parse(window.localStorage.getItem("lastState"))}catch(t){return}},_setLastState:function(t){try{window.localStorage.setItem("lastState",JSON.stringify(t))}catch(t){}},updateStateForce:function(t,e,a){this.updateState(t,e,a,true)},_checkAndSaveState:function(t){for(var e in this._storage)if(t?this._storage[e].stateKey===t&&!this._storage[e].saved:!this._storage[e].saved)return void h.pushState()},saveAllStates:function(){for(var t in this._storage)if(this._storage.hasOwnProperty(t))this._storage[t].saved=true},updateState:function(t,e,a,s){if(t){for(var i=0,n=this._storage.length;i<n;i++)if(this._storage[i].stateKey==t){if(!s&&!this._storage[i].applied)return;if(this._storage[i].state!==e&&!a)this._checkAndSaveState();return this._storage[i].state=e,this._updateHash(!this._storage[i].saved?a:true,[],this._storage[i].saved),void(this._storage[i].saved=false)}this._pushState(t,e,true,false),this._updateHash(true,[],true)}},setState:function(t,e){var a={};if(!t)throw new Error("NavigationController.setState :: wrong control stateKey");if("object"==typeof t)a=t;else a[t]=e;for(var s in a)if(a.hasOwnProperty(s))if(void 0===a[s]&&this._containsByStateKey(s))this.removeState(this._getByStateKey(s));else{for(var i=false,n=0,r=this._storage.length;n<r;n++)if(this._storage[n].stateKey==s)if(i=true,this._storage[n].state!==a[s])this._storage[n].state=a[s],this._needToParseHash=true;if(!i)this._pushState(s,a[s]),this._needToParseHash=true}this._updateHash()},_pushState:function(t,e,a,s){if(void 0===s)s=true;this._storage.push({stateKey:t,state:e,applied:a,saved:s})},_updateHash:function(t,e,a){var s=[];if(!e)e=[];for(var i=0,n=this._storage.length;i<n;i++)if(-1===e.indexOf(this._storage[i].stateKey))s.push([this._storage[i].stateKey,(""+this._storage[i].state).replace(/;|=|%/g,function(t){return{";":":s:","=":":e:","%":":p:"}[t]})].join("="));h.set("ws-nc",s.join(";"),t,a)},_removeFromHash:function(t,e){var a=decodeURI(h.get("ws-nc")),s=[];(a=a?a.split(";"):[]).forEach(function(t){s.push(t.split("=")[0])});for(var i=t.length-1;i>=0;i--)if(-1===s.indexOf(t[i]))t.splice(i,1);if(t.length)this._updateHash(true,t,e)},_parseHash:function(){var t=decodeURI(h.get("ws-nc")),e,a=o(this._storage),s;if(this._storage=[],"undefined"==t)return void this._checkChangeState([],a);t=t?t.split(";"):[],this._checkChangeState(t,a);for(var i=0,n=t.length;i<n;i++)if(!!t[i]){for(var r in s=false,e=t[i].split("="),a)if(a[r].stateKey===e[0]){s=true;break}this._pushState(e[0],e[1].replace(/:(s|e|p):/g,function(t,e){return{s:";",e:"=",p:"%"}[e]}),false,s)}this._buildChain()},_checkChangeState:function(t,e){var a=this,s=[];if(!t.length)this._storage=[];t.forEach(function(t){s.push(t.split("=")[0])}),e.forEach(function(t){if(-1===s.indexOf(t.stateKey))a._checkAndApplyEmptyState(t.stateKey)})},_checkAndApplyEmptyState:function(t){var e=t;if("string"===typeof t)if(this._containsByStateKey(t))e=this._getByStateKey(t);if("function"===typeof e.applyEmptyState)e.applyEmptyState()},getStateByKey:function(t){for(var e=0,a=this._storage.length;e<a;e++)if(this._storage[e].stateKey==t)return this._storage[e]},_buildChain:function(){var s=this,t,e=this._storage.concat();function a(a){return a.once("onStateChanged",function t(){var e=s.getStateByKey(a.getStateKey());if(e)e.applied=true,a.applyState(e.state)}),a}for(var i=0,n=e.length;i<n;i++){if(!(t=e[i]).stateKey)continue;if(this._containsByStateKey(t.stateKey)){var r=this._getByStateKey(t.stateKey);t.applied=true,r.applyState(t.state)}else this._waitByStateKey(t.stateKey).addCallback(a)}},removeState:function(t,e){var a=t.getStateKey(),s;if(a)for(var i=this._storage.length-1;i>=0;i--){var n=this._storage[i];if(n.stateKey===a){s=n.stateKey,this._checkAndSaveState(a);var r=n.saved;if(this._storage.splice(i,1),this._removeFromHash([s],r),e||void 0===e)this._checkAndApplyEmptyState(t);break}}}}});