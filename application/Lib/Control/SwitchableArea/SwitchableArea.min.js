define("Lib/Control/SwitchableArea/SwitchableArea",["Core/core-merge","Core/helpers/Hcontrol/replaceContainer","Core/helpers/collection","Core/Deferred","Core/moduleStubs","Lib/Control/CompoundControl/CompoundControl","Lib/Control/SwitchableArea/SwitchableAreaItem","tmpl!Lib/Control/SwitchableArea/SwitchableArea","tmpl!Lib/Control/SwitchableArea/SwitchableArea_area","Core/helpers/Number/randomId","Core/constants","Core/Sanitize","Core/IoC"],function(l,h,s,c,a,e,r,t,i,n,u,o,_){"use strict";var d=e.extend({_dotTplFn:t,$protected:{_areaHashMap:{},_bindedHandlers:void 0,_currentAreaId:null,_currentAreaWaitDeferred:void 0,_items:[],_createChildOnInitSelector:"> :not(.ws-SwitchableArea__item) [data-component]",_options:{areaTemplate:i,items:[],defaultArea:"",loadType:"cached",loadDependencies:true,activateArea:true}},$constructor:function(){this._publish("onBeforeChangeActiveArea","onAfterChangeActiveArea");var e=this;this._bindedHandlers={handleItemIdChanged:this._handleItemIdChanged.bind(this),handleItemContentChanged:this._handleItemContentChanged.bind(this)};for(var t=0,a=this._options.items.length;t<a;t++){var i=this._createSwitchableAreaItem(this._options.items[t]),n=i.getId(),r=this._options.defaultArea===n,o;if(this._items[t]=i,this._areaHashMap[n]=i,r)this.setActiveArea(n);else if("all"===this._options.loadType)(o=i.loadChildControls()).addCallback(function(){e.sendCommand("loadChildControls",e.getName(),n)});if(i.setVisible(r),r&&!this._currentAreaId)this._currentAreaId=n}this._items=s(this._items)},_modifyOptions:function(e){return d.superclass._modifyOptions.call(this,e),e.items=e.items.map(function(e,t){return e.id=e.id||n("ws-area-"+t+"-"),e}),e},_loadControls:function(e){return e.done([])},_createSwitchableAreaItem:function(e){var t=this._options.defaultArea===e.id,a=new r(l({visible:t,autoHeight:this._options.autoHeight,parent:this,element:this.getContainer().children('.ws-SwitchableArea__item[data-for="'+e.id+'"]'),contentExistence:"cached"!==this._options.loadType||t},e));return a.subscribe("onIdChanged",this._bindedHandlers.handleItemIdChanged),a.subscribe("onContentChanged",this._bindedHandlers.handleItemContentChanged),a.getContext().setPrevious(this.getContext()),a},_handleItemIdChanged:function(e,t,a){if(this._areaHashMap[a])this._areaHashMap[t]._options.id=t;else if(t&&this._areaHashMap[t]){if(this._areaHashMap[a]=this._areaHashMap[t],delete this._areaHashMap[t],this._currentAreaId===t)this._currentAreaId=a;this._areaHashMap[a].getContainer().attr("data-for",a)}},_getAreaMarkupContext:function(e){var t;return this._options.buildMarkupWithContext||e._options.buildMarkupWithContext?e.getLinkedContext():void 0},_handleItemContentChanged:function(e,t){if(this._areaHashMap[t]){var a=this._areaHashMap[t],i={id:a.getId(),content:a.getContent(),template:a.getTemplate(),componentOptions:a.getComponentOptions()||{}};if(h(a.getContainer(),this._buildMarkup(this._options.areaTemplate,{enabled:a._options.enabled,visible:a._options.visible,outer:this._options,item:i,index:this._getItemIndexById(t),contentExistence:true},void 0,void 0,this._getAreaMarkupContext(a))),"all"===this._options.loadType||t===this._currentAreaId)a.loadChildControls()}},getItems:function(){return this._items},getItemById:function(e){return this._areaHashMap[e]||null},_getItemIndexById:function(e){var t=this.getItemById(e);return t?this.getItems().indexOf(t):-1},setAreaContent:function(e,t){this.getItems()[this._getItemIndexById(e)].setContent(t)},getCurrentAreaId:function(){return this._currentAreaId},getActiveArea:function(){return this.getCurrentAreaId()},setActiveArea:function(n){var e=this._areaHashMap[this._currentAreaId],r=this._areaHashMap[n],o=this,t=[],s,d=new c;if(e)e._areaDefaultButton=e._defaultButton||e._shouldRegisterButton;if(n&&this._currentAreaId!==n&&r){if(this._notify("onBeforeChangeActiveArea",e||null,r),this._currentAreaId&&e)e.hide();if(!r.isLoaded()){if(this._options.loadDependencies)t=o._getDependencies(r.getContent());if(r.getTemplate()){if(!r._loadingTemplate)r._loadingTemplate=true,a.require([r.getTemplate(),"tmpl!Lib/Control/SwitchableArea/SwitchableArea_area_template"]).addCallbacks(function(e){r._loadingTemplate=false,s=l(r.getComponentOptions(),{element:document.createElement("div"),parent:r});var t=r._container[0];if(r._options.withScroll){var a={id:r.getId(),index:o._getItemIndexById(n),template:e[0],componentOptions:r.getComponentOptions()||{}};h(r.getContainer(),e[1](a)),t=$(".ws-SwitchableArea__item__root_container",r.getContainer())[0],r.reviveComponents(),s.parent=r.getChildControlByName("switchScroll")}t.appendChild(s.element);var i=new e[0](s);r.setLoaded(true),r.setContentExistence(true),setTimeout(function(){i._notifyOnSizeChanged()},10),d.callback()},function(e){_.resolve("ILogger").error("SwitchableArea::setActiveArea()",e)})}else if(t.length)a.require(t).addCallbacks(function(){r.loadChildControls().addCallback(function(e){return d.callback(),e})},function(e){_.resolve("ILogger").error("SwitchableArea::setActiveArea()",e)});else d=r.loadChildControls();d.addCallback(function(){o.sendCommand("loadChildControls",o.getName(),n)})}else if(u.browser.isMacOSDesktop&&u.browser.safari)setTimeout(function(){d.callback()},1);else d.callback();r.show(),this._currentAreaId=n,(this._currentAreaWaitDeferred=d).addCallback(function(){if(r._areaDefaultButton=r._areaDefaultButton||r._shouldRegisterButton,r._areaDefaultButton&&r._areaDefaultButton.setDefaultButton(true),o._notify("onAfterChangeActiveArea",r),o._options.activateArea)if(!o.getTopParent()||o.getTopParent().isVisible())r.activateFirstControl()})}else if(this._currentAreaWaitDeferred&&!this._currentAreaWaitDeferred.isReady())d=this._currentAreaWaitDeferred;else d=(new c).callback();return d},_getDependencies:function(e){var i=[];if("string"===typeof e)$("<div>"+o(e)+"</div>").find("[data-component]").each(function(e,t){var a=t.getAttribute("data-component");i.push(a)});return i},hideAll:function(){for(var e=0,t=this.getItems().length;e<t;e++)this.getItems()[e].hide();this._currentAreaId=null},addArea:function(e,t,a,i,n){n=n||{};var r=this.getItems().length,o={id:e,content:t||"",template:a,withScroll:n.withScroll,componentOptions:i||{}};return this.getItems().push(o),this._initAddedArea(r)},_initAddedArea:function(e){var t=this.getItems(),a=t[e];if(!(a instanceof r)){var i=this._createSwitchableAreaItem(a);if(i.setVisible(false),h(i.getContainer(),this._buildMarkup(this._options.areaTemplate,{outer:this._options,enabled:i._options.enabled,visible:i._options.visible,item:a,index:e,contentExistence:"cached"!==this._options.loadType||this._options.defaultArea===a.id},void 0,void 0,this._getAreaMarkupContext(i))),i.getId()!==a.id)i.setId(a.id);if(e<t.length-1){var n=t[e+1];$(i.getContainer()).insertBefore(n.getContainer())}else this.getContainer().append(i.getContainer());if(this.getItems()[e]=i,this._areaHashMap[i.getId()]=i,"all"===this._options.loadType)return i.loadChildControls()}if(!this._currentAreaId)this.setActiveArea(t[e].getId());return(new c).callback()},removeArea:function(e){if(this._areaHashMap[e]){if(this._currentAreaId===e)if(1===Object.keys(this._areaHashMap).length)this._areaHashMap[this._currentAreaId].hide(),this._currentAreaId=null;else{var t=this.getItems()[0].getId()!==e?0:1;this.setActiveArea(this.getItems()[t].getId())}this._areaHashMap[e].unsubscribe("onIdChanged",this._bindedHandlers.handleItemIdChanged),this._areaHashMap[e].unsubscribe("onContentChanged",this._bindedHandlers.handleItemContentChanged);var a=this._getItemIndexById(e);if(a>=0)this.getItems().splice(a,1);this._areaHashMap[e].destroy(),delete this._areaHashMap[e]}},clearAreaCache:function(){var e=this.getItems(),t=e.length,a;for(a=0;a<t;a++){var i=e[a];i.destroyChildControls(),i.setLoaded(false),i.setContentExistence(false),i._clearContainer();var n={id:i.getId(),content:i.getContent()};h(i.getContainer(),this._buildMarkup(this._options.areaTemplate,{outer:this._options,enabled:i._options.enabled,visible:i._options.visible,item:n,index:a,contentExistence:"cached"!==this._options.loadType||this._options.defaultArea===n.id},void 0,void 0,this._getAreaMarkupContext(i)))}if("all"===this._options.loadType)for(a=0;a<t;a++)e[a].loadChildControls();else if(this._currentAreaId)this.getItemById(this._currentAreaId).loadChildControls();if(this._currentAreaId)this.getItemById(this._currentAreaId).getContainer().removeClass("ws-hidden")},validateAreas:function(){for(var e=this.getItems(),t,a=0,i=e.length;a<i;a++)if(!e[a].validate(false,true))t=void 0!==t?t:e[a].getId();return t},_destroyAreas:function(){for(var e=this.getItems(),t=e.length,a,i=0;i<t;i++)(a=e[i]).unsubscribe("onIdChanged",this._bindedHandlers.handleItemIdChanged),a.unsubscribe("onContentChanged",this._bindedHandlers.handleItemContentChanged),a.destroyChildControls(),a.setLoaded(false),a._clearContainer(),a.destroy()},destroy:function(){this._destroyAreas(),d.superclass.destroy.apply(this,arguments)}});return d});