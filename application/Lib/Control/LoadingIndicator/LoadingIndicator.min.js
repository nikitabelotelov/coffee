define("Lib/Control/LoadingIndicator/LoadingIndicator",["Core/WindowManager","Core/helpers/isNewEnvironment","Lib/Control/Control","tmpl!Lib/Control/LoadingIndicator/LoadingIndicator","Lib/Control/Window/Window","Lib/Control/ProgressBar/ProgressBar","Lib/Control/ModalOverlay/ModalOverlay","Core/helpers/String/escapeTagsFromStr","Core/constants","Core/Deferred","css!Lib/Control/LoadingIndicator/LoadingIndicator","i18n!Lib/Control/LoadingIndicator/LoadingIndicator"],function(s,o,i,e,t,n,r,a,d,l){"use strict";var h=2e3,c=t.extend({$protected:{_isIndicator:true,_isIndicatorVisible:true,_options:{resizable:false,border:false,autoHeight:true,autoWidth:true},_keysWeHandle:[]},$constructor:function(){this.unsubscribeFrom(r,"onClick"),this._window.addClass("ws-LoadingIndicator__window")},_getNewZIndex:function(){var i=requirejs.defined("Controls/Popup/Manager/ManagerController")&&requirejs("Controls/Popup/Manager/ManagerController"),e=i&&i.getContainer()&&i.getContainer()._popupItems,t=10;if(o()&&e){var n=e.getCount()*t+t/2;return s._modalIndexes.push(n),n}return c.superclass._getNewZIndex.apply(this,arguments)},_moveFocusToSelf:function(){},onBringToFront:function(){},_activate:function(){},_restoreLastActiveOnHide:function(){},isMovableToTop:function(){for(var i=true,e=s.getStack(),t=e.length-1;t>=0;t--){var n=e[t];if(n.window._isIndicator)if(n.window===this)return i;else if(n.visible())i=false;else i=null}return true}}),_=function(i){var e=$(d.$body);if(this._options.showInWindow)if(i){if(!r.getState())e.addClass("ws-LoadingIndicator-overlay-hidden");e.addClass("ws-LoadingIndicator-hidden")}else e.removeClass("ws-LoadingIndicator-hidden ws-LoadingIndicator-overlay-hidden");else this._loadingIndicator.toggleClass("ws-LoadingIndicator-hidden",i)},u=function(i){var e=document.createElement("div"),t;if(!(-1!==i.indexOf("sprite:")))$(e).append('<img src="'+i+'" />');else $(e).addClass(i.replace("sprite:",""));return e},w=function(i){i._overlayZIndex=r.getZIndex()},f=function(i){if(i._overlayZIndex){if(i._options.delay&&r.getState())r._setZIndex(i._overlayZIndex);i._overlayZIndex=null}},g=i.Control.extend({$protected:{_loadingPic:"",_loadingIndicator:"",_loadingContainer:"",_loadingText:"",_picture:"",_myWindow:null,_myProgressBar:null,_progressBarContainer:"",_windowHeight:void 0,_windowWidth:void 0,_isVisible:false,_delay:null,_options:{message:rk("Загрузка"),loadingPicture:"/cdn/img/common/1.0.0/ajax-loader-indicator.gif",isShowLoadingPicture:true,showInWindow:true,height:57,width:"100%",modal:true,progressBar:false,showPercent:true,delay:false}},$constructor:function(){if(!o())this._redraw()},getParent:function(){return this._parent},isVisible:function(){return this._isVisible},_setWindowVisibleProperty:function(i){var e=this.getWindow();if(e)e._isIndicatorVisible=i},_showDelay:function(){var e=this;if((!this._delay||this._delay.isReady())&&this._options.delay)_.call(this,true),(s._delayedIndicator=this)._getDelay().addCallback(function(i){if(_.call(e,false),s._delayedIndicator=null,r.getState())r.adjust();return i})},_clearDelay:function(){if(this._delay){if(s._delayedIndicator===this)_.call(this,false);this._delay.cancel(),this._delay=null}},_getDelay:function(){return!this._delay||this._delay.isReady()?this._delay=l.fromTimer(h):this._delay},setDelay:function(i){this._options.delay=Boolean(i)},show:function(){if(!this._isVisible){if(this._showDelay(),this._options.showInWindow){if(this._myWindow)w(this),this._myWindow._isShow=false,this._myWindow.show(true),this._myWindow.moveWindowToCenter(),f(this)}else this._loadingIndicator.show();this._isVisible=true}},hide:function(){if(this._isVisible){if(this._clearDelay(),this._options.showInWindow)this._myWindow&&this._myWindow.hide();else this._loadingIndicator.hide();if(s.getCurrentVisibleIndicator()===this)s.setCurrentVisibleIndicator(null);this._isVisible=false}},setMessage:function(e){if(o())requirejs(["Controls/Popup/Manager/ManagerController"],function(i){i.getIndicator().show({message:e})});else if(this._loadingText)if(this._loadingText.html(a(e,["script"])),this._isVisible&&this._myWindow)this._recalcWindowSize(this._myWindow._window)},_recalcWindowSize:function(i){var e=this,t=function(){e._windowHeight=i.height()||e._windowHeight,e._windowWidth=i.width()||e._windowWidth};if(/none/.test(i.css("display")))i.css({display:"block",visibility:"hidden"}),t(),i.css({display:"none",visibility:"visible"});else t(),this._myWindow.moveWindowToCenter()},close:function i(){this.destroy()},setImg:function(i){$(this._picture).removeClass().empty(),$(this._picture).append(u(i))},_redraw:function(){if(this._myWindow)this._myWindow.close();if(this._container&&(this._progressBarContainer||this._loadingIndicator))this._container.html("");if(this._options.showInWindow){this._container=$(e(this._options)),this._renderInd();var i=this;this._showDelay(),w(i),this._myWindow=new c({modal:this._options.modal,animatedWindows:false,_openFromAction:true,handlers:{onDestroy:function(){i._myWindow=null},onReady:function(){this._myIndicator=i,this.getContainer().append('<div class="ws-win-loadingIndicator"></div>'),this.getContainer().find(".ws-win-loadingIndicator").append(i._container),i._windowHeight=this._window.height(),i._windowWidth=this._window.width()}}}),f(i)}else this._container.append($(e(this._options))),this._renderInd(),this._showDelay()},_renderInd:function(){if(this._loadingText=this._container.find(".ws-LoadingIndicator__message"),this._options.progressBar){this._progressBarContainer=this._container.find(".ws-progressbar-container");var i=this;this._myProgressBar=new n({element:i._progressBarContainer,width:289,showPercent:i._options.showPercent})}else{if("string"===typeof this._options.width){var e=this._options.width;if("%"!=e[e.length-1])this._options.width=parseInt(this._options.width,10)+"px"}else this._options.width=this._options.width+"px";this._loadingIndicator=this._container.find(".ws-loading"),this._loadingContainer=this._loadingIndicator.find(".ws-LoadingIndicator__loadingContainer"),this._loadingIndicator.css({"text-align":"center",height:this._options.height,width:this._options.showInWindow?"100%":void 0})}this._notify("onReady")},getWindow:function(){return this._myWindow},setProgress:function(i){if((i=parseInt(i,10))>=0&&i<=100&&null!==this._myProgressBar)return this._myProgressBar.setProgress(i),true;else return false},destroy:function(){this._clearDelay(),this.hide(),g.superclass.destroy.apply(this,arguments),this._myWindow&&this._myWindow.destroy(),this._myProgressBar&&this._myProgressBar.destroy()}});function p(i){for(var e=false,t=s.getStack(),n=t.length-1;n>=0;n--){var o=t[n];if(o.window._isIndicator)if(o.window===i)return!e;else if(o.visible())e=true}return true}function y(i,e){return function(){if(!this[i]){this[i]=true;try{return e.apply(this,arguments)}finally{this[i]=false}}}}var I=g.extend({$protected:{_showing:false,_hiding:false,_preventKeyDown:null,_keyboardLocked:false},$constructor:function(){this._preventKeyDown=function(i){var e=116,t=123,n=this._options.showInWindow&&this._myWindow?this._myWindow.getZIndex():0;if(i.keyCode!==e&&i.keyCode!==t&&n>=this._getMaxZIndex())if(i.preventDefault)i.preventDefault(),i.stopPropagation();else i.returnValue=false}.bind(this)},_getMaxZIndex:function(){if(o()){var i;return 10*require("Controls/Popup/Manager/ManagerController").getContainer()._popupItems.getCount()}else return s.getMaxZIndex()},_toggleKeyboardLocked:function(i){if(this._keyboardLocked!==i)if(this._keyboardLocked=i)if(document.addEventListener)document.addEventListener("keydown",this._preventKeyDown,true);else document.attachEvent("onkeydown",this._preventKeyDown);else if(document.removeEventListener)document.removeEventListener("keydown",this._preventKeyDown,true);else document.detachEvent("onkeydown",this._preventKeyDown)},_initComplete:function(){I.superclass._initComplete.apply(this,arguments),this.show()},hide:function(){if(o())requirejs(["Controls/Popup/Manager/ManagerController"],function(i){i.getIndicator().hide()});else y("_hiding",function(){if(this._options.showInWindow){if(this._setWindowVisibleProperty(false),this==s.getCurrentVisibleIndicator())I.superclass.hide.apply(this,arguments)}else I.superclass.hide.apply(this,arguments);this._toggleKeyboardLocked(false)}).call(this)},show:function(){if(o())requirejs(["Controls/Popup/Manager/ManagerController"],function(i){i.getIndicator().show({delay:2e3})});else y("_showing",function(){if(this._options.showInWindow){if(this._myWindow)if(this._setWindowVisibleProperty(true),p(this._myWindow)){s._pendingIndicator=this;var i=s.getCurrentVisibleIndicator();if(i&&this!==i)I.superclass.hide.apply(i,arguments);I.superclass.show.apply(this,arguments),s.setCurrentVisibleIndicator(this),s._pendingIndicator=null}else s.pushUp(this._myWindow)}else I.superclass.show.apply(this,arguments);this._toggleKeyboardLocked(true)}).call(this);this._toggleKeyboardLocked(true)},destroy:function(){if(o())requirejs(["Controls/Popup/Manager/ManagerController"],function(i){i.getIndicator().hide()});else if(this._toggleKeyboardLocked(false),s.popBack(this._myWindow),this._myWindow)delete this._myWindow._myIndicator;I.superclass.destroy.apply(this,arguments)}}),m;return I.toggleIndicator=function i(e,t){if(m=m||new I({message:rk("Пожалуйста, подождите…")}),!!e)if(e instanceof l)if(!e.isReady()&&!e.isCallbacksLocked())m.setDelay(t),m.show(),e.addBoth(function(i){return m.hide(),i});else m.hide();else m.setDelay(t),m.show();else m.hide()},I});