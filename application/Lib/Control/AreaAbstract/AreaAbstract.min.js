define("Lib/Control/AreaAbstract/AreaAbstract",["require","Core/core-extend","Lib/Control/AreaAbstract/AreaAbstract.compatible","Core/ControlBatchUpdater","Core/core-clone","Core/helpers/Object/find","Core/helpers/Hcontrol/getElementCachedDim","Core/WindowManager","Core/IoC","Core/ParallelDeferred","Core/Deferred","Core/constants","Lib/Control/Control","Core/core-instance","Core/core-debug","Core/detection","Core/CommandDispatcher","Lib/Mixins/BreakClickBySelectMixin","Transport/HTTPError","Core/helpers/Object/isPlainObject","Core/helpers/Array/findIndex","Core/Context","css!Lib/Control/AreaAbstract/AreaAbstract","i18n!Lib/Control/Control"],function(l,t,e,i,r,n,o,s,a,h,d,c,u,_,f,C,p,g,b){"use strict";function v(t){var e=false,i=t;while(i){if(i.wsControl&&!i.wsControl._template){e=false;break}if(i.controlNodes){e=true;break}i=i.parentElement}return e}function y(t,e){if(t&&e){var i=+t.tabindex,n=+e.tabindex;if(isNaN(i)||-1==i)return 1;if(isNaN(n)||-1==n)return-1;return i-n}else return 0}var m=t({},{$protected:{_group:[]},$constructor:function(t){this._group=t},_setEnabled:function(t){},setVisible:function(t){},getGroupContainers:function(){},destroy:function(){this._group=null}}),A=null,k=null,x={_hasSelectionInContainer:g._hasSelectionInContainer,_getSelection:g._getSelection,_onClickHandler:g.around._onClickHandler},w=false,B=u.Control.extend([e,x],{_$context:null,_$independentContext:false,_$contextRestriction:"",_$record:false,_$modal:false,_$validateIfHidden:false,_$ignoreTabCycles:true,_$groups:null,_$handleFocusCatch:false,_$currentTemplate:"",_$isRelativeTemplate:false,_$children:[],_$_doGridCalculation:false,_moduleName:"Lib/Control/AreaAbstract/AreaAbstract",_horizontalAlignment:"Left",_pending:null,_pendingTrace:null,_waiting:null,_groupInstances:null,_activeChildControl:-1,_activatedWithTabindex:true,_childControls:null,_childNonControls:null,_childsMapName:null,_childsMapId:null,_childContainers:null,_childsTabindex:false,_childsMapNameCache:null,_childsMapIdCache:null,_childsSizes:null,_maxTabindex:0,_dChildReady:null,_keysWeHandle:null,_resizer:null,_toolbarCount:null,_defaultButton:null,_activationIndex:0,_opener:void 0,_isModal:false,_isReady:false,_waitersByName:null,_waitersById:null,_onDestroyOpener:null,_isInitComplete:false,constructor:function t(e,i){e=e||{},this._$groups={},this._pending=this._pending||[],this._pendingTrace=this._pendingTrace||[],this._waiting=this._waiting||[],this._groupInstances=this._groupInstances||{},this._childControls=this._childControls||[],this._childNonControls=this._childNonControls||[],this._childsMapName=this._childsMapName||{},this._childsMapId=this._childsMapId||{},this._childContainers=this._childContainers||[],this._childsSizes=this._childsSizes||{},this._childsMapNameCache=this._childsMapNameCache||{},this._childsMapIdCache=this._childsMapIdCache||{},this._keysWeHandle=this._keysWeHandle||[c.key.tab,c.key.enter],this._toolbarCount={top:0,right:0,bottom:0,left:0},this._waitersByName={},this._waitersById={},this._baseTabIndex=e.tabindex,t.superclass.constructor.call(this,e,true);var n=this;if(this._publish("onResize","onActivate","onBeforeShow","onAfterShow","onBeforeLoad","onAfterLoad","onBeforeControlsLoad","onBatchFinished"),this._isModal=this._getOption("modal"),this._dChildReady=new h,!this._isCorrectContainer()){if(this._container=$("<div></div>",{tabindex:this._getOption("tabindex")>=0?0:-1}).bind("click",this._onActionHandler.bind(this)),this._checkClickByTap)this._container.bind("touchstart touchmove touchend",this._onActionHandler.bind(this));if((this._container[0].wsControl=this)._getOption("cssClassName"))this._container.addClass(this._getOption("cssClassName"));this._initKeyboardMonitor()}if(this._container.bind("mousedown.activate",function(){if(!$.event.props)$.event.props=[];if(!$.event.props["ws-area-activated-id"])n._container.trigger("container-clicked"),$.event.props["ws-area-activated-id"]=n.getId()}),!c.$doc)c.$doc=$(document);else if(!c.$doc.bind)c.$doc=$(c.$doc);if(c.$doc.bind("mousedown."+this.getId(),function(){if(!$.event.props)$.event.props=[];if(n.getId()==$.event.props["ws-area-activated-id"])$.event.props["ws-area-activated-id"]=null}),C.firefox)this._container.bind("mousedown.fxselect",function(t){if(t.ctrlKey)t.preventDefault()});if(!this.getParent()||!w)this._subscribeToWindowResize(),w=true;if(this._dChildReady.getResult().addCallback(function(){n._childNonControls=n._container.children(c.NON_CTRL)}),this.setOpener(e&&e.opener),p.declareCommand(this,"registerDefaultButtonAction",function(){n.sendCommand("resizeYourself")}),p.declareCommand(this,"registerDefaultButtonAction",function(t,e){if(n._defaultButton)return true;return n._registerDefaultButtonAction(t,e),!!_.instanceOfMixin(n,"Lib/Mixins/LikeWindowMixin")}),p.declareCommand(this,"unregisterDefaultButtonAction",function(){if(!k)k=n;if(n._defaultButton&&!A)A=n._defaultButton;else if(n===A)return true;else if(n!==k&&(!n._defaultButton||A!==n._defaultButton))return k=A=null,true;n._unregisterDefaultButtonAction();var t=!!_.instanceOfMixin(n,"Lib/Mixins/LikeWindowMixin")||!!_.instanceOfModule(n,"OnlineSbisRu/Base/View")||!n.getParent();if(t)k=A=null;return t}),!i)this._initInstance()},_subscribeToWindowResize:function(){c.$win.bind("resize."+this.getId(),this._onResizeHandler.bind(this))},addPendingOperation:function(t){var e=!!(t&&t instanceof d);if(e)this._pending.push(t),this._pendingTrace.push(f.getStackTrace()),t.addBoth(this._checkPendingOperations.bind(this));return e},_finishAllPendingsWithSave:function(){this._pending.forEach(function(t){t.callback(true)})},getAllPendingInfo:function(){var i=[],n=this;return this._pending.forEach(function(t,e){i.push({pending:t,trace:n._pendingTrace[e]})}),i},waitAllPendingOperations:function(t){if(t&&t instanceof d&&!t.isReady()){if(0===this._pending.length)t.callback();else this._waiting.push(t);return true}else return false},_checkPendingOperations:function(t){var e=this._pending.length,i;if((i=(i=this._pending.filter(function(t){return t.isReady()})).map(function(t){return t.getResult()})).length==e){this._pending=[],this._pendingTrace=[];while(this._waiting.length>0)this._waiting.pop().callback(i)}return t},init:function(){s.addWindow(this),B.superclass.init.apply(this,arguments),this._subscribeOnReady(),this._runInBatchUpdate("AreaAbstract - init - "+this._id,function(){return d.callbackWrapper(this._loadDescendents(),this._childrenLoadCallback.bind(this))});var t=this._baseTabIndex;if(0===t)t=-1;if(void 0!==t)this._getElementToFocus()[0].setAttribute("tabindex",t),this._container[0].setAttribute("tabindex",t)},_buildMarkup:function(t,e,i,n,r){return e.className=e.className||"",B.superclass._buildMarkup.apply(this,arguments)},_keyboardHover:function(t){return this._oldKeyboardHover.apply(this,arguments)},activateFirstControl:function(t){return this._oldActivateFirstControl.apply(this,arguments)},activateLastControl:function(t){return this._oldActivateLastControl.apply(this,arguments)},detectNextActiveChildControl:function(t,e,i){return this._oldDetectNextActiveChildControl.apply(this,arguments)},_childrenLoadCallback:function(){this._notify("onBeforeShow"),this._notifyBatchDelayed("onAfterShow")},_createCheckDestroyedFunc:function(i,n,r){var o=this;return function(t){if(o.isDestroyed()){var e=new Error(i+": "+rk("Область")+" "+n+", id = "+o._id+rk("была уничтожена до начала создания дочерних контролов."));if(t)e.silent=true,r(e,true);else throw e}return o.isDestroyed()}},_makeLoadErrorHandler:function(s){return function(t){if(!t.silent){var e=t.message,i=$("#onlineChecker"),n=i.find("#warningText"),r=window.navigator.onLine;if(t instanceof b)e+=", "+t.url;if(a.resolve("ILogger").error("AreaAbstract",rk("Ошибка при загрузке дочерних компонентов")+" ("+e+")",t),r)n.text(rk("Произошла ошибка при попытке загрузки ресурса. Пожалуйста, обновите страницу")),i.css("display",""),i.css("zIndex",9999)}try{var o=new d;o.addErrback(function(t){return t}),o.errback(t),s.push(o),s.done()}catch(t){}return t}.bind(this)},_createChildrenLoadCallback:function(){var i=this,t=new h,e=this._dChildReady.getResult().addCallback(this._templateInnerCallback.bind(this)).createDependent();return t.getResult().addErrback(function(t){var e=new d;return i._dChildReady.push(e.errback(t)).done(),t}).addCallback(function(){return i._dChildReady.done(),e}),t},_showControls:function(){this._notify("onAfterLoad")},_collectControlsToBuild:function(t,e){var i=this._getOption("children");if(!i.length&&t)i=t.getControls(e,this.getContainer());return i},_getControlsToBuild:function(t,e){var i=this._collectControlsToBuild(t,e);if(!t||t.needSetZindexByOrder())i=i.map(function(t,e){return t.zIndex="zIndex"in t?t.zIndex:e+1,t});return i=i.sort(y)},_loadControls:function(e,a,i,t,n){return this._runInBatchUpdate("_loadControls - "+this._id,function(){var s=this,t=this._getControlsToBuild(a,i);return(t=r(t).map(function(t){var e=t.type,i,n,r=["Deprecated","Lib"],o=e.indexOf("/")>0?e.split("/")[0]:false;if(o&&(r.indexOf(o)>-1||Object.keys(c.modules).some(function(t){return c.modules[t]===o}))||-1===e.indexOf("SBIS3.")&&e.indexOf("/")>-1&&-1==e.indexOf("Control/"))n={ctor:l(e),config:t};else n={ctor:l(o=e),config:t};return n})).forEach(function(t){var e=s._container[0],i=t.config,n=t.ctor,r;try{if(i.element=$("#"+i.id,e),i.parent=s,i.linkedContext=s._context,i.currentTemplate=a,i.supportOldJinneeMarkup=true,"function"===typeof(r=new n(i)).getReadyDeferred)s._dChildReady.push(r.getReadyDeferred());var o=r.getAlignment();if("Stretch"!=o.horizontalAlignment||"Stretch"!=o.verticalAlignment)s._doGridCalculation=true}finally{}}),e.done(),e})},_loadDescendents:function(){return this._runInBatchUpdate("_loadDescendents - "+this._id,function(){var t=this._createChildrenLoadCallback(),e=this._makeLoadErrorHandler(t),i=this._getOption("currentTemplate"),n,r=this._createCheckDestroyedFunc("_loadDescendents",this._getOption("name"),e);this._notify("onBeforeLoad"),this._notify("onBeforeControlsLoad");try{this._isPage=!!(i&&i.isPage()),this._loadControls(t,i,this.getId(),r,e)}catch(t){n=i&&i.getName?i.getName():"<неизвестном>",t.message+=" - в шаблоне "+n,e(t)}return t.getResult().createDependent()})},isAllReady:function(){for(var t=this.getChildControls(),e=0;e<t.length;++e)if(t[e].isReady&&!t[e].isReady())return false;return true},_templateInnerCallbackBeforeReady:function(){},_templateInnerCallback:function(){this._isReady=true,this._initResizers(),i.runBatchedDelayedAction("resizeYourself"),this._templateInnerCallbackBeforeReady(),this._notifyOnReady(),this._showControls()},_notifyOnReady:function(){this._notify("onReady"),this._container.trigger("onReady")},_onClickHandler:function(t){x._onClickHandler.call(this,function(){if(!v(t.target))if(this._getOption("activableByClick"))this.onBringToFront();this._notify("onClick",t)},t)},moveToTop:function(){},_restoreSize:function(){if(this._width||this._height)this._container.css({width:this._getOption("autoWidth")||"Stretch"===this._horizontalAlignment?"auto":this._width,height:this._getOption("autoHeight")||"Stretch"===this._verticalAlignment?"auto":this._height})},setSize:function(t){if(this._getOption("autoHeight"))t["height"]="auto";else this._getFixedHeight.reset();if(!this._getOption("autoWidth"))this._getFixedWidth.reset();this._container.css(t),this._resizeChilds(),this._notify("onResize")},getNamedGroup:function(t){if(t in this._getOption("groups"))if(t in this._groupInstances)return this._groupInstances[t];else{for(var e=[],i=this._getOption("groups")[t],n=0,r=i.length;n<r;n++)try{e.push(this.getChildControlById(i[n]))}catch(t){}return this._groupInstances[t]=new m(e)}else return null},getNearestChildControlByName:function(t,e){var i={},n=[],r,o=function(t){if(t&&!i[t.getId()])i[t.getId()]=true,n.push(t)};if(e){o(this);while(n.length){var s=n.shift();if(s.hasChildControlByName){if(s.hasChildControlByName(t))return s.getChildControlByName(t)}else if(s.getName&&s.getName()===t)return s;if(r=s.getParent())o(r);if(s.getOpener)o(s.getOpener());if(s._childContainers)for(var a=0,l=s._childContainers.length;a<l;++a)o(s._childContainers[a])}}else{r=this;while(r){if(r.hasChildControlByName)if(r.hasChildControlByName(t))return r.getChildControlByName(t);r=r.getParent()||r.getOpener&&r.getOpener()}}return},getImmediateChildControls:function(){for(var t=[],e=0;e<this._childControls.length;e++)if(this._childControls[e])t.push(this._childControls[e]);return t},_isActiveByTabindex:function(){return this._childsTabindex&&this._activeChildControl in this._childsTabindex&&this._childControls[this._childsTabindex[this._activeChildControl]]},isModal:function(){return this._isModal},_destroySuperClass:function(){B.superclass.destroy.apply(this,arguments)},destroyChild:function(t){var e=this._childsMapId[t];if(void 0!==e){var i=this._childControls[e];if(i)this.unregisterChildControl(i),i.destroy()}},disableActiveCtrl:function(t){var e=this.getActiveChildControl();if(e&&e.isActive()){var i=e instanceof B;if(i&&!t||!i)e.setActive(false)}},hide:function(){var t=this.getActiveChildControl(void 0,true);if(t)t._isControlActive=true,t.setActive(false,void 0,void 0,this.getParent());B.superclass.hide.apply(this,arguments)},getToolBarCount:function(t){return this._toolbarCount[t]},increaseToolBarCount:function(t){++this._toolbarCount[t]},setEnabled:function(t){var e=this._getOption("enabled");if(B.superclass.setEnabled.apply(this,arguments),this._getOption("enabled")!==e)this.getImmediateChildControls().forEach(this._setupChildByAreaEnabled,this)},_getAutoHeight:function(){return this._resizer?o(this._resizer,"height"):this._container.outerHeight()},_getAutoWidth:function(){return this._resizer?o(this._resizer,"width"):this._container.outerWidth()},_calcMinHeight:function(){var t,e;if(this._resizer)t=o(this._resizer,"height");else t=Math.max(this._getOption("minHeight"),this._getResizerHeight());return t||0},_calcMinWidth:function(){var t,e;if(this._resizer)t=o(this._resizer,"width");else t=Math.max(this._getOption("minWidth"),this._getResizerWidth());return t||0},getResizer:function(){return this._resizer},_haveAutoSize:function(){return this._getOption("autoHeight")||this._getOption("autoWidth")},_haveStretch:function(){return"Stretch"===this._horizontalAlignment||"Stretch"===this._verticalAlignment},isPage:function(){return this._isPage},hasActiveChildControl:function(){return!!n(this._childControls,function(t){if(t.isActive())return true;if(t instanceof B)return t.hasActiveChildControl()})}});return B.beforeExtend=function(t,e,i){B.prototype._setCompatibleOptions(t,e,i)},B});