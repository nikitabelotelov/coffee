define("Vdom/_private/Synchronizer/resources/VdomMarkup",["require","exports","Core/core-debug","View/Executor/Utils","Core/helpers/Array/flatten","Vdom/_private/Utils/Monad","Vdom/_private/Synchronizer/resources/Hooks"],function(e,t,m,y,V,l,T){"use strict";function N(e,t){if(t)return e.children||[];else return y.Vdom.isVNodeType(e)?null===e.children?[]:e.children:[]}function k(e,t,r,o,n,i){if(r.stopped)return r;if(o&&y.Vdom.isTemplateVNodeType(r)&&r.children&&r.children[0])return r.children[0]=k(e,t,r.children[0],o),r;if(y.Vdom.isVNodeType(r)){if(t.control&&"Controls/Decorator/Markup"===t.control._moduleName)if(r.children&&r.children[0])r.children[0].stopped=true;var d=e(r.type,r.hprops,r.children,r.key,t,r.ref,r),l=r.type===d[0]&&r.props===d[1]&&r.children===d[2]&&r.key===d[3];if(i){if(r.type=d[0],r.props=d[1],r.children=d[2],r.key=d[3],!r.hookedInvControlIds||-1===r.hookedInvControlIds.indexOf(t.id))if(r.ref=d[4],r.hookedInvControlIds)r.hookedInvControlIds.push(t.id)}else return l?r:y.Vdom.htmlNode.apply(y.Vdom,d)}else return r}function r(e){return Array.isArray(e)?e[0]:e}function o(r,e,o,n,i){function d(e){var t=n(e)?[o(e)]:[];return r?t.concat(l.ListMonad.join(N(e,i),d)):t}return l.ListMonad.join(N(e,i),d)}function n(e){return e}function g(e,t){return o(true,e,n,y.Vdom.isControlVNodeType,t)}function v(e){return o(true,e,n,y.Vdom.isTemplateVNodeType)}function C(e,t,r){var o={create:[],createTemplates:[],destroy:[],destroyTemplates:[],update:[],updateTemplates:[],vnodeChanged:false},n,i,d,l,s,a,V;function p(e,t){function r(e){if(e)for(var t=0,r=e.length;t!==r;t++)if(void 0!==e[t].key)return true;return false}function o(e){for(var t={},r=[],o=e.length,n=0;n<o;n++){var i,d=e[n].key;if(void 0!==d)t[d]=n;else r.push(n)}return{keys:t,free:r}}var n,i,d,l,s,a,p,c,u,f,h,m,y;if(r(e)&&r(t)){for(a=o(e),p=o(t),i=a.keys,h=e.length,d=p.keys,m=t.length,s=(l=p.free).length,u=0,n=new Array(length),c=0;c!==h;c++)if(void 0!==(y=e[c]).key)if(d.hasOwnProperty(y.key))n[c]=t[d[y.key]];else n[c]=null;else if(u!==s)n[c]=t[l[u]],u++;else n[c]=null;for(f=u!==s?l[u]:m,c=0;c!==m;c++)if(void 0!==(V=t[c]).key){if(!i.hasOwnProperty(V.key))n.push(V)}else if(c>=f)n.push(t[c])}else n=t;return n}function c(e,t){var r=e&&y.Vdom.isControlVNodeType(e),o=t&&y.Vdom.isControlVNodeType(t),n=e&&y.Vdom.isTemplateVNodeType(e),i,d=n===(t&&y.Vdom.isTemplateVNodeType(t)),l=r===o;if(l){if(r)l=e.controlClass===t.controlClass&&e.key===t.key;else if((l=e.type===t.type)&&y.Vdom.isVNodeType(e))l=e.tagName===t.tagName&&e.namespace===t.namespace&&e.key===t.key}else if(d)if(n)l=e.template===t.template&&e.key===t.key;else if((l=e.type===t.type&&e.compound===t.compound)&&y.Vdom.isVNodeType(e))l=e.tagName===t.tagName&&e.namespace===t.namespace&&e.key===t.key;return l}function u(e,t,r){e[t]=e[t].concat(r)}if(e!==t||r)if(m.checkAssertion(!!t,"newNode !== null"),c(e,t))if(y.Vdom.isControlVNodeType(t))if(-1===e.controlNodeIdx)o.create.push(t);else o.update.push({oldNode:e,newNode:t});else if(y.Vdom.isTemplateVNodeType(t))if(!t.children&&t===e)o.createTemplates.push(t);else o.updateTemplates.push({oldNode:e,newNode:t});else{d=p(i=N(e),N(t)),l=Math.max(i.length,d.length);var f=0,h=d!==t.children;if(i.length!==d.length)o.vnodeChanged=true;for(s=0;s!==l;s++){if((a=i[s])&&"vdom-focus-in"===a.key&&!h){f++;continue}if(V=d[s-f],a&&V)n=C(a,V,r),o.vnodeChanged=o.vnodeChanged||n,u(o,"create",n.create),u(o,"destroy",n.destroy),u(o,"update",n.update),u(o,"createTemplates",n.createTemplates),u(o,"destroyTemplates",n.destroyTemplates),u(o,"updateTemplates",n.updateTemplates);else if(a)if(y.Vdom.isControlVNodeType(a))u(o,"destroy",[a]);else if(y.Vdom.isTemplateVNodeType(t))u(o,"destroy",g(a,true));else u(o,"destroy",g(a,true));else if(y.Vdom.isControlVNodeType(V))u(o,"create",[V]);else if(y.Vdom.isTemplateVNodeType(V))u(o,"createTemplates",[V]);else u(o,"create",g(V)),u(o,"createTemplates",v(V))}}else{if(o.vnodeChanged=true,y.Vdom.isControlVNodeType(t))o.create.push(t);else if(y.Vdom.isTemplateVNodeType(t))o.createTemplates.push(t);else u(o,"create",g(t)),u(o,"createTemplates",v(t));if(e)if(y.Vdom.isControlVNodeType(e))o.destroy.push(e);else if(y.Vdom.isTemplateVNodeType(e))u(o,"destroy",g(e,true));else u(o,"destroy",g(e,true))}return o}function i(e,t){var r;for(r in t)if(t.hasOwnProperty(r))if(!e.hasOwnProperty(r)||e[r]!==t[r])return true;for(r in e)if(e.hasOwnProperty(r)&&!t.hasOwnProperty(r))return true;return false}function x(e,t){return i(e.attributes,t.attributes)||i(e.events,t.events)||i(e.hooks,t.hooks)}function I(r,o,n,e,t){var i,d,l,s,a,p,c,u=false;if(y.Vdom.isControlVNodeType(o)){if(n)return o;if((i=r[o.controlNodeIdx].fullMarkup)&&i.type&&"invisible-node"===i.type){if(t&&t.type){if(!t.hookedInvControlIds)t.hookedInvControlIds=[];k(T.setControlNodeHook(r[o.controlNodeIdx]),r[o.controlNodeIdx],t,true,false,true)}i=y.Vdom.textNode("",r[o.controlNodeIdx].key)}}else if(y.Vdom.isTemplateVNodeType(o)&&!o.children)i=o;else if(!y.Vdom.isTemplateVNodeType(o)&&!y.Vdom.isVNodeType(o)||!o.children||0===o.children.length)i=o;else{d=0,s=(l=y.Vdom.isTemplateVNodeType(o)?o.children:N(o)).length;while(d!==s){if((a=I(r,l[d],n,void 0,o)).changed)u=true;if(a!==l[d])break;d++}if(d===s){if(i=o,!u&&e)if(i.children&&e.children)if(i.children.length!==e.children.length)u=true;else for(var f=0;f<i.children.length;f++)if(i.children[f]!==e.children[f]||e.children[f]&&e.children[f].changed){u=true;break}}else{if(c=l.slice(d+1).map(function(e){var t=I(r,e,n,void 0,o);if(t.changed)u=true;return t}),c=V(c,true),p=l.slice(0,d).concat(Array.isArray(a)?a:[a]).concat(c),y.Vdom.isTemplateVNodeType(o)){var h={compound:false,children:p,childrenForDiff:o.children,template:o.template,controlProperties:o.controlProperties,parentControl:o.parentControl,attributes:o.attributes,context:o.context,changed:true,type:"TemplateNode",optionsVersions:o.optionsVersions,get count(){var e=0;if(this.children){for(var t=0;t<this.children.length;t++){var r;e+=this.children[t].count||0}return this.children.length+e}else return 0}};return Object.defineProperty(o,"count",{get:function(){return h.count},configurable:true}),h.children}if(e){if(!u)if(!e.children&&p||e.children.length!==p.length)u=true;else for(var f=0;f<e.children.length;f++)if(e.children[f]!==p[f]||p[f].changed){u=true;break}if(!u)u=x(o.hprops,e.hprops);if(u)(i=y.Vdom.htmlNode(o.type,o.hprops,p,o.key,o.ref)).changed=true;else i=e}else(i=y.Vdom.htmlNode(o.type,o.hprops,p,o.key,o.ref)).changed=true}}if(y.Vdom.isTemplateVNodeType(i))if(i.children)i=i.children;else y.Vdom.textNode("",i.attributes.key);if(u)i.changed=true;return i}function d(e,t){return y.Vdom.htmlNode("span",{},[y.Vdom.textNode(e,(t||"err_"+Math.trunc(1e3*Math.random()))+"_inner_text")],t||"err_"+Math.trunc(1e3*Math.random()))}function s(e,t){var r=e.control._getMarkup(e.key,t,{key:e.key,attributes:e.attributes,events:e.events,inheritOptions:e.inheritOptions,templateContext:e.templateContext,internal:e.internal,domNodeProps:e.domNodeProps}),o;if(y.Vdom.isVNodeType(r))o=k(e.markupDecorator,e,r);else if(y.Vdom.isControlVNodeType(r))o=k(e.markupDecorator,e,r);else o=r;if(!y.Vdom.isControlVNodeType(o)&&!y.Vdom.isVNodeType(o)&&!y.Vdom.isTemplateVNodeType(o))o=d("control._getMarkup должен отдавать dom-узел",e.key);return o}Object.defineProperty(t,"__esModule",{value:true}),t.getVNodeChidlren=N,t.mapVNode=k,t.getMarkupDiff=C,t.getFullMarkup=I,t.getDecoratedMarkup=s});