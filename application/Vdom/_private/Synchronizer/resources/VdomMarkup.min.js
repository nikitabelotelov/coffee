define("Vdom/_private/Synchronizer/resources/VdomMarkup",["require","exports","Env/Env","View/Executor/Utils","Core/helpers/Array/flatten","Vdom/_private/Utils/Monad","Vdom/_private/Synchronizer/resources/Hooks"],function(e,t,m,y,V,l,T){"use strict";function N(e,t){if(t)return e.children||[];else return y.Vdom.isVNodeType(e)?null===e.children?[]:e.children:[]}function k(e,t,o,r,n,i){if(o.stopped)return o;if(r&&y.Vdom.isTemplateVNodeType(o)&&o.children&&o.children[0])return o.children[0]=k(e,t,o.children[0],r),o;if(y.Vdom.isVNodeType(o)){if(t.control&&"Controls/Decorator/Markup"===t.control._moduleName)if(o.children&&o.children[0])o.children[0].stopped=true;var d=e(o.type,o.hprops,o.children,o.key,t,o.ref,o),l=o.type===d[0]&&o.props===d[1]&&o.children===d[2]&&o.key===d[3];if(i){if(o.type=d[0],o.props=d[1],o.children=d[2],o.key=d[3],!o.hookedInvControlIds||-1===o.hookedInvControlIds.indexOf(t.id))if(o.ref=d[4],o.hookedInvControlIds)o.hookedInvControlIds.push(t.id)}else return l?o:y.Vdom.htmlNode.apply(y.Vdom,d)}else return o}function o(e){return Array.isArray(e)?e[0]:e}function r(o,e,r,n,i){function d(e){var t=n(e)?[r(e)]:[];return o?t.concat(l.ListMonad.join(N(e,i),d)):t}return l.ListMonad.join(N(e,i),d)}function n(e){return e}function v(e,t){return r(true,e,n,y.Vdom.isControlVNodeType,t)}function g(e){return r(true,e,n,y.Vdom.isTemplateVNodeType)}function C(e,t,o){var r={create:[],createTemplates:[],destroy:[],destroyTemplates:[],update:[],updateTemplates:[],vnodeChanged:false},n,i,d,l,s,a,V;function p(e,t){function o(e){if(e)for(var t=0,o=e.length;t!==o;t++)if(void 0!==e[t].key)return true;return false}function r(e){for(var t={},o=[],r=e.length,n=0;n<r;n++){var i,d=e[n].key;if(void 0!==d)t[d]=n;else o.push(n)}return{keys:t,free:o}}var n,i,d,l,s,a,p,c,u,f,h,m,y;if(o(e)&&o(t)){for(a=r(e),p=r(t),i=a.keys,h=e.length,d=p.keys,m=t.length,s=(l=p.free).length,u=0,n=new Array(length),c=0;c!==h;c++)if(void 0!==(y=e[c]).key)if(d.hasOwnProperty(y.key))n[c]=t[d[y.key]];else n[c]=null;else if(u!==s)n[c]=t[l[u]],u++;else n[c]=null;for(f=u!==s?l[u]:m,c=0;c!==m;c++)if(void 0!==(V=t[c]).key){if(!i.hasOwnProperty(V.key))n.push(V)}else if(c>=f)n.push(t[c])}else n=t;return n}function c(e,t){var o=e&&y.Vdom.isControlVNodeType(e),r=t&&y.Vdom.isControlVNodeType(t),n=e&&y.Vdom.isTemplateVNodeType(e),i,d=n===(t&&y.Vdom.isTemplateVNodeType(t)),l=o===r;if(l){if(o)l=e.controlClass===t.controlClass&&e.key===t.key;else if((l=e.type===t.type)&&y.Vdom.isVNodeType(e))l=e.tagName===t.tagName&&e.namespace===t.namespace&&e.key===t.key}else if(d)if(n)l=e.template===t.template&&e.key===t.key;else if((l=e.type===t.type&&e.compound===t.compound)&&y.Vdom.isVNodeType(e))l=e.tagName===t.tagName&&e.namespace===t.namespace&&e.key===t.key;return l}function u(e,t,o){e[t]=e[t].concat(o)}if(e!==t||o)if(m.coreDebug.checkAssertion(!!t,"newNode !== null"),c(e,t))if(y.Vdom.isControlVNodeType(t))if(-1===e.controlNodeIdx)r.create.push(t);else r.update.push({oldNode:e,newNode:t});else if(y.Vdom.isTemplateVNodeType(t))if(!t.children&&t===e)r.createTemplates.push(t);else r.updateTemplates.push({oldNode:e,newNode:t});else{d=p(i=N(e),N(t)),l=Math.max(i.length,d.length);var f=0,h=d!==t.children;if(i.length!==d.length)r.vnodeChanged=true;for(s=0;s!==l;s++){if((a=i[s])&&"vdom-focus-in"===a.key&&!h){f++;continue}if(V=d[s-f],a&&V)n=C(a,V,o),r.vnodeChanged=r.vnodeChanged||n,u(r,"create",n.create),u(r,"destroy",n.destroy),u(r,"update",n.update),u(r,"createTemplates",n.createTemplates),u(r,"destroyTemplates",n.destroyTemplates),u(r,"updateTemplates",n.updateTemplates);else if(a)if(y.Vdom.isControlVNodeType(a))u(r,"destroy",[a]);else if(y.Vdom.isTemplateVNodeType(t))u(r,"destroy",v(a,true));else u(r,"destroy",v(a,true));else if(y.Vdom.isControlVNodeType(V))u(r,"create",[V]);else if(y.Vdom.isTemplateVNodeType(V))u(r,"createTemplates",[V]);else u(r,"create",v(V)),u(r,"createTemplates",g(V))}}else{if(r.vnodeChanged=true,y.Vdom.isControlVNodeType(t))r.create.push(t);else if(y.Vdom.isTemplateVNodeType(t))r.createTemplates.push(t);else u(r,"create",v(t)),u(r,"createTemplates",g(t));if(e)if(y.Vdom.isControlVNodeType(e))r.destroy.push(e);else if(y.Vdom.isTemplateVNodeType(e))u(r,"destroy",v(e,true));else u(r,"destroy",v(e,true))}return r}function i(e,t){var o;for(o in t)if(t.hasOwnProperty(o))if(!e.hasOwnProperty(o)||e[o]!==t[o])return true;for(o in e)if(e.hasOwnProperty(o)&&!t.hasOwnProperty(o))return true;return false}function x(e,t){return i(e.attributes,t.attributes)||i(e.events,t.events)||i(e.hooks,t.hooks)}function I(o,r,n,e,t){var i,d,l,s,a,p,c,u=false;if(y.Vdom.isControlVNodeType(r)){if(n)return r;if((i=o[r.controlNodeIdx].fullMarkup)&&i.type&&"invisible-node"===i.type){if(t&&t.type){if(!t.hookedInvControlIds)t.hookedInvControlIds=[];k(T.setControlNodeHook(o[r.controlNodeIdx]),o[r.controlNodeIdx],t,true,false,true)}i=y.Vdom.textNode("",o[r.controlNodeIdx].key)}}else if(y.Vdom.isTemplateVNodeType(r)&&!r.children)i=r;else if(!y.Vdom.isTemplateVNodeType(r)&&!y.Vdom.isVNodeType(r)||!r.children||0===r.children.length)i=r;else{d=0,s=(l=y.Vdom.isTemplateVNodeType(r)?r.children:N(r)).length;while(d!==s){if((a=I(o,l[d],n,void 0,r)).changed)u=true;if(a!==l[d])break;d++}if(d===s){if(i=r,!u&&e)if(i.children&&e.children)if(i.children.length!==e.children.length)u=true;else for(var f=0;f<i.children.length;f++)if(i.children[f]!==e.children[f]||e.children[f]&&e.children[f].changed){u=true;break}}else{if(c=l.slice(d+1).map(function(e){var t=I(o,e,n,void 0,r);if(t.changed)u=true;return t}),c=V(c,true),p=l.slice(0,d).concat(Array.isArray(a)?a:[a]).concat(c),y.Vdom.isTemplateVNodeType(r)){var h;return{compound:false,children:p,childrenForDiff:r.children,template:r.template,controlProperties:r.controlProperties,parentControl:r.parentControl,attributes:r.attributes,context:r.context,changed:true,type:"TemplateNode",optionsVersions:r.optionsVersions}.children}if(e){if(!u)if(!e.children&&p||e.children.length!==p.length)u=true;else for(var f=0;f<e.children.length;f++)if(e.children[f]!==p[f]||p[f].changed){u=true;break}if(!u)u=x(r.hprops,e.hprops);if(u)(i=y.Vdom.htmlNode(r.type,r.hprops,p,r.key,r.ref)).changed=true;else i=e}else(i=y.Vdom.htmlNode(r.type,r.hprops,p,r.key,r.ref)).changed=true}}if(y.Vdom.isTemplateVNodeType(i))if(i.children)i=i.children;else y.Vdom.textNode("",i.attributes.key);if(u)i.changed=true;return i}function d(e,t){return y.Vdom.htmlNode("span",{},[y.Vdom.textNode(e,(t||"err_"+Math.trunc(1e3*Math.random()))+"_inner_text")],t||"err_"+Math.trunc(1e3*Math.random()))}function s(e,t){var o=e.control._getMarkup(e.key,t,{key:e.key,attributes:e.attributes,events:e.events,inheritOptions:e.inheritOptions,templateContext:e.templateContext,internal:e.internal,domNodeProps:e.domNodeProps}),r;if(y.Vdom.isVNodeType(o))r=k(e.markupDecorator,e,o);else if(y.Vdom.isControlVNodeType(o))r=k(e.markupDecorator,e,o);else r=o;if(!y.Vdom.isControlVNodeType(r)&&!y.Vdom.isVNodeType(r)&&!y.Vdom.isTemplateVNodeType(r))r=d("control._getMarkup должен отдавать dom-узел",e.key);return r}Object.defineProperty(t,"__esModule",{value:true}),t.getVNodeChidlren=N,t.mapVNode=k,t.getMarkupDiff=C,t.getFullMarkup=I,t.getDecoratedMarkup=s});