define("Vdom/_private/Synchronizer/resources/DOMEnvironment",["require","exports","Core/core-debug","Core/constants","Core/IoC","Core/helpers/Array/findIndex","Core/helpers/isNewEnvironment","Vdom/_private/Synchronizer/resources/runDelayedRebuild","Vdom/_private/Synchronizer/resources/VdomMarkup","Vdom/_private/Synchronizer/resources/Hooks","Vdom/_private/Synchronizer/resources/SyntheticEvent","Vdom/_private/Synchronizer/resources/TabIndex","View/Executor/Expressions","View/Executor/Utils","View/Executor/Markup","Core/detection","Vdom/_private/Synchronizer/resources/Environment","Vdom/_private/Synchronizer/resources/SwipeController","View/Logger"],function(r,e,t,n,_,f,s,l,h,i,a,d,u,v,p,c,m,o,g){"use strict";Object.defineProperty(e,"__esModule",{value:true});var N=t.checkAssertion,y=9,b=function e(t){return"SPAN"===t.tagName&&"warning-container"===t.getAttribute("id")&&t.nextElementSibling&&"BODY"===t.nextElementSibling.tagName},w=function e(t,o,r){if(b(t))t.setAttribute("data-vdomignore","true"),o=true;if(8===r)o=true;return o},E=function e(t){var o=t.nodeType,r=1===o&&t.getAttribute("data-vdomignore");return r||w(t,r,o)};function C(c){return function r(e,t,o,n,i,s){var a,u,d=c(e,t,o,n,i,s),l=d[2];if(-1!==(a=f(l,function e(t){var o;return t!==h.mapVNode(r,i,t)}))&&void 0!==a)u=l.slice(a).map(h.mapVNode.bind(self,r,i)),l=l.slice(0,a).concat(u),d=[d[0],d[1],l,d[3],d[4]];return d}}function O(e){function l(e){var t,o,r,n,i;if(e)if(i=(r=e.split(";")).length)for(n=0;n!==i;n++)if(2===(o=r[n].split(":")).length){if(!t)t={};t[o[0].trim()]=o[1].trim()}return t}function d(e){var t=e.attributes,o,r=t.length,n,i,s,a,u,d=null;for(o=0;o!==r;o++)if("key"===(s=t[o]).name)d=s.value;else if("style"===s.name)i=l(s.value);else{if(!n)n={};n[s.name]=s.value}if(a={properties:u={}},n)u.attributes=n;if(i)u.style=i;if(a.key=d,"input"===e.tagName.toLowerCase()){if(!u.attributes)u.attributes={};if(!u.attributes.hasOwnProperty("value"))u.attributes.value=void 0}return a}function c(e){var t=e.nodeType,o;if(!E(e))if(e.__WS={},1===t)return r(e);else if(3===t){if("\n"===e.data||""===e.data)return e.parentNode.removeChild(e),-1;return v.Vdom.textNode(e.nodeValue)}return null}function r(e){var t=e.tagName,o="http://www.w3.org/1999/xhtml"==e.namespaceURI?null:e.namespaceURI,r=d(e),n=[],i,s=e.childNodes.length;for(i=0;i!==s;i++){var a=c(e.childNodes[i]);if(-1===a)i--,s--;else if(a)n.push(a)}var u=r&&r.properties&&r.properties.attributes||{};return o=o||v.Common.getNamespace(u),p.GeneratorVdom.createTag(t.toLowerCase(),r.properties,n,{attributes:{"ws-creates-context":"true"}})}return c(e)}function M(e,t){return!(e&&t)}function D(e,t){return t.control}function T(e){return!e.reduce(M,true)}function S(e){return e.reduce(D,true)}function k(e){return(e=e.hasOwnProperty("length")?e[0]:e)===document.documentElement||e===document.body||null===e.offsetParent?false:document.body.contains(e)}function V(e){var t=e._container.length?e._container[0].controlNodes:e._container.controlNodes;for(var o in t)if(t[o].control===e)return t[o]}function P(e){var t;if(e)if(e&&!e._options)t="Control "+e._moduleName+" with name "+(e.getName&&e.getName())+" must have _options";if(t)_.resolve("ILogger").error("DOMEnvironment","Incorrect opener or parent is found! It seems that anybody set wrong opener option! "+t)}function L(e,t){var o=e.control;if(t[t.length-1]!==o)t.push(o);var r=o._options.opener||e.parent;if(r&&!r.control)if(r._container)P(r),r=V(r);else r=null;if(r)L(r,t);else if(P(r=o._options&&o._options.opener||o.getOpener&&o.getOpener()||o.getParent&&o.getParent()),r)x(r,t)}function x(e,t){if(t[t.length-1]!==e)t.push(e);var o=e._options&&e._options.opener||e.getOpener&&e.getOpener()||e.getParent&&e.getParent();if(P(o),o)if(o._template){var r;L((o._container.length?o._container[0]:o._container).controlNodes[0],t)}else x(o,t)}function H(e,t){if(t=t||[],e&&e.jquery)e=e[0];if(e)if(e.controlNodes&&e.controlNodes.length)L(e.controlNodes[0],t);else if(n.compat&&e.wsControl)x(e.wsControl,t);else H(e.parentNode,t);return t}function I(e,t){if(e&&e.length>0)for(var o=0;o<e.length;o++)if(t.id===e[o].id)return true;return false}var A=m.default.extend({constructor:function(e,t,o){if(N(e!==document,"Корневой контрол нельзя монтировать на document"),this._rootDOMNode=e,this._rootVNode=O(e),this._captureEventHandlers={},this._markupNodeDecorator=C(i.setEventHooks(this)),this.addCaptureProcessingHandler("focus",this._handleFocusEvent),this.addCaptureProcessingHandler("blur",this._handleBlurEvent),this.addCaptureProcessingHandler("mousedown",this._handleMouseDown),this.addCaptureProcessingHandler("click",this._handleClick),this.addCaptureProcessingHandler("touchstart",this._handleTouchstart),this.addCaptureProcessingHandler("touchmove",this._handleTouchmove),this.addCaptureProcessingHandler("touchend",this._handleTouchend),this._handleTabKey=this._handleTabKey.bind(this),this._clickState={detected:false,stage:"",timer:void 0,timeout:500,target:null,touchCount:0,timeStart:void 0},!s()&&"undefined"!==typeof window)document.body.tabIndex=0;m.default.call(this,t,o)},destroy:function(){this.removeTabListener(),this.removeCaptureEventHandler("focus"),this.removeCaptureEventHandler("blur"),this.removeCaptureEventHandler("mousedown"),this.removeCaptureEventHandler("click"),this.removeCaptureEventHandler("touchstart"),this.removeCaptureEventHandler("touchmove"),this.removeCaptureEventHandler("touchend"),this._rootDOMNode=void 0,this._rootVNode=void 0,this._captureEventHandlers={},this._handleTabKey=void 0,A.superclass.destroy.call(this)}}),K=A.prototype;function U(e){try{if(e.control._afterMount&&e.control._afterMount(e.options,e.context),e.control._mounted=true,e.control._$needForceUpdate)delete e.control._$needForceUpdate,e.control._forceUpdate()}catch(e){g.catchLifeCircleErrors("_afterMount",e)}}function R(e,t){e.forEach(function(e){if(e.childrenNodes&&e.childrenNodes.length>0)R(e.childrenNodes,t);if(~t.indexOf(e.id))if(!e.control._mounted&&!e.control._unmounted)if(e.hasCompound)l.default(function(){U(e)});else U(e);else try{e.control._afterUpdate&&e.control._afterUpdate(e.oldOptions||e.options,e.oldContext)}catch(e){g.catchLifeCircleErrors("_afterUpdate",e)}})}function F(e){var t=e.target._cachedValue,o=e.target.value;if(void 0!==t&&t!==o){if(c.isIE12)var r=new Event("change");else{var r;(r=document.createEvent("Event")).initEvent("change",true,true)}r._dispatchedForIE=true,e.target.dispatchEvent(r)}e.target._cachedValue=void 0}function q(e){if(c.isIE)e._cachedValue=e.value}function z(e){if(!e)return false;if(e.classList.contains("vdom-focus-in")||e.classList.contains("vdom-focus-out"))return false;return e.parentElement===document.body&&!e.firstChild||c.isIE&&e===document.body}function B(e,t,o){var r=H(e),n=H(t),i=r.find(function(e){return-1!==n.indexOf(e)});n.find(function(e){if(e!==i)return e._notify("deactivated",[{isTabPressed:!!o,isShiftKey:o&&o.isShiftKey}]),e._active=false;else return true}),r.find(function(e){if(e!==i)return e._notify("activated",[{_$to:r[0],isTabPressed:!!o,isShiftKey:o&&o.isShiftKey}]),e._active=true,false;else return true})}K._handleTabKey=function(e){if(!this._rootDOMNode)return;var t,o;if(e.keyCode===y)if(t=d.findWithContexts(this._rootDOMNode,e.target,!!e.shiftKey,d.getElementProps),this._isTabPressed={isShiftKey:!!e.shiftKey},setTimeout(function(){this._isTabPressed=null}.bind(this),0),t){if(t.wsControl&&t.wsControl.setActive)t.wsControl.setActive(true);else d.focus(t);e.preventDefault(),e.stopImmediatePropagation()}else{if(this._rootDOMNode.wsControl)o=this._rootDOMNode.wsControl._oldKeyboardHover(e);if(false!==o);else e.preventDefault(),e.stopImmediatePropagation()}},K.addTabListener=function(){if(this._rootDOMNode)this._rootDOMNode.addEventListener("keydown",this._handleTabKey,false)},K.removeTabListener=function(){if(this._rootDOMNode)this._rootDOMNode.removeEventListener("keydown",this._handleTabKey)},K.autofocusChanges=function e(t){function n(e,t){var o;if(I(e.controlNodes,t))return e;if(e.children&&e.children.length>0){o=e.children;for(var r=0;r<o.length;r++)if(o[r].controlNodes){if(I(o[r].controlNodes,t))return i=o[r];n(o[r],t)}}return i}function o(e){var t=d.getElementProps(e);return t.tabStop="true"===e.getAttribute("ws-autofocus"),t}var i,r,s=t.control,a=t.environment,u;if(s.__$focusing&&a._rootDOMNode){if(i=n(a._rootDOMNode,t))if(r=d.findFirstInContext(i,void 0,o))d.focus(r);else d.focus(i);s.__$focusing=false}},K._handleFocusEvent=function e(t){if(q(t.target),this._rootDOMNode&&u.Focus.closest(t.target,this._rootDOMNode)&&!z(t.target)){var o=!z(t.relatedTarget)&&t.relatedTarget||this._savedFocusedElement;if(this._savedFocusedElement=t.target,B(t.target,o,this._isTabPressed),n.compat&&this._rootDOMNode&&this._rootDOMNode.controlNodes)if(this._rootDOMNode.controlNodes[0]&&this._rootDOMNode.controlNodes[0].control.isActive)if(this._rootDOMNode.controlNodes[0].control.isActive())this._rootDOMNode.controlNodes[0].control._callOnFocusInside();else r("Lib/Control/AreaAbstract/AreaAbstract.compatible")._storeActiveChildInner.apply(this._rootDOMNode.controlNodes[0].control);this._focused=true}ie.call(this,t)},K._handleBlurEvent=function e(t){var o,r;if(c.isIE)if(F(t),null===t.relatedTarget)r=document.body;if(o=t.target,r=r||t.relatedTarget,!s()&&r){var n,i;if(!H(r).find(function(e){return e._template}))B(null,o,this._isTabPressed)}ie.call(this,t)},K._handleMouseDown=function e(t){var o=t.target,r=document.documentElement;while(o!==r)if(o["ws-no-focus"]||o.getAttribute("ws-no-focus")){t.preventDefault();break}else o=o.parentNode;ie.call(this,t)};var Q=[];function W(e,t){while(e.parentNode)if((e=e.parentNode)===t)return true;return false}function j(e){if(!this._rootDOMNode)return;var t=e.relatedTarget||document.body,o=e.target,r=document.createEvent("Events");r.initEvent("keydown",true,true);var n=false;if("vdom-focus-in"===o.className)if(W(t,this._rootDOMNode))if(!(t.classList.contains("vdom-focus-out")&&"true"===this._rootDOMNode["ws-tab-cycling"]))n=true;if("vdom-focus-out"===o.className)if(!W(t,this._rootDOMNode))n=true;r.view=window,r.altKey=false,r.ctrlKey=false,r.shiftKey=n,r.metaKey=false,r.keyCode=9,o.dispatchEvent(r)}function G(e){if(!Array.isArray(e))return null;return e.find(function(e){return!!e})}function Y(t,e){var o=G(e.children),r=function(e){j.call(t,e)},n=function e(t){if(t)t.addEventListener("focus",r)};if(o&&"vdom-focus-in"!==o.key){var i=v.Vdom.htmlNode("a",{attributes:{class:"vdom-focus-in",tabindex:"1"}},[],"vdom-focus-in",n),s=v.Vdom.htmlNode("a",{attributes:{class:"vdom-focus-out",tabindex:"0"}},[],"vdom-focus-out",n);return e.children=[].concat(i,e.children,s),true}return false}function J(e,t){return Array.prototype.filter.call(e.children,function(e){return e.matches(t)})}function X(e){var t=e.firstChild;if(t&&t.classList&&!t.classList.contains("vdom-focus-in")){var o=J(e,".vdom-focus-in"),r=J(e,".vdom-focus-out"),n=o.length?o[0]:document.createElement("a");n.classList.add("vdom-focus-in"),n.tabIndex=1;var i=r.length?r[0]:document.createElement("a");return i.classList.add("vdom-focus-out"),i.tabIndex=0,e.insertBefore(n,t),e.appendChild(i),true}return false}function Z(e,t){return e&&e.args&&e.args.length===t.length}function ee(e,t,o){return e&&e.events&&e.events[t]&&e.events[t][o]}function te(t,e,o,r,n){var i,s=false,a="on:"+t.type.toLowerCase(),u,d,l,c,f,h;if(n)u=t.target===window||t.target===document?document.body:t.target;else u=e.element;u=n?u:e.element;while(!s){if((i=u.eventProperties)&&i[a])for(var v=o;v<i[a].length&&!s;v++){d=i[a][v].fn,l=i[a][v].args,f=Z(ee(e,a,v),l)?e.events[a][v].args:l;try{if(!r.concat)throw new Error("Аргументы обработчика события "+a.slice(3)+" должны быть массивом.");if(h=f.concat(r),h=[t].concat(h),t.currentTarget=u,!d.control._destroyed&&(!e||d.control!==e.control))d.apply(d.control,h);if(h=[],t.currentTarget=void 0,!t.propagating()){var p;if(!(!t.isStopped()&&i[a][v+1]&&(i[a][v+1].toPartial||i[a][v+1].fn.controlDestination===i[a][v].fn.controlDestination)))s=true}}catch(e){var m;if(!d.control){if("undefined"!==typeof window)window["console"].error("Error calculating the logical parent for the function ",d);m=new Error(t.type+" event handle error")}else m=new Error(t.type+" event handle error in "+d.control._moduleName);_.resolve("ILogger").error(u,m,e)}if(c=t.result,!e||!e.control._destroyed)if(c&&c.then)c.then(function(t){return function(e){return t.control._forceUpdate(),e}}(d));else d.control._forceUpdate();c=void 0}if(null===(u=u.parentNode)||void 0===u||!t.propagating())s=true;if(0!==o)o=0}}function oe(e,t){var o=e.element.eventProperties,r=e.element.controlNodes,n=0,i=0,s="on:"+t,a=true,u;if(o&&o[s]){u=o[s][0].fn.control;while(a&&i<r.length){if(r[i].control===u)if(++n<o[s].length)u=o[s][n].fn.control;if(r[i].control===e.control)a=false;i++}}return n}function re(e,t){function o(e){return"text"===e.type||"password"===e.type}if(!e._rootDOMNode)return false;else if(!(t.currentTarget===window&&"scroll"===t.type||t.currentTarget===window&&"resize"===t.type)&&1!==t.eventPhase)return false;else if(c.isIE&&"change"===t.type&&!t._dispatchedForIE&&o(t.target))return false;else if(!ne(e,t))return false;return true}function ne(e,t){var o=t.target;if(o===window||o===document)return true;while(o){if(o===e._rootDOMNode)return true;if(o.controlNodes&&o.controlNodes[0]&&o.controlNodes[0].environment===e)return true;else if(o.controlNodes&&o.controlNodes[0]&&o.controlNodes[0].environment!==e)return false;if(o===document.body)o=document.documentElement;else if(o===document.documentElement)o=document;else o=o.parentNode}return false}function ie(e){if(re(this,e)){var t;te(new a.default(e),null,0,[],true)}}K._handleClick=function e(t){if(this._shouldUseClickByTap())if(Q.indexOf(t.target)>-1)Q.splice(Q.indexOf(t.target),1);if(2===t.button)return void t.stopPropagation();var o=window.getSelection?window.getSelection():null,r=o&&o.toString().length&&t.target.contains(o.focusNode),n=window.getComputedStyle?"none"===window.getComputedStyle(t.target)["user-select"]:true;if(r&&!n)return void t.stopPropagation();ie.call(this,t)},K._handleTouchstart=function e(t){if(this._shouldUseClickByTap())Q.push(t.target);o.initSwipeState(t),ie.call(this,t)},K._handleTouchmove=function e(t){if(this._shouldUseClickByTap())if(this._clickState.touchCount++,this._clickState.touchCount>3)Q.splice(Q.indexOf(t.target),1);o.detectSwipe(t),ie.call(this,t)},K._handleTouchend=function e(t){if(this._shouldUseClickByTap())this._clickState.touchCount=0,setTimeout(function(){if(Q.indexOf(t.target)>-1)t.target.click()},this._clickState.timeout);o.resetSwipeState(),ie.call(this,t)},K._shouldUseClickByTap=function e(){return n.browser.retailOffline||n.compatibility.touch&&n.browser.chrome&&navigator&&navigator.userAgent.indexOf("Windows")>-1},K.applyNewVNode=function(e,t,o){if(!this._rootDOMNode)return;var r=this.decorateRootNode(e),n,i,s,a;if("HTML"!==this._rootDOMNode.tagName){if(r&&Y(this,r))if(this._rootVNode&&Y(this,this._rootVNode))X(this._rootDOMNode)}else if(r&&r.children[1]){var u=r.children[1];if(this._rootVNode&&Y(this,u)){var d=this._rootDOMNode.getElementsByTagName("body");if(d.length)X(d=d[0])}}if(this._rootDOMNode.isRoot=true,this._rootDOMNode.hasOwnProperty("$V")||!this._rootDOMNode.firstChild)s=this._rootVNode?v.Vdom.render(r,this._rootDOMNode,void 0,void 0,true):null;else s=this._rootVNode?v.Vdom.hydrate(r,this._rootDOMNode,true,true):null;if(this._rootVNode=r,n=T([o])){if(i=S([o]),a)i._container=window.$?$(a):a;l.default(function(){o.environment._haveRebuildRequest=false,i.reviveSuperOldControls&&i.reviveSuperOldControls(),R([o],t),o.environment._rebuildRequestStarted=false,o.environment.runQueue()})}else o.environment._haveRebuildRequest=false,R([o],t),o.environment._rebuildRequestStarted=false,o.environment.runQueue();return s},K.decorateFullMarkup=function(e,t){if(Array.isArray(e))e=e[0];return h.mapVNode(i.setControlNodeHook(t),t,e,true)},K.getMarkupNodeDecorator=function(){return this._markupNodeDecorator},K.getDOMNode=function(){return this._rootDOMNode},K.runQueue=function(){if(this.queue)for(var e=0;e<this.queue.length;e++)this.forceRebuild(this.queue[e]);this.queue=null,this.queueIds={}},K.startEvent=function(e,t){var o=t[0].toLowerCase(),r=t[1]||[],n=t[2],i={},s;if(i._bubbling=n&&void 0!==n.bubbling?n.bubbling:false,i.type=o,i.target=e.element,!i.target){if(!(e.fullMarkup instanceof u.RawMarkupNode)&&!(e.fullMarkup&&"invisible-node"===e.fullMarkup.type))_.resolve("ILogger").error("Event "+o+" has emited before mounting to DOM");return}return te(s=new a.default(null,i),e,oe(e,o),r,false),s.result},K.addCaptureEventHandler=function(e,t){var o=this._captureEventHandlers;if(this._rootDOMNode.parentNode)if(t.tagName&&"body"===t.tagName.toLowerCase()&&("scroll"===e||"resize"===e))if(void 0===o[e+"body"])o[e+"body"]={handler:ie.bind(this),count:1},window.addEventListener(e,o[e+"body"].handler);else o[e+"body"].count++;else if(void 0===o[e]){o[e]={handler:ie.bind(this),count:1};var r=u.Event.fixUppercaseDOMEventName(e);this._rootDOMNode.parentNode.addEventListener(r,o[e].handler,true)}else o[e].count++},K.addCaptureProcessingHandler=function e(t,o){var r=this._captureEventHandlers;if(void 0===r[t]){if(this._rootDOMNode.parentNode)r[t]={handler:function(e){if(!ne(this,e))return;o.apply(this,arguments)}.bind(this),count:1},this._rootDOMNode.parentNode.addEventListener(t,r[t].handler,true)}else r[t].count++},K.removeCaptureEventHandler=function(e,t){var o=this._captureEventHandlers;if(t&&t.tagName&&"body"===t.tagName.toLowerCase()&&("scroll"===e||"resize"===e)){if(o[e+"body"].count--,0===o[e+"body"])window.removeEventListener(e,o[e+"body"].handler)}else{var r=o[e];if(r)if(r.count--,0===r.count){if(this._rootDOMNode.parentNode)this._rootDOMNode.parentNode.removeEventListener(e,r.handler,true);delete o[e]}}},K._canDestroy=function(t){return!this._rootDOMNode||!this._rootDOMNode.controlNodes||!this._rootDOMNode.controlNodes.find(function(e){return!e.parent&&e.control!==t})},A._goUpByControlTree=H,e.default=A});