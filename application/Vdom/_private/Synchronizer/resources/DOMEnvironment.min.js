define("Vdom/_private/Synchronizer/resources/DOMEnvironment",["require","exports","Env/Env","Core/helpers/Array/findIndex","Core/helpers/isNewEnvironment","Vdom/_private/Synchronizer/resources/runDelayedRebuild","Vdom/_private/Synchronizer/resources/VdomMarkup","Vdom/_private/Synchronizer/resources/Hooks","Vdom/_private/Synchronizer/resources/SyntheticEvent","Vdom/_private/Synchronizer/resources/TabIndex","View/Executor/Expressions","View/Executor/Utils","View/Executor/Markup","Vdom/_private/Synchronizer/resources/Environment","Vdom/_private/Synchronizer/resources/SwipeController","View/Logger"],function(n,e,_,f,i,l,h,r,a,d,u,v,p,s,o,c){"use strict";Object.defineProperty(e,"__esModule",{value:true});var m=_.coreDebug.checkAssertion,g=9,N=function e(t){return"SPAN"===t.tagName&&"warning-container"===t.getAttribute("id")&&t.nextElementSibling&&"BODY"===t.nextElementSibling.tagName},y=function e(t,o,n){if(N(t))t.setAttribute("data-vdomignore","true"),o=true;if(8===n)o=true;return o},b=function e(t){var o=t.nodeType,n=1===o&&t.getAttribute("data-vdomignore");return n||y(t,n,o)};function w(c){return function n(e,t,o,r,i,s){var a,u,d=c(e,t,o,r,i,s),l=d[2];if(-1!==(a=f(l,function e(t){var o;return t!==h.mapVNode(n,i,t)}))&&void 0!==a)u=l.slice(a).map(h.mapVNode.bind(self,n,i)),l=l.slice(0,a).concat(u),d=[d[0],d[1],l,d[3],d[4]];return d}}function E(e){function l(e){var t,o,n,r,i;if(e)if(i=(n=e.split(";")).length)for(r=0;r!==i;r++)if(2===(o=n[r].split(":")).length){if(!t)t={};t[o[0].trim()]=o[1].trim()}return t}function d(e){var t=e.attributes,o,n=t.length,r,i,s,a,u,d=null;for(o=0;o!==n;o++)if("key"===(s=t[o]).name)d=s.value;else if("style"===s.name)i=l(s.value);else{if(!r)r={};r[s.name]=s.value}if(a={properties:u={}},r)u.attributes=r;if(i)u.style=i;if(a.key=d,"input"===e.tagName.toLowerCase()){if(!u.attributes)u.attributes={};if(!u.attributes.hasOwnProperty("value"))u.attributes.value=void 0}return a}function c(e){var t=e.nodeType,o;if(!b(e))if(e.__WS={},1===t)return n(e);else if(3===t){if("\n"===e.data||""===e.data)return e.parentNode.removeChild(e),-1;return v.Vdom.textNode(e.nodeValue)}return null}function n(e){var t=e.tagName,o="http://www.w3.org/1999/xhtml"==e.namespaceURI?null:e.namespaceURI,n=d(e),r=[],i,s=e.childNodes.length;for(i=0;i!==s;i++){var a=c(e.childNodes[i]);if(-1===a)i--,s--;else if(a)r.push(a)}var u=n&&n.properties&&n.properties.attributes||{};return o=o||v.Common.getNamespace(u),p.GeneratorVdom.createTag(t.toLowerCase(),n.properties,r,{attributes:{"ws-creates-context":"true"}})}return c(e)}function t(e,t){return!(e&&t)}function C(e,t){return t.control}function O(e){return!e.reduce(t,true)}function M(e){return e.reduce(C,true)}function D(e){return(e=e.hasOwnProperty("length")?e[0]:e)===document.documentElement||e===document.body||null===e.offsetParent?false:document.body.contains(e)}function T(e){var t=e._container.length?e._container[0].controlNodes:e._container.controlNodes;for(var o in t)if(t[o].control===e)return t[o]}function S(e){var t;if(e)if(e&&!e._options)t="Control "+e._moduleName+" with name "+(e.getName&&e.getName())+" must have _options";if(t)_.IoC.resolve("ILogger").error("DOMEnvironment","Incorrect opener or parent is found! It seems that anybody set wrong opener option! "+t)}function k(e){return e.getOpener&&e.getOpener()||e._options&&e._options.opener||e.getParent&&e.getParent()||e._options&&e._options.parent}function V(e,t){var o=e.control;if(t[t.length-1]!==o)t.push(o);var n=o._options.opener||e.parent;if(n&&!n.control)if(n._container)S(n),n=T(n);else n=null;if(n)V(n,t);else if(S(n=k(o)),n)L(n,t)}function L(e,t){if(t[t.length-1]!==e)t.push(e);var o=k(e);if(S(o),o)if(o._template){var n;V((o._container.length?o._container[0]:o._container).controlNodes[0],t)}else L(o,t)}function P(e,t){if(t=t||[],e&&e.jquery)e=e[0];if(e)if(e.controlNodes&&e.controlNodes.length)V(e.controlNodes[0],t);else if(_.constants.compat&&e.wsControl)L(e.wsControl,t);else P(e.parentNode,t);return t}function x(e,t){if(e&&e.length>0)for(var o=0;o<e.length;o++)if(t.id===e[o].id)return true;return false}var I=s.default.extend({constructor:function(e,t,o){if(m(e!==document,"Корневой контрол нельзя монтировать на document"),this._rootDOMNode=e,this._rootVNode=E(e),this._captureEventHandlers={},this._markupNodeDecorator=w(r.setEventHooks(this)),this.addCaptureProcessingHandler("focus",this._handleFocusEvent),this.addCaptureProcessingHandler("blur",this._handleBlurEvent),this.addCaptureProcessingHandler("mousedown",this._handleMouseDown),this.addCaptureProcessingHandler("click",this._handleClick),this.addCaptureProcessingHandler("touchstart",this._handleTouchstart),this.addCaptureProcessingHandler("touchmove",this._handleTouchmove),this.addCaptureProcessingHandler("touchend",this._handleTouchend),this._handleTabKey=this._handleTabKey.bind(this),this._clickState={detected:false,stage:"",timer:void 0,timeout:500,target:null,touchCount:0,timeStart:void 0},!i()&&"undefined"!==typeof window)document.body.tabIndex=0;s.default.call(this,t,o)},destroy:function(){this.runQueue(),this.removeTabListener(),this.removeCaptureEventHandler("focus"),this.removeCaptureEventHandler("blur"),this.removeCaptureEventHandler("mousedown"),this.removeCaptureEventHandler("click"),this.removeCaptureEventHandler("touchstart"),this.removeCaptureEventHandler("touchmove"),this.removeCaptureEventHandler("touchend"),this._rootDOMNode=void 0,this._rootVNode=void 0,this._captureEventHandlers={},this._handleTabKey=void 0,this.rootNodes=null,this._savedFocusedElement=void 0,I.superclass.destroy.call(this)}}),H=I.prototype;function A(e){try{if(e.control._afterMount&&e.control._afterMount(e.options,e.context),e.control._mounted=true,e.control._$needForceUpdate)delete e.control._$needForceUpdate,e.control._forceUpdate()}catch(e){c.catchLifeCircleErrors("_afterMount",e)}}function U(e,t){e.forEach(function(e){if(e.childrenNodes&&e.childrenNodes.length>0)U(e.childrenNodes,t);if(~t.indexOf(e.id))if(!e.control._mounted&&!e.control._unmounted)if(e.hasCompound)l.default(function(){A(e)});else A(e);else try{e.control._afterUpdate&&e.control._afterUpdate(e.oldOptions||e.options,e.oldContext)}catch(e){c.catchLifeCircleErrors("_afterUpdate",e)}})}function K(e){var t=e.target._cachedValue,o=e.target.value;if(void 0!==t&&t!==o){if(_.detection.isIE12)var n=new Event("change");else{var n;(n=document.createEvent("Event")).initEvent("change",true,true)}n._dispatchedForIE=true,e.target.dispatchEvent(n)}e.target._cachedValue=void 0}function q(e){if(_.detection.isIE)e._cachedValue=e.value}function R(e){if(!e)return false;if(e.classList.contains("vdom-focus-in")||e.classList.contains("vdom-focus-out"))return false;return e.parentElement===document.body&&!e.firstChild||_.detection.isIE&&e===document.body}function F(o,e,n){var t=P(o),r=P(e),i=t.find(function(e){return-1!==r.indexOf(e)});r.find(function(e){if(e!==i){var t=e._container;if(t&&t[0])t=t[0];if(t&&t.contains&&t.contains(o))return false;if(!B(t,document.body))return false;return e._notify("deactivated",[{isTabPressed:!!n,isShiftKey:n&&n.isShiftKey}]),e._active=false}else return true}),t.find(function(e){if(e!==i)return e._notify("activated",[{_$to:t[0],isTabPressed:!!n,isShiftKey:n&&n.isShiftKey}]),e._active=true,false;else return true})}H._handleTabKey=function(e){if(!this._rootDOMNode)return;var t,o;if(e.keyCode===g)if(t=d.findWithContexts(this._rootDOMNode,e.target,!!e.shiftKey,d.getElementProps),this._isTabPressed={isShiftKey:!!e.shiftKey},setTimeout(function(){this._isTabPressed=null}.bind(this),0),t){if(t.wsControl&&t.wsControl.setActive)t.wsControl.setActive(true);else d.focus(t);e.preventDefault(),e.stopImmediatePropagation()}else{if(this._rootDOMNode.wsControl)o=this._rootDOMNode.wsControl._oldKeyboardHover(e);if(false!==o);else e.preventDefault(),e.stopImmediatePropagation()}},H.addTabListener=function(){if(this._rootDOMNode)this._rootDOMNode.addEventListener("keydown",this._handleTabKey,false)},H.removeTabListener=function(){if(this._rootDOMNode)this._rootDOMNode.removeEventListener("keydown",this._handleTabKey)},H.autofocusChanges=function e(t){function r(e,t){var o;if(x(e.controlNodes,t))return e;if(e.children&&e.children.length>0){o=e.children;for(var n=0;n<o.length;n++)if(o[n].controlNodes){if(x(o[n].controlNodes,t))return i=o[n];r(o[n],t)}}return i}function o(e){var t=d.getElementProps(e);return t.tabStop="true"===e.getAttribute("ws-autofocus"),t}var i,n,s=t.control,a=t.environment,u;if(s.__$focusing&&a._rootDOMNode){if(i=r(a._rootDOMNode,t))if(n=d.findFirstInContext(i,void 0,o))d.focus(n);else d.focus(i);s.__$focusing=false}},H._handleFocusEvent=function e(t){if(q(t.target),this._rootDOMNode&&B(t.target,this._rootDOMNode)&&!R(t.target)){var o=!R(t.relatedTarget)&&t.relatedTarget||this._savedFocusedElement;if(this._savedFocusedElement=t.target,F(t.target,o,this._isTabPressed),_.constants.compat&&this._rootDOMNode&&this._rootDOMNode.controlNodes)if(this._rootDOMNode.controlNodes[0]&&this._rootDOMNode.controlNodes[0].control.isActive)if(this._rootDOMNode.controlNodes[0].control.isActive())this._rootDOMNode.controlNodes[0].control._callOnFocusInside();else n("Lib/Control/AreaAbstract/AreaAbstract.compatible")._storeActiveChildInner.apply(this._rootDOMNode.controlNodes[0].control);this._focused=true}re.call(this,t)},H._handleBlurEvent=function e(t){var o,n;if(_.detection.isIE)if(K(t),null===t.relatedTarget)n=document.activeElement;if(o=t.target,n=n||t.relatedTarget,!i()&&n){var r;if(!Q(n))F(n,o,this._isTabPressed)}re.call(this,t)},H._handleMouseDown=function e(t){var o=t.target,n=document.documentElement;while(o!==n)if(o["ws-no-focus"]||o.getAttribute("ws-no-focus")){t.preventDefault();break}else o=o.parentNode;re.call(this,t)};var z=[];function B(e,t){while(e.parentNode)if((e=e.parentNode)===t)return true;return false}function Q(e){while(e.parentNode)if((e=e.parentNode).controlNodes)return true;return false}function W(e){if(!this._rootDOMNode)return;var t=e.relatedTarget||document.body,o=e.target,n=document.createEvent("Events");n.initEvent("keydown",true,true);var r=false;if("vdom-focus-in"===o.className)if(B(t,this._rootDOMNode))if(!(t.classList.contains("vdom-focus-out")&&"true"===this._rootDOMNode["ws-tab-cycling"]))r=true;if("vdom-focus-out"===o.className)if(!B(t,this._rootDOMNode))r=true;n.view=window,n.altKey=false,n.ctrlKey=false,n.shiftKey=r,n.metaKey=false,n.keyCode=9,o.dispatchEvent(n)}function j(e){if(!Array.isArray(e))return null;return e.find(function(e){return!!e})}function G(t,e){var o=j(e.children),n=function(e){W.call(t,e)},r=function e(t){if(t)t.addEventListener("focus",n)};if(o&&"vdom-focus-in"!==o.key){var i=v.Vdom.htmlNode("a",{attributes:{class:"vdom-focus-in",tabindex:"1"}},[],"vdom-focus-in",r),s=v.Vdom.htmlNode("a",{attributes:{class:"vdom-focus-out",tabindex:"0"}},[],"vdom-focus-out",r);return e.children=[].concat(i,e.children,s),true}return false}function Y(e,t){return Array.prototype.filter.call(e.children,function(e){return e.matches(t)})}function J(e){var t=e.firstChild;if(t&&t.classList&&!t.classList.contains("vdom-focus-in")){var o=Y(e,".vdom-focus-in"),n=Y(e,".vdom-focus-out"),r=o.length?o[0]:document.createElement("a");r.classList.add("vdom-focus-in"),r.tabIndex=1;var i=n.length?n[0]:document.createElement("a");return i.classList.add("vdom-focus-out"),i.tabIndex=0,e.insertBefore(r,t),e.appendChild(i),true}return false}function X(e,t){return e&&e.args&&e.args.length===t.length}function Z(e,t,o){return e&&e.events&&e.events[t]&&e.events[t][o]}function ee(o,e,t,n,r){var i,s=false,a="on:"+o.type.toLowerCase(),u,d,l,c,f,h;if(r)u=o.target===window||o.target===document?document.body:o.target;else u=e.element;u=r?u:e.element;while(!s){if((i=u.eventProperties)&&i[a])for(var v=t;v<i[a].length&&!s;v++){d=i[a][v].fn,l=i[a][v].args,f=X(Z(e,a,v),l)?e.events[a][v].args:l;try{if(!n.concat)throw new Error("Аргументы обработчика события "+a.slice(3)+" должны быть массивом.");if(h=f.concat(n),h=[o].concat(h),o.currentTarget=u,!d.control._destroyed&&(!e||d.control!==e.control))d.apply(d.control,h);if(h=[],o.currentTarget=void 0,!o.propagating()){var p;if(!(!o.isStopped()&&i[a][v+1]&&(i[a][v+1].toPartial||i[a][v+1].fn.controlDestination===i[a][v].fn.controlDestination)))s=true}}catch(e){var m;if(!d.control){if("undefined"!==typeof window)window["console"].error("Error calculating the logical parent for the function ",d);m=new Error(o.type+" event handle error")}else m=new Error(o.type+" event handle error in "+d.control._moduleName);_.IoC.resolve("ILogger").error(u,m,e)}if(c=o.result,!e||!e.control._destroyed)if(c&&c.then)c.then(function(t){return function(e){if(!o.blockUpdate)t.control._forceUpdate();return e}}(d),function(e){return e});else if(!o.blockUpdate)d.control._forceUpdate();c=void 0}if(null===(u=u.parentNode)||void 0===u||!o.propagating())s=true;if(0!==t)t=0}}function te(e,t){var o=e.element.eventProperties,n=e.element.controlNodes,r=0,i=0,s="on:"+t,a=true,u;if(o&&o[s]){u=o[s][0].fn.control;while(a&&i<n.length){if(n[i].control===u)if(++r<o[s].length)u=o[s][r].fn.control;if(n[i].control===e.control)a=false;i++}}return r}function oe(e,t){function o(e){return"text"===e.type||"password"===e.type}if(!e._rootDOMNode)return false;else if(!(t.currentTarget===window&&"scroll"===t.type||t.currentTarget===window&&"resize"===t.type)&&1!==t.eventPhase)return false;else if(_.detection.isIE&&"change"===t.type&&!t._dispatchedForIE&&o(t.target))return false;else if(!ne(e,t))return false;return true}function ne(e,t){var o=t.target;if(o===window||o===document)return true;while(o){if(o===e._rootDOMNode)return true;if(o.controlNodes&&o.controlNodes[0]&&o.controlNodes[0].environment===e)return true;else if(o.controlNodes&&o.controlNodes[0]&&o.controlNodes[0].environment!==e)return false;if(o===document.body)o=document.documentElement;else if(o===document.documentElement)o=document;else o=o.parentNode}return false}function re(e){if(oe(this,e)){var t;ee(new a.default(e),null,0,[],true)}}H._handleClick=function e(t){if(this._shouldUseClickByTap())if(z.indexOf(t.target)>-1)z.splice(z.indexOf(t.target),1);if(2===t.button)return void t.stopPropagation();var o=window.getSelection?window.getSelection():null,n=o&&o.toString().length&&t.target.contains(o.focusNode),r=window.getComputedStyle?"none"===window.getComputedStyle(t.target)["user-select"]:true;if(n&&!r)return void t.stopPropagation();re.call(this,t)},H._handleTouchstart=function e(t){if(this._shouldUseClickByTap())z.push(t.target);o.initSwipeState(t),re.call(this,t)},H._handleTouchmove=function e(t){if(this._shouldUseClickByTap())if(this._clickState.touchCount++,this._clickState.touchCount>3)z.splice(z.indexOf(t.target),1);o.detectSwipe(t),re.call(this,t)},H._handleTouchend=function e(t){if(this._shouldUseClickByTap())this._clickState.touchCount=0,setTimeout(function(){if(z.indexOf(t.target)>-1)t.target.click()},this._clickState.timeout);o.resetSwipeState(),re.call(this,t)},H._shouldUseClickByTap=function e(){return _.constants.browser.retailOffline||_.constants.compatibility.touch&&_.constants.browser.chrome&&navigator&&navigator.userAgent.indexOf("Windows")>-1},H.applyNewVNode=function(e,t,o){if(!this._rootDOMNode)return;var n=this.decorateRootNode(e),r,i,s,a;if("HTML"!==this._rootDOMNode.tagName){if(n&&G(this,n))if(this._rootVNode&&G(this,this._rootVNode))J(this._rootDOMNode)}else if(n&&n.children[1]){var u=n.children[1];if(this._rootVNode&&G(this,u)){var d=this._rootDOMNode.getElementsByTagName("body");if(d.length)J(d=d[0])}}if(this._rootDOMNode.isRoot=true,this._rootDOMNode.hasOwnProperty("$V")||!this._rootDOMNode.firstChild)s=this._rootVNode?v.Vdom.render(n,this._rootDOMNode,void 0,void 0,true):null;else s=this._rootVNode?v.Vdom.hydrate(n,this._rootDOMNode,true,true):null;if(this._rootVNode=n,r=O([o])){if(i=M([o]),a)i._container=window.$?$(a):a;l.default(function(){o.environment._haveRebuildRequest=false,i.reviveSuperOldControls&&i.reviveSuperOldControls(),U([o],t),o.environment._rebuildRequestStarted=false,o.environment.runQueue()})}else o.environment._haveRebuildRequest=false,U([o],t),o.environment._rebuildRequestStarted=false,o.environment.runQueue();return s},H.decorateFullMarkup=function(e,t){if(Array.isArray(e))e=e[0];return h.mapVNode(r.setControlNodeHook(t),t,e,true)},H.getMarkupNodeDecorator=function(){return this._markupNodeDecorator},H.getDOMNode=function(){return this._rootDOMNode},H.runQueue=function(){if(this.queue){this.activateSubQueue=true;for(var e=0;e<this.queue.length;e++)this.forceRebuild(this.queue[e]);this.activateSubQueue=false}if(this.queue=null,this.queueIds={},this.subQueue)this.queue=this.subQueue,this.subQueueIds=this.queueIds,this.subQueue=null,this.subQueueIds={}},H.startEvent=function(e,t){var o=t[0].toLowerCase(),n=t[1]||[],r=t[2],i={},s;if(i._bubbling=r&&void 0!==r.bubbling?r.bubbling:false,i.type=o,i.target=e.element,!i.target){if(!(e.fullMarkup instanceof u.RawMarkupNode)&&!(e.fullMarkup&&"invisible-node"===e.fullMarkup.type))_.IoC.resolve("ILogger").error("Event "+o+" has emited before mounting to DOM");return}return ee(s=new a.default(null,i),e,te(e,o),n,false),s.result},H.addCaptureEventHandler=function(e,t){var o=this._captureEventHandlers;if(this._rootDOMNode.parentNode)if(t.tagName&&"body"===t.tagName.toLowerCase()&&("scroll"===e||"resize"===e))if(void 0===o[e+"body"])o[e+"body"]={handler:re.bind(this),count:1},window.addEventListener(e,o[e+"body"].handler);else o[e+"body"].count++;else if(void 0===o[e]){o[e]={handler:re.bind(this),count:1};var n=u.Event.fixUppercaseDOMEventName(e);this._rootDOMNode.parentNode.addEventListener(n,o[e].handler,true)}else o[e].count++},H.addCaptureProcessingHandler=function e(t,o){var n=this._captureEventHandlers;if(void 0===n[t]){if(this._rootDOMNode.parentNode)n[t]={handler:function(e){if(!ne(this,e))return;o.apply(this,arguments)}.bind(this),count:1},this._rootDOMNode.parentNode.addEventListener(t,n[t].handler,true)}else n[t].count++},H.removeCaptureEventHandler=function(e,t){var o=this._captureEventHandlers;if(t&&t.tagName&&"body"===t.tagName.toLowerCase()&&("scroll"===e||"resize"===e)){if(o[e+"body"].count--,0===o[e+"body"])window.removeEventListener(e,o[e+"body"].handler)}else{var n=o[e];if(n)if(n.count--,0===n.count){if(this._rootDOMNode.parentNode)this._rootDOMNode.parentNode.removeEventListener(e,n.handler,true);delete o[e]}}},H._canDestroy=function(t){return!this._rootDOMNode||!this._rootDOMNode.controlNodes||!this._rootDOMNode.controlNodes.find(function(e){return!e.parent&&e.control!==t})},I._goUpByControlTree=P,e.default=I});