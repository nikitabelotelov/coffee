define("Vdom/_private/Synchronizer/resources/DirtyChecking",["require","exports","Env/Env","Vdom/_private/Utils/Monad","Vdom/_private/Utils/Functional","View/Executor/Expressions","Vdom/_private/Synchronizer/resources/VdomMarkup","View/Executor/Utils","View/Executor/Expressions","Core/helpers/Function/shallowClone","Vdom/_private/Synchronizer/resources/runDelayedRebuild","Core/Serializer","View/Logger","Vdom/_private/Synchronizer/resources/DirtyCheckingCompatible"],function(e,S,U,F,n,o,z,L,j,t,K,r,W,k){"use strict";Object.defineProperty(S,"__esModule",{value:true});var Y=new r,q;if(U.constants.compat)q=k;function H(e){if(e.control&&e.control._getInternalOption&&e.control._getInternalOption("parent")){var t=o.Subscriber.getEventsListFromOptions(e.options);o.Subscriber.applyEvents(e.control,e.control._getInternalOption("parent"),t)}}function T(e,t,o){e.parent=e.parent||o&&o.control||t.parent||null,e.logicParent=e.logicParent||o&&o.control&&o.control.logicParent||t.logicParent||null}function b(e){return"function"===typeof e?e:e["constructor"]}function C(e){return"[object Date]"===Object.prototype.toString.call(e)}S.DirtyKind={NONE:0,DIRTY:1,CHILD_DIRTY:2};var B=[],G={plus:function(e,t){return{createdNodes:e.createdNodes.concat(t.createdNodes),destroyedNodes:e.destroyedNodes.concat(t.destroyedNodes),updatedNodes:e.updatedNodes.concat(t.updatedNodes),createdTemplateNodes:e.createdTemplateNodes.concat(t.createdTemplateNodes),updatedTemplateNodes:e.updatedTemplateNodes.concat(t.updatedTemplateNodes),updatedChangedNodes:e.updatedChangedNodes.concat(t.updatedChangedNodes),updatedChangedTemplateNodes:e.updatedChangedTemplateNodes.concat(t.updatedChangedTemplateNodes),updatedUnchangedNodes:e.updatedUnchangedNodes.concat(t.updatedUnchangedNodes),selfDirtyNodes:e.selfDirtyNodes.concat(t.selfDirtyNodes)}},zero:{createdNodes:[],destroyedNodes:[],updatedNodes:[],createdTemplateNodes:[],updatedTemplateNodes:[],updatedUnchangedNodes:[],updatedChangedNodes:[],updatedChangedTemplateNodes:[],selfDirtyNodes:[]}};function J(e,t){var o;for(o in t)if(t.hasOwnProperty(o))e[o]=t[o];return e}function Q(e){var t={};for(var o in e)if(e.hasOwnProperty(o))if(e[o]&&e[o].getVersion)t[o]=e[o].getVersion();else if(e[o]&&e[o].isDataArray)for(var r=0;r<e[o].length;r++){var n=Q(e[o][r].internal||{});for(var a in n)if(n.hasOwnProperty(a))t[o+";"+r+";"+a]=n[a]}return t}function O(e){return e&&e.internal?e.internal:{}}function D(e,t){return"object"===typeof e&&e&&t&&e.getVersion}function X(e,t,o,r,n,a){var i,l,s=false,d={},c,p;for(i in t){if(o&&i&&i.indexOf("__dirtyCheckingVars_")>-1)continue;if(c=t.hasOwnProperty(i)||n&&void 0!==t[i])if(p=e.hasOwnProperty(i)||void 0!==e[i]){if("number"===typeof e[i]&&"number"===typeof t[i]&&isNaN(e[i])&&isNaN(t[i]))continue;if(e[i]===t[i]){if(D(e[i],r)){var u=e[i].getVersion(),f=a||"";if(r[f+i]!==u)s=true,d[i]=e[i],r[f+i]=u;else if(Array.isArray(e[i])&&e[i])if(!e[i].isDataArray)s=true,d[i]=e[i]}}else if(Array.isArray(e[i])&&e[i])if(!e[i].isDataArray)s=true,d[i]=e[i];else{if(!t[i]){s=true,d[i]=e[i];continue}for(var m=0;m<e[i].length;m++){var h=i+";"+m+";",g;if(a)h=a+h;if(X(O(e[i][m]),O(t[i][m]),false,r,n,h)){s=true,d[i]=e[i];break}}}else if(i.indexOf("__dirtyCheckingVars_")>-1&&"object"===typeof t[i]&&"object"===typeof e[i]&&e[i]&&t[i]&&!C(e[i]))if(e[i]!==t[i]){s=true,d[i]=e[i];break}else{var v;if(X(e[i],t[i],true,{},true)){s=true,d[i]=e[i];break}}else if(e[i]&&e[i]._preferVersionAPI){var N=e[i].getVersion(),y=a||"";if(r[y+i]!==N){s=true,d[i]=e[i],r[y+i]=N;break}}else if(e[i]&&e[i]._isDeepChecking&&t[i]&&t[i]._isDeepChecking){var _;if(X(e[i],t[i],true,{},true)){s=true,d[i]=e[i];break}}else{if(e[i]&&e[i]._ignoreChanging)continue;if(s=true,d[i]=e[i],D(e[i],r))r[(a||"")+i]=e[i].getVersion()}}}return s?d:null}function a(e){return(e=e||[]).reduce(function(e,t){return e.concat(Array.isArray(t)?a(t):t)},[])}function V(e,t,o){var r;return{markupDecorator:n.composeWithResultApply.call(void 0,[o.getMarkupNodeDecorator()]).bind(e),defaultOptions:{}}}function Z(e,t,o){var r=e.parentControl?e.template.call(e.parentControl,e.controlProperties,e.attributes,e.context,true):e.template(e.controlProperties,e.attributes,e.context,true),n=[],a;if(!Array.isArray(r))r=[r];for(a=0;a<r.length;a++){var i=z.getFullMarkup(t,r[a],true);n=n.concat(Array.isArray(i)?i:[i])}for(a=0;a<n.length;a++)n[a]=z.mapVNode(o.getMarkupNodeDecorator(),t,n[a]);return r=n}function ee(e,t,o,r,n,a,i){var l=b(e),s=i&&i.compound,d=a&&a.state||{vdomCORE:true},c=t.user,p=t.internal||{},u;if(T(p,c,n),!o)o="_";if(s){if(!q)q=k;u=q.createCompoundControlNode(e,l,c,p,o,n,i)}else{var f=i&&i.invisible,m=d?J(c,d):c,h,g,v,N,y,_,C;if("function"===typeof e)v=(_=L.Compatible.createInstanceCompatible(l,m,p)).instance,m=_.resolvedOptions,C=_.defaultOptions;else if(v=e,C=L.OptionsResolver.getDefaultOptions(e),U.constants.compat)if(m=L.Compatible.combineOptionsIfCompatible(l.prototype,m,p),v._setInternalOptions)v._options.doNotSetParent=true,v._setInternalOptions(p||{});h=Q(m),g=Q(y=i&&i.context||{}),N=V(v,l,r),u={attributes:t.attributes,events:t.events,control:v,errors:a&&a.errors,controlClass:l,options:m,internalOptions:p,optionsVersions:h,id:v._instId||0,parent:n,key:o,defaultOptions:C,markup:f?L.Vdom.textNode(""):void 0,fullMarkup:void 0,childrenNodes:B,markupDecorator:N&&N.markupDecorator,serializedChildren:a&&a.childrenNodes,hasCompound:false,receivedState:void 0,invisible:f,contextVersions:g,context:i&&i.context||{},inheritOptions:i&&i.inheritOptions||{}},r.setupControlNode(u)}return u}function i(e){return t(e)}function te(o,r,n,a,i){if(n.receivedState&&n.receivedState.then)return n.receivedState.then(function e(t){return n.receivedState=t,l(o,r,n,a,i)},function(e){return L.Common.asyncRenderErrorLog(e),n.receivedState=null,l(o,r,n,a,i)});else return l(o,r,n,a,i)}function oe(e,t){if(!e)return;try{if(t.setRebuildIgnoreId(e.id),e.compound){var o=e.options,r=o.__vdomOptions&&o.__vdomOptions.controlNode.instance;if(r)K.default(function(){r.destroy()})}else{for(var n=0;n<e.childrenNodes.length;n++)oe(e.childrenNodes[n],t);if(e.control.__$destroyFromDirtyChecking=true,e.control.destroy(),delete e.controlProperties,delete e.oldOptions,delete e.element,delete e.fullMarkup,delete e.markup,e.control._logicParent&&e.control._logicParent._template&&e.control._options.name)delete e.control._logicParent._children[e.control._options.name]}}finally{t.setRebuildIgnoreId(e.id)}}function re(e){if(e.fullMarkup)e.fullMarkup.changed=true;if(e.parent&&e.parent.fullMarkup&&!e.parent.fullMarkup.changed)re(e.parent)}function ne(e,t){if(e.children)for(var o=0;o<e.children.length;o++)if(L.Vdom.isControlVNodeType(e.children[o]))t.push(e.children[o]);else if(L.Vdom.isTemplateVNodeType(e.children[o])||L.Vdom.isVNodeType(e.children[o]))ne(e.children[o],t)}function l(D,V,e,t,o){var r=e.id,n,a=V[r]||S.DirtyKind.NONE,i=a!==S.DirtyKind.NONE||t,l=!!(a&S.DirtyKind.DIRTY)||t,s=e.markup,d,c=false,v,x,p,u,f,m,h,g,N,y=[],_,C,k,T,b,O,I,M,P,R,A;if(i){if(R=(v=e).context,A=j.ContextResolver.resolveContext(v.controlClass,R,v.control),!v.compound){if(l&&v.control._mounted&&!t){try{v.control.__beforeUpdate(v.options,A)}catch(e){W.catchLifeCircleErrors("_beforeUpdate",e)}try{d=v.control._shouldUpdate(v.options,A)}catch(e){W.catchLifeCircleErrors("_shouldUpdate",e)}l=l&&d}if(l){if(W.log("DirtyChecking",["requestRebuild "+r,v.control,v]),(x=v).control.saveFullContext(j.ContextResolver.wrapContext(v.control,v.context||{})),!v.inheritOptions)v.inheritOptions={};if(L.OptionsResolver.resolveInheritOptions(v.controlClass,v,v.options),v.control.saveInheritOptions(v.inheritOptions),v.markup=z.getDecoratedMarkup(v,o),p=z.getMarkupDiff(s,v.markup),W.log("DirtyChecking (diff)",["","",p]),p.destroy.length||p.vnodeChanged)re(v),c=true;while(p.createTemplates.length>0||p.updateTemplates.length>0){var E={create:[],createTemplates:[],destroy:[],destroyTemplates:[],update:[],updateTemplates:[]};f=p.createTemplates.map(function e(t){W.log("DirtyChecking (create template)",["","",t]),t.optionsVersions=Q(t.controlProperties),t.contextVersions=Q(t.context),t.children=Z(t,v,D);for(var o=0;o<t.children.length;o++){var r=z.getMarkupDiff(null,t.children[o]);E.create=E.create.concat(r.create),E.createTemplates=E.createTemplates.concat(r.createTemplates),E.update=E.update.concat(r.update),E.updateTemplates=E.updateTemplates.concat(r.updateTemplates)}return t}),p.createTemplates=E.createTemplates,p.updateTemplates=p.updateTemplates.concat(E.updateTemplates),E.createTemplates=[],E.updateTemplates=[],h=p.updateTemplates.map(function e(t){W.log("DirtyChecking (update template)",["","",t]);var o=t.newNode,r=t.oldNode,n=r.controlProperties,a,i=X(o.controlProperties,n,false,r.optionsVersions),l=r.attributes.attributes,s,d=X(o.attributes.attributes,l,false,{}),c=r.template!==o.template,p,u;if(i||d||c){W.log("DirtyChecking (update template with changed options)",["","",i]);var f=r.children;o.children=Z(o,v,D);var m=o.children.length>f.length?o.children.length:f.length;for(u=0;u<m;u++){var h=f[u],g=o.children[u];if(g)p=z.getMarkupDiff(h,g,true),E.create=E.create.concat(p.create),E.createTemplates=E.createTemplates.concat(p.createTemplates),E.update=E.update.concat(p.update),E.updateTemplates=E.updateTemplates.concat(p.updateTemplates),E.destroy=E.destroy.concat(p.destroy);else if(h)if(L.Vdom.isControlVNodeType(h))E.destroy.push(h);else if(L.Vdom.isTemplateVNodeType(h)||L.Vdom.isVNodeType(h))ne(h,E.destroy)}}else for(o.children=r.children,u=0;u<o.children.length;u++)p=z.getMarkupDiff(r.children[u],o.children[u],true),E.create=E.create.concat(p.create),E.createTemplates=E.createTemplates.concat(p.createTemplates),E.update=E.update.concat(p.update),E.updateTemplates=E.updateTemplates.concat(p.updateTemplates),E.destroy=E.destroy.concat(p.destroy);return o.optionsVersions=r.optionsVersions,o}),p.updateTemplates=E.updateTemplates,p.create=p.create.concat(E.create),p.destroy=p.destroy.concat(E.destroy),p.update=p.update.concat(E.update),p.createTemplates=p.createTemplates.concat(E.createTemplates)}if(C=p.destroy.map(function e(t){var o=t.controlNodeIdx,r=x.childrenNodes[o];return oe(r,D),r}),M=new Array(p.create.length+p.update.length),P=new Array(p.createTemplates.length+p.updateTemplates.length),I=p.update.length,f=[],h=[],u=p.create.map(function e(t,o){var r=I+o,n=x.serializedChildren,a=n&&n[r],i,l,s;if(W.log("DirtyChecking (create node)",["","",o,t]),c=true,!t.compound){if(i=t.controlProperties,!(s=ee(t.controlClass,{user:i,internal:t.controlInternalProperties,attributes:t.controlAttributes,events:t.controlEvents},t.key,D,x,a,t)).control._mounted&&!s.control._unmounted){if(l=L.Vdom.getReceivedState(s,t,Y))s.receivedState=l;if(s.control.saveOptions)s.control.saveOptions(s.options,s);else if(s.control._options=s.options,s.control._container=s.element,s.control._setInternalOptions(t.controlInternalProperties||{}),U.constants.compat)s.control._container=$(s.element)}if(U.constants.compat&&(!s.control.hasCompatible||s.control.hasCompatible()))H(s)}else s=ee(t.controlClass,{user:J(t.controlProperties,t.controlInternalProperties),attributes:t.controlAttributes,events:t.controlEvents},t.key,D,x,a,t);return t.controlNodeIdx=r,M[t.controlNodeIdx]=true,s}),O=(m=p.update.map(function e(t,o){W.log("DirtyChecking (update node)",["","",t]);var r=t.newNode,n=t.oldNode.controlNodeIdx,a=x.childrenNodes[n],i=a.control,l=true,s=r.compound?L.Compatible.createCombinedOptions(r.controlProperties,r.controlInternalProperties):r.controlProperties,d=a.options,c=a.optionsVersions,p=r.context||{},u=a.context,f=a.contextVersions,m=X(s,d,r.compound,c),h=X(p,u,false,f),g=h?h:X(p,u,false,f,true),v=a.controlAttributes||a.attributes,N=X(r.controlAttributes,v,r.compound),y;if(r.compound){if(s.__vdomOptions=d.__vdomOptions,m){var _=d.__vdomOptions&&d.__vdomOptions.controlNode.instance;if(_&&!_.__$$blockSetProperties){var C=X(s,_._options||{},r.compound);if(C)_.__$$blockSetProperties=true,m=q.clearNotChangedOptions(m,C),_.setProperties(m),K.default(function(){_.__$$blockSetProperties=false})}}a.options=s}else if(y=X(r.controlInternalProperties,a.internalOptions),m||y||N||h)try{var k;W.log("DirtyChecking (update node with changed)",["","",m||y||N||h]),D.setRebuildIgnoreId(a.id),L.OptionsResolver.resolveInheritOptions(a.controlClass,a,s),i.saveInheritOptions(a.inheritOptions),k=j.ContextResolver.resolveContext(a.controlClass,p,a.control),L.OptionsResolver.resolveOptions(a.controlClass,a.defaultOptions,s,a.parent.control._moduleName),i._beforeUpdate&&i.__beforeUpdate(s,k),i._options=s,l=(i._shouldUpdate?i._shouldUpdate(s,k):true)||y,i._setInternalOptions(y||{}),a.oldOptions=d,a.oldContext=u,a.attributes=r.controlAttributes,a.events=r.controlEvents,i._saveContextObject(k),i.saveFullContext(j.ContextResolver.wrapContext(i,i._context))}finally{var T=i._shouldUpdate?i._shouldUpdate(s,p)||y:true;if(i._setInternalOptions(y||{}),T)D.setRebuildIgnoreId(null);if(a.options=s,a.context=p,!r.compound)a.internalOptions=r.controlInternalProperties}else if(g)for(var b=a.childrenNodes,O=0;O<b.length;O++)V[b[O].id]|=S.DirtyKind.CHILD_DIRTY;return M[o]=(!!m||!!y||!!h||!!N)&&l,r.controlNodeIdx=o,a.events=r.controlEvents,a})).concat(u),_=N=g=B,m.forEach(function(e,t){if(M[t]){if(N===B)N=[];N.push(e)}else{if(g===B)g=[];g.push(e)}}),N.length||u.length)re(v),c=true;if(-1===O.indexOf(v)){if(_===B)_=[];_.push(v)}}else O=e.childrenNodes,_=C=y=N=g=m=f=u=B}else if(O=e.childrenNodes,_=C=y=N=g=m=f=u=B,v.compound)v.parent.hasCompound=true;if((b=F.mapM(O,function(e,t){if(M&&M[t])re(e);return te(D,V,e,M&&M[t])},S.RebuildResultWriter)).then)return b.then(function(e){if(v.childrenNodes=e.value,c||!v.fullMarkup||v.fullMarkup.changed||l){var t=v.fullMarkup&&v.fullMarkup.changed;if(v.fullMarkup=D.decorateFullMarkup(z.getFullMarkup(v.childrenNodes,v.markup,void 0,c||l?void 0:v.fullMarkup),v),v.fullMarkup.changed=t||v.fullMarkup.changed||c||l,v.fullMarkup.changed)re(v)}return{value:v,memo:G.plus(e.memo,{createdNodes:u,updatedNodes:m,destroyedNodes:C,updatedChangedNodes:N,updatedChangedTemplateNodes:y,updatedUnchangedNodes:g,selfDirtyNodes:_,createdTemplateNodes:f,updatedTemplateNodes:h,destroyedTemplateNodes:k})}},function(e){return L.Common.asyncRenderErrorLog(e),e});else{if(v.childrenNodes=b.value,c||!v.fullMarkup||v.fullMarkup.changed||l){var w=v.fullMarkup&&v.fullMarkup.changed;if(v.fullMarkup=D.decorateFullMarkup(z.getFullMarkup(v.childrenNodes,v.markup,void 0,c||l?void 0:v.fullMarkup),v),v.fullMarkup.changed=w||v.fullMarkup.changed||c||l,v.fullMarkup.changed)re(v)}T={value:v,memo:G.plus(b.memo,{createdNodes:u,updatedNodes:m,destroyedNodes:C,updatedChangedNodes:N,updatedChangedTemplateNodes:y,updatedUnchangedNodes:g,selfDirtyNodes:_,createdTemplateNodes:f,updatedTemplateNodes:h,destroyedTemplateNodes:k})}}}else T={value:e,memo:G.zero};return T}S.RebuildResultWriter=F.createWriterMonad(G),S.createNode=ee,S.destroyReqursive=oe,S.rebuildNode=l});