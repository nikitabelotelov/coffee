define("Vdom/_private/Synchronizer/resources/DirtyChecking",["require","exports","Core/constants","Vdom/_private/Utils/Monad","Vdom/_private/Utils/Functional","View/Executor/Expressions","Vdom/_private/Synchronizer/resources/VdomMarkup","View/Executor/Utils","View/Executor/Expressions","Core/helpers/Function/shallowClone","Vdom/_private/Synchronizer/resources/runDelayedRebuild","Core/Serializer","View/Logger","Vdom/_private/Synchronizer/resources/DirtyCheckingCompatible"],function(e,S,U,F,n,o,z,L,K,t,W,r,Y,T){"use strict";Object.defineProperty(S,"__esModule",{value:true});var j=new r,q;if(U.compat)q=T;function H(e){if(e.control&&e.control._getInternalOption&&e.control._getInternalOption("parent")){var t=o.Subscriber.getEventsListFromOptions(e.options);o.Subscriber.applyEvents(e.control,e.control._getInternalOption("parent"),t)}}function _(e,t,o){e.parent=e.parent||o&&o.control||t.parent||null,e.logicParent=e.logicParent||o&&o.control&&o.control.logicParent||t.logicParent||null}function k(e){return"function"===typeof e?e:e["constructor"]}S.DirtyKind={NONE:0,DIRTY:1,CHILD_DIRTY:2};var B=[],G={plus:function(e,t){return{createdNodes:e.createdNodes.concat(t.createdNodes),destroyedNodes:e.destroyedNodes.concat(t.destroyedNodes),updatedNodes:e.updatedNodes.concat(t.updatedNodes),createdTemplateNodes:e.createdTemplateNodes.concat(t.createdTemplateNodes),updatedTemplateNodes:e.updatedTemplateNodes.concat(t.updatedTemplateNodes),updatedChangedNodes:e.updatedChangedNodes.concat(t.updatedChangedNodes),updatedChangedTemplateNodes:e.updatedChangedTemplateNodes.concat(t.updatedChangedTemplateNodes),updatedUnchangedNodes:e.updatedUnchangedNodes.concat(t.updatedUnchangedNodes),selfDirtyNodes:e.selfDirtyNodes.concat(t.selfDirtyNodes)}},zero:{createdNodes:[],destroyedNodes:[],updatedNodes:[],createdTemplateNodes:[],updatedTemplateNodes:[],updatedUnchangedNodes:[],updatedChangedNodes:[],updatedChangedTemplateNodes:[],selfDirtyNodes:[]}};function J(e,t){var o;for(o in t)if(t.hasOwnProperty(o))e[o]=t[o];return e}function Q(e){var t={};for(var o in e)if(e.hasOwnProperty(o))if(e[o]&&e[o].getVersion)t[o]=e[o].getVersion();return t}function m(e){return e&&e.internal?e.internal:{}}function h(e,t){return"object"===typeof e&&e&&t&&e.getVersion}function X(e,t,o,r,n){var a,i,d=false,l={},s,c;for(a in t){if(o&&a&&a.indexOf("__dirtyCheckingVars_")>-1)continue;if(s=t.hasOwnProperty(a)||n&&void 0!==t[a])if(c=e.hasOwnProperty(a)||void 0!==e[a]){if("function"===typeof e[a]&&"function"===typeof t[a]||"number"===typeof e[a]&&"number"===typeof t[a]&&isNaN(e[a])&&isNaN(t[a]))continue;if(e[a]===t[a]){if(h(e[a],r)){var p=e[a].getVersion();if(r[a]!==p)r[a]=p,d=true,l[a]=e[a];else if(Array.isArray(e[a])&&e[a])if(!e[a].isDataArray)d=true,l[a]=e[a]}}else if(Array.isArray(e[a])&&e[a])if(!e[a].isDataArray)d=true,l[a]=e[a];else{if(!t[a]){d=true,l[a]=e[a];continue}for(var u=0;u<e[a].length;u++){var f;if(X(m(e[a][u]),m(t[a][u]),false,r,n)){d=true,l[a]=e[a];break}}}else if(d=true,l[a]=e[a],h(e[a],r))r[a]=e[a].getVersion()}}return d?l:null}function a(e){return(e=e||[]).reduce(function(e,t){return e.concat(Array.isArray(t)?a(t):t)},[])}function b(e,t,o){var r;return{markupDecorator:n.composeWithResultApply.call(void 0,[o.getMarkupNodeDecorator()]).bind(e),defaultOptions:{}}}function Z(e,t,o){var r=e.parentControl?e.template.call(e.parentControl,e.controlProperties,e.attributes,e.context,true):e.template(e.controlProperties,e.attributes,e.context,true),n=[],a;if(!Array.isArray(r))r=[r];for(a=0;a<r.length;a++){var i=z.getFullMarkup(t,r[a],true);n=n.concat(Array.isArray(i)?i:[i])}for(a=0;a<n.length;a++)n[a]=z.mapVNode(o.getMarkupNodeDecorator(),t,n[a]);return r=n}function ee(e,t,o,r,n,a,i){var d=k(e),l=i&&i.compound,s=a&&a.state||{vdomCORE:true},c=t.user,p=t.internal||{},u;if(_(p,c,n),!o)o="_";if(l){if(!q)q=T;u=q.createCompoundControlNode(e,d,c,p,o,n,i)}else{var f=i&&i.invisible,m=s?J(c,s):c,h,g,v,N,y,C;if("function"===typeof e)v=(C=L.Compatible.createInstanceCompatible(d,m,p)).instance,m=C.resolvedOptions;else if(v=e,U.compat)if(m=L.Compatible.combineOptionsIfCompatible(d.prototype,m,p),v._setInternalOptions)v._options.doNotSetParent=true,v._setInternalOptions(p||{});h=Q(m),g=Q(y=i&&i.context||{}),N=b(v,d,r),u={attributes:t.attributes,events:t.events,control:v,errors:a&&a.errors,controlClass:d,options:m,internalOptions:p,optionsVersions:h,id:v._instId||0,parent:n,key:o,defaultOptions:N&&N.defaultOptions,markup:f?L.Vdom.textNode(""):void 0,fullMarkup:void 0,childrenNodes:B,markupDecorator:N&&N.markupDecorator,serializedChildren:a&&a.childrenNodes,hasCompound:false,receivedState:void 0,invisible:f,contextVersions:g,context:i&&i.context||{},inheritOptions:i&&i.inheritOptions||{}},r.setupControlNode(u)}return u}function i(e){return t(e)}function te(o,r,n,a,i){if(n.receivedState&&n.receivedState.then)return n.receivedState.then(function e(t){return n.receivedState=t,d(o,r,n,a,i)},function(e){return L.Common.asyncRenderErrorLog(e),n.receivedState=null,d(o,r,n,a,i)});else return d(o,r,n,a,i)}function oe(e,t){if(!e)return;try{if(t.setRebuildIgnoreId(e.id),e.compound){var o=e.options,r=o.__vdomOptions&&o.__vdomOptions.controlNode.instance;if(r)W.default(function(){r.destroy()})}else{for(var n=0;n<e.childrenNodes.length;n++)oe(e.childrenNodes[n],t);if(e.control.__$destroyFromDirtyChecking=true,e.control.destroy(),e.control._logicParent&&e.control._logicParent._template&&e.control._options.name)delete e.control._logicParent._children[e.control._options.name]}}finally{t.setRebuildIgnoreId(e.id)}}function re(e){if(e.fullMarkup)e.fullMarkup.changed=true;if(e.parent&&e.parent.fullMarkup&&!e.parent.fullMarkup.changed)re(e.parent)}function ne(e,t){if(e.children)for(var o=0;o<e.children.length;o++)if(L.Vdom.isControlVNodeType(e.children[o]))t.push(e.children[o]);else if(L.Vdom.isTemplateVNodeType(e.children[o])||L.Vdom.isVNodeType(e.children[o]))ne(e.children[o],t)}function d(x,D,e,t,o){var r=e.id,n,a=D[r]||S.DirtyKind.NONE,i=a!==S.DirtyKind.NONE||t,d=!!(a&S.DirtyKind.DIRTY)||t,l=e.markup,s,c=false,v,V,p,u,f,m,h,g,N,y=[],C,T,_,k,b,O,I,M,P,R,A;if(i){if(R=(v=e).context,A=K.ContextResolver.resolveContext(v.controlClass,R,v.control),!v.compound){if(d&&v.control._mounted&&!t){try{v.control._beforeUpdate(v.options,A)}catch(e){Y.catchLifeCircleErrors("_beforeUpdate",e)}try{s=v.control._shouldUpdate(v.options,A)}catch(e){Y.catchLifeCircleErrors("_shouldUpdate",e)}d=d&&s}if(d){if(Y.log("DirtyChecking",["requestRebuild "+r,v.control,v]),(V=v).control.saveFullContext(K.ContextResolver.wrapContext(v.control,v.context||{})),!v.inheritOptions)v.inheritOptions={};if(L.OptionsResolver.resolveInheritOptions(v.controlClass,v,v.options),v.control.saveInheritOptions(v.inheritOptions),v.markup=z.getDecoratedMarkup(v,o),p=z.getMarkupDiff(l,v.markup),Y.log("DirtyChecking (diff)",["","",p]),p.destroy.length||p.vnodeChanged)re(v),c=true;while(p.createTemplates.length>0||p.updateTemplates.length>0){var E={create:[],createTemplates:[],destroy:[],destroyTemplates:[],update:[],updateTemplates:[]};f=p.createTemplates.map(function e(t){Y.log("DirtyChecking (create template)",["","",t]),t.optionsVersions=Q(t.controlProperties),t.contextVersions=Q(t.context),t.children=Z(t,v,x);for(var o=0;o<t.children.length;o++){var r=z.getMarkupDiff(null,t.children[o]);E.create=E.create.concat(r.create),E.createTemplates=E.createTemplates.concat(r.createTemplates),E.update=E.update.concat(r.update),E.updateTemplates=E.updateTemplates.concat(r.updateTemplates)}return t}),p.createTemplates=E.createTemplates,p.updateTemplates=p.updateTemplates.concat(E.updateTemplates),E.createTemplates=[],E.updateTemplates=[],h=p.updateTemplates.map(function e(t){Y.log("DirtyChecking (update template)",["","",t]);var o=t.newNode,r=t.oldNode,n=r.controlProperties,a,i=X(o.controlProperties,n,false,r.optionsVersions),d=r.attributes.attributes,l,s=X(o.attributes.attributes,d,false,{}),c=r.template!==o.template,p,u;if(i||s||c){Y.log("DirtyChecking (update template with changed options)",["","",i]);var f=r.children;o.children=Z(o,v,x);var m=o.children.length>f.length?o.children.length:f.length;for(u=0;u<m;u++){var h=f[u],g=o.children[u];if(g)p=z.getMarkupDiff(h,g,true),E.create=E.create.concat(p.create),E.createTemplates=E.createTemplates.concat(p.createTemplates),E.update=E.update.concat(p.update),E.updateTemplates=E.updateTemplates.concat(p.updateTemplates),E.destroy=E.destroy.concat(p.destroy);else if(h)if(L.Vdom.isControlVNodeType(h))E.destroy.push(h);else if(L.Vdom.isTemplateVNodeType(h)||L.Vdom.isVNodeType(h))ne(h,E.destroy)}}else for(o.children=r.children,u=0;u<o.children.length;u++)p=z.getMarkupDiff(r.children[u],o.children[u],true),E.create=E.create.concat(p.create),E.createTemplates=E.createTemplates.concat(p.createTemplates),E.update=E.update.concat(p.update),E.updateTemplates=E.updateTemplates.concat(p.updateTemplates),E.destroy=E.destroy.concat(p.destroy);return o.optionsVersions=r.optionsVersions,o}),p.updateTemplates=E.updateTemplates,p.create=p.create.concat(E.create),p.destroy=p.destroy.concat(E.destroy),p.update=p.update.concat(E.update),p.createTemplates=p.createTemplates.concat(E.createTemplates)}if(T=p.destroy.map(function e(t){var o=t.controlNodeIdx,r=V.childrenNodes[o];return oe(r,x),r}),M=new Array(p.create.length+p.update.length),P=new Array(p.createTemplates.length+p.updateTemplates.length),I=p.update.length,f=[],h=[],u=p.create.map(function e(t,o){var r=I+o,n=V.serializedChildren,a=n&&n[r],i,d,l;if(Y.log("DirtyChecking (create node)",["","",o,t]),c=true,!t.compound){if(i=t.controlProperties,!(l=ee(t.controlClass,{user:i,internal:t.controlInternalProperties,attributes:t.controlAttributes,events:t.controlEvents},t.key,x,V,a,t)).control._mounted&&!l.control._unmounted){if(d=L.Vdom.getReceivedState(l,t,j))l.receivedState=d;if(l.control.saveOptions)l.control.saveOptions(l.options,l);else if(l.control._options=l.options,l.control._container=l.element,l.control._setInternalOptions(t.controlInternalProperties||{}),U.compat)l.control._container=$(l.element)}if(U.compat&&(!l.control.hasCompatible||l.control.hasCompatible()))H(l)}else l=ee(t.controlClass,{user:J(t.controlProperties,t.controlInternalProperties),attributes:t.controlAttributes,events:t.controlEvents},t.key,x,V,a,t);return t.controlNodeIdx=r,M[t.controlNodeIdx]=true,l}),O=(m=p.update.map(function e(t,o){Y.log("DirtyChecking (update node)",["","",t]);var r=t.newNode,n=t.oldNode.controlNodeIdx,a=V.childrenNodes[n],i=a.control,d=true,l=r.compound?L.Compatible.createCombinedOptions(r.controlProperties,r.controlInternalProperties):r.controlProperties,s=a.options,c=a.optionsVersions,p=r.context||{},u=a.context,f=a.contextVersions,m=X(l,s,r.compound,c),h=X(p,u,false,f),g=h?h:X(p,u,false,f,true),v=a.controlAttributes||a.attributes,N=X(r.controlAttributes,v,r.compound),y;if(r.compound){if(l.__vdomOptions=s.__vdomOptions,m){var C=s.__vdomOptions&&s.__vdomOptions.controlNode.instance;if(C&&!C.__$$blockSetProperties){var T=X(l,C._options||{},r.compound);if(T)C.__$$blockSetProperties=true,m=q.clearNotChangedOptions(m,T),C.setProperties(m),W.default(function(){C.__$$blockSetProperties=false})}}a.options=l}else if(y=X(r.controlInternalProperties,a.internalOptions),m||y||N||h)try{var _;Y.log("DirtyChecking (update node with changed)",["","",m||y||N||h]),x.setRebuildIgnoreId(a.id),L.OptionsResolver.resolveInheritOptions(a.controlClass,a,l),i.saveInheritOptions(a.inheritOptions),_=K.ContextResolver.resolveContext(a.controlClass,p,a.control),i._beforeUpdate&&i._beforeUpdate(l,_),i._options=l,d=(i._shouldUpdate?i._shouldUpdate(l,_):true)||y,i._setInternalOptions(y||{}),a.oldOptions=s,a.oldContext=u,a.attributes=r.controlAttributes,a.events=r.controlEvents,i._saveContextObject(_),i.saveFullContext(K.ContextResolver.wrapContext(i,i._context))}finally{var k=i._shouldUpdate?i._shouldUpdate(l,p)||y:true;if(i._setInternalOptions(y||{}),k)x.setRebuildIgnoreId(null);if(a.options=l,a.context=p,!r.compound)a.internalOptions=r.controlInternalProperties}else if(g)for(var b=a.childrenNodes,O=0;O<b.length;O++)D[b[O].id]|=S.DirtyKind.CHILD_DIRTY;return M[o]=(!!m||!!y||!!h||!!N)&&d,r.controlNodeIdx=o,a.events=r.controlEvents,a})).concat(u),C=N=g=B,m.forEach(function(e,t){if(M[t]){if(N===B)N=[];N.push(e)}else{if(g===B)g=[];g.push(e)}}),N.length||u.length)re(v),c=true;if(-1===O.indexOf(v)){if(C===B)C=[];C.push(v)}}else O=e.childrenNodes,C=T=y=N=g=m=f=u=B}else if(O=e.childrenNodes,C=T=y=N=g=m=f=u=B,v.compound)v.parent.hasCompound=true;if((b=F.mapM(O,function(e,t){if(M&&M[t])re(e);return te(x,D,e,M&&M[t])},S.RebuildResultWriter)).then)return b.then(function(e){if(v.childrenNodes=e.value,c||!v.fullMarkup||v.fullMarkup.changed||d){var t=v.fullMarkup&&v.fullMarkup.changed;if(v.fullMarkup=x.decorateFullMarkup(z.getFullMarkup(v.childrenNodes,v.markup,void 0,c||d?void 0:v.fullMarkup),v),v.fullMarkup.changed=t||v.fullMarkup.changed||c||d,v.fullMarkup.changed)re(v)}return{value:v,memo:G.plus(e.memo,{createdNodes:u,updatedNodes:m,destroyedNodes:T,updatedChangedNodes:N,updatedChangedTemplateNodes:y,updatedUnchangedNodes:g,selfDirtyNodes:C,createdTemplateNodes:f,updatedTemplateNodes:h,destroyedTemplateNodes:_})}},function(e){return L.Common.asyncRenderErrorLog(e),e});else{if(v.childrenNodes=b.value,c||!v.fullMarkup||v.fullMarkup.changed||d){var w=v.fullMarkup&&v.fullMarkup.changed;if(v.fullMarkup=x.decorateFullMarkup(z.getFullMarkup(v.childrenNodes,v.markup,void 0,c||d?void 0:v.fullMarkup),v),v.fullMarkup.changed=w||v.fullMarkup.changed||c||d,v.fullMarkup.changed)re(v)}k={value:v,memo:G.plus(b.memo,{createdNodes:u,updatedNodes:m,destroyedNodes:T,updatedChangedNodes:N,updatedChangedTemplateNodes:y,updatedUnchangedNodes:g,selfDirtyNodes:C,createdTemplateNodes:f,updatedTemplateNodes:h,destroyedTemplateNodes:_})}}}else k={value:e,memo:G.zero};return k}S.RebuildResultWriter=F.createWriterMonad(G),S.createNode=ee,S.destroyReqursive=oe,S.rebuildNode=d});