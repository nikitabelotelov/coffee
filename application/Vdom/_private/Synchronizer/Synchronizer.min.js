define("Vdom/_private/Synchronizer/Synchronizer",["require","exports","Vdom/_private/Synchronizer/resources/Debug","Vdom/_private/Utils/Monad","Vdom/_private/Synchronizer/resources/DirtyChecking","Vdom/_private/Synchronizer/resources/DOMEnvironment","Vdom/_private/Synchronizer/resources/runDelayedRebuild","Core/helpers/Object/isEmpty","Core/helpers/Array/uniq","Core/Serializer","View/Executor/Utils","View/Logger"],function(o,e,t,c,f,v,n,i,h,m,p,u){"use strict";var d;Object.defineProperty(e,"__esModule",{value:true});var l=50,s=2,a=false;if(a)d=t;function g(e,t){var n=e.parent;while(n)t(n),n=n.parent}function b(e,n){return e.map(function(t){var e=n.filter(function(e){return t.id===e.id});if(e.length)return e[0];return t})}function y(e){return e.control&&e.control._parent&&e.control._parent.isDestroyed&&e.control._parent.isDestroyed()}function _(e){if("[object String]"===Object.prototype.toString.call(e))return o(e);return e}function N(e){return e.map(function e(t){return t.id})}var R=[],C=[],D={},q={},r={_rebuild:function(){function e(l){var s=q;if(0===Object.keys(s).length)return{dirties:s,oldRoots:R,newRoots:R,rebuildChanges:null,applyResults:null};q={},R.splice(C.length);var a=R,e=c.mapM(a,function e(t,n){return t.requestDirtyCheck=E.bind(t),f.rebuildNode(C[n],s,t,void 0,true)},f.RebuildResultWriter,this);if(e.then)e.then(function(e){var n=e.value.filter(function(e){if(y(e))return false;return true}),t=e.memo,r=N(n),o={createdNodes:true,updatedChangedNodes:true,selfDirtyNodes:true,createdTemplateNodes:true,updatedChangedTemplateNodes:true},i;for(var u in o)if(t[u].length>0)r=r.concat(N(t[u]));r=h(r);var d=function(e,t){return n[t]&&n[t].fullMarkup?e.applyNewVNode(n[t].fullMarkup,r,n[t]):null};if(l)d=l(d);if(t.createdNodes.forEach(function(e){e.requestDirtyCheck=E.bind(e),D[e.id]=e},this),t.destroyedNodes.forEach(function(e){delete D[e.id]},this),i=C.map(d),R.length>n.length)R=b(R,n);else R=n;return{dirties:s,oldRoots:a,newRoots:n,rebuildChanges:t,applyResults:i}},function(e){return p.Common.asyncRenderErrorLog(e),e});else{var n=e.value.filter(function(e){return-1!==C.indexOf(e.environment)}),t=e.memo,r=N(n).map(function(e){return s[e]&f.DirtyKind.DIRTY?e:void 0}),o={createdNodes:true,updatedChangedNodes:true,selfDirtyNodes:true,createdTemplateNodes:true,updatedChangedTemplateNodes:true},i;for(var u in o)if(t[u].length>0)r=r.concat(N(t[u]));r=h(r);var d=function(e,t){return n[t]&&n[t].fullMarkup?e.applyNewVNode(n[t].fullMarkup,r,n[t]):null};if(l)d=l(d);return t.createdNodes.forEach(function(e){e.requestDirtyCheck=E.bind(e),D[e.id]=e},this),t.destroyedNodes.forEach(function(e){delete D[e.id]},this),i=C.map(d),{dirties:s,oldRoots:a,newRoots:R=n,rebuildChanges:t,applyResults:i}}}var t=a?d.withLogRebuild(e,{silent:true}):e,n;for(n=0;n!==l;n++)if(t.call(this),i(q))break;if(n===l){var r;for(u.setLoggerStatus(true,true),r=1;r<=s;r++)u.log("MAX_REBUILD error",["Logged iteration "+r]),t.call(this);throw u.setLoggerStatus(false,true),new Error("SBIS3.CORE.VDOM.Synchronizer: i === MAX_REBUILD")}},controlStateChangedCallback:function(e){r.requestRebuild(e)},mountControlToDOM:function(u,d,l,s,e){s=s[0]?s[0]:s;var t,a=e||{},c=s.getAttribute("data-component-root-id"),n=c&&window.vdomJsModules[c];if(!e)a["data-component"]=s.getAttribute("data-component");d=_(d);var r=function e(){var n,t,r,o=new m,i;if(t=new v.default(s,this.controlStateChangedCallback,a,c),(n=f.createNode(u,{user:l},void 0,t,null,r)).requestDirtyCheck=E.bind(n),a)n.attributes=a;if(D[n.id]=n,C.push(t),R.push(n),n.control._saveEnvironment(t,n),!u._mounted&&!u._unmounted&&!u._beforeMountCalled)i=p.Vdom.getReceivedState(n,{controlProperties:l,controlClass:d},o);if(n["element"]=s,n.control.saveOptions)n.control.saveOptions(n.options,n);else n.control._options=n.options,n.control._container=$(n.element);if(i)i.then(function e(t){return n.receivedState=t,this.requestRebuild(n.id),t}.bind(this),function e(t){return p.Common.asyncRenderErrorLog(t),t});else this.requestRebuild(n.id)}.bind(this);if(t=C.some(function(e){return e instanceof v.default&&e.getDOMNode()===s}))throw new Error("На этом DOM-элементе уже есть смонтированный корневой компонент");if(n&&n.length>0)o(n,r);else r()},cleanControlDomLink:function(e){if(!e)return;var t=e[0]?e[0]:e;if(t.controlNodes)for(var n=0;n<t.controlNodes.length;n++)if(!t.controlNodes[n].control||t.controlNodes[n].control._destroyed)if(delete D[t.controlNodes[n].id],t.controlNodes.length>0)if(t.controlNodes.length>1||!t.controlNodes[0].parent)t.controlNodes.splice(n,1),n--},unMountControlFromDOM:function e(t,n){for(var r=n[0]?n[0]:n,o,i,u=R.length-1;u>=0;u--){var d=R[u].environment._rootDOMNode;if(r===d&&R[u].environment._canDestroy(t)||!d){var l=R[u].id,s=C.splice(u,1)[0];if(D[l])i=D[l],delete D[l];if(R.splice(u,1),r===d)o=s;else s.destroy()}}if(o){if(!t._destroyed)t.destroy();if(i)f.destroyReqursive(i,o);t._mounted=false,t._unmounted=true,o.destroy()}},queue:null,requestRebuild:function(e){var r=D[e],t=q,o=this;if(r&&!r.environment._rebuildRequestStarted){if(t[e]|=f.DirtyKind.DIRTY,g(r,function(e){t[e.id]|=f.DirtyKind.CHILD_DIRTY}),!r.environment._haveRebuildRequest)r.environment._haveRebuildRequest=true,n.default(function e(){if(r.environment._rebuildRequestStarted=true,this._savedActiveElement!==document.activeElement){var t=document.activeElement;while(t&&t.parentElement){if(t.controlNodes&&t.controlNodes[0]){this._savedControlNode=t.controlNodes[0];break}t=t.parentElement}}var n;if(this._savedActiveElement=document.activeElement,o._rebuild(),r.environment.addTabListener(),r.control.__$focusing)n=r;if(n)r.environment.autofocusChanges.call(this,n)}.bind(this))}else if(r&&r.environment){if(!r.environment.queue)r.environment.queue=[];if(!r.environment.queueIds)r.environment.queueIds={};if(!r.environment.queueIds[e])r.environment.queue.push(e);r.environment.queueIds[e]=1}},setDebugMode:function(e){a=e}};function E(){r.requestRebuild(this.id)}e.default=r});