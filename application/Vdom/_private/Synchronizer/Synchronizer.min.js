define("Vdom/_private/Synchronizer/Synchronizer",["require","exports","Vdom/_private/Synchronizer/resources/Debug","Vdom/_private/Utils/Monad","Vdom/_private/Synchronizer/resources/DirtyChecking","Vdom/_private/Synchronizer/resources/DOMEnvironment","Vdom/_private/Synchronizer/resources/runDelayedRebuild","Core/helpers/Object/isEmpty","Core/helpers/Array/uniq","Core/Serializer","View/Executor/Utils","View/Logger"],function(f,e,t,c,v,m,s,o,h,p,_,i){"use strict";var u;Object.defineProperty(e,"__esModule",{value:true});var d=50,l=2,a=false;if(a)u=t;function b(e,t){var n=e.parent;while(n)t(n),n=n.parent}function N(e,n){return e.map(function(t){var e=n.filter(function(e){return t.id===e.id});if(e.length)return e[0];return t})}function R(e){return e.control&&e.control._parent&&e.control._parent.isDestroyed&&e.control._parent.isDestroyed()}function g(e){if("[object String]"===Object.prototype.toString.call(e))return f(e);return e}function y(e){return e.map(function e(t){return t.id})}var q,C=[],D=[],E={},n={_controlNodes:{},_rebuild:function(){function e(d){var l=E;if(0===Object.keys(l).length)return{dirties:l,oldRoots:C,newRoots:C,rebuildChanges:null,applyResults:null};E={},C.splice(D.length);var a=C,e=c.mapM(a,function e(t,n){return t.requestDirtyCheck=M,v.rebuildNode(D[n],l,t,void 0,true)},v.RebuildResultWriter,this);if(e.then)e.then(function(e){var n=e.value.filter(function(e){if(R(e))return false;return true}),t=e.memo,r=y(n),o={createdNodes:true,updatedChangedNodes:true,selfDirtyNodes:true,createdTemplateNodes:true,updatedChangedTemplateNodes:true},i;for(var u in o)if(t[u].length>0)r=r.concat(y(t[u]));r=h(r);var s=function(e,t){return n[t]&&n[t].environment&&n[t].environment._haveRebuildRequest&&n[t].fullMarkup?e.applyNewVNode(n[t].fullMarkup,r,n[t]):null};if(d)s=d(s);if(t.createdNodes.forEach(function(e){e.requestDirtyCheck=M,this._controlNodes[e.id]=e},this),t.destroyedNodes.forEach(function(e){delete this._controlNodes[e.id]},this),i=D.map(s),C.length>n.length)C=N(C,n);else C=n;return{dirties:l,oldRoots:a,newRoots:n,rebuildChanges:t,applyResults:i}}.bind(this),function(e){return _.Common.asyncRenderErrorLog(e),e});else{var n=e.value.filter(function(e){return-1!==D.indexOf(e.environment)}),t=e.memo,r=y(n).map(function(e){return l[e]&v.DirtyKind.DIRTY?e:void 0}),o={createdNodes:true,updatedChangedNodes:true,selfDirtyNodes:true,createdTemplateNodes:true,updatedChangedTemplateNodes:true},i;for(var u in o)if(t[u].length>0)r=r.concat(y(t[u]));r=h(r);var s=function(e,t){return n[t]&&n[t].environment&&n[t].environment._haveRebuildRequest&&n[t].fullMarkup?e.applyNewVNode(n[t].fullMarkup,r,n[t]):null};if(d)s=d(s);return t.createdNodes.forEach(function(e){e.requestDirtyCheck=M,this._controlNodes[e.id]=e},this),t.destroyedNodes.forEach(function(e){delete this._controlNodes[e.id]},this),i=D.map(s),{dirties:l,oldRoots:a,newRoots:C=n,rebuildChanges:t,applyResults:i}}}var t=a?u.withLogRebuild(e,{silent:true}):e,n;for(n=0;n!==d;n++)if(t.call(this),o(E))break;if(n===d){var r;for(i.setLoggerStatus(true,true),r=1;r<=l;r++)i.log("MAX_REBUILD error",["Logged iteration "+r]),t.call(this);throw i.setLoggerStatus(false,true),new Error("SBIS3.CORE.VDOM.Synchronizer: i === MAX_REBUILD")}},controlStateChangedCallback:function(e){n.requestRebuild(e,false)},mountControlToDOM:function(u,s,d,l,e){l=l[0]?l[0]:l;var t,a=e||{},c=l.getAttribute("data-component-root-id"),n=c&&window.vdomJsModules[c];if(!e)a["data-component"]=l.getAttribute("data-component");s=g(s);var r=function e(){var n,t,r,o=new p,i;if(t=new m.default(l,this.controlStateChangedCallback,a,c),(n=v.createNode(u,{user:d},void 0,t,null,r)).requestDirtyCheck=M,a)n.attributes=a;if(this._controlNodes[n.id]=n,D.push(t),C.push(n),n.control._saveEnvironment(t,n),!u._mounted&&!u._unmounted&&!u._beforeMountCalled)i=_.Vdom.getReceivedState(n,{controlProperties:d,controlClass:s},o);if(n["element"]=l,n.control.saveOptions)n.control.saveOptions(n.options,n);else n.control._options=n.options,n.control._container=$(n.element);if(i)i.then(function e(t){return n.receivedState=t,this.requestRebuild(n.id,true),t}.bind(this),function e(t){return _.Common.asyncRenderErrorLog(t),t});else this.requestRebuild(n.id,true)}.bind(this);if(t=D.some(function(e){return e instanceof m.default&&e.getDOMNode()===l}))throw new Error("На этом DOM-элементе уже есть смонтированный корневой компонент");var o=function(e,t){var n=e._afterMount;e._afterMount=function(){n.apply(this,arguments),setTimeout(function(){t()})}},i=function(){var t=q;q=new Promise(function(e){if(t)t.then(function(){o(u,e),r()});else o(u,e),r()})};if(n&&n.length>0)f(n,i);else i()},cleanControlDomLink:function(e){if(!e)return;var t=e[0]?e[0]:e;if(t.controlNodes)for(var n=0;n<t.controlNodes.length;n++)if(!t.controlNodes[n].control||t.controlNodes[n].control._destroyed)if(delete this._controlNodes[t.controlNodes[n].id],t.controlNodes.length>0)if(t.controlNodes.length>1||!t.controlNodes[0].parent)t.controlNodes.splice(n,1),n--},unMountControlFromDOM:function e(t,n){for(var r=n[0]?n[0]:n,o,i,u=C.length-1;u>=0;u--){var s=C[u].environment._rootDOMNode;if(r===s&&C[u].environment._canDestroy(t)||!s){var d=C[u].id,l=D.splice(u,1)[0];if(this._controlNodes[d])i=this._controlNodes[d],delete this._controlNodes[d];if(C.splice(u,1),r===s)o=l;else l.destroy()}}if(o){if(!t._destroyed)t.destroy();if(i)v.destroyReqursive(i,o);t._mounted=false,t._unmounted=true,o.destroy()}},queue:null,requestRebuild:function(t,e){var r=this._controlNodes[t],n=E,o=false,i=this,u=r&&!r.environment._rebuildRequestStarted;if(!e)u=u&&!C.some(function(e){if(e.environment!==r.environment&&!r.environment._haveRebuildRequest)if(e.environment&&(e.environment._rebuildRequestStarted||e.environment._haveRebuildRequest)){if(!e.environment.queue)e.environment.queue=[];if(!e.environment.queueIds)e.environment.queueIds={};if(o=true,!e.environment.queueIds[t])e.environment.queue.push(t);if(e.environment.queueIds[t]=1,e.environment.activateSubQueue){if(!e.environment.subQueue)e.environment.subQueue=[];if(!e.environment.subQueueIds)e.environment.subQueueIds={};if(!e.environment.subQueueIds[t])e.environment.subQueue.push(t);e.environment.subQueueIds[t]=1}return true}});if(u){if(n[t]|=v.DirtyKind.DIRTY,b(r,function(e){n[e.id]|=v.DirtyKind.CHILD_DIRTY}),!r.environment._haveRebuildRequest)r.environment._haveRebuildRequest=true,s.default(function e(){if(!r.environment._haveRebuildRequest)return;if(r.environment._rebuildRequestStarted=true,this._savedActiveElement!==document.activeElement){var t=document.activeElement;while(t&&t.parentElement){if(t.controlNodes&&t.controlNodes[0]){this._savedControlNode=t.controlNodes[0];break}t=t.parentElement}}var n;if(this._savedActiveElement=document.activeElement,i._rebuild(),r.environment.addTabListener(),r.control.__$focusing)n=r;if(n)r.environment.autofocusChanges.call(this,n)}.bind(this))}else if(r&&r.environment&&!o){if(!r.environment.queue)r.environment.queue=[];if(!r.environment.queueIds)r.environment.queueIds={};if(!r.environment.queueIds[t])r.environment.queue.push(t);r.environment.queueIds[t]=1}},setDebugMode:function(e){a=e}};function M(e){n.requestRebuild(e.id,false)}e.default=n});