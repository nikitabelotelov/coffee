define("View/Builder/Tmpl/traverse",["Core/htmlparser2","View/Builder/Tmpl/modules/utils/common","View/Builder/Tmpl/expressions/statement","View/Builder/Tmpl/modules/control","View/Builder/Tmpl/modules/template","View/Builder/Tmpl/modules/partial","View/Builder/Tmpl/modules/for","View/Builder/Tmpl/expressions/dirtyCheckingPatch","View/Builder/Tmpl/handlers/error","View/Builder/Tmpl/handlers/third-party/dom","View/Builder/Tmpl/checkDomHandler","View/Builder/Tmpl/modules/utils/tag","View/Builder/Tmpl/modules/utils/parse","View/Builder/Tmpl/expressions/event","View/Builder/Tmpl/expressions/bind","View/Builder/Tmpl/modules/data/utils/dataTypesCreator","Core/Deferred","Core/ParallelDeferred","Env/Env"],function e(c,o,l,r,t,i,a,p,u,h,f,d,m,n,s,_,g,v,b){var y=/\{\[([\s\S]+?)]}/g,w=/^&[^\s;]+;$/,T=["ws:string","ws:number","ws:boolean","ws:value","ws:array","ws:object"],k;function C(e){return e.control}function x(e,t){var r=e.from;e=e.element;while(r.array!==t.array)e=r.parent,r=r.parentFrom;return{element:e,from:r}}function I(e,t){for(var r=[],i=t[C(e[0])],a=i.deps,n=1;n<e.length;n++){var s=t[C(e[n])],o=s.deps;if(a>o)a=o,i=s}for(var n=0;n<e.length;n++){var l=C(e[n]),c=x(t[l],i.from);c.name=l,c.attrName=e[n].to,r.push(c)}return r}function V(e,t,r,i,a){var n=r||{},s=i||0,o=t||[];if(e.attribs){if(e.attribs.name&&e.attribs.name.data)n[e.attribs.name&&e.attribs.name.data.value]={element:e,from:a,deps:s};var l;for(var c in e.attribs)if(0===c.indexOf("ws:")&&e.attribs[c].data){if(!l)l={from:a,hoc:e,elements:[]};var u=e.attribs[c].data.value;l.elements.push({control:u,to:c}),delete e.attribs[c]}if(l)o.push(l)}if(e.children)V(e.children,o,n,s++,{array:e.children,parent:e,parentFrom:a});if(e.injectedData)V(e.injectedData,o,n,s++,{array:e.injectedData,parent:e,parentFrom:a});if(e.length)for(var h=0;h<e.length;h++)V(e[h],o,n,s++,{array:e,parent:e[h],parentFrom:a});return{hocs:o,childMap:n}}function F(e){var t=e.trim();if(-1!==t.indexOf("{["))return e;else return e.replace(t,"{["+t+"]}")}return{_modules:{"ws:template":t,"ws:partial":i,"ws:for":a},_attributeModules:{for:a},_regex:{forVariables:/\{\{ ?([\s\S]*?) ?\}\}/g,forLocalization:/\{\[ ?([\s\S]*?) ?\]\}/g},safeReplaceCaseReg:/\r|\n|\t|\/\*[\s\S]*?\*\//g,safeReplaceCasePlace:"",includeStack:{},reservedCanBeOptions:["ws:template"],restrictedTags:["script"],parse:function e(t,r,i,a){if(i){var n=new c(new f(function(e){if(e)throw e.message="filename: "+a+",\n"+e.message,e}.bind(this)),{xmlMode:true,recognizeSelfClosing:true,failOnInnerCurlyBrace:true,generateTagErrors:true});n.write(t),n.done()}var s={ignoreWhitespace:true},o={lowerCaseTags:false,lowerCaseAttributeNames:false,recognizeSelfClosing:true},r=new h(r||this.defaultHandler,s),l=new c(r,o);return l.write(t),l.done(),r.dom},_traverseTagAttributes:function e(t){var r=o.clone(t);return o.eachObject(r,function e(t,r){var i;this._optionName=this._optionName||[],this._optionName.push(r);try{if(n.isEvent(r)||s.isBind(r))i=this._traverseProperty(t);else i=this._traverseText({data:t})}finally{this._optionName.pop()}return i}.bind(this))},_createTextVarNode:function e(t){var r;return{data:[t],type:"text",property:true}},_traverseProperty:function e(t){return this._createTextVarNode(l.processProperty(t))},_replaceAllUncertainStuff:function e(t){return t.replace(this.safeReplaceCaseReg,this.safeReplaceCasePlace)},_searchFor:function(e,i){return o.mapForLoop(e,function e(t){var r;return r=t.split(i).join("")}.bind(this))},_searchForVars:function e(t){return this._searchFor(t,this._regex.forVariables)},_searchForLocalizedVars:function e(t){return this._searchFor(t,this._regex.forLocalization)},_replaceAndCreateStatements:function e(t,r,i){var a=[],n,s="";for(n=0;n<t.length;n++)if(t[n]!==s)a.push(l.processInnerStatements.call(this,t[n],r,i));return a},_getPropertiesInformation:function(e){return this.componentsProperties[e]&&this.componentsProperties[e].properties["ws-config"].options},_addWord:function(e){var r,i;e.replace(y,function(e,t){if(t.indexOf("@@")>-1)i=t.substring(0,t.indexOf("@@")),r=t.substr(t.indexOf("@@")+2);this.words.push({key:r||t,context:i||"",module:this.filename})}.bind(this))},_findLocaleVariables:function(l){var c=this,e=false;function u(e){return!c._regex.forVariables.test(e)&&!w.test(e.trim())&&-1===e.indexOf("%{INCLUDE")}if(this._oldComponentInside=this._oldComponentInside||0,this._scriptInside=this._scriptInside||0,this._styleInside=this._styleInside||0,y.test(l))e=true;else if(0===this._oldComponentInside&&0===this._scriptInside&&0===this._styleInside)if(this._currentPartialName&&this._currentPartialName.length){var t=this._currentPartialName[this._currentPartialName.length-1],r=this._getPropertiesInformation(t),i=function e(t,r){for(var i=t,a=0;a<r.length&&i;a++){var n=r[a],s=i.itemType||i.arrayElementType,o="string"===typeof s;if(i.translatable)break;else if(o)i=c._getPropertiesInformation(s);if(i)i=i[n]}if(u(l))return i&&i.translatable};e=r&&this._optionName&&i(r,this._optionName)}else e=u(l)&&(!this._optionName||!this._optionName[0]||"title"===this._optionName[0]);if(e)l=F(l),this._addWord(l);return l},_createDataObjectWorkWithProperty:function e(t,r,i){if(r||i)return this._replaceAndCreateStatements(t,r,i);return l.createDataText(t[0])},_createDataObject:function e(t,r,i){return t.data=this._createDataObjectWorkWithProperty(t.data,r,i),t},_createLocales:function e(t){return{val:t,loc:true}},_localizeStatements:function e(t,r){for(var i=[],a=[],n=0;n<t.length;n++)if((a=t[n].split(this._regex.forLocalization)).length>1)for(var s=0;s<a.length;s++)if(!o.inArray(r,a[s]))i.push(a[s]);else i.push(this._createLocales(a[s]));else i.push(t[n]);return i},_replaceMatch:function e(t){var r=this._replaceAllUncertainStuff(t.data),i=r.match(this._regex.forVariables),a=r.match(this._regex.forLocalization),n,s;if(i)s=this._searchForVars(i);if(a)n=this._searchForLocalizedVars(a);if(t.data=r.split(this._regex.forVariables),n)t.data=this._localizeStatements.call(this,t.data,n);return this._createDataObject(t,s,n)},_lookForStatements:function e(t){if(t){if(this.createResultDictionary)t.data=this._findLocaleVariables(t.data);return this._replaceMatch(t)}},_traverseTag:function e(t,r){if(r&&~this.reservedCanBeOptions.indexOf(t))return this._handlingTag;else{if(this._modules[t])return this._traverseModule;if(d.isTagRequirable.call(this,t,_.injectedDataTypes,r))return this._traverseOptionModule}return this._handlingTag},_whatMethodShouldYouUse:function e(t,r){return d.findFunctionCase.call(this,t,"_traverse",r)},actionOnMainArray:function e(t,r){if(void 0!==r&&r.length>0)for(var i=0;i<r.length;i++)if(r[i])t.push(r[i]);return r=null,t},_collect:function e(t,r,i){return t.call(this,r,i)},_checkIsPropertyName:function(e){return e&&0===e.indexOf("ws:")&&-1===T.indexOf(e.toLowerCase())},traversingAST:function e(t,r,i){for(var a,n=new v,s=0,o,l="",c=0;c<t.length;c++)if(a=this._whatMethodShouldYouUse(t[c],i)){if("tag"===t[c].type){if(t[c].parent)if(d.isWsControl(t[c].parent)||"ws:partial"===t[c].parent.name||"ws:for"===t[c].parent.name)l="";else l=t[c].parent?t[c].parent.key:"";t[c].key=l+s+++"_",t[c].prefix=r}if("text"===t[c].type)l=t[c].parent?t[c].parent.key:"",t[c].key=l+s+++"_",t[c].prefix=r;t[c]=m.checkForAttributes(t[c]);try{if(i&&this._checkIsPropertyName(t[c].name))this._optionName.push(t[c].name.replace("ws:",""));o=this._collect(a,t[c],i)}finally{if(i&&this._checkIsPropertyName(t[c].name))this._optionName.pop()}if(void 0!==o)n.push(o)}return n.done().getResult().addCallbacks(this.resolveNodesToArray,this.failedTraverse)},resolveNodesToArray:function e(t){return Object.keys(t).map(function(e){return t[e]})},failedTraverse:function e(t){return t},traverse:function e(t,r,i){var d=new g;if(r)if(this.resolver=r,i)if(this.filename=i.filename,this.config=i.config,this.fromBuilderTmpl=i.fromBuilderTmpl,this.createResultDictionary=i.createResultDictionary,this.componentsProperties=i.componentsProperties,this.createResultDictionary)this.words=[];return this.traversingAST(t).addCallbacks(function e(t){if(t){for(var r=this.actionOnMainArray([],t),i=V(r),a=i.hocs,n=i.childMap,s,o=a.length-1;o>=0;o--){var l=a[o],c=I(l.elements,n);if(s=void 0,!l.hoc.injectedData)l.hoc.injectedData=[];for(var u=0;u<c.length;u++){l.hoc.injectedData.push({attribs:void 0,children:[c[u].element],data:void 0,key:0,name:c[u].attrName,selfclosing:false,type:"tag"});var h=c[u].from.array.indexOf(c[u].element);if(0===u)c[u].from.array[h]=l.hoc,h=l.from.array.indexOf(l.hoc),l.from.array.splice(h,1);else c[u].from.array.splice(h,1);if(s)n[c[u].name]=s;else s=n[c[u].name],n[c[u].name].element=l.hoc,n[c[u].name].from=c[u].from}}r.__newVersion=true;for(var f=0;f<r.length;f++)try{p.detectControlTags(r[f],true)}catch(e){return void d.errback(new Error("Something wrong with "+this.filename+" template. "+e.message))}if(this.createResultDictionary)d.callback({astResult:r,words:this.words});else d.callback(r);return r}else d.errback(new Error("Something wrong with "+this.filename+" template."))}.bind(this),function e(t){d.errback(t),u(t,this.filename)}.bind(this)),d},_generatorFunctionForTags:function e(t,r){return t.children=this.actionOnMainArray([],r),t},traverseTagWithChildren:function e(i,t){var a=new g;return this.traversingAST(i.children,i.prefix,t).addCallbacks(function e(t){var r=this._generatorFunctionForTags(i,t);a.callback(r)}.bind(this),function e(t){a.errback(t),u(t,this.filename)}.bind(this)),a},_traverseManageableAttributes:function e(t){var r=[],i;for(i in t)if(this._attributeModules.hasOwnProperty(i)&&t[i])r.push({module:i,value:t[i]});return r},_useManageableAttributes:function e(t,r){var i=this._traverseManageableAttributes(t.attribs);if(!!i.length){var a=i.shift().module;if("for"===a&&"label"===t.name)return this._generateTag(t,r);return d.loadModuleFunction.call(this,m.attributeMatcherByName.call(this,a),t)}return this._generateTag(t,r)},_checkForManageableAttributes:function e(t,r){if(t.attribs)return this._useManageableAttributes(t,r);return this._generateTag(t,r)},_generateTag:function e(t,r){var i=new g,a,n;try{if(a=this._traverseTagAttributes(t.attribs),(n=this._acceptTag(t,a)).children&&n.children.length>0){var s;if(this._oldComponentInside=this._oldComponentInside||0,this._scriptInside=this._scriptInside||0,this._styleInside=this._styleInside||0,"component"===n.name)this._oldComponentInside++;if("script"===n.name)this._scriptInside++;if("style"===n.name)this._styleInside++;try{s=this.traverseTagWithChildren(n,r)}finally{if("component"===n.name)this._oldComponentInside--;if("script"===n.name)this._scriptInside--;if("style"===n.name)this._styleInside--}return s}i.callback(this._generatorFunctionForTags(n))}catch(e){b.IoC.resolve("ILogger").error("traverse",e.stack),i.errback(u(e,this.filename))}return i},_handlingTag:function e(t,r){return this._checkForManageableAttributes(t,r)},_traverseOptionModule:function e(t){return d.loadModuleFunction.call(this,r.parse,this._acceptTag(t,t.attribs))},_traverseModule:function e(t){var r=this._acceptTag(t,t.attribs),i=m.parserMatcher.call(this,r);return d.loadModuleFunction.call(this,i,r)},_traverseText:function e(t){var r=new g,i,a=this.createTextNode(t);if(t.hasOwnProperty("type")){t.data=this._replaceAllUncertainStuff(a.data);try{i=this._lookForStatements(a),r.callback(i)}catch(e){r.errback(u(e,this.filename))}return r}return this._lookForStatements(a)},_traverseDirective:function e(t){var r=new g;return r.callback(t),r},_traverseComment:function e(t){var r=new g;if(t.data)r.callback(this._lookForStatements(t));return r},_createTag:function e(t){return{name:t.name,data:t.data,key:t.key,attribs:t.attribs,children:t.children,selfclosing:t.selfclosing,type:"tag"}},_acceptTag:function e(t,r){return this._createTag({name:t.name,data:t.data,key:t.key,attribs:r,children:t.children,selfclosing:!!t.selfclosing})},defaultHandler:function e(t,r){if(t)u(t,this.filename)},createTextNode:function e(t){return{data:t.data,type:"text",key:t.key}},getComponents:function e(t){var i=[];function a(e){var t=d.splitOptional(e),r=d.splitJs(e),i=d.splitHtml(e),a=d.splitTmpl(e),n=d.splitWml(e),s=d.slashedControl(e);if(t)return"optional!"+t;else if(r)return"js!"+r;else if(i)return"html!"+i;else if(a)return"tmpl!"+a;else if(n)return"wml!"+n;else if(s)return e}function n(e,t,r){var i=d.isTagRequirable.call(this,e,t,true,true);if(i)return i;if("ws:partial"===e&&r.attribs&&l.isStaticString(r.attribs.template))return a(r.attribs.template)}function s(e){for(var t,r=0;r<e.length;r++){if(t=n.call(this,e[r].name,_.injectedDataTypes,e[r])){if(o.isLibraryModuleString(t))t=o.splitModule(t).library;if(!~i.indexOf(t))i.push(t)}if(e[r].children&&e[r].children.length>0)s.call(this,e[r].children)}}return s.call(this,t),i},getDependencies:function e(t,r){if(!r)return["View/Executor/TClosure"].concat(this.getComponents.call(this,t))}}});