define("View/Builder/Tmpl",["View/Builder/Tmpl/traverse","Env/Env","View/Builder/Tmpl/modules/utils/common","text!View/Builder/Tmpl/modules/templates/file.jstpl","View/Builder/Tmpl/function"],function(o,I,e,A,w){"use strict";A=A.replace(/\r|\n/g,"");var O=[["WS.Core/lib/","Lib/"],["WS.Core/core/","Core/"],["ws/lib/","Lib/"],["ws/core/","Core/"]],S={template:function e(r,t,i){var a,l;try{a=o.parse(r,void 0,true,i.filename)}catch(e){l=e}return{dependencies:o.getDependencies(a,l),handle:function e(r,n){if(l)n(l);else o.traverse(a,t,i).addCallbacks(r,n)}}},func:function e(r,n){var t;return w.includedFunctions={},t=w.getFunction(r,null,n,null)},clearFunctionFromDeprecated:function(e){var r=e.indexOf("/*#DELETE IT START#*/");while(r>-1){var n=e.indexOf("/*#DELETE IT END#*/");r=(e=e.substr(0,r)+e.substr(n+19)).indexOf("/*#DELETE IT START#*/")}return e},getFile:function(T,E,F,C,L){if(!L)L="tmpl";C=C||function(e){I.IoC.resolve("ILogger").error("Template","Ошибка при парсинге шаблона: "+e.message,e)};var e="",h=this,D=null,r=function e(r){return L+"!"+r};S.template(T,r,E).handle(function(e){try{var r=A;if(w.privateFn=[],w.includedFn={},w.privatePrefix="_private",!(D=S.func(e,E)))I.IoC.resolve("ILogger").error("Template","Шаблон не может быть построен. Не загружены зависимости. Шаблон: "+T);var n=D.toString();if(r=(r=r.replace(/\/\*#FUNCTION#\*\//g,n)).replace("__EXTMODULE__",L),n="",D.privateFn)for(var t=0,i=0;i<D.privateFn.length;i++){var a=D.privateFn[i].toString(),l="_private"+i.toString();n+=a=a.replace("function anonymous","function "+l)}w.privateFn=null,r=r.replace(/\/\*#INCLUDEDFUNC#\*\//g,n);var o="",c="";if(D.includedFn)for(var u in D.includedFn)if(D.includedFn.hasOwnProperty(u))o+="function "+u+"(data, attr, context, isVdom)"+D.includedFn[u],c+='depsLocal["'+u+'"] = '+u+";";r=r.replace(/\/\*#TEMPLATEFUNC#\*\//g,o),w.includedFn=null;for(var p=E.fileName.replace(/\.tmpl$/g,"").replace(/\.wml/g,""),f=0;f<O.length;f++){var d=O[f];if(p.startsWith(d[0])){p=p.replace(d[0],d[1]);break}}r=r.replace(/\/\*#MODULENAME#\*\//g,p);var s=h.getComponents(T),g="";if(s)for(var m=0;m<s.length;m++)g+='depsLocal["'+s[m]+'"] = deps['+(m+1)+"];";r=r.replace(/\/\*#DEPSTOLOCALVAR#\*\//g,g+c),s=["View/Executor/TClosure"].concat(s);var v=JSON.stringify(s);r=r.replace(/\/\*#DEPS#\*\//g,v),r=S.clearFunctionFromDeprecated(r),F(r)}catch(e){C(e)}},C)},getComponents:function e(r,n){var t=o.parse(r);if(n)o.config=n;return o.getComponents(t)},addArgument:e.addArgument,addArgumentsConfig:function e(){var r=Array.prototype.slice.call(arguments);return S.addArgument(r[0],r.slice(1))},getFunction:function(n,t,i){var a=null,e=function e(r){return"tmpl!"+r},l=function(e){I.IoC.resolve("ILogger").error("Template","Ошибка при парсинге шаблона: "+e.message,e)};if(S.template(n,e,{config:t}).handle(function(e){try{var r=S.func(e,{config:t,filename:"userTemplate"});r.stable=true,(a=function(){return r.apply(this,S.addArgument(i,arguments))}).toJSON=function(){return n}}catch(e){l(e)}},l),!a)I.IoC.resolve("ILogger").error("Template","Шаблон не может быть построен. Не загружены зависимости. Шаблон: "+n);return a}};return S});