define("View/Executor/_Markup/Text/Generator",["require","exports","Core/helpers/Number/randomId","Env/Env","Core/Serializer","Core/library","View/Logger","View/Request","View/Executor/Expressions","View/Executor/Utils"],function(p,e,i,v,o,a,C,m,d,y){Object.defineProperty(e,"__esModule",{value:true}),e["View/Executor/_Markup/Generator"]=true;var t,g=function(){"use strict";var e={},t=function(e,t,b,d,w,x){Object.defineProperty(t,"__esModule",{value:true});var E={},o=/(\[def-[\w\d]+\])/g,i=["ws-creates-context","ws-delegates-tabfocus","ws-tab-cycling","ws-no-focus","attr:ws-creates-context","attr:ws-delegates-tabfocus","attr:ws-tab-cycling","attr:ws-no-focus"],r={createWsControl:function(e,t,r,n,o){throw new Error("Generator.createWsControl is not implemented")},createTemplate:function(e,t,r,n,o,i){throw new Error("Generator.createTemplate is not implemented")},createController:function(e,t,r,n,o){throw new Error("Generator.createController is not implemented")},resolver:function(e,t,r,n,o,i){throw new Error("Generator.resolver is not implemented")},joinElements:function(e,t){throw new Error("Generator.joinElements is not implemented")},createTag:function(e,t,r,n,o){throw new Error("Generator.createTag is not implemented")},createText:function(e){throw new Error("Generator.createText is not implemented")},createEmptyText:function(){throw new Error("Generator.createEmptyText is not implemented")},createDirective:function(e){throw new Error("Generator.createDirective is not implemented")},escape:function(e){throw new Error("Generator.escape is not implemented")},getScope:function(e){return e},chain:function(t,n){return Promise.all(n.def).then(function e(r){return t.replace(o,function(e){var t=n.id.indexOf(e);if(n.id[t])return r[t].result?r[t].result:r[t];return""})},function(e){w.Common.asyncRenderErrorLog(e)})},createControl:function(e,t,r,n,o,i,a,l,s,u,c){var f;if((r=w.ConfigResolver.resolveControlCfg(r,o,n)).internal.logicParent=r.internal.logicParent||o.viewController,r.internal.parent=r.internal.parent||o.viewController,n.internal=r.internal,r=r.user,null===t)return this.createText("",n.key);else{if("wsControl"===e)if(d.getLoggerStatus()||w.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createWsControl,this,[t,r,n,i,a]);else f=this.createWsControl(t,r,n,i,a);if("template"===e)if(d.getLoggerStatus()||w.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createTemplate,this,[t,r,n,i,a,s]);else f=this.createTemplate(t,r,n,i,a,s);if("controller"===e)if(d.getLoggerStatus()||w.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createController,this,[t,r,n,i,a]);else f=this.createController(t,r,n,i,a);if("resolver"===e){var p,m;if(n.events)for(m in n.events)if(n.events.hasOwnProperty(m))for(p=0;p<n.events[m].length;p++)if(!n.events[m][p].fn.isControlEvent)n.events[m][p].toPartial=true;if(d.getLoggerStatus()||w.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.resolver,this,[t,r,n,i,a,l,s,c]);else f=this.resolver(t,r,n,i,a,l,s,c)}if(void 0!==f)return f;else{if(t&&e)return this.createText("",n.key);if("undefined"===typeof t)return b.IoC.resolve("ILogger").error("Undefined component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне в опцию template был передан undefined! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается undefined"),this.createText("",n.key);throw new Error("MarkupGenerator: createControl type not resolved")}}},prepareDataForCreate:function(e,t,r,n,o){var i,a,l,s,u,c;if("function"===typeof e)l=(i=e).prototype?e.prototype._moduleName:"";if("string"===typeof e)if(w.Common.isLibraryModuleString(e))e=w.Common.splitModule(e);else{var f=w.Common.splitWs(e);if(f)e=f;if(e.indexOf("/")>-1)if(s=true,e.indexOf("optional!")>-1)u=true;if(e=e.replace("optional!",""),o&&o[e])i=o[e];if(!i)i=n&&(n[e]||n["optional!"+e]);if(!i)if(!s||u||b.constants.compat){if(w.RequireHelper.defined(e))i=w.RequireHelper.require(e)}else try{if(!(i=E[e]))i=w.RequireHelper.require(e),E[e]=i}catch(e){b.IoC.resolve("ILogger").warn("Create component",e,e.stack)}if(l=e,i&&i.default&&i.default.isWasaby)i=i.default}if("object"===typeof e&&e&&e.library&&e.module){var p=e.library+":"+e.module.join(".");if(n&&n[e.library])i=w.Common.extractLibraryModule(n[e.library],e.module);else if(w.RequireHelper.defined(e.library))i=w.Common.extractLibraryModule(w.RequireHelper.require(e.library),e.module);else{var m;if(E[e.library])i=w.Common.extractLibraryModule(E[e.library],e.module);else p=void 0}if(i&&i.prototype&&!i.prototype.hasOwnProperty("_moduleName"))i.prototype._moduleName=p;l=p}var d=i&&i.prototype&&w.Common.isCompound(i),v=x.Scope.calculateScope(t,w.Common.plainMerge)||{};if(d)for(var C in r.events)v[C]=r.events[C];if(!r.attributes)r.attributes={};if(x.Focus.prepareAttrsForFocus(r.attributes,v),a=r.internal&&r.internal.logicParent?r.internal.logicParent:null,c=r.internal&&r.internal.parent?r.internal.parent:null,w.OptionsResolver.resolveInheritOptions(i,r,v),b.constants.compat){if(v&&void 0===v.enabled){var y=r.internal;if(y&&y.parent&&d)if(void 0!==y.parentEnabled&&false!==v.allowChangeEnable)v.enabled=y.parentEnabled;else v.enabled=true;else if(d&&false===y.parentEnabled)v.__enabledOnlyToTpl=y.parentEnabled}if(d){var g=r.attributes;for(var h in g)if(g.hasOwnProperty(h)&&x.Event.isEvent(h))v[h]=g[h]}}return{logicParent:a,parent:c,attrs:r.attributes,controlProperties:v,dataComponent:l,internal:r.internal,controlClass:i,compound:!(i&&i.isWasaby)}},invisibleNodeCompat:function e(t){return t&&t.indexOf&&0===t.indexOf("<invisible-node")?t.replace(/invisible-node/g,"div"):t},cutFocusAttributes:function(t,r,n){i.forEach(function(e){if(t.hasOwnProperty(e))if(r&&r(e,t[e]),delete t[e],n)n.removeAttribute(e)})},joinAttrs:x.Attr.joinAttrs};t.default=r}(p,e,v,C,y,d);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["View/Executor/_Markup/Text/FunctionHeaderTemplate"]=true;var r=function(){"use strict";var e={},t=(r=p,n=e,Object.defineProperty(n,"__esModule",{value:true}),void(n.default="/*#DELETE IT START#*/\nfunction debug() { debugger; }\nvar thelpers = typeof tclosure === 'undefined' || !tclosure ? arguments[arguments.length - 1] : tclosure;\nif (typeof thelpers === \"undefined\" || !thelpers._isTClosure) {\neval(\"var thelpers = null;\");\nthelpers = (function(){return this || (0, eval)('this')})().requirejs(\"View/Executor/TClosure\");\n}\nvar depsLocal = typeof _deps === 'undefined' ? undefined : _deps;\nif (typeof includedTemplates === \"undefined\") {\neval(\"var includedTemplates = undefined;\");\nincludedTemplates = (this && this.includedTemplates) ? this.includedTemplates : {};\n}\n/*#DELETE IT END#*/\nvar templateCount = 0;\nvar key = attr && attr.key || '_';\nvar defCollection = {id: [], def: undefined};\nvar viewController = thelpers.configResolver.calcParent(this, typeof currentPropertyName === 'undefined' ? undefined : currentPropertyName, data);")),r,n;if(t instanceof Function)return t;else for(var o in t)if(t.hasOwnProperty(o))e[o]=t[o];return e}(),h=Object.create(g.default),s=["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr","path","circle","ellipse","line","rect","use","stop","polyline","polygon"];function b(e){return e&&e.then}function l(e,t){var r=t||{};if(e&&e.name)r.name=e.name;else if(t&&t.name)e.name=t.name;return r}function n(e){var t,r=[],n=e._linksStorage,o;for(var i in n)if(n.hasOwnProperty(i))if((t=n[i]).module)o=a.parse(t.module),r.push(o.name);return r}function u(n,o,i){var e=n.user,t,a;e["class"]=i["class"];var r=d.Subscriber.getEventsListFromOptions(e);for(var l in r)if(r.hasOwnProperty(l))delete e[l];var s=e.doNotSetParent;e.doNotSetParent=true;var u=e._logicParent&&e._logicParent._moduleName||"",c=y.OptionsResolver.getDefaultOptions(o);y.OptionsResolver.resolveOptions(o,c,e,u);var f=new o(e),p=e;if(p.doNotSetParent=s,"undefined"!==typeof window)d.Subscriber.subscribeEvents(f,n.internal.logicParent,r);if(f._template){if(f.saveOptions)f.saveOptions(p);else f._options=p;try{t=f._beforeMountLimited&&f._beforeMountLimited(p,n.templateContext||{})}catch(e){C.catchLifeCircleErrors("_beforeMount",e)}if(f.saveInheritOptions(n.inheritOptions||{}),t&&b(t))return new Promise(function(r){t.then(function(t){f._saveContextObject(d.ContextResolver.resolveContext(o,n.templateContext||{})),f.saveFullContext(d.ContextResolver.wrapContext(f,n.templateContext||{}));var e=m.getCurrent();if(e)e.stateReceiver.register(n.key,{getState:function(){return t},setState:function(){}});if((a=f._template?f.render(null,i):"").then)a.then(function(e){r({result:e,receivedState:t})},function(e){y.Common.asyncRenderErrorLog(e),r({result:E(f),receivedState:void 0})});else r({result:a,receivedState:t})},function(e){y.Common.asyncRenderErrorLog(e),r({result:E(f),receivedState:void 0})})});else f._saveContextObject(d.ContextResolver.resolveContext(o,n.templateContext||{})),f.saveFullContext(d.ContextResolver.wrapContext(f,n.templateContext||{}))}return a=f._template?g.default.invisibleNodeCompat(f.render(void 0,i)):""}function w(e,t,r,n,o){var i=t.user,a;return o=l(i,o),a=u({user:i,internal:t.internal,templateContext:t.templateContext,inheritOptions:t.inheritOptions,key:t.key},e,o)}function x(e,t,r,n){var o=n&&n.resolvers?y.Common.findResolverInConfig(e,n.resolvers):void 0;if(o)return o(e);else return y.Common.depsTemplateResolver(e,t,r,n)}function E(e){var t={},r;if(e&&e._options)r=e._options,t=d.Decorate.createRootDecoratorObject(r["__$config"],true,r["data-component"],{});return h.createTag("div",{attributes:t},[])}function c(e,t){function n(e){if(void 0===e||null===e)return"";else return e}var r;return function(e){var t="";for(var r in e)if(e.hasOwnProperty(r))t+=""!==n(e[r])?" "+r+'="'+e[r]+'"':"";return t}(h.joinAttrs(e,t))}if(h.createController=function(){return""},h.createEmptyText=function(){return""},h.createWsControl=function e(t,r,n,o,i){var a=this.prepareDataForCreate(t,r,n,i),l=a.dataComponent;C.log("createWsControl",[l,a.controlProperties]),C.log("Context for control",["",n.context]),C.log("Inherit options for control",["",n.inheritOptions]);var s=null,u=a.controlClass,c=u&&u.prototype&&u.prototype._template;if(!u&&!c){var f=new Error("Попытка создания контрола, у которого отсутствует конструктор и шаблон");return v.IoC.resolve("ILogger").error(f.message,f.stack),""}if(u&&!c)return h.createController(u,r,n,o,i);var p=a.controlProperties;if(!p["data-component"])p["data-component"]=l;for(var m=0;p.hasOwnProperty("__dirtyCheckingVars_"+m);m++)delete p["__dirtyCheckingVars_"+m];return w(u,{user:p,internal:a.internal,templateContext:n.context,inheritOptions:n.inheritOptions,key:n.key},o,s,n)},h.createTemplate=function e(t,r,n,o,i,a){var l,s=y.Common.hasResolver(t,a&&a.resolvers);if(y.Common.isString(t)){if(s)l=a.resolvers[s](t);else if((l=i&&i[t]||p(t))&&y.Common.isOptionalString(t)&&!y.Common.isTemplateString(t))return this.createWsControl(t.split("js!")[1],r,n,o,i)}else l=t;var u=this.prepareDataForCreate(t,r,n,i),c=u.parent,f=u.controlProperties;return C.log("createTemplate",[y.Common.isString(t)?t:"InlineFunction",u.controlProperties,l]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]),null===l?"":c?l.call(c,f,n,o):l(f,n,o)},h.resolver=function e(t,r,n,o,i,a,l,s){var u="string"===typeof t,c=y.Common.isLibraryModule(t),f=this.prepareDataForCreate(t,r,n,i,a),p=f.controlProperties,m;if(u)m=x(t,a,i,l);else if(c)m=f.controlClass;else m=t;if(y.Common.isControlClass(m)){if(u&&-1!==t.indexOf("js!")&&!y.RequireHelper.defined(m.prototype._moduleName))m.prototype._moduleName=t.split("js!")[1];if(m.prototype._template)return h.createWsControl(m,r,n,o,i)}else{var d;if(C.log("Resolver",[u?t:"InlineFunction",f.controlProperties,m]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]),"function"===typeof m)d=r&&f.parent?m.call(f.parent,p,n,o,false):m(p,n,o,false);else if(m&&"function"===typeof m.func)d=r&&f.parent?m.func.call(f.parent,p,n,o,false):m.func(p,n,o,false);else if(y.Common.isArray(m))d=r&&f.parent?m.map(function(e){if("function"===typeof e)return e.call(f.parent,p,n,o,false);else if("function"===typeof e.func)return e.func.call(f.parent,p,n,o,false);return e}):m.map(function(e){if("function"===typeof e)return e(p,n,o,false);else if("function"===typeof e.func)return e.func(p,n,o,false);return e}),d=h.joinElements(d,void 0,s);else if("undefined"===typeof t)return v.IoC.resolve("ILogger").error(typeof t+" component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне был передан "+typeof t+"! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается "+typeof t),"";else d=t;return d}},h.joinElements=function e(t,r,n){if(Array.isArray(t)){var o="";return t.forEach(function e(t){var r;if(Array.isArray(t))t=h.joinElements(t,void 0,n);if(t&&b(t)){if(r=i("def-"),!n.def)n.def=[];n.def.push(t),t="["+r+"]",n.id.push(t)}o+=t||""}),o}else throw new Error("joinElements: elements is not array")},h.createTag=function e(t,r,n,o,i){if(!o)o={};if(!r)r={};var a=d.Attr.processMergeAttributes(o.attributes,r.attributes,true);d.Focus.prepareTabindex(a),h.cutFocusAttributes(a);var l=a?c(a,{}):"";if(~s.indexOf(t))return"<"+t+l+" />";return"<"+t+l+">"+h.joinElements(n,void 0,i)+"</"+t+">"},h.createText=function e(t){return t},h.createDirective=function e(t){return"<"+t+">"},h.createComment=function e(t){return"\x3c!--"+t+"--\x3e"},h.makeInlineConfigs=function e(t,r,n){var o=h.serializeReceivedState(n);return t+'<script type="text/javascript" data-vdomignore="true">window.inline'+r.replace("cfg-","")+"='"+o+"';<\/script>"},h.serializeReceivedState=function e(t){var r=new o,n=JSON.stringify(t,r.serialize);return y.Common.componentOptsReArray.forEach(function(e){n=n.replace(e.toFind,e.toReplace)}),n},h.calculateScope=function e(t){return d.Scope.calculateScope(t,d.Scope.controlPropMerge)},h.buildMarkupForClass=w,h.escape=y.Common.escape,v.constants.isBrowserPlatform&&v.constants.compat)p(["View/Executor/GeneratorCompatible"]);return e.default=h,e});