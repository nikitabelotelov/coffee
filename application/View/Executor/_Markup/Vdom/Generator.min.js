define("View/Executor/_Markup/Vdom/Generator",["require","exports","Core/helpers/Array/flatten","Env/Env","View/Logger","View/Executor/Expressions","View/Executor/Utils"],function(c,e,p,h,v,m,y){Object.defineProperty(e,"__esModule",{value:true}),e["View/Executor/_Markup/Generator"]=true;var t,r=function(){"use strict";var e={},t=function(e,t,b,d,w,x){Object.defineProperty(t,"__esModule",{value:true});var E={},n=/(\[def-[\w\d]+\])/g,i=["ws-creates-context","ws-delegates-tabfocus","ws-tab-cycling","ws-no-focus","attr:ws-creates-context","attr:ws-delegates-tabfocus","attr:ws-tab-cycling","attr:ws-no-focus"],r={createWsControl:function(e,t,r,o,n){throw new Error("Generator.createWsControl is not implemented")},createTemplate:function(e,t,r,o,n,i){throw new Error("Generator.createTemplate is not implemented")},createController:function(e,t,r,o,n){throw new Error("Generator.createController is not implemented")},resolver:function(e,t,r,o,n,i){throw new Error("Generator.resolver is not implemented")},joinElements:function(e,t){throw new Error("Generator.joinElements is not implemented")},createTag:function(e,t,r,o,n){throw new Error("Generator.createTag is not implemented")},createText:function(e){throw new Error("Generator.createText is not implemented")},createEmptyText:function(){throw new Error("Generator.createEmptyText is not implemented")},createDirective:function(e){throw new Error("Generator.createDirective is not implemented")},escape:function(e){throw new Error("Generator.escape is not implemented")},getScope:function(e){return e},chain:function(t,o){return Promise.all(o.def).then(function e(r){return t.replace(n,function(e){var t=o.id.indexOf(e);if(o.id[t])return r[t].result?r[t].result:r[t];return""})},function(e){w.Common.asyncRenderErrorLog(e)})},createControl:function(e,t,r,o,n,i,a,l,s,c,u){var f;if((r=w.ConfigResolver.resolveControlCfg(r,n,o)).internal.logicParent=r.internal.logicParent||n.viewController,r.internal.parent=r.internal.parent||n.viewController,o.internal=r.internal,r=r.user,null===t)return this.createText("",o.key);else{if("wsControl"===e)if(d.getLoggerStatus()||w.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createWsControl,this,[t,r,o,i,a]);else f=this.createWsControl(t,r,o,i,a);if("template"===e)if(d.getLoggerStatus()||w.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createTemplate,this,[t,r,o,i,a,s]);else f=this.createTemplate(t,r,o,i,a,s);if("controller"===e)if(d.getLoggerStatus()||w.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createController,this,[t,r,o,i,a]);else f=this.createController(t,r,o,i,a);if("resolver"===e){var p,m;if(o.events)for(m in o.events)if(o.events.hasOwnProperty(m))for(p=0;p<o.events[m].length;p++)if(!o.events[m][p].fn.isControlEvent)o.events[m][p].toPartial=true;if(d.getLoggerStatus()||w.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.resolver,this,[t,r,o,i,a,l,s,u]);else f=this.resolver(t,r,o,i,a,l,s,u)}if(void 0!==f)return f;else{if(t&&e)return this.createText("",o.key);if("undefined"===typeof t)return b.IoC.resolve("ILogger").error("Undefined component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне в опцию template был передан undefined! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается undefined"),this.createText("",o.key);throw new Error("MarkupGenerator: createControl type not resolved")}}},prepareDataForCreate:function(e,t,r,o,n){var i,a,l,s,c,u;if("function"===typeof e)l=(i=e).prototype?e.prototype._moduleName:"";if("string"===typeof e)if(w.Common.isLibraryModuleString(e))e=w.Common.splitModule(e);else{var f=w.Common.splitWs(e);if(f)e=f;if(e.indexOf("/")>-1)if(s=true,e.indexOf("optional!")>-1)c=true;if(e=e.replace("optional!",""),n&&n[e])i=n[e];if(!i)i=o&&(o[e]||o["optional!"+e]);if(!i)if(!s||c||b.constants.compat){if(w.RequireHelper.defined(e))i=w.RequireHelper.require(e)}else try{if(!(i=E[e]))i=w.RequireHelper.require(e),E[e]=i}catch(e){b.IoC.resolve("ILogger").warn("Create component",e,e.stack)}if(l=e,i&&i.default&&i.default.isWasaby)i=i.default}if("object"===typeof e&&e&&e.library&&e.module){var p=e.library+":"+e.module.join(".");if(o&&o[e.library])i=w.Common.extractLibraryModule(o[e.library],e.module);else if(w.RequireHelper.defined(e.library))i=w.Common.extractLibraryModule(w.RequireHelper.require(e.library),e.module);else{var m;if(E[e.library])i=w.Common.extractLibraryModule(E[e.library],e.module);else p=void 0}if(i&&i.prototype&&!i.prototype.hasOwnProperty("_moduleName"))i.prototype._moduleName=p;l=p}var d=i&&i.prototype&&w.Common.isCompound(i),h=x.Scope.calculateScope(t,w.Common.plainMerge)||{};if(d)for(var v in r.events)h[v]=r.events[v];if(!r.attributes)r.attributes={};if(x.Focus.prepareAttrsForFocus(r.attributes,h),a=r.internal&&r.internal.logicParent?r.internal.logicParent:null,u=r.internal&&r.internal.parent?r.internal.parent:null,w.OptionsResolver.resolveInheritOptions(i,r,h),b.constants.compat){if(h&&void 0===h.enabled){var y=r.internal;if(y&&y.parent&&d)if(void 0!==y.parentEnabled&&false!==h.allowChangeEnable)h.enabled=y.parentEnabled;else h.enabled=true;else if(d&&false===y.parentEnabled)h.__enabledOnlyToTpl=y.parentEnabled}if(d){var C=r.attributes;for(var g in C)if(C.hasOwnProperty(g)&&x.Event.isEvent(g))h[g]=C[g]}}return{logicParent:a,parent:u,attrs:r.attributes,controlProperties:h,dataComponent:l,internal:r.internal,controlClass:i,compound:!(i&&i.isWasaby)}},invisibleNodeCompat:function e(t){return t&&t.indexOf&&0===t.indexOf("<invisible-node")?t.replace(/invisible-node/g,"div"):t},cutFocusAttributes:function(t,r,o){i.forEach(function(e){if(t.hasOwnProperty(e))if(r&&r(e,t[e]),delete t[e],o)o.removeAttribute(e)})},joinAttrs:x.Attr.joinAttrs};t.default=r}(c,e,h,v,y,m);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}(),C=Object.create(r.default),o=[],n="";return C.createEmptyText=function(e){return C.createText("",e)},C.createWsControl=function e(t,r,o,n,i){var a=this.prepareDataForCreate(t,r,o,i),l=a.controlClass;if(v.log("createWsControl",[a.dataComponent,a.controlProperties]),v.log("Context for control",["",o.context]),v.log("Inherit options for control",["",o.inheritOptions]),!l)return C.createText("",a.controlProperties&&a.controlProperties.__key||o.key);var s=a.compound,c=a.controlProperties;return{compound:s,invisible:false,controlClass:l,controlProperties:c,controlInternalProperties:a.internal,controlAttributes:a.attrs,controlEvents:o.events,key:c.__key||o.key,controlNodeIdx:-1,context:o.context,inheritOptions:o.inheritOptions}},C.createTemplate=function e(t,r,o,n,i){var a;if(y.Common.isString(t)){if((a=i&&i[t]||c(t))&&y.Common.isOptionalString(t)&&!y.Common.isTemplateString(t))return this.createWsControl(t.split("js!")[1],r,o,n,i)}else a=t;var l=this.prepareDataForCreate(t,r,o,i);if(v.log("createTemplate",[y.Common.isString(t)?t:"InlineFunction",l.controlProperties,a]),v.log("Context for template",["",o.context]),v.log("Inherit options for template",["",o.inheritOptions]),null==a)return"";if(l.controlProperties.__noDirtyChecking)return this.resolver(a,l.controlProperties,o,n,i);var s={compound:false,template:a,controlProperties:l.controlProperties,parentControl:l.parent,attributes:o,context:o.key,type:"TemplateNode"};return Object.defineProperty(s,"count",{configurable:true,get:function(){var e=0;if(this.children){for(var t=0;t<this.children.length;t++){var r;e+=this.children[t].count||0}return this.children.length+e}else return 0}}),s},C.createController=function e(t,r,o,n,i){return C.createWsControl.apply(this,arguments)},C.resolver=function e(t,r,o,n,i,a,l){var s=this.prepareDataForCreate(t,r,o,i,a),c=s.controlProperties,u="string"===typeof t,f=y.Common.isLibraryModule(t),p;if(u)p=y.Common.depsTemplateResolver(t,a,i,l);else p=s.controlClass;if(!p)if("function"===typeof t)p=t;else if(t&&"function"===typeof t.func)p=t;else if(y.Common.isArray(t))p=t;if(y.Common.isControlClass(p))return C.createWsControl(p,c,o,n,i);else{v.log("Resolver",[u?t:"InlineFunction",s.controlProperties,p]),v.log("Context for template",["",o.context]),v.log("Inherit options for template",["",o.inheritOptions]);var m=s.parent;if("function"===typeof p)return m?p.call(m,c,o,n,true,void 0):p(c,o,n,true);else if(p&&"function"===typeof p.func)return m?p.func.call(m,c,o,n,true,void 0):p.func(c,o,n,true);else if(y.Common.isArray(p)){var d;return m?p.reduce(function(e,t){if("function"===typeof t)return e.concat(t.call(m,c,o,n,true));else if("function"===typeof t.func)return e.concat(t.func.call(m,c,o,n,true));return e.concat(t)},[]):p.reduce(function(e,t){if("function"===typeof t)return e.concat(t(c,o,n,true));else if("function"===typeof t.func)return e.concat(t.func(c,o,n,true));return e.concat(t)},[])}else if("undefined"===typeof t)return h.IoC.resolve("ILogger").error(typeof t+" component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне был передан "+typeof t+"! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается "+typeof t),C.createText("",o.key);else return C.createText(t,o.key)}},C.joinElements=function e(t,r){if(Array.isArray(t))return o=[],n=r||"",t=p(t,true);else throw new Error("joinElements: elements is not array")},C.createTag=function e(t,r,o,n,i,a){if(!n)n={};if(!r)r={};var l=m.Attr.mergeAttrs(n.attributes,r.attributes),s=m.Attr.mergeEvents(n.events,r.events);m.Focus.prepareTabindex(l);var c={attributes:l,hooks:{},events:s||{}},u,f=c.attributes&&c.attributes.key?c.attributes.key:r.key;return o=p(o,true),y.Vdom.htmlNode(t,c,o,f,function(r){if(r){if(this.control&&this.attrs&&this.attrs.name){if(this.control._options.name===this.attrs.name&&"DIV"===r.tagName&&this.control.hasCompatible&&this.control.hasCompatible())this.attrs.name+="_fix";this.control._children[this.attrs.name]=r}if(this.attrs)C.cutFocusAttributes(this.attrs,function(e,t){r[e]=t},r)}}.bind({control:a,attrs:c.attributes}))},C.createText=function e(t,r){if(!t)return;return y.Vdom.textNode(t,r)},C.createDirective=function e(t){throw new Error("vdomMarkupGenerator createDirective not realized")},C.getScope=function(e){try{throw new Error('vdomMarkupGenerator: using scope="{{...}}"')}catch(e){h.IoC.resolve("ILogger").info("SCOPE ... in VDom",e.stack)}return e},C.canBeCompatible=false,C.escape=function(e){return e},e.default=C,e});