define("View/Executor/Markup",["Core/helpers/Array/flatten","View/Request","Core/library","Core/Serializer","Core/helpers/Number/randomId","View/Executor/Expressions","View/Executor/Utils","View/Logger","Env/Env","require","exports"],function(n,o,i,a,s,l,c,u,f,p,e){Object.defineProperty(e,"__esModule",{value:true}),e["View/Executor/_Markup/Generator"]=true;var m=function(){"use strict";var e={},t=function(e,t,b,d,x,w){Object.defineProperty(t,"__esModule",{value:true});var E={},o=/(\[def-[\w\d]+\])/g,i=["ws-creates-context","ws-delegates-tabfocus","ws-tab-cycling","ws-no-focus","attr:ws-creates-context","attr:ws-delegates-tabfocus","attr:ws-tab-cycling","attr:ws-no-focus"],r={createWsControl:function(e,t,r,n,o){throw new Error("Generator.createWsControl is not implemented")},createTemplate:function(e,t,r,n,o,i){throw new Error("Generator.createTemplate is not implemented")},createController:function(e,t,r,n,o){throw new Error("Generator.createController is not implemented")},resolver:function(e,t,r,n,o,i){throw new Error("Generator.resolver is not implemented")},joinElements:function(e,t){throw new Error("Generator.joinElements is not implemented")},createTag:function(e,t,r,n,o){throw new Error("Generator.createTag is not implemented")},createText:function(e){throw new Error("Generator.createText is not implemented")},createEmptyText:function(){throw new Error("Generator.createEmptyText is not implemented")},createDirective:function(e){throw new Error("Generator.createDirective is not implemented")},escape:function(e){throw new Error("Generator.escape is not implemented")},getScope:function(e){return e},chain:function(t,n){return Promise.all(n.def).then(function e(r){return t.replace(o,function(e){var t=n.id.indexOf(e);if(n.id[t])return r[t].result?r[t].result:r[t];return""})},function(e){x.Common.asyncRenderErrorLog(e)})},createControl:function(e,t,r,n,o,i,a,s,l,c,u){var f;if((r=x.ConfigResolver.resolveControlCfg(r,o,n)).internal.logicParent=r.internal.logicParent||o.viewController,r.internal.parent=r.internal.parent||o.viewController,n.internal=r.internal,r=r.user,null===t)return this.createText("",n.key);else{if("wsControl"===e)if(d.getLoggerStatus()||x.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createWsControl,this,[t,r,n,i,a]);else f=this.createWsControl(t,r,n,i,a);if("template"===e)if(d.getLoggerStatus()||x.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createTemplate,this,[t,r,n,i,a,l]);else f=this.createTemplate(t,r,n,i,a,l);if("controller"===e)if(d.getLoggerStatus()||x.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.createController,this,[t,r,n,i,a]);else f=this.createController(t,r,n,i,a);if("resolver"===e){var p,m;if(n.events)for(m in n.events)if(n.events.hasOwnProperty(m))for(p=0;p<n.events[m].length;p++)if(!n.events[m][p].fn.isControlEvent)n.events[m][p].toPartial=true;if(d.getLoggerStatus()||x.Common.isCompat())f=b.coreDebug.methodExecutionTime(this.resolver,this,[t,r,n,i,a,s,l,u]);else f=this.resolver(t,r,n,i,a,s,l,u)}if(void 0!==f)return f;else{if(t&&e)return this.createText("",n.key);if("undefined"===typeof t)return b.IoC.resolve("ILogger").error("Undefined component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне в опцию template был передан undefined! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается undefined"),this.createText("",n.key);throw new Error("MarkupGenerator: createControl type not resolved")}}},prepareDataForCreate:function(e,t,r,n,o){var i,a,s,l,c,u;if("function"===typeof e)s=(i=e).prototype?e.prototype._moduleName:"";if("string"===typeof e)if(x.Common.isLibraryModuleString(e))e=x.Common.splitModule(e);else{var f=x.Common.splitWs(e);if(f)e=f;if(e.indexOf("/")>-1)if(l=true,e.indexOf("optional!")>-1)c=true;if(e=e.replace("optional!",""),o&&o[e])i=o[e];if(!i)i=n&&(n[e]||n["optional!"+e]);if(!i)if(!l||c||b.constants.compat){if(x.RequireHelper.defined(e))i=x.RequireHelper.require(e)}else try{if(!(i=E[e]))i=x.RequireHelper.require(e),E[e]=i}catch(e){b.IoC.resolve("ILogger").warn("Create component",e,e.stack)}if(s=e,i&&i.default&&i.default.isWasaby)i=i.default}if("object"===typeof e&&e&&e.library&&e.module){var p=e.library+":"+e.module.join(".");if(n&&n[e.library])i=x.Common.extractLibraryModule(n[e.library],e.module);else if(x.RequireHelper.defined(e.library))i=x.Common.extractLibraryModule(x.RequireHelper.require(e.library),e.module);else{var m;if(E[e.library])i=x.Common.extractLibraryModule(E[e.library],e.module);else p=void 0}if(i&&i.prototype&&!i.prototype.hasOwnProperty("_moduleName"))i.prototype._moduleName=p;s=p}var d=i&&i.prototype&&x.Common.isCompound(i),v=w.Scope.calculateScope(t,x.Common.plainMerge)||{};if(d)for(var C in r.events)v[C]=r.events[C];if(!r.attributes)r.attributes={};if(w.Focus.prepareAttrsForFocus(r.attributes,v),a=r.internal&&r.internal.logicParent?r.internal.logicParent:null,u=r.internal&&r.internal.parent?r.internal.parent:null,x.OptionsResolver.resolveInheritOptions(i,r,v),b.constants.compat){if(v&&void 0===v.enabled){var h=r.internal;if(h&&h.parent&&d)if(void 0!==h.parentEnabled&&false!==v.allowChangeEnable)v.enabled=h.parentEnabled;else v.enabled=true;else if(d&&false===h.parentEnabled)v.__enabledOnlyToTpl=h.parentEnabled}if(d){var y=r.attributes;for(var g in y)if(y.hasOwnProperty(g)&&w.Event.isEvent(g))v[g]=y[g]}}return{logicParent:a,parent:u,attrs:r.attributes,controlProperties:v,dataComponent:s,internal:r.internal,controlClass:i,compound:!(i&&i.isWasaby)}},invisibleNodeCompat:function e(t){return t&&t.indexOf&&0===t.indexOf("<invisible-node")?t.replace(/invisible-node/g,"div"):t},cutFocusAttributes:function(t,r,n){i.forEach(function(e){if(t.hasOwnProperty(e))if(r&&r(e,t[e]),delete t[e],n)n.removeAttribute(e)})},joinAttrs:w.Attr.joinAttrs};t.default=r}(p,e,f,u,c,l);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}(),t=m;e["View/Executor/_Markup/Text/FunctionHeaderTemplate"]=true;var d=function(){"use strict";var e={},t=(r=p,n=e,Object.defineProperty(n,"__esModule",{value:true}),void(n.default="/*#DELETE IT START#*/\nfunction debug() { debugger; }\nvar thelpers = typeof tclosure === 'undefined' || !tclosure ? arguments[arguments.length - 1] : tclosure;\nif (typeof thelpers === \"undefined\" || !thelpers._isTClosure) {\neval(\"var thelpers = null;\");\nthelpers = (function(){return this || (0, eval)('this')})().requirejs(\"View/Executor/TClosure\");\n}\nvar depsLocal = typeof _deps === 'undefined' ? undefined : _deps;\nif (typeof includedTemplates === \"undefined\") {\neval(\"var includedTemplates = undefined;\");\nincludedTemplates = (this && this.includedTemplates) ? this.includedTemplates : {};\n}\n/*#DELETE IT END#*/\nvar templateCount = 0;\nvar key = attr && attr.key || '_';\nvar defCollection = {id: [], def: undefined};\nvar viewController = thelpers.configResolver.calcParent(this, typeof currentPropertyName === 'undefined' ? undefined : currentPropertyName, data);")),r,n;if(t instanceof Function)return t;else for(var o in t)if(t.hasOwnProperty(o))e[o]=t[o];return e}(),r=d;e["View/Executor/_Markup/Text/Generator"]=true;var v,C=function(){"use strict";var e={},t=function(p,e,i,v,o,a,C,m,d,h,y){Object.defineProperty(e,"__esModule",{value:true});var g=Object.create(d.default),l=["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr","path","circle","ellipse","line","rect","use","stop","polyline","polygon"];function b(e){return e&&e.then}function s(e,t){var r=t||{};if(e&&e.name)r.name=e.name;else if(t&&t.name)e.name=t.name;return r}function t(e){var t,r=[],n=e._linksStorage,o;for(var i in n)if(n.hasOwnProperty(i))if((t=n[i]).module)o=a.parse(t.module),r.push(o.name);return r}function c(n,o,i){var e=n.user,t,a;e["class"]=i["class"];var r=h.Subscriber.getEventsListFromOptions(e);for(var s in r)if(r.hasOwnProperty(s))delete e[s];var l=e.doNotSetParent;e.doNotSetParent=true;var c=e._logicParent&&e._logicParent._moduleName||"",u=y.OptionsResolver.getDefaultOptions(o);y.OptionsResolver.resolveOptions(o,u,e,c);var f=new o(e),p=e;if(p.doNotSetParent=l,"undefined"!==typeof window)h.Subscriber.subscribeEvents(f,n.internal.logicParent,r);if(f._template){if(f.saveOptions)f.saveOptions(p);else f._options=p;try{t=f._beforeMountLimited&&f._beforeMountLimited(p,n.templateContext||{})}catch(e){C.catchLifeCircleErrors("_beforeMount",e)}if(f.saveInheritOptions(n.inheritOptions||{}),t&&b(t))return new Promise(function(r){t.then(function(t){f._saveContextObject(h.ContextResolver.resolveContext(o,n.templateContext||{})),f.saveFullContext(h.ContextResolver.wrapContext(f,n.templateContext||{}));var e=m.getCurrent();if(e)e.stateReceiver.register(n.key,{getState:function(){return t},setState:function(){}});if((a=f._template?f.render(null,i):"").then)a.then(function(e){r({result:e,receivedState:t})},function(e){y.Common.asyncRenderErrorLog(e),r({result:E(f),receivedState:void 0})});else r({result:a,receivedState:t})},function(e){y.Common.asyncRenderErrorLog(e),r({result:E(f),receivedState:void 0})})});else f._saveContextObject(h.ContextResolver.resolveContext(o,n.templateContext||{})),f.saveFullContext(h.ContextResolver.wrapContext(f,n.templateContext||{}))}return a=f._template?d.default.invisibleNodeCompat(f.render(void 0,i)):""}function x(e,t,r,n,o){var i=t.user,a;return o=s(i,o),a=c({user:i,internal:t.internal,templateContext:t.templateContext,inheritOptions:t.inheritOptions,key:t.key},e,o)}function w(e,t,r,n){var o=n&&n.resolvers?y.Common.findResolverInConfig(e,n.resolvers):void 0;if(o)return o(e);else return y.Common.depsTemplateResolver(e,t,r,n)}function E(e){var t={},r;if(e&&e._options)r=e._options,t=h.Decorate.createRootDecoratorObject(r["__$config"],true,r["data-component"],{});return g.createTag("div",{attributes:t},[])}function u(e,t){function n(e){if(void 0===e||null===e)return"";else return e}var r;return function(e){var t="";for(var r in e)if(e.hasOwnProperty(r))t+=""!==n(e[r])?" "+r+'="'+e[r]+'"':"";return t}(g.joinAttrs(e,t))}if(g.createController=function(){return""},g.createEmptyText=function(){return""},g.createWsControl=function e(t,r,n,o,i){var a=this.prepareDataForCreate(t,r,n,i),s=a.dataComponent;C.log("createWsControl",[s,a.controlProperties]),C.log("Context for control",["",n.context]),C.log("Inherit options for control",["",n.inheritOptions]);var l=null,c=a.controlClass,u=c&&c.prototype&&c.prototype._template;if(!c&&!u){var f=new Error("Попытка создания контрола, у которого отсутствует конструктор и шаблон");return v.IoC.resolve("ILogger").error(f.message,f.stack),""}if(c&&!u)return g.createController(c,r,n,o,i);var p=a.controlProperties;if(!p["data-component"])p["data-component"]=s;for(var m=0;p.hasOwnProperty("__dirtyCheckingVars_"+m);m++)delete p["__dirtyCheckingVars_"+m];return x(c,{user:p,internal:a.internal,templateContext:n.context,inheritOptions:n.inheritOptions,key:n.key},o,l,n)},g.createTemplate=function e(t,r,n,o,i,a){var s,l=y.Common.hasResolver(t,a&&a.resolvers);if(y.Common.isString(t)){if(l)s=a.resolvers[l](t);else if((s=i&&i[t]||p(t))&&y.Common.isOptionalString(t)&&!y.Common.isTemplateString(t))return this.createWsControl(t.split("js!")[1],r,n,o,i)}else s=t;var c=this.prepareDataForCreate(t,r,n,i),u=c.parent,f=c.controlProperties;return C.log("createTemplate",[y.Common.isString(t)?t:"InlineFunction",c.controlProperties,s]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]),null===s?"":u?s.call(u,f,n,o):s(f,n,o)},g.resolver=function e(t,r,n,o,i,a,s,l){var c="string"===typeof t,u=y.Common.isLibraryModule(t),f=this.prepareDataForCreate(t,r,n,i,a),p=f.controlProperties,m;if(c)m=w(t,a,i,s);else if(u)m=f.controlClass;else m=t;if(y.Common.isControlClass(m)){if(c&&-1!==t.indexOf("js!")&&!y.RequireHelper.defined(m.prototype._moduleName))m.prototype._moduleName=t.split("js!")[1];if(m.prototype._template)return g.createWsControl(m,r,n,o,i)}else{var d;if(C.log("Resolver",[c?t:"InlineFunction",f.controlProperties,m]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]),"function"===typeof m)d=r&&f.parent?m.call(f.parent,p,n,o,false):m(p,n,o,false);else if(m&&"function"===typeof m.func)d=r&&f.parent?m.func.call(f.parent,p,n,o,false):m.func(p,n,o,false);else if(y.Common.isArray(m))d=r&&f.parent?m.map(function(e){if("function"===typeof e)return e.call(f.parent,p,n,o,false);else if("function"===typeof e.func)return e.func.call(f.parent,p,n,o,false);return e}):m.map(function(e){if("function"===typeof e)return e(p,n,o,false);else if("function"===typeof e.func)return e.func(p,n,o,false);return e}),d=g.joinElements(d,void 0,l);else if("undefined"===typeof t)return v.IoC.resolve("ILogger").error(typeof t+" component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне был передан "+typeof t+"! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается "+typeof t),"";else d=t;return d}},g.joinElements=function e(t,r,n){if(Array.isArray(t)){var o="";return t.forEach(function e(t){var r;if(Array.isArray(t))t=g.joinElements(t,void 0,n);if(t&&b(t)){if(r=i("def-"),!n.def)n.def=[];n.def.push(t),t="["+r+"]",n.id.push(t)}o+=t||""}),o}else throw new Error("joinElements: elements is not array")},g.createTag=function e(t,r,n,o,i){if(!o)o={};if(!r)r={};var a=h.Attr.processMergeAttributes(o.attributes,r.attributes,true);h.Focus.prepareTabindex(a),g.cutFocusAttributes(a);var s=a?u(a,{}):"";if(~l.indexOf(t))return"<"+t+s+" />";return"<"+t+s+">"+g.joinElements(n,void 0,i)+"</"+t+">"},g.createText=function e(t){return t},g.createDirective=function e(t){return"<"+t+">"},g.createComment=function e(t){return"\x3c!--"+t+"--\x3e"},g.makeInlineConfigs=function e(t,r,n){var o=g.serializeReceivedState(n);return t+'<script type="text/javascript" data-vdomignore="true">window.inline'+r.replace("cfg-","")+"='"+o+"';<\/script>"},g.serializeReceivedState=function e(t){var r=new o,n=JSON.stringify(t,r.serialize);return y.Common.componentOptsReArray.forEach(function(e){n=n.replace(e.toFind,e.toReplace)}),n},g.calculateScope=function e(t){return h.Scope.calculateScope(t,h.Scope.controlPropMerge)},g.buildMarkupForClass=x,g.escape=y.Common.escape,v.constants.isBrowserPlatform&&v.constants.compat)p(["View/Executor/GeneratorCompatible"]);e.default=g}(p,e,s,f,a,i,u,o,m,l,c,d);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["View/Executor/_Markup/Vdom/Generator"]=true;var h,y=function(){"use strict";var e={},t=function(c,e,p,v,C,t,m,h){Object.defineProperty(e,"__esModule",{value:true});var y=Object.create(t.default),n=[],o="";y.createEmptyText=function(e){return y.createText("",e)},y.createWsControl=function e(t,r,n,o,i){var a=this.prepareDataForCreate(t,r,n,i),s=a.controlClass;if(C.log("createWsControl",[a.dataComponent,a.controlProperties]),C.log("Context for control",["",n.context]),C.log("Inherit options for control",["",n.inheritOptions]),!s)return y.createText("",a.controlProperties&&a.controlProperties.__key||n.key);var l=a.compound,c=a.controlProperties;return{compound:l,invisible:false,controlClass:s,controlProperties:c,controlInternalProperties:a.internal,controlAttributes:a.attrs,controlEvents:n.events,key:c.__key||n.key,controlNodeIdx:-1,context:n.context,inheritOptions:n.inheritOptions}},y.createTemplate=function e(t,r,n,o,i){var a;if(h.Common.isString(t)){if((a=i&&i[t]||c(t))&&h.Common.isOptionalString(t)&&!h.Common.isTemplateString(t))return this.createWsControl(t.split("js!")[1],r,n,o,i)}else a=t;var s=this.prepareDataForCreate(t,r,n,i);if(C.log("createTemplate",[h.Common.isString(t)?t:"InlineFunction",s.controlProperties,a]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]),null==a)return"";if(s.controlProperties.__noDirtyChecking)return this.resolver(a,s.controlProperties,n,o,i);var l={compound:false,template:a,controlProperties:s.controlProperties,parentControl:s.parent,attributes:n,context:n.key,type:"TemplateNode"};return Object.defineProperty(l,"count",{configurable:true,get:function(){var e=0;if(this.children){for(var t=0;t<this.children.length;t++){var r;e+=this.children[t].count||0}return this.children.length+e}else return 0}}),l},y.createController=function e(t,r,n,o,i){return y.createWsControl.apply(this,arguments)},y.resolver=function e(t,r,n,o,i,a,s){var l=this.prepareDataForCreate(t,r,n,i,a),c=l.controlProperties,u="string"===typeof t,f=h.Common.isLibraryModule(t),p;if(u)p=h.Common.depsTemplateResolver(t,a,i,s);else p=l.controlClass;if(!p)if("function"===typeof t)p=t;else if(t&&"function"===typeof t.func)p=t;else if(h.Common.isArray(t))p=t;if(h.Common.isControlClass(p))return y.createWsControl(p,c,n,o,i);else{C.log("Resolver",[u?t:"InlineFunction",l.controlProperties,p]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]);var m=l.parent;if("function"===typeof p)return m?p.call(m,c,n,o,true,void 0):p(c,n,o,true);else if(p&&"function"===typeof p.func)return m?p.func.call(m,c,n,o,true,void 0):p.func(c,n,o,true);else if(h.Common.isArray(p)){var d;return m?p.reduce(function(e,t){if("function"===typeof t)return e.concat(t.call(m,c,n,o,true));else if("function"===typeof t.func)return e.concat(t.func.call(m,c,n,o,true));return e.concat(t)},[]):p.reduce(function(e,t){if("function"===typeof t)return e.concat(t(c,n,o,true));else if("function"===typeof t.func)return e.concat(t.func(c,n,o,true));return e.concat(t)},[])}else if("undefined"===typeof t)return v.IoC.resolve("ILogger").error(typeof t+" component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне был передан "+typeof t+"! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается "+typeof t),y.createText("",n.key);else return y.createText(t,n.key)}},y.joinElements=function e(t,r){if(Array.isArray(t))return n=[],o=r||"",t=p(t,true);else throw new Error("joinElements: elements is not array")},y.createTag=function e(t,r,n,o,i,a){if(!o)o={};if(!r)r={};var s=m.Attr.mergeAttrs(o.attributes,r.attributes),l=m.Attr.mergeEvents(o.events,r.events);m.Focus.prepareTabindex(s);var c={attributes:s,hooks:{},events:l||{}},u,f=c.attributes&&c.attributes.key?c.attributes.key:r.key;return n=p(n,true),h.Vdom.htmlNode(t,c,n,f,function(r){if(r){if(this.control&&this.attrs&&this.attrs.name){if(this.control._options.name===this.attrs.name&&"DIV"===r.tagName&&this.control.hasCompatible&&this.control.hasCompatible())this.attrs.name+="_fix";this.control._children[this.attrs.name]=r}if(this.attrs)y.cutFocusAttributes(this.attrs,function(e,t){r[e]=t},r)}}.bind({control:a,attrs:c.attributes}))},y.createText=function e(t,r){if(!t)return;return h.Vdom.textNode(t,r)},y.createDirective=function e(t){throw new Error("vdomMarkupGenerator createDirective not realized")},y.getScope=function(e){try{throw new Error('vdomMarkupGenerator: using scope="{{...}}"')}catch(e){v.IoC.resolve("ILogger").info("SCOPE ... in VDom",e.stack)}return e},y.canBeCompatible=false,y.escape=function(e){return e},e.default=y}(p,e,n,f,u,m,l,c);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();return e.Generator=t.default,e.GeneratorText=C.default,e.GeneratorVdom=y.default,e.FunctionHeaderTemplate=r.default,e});