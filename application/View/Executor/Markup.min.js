define("View/Executor/Markup",["Core/helpers/Array/flatten","View/Request","Core/library","Core/Serializer","Core/helpers/Hcontrol/configStorage","Core/helpers/Number/randomId","View/Executor/Expressions","View/Executor/Utils","View/Logger","Core/IoC","Core/constants","Core/core-debug","require","exports"],function(n,o,i,a,l,s,u,c,f,p,m,d,v,e){Object.defineProperty(e,"__esModule",{value:true}),e["View/Executor/_Markup/Generator"]=true;var C=function(){"use strict";var e={},t=function(e,t,d,b,x,v,w,E){Object.defineProperty(t,"__esModule",{value:true});var T={},o=/(\[def-[\w\d]+\])/g,i=["ws-creates-context","ws-delegates-tabfocus","ws-tab-cycling","ws-no-focus","attr:ws-creates-context","attr:ws-delegates-tabfocus","attr:ws-tab-cycling","attr:ws-no-focus"],r={createWsControl:function(e,t,r,n,o){throw new Error("Generator.createWsControl is not implemented")},createTemplate:function(e,t,r,n,o,i){throw new Error("Generator.createTemplate is not implemented")},createController:function(e,t,r,n,o){throw new Error("Generator.createController is not implemented")},resolver:function(e,t,r,n,o,i){throw new Error("Generator.resolver is not implemented")},joinElements:function(e,t){throw new Error("Generator.joinElements is not implemented")},createTag:function(e,t,r,n,o){throw new Error("Generator.createTag is not implemented")},createText:function(e){throw new Error("Generator.createText is not implemented")},createEmptyText:function(){throw new Error("Generator.createEmptyText is not implemented")},createDirective:function(e){throw new Error("Generator.createDirective is not implemented")},escape:function(e){throw new Error("Generator.escape is not implemented")},getScope:function(e){return e},chain:function(t,n){return Promise.all(n.def).then(function e(r){return t.replace(o,function(e){var t=n.id.indexOf(e);if(n.id[t])return r[t].result?r[t].result:r[t];return""})},function(e){w.Common.asyncRenderErrorLog(e)})},createControl:function(e,t,r,n,o,i,a,l,s,u,c){var f;if((r=w.ConfigResolver.resolveControlCfg(r,o,n)).internal.logicParent=r.internal.logicParent||o.viewController,r.internal.parent=r.internal.parent||o.viewController,n.internal=r.internal,r=r.user,null===t)return this.createText("",n.key);else{if("wsControl"===e)if(v.getLoggerStatus()||w.Common.isCompat())f=d.methodExecutionTime(this.createWsControl,this,[t,r,n,i,a]);else f=this.createWsControl(t,r,n,i,a);if("template"===e)if(v.getLoggerStatus()||w.Common.isCompat())f=d.methodExecutionTime(this.createTemplate,this,[t,r,n,i,a,s]);else f=this.createTemplate(t,r,n,i,a,s);if("controller"===e)if(v.getLoggerStatus()||w.Common.isCompat())f=d.methodExecutionTime(this.createController,this,[t,r,n,i,a]);else f=this.createController(t,r,n,i,a);if("resolver"===e){var p,m;if(n.events)for(m in n.events)if(n.events.hasOwnProperty(m))for(p=0;p<n.events[m].length;p++)if(!n.events[m][p].fn.isControlEvent)n.events[m][p].toPartial=true;if(v.getLoggerStatus()||w.Common.isCompat())f=d.methodExecutionTime(this.resolver,this,[t,r,n,i,a,l,s,c]);else f=this.resolver(t,r,n,i,a,l,s,c)}if(void 0!==f)return f;else{if(t&&e)return this.createText("",n.key);if("undefined"===typeof t)return x.resolve("ILogger").error("Undefined component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне в опцию template был передан undefined! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается undefined"),this.createText("",n.key);throw new Error("MarkupGenerator: createControl type not resolved")}}},prepareDataForCreate:function(e,t,r,n,o){var i,a,l,s,u,c;if("function"===typeof e)l=(i=e).prototype?e.prototype._moduleName:"";if("string"===typeof e)if(w.Common.isLibraryModuleString(e))e=w.Common.splitModule(e);else{var f=w.Common.splitWs(e);if(f)e=f;if(e.indexOf("/")>-1)if(s=true,e.indexOf("optional!")>-1)u=true;if(e=e.replace("optional!",""),o&&o[e])i=o[e];if(!i)i=n&&(n[e]||n["optional!"+e]);if(!i)if(!s||u||b.compat){if(w.RequireHelper.defined(e))i=w.RequireHelper.require(e)}else try{if(!(i=T[e]))i=w.RequireHelper.require(e),T[e]=i}catch(e){x.resolve("ILogger").warn("Create component",e,e.stack)}if(l=e,i&&i.default&&i.default.isWasaby)i=i.default}if("object"===typeof e&&e&&e.library&&e.module){var p=e.library+":"+e.module.join(".");if(n&&n[e.library])i=w.Common.extractLibraryModule(n[e.library],e.module);else if(w.RequireHelper.defined(e.library))i=w.Common.extractLibraryModule(w.RequireHelper.require(e.library),e.module);else{var m;if(T[e.library])i=w.Common.extractLibraryModule(T[e.library],e.module);else p=void 0}if(i&&i.prototype&&!i.prototype.hasOwnProperty("_moduleName"))i.prototype._moduleName=p;l=p}var d=i&&i.prototype&&w.Common.isCompound(i),v=E.Scope.calculateScope(t,w.Common.plainMerge)||{};if(d)for(var C in r.events)v[C]=r.events[C];if(!r.attributes)r.attributes={};if(E.Focus.prepareAttrsForFocus(r.attributes,v),a=r.internal&&r.internal.logicParent?r.internal.logicParent:null,c=r.internal&&r.internal.parent?r.internal.parent:null,w.OptionsResolver.resolveInheritOptions(i,r,v),b.compat){if(v&&void 0===v.enabled){var h=r.internal;if(h&&h.parent&&d)if(void 0!==h.parentEnabled&&false!==v.allowChangeEnable)v.enabled=h.parentEnabled;else v.enabled=true;else if(d&&false===h.parentEnabled)v.__enabledOnlyToTpl=h.parentEnabled}if(d){var y=r.attributes;for(var g in y)if(y.hasOwnProperty(g)&&E.Event.isEvent(g))v[g]=y[g]}}return{logicParent:a,parent:c,attrs:r.attributes,controlProperties:v,dataComponent:l,internal:r.internal,controlClass:i,compound:!(i&&i.isWasaby)}},cutFocusAttributes:function(t,r,n){i.forEach(function(e){if(t.hasOwnProperty(e))if(r&&r(e,t[e]),delete t[e],n)n.removeAttribute(e)})},joinAttrs:E.Attr.joinAttrs};t.default=r}(v,e,d,m,p,f,c,u);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}(),t=C;e["View/Executor/_Markup/Text/FunctionHeaderTemplate"]=true;var h=function(){"use strict";var e={},t=(r=v,n=e,Object.defineProperty(n,"__esModule",{value:true}),void(n.default="/*#DELETE IT START#*/\nfunction debug() { debugger; }\nvar thelpers = typeof tclosure === 'undefined' || !tclosure ? arguments[arguments.length - 1] : tclosure;\nif (typeof thelpers === \"undefined\" || !thelpers._isTClosure) {\neval(\"var thelpers = null;\");\nthelpers = (function(){return this || (0, eval)('this')})().requirejs(\"View/Executor/TClosure\");\n}\nvar depsLocal = typeof _deps === 'undefined' ? undefined : _deps;\nif (typeof includedTemplates === \"undefined\") {\neval(\"var includedTemplates = undefined;\");\nincludedTemplates = (this && this.includedTemplates) ? this.includedTemplates : {};\n}\n/*#DELETE IT END#*/\nvar templateCount = 0;\nvar key = attr && attr.key || '_';\nvar defCollection = {id: [], def: undefined};\nvar viewController = thelpers.configResolver.calcParent(this, typeof currentPropertyName === 'undefined' ? undefined : currentPropertyName, data);")),r,n;if(t instanceof Function)return t;else for(var o in t)if(t.hasOwnProperty(o))e[o]=t[o];return e}(),r=h;e["View/Executor/_Markup/Text/Generator"]=true;var y,g=function(){"use strict";var e={},t=function(p,e,i,o,v,t,a,l,C,m,r,d,h){Object.defineProperty(e,"__esModule",{value:true});var y=Object.create(r.default),s=["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr","path","circle","ellipse","line","rect","use","stop","polyline","polygon"];function g(e){return e&&e.then}function u(e,t){var r=t||{};if(e&&e.name)r.name=e.name;else if(t&&t.name)e.name=t.name;return r}function n(e){var t,r=[],n=e._linksStorage,o;for(var i in n)if(n.hasOwnProperty(i))if((t=n[i]).module)o=l.parse(t.module),r.push(o.name);return r}function c(n,o,i){var e=n.user,t,a;e["class"]=i["class"];var r=d.Subscriber.getEventsListFromOptions(e);for(var l in r)if(r.hasOwnProperty(l))delete e[l];var s=e.doNotSetParent;e.doNotSetParent=true;var u=e._logicParent&&e._logicParent._moduleName||"",c=h.OptionsResolver.getDefaultOptions(o);h.OptionsResolver.resolveOptions(o,c,e,u);var f=new o(e),p=e;if(p.doNotSetParent=s,"undefined"!==typeof window)d.Subscriber.subscribeEvents(f,n.internal.logicParent,r);if(f._template){if(f.saveOptions)f.saveOptions(p);else f._options=p;try{t=f._beforeMountLimited&&f._beforeMountLimited(p,n.templateContext||{})}catch(e){C.catchLifeCircleErrors("_beforeMount",e)}if(f.saveInheritOptions(n.inheritOptions||{}),t&&g(t))return new Promise(function(r){t.then(function(t){f._saveContextObject(d.ContextResolver.resolveContext(o,n.templateContext||{})),f.saveFullContext(d.ContextResolver.wrapContext(f,n.templateContext||{}));var e=m.getCurrent();if(e)e.stateReceiver.register(n.key,{getState:function(){return t},setState:function(){}});if((a=f._template?f.render(null,i):"").then)a.then(function(e){r({result:e,receivedState:t})},function(e){h.Common.asyncRenderErrorLog(e),r({result:w(f),receivedState:void 0})});else r({result:a,receivedState:t})},function(e){h.Common.asyncRenderErrorLog(e),r({result:w(f),receivedState:void 0})})});else f._saveContextObject(d.ContextResolver.resolveContext(o,n.templateContext||{})),f.saveFullContext(d.ContextResolver.wrapContext(f,n.templateContext||{}))}return a=f._template?f.render(void 0,i):""}function b(e,t,r,n,o){var i=t.user,a;return o=u(i,o),a=c({user:i,internal:t.internal,templateContext:t.templateContext,inheritOptions:t.inheritOptions,key:t.key},e,o)}function x(e,t,r,n){var o=n&&n.resolvers?h.Common.findResolverInConfig(e,n.resolvers):void 0;if(o)return o(e);else return h.Common.depsTemplateResolver(e,t,r,n)}function w(e){var t={},r;if(e&&e._options)r=e._options,t=d.Decorate.createRootDecoratorObject(r["__$config"],true,r["data-component"],{});return y.createTag("div",{attributes:t},[])}function f(e,t){function n(e){if(void 0===e||null===e)return"";else return e}var r;return function(e){var t="";for(var r in e)if(e.hasOwnProperty(r))t+=""!==n(e[r])?" "+r+'="'+e[r]+'"':"";return t}(y.joinAttrs(e,t))}if(y.createController=function(){return""},y.createEmptyText=function(){return""},y.createWsControl=function e(t,r,n,o,i){var a=this.prepareDataForCreate(t,r,n,i),l=a.dataComponent;C.log("createWsControl",[l,a.controlProperties]),C.log("Context for control",["",n.context]),C.log("Inherit options for control",["",n.inheritOptions]);var s=null,u=a.controlClass,c=u&&u.prototype&&u.prototype._template;if(!u&&!c)return"";if(u&&!c)return y.createController(u,r,n,o,i);var f=a.controlProperties;if(!f["data-component"])f["data-component"]=l;for(var p=0;f.hasOwnProperty("__dirtyCheckingVars_"+p);p++)delete f["__dirtyCheckingVars_"+p];return b(u,{user:f,internal:a.internal,templateContext:n.context,inheritOptions:n.inheritOptions,key:n.key},o,s,n)},y.createTemplate=function e(t,r,n,o,i,a){var l,s=h.Common.hasResolver(t,a&&a.resolvers);if(h.Common.isString(t)){if(s)l=a.resolvers[s](t);else if((l=i&&i[t]||p(t))&&h.Common.isOptionalString(t)&&!h.Common.isTemplateString(t))return this.createWsControl(t.split("js!")[1],r,n,o,i)}else l=t;var u=this.prepareDataForCreate(t,r,n,i),c=u.parent,f=u.controlProperties;return C.log("createTemplate",[h.Common.isString(t)?t:"InlineFunction",u.controlProperties,l]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]),null===l?"":c?l.call(c,f,n,o):l(f,n,o)},y.resolver=function e(t,r,n,o,i,a,l,s){var u="string"===typeof t,c=h.Common.isLibraryModule(t),f=this.prepareDataForCreate(t,r,n,i,a),p=f.controlProperties,m;if(u)m=x(t,a,i,l);else if(c)m=f.controlClass;else m=t;if(h.Common.isControlClass(m)){if(u&&-1!==t.indexOf("js!")&&!h.RequireHelper.defined(m.prototype._moduleName))m.prototype._moduleName=t.split("js!")[1];if(m.prototype._template)return y.createWsControl(m,r,n,o,i)}else{var d;if(C.log("Resolver",[u?t:"InlineFunction",f.controlProperties,m]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]),"function"===typeof m)d=r&&f.parent?m.call(f.parent,p,n,o,false):m(p,n,o,false);else if(m&&"function"===typeof m.func)d=r&&f.parent?m.func.call(f.parent,p,n,o,false):m.func(p,n,o,false);else if(h.Common.isArray(m))d=r&&f.parent?m.map(function(e){if("function"===typeof e)return e.call(f.parent,p,n,o,false);else if("function"===typeof e.func)return e.func.call(f.parent,p,n,o,false);return e}):m.map(function(e){if("function"===typeof e)return e(p,n,o,false);else if("function"===typeof e.func)return e.func(p,n,o,false);return e}),d=y.joinElements(d,void 0,s);else if("undefined"===typeof t)return v.resolve("ILogger").error(typeof t+" component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне был передан "+typeof t+"! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается "+typeof t),"";else d=t;return d}},y.joinElements=function e(t,r,n){if(Array.isArray(t)){var o="";return t.forEach(function e(t){var r;if(Array.isArray(t))t=y.joinElements(t,void 0,n);if(t&&g(t)){if(r=i("def-"),!n.def)n.def=[];n.def.push(t),t="["+r+"]",n.id.push(t)}o+=t||""}),o}else throw new Error("joinElements: elements is not array")},y.createTag=function e(t,r,n,o,i){if(!o)o={};if(!r)r={};var a=d.Attr.processMergeAttributes(o.attributes,r.attributes,true);d.Focus.prepareTabindex(a),y.cutFocusAttributes(a);var l=a?f(a,{}):"";if(~s.indexOf(t))return"<"+t+l+" />";return"<"+t+l+">"+y.joinElements(n,void 0,i)+"</"+t+">"},y.createText=function e(t){return t},y.createDirective=function e(t){return"<"+t+">"},y.createComment=function e(t){return"\x3c!--"+t+"--\x3e"},y.makeInlineConfigs=function e(t,r,n){var o=y.serializeReceivedState(n);return t+'<script type="text/javascript" data-vdomignore="true">window.inline'+r.replace("cfg-","")+"='"+o+"';<\/script>"},y.serializeReceivedState=function e(t){var r=new a,n=JSON.stringify(t,r.serialize);return h.Common.componentOptsReArray.forEach(function(e){n=n.replace(e.toFind,e.toReplace)}),n},y.saveConfig=function e(t,r){if("undefined"!==typeof window){var n={};n[t]=r,o.merge(n)}},y.calculateScope=function e(t){return d.Scope.calculateScope(t,d.Scope.controlPropMerge)},y.buildMarkupForClass=b,y.escape=h.Common.escape,t.isBrowserPlatform&&t.compat)p(["View/Executor/GeneratorCompatible"]);e.default=y}(v,e,s,l,p,m,a,i,f,o,C,u,c,h);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["View/Executor/_Markup/Vdom/Generator"]=true;var b,x=function(){"use strict";var e={},t=function(u,e,p,v,C,t,m,h){Object.defineProperty(e,"__esModule",{value:true});var y=Object.create(t.default),n=[],o="";y.createEmptyText=function(e){return y.createText("",e)},y.createWsControl=function e(t,r,n,o,i){var a=this.prepareDataForCreate(t,r,n,i),l=a.controlClass;if(C.log("createWsControl",[a.dataComponent,a.controlProperties]),C.log("Context for control",["",n.context]),C.log("Inherit options for control",["",n.inheritOptions]),!l)return y.createText("",a.controlProperties&&a.controlProperties.__key||n.key);var s=a.compound,u=a.controlProperties;return{compound:s,invisible:false,controlClass:l,controlProperties:u,controlInternalProperties:a.internal,controlAttributes:a.attrs,controlEvents:n.events,key:u.__key||n.key,controlNodeIdx:-1,context:n.context,inheritOptions:n.inheritOptions}},y.createTemplate=function e(t,r,n,o,i){var a;if(h.Common.isString(t)){if((a=i&&i[t]||u(t))&&h.Common.isOptionalString(t)&&!h.Common.isTemplateString(t))return this.createWsControl(t.split("js!")[1],r,n,o,i)}else a=t;var l=this.prepareDataForCreate(t,r,n,i);if(C.log("createTemplate",[h.Common.isString(t)?t:"InlineFunction",l.controlProperties,a]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]),null==a)return"";if(l.controlProperties.__noDirtyChecking)return this.resolver(a,l.controlProperties,n,o,i);var s={compound:false,template:a,controlProperties:l.controlProperties,parentControl:l.parent,attributes:n,context:n.key,type:"TemplateNode"};return Object.defineProperty(s,"count",{configurable:true,get:function(){var e=0;if(this.children){for(var t=0;t<this.children.length;t++){var r;e+=this.children[t].count||0}return this.children.length+e}else return 0}}),s},y.createController=function e(t,r,n,o,i){return y.createWsControl.apply(this,arguments)},y.resolver=function e(t,r,n,o,i,a,l){var s=this.prepareDataForCreate(t,r,n,i,a),u=s.controlProperties,c="string"===typeof t,f=h.Common.isLibraryModule(t),p;if(c)p=h.Common.depsTemplateResolver(t,a,i,l);else p=s.controlClass;if(!p)if("function"===typeof t)p=t;else if(t&&"function"===typeof t.func)p=t;else if(h.Common.isArray(t))p=t;if(h.Common.isControlClass(p))return y.createWsControl(p,u,n,o,i);else{C.log("Resolver",[c?t:"InlineFunction",s.controlProperties,p]),C.log("Context for template",["",n.context]),C.log("Inherit options for template",["",n.inheritOptions]);var m=s.parent;if("function"===typeof p)return m?p.call(m,u,n,o,true,void 0):p(u,n,o,true);else if(p&&"function"===typeof p.func)return m?p.func.call(m,u,n,o,true,void 0):p.func(u,n,o,true);else if(h.Common.isArray(p)){var d;return m?p.reduce(function(e,t){if("function"===typeof t)return e.concat(t.call(m,u,n,o,true));else if("function"===typeof t.func)return e.concat(t.func.call(m,u,n,o,true));return e.concat(t)},[]):p.reduce(function(e,t){if("function"===typeof t)return e.concat(t(u,n,o,true));else if("function"===typeof t.func)return e.concat(t.func(u,n,o,true));return e.concat(t)},[])}else if("undefined"===typeof t)return v.resolve("ILogger").error(typeof t+" component error","Попытка использовать компонент/шаблон, "+"но вместо компонента в шаблоне был передан "+typeof t+"! "+"Если верстка строится неправильно, нужно поставить точку останова и исследовать стек вызовов. "+"По стеку будет понятно, в каком шаблоне и в какую опцию передается "+typeof t),y.createText("",n.key);else return y.createText(t,n.key)}},y.joinElements=function e(t,r){if(Array.isArray(t))return n=[],o=r||"",t=p(t,true);else throw new Error("joinElements: elements is not array")},y.createTag=function e(t,r,n,o,i,a){if(!o)o={};if(!r)r={};var l=m.Attr.mergeAttrs(o.attributes,r.attributes),s=m.Attr.mergeEvents(o.events,r.events);m.Focus.prepareTabindex(l);var u={attributes:l,hooks:{},events:s||{}},c,f=u.attributes&&u.attributes.key?u.attributes.key:r.key;return n=p(n,true),h.Vdom.htmlNode(t,u,n,f,function(r){if(r){if(this.control&&this.attrs&&this.attrs.name){if(this.control._options.name===this.attrs.name&&"DIV"===r.tagName&&this.control.hasCompatible&&this.control.hasCompatible())this.attrs.name+="_fix";this.control._children[this.attrs.name]=r}if(this.attrs)y.cutFocusAttributes(this.attrs,function(e,t){r[e]=t},r)}}.bind({control:a,attrs:u.attributes}))},y.createText=function e(t,r){if(!t)return;return h.Vdom.textNode(t,r)},y.createDirective=function e(t){throw new Error("vdomMarkupGenerator createDirective not realized")},y.getScope=function(e){try{throw new Error('vdomMarkupGenerator: using scope="{{...}}"')}catch(e){v.resolve("ILogger").info("SCOPE ... in VDom",e.stack)}return e},y.canBeCompatible=false,y.escape=function(e){return e},e.default=y}(v,e,n,p,f,C,u,c);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();return e.Generator=t.default,e.GeneratorText=g.default,e.GeneratorVdom=x.default,e.FunctionHeaderTemplate=r.default,e});