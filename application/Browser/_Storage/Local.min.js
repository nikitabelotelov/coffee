define("Browser/_Storage/Local",["require","exports","tslib","Env/Event","Browser/_Storage/NativeGetter","Browser/_Storage/utils/item","Browser/_Storage/utils/prefix","Types/entity"],function(e,t,r,i,n,s,f,o){"use strict";Object.defineProperty(t,"__esModule",{value:true});var u=function(){return this||(0,eval)("this")}(),a="ws-store-always-keys",c=["onChange","onRemove","onClear"],h=function(){return i.Bus.channel("local_storage")},l=n(),p=false;function v(){if(p||!u)return;if(p=true,u.addEventListener)return u.addEventListener("storage",d,false)}function d(e){if(!e&&u.event)e=u.event;if(!e)return;var t=e.key,r=e.newValue,i=e.oldValue;if(!t)return void h().notify("onClear");if(!r)return h().notify("onRemove",t);return h().notify("onChange",t,s.deserialize(r))}function y(e,t,r){if(!t)return this._notify(e.name);if(f.startsWith(t,this.prefix))return this._notify(e.name,f.remove(t,this.prefix),r)}function m(e,t){return s.deserialize(l.getItem(e,!t))}function g(t){return l.getKeys().filter(function(e){return f.startsWith(e,t)})}var x=function(n){function e(e,t,r){if(void 0===e)e="";if(void 0===t)t=false;if(void 0===r)r=true;var i=n.call(this)||this;return i.prefix=e,i.storeAlways=t,i.isCheckSession=r,i._onStorage=y.bind(i),c.forEach(function(e){h().subscribe(e,i._onStorage)}),i._publish.apply(i,c),v(),i}return r.__extends(e,n),e.prototype.destroy=function(){var t=this;return c.forEach(function(e){h().unsubscribe(e,t._onStorage)}),n.prototype.destroy.call(this)},e.prototype.setItem=function(e,t){var r=f.add(e,this.prefix),i=s.serialize(t),n=l.setItem(r,i,!this.isCheckSession);if(!n||!this.storeAlways)return n;var o=m(a,!this.isCheckSession)||[];if(-1===o.indexOf(r))o.push(r),l.setItem(a,s.serialize(o),!this.isCheckSession);return n},e.prototype.getItem=function(e){return m(f.add(e,this.prefix),!this.isCheckSession)},e.prototype.removeItem=function(e){return l.removeItem(f.add(e,this.prefix))},e.prototype.clear=function(){g(this.prefix).forEach(function(e){l.removeItem(e)})},e.prototype.getKeys=function(){var t=this;return g(this.prefix).map(function(e){return f.remove(e,t.prefix)})},e.prototype.toObject=function(){var t=this,r={};return g(this.prefix).forEach(function(e){r[e]=m(e,!t.isCheckSession)}),r},e.clearAll=function(){l.clear()},e}(o.ObservableMixin);t.default=x});