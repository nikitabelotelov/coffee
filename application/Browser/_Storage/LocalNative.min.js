define("Browser/_Storage/LocalNative",["require","exports","Core/UserInfo","Env/Env","Env/Constants","Core/helpers/String/format","Core/i18n","Browser/_Storage/_storage","Env/Event"],function(e,t,r,n,o,i,s,u,a){"use strict";Object.defineProperty(t,"__esModule",{value:true});var f="__s3su",c="ws-local-keys",g="ws-store-always-keys",m=u.getLocal(),l=1024*512,v=s.rk('Превышен максимальный размер записи ($max$d$ kb) в локальное хранилище для ключа "$key$s$" ($size$F$2$ kb)');function I(e,t){if(void 0===t)t="log";n.IoC.resolve("ILogger")[t]("Core/LocalStorageNative",e)}function h(e){var t=encodeURIComponent(e).match(/%[89ABab]/g);return e.length+(t?t.length:0)}function y(e,t){if(!o.constants.isBrowserPlatform)return true;var r=h(t);if(r<=l)return true;return I(i({max:l/1024,key:e,size:r/1024},v)),false}function d(){m.setItem(f,r.getCurrent())}var O=function(){var e=S(),t;try{t=[].concat(JSON.parse(m.getItem(g)))}catch(e){t=[]}var r=[];e.forEach(function(e){if(-1===t.indexOf(e))return m.removeItem(e);r.push(e)}),m.setItem(c,JSON.stringify(r))},S=function(){try{return JSON.parse(m.getItem(c))||[]}catch(e){return[]}};function $(){var e=m.getItem(f);if(!r.isValid(e))O(),d()}a.Bus.channel("errors").subscribe("onAuthError",$),$();var p={getItem:function(e){return m.getItem(e)},setItem:function(e,t){if(e===f)return false;var r=""+t;if(!y(e,r))return false;var n=m.setItem(e,r),o=S();if(-1===o.indexOf(e)&&e!==g)o.push(e),m.setItem(c,JSON.stringify(o));return!!n},removeItem:function(t){if(t===f)return;m.removeItem(t);var e=S(),r;e=e.filter(function(e){return t!==e}),m.setItem(c,JSON.stringify(e));try{r=JSON.parse(m.getItem(g))||[]}catch(e){r=[]}if(-1!==r.indexOf(t))r=r.filter(function(e){return t!==e}),m.setItem(g,JSON.stringify(r))},clear:function(){O(),d()},getLength:function(){return S().length},getKeys:function(){return S()}};t.default=p});