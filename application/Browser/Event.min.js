define("Browser/Event",["optional!Types/entity","Core/UserInfo","Browser/Transport","tslib","Core/helpers/createGUID","Env/Env","Browser/Storage","Env/Event","Env/Constants","Core/Deferred","require","exports"],function(n,o,i,s,a,c,u,f,h,l,p,e){Object.defineProperty(e,"__esModule",{value:true}),e["Browser/_Event/Server/native/HashedCounter"]=true;var v=function(){"use strict";var e={},t=function(e,t){Object.defineProperty(t,"__esModule",{value:true});var r=function(){function e(e){if(void 0===e)e=true;if(this.counter=Object.create(null),this.list=[],!e)this.add=this.addWithoutCount.bind(this)}return e.prototype.add=function(e){var t=this.counter[e.hash()]||0;t+=1,this.counter[e.hash()]=t,this.list.push(e)},e.prototype.addWithoutCount=function(e){var t;if((this.counter[e.hash()]||0)>0)return;this.counter[e.hash()]=1,this.list.push(e)},e.prototype.remove=function(t){var e=this.counter[t.hash()]||0;if(0===e)return;if(e-=1,0===(this.counter[t.hash()]=e))return this.list=this.list.filter(function(e){return e.hash()!==t.hash()}),void delete this.counter[t.hash()];var r=this.list.indexOf(t);if(r>-1)return void this.list.splice(r,1);var n=-1,o=0;while(-1===n&&o<this.list.length){var i;if(this.list[o].hash()===t.hash())n=o;o+=1}if(n>-1)this.list.splice(n,1)},e.prototype.has=function(e){return!!this.counter[e.hash()]},e.prototype.getSubscribes=function(){return this.list.slice()},e.prototype.getByName=function(e){for(var t=[],r=0,n=this.list;r<n.length;r++){var o=n[r];if(o.getChannelName()!==e)continue;t.push(o)}return t},e.prototype.getCount=function(e){return this.counter[e.hash()]||0},e.prototype.clear=function(){this.list=[],this.counter=Object.create(null)},e}();t.HashedCounter=r}(p,e);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/ResponseConverter"]=true;var d=function(){"use strict";var e={},t=function(e,t,r){var n=i,o=i;if(!!r.Record)n=function(e){if("record"!=e._type)throw new TypeError("Raw data is not Record");return new r.Record({rawData:e,adapter:"adapter.sbis"})};if(!!r.RecordSet)o=function(e){if("recordset"!=e._type)throw new TypeError("Raw data is not RecordSet");return new r.RecordSet({rawData:e,adapter:"adapter.sbis"})};function i(e){return e}function s(e){return e&&e.s&&e.d&&"record"==e._type}function a(e){return e&&e.s&&e.d&&"recordset"==e._type}function c(e){for(var t in e){if(!e.hasOwnProperty(t))continue;e[t]=f(e[t])}return e}function u(e){for(var t=[],r=0,n=e;r<n.length;r++){var o=n[r];t.push(f(o))}return t}function f(e){if(s(e))return n(e);if(a(e))return o(e);if(e instanceof Array)return u(e);return e}function h(e){return f(JSON.parse(e))}return h}(p,e,n);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/transport/Constants"]=true;var b=function(){"use strict";var e={},t=(r=p,n=e,{LS_PREFIX:"SEB",CHECK_MIN_INTERVAL:4e3,RECONNECT_INTERVAL:1e4,KEY_ACTUAL_DATE:"actual-date",KEY_TRY_CREATE_MAIN:"reconnect-main-time",KEY_SUBSCRIBE:"SEB.subscribe",KEY_UNSUBSCRIBE:"SEB.unsubscribe",KEY_MAINREADY:"SEB.iammain",KEY_NEW_PAGE:"SEB.nwepage"}),r,n,o;if(t instanceof Function)return t;else for(var i in t)if(t.hasOwnProperty(i))e[i]=t[i];return e}();e["Browser/_Event/Server/DebugUtils"]=true;var y=function(){"use strict";var e={},t=(s=p,r=e,function(e){function t(){if("function"!==typeof Promise)return;var r=function(e){var t="";if(e["headers"]&&e["headers"]["event-type"])t=e["headers"]["event-type"];console.log("[EventLog]",new Date(e.timestamp).toLocaleString(),t,e)},o=function(e,t){e.query(t).then(function(e){e.forEach(r)})},i;window["sharedBusLog"]=function(n){if(i)return void o(i,n);s(["Browser/_Event/Server/native/_IndexedDB"],function(e){var t=e.Connector,r=e.AdapterStomp;t.connect(t.DB_DEBUG,t.DEBUG_STORE_NAME,new r).addCallback(function(e){i=e.createReader(),o(i,n)})})}}var r=false;function n(){if(r)return;r=true,s(["Browser/_Event/Server/Bus","Browser/_Event/Server/_class/logger/ConsoleWatchDog"],function(e,t){e["addWatchDog"](new t.ConsoleWatchDog)})}function o(){if(!window)return;t(),window["sharedBusWatch"]=n}e.attachDebugFn=o}(n||(n={})),n),s,r,n;if(t instanceof Function)return t;else for(var o in t)if(t.hasOwnProperty(o))e[o]=t[o];return e}();e["Browser/_Event/Server/_class/deliver/Page"]=true;var E=function(){"use strict";var e={},t=function(e,t){Object.defineProperty(t,"__esModule",{value:true});var r=function(){function e(e){this.notifier=e}return e.prototype.deliver=function(e,t,r){this.notifier.fire(e,t,r)},e.prototype.destroy=function(){},e}();t.Page=r}(p,e);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/Events"]=true;var _=function(){"use strict";var e={},t=function(e,t,r){Object.defineProperty(t,"__esModule",{value:true});var n="disableservereventbus",o="detectlatermain",i=function(){function e(e,t){if(void 0===t)t={};for(var r in this.bubbles=false,this.cancelBubble=false,this.cancelable=false,this.type=e,t)this[r]=t[r]}return e.prototype.composedPath=function(){return[]},e.prototype.initEvent=function(e,t,r){},e.prototype.preventDefault=function(){},e.prototype.stopImmediatePropagation=function(){},e.prototype.stopPropagation=function(){},e}(),s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t}(i);function a(t){try{return new Event(t)}catch(e){if("undefined"===typeof document)return new i(t);var r=document.createEvent("Event");return r.initEvent(t,false,false),r}}function c(t,e){if(void 0===e)e={};try{return new MessageEvent(t,e)}catch(e){if("undefined"===typeof document)return new s(t);var r=document.createEvent("MessageEvent");return r.initEvent(t,false,false),r}}t.create=a,t.createME=c,t.EVENT_DISABLE_SEB=a(n),t.EVENT_LATER_MAIN_TRANSPORT=a(o)}(p,e,s);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/logger/ConnectWatchDog"]=true;var w=function(){"use strict";var e={},t=function(e,t){Object.defineProperty(t,"__esModule",{value:true});var r=function(){function e(){}return e.prototype.logStomp=function(e){},e.prototype.logEvent=function(e,t,r){},e.prototype.logConnect=function(e){var t=e||{},r=t.connectOptions||{},n=r.getWebSocketUrl&&r.getWebSocketUrl()||"",o=t.transport||"";console.log("[STOMP][Connect]["+(new Date).toLocaleString()+"]","transport: "+o+"; url: "+n)},e.prototype.logDisconnect=function(e){console.log("[STOMP][Disconnect]["+(new Date).toLocaleString()+"]",e)},e}();t.ConnectWatchDog=r}(p,e);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Broadcast/Transport/LocalStorage"]=true;var g=function(){"use strict";var e={},t=function(e,t,r,n){Object.defineProperty(t,"__esModule",{value:true});var o="TabMessage",i={},s=function(){function e(e){var n=this;this.channel=e,this.storage=new r.LocalStorage(o,void 0,false),this.storage.subscribe("onChange",function(e,t,r){n.channel.notify(t,r)})}return e.prototype.notify=function(e,t){var r=this;if(this.storage.setItem(e,t),!n.detection.isIE)return this.storage.removeItem(e);if(i[e])clearTimeout(i[e]);i[e]=setTimeout(function(){r.storage.removeItem(e)},500)},e.prototype.destroy=function(){this.storage.destroy()},e}();t.LocalStorageTransport=s}(p,e,u,c);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Broadcast/Transport/BroadCast"]=true;var S=function(){"use strict";var e={},t=function(e,t,i,n){Object.defineProperty(t,"__esModule",{value:true});var r="TabMessage",s=Object.create(null),o=function(e){var t=e.data,r=t.message,n=i.utils.item.deserialize(t.data);for(var o in s)s[o](r,n)},a,c=function(){if(!a)(a=new BroadcastChannel(r)).addEventListener("message",o);return a},u=function(){function e(r){this.uid=n(),s[this.uid]=function(e,t){r.notify(e,t)}}return e.prototype.notify=function(e,t){c().postMessage({message:e,data:i.utils.item.serialize(t)})},e.prototype.destroy=function(){delete s[this.uid]},e}();t.BroadCastTransport=u}(p,e,u,a);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Broadcast/Transport/Fake"]=true;var C=function(){"use strict";var e={},t=function(e,t){Object.defineProperty(t,"__esModule",{value:true});var r=function(){function e(e){}return e.prototype.notify=function(e,t){},e.prototype.destroy=function(){},e}();t.FakeTransport=r}(p,e);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Broadcast/FakeMessage"]=true;var m=function(){"use strict";var e={},t=function(e,t){Object.defineProperty(t,"__esModule",{value:true});var r=function(){function e(){}return e.prototype.unsubscribe=function(){return this},e.prototype.subscribe=function(){return this},e.prototype.once=function(){return this},e.prototype.destroy=function(){},e.prototype.notify=function(){},e}();t.default=r}(p,e);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/logger/WatchDogAggregator"]=true;var O=function(){"use strict";var e={},t=function(e,t){Object.defineProperty(t,"__esModule",{value:true});var r=function(){function e(e){if(void 0===e)e=[];this.container=e}return e.prototype.reg=function(e){this.container.push(e)},e.prototype.logStomp=function(e){for(var t=0,r=this.container;t<r.length;t++){var n=r[t];try{n.logStomp(e)}catch(e){}}},e.prototype.logEvent=function(e,t,r){for(var n=0,o=this.container;n<o.length;n++){var i=o[n];try{i.logEvent(e,t,r)}catch(e){}}},e.prototype.logConnect=function(e){for(var t=0,r=this.container;t<r.length;t++){var n=r[t];try{if(!n["logConnect"])continue;n.logConnect(e)}catch(e){}}},e.prototype.logDisconnect=function(e){for(var t=0,r=this.container;t<r.length;t++){var n=r[t];try{if(!n["logDisconnect"])continue;n.logDisconnect(e)}catch(e){}}},e}();t.WatchDogAggregator=r}(p,e);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/Constants"]=true;var B=function(){"use strict";var e={},t=(r=p,n=e,i=o||(o={}),(a=s=i.CHANNEL_SCOPE||(i.CHANNEL_SCOPE={}))["GLOBAL"]="global",a["CLIENT"]="client",a["USER"]="user",i.DELIVERY_COMMON="common",i.DELIVERY_HOST="host",i.DELIVERY_EXCLUSIVE_PAGE="page",i.ERR_MSG_RABBIT_OFF="Can't create RabbitMQ channel",i.ERR_MSG_EMPTY_SID="sid not found",i.ERR_MSG_HASH_401="!hash not found",o),r,n,o,i,s,a;if(t instanceof Function)return t;else for(var c in t)if(t.hasOwnProperty(c))e[c]=t[c];return e}();e["Browser/_Event/Server/_class/creator/TransportConnect"]=true;var D=function(){"use strict";var e={},t=function(i,e){Object.defineProperty(e,"__esModule",{value:true});var t=function(){function o(e){if(void 0===e)e=false;this.connectWay=!e?this.byWebSocket:this.bySockjs}return o.prototype.getWebSocket=function(n,o){if(void 0===o)o=true;return new Promise(function(t,r){i(["Browser/_Event/Server/native/SockjsEmulator"],function(e){try{t(new e(n,void 0,o))}catch(e){r(e)}})})},o.prototype.getSockjs=function(n,o){return new Promise(function(e,t){try{var r;e(new n(o.replace("wss:","https:").replace("ws:","http:"),null,{transports:["xhr-streaming"],debug:function(){},stompLogger:function(){}}))}catch(e){return t(e)}})},o.prototype.requireStomp=function(){return new Promise(function(e){i(["Browser/_Event/Server/resources/stomp"],function(){e()})})},o.prototype.requireSockjs=function(){return new Promise(function(r,n){i(["Browser/_Event/Server/resources/stomp","Browser/_Event/Server/resources/sockjs-1.0.3"],function(e,t){if(!t)return n("Can't load Browser/_Event/Server/resources/sockjs-1.0.3");r(t)})})},o.prototype.byWebSocket=function(e,t){var r=this;return this.requireStomp().then(function(){return r.getWebSocket(e,t)})},o.prototype.bySockjs=function(t){var r=this;return this.requireSockjs().then(function(e){return r.getSockjs(e,t)})},o.prototype.initStomp=function(n){return new Promise(function(e,t){var r=Stomp.over(n);r.heartbeat.outgoing=o.STOMP_HEARTBEAT_OUT_TIME,r.heartbeat.incoming=o.STOMP_HEARTBEAT_IN_TIME,r.debug=function(){},r.connect(o.LOGIN,o.PASSWORD,function(){e(r)},function(e){t(e)})})},o.prototype.connect=function(e,t){return this.connectWay(e.getWebSocketUrl(),t).then(this.initStomp)},o.STOMP_HEARTBEAT_OUT_TIME=6e4,o.STOMP_HEARTBEAT_IN_TIME=0,o.LOGIN="stomp_user",o.PASSWORD="stomp_user",o}();e.TransportConnect=t}(p,e);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Broadcast/Message"]=true;var T=function(){"use strict";var e={},t=function(e,t,r,n,o,i,s,a,c){Object.defineProperty(t,"__esModule",{value:true});var u="TabMessage",f=function(){if(!n.constants.isBrowserPlatform)return a.FakeTransport;if("undefined"!==typeof BroadcastChannel)return s.BroadCastTransport;return i.LocalStorageTransport},h,l=function(){if(!h)h=f();return h},p=function(){function e(){this._channel=r.Bus.channel(u+"-"+o());var e=l();this._transport=new e(this._channel)}return e.prototype.destroy=function(){this._transport.destroy(),this._channel.unsubscribeAll(),this._channel.destroy()},e.prototype.subscribe=function(e,t){return this._channel.subscribe(e,t,this),this},e.prototype.once=function(e,t){return this._channel.once(e,t,this),this},e.prototype.unsubscribe=function(e,t){return this._channel.unsubscribe(e,t),this},e.prototype.notify=function(e,t){if(void 0==t)t=""+t;this._transport.notify(e,t)},e}(),v=n.constants.isBrowserPlatform?p:c.default;t.default=v}(p,e,f,h,a,g,S,C,m);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}(),t=T;e["Browser/_Event/Server/_class/SubscribeContainer"]=true;var P=function(){"use strict";var e={},t=function(e,t,r){Object.defineProperty(t,"__esModule",{value:true});var n=function(){function e(){this.common=new r.HashedCounter(false),this.channeled=new r.HashedCounter}return e.prototype.add=function(e){if(e.isChanneled())return this.channeled.add(e);this.common.add(e)},e.prototype.remove=function(e){if(e.isChanneled())return this.channeled.remove(e);this.common.remove(e)},e.prototype.has=function(e){return this.common.has(e)||this.channeled.has(e)},e.prototype.all=function(){return this.common.getSubscribes().concat(this.channeled.getSubscribes())},e.prototype.clear=function(){this.common.clear(),this.channeled.clear()},e.prototype.removeByName=function(e){for(var t=this.common.getByName(e),r=this.channeled.getByName(e),n=0,o=t;n<o.length;n++){var i=o[n];this.common.remove(i)}for(var s=0,a=r;s<a.length;s++){var i=a[s];this.channeled.remove(i)}return t.concat(r)},e.prototype.hasCommon=function(){return this.common.getSubscribes().length>0},e.prototype.hasChanneled=function(){return this.channeled.getSubscribes().length>0},e}();t.SubscribeContainer=n}(p,e,v);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/ConnectOptions"]=true;var M=function(){"use strict";var e={},t=function(e,t,r){Object.defineProperty(t,"__esModule",{value:true});var n=function(){function a(e,t,r,n,o,i,s,a,c){if(void 0===s)s=null;if(void 0===a)a=null;if(void 0===c)c=false;this.sid=e,this.hash=t,this.protocol=r,this.domain=n,this.stompPath=o,this.exchange=i,this.cid=s,this.uid=a,this.__isDesktop=c}return a.prototype.getUrl=function(){return this.protocol+"//"+this.domain+this.stompPath+"s-"+this.sid+"/info?t="+(new Date).valueOf()},a.prototype.isDesktop=function(){return this.__isDesktop},a.prototype.getWebSocketUrl=function(){var e;return("http:"===this.protocol?"ws:":"wss:")+"//"+this.domain+this.stompPath+"s-"+this.sid+"/"},a.prototype.getStompPath=function(){return this.stompPath},a.prototype.getUid=function(e){switch(e){case r.CHANNEL_SCOPE.CLIENT:return this.cid;case r.CHANNEL_SCOPE.USER:return this.uid;case r.CHANNEL_SCOPE.GLOBAL:default:return null}},a.createForDesktop=function(e,t,r,n,o){if(void 0===n)n=null;if(void 0===o)o=null;var i=r.indexOf("https://")>-1?"https:":"http:",s=r.replace("https://","").replace("http://","");return new a(e,t,i,s,"/stomp/",s,n,o,true)},a.createByLocation=function(e,t,r,n,o){if(void 0===n)n=null;if(void 0===o)o=null;var i="stomp-";if(location.host.split(".").length<3)i="stomp.";return new a(e,t,location.protocol,""+i+location.host,r,location.hostname,n,o)},a}();t.ConnectOptions=n}(p,e,B);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/RabbitEnv"]=true;var k=function(){"use strict";var e={},t=function(e,t,i,s,o,a){Object.defineProperty(t,"__esModule",{value:true});var c=2*1e3,r=function(){function e(e){this.watcher=e}return e.prototype.up=function(t){var r=this,n=new s,o=Date.now();return this.tryCreateChannel(t).addCallback(function(e){if(Date.now()-o>c)i.IoC.resolve("ILogger").warn("[STOMP][timeout] /!info request to long: "+(Date.now()-o)+"ms");n.callback(e)}).addErrback(function(e){if(e.message==a.ERR_MSG_RABBIT_OFF)return void n.errback(e);setTimeout(function(){r.up(t).addCallback(function(e){n.callback(e)})},5e3)}),n},e.prototype.tryCreateChannel=function(t){var r=this,n=t.getUrl();return new o.XHR({url:n,method:"GET",dataType:"json"}).execute().addCallback(function(e){if(!e.websocket)return new Error(a.ERR_MSG_RABBIT_OFF);return t.hash}).addErrback(function(e){return r.watcher.logConnect({message:"error get info",url:n,err:e}),e})},e}();t.RabbitEnv=r}(p,e,c,l,i,B);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/creator/CreatorWebSocket"]=true;var N=function(){"use strict";var e={},t=function(i,e,t,n,o,s,a){Object.defineProperty(e,"__esModule",{value:true});var r=function(){function e(e,t){if(void 0===t)t=new s.TransportConnect;this.connectOptions=e,this.transportConnect=t,this.ls=new o.LocalStorage("SEB");var r=n.get("ЛогинПользователя")||"";this.isGuestAccess=r.indexOf("__сбис__гость__")>-1}return e.prototype.isAvailableInEnv=function(e){if(e)return false;return!this.connectOptions.isDesktop()&&!t.detection.isMobileIOS},e.prototype.build=function(t){var r=this;return this.chooseTransportConstructor().then(function(e){return r.createTransport(e,t)})},e.prototype.createTransport=function(t,r){var n=this;if("LocalSlaveTransport"===t.getLocalName())return Promise.resolve(new t);return this.transportConnect.connect(this.connectOptions,true).then(function(e){return new t(e,r,!n.isGuestAccess,n.connectOptions.exchange)})},e.prototype.chooseTransportConstructor=function(){var n=this,o=this.ls.getItem(a.KEY_ACTUAL_DATE);return new Promise(function(t,r){if(!o)return t(n.loadMainTransport());var e=new Date(o+2*a.CHECK_MIN_INTERVAL);if(e<new Date||isNaN(e.valueOf()))return t(n.loadMainTransport());i(["Browser/_Event/Server/_class/transport/LocalSlaveTransport"],function(e){if(!e.LocalSlaveTransport)return r(new Error("Browser/_Event/Server/_class/transport/LocalSlaveTransport not found"));t(e.LocalSlaveTransport)})})},e.prototype.loadMainTransport=function(){return new Promise(function(t,r){i(["Browser/_Event/Server/_class/transport/LocalMainTransport"],function(e){if(!e.LocalMainTransport)return r(new Error("Browser/_Event/Server/_class/transport/LocalMainTransport not found"));t(e.LocalMainTransport)})})},e}();e.CreatorWebSocket=r}(p,e,c,o,u,D,b);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/Notifier"]=true;var I=function(){"use strict";var e={},t=function(e,t,o,i,r){var n,s;Object.defineProperty(t,"__esModule",{value:true}),(s=n||(n={}))["READY"]="onready",s["DISCONNECT"]="ondisconnect";var a=function(){function e(e){if(this.watcher=e,this.readyStatuses={},!e)this.watcher=new r.WatchDogAggregator}return e.prototype.setWatcher=function(e){this.watcher=e},e.prototype.fire=function(e,t,r){if(this.isSkip(e,t))return;var n;if(r)n=i(r);this.watcher.logEvent(e,t,n),o.Bus.channel(e).notify(t,n,r)},e.prototype.isSkip=function(e,t){if(t!==n.READY&&t!==n.DISCONNECT)return false;if(t===n.READY&&this.readyStatuses[e])return true;if(t===n.READY)this.readyStatuses[e]=true,o.Bus.channel(e).setEventQueueSize(n.READY,1);if(t===n.DISCONNECT)this.readyStatuses[e]=false,o.Bus.channel(e).setEventQueueSize(n.READY,0);return false},e}();t.Notifier=a}(p,e,f,d,O);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/creator/CreatorExclusive"]=true;var L=function(){"use strict";var e={},t=function(n,e,t,r){Object.defineProperty(e,"__esModule",{value:true});var o=function(){function e(e,t){if(void 0===t)t=new r.TransportConnect;this.connectOptions=e,this.transportConnect=t}return e.prototype.isAvailableInEnv=function(e){return e||this.connectOptions.isDesktop()||t.detection.isMobileIOS},e.prototype.build=function(t){var r=this;return new Promise(function(r,e){n(["Browser/_Event/Server/_class/transport/LocalPageTransport"],function(e){var t=e.LocalPageTransport;r(t)})}).then(function(e){return r.createTransport(e,t)})},e.prototype.createTransport=function(t,r){var n=this;return this.transportConnect.connect(this.connectOptions,false).then(function(e){return new t(e,r,false,n.connectOptions.exchange)})},e}();e.CreatorExclusive=o}(p,e,c,D);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/Subscribe"]=true;var R=function(){"use strict";var e={},t=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:true});var n=function(){function e(e,t){this.channelName=e,this.type=t}return e.prototype.hash=function(){var e=this.isChanneled()?"ch":"cm";return this.channelName+"::"+e+"::"+this.getDeliveryType()},e.prototype.getDeliveryType=function(){return this.type},e.prototype.getChannelName=function(){return this.channelName},e.create=function(e,t,r,n){if(void 0===t)t=false;if(void 0===r)r=false;if(void 0===n)n=null;var o=r?i.DELIVERY_EXCLUSIVE_PAGE:i.DELIVERY_COMMON;if(!t)return new s(e,o);return new a(e,o,n)},e.createRaw=function(e,t,r,n){if(void 0===t)t=false;if(void 0===r)r=false;if(void 0===n)n=null;var o=r?i.DELIVERY_EXCLUSIVE_PAGE:i.DELIVERY_COMMON;if(!t)return new s(e,o);return new c(e,o,n)},e}(),s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.channeled=false,e}return r.__extends(e,t),e.prototype.isChanneled=function(){return false},e}(t.Subscribe=n);t.CommonSubscribe=s;var a=function(o){function e(e,t,r){if(void 0===r)r=null;var n=o.call(this,e,t)||this;return n.target=r,n.channeled=true,n}return r.__extends(e,o),e.prototype.isChanneled=function(){return true},e.prototype.hash=function(){return o.prototype.hash.call(this)+"::"+this.target},e.prototype.getTarget=function(){return this.target},e}(n);t.ChanneledSubscribe=a;var c=function(o){function e(e,t,r){if(void 0===r)r=null;var n=o.call(this,e,t)||this;return n.scope=r,n}return r.__extends(e,o),e.prototype.isChanneled=function(){return true},e.prototype.hash=function(){return o.prototype.hash.call(this)+"::"+this.scope},e.prototype.getScope=function(){return this.scope},e}(n);t.RawChanneledSubscribe=c}(p,e,s,B);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/DeviceEnv"]=true;var A=function(){"use strict";var e={},t=function(e,t,i,s,a,c,u){function f(){var e;return document.cookie.split("; ").filter(function(e){return"sid="==e.substr(0,4)}).map(function(e){return e.substr(4)}).pop()}Object.defineProperty(t,"__esModule",{value:true});var h=2*1e3,l=6e4,p=1e4,r=function(){function o(){}return o.getConnectData=function(t){if(!t)t=Math.round(Math.random()*p);if(t>l)t=l;var r=new i,n=Date.now();return new a.XHR({url:"/!hash/",method:"GET",dataType:"json"}).execute().addCallback(function(e){if(Date.now()-n>h)s.IoC.resolve("ILogger").warn("[STOMP][timeout] /!hash/ request to long: "+(Date.now()-n)+"ms");r.callback(e.result)}).addErrback(function(e){if(404===e.httpError)return void r.errback(e);if(0===e.httpError)t=p;setTimeout(function(){o.getConnectData(t+Math.round(1e4*Math.random())).addCallback(function(e){r.callback(e)})},t)}),r},o.getOptions=function(){var s=new i;return o.getConnectData().addCallbacks(function(e){var t=e.sid;if(!t)t=f();if(!t)throw new Error(c.ERR_MSG_EMPTY_SID);if(!e.user)return new Error(c.ERR_MSG_HASH_401);var r=e.cid;if(!r)r=t.substr(0,8);var n=e.uid,o;if(!n)n=t.substr(9,8);if(!!e.url)o=u.ConnectOptions.createForDesktop(t,e.user,e.url,r,n);var i="/stomp/";if(!!e.path)i=e.path;if(e.domain)o=new u.ConnectOptions(t,e.user,location.protocol,e.domain,i,e.exchange,r,n);if(!o)o=u.ConnectOptions.createByLocation(t,e.user,i,r,n);s.callback(o)},function(e){s.errback(e)}),s},o}();t.DeviceEnv=r}(p,e,l,c,i,B,M);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/creator/CreatorExclusiveSockJs"]=true;var x=function(){"use strict";var e={},t=function(e,t,r,n,o){Object.defineProperty(t,"__esModule",{value:true});var i=function(n){function e(e){var t=this,r=true;return t=n.call(this,e,new o.TransportConnect(r))||this}return r.__extends(e,n),e}(n.CreatorExclusive);t.CreatorExclusiveSockJs=i}(p,e,s,L,D);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/creator/CreatorSockJs"]=true;var F=function(){"use strict";var e={},t=function(e,t,r,n,o){Object.defineProperty(t,"__esModule",{value:true});var i=function(n){function e(e){var t=this,r=true;return t=n.call(this,e,new o.TransportConnect(r))||this}return r.__extends(e,n),e}(n.CreatorWebSocket);t.CreatorSockJs=i}(p,e,s,N,D);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/deliver/Browser"]=true;var j=function(){"use strict";var e={},t=function(e,t,r){Object.defineProperty(t,"__esModule",{value:true});var n=function(){function n(e){this.notifier=e,this.onmessageHandler=this.onmessageHandler.bind(this),this.taber=new r.default,this.taber.subscribe(n.ON_MESSAGE,this.onmessageHandler)}return n.prototype.onmessageHandler=function(e,t){this.notifier.fire(t.channelName,t.eventName,t.rawData)},n.prototype.deliver=function(e,t,r){this.notifier.fire(e,t,r),this.taber.notify(n.ON_MESSAGE,{channelName:e,eventName:t,rawData:r})},n.prototype.destroy=function(){this.taber.unsubscribe(n.ON_MESSAGE,this.onmessageHandler)},n.ON_MESSAGE="servereventbus_onmessage",n}();t.Browser=n}(p,e,T);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/deliver/DeliveryChooser"]=true;var W=function(){"use strict";var e={},t=function(n,e,o,i,t,s,a){Object.defineProperty(e,"__esModule",{value:true});var c=new t.Notifier,r=function(){function e(e){this.watcher=e,c.setWatcher(e)}return e.prototype.choose=function(e){if("WorkerTransport"===e.getLocalName()||i.detection.isMobileIOS)return o.success(new a.Page(c));var t=a.Page,r;if("LocalPageTransport"!==e.getLocalName())t=s.Browser;if(i.detection.isMobileAndroid&&"undefined"!==typeof Promise&&"undefined"!==typeof indexedDB&&null!==indexedDB)return this.tryLazyIndexedDb().addErrback(function(){return new t(c)});return o.success(new t(c))},e.prototype.tryLazyIndexedDb=function(){var t=new o,r;return n(["Browser/_Event/Server/_class/deliver/IndexedDB"],function(e){if(!e)return t.errback();try{r=setTimeout(function(){t.errback("Timeout crete indexedDB")},3e3),t.dependOn(e.IndexedDB.create(c))}catch(e){t.errback(e)}}),t.addCallback(function(e){return clearTimeout(r),e}),t},e}();e.DeliveryChooser=r}(p,e,l,c,I,j,E);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/transport/TransportChooser"]=true;var H=function(){"use strict";var e={},t=function(e,t,s,u,r,f,h,l,p,v){Object.defineProperty(t,"__esModule",{value:true});var n=function(){function e(e,t,r,n){if(void 0===t)t=function(e){return e};if(void 0===r)r=false;if(void 0===n)n=new u.WatchDogAggregator;this.connectOptions=e,this.onclose=t,this.isExclusive=r,this.watcher=n,this.builders=[],this.deliveryChooser=new v.DeliveryChooser(n);for(var o,i=0,s=[f.CreatorWebSocket,h.CreatorSockJs,l.CreatorExclusive,p.CreatorExclusiveSockJs];i<s.length;i++){var a,c=new(0,s[i])(this.connectOptions);if(!c.isAvailableInEnv(this.isExclusive))continue;this.builders.push(c)}}return e.prototype.destructor=function(){var t=this;this.defStrategy&&this.defStrategy.addCallback(function(e){t.watcher&&t.watcher.logDisconnect("Manual disconnect"),e.close()})},e.prototype.choose=function(){var r=this;if(this.defStrategy)return this.defStrategy.createDependent();return this.defStrategy=this.build(),this.defStrategy.addCallback(function(t){return t.setDisconnectHandler(function(e){r.defStrategy=void 0,r.onclose(e)}),t.setWatchDog(r.watcher),r.deliveryChooser.choose(t).addCallback(function(e){return t.setDelivery(e),t})}),this.defStrategy.createDependent()},e.prototype.build=function(){var t=this,e;return new r.RabbitEnv(this.watcher).up(this.connectOptions).addCallback(function(e){return t.createTransport(e)})},e.prototype.createTransport=function(t){for(var r=new s,e=function(e){r.addErrback(function(){return s.fromPromise(e.build(t))})},n=0,o=this.builders;n<o.length;n++){var i;e(o[n])}return r.addErrback(function(e){return new Error("No one server event bus transport choice.")}),r.errback(),r},e}();t.TransportChooser=n}(p,e,l,O,k,N,F,L,x,W);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/_class/transport/ExclusiveProxy"]=true;var G=function(){"use strict";var e={},t=function(e,t,a,c,r,u,f,n,h){Object.defineProperty(t,"__esModule",{value:true});var o=function(){function e(){this.message="Need subscribe connect to subscribe",this.name="SubscribeExclusiveError"}return e}(),i=function(){function s(e,t,r){this.transport=e,this.isExclusive=t,this.options=r}return s.init=function(t,r,n){if(void 0===t)t=false;var o=new a,i;return u.DeviceEnv.getOptions().addCallback(function(e){return i=e,new f.TransportChooser(e,r,t,n).choose()}).addCallback(function(e){try{if(h.attachDebugFn(),n.logConnect({connectOptions:i,transport:e.constructor.getLocalName()}),window&&"true"===c.LocalStorageNative.getItem("shared-bus-debug"))window["sharedBusWatch"]()}catch(e){}o.callback(new s(e,t,i))}).addErrback(function(e){return o.errback(e),e}),o},s.prototype.subscribe=function(e){if(e.getDeliveryType()!==r.DELIVERY_COMMON&&!this.isExclusive)throw new o;if(e instanceof n.RawChanneledSubscribe)return void this.transport.subscribe(n.Subscribe.create(e.getChannelName(),e.isChanneled(),this.isExclusive,this.options.getUid(e.getScope())));this.transport.subscribe(e)},s.prototype.unsubscribe=function(e){if(e instanceof n.RawChanneledSubscribe)return void this.transport.unsubscribe(n.Subscribe.create(e.getChannelName(),e.isChanneled(),this.isExclusive,this.options.getUid(e.getScope())));this.transport.unsubscribe(e)},s.prototype.setDelivery=function(e){this.transport.setDelivery(e)},s.prototype.close=function(){this.transport.close(),this.transport=void 0},s.prototype.setWatchDog=function(e){this.transport.setWatchDog(e)},s}();t.ExclusiveProxy=i}(p,e,l,u,B,A,H,R,y);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Event/Server/Bus"]=true;var r,U=function(){"use strict";var e={},t=function(e,t,o,r,n,i,s,a,c,u,f,h,l,p){Object.defineProperty(t,"__esModule",{value:true}),i.LocalStorageNative.setItem("shared-bus-ack","true");var v=[a.CHANNEL_SCOPE.GLOBAL],d=function(){function e(e){if(void 0===e)e="Это приложение не имеет серверных событий";this.message=e}return e}(),b,y=new(function(){function e(){this.subscribes=new f.SubscribeContainer,this.isExclusive=false,this.watcher=new c.WatchDogAggregator([new p.ConnectWatchDog]),this.subsDeferred=new o,this.subscribe=this.subscribeInit.bind(this),this.closeChannel=this.closeChannel.bind(this),this.closeTransportBehavior=this.closeTransportBehavior.bind(this)}return e.prototype.subscribe=function(e){},e.prototype.subscribeClear=function(e,t){if(this.subscribes.has(t))return;this.subscribes.add(t);try{e.subscribe(t)}catch(e){if("SubscribeExclusiveError"!==e.name)throw e;this.isExclusive=true,this.reconnect()}},e.prototype.subscribeBeforeReconnect=function(e){if(this.subscribes.has(e))return;this.subscribes.add(e)},e.prototype.subscribeDeferred=function(t){var r=this;this.subsDeferred.addCallback(function(e){return r.subscribeClear(e,t),e})},e.prototype.subscribeInit=function(r){var n=this;this.subscribe=this.subscribeDeferred,this.subscribeDeferred(r);try{h.ExclusiveProxy.init(this.isExclusive||r.getDeliveryType()!==a.DELIVERY_COMMON,this.closeTransportBehavior,this.watcher).addCallback(function(e){n.subscribe=n.subscribeClear.bind(n,e),n.subsDeferred.callback(e)}).addErrback(function(e){if(404===e.httpError)return s.IoC.resolve("ILogger").warn((new d).message),void(n.subscribe=function(){});n.subscribe=n.subscribeInit;var t=n.subsDeferred;n.subsDeferred=new o,t.dependOn(n.subsDeferred),s.IoC.resolve("ILogger").warn("Не удалось подписаться на "+r.getChannelName())})}catch(e){this.subscribe=function(){}}},e.prototype.addWatchDog=function(e){this.watcher.reg(e)},e.prototype.closeTransportBehavior=function(e){if(this.watcher.logDisconnect(e),e===l.EVENT_DISABLE_SEB)return;this.reInit()},e.prototype.reInit=function(){this.subsDeferred=new o,this.subscribe=this.subscribeInit;var e=this.subscribes.all();this.subscribes.clear();for(var t=0,r=e;t<r.length;t++){var n=r[t];this.subscribe(n)}},e.prototype.reconnect=function(){var t=this;if(!this.subsDeferred)return this.reInit();this.subsDeferred.addCallbacks(function(e){return t.subscribe=t.subscribeBeforeReconnect.bind(t),e.close(),e},function(){t.reInit()})},e.prototype.closeChannel=function(i){var s=this;this.subsDeferred.addCallback(function(e){for(var t,r=0,n=s.subscribes.removeByName(i);r<n.length;r++){var o=n[r];e.unsubscribe(o)}return e})},e}());function E(e,t){var o=e.toLocaleLowerCase(),r=n.Bus.channel(o),i=t||{};return setTimeout(function(){if(!i.isChanneled)return void y.subscribe(u.Subscribe.create(o,i.isChanneled,i.exclusive));if(!i.scopes)s.IoC.resolve("ILogger").error("В канализированных событиях необходимо указать options.scopes.             https://wi.sbis.ru/docs/js/Browser/_Event/Server/Bus/typedefs/ConnectOptions/?v=3.18.10");for(var e,t=0,r=i.scopes||v;t<r.length;t++){var n=r[t];y.subscribe(u.Subscribe.createRaw(o,i.isChanneled,i.exclusive,n))}},0),r}if(E["reconnect"]=function(){y.reconnect()},E["close"]=function(e){y.closeChannel(e)},E["SCOPE"]=a.CHANNEL_SCOPE,n.Bus["addWatchDog"]=function(e){y.addWatchDog(e)},r.constants.isBrowserPlatform)n.Bus["serverChannel"]=E;else n.Bus["serverChannel"]=function(e){return n.Bus.channel(e)};t.default=n.Bus}(p,e,l,h,f,u,c,B,O,R,P,G,_,w);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();return e.Server=U.default,e.Broadcast=t.default,e});