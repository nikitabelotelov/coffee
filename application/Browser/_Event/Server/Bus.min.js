define("Browser/_Event/Server/Bus",["require","exports","Core/Deferred","Env/Constants","Env/Event","Browser/Storage","Env/Env","Browser/_Event/Server/_class/Constants","Browser/_Event/Server/_class/logger/WatchDogAggregator","Browser/_Event/Server/_class/Subscribe","Browser/_Event/Server/_class/SubscribeContainer","Browser/_Event/Server/_class/transport/ExclusiveProxy","Browser/_Event/Server/_class/Events","Browser/_Event/Server/_class/logger/ConnectWatchDog"],function(e,s,n,r,t,i,o,c,u,a,b,h,l,f){"use strict";Object.defineProperty(s,"__esModule",{value:true}),i.LocalStorageNative.setItem("shared-bus-ack","true");var v=[c.CHANNEL_SCOPE.GLOBAL],d=function(){function e(e){if(void 0===e)e="Это приложение не имеет серверных событий";this.message=e}return e}(),p,C=new(function(){function e(){this.subscribes=new b.SubscribeContainer,this.isExclusive=false,this.watcher=new u.WatchDogAggregator([new f.ConnectWatchDog]),this.subsDeferred=new n,this.subscribe=this.subscribeInit.bind(this),this.closeChannel=this.closeChannel.bind(this),this.closeTransportBehavior=this.closeTransportBehavior.bind(this)}return e.prototype.subscribe=function(e){},e.prototype.subscribeClear=function(e,s){if(this.subscribes.has(s))return;this.subscribes.add(s);try{e.subscribe(s)}catch(e){if("SubscribeExclusiveError"!==e.name)throw e;this.isExclusive=true,this.reconnect()}},e.prototype.subscribeBeforeReconnect=function(e){if(this.subscribes.has(e))return;this.subscribes.add(e)},e.prototype.subscribeDeferred=function(s){var r=this;this.subsDeferred.addCallback(function(e){return r.subscribeClear(e,s),e})},e.prototype.subscribeInit=function(r){var t=this;this.subscribe=this.subscribeDeferred,this.subscribeDeferred(r);try{h.ExclusiveProxy.init(this.isExclusive||r.getDeliveryType()!==c.DELIVERY_COMMON,this.closeTransportBehavior,this.watcher).addCallback(function(e){t.subscribe=t.subscribeClear.bind(t,e),t.subsDeferred.callback(e)}).addErrback(function(e){if(404===e.httpError)return o.IoC.resolve("ILogger").warn((new d).message),void(t.subscribe=function(){});t.subscribe=t.subscribeInit;var s=t.subsDeferred;t.subsDeferred=new n,s.dependOn(t.subsDeferred),o.IoC.resolve("ILogger").warn("Не удалось подписаться на "+r.getChannelName())})}catch(e){this.subscribe=function(){}}},e.prototype.addWatchDog=function(e){this.watcher.reg(e)},e.prototype.closeTransportBehavior=function(e){if(this.watcher.logDisconnect(e),e===l.EVENT_DISABLE_SEB)return;this.reInit()},e.prototype.reInit=function(){this.subsDeferred=new n,this.subscribe=this.subscribeInit;var e=this.subscribes.all();this.subscribes.clear();for(var s=0,r=e;s<r.length;s++){var t=r[s];this.subscribe(t)}},e.prototype.reconnect=function(){var s=this;if(!this.subsDeferred)return this.reInit();this.subsDeferred.addCallbacks(function(e){return s.subscribe=s.subscribeBeforeReconnect.bind(s),e.close(),e},function(){s.reInit()})},e.prototype.closeChannel=function(i){var o=this;this.subsDeferred.addCallback(function(e){for(var s,r=0,t=o.subscribes.removeByName(i);r<t.length;r++){var n=t[r];e.unsubscribe(n)}return e})},e}());function E(e,s){var n=e.toLocaleLowerCase(),r=t.Bus.channel(n),i=s||{};return setTimeout(function(){if(!i.isChanneled)return void C.subscribe(a.Subscribe.create(n,i.isChanneled,i.exclusive));if(!i.scopes)o.IoC.resolve("ILogger").error("В канализированных событиях необходимо указать options.scopes.             https://wi.sbis.ru/docs/js/Browser/_Event/Server/Bus/typedefs/ConnectOptions/?v=3.18.10");for(var e,s=0,r=i.scopes||v;s<r.length;s++){var t=r[s];C.subscribe(a.Subscribe.createRaw(n,i.isChanneled,i.exclusive,t))}},0),r}if(E["reconnect"]=function(){C.reconnect()},E["close"]=function(e){C.closeChannel(e)},E["SCOPE"]=c.CHANNEL_SCOPE,t.Bus["addWatchDog"]=function(e){C.addWatchDog(e)},r.constants.isBrowserPlatform)t.Bus["serverChannel"]=E;else t.Bus["serverChannel"]=function(e){return t.Bus.channel(e)};s.default=t.Bus});