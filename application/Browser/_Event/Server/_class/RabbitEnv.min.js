define("Browser/_Event/Server/_class/RabbitEnv",["require","exports","Env/Env","Core/Deferred","Browser/Transport","Browser/_Event/Server/_class/Constants"],function(e,r,a,u,o,c){"use strict";Object.defineProperty(r,"__esModule",{value:true});var i=2*1e3,t=function(){function e(e){this.watcher=e}return e.prototype.up=function(r){var t=this,n=new u,o=Date.now();return this.tryCreateChannel(r).addCallback(function(e){if(Date.now()-o>i)a.IoC.resolve("ILogger").warn("[STOMP][timeout] /!info request to long: "+(Date.now()-o)+"ms");n.callback(e)}).addErrback(function(e){if(e.message==c.ERR_MSG_RABBIT_OFF)return void n.errback(e);setTimeout(function(){t.up(r).addCallback(function(e){n.callback(e)})},5e3)}),n},e.prototype.tryCreateChannel=function(r){var t=this,n=r.getUrl();return new o.XHR({url:n,method:"GET",dataType:"json"}).execute().addCallback(function(e){if(!e.websocket)return new Error(c.ERR_MSG_RABBIT_OFF);return r.hash}).addErrback(function(e){return t.watcher.logConnect({message:"error get info",url:n,err:e}),e})},e}();r.RabbitEnv=t});