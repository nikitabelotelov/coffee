define("Browser/_Event/Server/_class/transport/LocalPageTransport",["require","exports","tslib","Core/Deferred","Env/Env","Browser/Storage","Browser/_Event/Server/_class/transport/Transport","Browser/_Event/Server/_class/SubscribeContainer","Browser/_Event/Server/native/AckSender","Browser/_Event/Server/native/_IndexedDB/Connector","Browser/_Event/Server/native/_IndexedDB/AdapterStomp"],function(e,t,r,c,h,d,s,l,u,p,f){"use strict";function n(e,t,r,s){var n;return t+"-"+r+"-"+e+(s?"-"+s:"")}Object.defineProperty(t,"__esModule",{value:true});var i=function(a){function o(e,t,r,s,n){if(void 0===r)r=true;if(void 0===n)n=false;var i=a.call(this)||this;if(i.stomp=e,i.hash=t,i.persistent=r,i.exchangeName=s,i.isAck=n,i.subscribes=new l.SubscribeContainer,i.onclose=function(){},i.hasCommon=false,i.guid=d.LocalStorageNative.getItem("SEB.GUID"),!i.guid)i.guid=o.generateGUID(),d.LocalStorageNative.setItem("SEB.GUID",i.guid);if(!r)i.guid=i.guid+Math.floor(1e4*Math.random());if(i.ackSender=u.AckSender.createAckSender(n),i.ackSender.start(),i.closeWsHandler=function(e){i.onclose(e)},e.ws.addEventListener("close",i.closeWsHandler),i.eventStore=c.fail(),!h.detection.isMobilePlatform&&!h.detection.safari)i.eventStore=p.Connector.connect(p.Connector.DB_DEBUG,p.Connector.DEBUG_STORE_NAME,new f.AdapterStomp).addCallback(function(e){return e.createWriter()});return i}return r.__extends(o,a),o.getLocalName=function(){return"LocalPageTransport"},o.prototype.getLocalName=function(){return o.getLocalName()},o.prototype.messageHandler=function(t){a.prototype.messageHandler.call(this,t),this.ackSender.push(t),this.eventStore.addCallback(function(e){return e.write(t),e})},o.prototype.subscribe=function(e){if(e.isChanneled())return this.subscribeChanneled(e);if(!this.hasCommon)this.hasCommon=true,this.stomp.subscribe("/exchange/"+this.exchangeName+":"+this.hash,this.messageHandler,this.createHeader());this.subscribes.add(e),this.delivery.deliver(e.getChannelName(),"onready")},o.prototype.subscribeChanneled=function(e){if(this.subscribes.has(e))return this.subscribes.add(e),void this.delivery.deliver(e.getChannelName(),"onready");this.subscribes.add(e);var t=e.getChannelName(),r;if(null!==e.getTarget())t=(r=e.getTarget())+"$"+e.getChannelName();this.stomp.subscribe("/exchange/"+this.exchangeName+".channel/"+t,this.messageHandler,this.createChanneledHeader(e,r)),this.delivery.deliver(e.getChannelName(),"onready")},o.prototype.unsubscribe=function(e){if(this.subscribes.remove(e),!e.isChanneled())return;if(this.subscribes.has(e))return;var t=e.getTarget();this.stomp.unsubscribe(n(e.getChannelName(),this.guid,this.hash,t)),this.delivery.deliver(e.getChannelName(),"ondisconnect")},o.prototype.destructor=function(){if(this.callDisconnect(),a.prototype.destructor.call(this),this.ackSender.stop(),this.eventStore.addCallback(function(e){return e.destructor(),e}),this.stomp.ws.removeEventListener("close",this.closeWsHandler),3==this.stomp.ws.readyState||2==this.stomp.ws.readyState)return;this.stomp.ws.close(1e3)},o.prototype.setDisconnectHandler=function(t){var r=this;this.onclose=function(e){r.destructor(),t(e)}},o.prototype.close=function(){this.destructor()},o.prototype.callDisconnect=function(){var t=this,e=function(e){t.delivery.deliver(e.getChannelName(),"ondisconnect")};this.subscribes.all().forEach(e)},o.prototype.createHeader=function(){var e={receipt:this.hash,id:this.guid+"-"+this.hash,persistent:this.persistent,"auto-delete":!this.persistent};if(this.isAck)e["prefetch-count"]=10,e["ack"]="client";return e},o.prototype.createChanneledHeader=function(e,t){var r=n(e.getChannelName(),this.guid,this.hash,t),s={receipt:this.hash,id:r,persistent:this.persistent,"auto-delete":!this.persistent};if(this.isAck)s["prefetch-count"]=10,s["ack"]="client";return s},o.generateGUID=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},o}(s.Transport);t.LocalPageTransport=i});