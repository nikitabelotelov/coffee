define("Browser/_Event/Server/_class/transport/LocalMainTransport",["require","exports","Core/UserInfo","Browser/Event","Browser/Storage","Browser/_Event/Server/_class/transport/Constants","Browser/_Event/Server/_class/transport/LocalPageTransport","Browser/_Event/Server/_class/Subscribe","Browser/_Event/Server/_class/Events"],function(t,e,o,c,u,b,h,l,E){"use strict";Object.defineProperty(e,"__esModule",{value:true});var s=function(){function t(t,e,s,r){if(void 0===s)s=true;var n=this;this.stomp=t,this.hash=e,this.persistent=s,this.exchangeName=r,this.ls=new u.LocalStorage(b.LS_PREFIX),this.taber=new c.Broadcast,this.isAloneMain=true,this.fixMain();var i=Date.now();this.taber.notify(b.KEY_MAINREADY,i),this.fnQuit=function(t,e){if(e<i)return;n.taber.unsubscribe(b.KEY_MAINREADY,n.fnQuit),n.isAloneMain=false,n.close(E.EVENT_LATER_MAIN_TRANSPORT)},this.taber.subscribe(b.KEY_MAINREADY,this.fnQuit),this.taber.subscribe(b.KEY_NEW_PAGE,function(t){if(!o.isValid())n.fnQuit(t,new Date)}),this.ls.removeItem(b.KEY_TRY_CREATE_MAIN),this.mainChecker=setInterval(function(){n.fixMain()},b.CHECK_MIN_INTERVAL);var a="true"===u.LocalStorageNative.getItem("shared-bus-ack");this.transport=new h.LocalPageTransport(t,e,s,r,a),this.subFromTaber=function(t,e){n.subscribe(l.Subscribe.create(e.channelName,e.channeled,false,e.target))},this.unsubFromTaber=function(t,e){n.unsubscribe(l.Subscribe.create(e.channelName,e.channeled,false,e.target))},this.taber.subscribe(b.KEY_SUBSCRIBE,this.subFromTaber),this.taber.subscribe(b.KEY_UNSUBSCRIBE,this.unsubFromTaber),window&&window.addEventListener("unload",function(){n.close(E.EVENT_DISABLE_SEB)})}return t.prototype.fixMain=function(){this.ls.setItem(b.KEY_ACTUAL_DATE,Date.now())},t.getLocalName=function(){return"LocalMainTransport"},t.prototype.getLocalName=function(){return t.getLocalName()},t.prototype.subscribe=function(t){this.transport.subscribe(t)},t.prototype.unsubscribe=function(t){this.transport.unsubscribe(t)},t.prototype.destructor=function(t){if(this.taber)this.taber.unsubscribe(b.KEY_SUBSCRIBE,this.subFromTaber),this.taber.unsubscribe(b.KEY_UNSUBSCRIBE,this.unsubFromTaber),this.taber.unsubscribe(b.KEY_MAINREADY,this.fnQuit),this.taber=void 0;if(this.isAloneMain)this.ls.removeItem(b.KEY_ACTUAL_DATE);clearInterval(this.mainChecker);var e=this.disconnectCallback;if(this.disconnectCallback=function(){},!e)return;e(t)},t.prototype.setDisconnectHandler=function(t){var e=this;this.disconnectCallback=t,this.transport.setDisconnectHandler(function(t){e.destructor(t)})},t.prototype.close=function(t){this.transport.close(),this.destructor(t)},t.prototype.setDelivery=function(t){this.transport.setDelivery(t)},t.prototype.setWatchDog=function(t){this.transport.setWatchDog(t)},t}();e.LocalMainTransport=s});