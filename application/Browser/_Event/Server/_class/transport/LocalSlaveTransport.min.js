define("Browser/_Event/Server/_class/transport/LocalSlaveTransport",["require","exports","tslib","Browser/Event","Browser/Storage","Browser/_Event/Server/_class/transport/Constants","Browser/_Event/Server/_class/transport/Transport","Browser/_Event/Server/_class/Events","Browser/_Event/Server/_class/SubscribeContainer"],function(e,t,r,n,o,i,s,a,c){"use strict";Object.defineProperty(t,"__esModule",{value:true});var l=function(s){function e(){var e=s.call(this)||this;return e.ls=new o.LocalStorage(i.LS_PREFIX),e.taber=new n.Broadcast,e.subscribes=new c.SubscribeContainer,e.minInterval=2*i.CHECK_MIN_INTERVAL+Math.floor(Math.random()*i.RECONNECT_INTERVAL),e.setDisconnectHandler(function(){}),e.subMainReady=function(){if(!e.subscribes.hasChanneled())return;e.destructor("Reconnect to resubscribe")},e.taber.subscribe(i.KEY_MAINREADY,e.subMainReady),e.unloadWindow=e.unloadWindow.bind(e),window.addEventListener("unload",e.unloadWindow),e.taber.notify(i.KEY_NEW_PAGE,""),e}return r.__extends(e,s),e.prototype.getLocalName=function(){return e.getLocalName()},e.getLocalName=function(){return"LocalSlaveTransport"},e.prototype.subscribe=function(e){this.subscribes.add(e),this.taber.notify(i.KEY_SUBSCRIBE,e)},e.prototype.unsubscribe=function(e){this.subscribes.remove(e),this.taber.notify(i.KEY_UNSUBSCRIBE,e)},e.prototype.destructor=function(e,t){if(void 0===t)t=true;if(this.taber.unsubscribe(i.KEY_MAINREADY,this.subMainReady),this.mainChecker)clearInterval(this.mainChecker),this.mainChecker=void 0;this.taber=void 0,window.removeEventListener("unload",this.unloadWindow);var r=this.disconnectCallback;if(this.disconnectCallback=function(){},s.prototype.destructor.call(this),t){var n;r(e?a.create(e):void 0)}},e.prototype.setDisconnectHandler=function(e){var r=this;if(this.disconnectCallback=e,this.mainChecker)clearInterval(this.mainChecker);this.mainChecker=setInterval(function(){var e,t;if(r.ls.getItem(i.KEY_ACTUAL_DATE)+r.minInterval>Date.now())return;if((r.ls.getItem(i.KEY_TRY_CREATE_MAIN)||0)+i.RECONNECT_INTERVAL>Date.now())return;r.ls.setItem(i.KEY_TRY_CREATE_MAIN,Date.now()),r.destructor("Main is dead")},this.minInterval)},e.prototype.unloadWindow=function(){this.close(false)},e.prototype.close=function(e){if(void 0===e)e=true;for(var t=0,r=this.subscribes.all();t<r.length;t++){var n=r[t];this.taber.notify(i.KEY_UNSUBSCRIBE,n)}this.destructor("closeWindow",e)},e}(s.Transport);t.LocalSlaveTransport=l});