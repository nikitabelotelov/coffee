define("Browser/_Event/Server/_class/DeviceEnv",["require","exports","Core/Deferred","Env/Env","Browser/Transport","Browser/_Event/Server/_class/Constants","Browser/_Event/Server/_class/ConnectOptions"],function(e,r,a,i,c,s,u){"use strict";function f(){var e;return document.cookie.split("; ").filter(function(e){return"sid="==e.substr(0,4)}).map(function(e){return e.substr(4)}).pop()}Object.defineProperty(r,"__esModule",{value:true});var l=2*1e3,d=6e4,v=1e4,t=function(){function o(){}return o.getConnectData=function(r){if(!r)r=Math.round(Math.random()*v);if(r>d)r=d;var t=new a,n=Date.now();return new c.XHR({url:"/!hash/",method:"GET",dataType:"json"}).execute().addCallback(function(e){if(Date.now()-n>l)i.IoC.resolve("ILogger").warn("[STOMP][timeout] /!hash/ request to long: "+(Date.now()-n)+"ms");t.callback(e.result)}).addErrback(function(e){if(404===e.httpError)return void t.errback(e);if(0===e.httpError)r=v;setTimeout(function(){o.getConnectData(r+Math.round(1e4*Math.random())).addCallback(function(e){t.callback(e)})},r)}),t},o.getOptions=function(){var i=new a;return o.getConnectData().addCallbacks(function(e){var r=e.sid;if(!r)r=f();if(!r)throw new Error(s.ERR_MSG_EMPTY_SID);if(!e.user)return new Error(s.ERR_MSG_HASH_401);var t=e.cid;if(!t)t=r.substr(0,8);var n=e.uid,o;if(!n)n=r.substr(9,8);if(!!e.url)o=u.ConnectOptions.createForDesktop(r,e.user,e.url,t,n);var a="/stomp/";if(!!e.path)a=e.path;if(e.domain)o=new u.ConnectOptions(r,e.user,location.protocol,e.domain,a,e.exchange,t,n);if(!o)o=u.ConnectOptions.createByLocation(r,e.user,a,t,n);i.callback(o)},function(e){i.errback(e)}),i},o}();r.DeviceEnv=t});