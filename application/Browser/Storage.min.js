define("Browser/Storage",["Core/Serializer","Core/helpers/Object/isPlainObject","Core/i18n","Core/helpers/String/format","Env/Constants","Env/Env","Core/UserInfo","Types/entity","Env/Event","tslib","require","exports"],function(n,i,o,s,u,a,f,c,l,v,d,e){Object.defineProperty(e,"__esModule",{value:true}),e["Browser/_Storage/utils/item"]=true;var h=function(){"use strict";var e={},t=function(e,t,r,n){Object.defineProperty(t,"__esModule",{value:true});var i=new n;t.serialize=function(e){var t=e;if(e&&"function"===typeof e.toJSON)t=e.toJSON();try{if(!t||r(t))return JSON.stringify(t,i.serialize);return JSON.stringify(t)}catch(e){return""+t}},t.deserialize=function(t){if(!t)return null;var e;try{e=JSON.parse(t,i.deserialize)}catch(e){return t}return e}}(d,e,i,n);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Storage/utils/prefix"]=true;var g=function(){"use strict";var e={},t=(r=d,n=e,Object.defineProperty(n,"__esModule",{value:true}),n.add=function(e,t){return t&&t+"/"+e||e},n.remove=function(e,t){return t&&n.startsWith(e,t)?e.substr(t.length+1):e},void(n.startsWith=function(e,t){return!t||0===e.indexOf(t+"/")})),r,n;if(t instanceof Function)return t;else for(var i in t)if(t.hasOwnProperty(i))e[i]=t[i];return e}();e["Browser/_Storage/_storage"]=true;var m=function(){"use strict";var e={},t=function(e,t,r,n){Object.defineProperty(t,"__esModule",{value:true});var i=function(){return this||(0,eval)("this")}(),o,s;(s=o||(o={}))["local"]="localStorage",s["session"]="sessionStorage";var u=function(e,t){if(void 0===t)t="Core/_storage";n.IoC.resolve("ILogger").log(t,e)};function a(){var r={};return{setItem:function(e,t){r[e]=t&&t.toString()||""+t,this.length++},removeItem:function(e){delete r[e],this.length--},getItem:function(e){return r[e]||null},clear:function(){r={},this.length=0},length:0}}function f(r,e){return{getItem:function(e){try{return r.getItem(e)}catch(e){u(e)}},setItem:function(e,t){try{return r.setItem(e,t),true}catch(e){return u(e),false}},removeItem:function(e){try{r.removeItem(e)}catch(e){u(e)}},clear:function(){try{r.clear()}catch(e){u(e)}}}}function c(e){var t=i&&i[e];if(!r.constants.isBrowserPlatform||!t)return a();return f(t,e)}t.getLocal=function(){return c(o.local)},t.getSession=function(){return c(o.session)}}(d,e,u,a);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Storage/utils"]=true;var p=function(){"use strict";var e={},t=(r=d,n=e,i=h,o=g,Object.defineProperty(n,"__esModule",{value:true}),n.item=i,void(n.prefix=o)),r,n,i,o;if(t instanceof Function)return t;else for(var s in t)if(t.hasOwnProperty(s))e[s]=t[s];return e}(),t=p;e["Browser/_Storage/LocalNative"]=true;var y=function(){"use strict";var e={},t=function(e,t,r,n,i,o,s,u,a){Object.defineProperty(t,"__esModule",{value:true});var f="__s3su",c="ws-local-keys",l="ws-store-always-keys",v=u.getLocal(),d=1024*512,h=s.rk('Превышен максимальный размер записи ($max$d$ kb) в локальное хранилище для ключа "$key$s$" ($size$F$2$ kb)');function g(e,t){if(void 0===t)t="log";n.IoC.resolve("ILogger")[t]("Core/LocalStorageNative",e)}function m(e){var t=encodeURIComponent(e).match(/%[89ABab]/g);return e.length+(t?t.length:0)}function p(e,t){if(!i.constants.isBrowserPlatform)return true;var r=m(t);if(r<=d)return true;return g(o({max:d/1024,key:e,size:r/1024},h)),false}function y(){v.setItem(f,r.getCurrent())}var I=function(){var e=S(),t;try{t=[].concat(JSON.parse(v.getItem(l)))}catch(e){t=[]}var r=[];e.forEach(function(e){if(-1===t.indexOf(e))return v.removeItem(e);r.push(e)}),v.setItem(c,JSON.stringify(r))},S=function(){try{return JSON.parse(v.getItem(c))||[]}catch(e){return[]}};function O(){var e=v.getItem(f);if(!r.isValid(e))I(),y()}a.Bus.channel("errors").subscribe("onAuthError",O),O();var w={getItem:function(e){return v.getItem(e)},setItem:function(e,t){if(e===f)return false;var r=""+t;if(!p(e,r))return false;var n=v.setItem(e,r),i=S();if(-1===i.indexOf(e)&&e!==l)i.push(e),v.setItem(c,JSON.stringify(i));return!!n},removeItem:function(t){if(t===f)return;v.removeItem(t);var e=S(),r;e=e.filter(function(e){return t!==e}),v.setItem(c,JSON.stringify(e));try{r=JSON.parse(v.getItem(l))||[]}catch(e){r=[]}if(-1!==r.indexOf(t))r=r.filter(function(e){return t!==e}),v.setItem(l,JSON.stringify(r))},clear:function(){I(),y()},getLength:function(){return S().length},getKeys:function(){return S()}};t.default=w}(d,e,f,a,u,s,o,m,l);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}(),r=y;e["Browser/_Storage/Session"]=true;var I,S=function(){"use strict";var e={},t=function(e,t,r,n,i,o){var s;Object.defineProperty(t,"__esModule",{value:true});var u=o.getSession(),a=4*1e3,f="wsss",c;function l(){if(!i.constants.isBrowserPlatform&&i.constants.isBuildOnServer){var e=process&&process.domain&&process.domain.req||{};c=e.sessionStorage=e.sessionStorage||{}}if(c)return c;var t=u.getItem(f);try{c=JSON.parse(t)||{}}catch(e){c={}}if(!r.isValid(c.user))u.removeItem(f),(c={}).user=r.getCurrent();return c}if(i.constants.isBrowserPlatform){var v=n.detection.firefox?"beforeunload":"unload";window.addEventListener(v,function(){u.setItem(f,JSON.stringify(l()))})}function d(){if(!i.constants.isBrowserPlatform)return;if(s)clearTimeout(s);s=setTimeout(function(){u.setItem(f,JSON.stringify(l())),s=null},a)}var h={get:function(e){return l()[e]},set:function(e,t){if(!e)return;if(null==t&&"object"==typeof e&&"[object Object]"==Object.prototype.toString.call(e)){for(var r in e)if(e.hasOwnProperty(r))l()[r]=e[r]}else l()[e]=t;d()},remove:function(e){delete l()[e],d()},toObject:function(){return l()}};t.default=h}(d,e,f,a,u,m);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Storage/NativeGetter"]=true;var O=function(){"use strict";var e={},t=function(e,t,r,n,a,i,f){var c=function(){return this||(0,eval)("this")}(),l="__storage",v=function(){return r.Bus.channel("local_storage")},o="ws-store-always-keys",s="ws-local-keys",u=a.prefix.add("ie-fix-event",l),d=[];function h(e){return e.length>=2143}var g=/\$ie-fix\{(\d+)\}/i,m=Math.random().toString().substr(2),p=function(e){return"$ie-fix{"+m+"}"+e},y=function(e){return e&&e.replace(g,"")||e},I;function S(e){if(!(e=e||c.event))return;var t=e.key,r=e.newValue,n=e.oldValue;if(r==n)return e.stopPropagation(),void e.stopImmediatePropagation();var i=Date.now(),o,s;if(I&&I.key===t&&I.newValue===r&&I.oldValue===n&&i-I.date<=2*1e3)return;if(I={key:t,newValue:r,oldValue:n,date:i},r){var u=r.match(g);if(u)r=r.replace(u[0],""),o=u[1],s=true,e.stopPropagation(),e.stopImmediatePropagation()}if(o===m)return;if(a.prefix.startsWith(t,l))return O(t,r,n);if(h(r))d.push({key:t,length:r.length});if(s)v().notify("onChange",t,f.deserialize(r))}function O(e,t,r){var n=a.prefix.remove(e,l),i=t;if(n===u)setTimeout(function(){var t=w.getItem(i),r=d.filter(function(e){return e.key===i&&e.length===t.length});if(!r)v().notify("onChange",i,f.deserialize(t));d=d.filter(function(e){return e!==r})},10)}var w={getItem:function(e){return y(n.default.getItem(e))},setItem:function(e,t){if(e===o||e===s)return n.default.setItem(e,t);t=p(t);var r=n.default.setItem(e,t);if(r&&h(t))n.default.setItem(u,e),n.default.removeItem(u);return r}};return["getLength","getKeys","removeItem","clear"].forEach(function(e){w[e]=n.default[e].bind(w)}),function(){if(i.detection.isIE&&c.addEventListener)return c.addEventListener("storage",S,false),w;return n.default}}(d,e,l,y,p,a,h);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["Browser/_Storage/Local"]=true;var w,_=function(){"use strict";var e={},t=function(e,t,r,n,i,s,u,o){Object.defineProperty(t,"__esModule",{value:true});var a=function(){return this||(0,eval)("this")}(),f="ws-store-always-keys",c=["onChange","onRemove","onClear"],l=function(){return n.Bus.channel("local_storage")},v=i(),d=false;function h(){if(d||!a)return;if(d=true,a.addEventListener)return a.addEventListener("storage",g,false)}function g(e){if(!e&&a.event)e=a.event;if(!e)return;var t=e.key,r=e.newValue,n=e.oldValue;if(!t)return void l().notify("onClear");if(!r)return l().notify("onRemove",t);return l().notify("onChange",t,s.deserialize(r))}function m(e,t,r){if(!t)return this._notify(e.name);if(u.startsWith(t,this.prefix))return this._notify(e.name,u.remove(t,this.prefix),r)}function p(e,t){return s.deserialize(v.getItem(e,!t))}function y(t){return v.getKeys().filter(function(e){return u.startsWith(e,t)})}var I=function(i){function e(e,t,r){if(void 0===e)e="";if(void 0===t)t=false;if(void 0===r)r=true;var n=i.call(this)||this;return n.prefix=e,n.storeAlways=t,n.isCheckSession=r,n._onStorage=m.bind(n),c.forEach(function(e){l().subscribe(e,n._onStorage)}),n._publish.apply(n,c),h(),n}return r.__extends(e,i),e.prototype.destroy=function(){var t=this;return c.forEach(function(e){l().unsubscribe(e,t._onStorage)}),i.prototype.destroy.call(this)},e.prototype.setItem=function(e,t){var r=u.add(e,this.prefix),n=s.serialize(t),i=v.setItem(r,n,!this.isCheckSession);if(!i||!this.storeAlways)return i;var o=p(f,!this.isCheckSession)||[];if(-1===o.indexOf(r))o.push(r),v.setItem(f,s.serialize(o),!this.isCheckSession);return i},e.prototype.getItem=function(e){return p(u.add(e,this.prefix),!this.isCheckSession)},e.prototype.removeItem=function(e){return v.removeItem(u.add(e,this.prefix))},e.prototype.clear=function(){y(this.prefix).forEach(function(e){v.removeItem(e)})},e.prototype.getKeys=function(){var t=this;return y(this.prefix).map(function(e){return u.remove(e,t.prefix)})},e.prototype.toObject=function(){var t=this,r={};return y(this.prefix).forEach(function(e){r[e]=p(e,!t.isCheckSession)}),r},e.clearAll=function(){v.clear()},e}(o.ObservableMixin);t.default=I}(d,e,v,l,O,h,g,c);if(t instanceof Function)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();return e.LocalStorage=_.default,e.LocalStorageNative=r.default,e.SessionStorage=S.default,e.utils=t,e});