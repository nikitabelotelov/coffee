define("Browser/_TransportOld/XMLTemplate",["Browser/_TransportOld/Template","Env/Env","Browser/_TransportOld/nodeType","Browser/_TransportOld/loadTemplateFile","Core/Deferred","Core/ParallelDeferred","Core/core-attach","Core/Context","Core/CommandDispatcher","Core/helpers/Object/isEmpty","Core/core-instance","Core/helpers/Number/randomId"],function(Template,Env,nodeType,loadTemplateFile,Deferred,ParallelDeferred,core_attach,Context,CommandDispatcher,isEmptyObject,cInstance,randomId){var XMLTemplate,forEach=function(e,t,n){if(null===e||void 0===e||0===e.length)return;var r,i,o;if(e instanceof Array){if(e.forEach)e.forEach(t,n);else for(i=e.length,r=0;r<i;r++)if(r in e)t.call(n,e[r],r,e)}else if("length"in e&&e.length-1 in e){for(i=parseInt(e.length,10),r=0;r<i;r++)if(r in e)t.call(n,e[r],r,e)}else for(o in e)if(e.hasOwnProperty(o))t.call(n,e[o],o,e)},filter=function(e,r,i){var o=[];if(null===e||void 0===e)return o;return forEach(e,function(e,t,n){if(r){if(r.call(i,e,t,n))o[o.length]=e}else if(!!e)o[o.length]=e},i),o},insertCss=function(e,t,n){function r(){var e;if("getElementsByClassName"in document)e=document.getElementsByClassName("ws-style-holder-current")[0];else for(var t=document.getElementsByTagName("style"),n=0,r=t.length;n<r;n++)if(o(t[n],"ws-style-holder-current")){e=t[n];break}return e=e||i()}function i(){var e=document.createElement("style"),t=document.getElementsByTagName("head")[0];return e.setAttribute("type","text/css"),e.setAttribute("media","all"),e.className="ws-style-holder ws-style-holder-current",t.appendChild(e),e}function o(e,t){for(var n=" "+e.className+" ",r=t.split(" "),i=0,o=r.length;i<o;i++)if(-1==n.indexOf(" "+r[i]+" "))return false;return true}function a(){var e,t="absolute"===u.css("position"),n=+new Date-f>Env.constants.styleLoadTimeout,r=$("#onlineChecker");if(t||n)if(u.remove(),d)if(clearInterval(d),n)r.text(rk("Страница загружается слишком долго. Попробуйте перезагрузить страницу")),r.css("display",""),r.css("zIndex",9999),s.callback();else s.callback();return t}var l="",s=null,c,u,d,f,h;if(t)c=randomId("cssReady-"),u=$('<div id="'+c+'" style="display: none;" />').appendTo($("body")),l="#"+c+" { position: absolute; }";if(Env.compatibility.standartStylesheetProperty)(h=i()).appendChild(document.createTextNode(e+l));else{var m,g,p;if(e+=l,((h=r()).styleSheet.cssText.match(/\{|,/g)||[]).length+(e.match(/\{|,/g)||[]).length>4e3)h.className="ws-style-holder",h=i();try{h.styleSheet.cssText+=e}catch(e){throw Env.IoC.resolve("ILogger").error("insertCss","Failed to insert styles to document! IE8/9 Stylesheet limit exceeded (31 per document)?"),e}}if(t)if(f=+new Date,!a())(s=new Deferred).addErrback(function(e){return e}),d=setInterval(a,1);return s};return XMLTemplate=Template.extend({$protected:{_xml:null,_toText:[],_html:"",_dReady:null,_innerTemplates:[],_templateName:"",_document:void 0,_controlTagCache:""},$constructor:function(e){var t=this;this._xml=e.templateXML,this._document=this._xml.documentElement?this._xml.documentElement:this._xml,this._innerTemplates[this._templateName=e.templateName]=true,this._includeInnerTemplate(new Deferred).addCallbacks(function(){t._assignId(),t._loadEventHandlers()},function(e){return Env.IoC.resolve("ILogger").log("Template","Building failed. Reason: "+e.message),e});var n=this._xml.getElementsByTagName("style")[0];if(n){var r=this._findCDATA(n,true);if(r){var i=insertCss(r,true,this.getName());if(i)this._dReady.push(i)}}},_getIncludeDescriptorNodes:function(){var e;if(this._xml.nodeType==nodeType.DOCUMENT_NODE)e=this._xml.firstChild.childNodes;else e=this._xml.childNodes;return filter(e,function(e){return"I"==e.nodeName.toUpperCase()})},isPage:function(){return"false"===this._document.getAttribute("isApplication")},_collectAllControlsToPreload:function(e){return this._getControlsByFilter(function(){return true})},_extractControlConfiguration:function(controlNode){var configObject,cfg=controlNode.getAttribute("config");if(cfg)try{configObject=eval("("+cfg+")")}catch(e){configObject={}}else configObject=this._parseConfiguration(controlNode.getElementsByTagName("configuration")[0]);return configObject},_findCDATA:function(e,t){for(var n,r,i=0,o=e.childNodes.length;i<o;i++)if((n=e.childNodes[i]).nodeType===nodeType.CDATA_SECTION_NODE){r=t?n.nodeValue:n;break}return r},_includeInnerTemplate:function(r){var c=this,e=this._xml.getElementsByTagName("include"),t=new ParallelDeferred,n,i,o,a=[],u=[];if(0===e.length)r.callback();else{for(var l=0,s=e.length;l<s;l++)if(i=(n=e[l]).parentNode,null!==(o=e[l].getAttribute("name")))if(this._innerTemplates[o])return r.errback("Cyclic dependency detected");else a.push(o),u[l]="",function(a,l,s){t.push(loadTemplateFile(o).addCallback(function(e){var t=e.documentElement?e.documentElement.childNodes:e.childNodes,n=e.getElementsByTagName("style")[0],r;if(n)u[s]=c._findCDATA(n,true),(e.documentElement?e.documentElement:e).removeChild(n);for(var i=0,o=t.length;i<o;i++){if(r=t[0],c._xml.adoptNode)r=c._xml.adoptNode(r);a.insertBefore(r,l)}return a.removeChild(l),e}))}(i,n,l);else for(var d in n.childNodes)if(n.childNodes.hasOwnProperty(d)){var f=n.childNodes[d];if(f.getAttribute){var h=f.getAttribute("source");if(h)t.push(core_attach.attach(h))}}t.done().getResult().addCallback(function(){for(var e=c._xml.getElementsByTagName("style")[0],t=0,n=a.length;t<n;t++)c._innerTemplates[a[t]]=true;if(e)c._findCDATA(e,false).nodeValue+=u.join("");else(e=c._xml.createElement("style")).appendChild(c._xml.createCDATASection(u.join(""))),c._document.appendChild(e);c._includeInnerTemplate(r)})}return r},_assignId:function(){for(var e=this._getControlTags(this._xml),t=0,n=e.length;t<n;t++){var r=e[t];if(!r.getAttribute("id"))r.setAttribute("id",randomId())}},_getControlTags:function(e){var t;if(this._controlTagCache)return this._controlTagCache;if(e.querySelectorAll){var n=e.querySelectorAll('div[wsControl="true"]');if(n)t=n}if(!t){t=[];for(var r=e.getElementsByTagName("div"),i=0,o=r.length;i<o;i++){var a=r[i];if(a.getAttribute("wsControl"))t.push(a)}}return this._controlTagCache=t},_getFunctionOptions:function(){var e;if(this._xml.querySelectorAll)if(e=this._xml.querySelectorAll('option[type="function"]'))return e;var t=this._xml.getElementsByTagName("option");e=[];for(var n=0;n<t.length;n++)if("function"===t[n].getAttribute("type"))e.push(t[n]);return e},_loadEventHandlers:function(){for(var e=this._getFunctionOptions(),t=0;t<e.length;t++){var n=e[t].getAttribute("name"),r=e[t].getAttribute("value");if(null!==r&&r.length>0)this._dReady.push(core_attach.getHandler(r))}this._dReady.push(this._processTemplateHandlers()).done(this)},_processTemplateHandlers:function(){for(var r=new ParallelDeferred,i=this,e=this._document.attributes,t={},n=0,o=e.length;n<o;n++){var a=e[n],l=a.nodeName;if("on"==l.substring(0,2)&&""!==a.nodeValue)t[l]=a.nodeValue.split("|")}if(!isEmptyObject(t))for(var s in t)if(t.hasOwnProperty(s))(function(n,e){i._loadedHandlers[n]=[];for(var t=0;t<e.length;++t)(function(t){r.push(core_attach.getHandler(e[t]).addCallbacks(function(e){return i._loadedHandlers[n][t]=e},function(e){return Env.IoC.resolve("ILogger").error("Template","Error while loading handler "+n+": "+e.message,e),e}))})(t)})(s,t[s]);return r.done().getResult()},getStyle:function(){return this._document.getAttribute("windowStyle")||""},getDimensions:function(){var e=this._document.getAttribute("width"),t=this._document.getAttribute("height");return{width:!e?"":"auto"===e.toLowerCase()?"auto":e.indexOf("%")>=0?e:parseInt(e,10)+"px",height:!t?"":"auto"===t.toLowerCase()?"auto":t.indexOf("%")>=0?t:parseInt(t,10)+"px"}},getAlignment:function(){var e=this._document.getAttribute("HorizontalAlignment"),t=this._document.getAttribute("VerticalAlignment");return{horizontalAlignment:!e?"Stretch":e,verticalAlignment:!t?"Stretch":t}},getTitle:function(){return this._document.getAttribute("title")},getConfig:function(e){var t=this._configuration,n=e||this._document;if(null!==n.attributes)for(var r=0,i=n.attributes.length;r<i;r++){var o=n.attributes[r];this._mergeAttrToConfig(t,o.nodeName,o.nodeValue)}return t},getDeclaredHandlers:function(){return this._loadedHandlers},createMarkup:function(e){var t;if(""===this._html){var n="ws-template"==this._xml.nodeName?this._xml:this._xml.getElementsByTagName("ws-template")[0],r=e.get(0).ownerDocument,i=r.createElement("div"),o=n?n.childNodes:[],a,l=0,s;while(o.length&&l<o.length)if((a=o.item(l)).nodeType==nodeType.ELEMENT_NODE&&"style"!=a.nodeName)a=Template._importNode(r,a,true),l++,i.appendChild(a);else l++;var c=i.getElementsByTagName("configuration");for(l=0,s=c.length;l<s;l++)c[0].parentNode.removeChild(c[0]);this._html=t=i.innerHTML.replace(/<\/ ?br>/gi,"").replace(/&amp;/gi,"&")}else t=this._html;e.html(t)},_getControlsByFilter:function(e){for(var t=this._getControlTags(this._xml),n=[],r=0,i=t.length;r<i;r++){var o=t[r];if(e(o)){var a=this._extractControlConfiguration(o);a.type=o.getAttribute("type"),a.id=o.getAttribute("id"),n.push(a)}}return n},getControls:function(t){return this._getControlsByFilter(function(e){return t==e.getAttribute("parentId")})},_parseConfiguration:function(e,r){var i,t,n,o,a=new function(){var n=this;n.mass=r?[]:{},n.push=function(e,t){if(r)n.mass.push(t);else if(null!==e)n.mass[e]=t}};if(e&&e.childNodes)for(var l=e.childNodes,s=0,c=l.length;s<c;s++){var u=l[s];if(u.nodeName&&("option"==u.nodeName||"options"==u.nodeName))if(i=u.getAttribute("name"),n=u.getAttribute("type"),t=u.getAttribute("value"),"array"===n||null===t&&"cdata"!=n){if(null===t)t=this._parseConfiguration(u,"array"===n);a.push(i,t)}else switch(n){case"cdata":a.push(i,this._findCDATA(u,true));break;case"boolean":a.push(i,"true"===t);break;case"moduleFunc":case"function":if("string"===typeof t&&t.length>0){var d=core_attach.getHandler(t);if(!d.isReady()||d.isSuccessful())(function(t){d.addCallback(function(e){if("function"==typeof e)return a.push(t,e),e;else throw new Error("Integrity error! Some serious problems in $ws.core.getHandler()!")})})(i);else throw new Error(t+" function is not ready or don't exist")}break;case"dialog":if("string"===typeof t&&t.length>0)(function(n){a.push(i,function(){var e=new Deferred,t=Context.createContext(e,null,this.getLinkedContext());core_attach.attachInstance("Lib/Control/Dialog/Dialog",{template:n,opener:this,context:t,handlers:{onDestroy:function(){e.callback()}}})})})(t);break;case"floatArea":if("string"===typeof t&&t.length>0)(function(t){a.push(i,function(){var e=this.getTopParent().getContainer();this.setEnabled(false),core_attach.attachInstance("Lib/Control/FloatArea/FloatArea",{id:this.getId(),opener:this,name:this.getName()+"-floatArea",template:t,target:e,side:"right",autHide:true,showDelay:300,animationLength:300,offset:{x:0,y:window.scrollY>e.offset().top?window.scrollY:0},handlers:{onAfterClose:function(){this.getOpener().setEnabled(true)}}})})})(t);break;case"command":if("string"===typeof t&&t.length>0)(function(t){a.push(i,function(e){e.setResult(CommandDispatcher.sendCommand.apply(CommandDispatcher,[this,t].concat(Array.prototype.slice.call(arguments,1))))})})(t);break;case"page":case"newpage":if("string"===typeof t&&t.length>0)(function(t,n){a.push(i,function(){var e="function"===typeof this.getOpenLink?this.getOpenLink()||t:t;if("page"==n)window.location=e;else window.open(e)})})(t,n);break;case"menu":if("string"===typeof t&&t.length>0)(function(e){a.push(i,function(){if(cInstance.instanceOfModule(this,"Deprecated/Controls/Button/Button"))this._options.menu=e,this.unsubscribe("onActivated",arguments.callee),this._initMenu(),this._notify("onActivated")})})(t);break;case null:default:if("null"===t)t=null;if("Infinity"===t)t=1/0;a.push(i,t)}}return a.mass},needSetZindexByOrder:function(){return true}}),XMLTemplate});