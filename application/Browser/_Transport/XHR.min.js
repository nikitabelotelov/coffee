define("Browser/_Transport/XHR",["require","exports","Env/Env","Env/Constants","Core/Deferred","Core/UserInfo","Browser/_Transport/ajax-emulator","Browser/_Transport/ITransport","Browser/_Transport/fetch","Env/Event"],function(r,e,t,n,l,o,s,i,d,a){"use strict";Object.defineProperty(e,"__esModule",{value:true});var c,p=a.Bus.channel("Transport"),E=a.Bus.channel("errors");function h(e,n){if(c.isOfflineError(e)){var o;try{(o=JSON.parse(n).method.split(".")).push(e)}catch(r){o=[n,e]}return!!c.notifyOfflineError(o)}}var T=false;if("undefined"!==typeof window)if(t.detection.firefox)window.addEventListener("beforeunload",function(){T=true,setTimeout(function(){T=false},600)});else window.addEventListener("unload",function(){T=true});if((c=i.default.extend({$protected:{_options:{method:"GET",dataType:"text",contentType:"application/x-www-form-urlencoded",url:"",async:true},_xhr:void 0},$constructor:function(){if(""===this._options.url)throw new Error("Request with no URL is ambiguous")},execute:function(a,r){var c=new l({cancelCallback:this.abort.bind(this)}),f=this;if(n.constants.checkSessionCookie&&!o.isValid())return c.errback(d.Errors.ERROR_TEXT[401]),E.notify("onAuthError"),c;var u=this._options.url;try{this._xhr=s({type:this._options.method,dataType:this._options.dataType,contentType:this._options.contentType,url:u,headers:r||{},data:a,async:this._options.async,beforeSend:function(r,e){return p.notify("onBeforeSend",r,e)},success:function(r,e,n){if(h(r.error,a))return void c.errback(new d.Errors.Connection(u));var o=l.success(r);return p.notify("onResponseSuccess",n,o,f._options.url),c.dependOn(o),r},error:function(r,e){if(r.responseJSON&&h(r.responseJSON.error,a))return void c.errback(new d.Errors.Connection(u));if("abort"===e)return void c.cancel();var n=r.status,o=d.Errors.ERROR_TEXT[n]||d.Errors.ERROR_TEXT[e]||d.Errors.ERROR_TEXT.unknown||"";if(0===n&&""===r.getAllResponseHeaders()){var t="/"===f._options.url.charAt(0)?window.location.hostname:f._options.url;o=d.Errors.ERROR_TEXT.lossOfConnection+" "+t}var s=new d.Errors.HTTP({message:o,httpError:n,url:f._options.url,payload:r.responseText,xhr:r});if(E.notify("onHTTPError",s),"401"==n)if(true===E.notify("onAuthError"))return;var i=new l;if(p.notify("onResponseError",f._xhr,i),i.addCallback(function(r){c.callback(r)}).addErrback(function(r){c.errback(r)}),T)i.cancel();else i.errback(s)}})}catch(r){c.errback("JavaScript exception while trying to execute request: "+r.message)}return c},setUrl:function(r){if("string"==typeof r)this._options.url=r},abort:function(){if(this._xhr)this._xhr.abort()}})).ERRORS_TEXT=d.Errors.ERROR_TEXT,c.isOfflineError=function(r){var e;return 300==(e=r&&(r.data&&r.data.error_code||r.httpError||r.code))||405==e},c.notifyOfflineError=function(r){var e,n,o;if(e=a.Bus.globalChannel(),n=["onOfflineModeError"].concat(r),o=e.notify.apply(e,n))t.IoC.resolve("ILogger").info("XHRTransport","Работа в offline-режиме");return o},c.getServiceByName=function(r){return n.constants.services[r]||n.constants.defaultServiceUrl},!t.IoC.has("ITransport"))t.IoC.bind("ITransport",c);e.default=c});