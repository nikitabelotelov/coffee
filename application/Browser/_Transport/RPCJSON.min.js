define("Browser/_Transport/RPCJSON",["require","exports","Core/core-extend","Env/Constants","Env/Env","Browser/_Transport/RPC/Body","Browser/_Transport/RPC/Headers","Browser/_Transport/RPC/request","Browser/_Transport/RPC/fallback","Browser/_Transport/RPC/ErrorCreator","Browser/_Transport/XHR"],function(r,e,t,s,o,i,c,n,a,d){"use strict";Object.defineProperty(e,"__esModule",{value:true});var p=o.IoC.resolve("ILogger");function l(r,e){e=e?', use "'+e+'"':"",p.log("Browser/_Transport/RPCJSON",'Method "'+r+'" is deprecated and will be removed'+e)}function u(r,e,t){return function(){return l(r,e),t.apply(this,arguments)}}function _(r){if("undefined"===typeof window||!window.cachedMethods||!window.cachedMethods.length)return false;return window.cachedMethods.indexOf(r)>-1}function f(r){return r.length<2*1024}var h=t({},{$protected:{_transports:null,_options:{serviceUrl:"",fallback:false,timeout:6e4,asyncInvoke:false,async:true}},$constructor:function(){this._transports={}},callMethod:function(r,e,t){var o=this.__getRequestParam(r,e,t),s;return this._transports.current=o.transport,(this._options.fallback?a.default:n.default)(o).addErrback(function(r){if(!r.details){var e=r.httpError||0;r.details=e>500?rk("Попробуйте заглянуть сюда через 15 минут"):""}return r})},abort:function(){p.log("Browser/_Transport/RPCJSON",'Метод "abort" обрывает только последний созданный запрос. Если вам необходима эта логика используйде Core/Deferred#cancel'),this._transports.current&&this._transports.current.abort()},__getRequestParam:function(r,e,t){var o="",s=false,n="POST",a;if(_(r))o=i.getURL(r,e);if(o&&f(o))n="GET",(a=this.__getTransport(n)).setUrl(this.__getServiceAddress(o)),s=true;return{method:r,timeout:this._options.timeout,headers:new c.default({method:r,httpMethod:n,fallback:this._options.fallback,asyncInvoke:this._options.asyncInvoke,recent:t}),transport:a||this.__getTransport(),data:s?"":i.getBody(r,e),url:this.__getServiceAddress()}},__getTransport:function(r){if(r=r||"POST",!this._transports[r])this._transports[r]=this.__createTransport(r);return this._transports[r]},__createTransport:function(r){return o.IoC.resolve("ITransport",{url:this.__getServiceAddress(),method:r,dataType:"json",contentType:"application/json; charset=utf-8",async:this._options.async})},__getServiceAddress:function(r){var e=this._options.serviceUrl||s.constants.defaultServiceUrl,t,o=(e+=e.indexOf("?")>-1?"&":"?")+("x_version="+s.constants.buildnumber);if(r)o+=r.replace(/^\?/,"&");return o},_setHeaders:function(r,e,t){l("_setHeaders","Browser/_Transport/RPC/Headers"),Object.assign(r.reqHeaders,new c.default({recent:t,httpMethod:e,fallback:this._options.fallback,asyncInvoke:this._options.asyncInvoke}))},_fallbackResponse:function(r,e,t,o){l("_fallbackResponse")}});h.jsonRpcPreparePacket=function(r,e,t){return l("jsonRpcPreparePacket",'Browser/_Transport/RPC/Body" or "Browser/_Transport/RPC/Headers'),{reqUrl:i.getURL(r,e,t),reqBody:i.getBody(r,e,t),reqHeaders:c.default.getForMethod(r)}},h.getEmptyRpcResponse=u("getEmptyRpcResponse","Browser/_Transport/RPC/Body#getEmptyResponse",i.getEmptyResponse),h.handleHTTPError=u("handleHTTPError","Browser/_Transport/RPC/ErrorNotifier#HTTP",d.fromHTTP),h.handleRPCError=u("handleRPCError","Browser/_Transport/RPC/ErrorNotifier#RPC",d.fromRPC),e.default=h});