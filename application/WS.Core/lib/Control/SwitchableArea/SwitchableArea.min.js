define("Lib/Control/SwitchableArea/SwitchableArea",["Core/core-merge","Core/helpers/Hcontrol/replaceContainer","Core/helpers/collection","Core/Deferred","Core/moduleStubs","Lib/Control/CompoundControl/CompoundControl","Lib/Control/SwitchableArea/SwitchableAreaItem","tmpl!Lib/Control/SwitchableArea/SwitchableArea","tmpl!Lib/Control/SwitchableArea/SwitchableArea_area","Core/helpers/Number/randomId","Env/Env","Core/Sanitize"],function(l,h,o,c,a,e,r,t,n,i,u,s){"use strict";var d=e.extend({_dotTplFn:t,$protected:{_areaHashMap:{},_bindedHandlers:void 0,_currentAreaId:null,_currentAreaWaitDeferred:void 0,_items:[],_createChildOnInitSelector:"> :not(.ws-SwitchableArea__item) [data-component]",_options:{areaTemplate:n,items:[],defaultArea:"",loadType:"cached",loadDependencies:true,activateArea:true}},$constructor:function(){this._publish("onBeforeChangeActiveArea","onAfterChangeActiveArea");var e=this;this._bindedHandlers={handleItemIdChanged:this._handleItemIdChanged.bind(this),handleItemContentChanged:this._handleItemContentChanged.bind(this)};for(var t=0,a=this._options.items.length;t<a;t++){var n=this._createSwitchableAreaItem(this._options.items[t]),i=n.getId(),r=this._options.defaultArea===i,s;if(this._items[t]=n,this._areaHashMap[i]=n,r)this.setActiveArea(i);else if("all"===this._options.loadType)(s=n.loadChildControls()).addCallback(function(){e.sendCommand("loadChildControls",e.getName(),i)});if(n.setVisible(r),r&&!this._currentAreaId)this._currentAreaId=i}this._items=o(this._items)},_modifyOptions:function(e){return d.superclass._modifyOptions.call(this,e),e.items=e.items.map(function(e,t){return e.id=e.id||i("ws-area-"+t+"-"),e}),e},_loadControls:function(e){return e.done([])},_createSwitchableAreaItem:function(e){var t=this._options.defaultArea===e.id,a=new r(l({visible:t,autoHeight:this._options.autoHeight,parent:this,element:this.getContainer().children('.ws-SwitchableArea__item[data-for="'+e.id+'"]'),contentExistence:"cached"!==this._options.loadType||t},e));return a.subscribe("onIdChanged",this._bindedHandlers.handleItemIdChanged),a.subscribe("onContentChanged",this._bindedHandlers.handleItemContentChanged),a.getContext().setPrevious(this.getContext()),a},_handleItemIdChanged:function(e,t,a){if(this._areaHashMap[a])this._areaHashMap[t]._options.id=t;else if(t&&this._areaHashMap[t]){if(this._areaHashMap[a]=this._areaHashMap[t],delete this._areaHashMap[t],this._currentAreaId===t)this._currentAreaId=a;this._areaHashMap[a].getContainer().attr("data-for",a)}},_getAreaMarkupContext:function(e){var t;return this._options.buildMarkupWithContext||e._options.buildMarkupWithContext?e.getLinkedContext():void 0},_handleItemContentChanged:function(e,t){if(this._areaHashMap[t]){var a=this._areaHashMap[t],n={id:a.getId(),content:a.getContent(),template:a.getTemplate(),componentOptions:a.getComponentOptions()||{}};if(h(a.getContainer(),this._buildMarkup(this._options.areaTemplate,{enabled:a._options.enabled,visible:a._options.visible,outer:this._options,item:n,index:this._getItemIndexById(t),contentExistence:true},void 0,void 0,this._getAreaMarkupContext(a))),"all"===this._options.loadType||t===this._currentAreaId)a.loadChildControls()}},getItems:function(){return this._items},getItemById:function(e){return this._areaHashMap[e]||null},_getItemIndexById:function(e){var t=this.getItemById(e);return t?this.getItems().indexOf(t):-1},setAreaContent:function(e,t){this.getItems()[this._getItemIndexById(e)].setContent(t)},getCurrentAreaId:function(){return this._currentAreaId},getActiveArea:function(){return this.getCurrentAreaId()},setActiveArea:function(i){var e=this._areaHashMap[this._currentAreaId],r=this._areaHashMap[i],s=this,t=[],o,d=new c;if(e)e._areaDefaultButton=e._defaultButton||e._shouldRegisterButton;if(i&&this._currentAreaId!==i&&r){if(this._notify("onBeforeChangeActiveArea",e||null,r),this._currentAreaId&&e)e.hide();if(!r.isLoaded()){if(this._options.loadDependencies)t=s._getDependencies(r.getContent());if(r.getTemplate()){if(!r._loadingTemplate)r._loadingTemplate=true,a.require([r.getTemplate(),"tmpl!Lib/Control/SwitchableArea/SwitchableArea_area_template"]).addCallbacks(function(e){r._loadingTemplate=false,o=l(r.getComponentOptions(),{element:document.createElement("div"),parent:r});var t=r._container[0];if(r._options.withScroll){var a={id:r.getId(),index:s._getItemIndexById(i),template:e[0],componentOptions:r.getComponentOptions()||{}};h(r.getContainer(),e[1](a)),t=$(".ws-SwitchableArea__item__root_container",r.getContainer())[0],r.reviveComponents(),o.parent=r.getChildControlByName("switchScroll")}t.appendChild(o.element);var n=new e[0](o);r.setLoaded(true),r.setContentExistence(true),setTimeout(function(){n._notifyOnSizeChanged()},10),d.callback()},function(e){u.IoC.resolve("ILogger").error("SwitchableArea::setActiveArea()",e)})}else if(t.length)a.require(t).addCallbacks(function(){r.loadChildControls().addCallback(function(e){return d.callback(),e})},function(e){u.IoC.resolve("ILogger").error("SwitchableArea::setActiveArea()",e)});else d=r.loadChildControls();d.addCallback(function(){s.sendCommand("loadChildControls",s.getName(),i)})}else if(u.constants.browser.isMacOSDesktop&&u.constants.browser.safari)setTimeout(function(){d.callback()},1);else d.callback();r.show(),this._currentAreaId=i,(this._currentAreaWaitDeferred=d).addCallback(function(){if(r._areaDefaultButton=r._areaDefaultButton||r._shouldRegisterButton,r._areaDefaultButton&&r._areaDefaultButton.setDefaultButton(true),s._notify("onAfterChangeActiveArea",r),s._options.activateArea)if(!s.getTopParent()||s.getTopParent().isVisible())r.activateFirstControl()})}else if(this._currentAreaWaitDeferred&&!this._currentAreaWaitDeferred.isReady())d=this._currentAreaWaitDeferred;else d=(new c).callback();return d},_getDependencies:function(e){var n=[];if("string"===typeof e)$("<div>"+s(e)+"</div>").find("[data-component]").each(function(e,t){var a=t.getAttribute("data-component");n.push(a)});return n},hideAll:function(){for(var e=0,t=this.getItems().length;e<t;e++)this.getItems()[e].hide();this._currentAreaId=null},addArea:function(e,t,a,n,i){i=i||{};var r=this.getItems().length,s={id:e,content:t||"",template:a,withScroll:i.withScroll,componentOptions:n||{}};return this.getItems().push(s),this._initAddedArea(r)},_initAddedArea:function(e){var t=this.getItems(),a=t[e];if(!(a instanceof r)){var n=this._createSwitchableAreaItem(a);if(n.setVisible(false),h(n.getContainer(),this._buildMarkup(this._options.areaTemplate,{outer:this._options,enabled:n._options.enabled,visible:n._options.visible,item:a,index:e,contentExistence:"cached"!==this._options.loadType||this._options.defaultArea===a.id},void 0,void 0,this._getAreaMarkupContext(n))),n.getId()!==a.id)n.setId(a.id);if(e<t.length-1){var i=t[e+1];$(n.getContainer()).insertBefore(i.getContainer())}else this.getContainer().append(n.getContainer());if(this.getItems()[e]=n,this._areaHashMap[n.getId()]=n,"all"===this._options.loadType)return n.loadChildControls()}if(!this._currentAreaId)this.setActiveArea(t[e].getId());return(new c).callback()},removeArea:function(e){if(this._areaHashMap[e]){if(this._currentAreaId===e)if(1===Object.keys(this._areaHashMap).length)this._areaHashMap[this._currentAreaId].hide(),this._currentAreaId=null;else{var t=this.getItems()[0].getId()!==e?0:1;this.setActiveArea(this.getItems()[t].getId())}this._areaHashMap[e].unsubscribe("onIdChanged",this._bindedHandlers.handleItemIdChanged),this._areaHashMap[e].unsubscribe("onContentChanged",this._bindedHandlers.handleItemContentChanged);var a=this._getItemIndexById(e);if(a>=0)this.getItems().splice(a,1);this._areaHashMap[e].destroy(),delete this._areaHashMap[e]}},clearAreaCache:function(){var e=this.getItems(),t=e.length,a;for(a=0;a<t;a++){var n=e[a];n.destroyChildControls(),n.setLoaded(false),n.setContentExistence(false),n._clearContainer();var i={id:n.getId(),content:n.getContent()};h(n.getContainer(),this._buildMarkup(this._options.areaTemplate,{outer:this._options,enabled:n._options.enabled,visible:n._options.visible,item:i,index:a,contentExistence:"cached"!==this._options.loadType||this._options.defaultArea===i.id},void 0,void 0,this._getAreaMarkupContext(n)))}if("all"===this._options.loadType)for(a=0;a<t;a++)e[a].loadChildControls();else if(this._currentAreaId)this.getItemById(this._currentAreaId).loadChildControls();if(this._currentAreaId)this.getItemById(this._currentAreaId).getContainer().removeClass("ws-hidden")},validateAreas:function(){for(var e=this.getItems(),t,a=0,n=e.length;a<n;a++)if(!e[a].validate(false,true))t=void 0!==t?t:e[a].getId();return t},_destroyAreas:function(){for(var e=this.getItems(),t=e.length,a,n=0;n<t;n++)(a=e[n]).unsubscribe("onIdChanged",this._bindedHandlers.handleItemIdChanged),a.unsubscribe("onContentChanged",this._bindedHandlers.handleItemContentChanged),a.destroyChildControls(),a.setLoaded(false),a._clearContainer(),a.destroy()},destroy:function(){this._destroyAreas(),d.superclass.destroy.apply(this,arguments)}});return d});