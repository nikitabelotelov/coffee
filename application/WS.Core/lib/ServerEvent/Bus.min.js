define("Lib/ServerEvent/Bus",["require","exports","Core/Deferred","Core/constants","Core/EventBus","Core/LocalStorageNative","Core/IoC","Lib/ServerEvent/_class/Constants","Lib/ServerEvent/_class/logger/WatchDogAggregator","Lib/ServerEvent/_class/Subscribe","Lib/ServerEvent/_class/SubscribeContainer","Lib/ServerEvent/_class/transport/ExclusiveProxy","Lib/ServerEvent/_class/Events","Lib/ServerEvent/_class/logger/ConnectWatchDog"],function(e,s,i,r,t,n,c,o,b,u,a,h,l,f){"use strict";n.setItem("shared-bus-ack","true");var v=[o.CHANNEL_SCOPE.GLOBAL],d=function(){function e(e){if(void 0===e)e="Это приложение не имеет серверных событий";this.message=e}return e}(),p,C=new(function(){function e(){this.subscribes=new a.SubscribeContainer,this.isExclusive=false,this.watcher=new b.WatchDogAggregator([new f.ConnectWatchDog]),this.subsDeferred=new i,this.subscribe=this.subscribeInit.bind(this),this.closeChannel=this.closeChannel.bind(this),this.closeTransportBehavior=this.closeTransportBehavior.bind(this)}return e.prototype.subscribe=function(e){},e.prototype.subscribeClear=function(e,s){if(this.subscribes.has(s))return;this.subscribes.add(s);try{e.subscribe(s)}catch(e){if("SubscribeExclusiveError"!==e.name)throw e;this.isExclusive=true,this.reconnect()}},e.prototype.subscribeBeforeReconnect=function(e){if(this.subscribes.has(e))return;this.subscribes.add(e)},e.prototype.subscribeDeferred=function(s){var r=this;this.subsDeferred.addCallback(function(e){return r.subscribeClear(e,s),e})},e.prototype.subscribeInit=function(r){var t=this;this.subscribe=this.subscribeDeferred,this.subscribeDeferred(r);try{h.ExclusiveProxy.init(this.isExclusive||r.getDeliveryType()!==o.DELIVERY_COMMON,this.closeTransportBehavior,this.watcher).addCallback(function(e){t.subscribe=t.subscribeClear.bind(t,e),t.subsDeferred.callback(e)}).addErrback(function(e){if(404===e.httpError)return c.resolve("ILogger").warn((new d).message),void(t.subscribe=function(){});t.subscribe=t.subscribeInit;var s=t.subsDeferred;t.subsDeferred=new i,s.dependOn(t.subsDeferred),c.resolve("ILogger").warn("Не удалось подписаться на "+r.getChannelName())})}catch(e){this.subscribe=function(){}}},e.prototype.addWatchDog=function(e){this.watcher.reg(e)},e.prototype.closeTransportBehavior=function(e){if(this.watcher.logDisconnect(e),e===l.EVENT_DISABLE_SEB)return;this.reInit()},e.prototype.reInit=function(){this.subsDeferred=new i,this.subscribe=this.subscribeInit;var e=this.subscribes.all();this.subscribes.clear();for(var s=0,r=e;s<r.length;s++){var t=r[s];this.subscribe(t)}},e.prototype.reconnect=function(){var s=this;if(!this.subsDeferred)return this.reInit();this.subsDeferred.addCallbacks(function(e){return s.subscribe=s.subscribeBeforeReconnect.bind(s),e.close(),e},function(){s.reInit()})},e.prototype.closeChannel=function(n){var c=this;this.subsDeferred.addCallback(function(e){for(var s,r=0,t=c.subscribes.removeByName(n);r<t.length;r++){var i=t[r];e.unsubscribe(i)}return e})},e}());function g(e,s){var i=e.toLocaleLowerCase(),r=t.channel(i),n=s||{};return setTimeout(function(){if(!n.isChanneled)return void C.subscribe(u.Subscribe.create(i,n.isChanneled,n.exclusive));if(!n.scopes)c.resolve("ILogger").error("В канализированных событиях необходимо указать options.scopes.             https://wi.sbis.ru/docs/js/Lib/ServerEvent/Bus/typedefs/ConnectOptions/?v=3.18.10");for(var e,s=0,r=n.scopes||v;s<r.length;s++){var t=r[s];C.subscribe(u.Subscribe.createRaw(i,n.isChanneled,n.exclusive,t))}},0),r}if(g["reconnect"]=function(){C.reconnect()},g["close"]=function(e){C.closeChannel(e)},g["SCOPE"]=o.CHANNEL_SCOPE,t["addWatchDog"]=function(e){C.addWatchDog(e)},r.isBrowserPlatform)t["serverChannel"]=g;else t["serverChannel"]=function(e){return t.channel(e)};return t});