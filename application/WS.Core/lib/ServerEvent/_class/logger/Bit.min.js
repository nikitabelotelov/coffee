define("Lib/ServerEvent/_class/logger/Bit",["require","exports","Transport/RPCJSON","Core/UserInfo"],function(t,e,a,u){"use strict";Object.defineProperty(e,"__esModule",{value:true});var i="sbis.page.ping",d="/test_client_service/service/",h="ClientEventTest.Record",s=6*60*1e3,f=function(){function t(t,e){if(void 0===e)e=Date.now();this.num=t,this.timestamp=e}return t.compare=function(t,e){if(t.num>e.num)return 1;if(t.num<e.num)return-1;return 0},t}(),n=function(){function n(t){var e=this;if(this.lastPingNum=0,this.pings=[],!window)return;this.tabId=n.generateID(),this.appendPing=this.appendPing.bind(this),this.detectAfterReconnect=this.detectAfterReconnect.bind(this),t.serverChannel(i).subscribe("onready",function(){e.lastConnect=Date.now()}),t.serverChannel(i).subscribe("onmessage",this.appendPing),t.serverChannel(i).subscribe("ondisconnect",function(){if(e.lastDisconnect=Date.now(),e.detectMode)clearTimeout(e.detectMode);e.detectMode=setTimeout(e.detectAfterReconnect,s)})}return n.prototype.appendPing=function(t,e){var n=this.lastPingNum;if(this.lastPingNum=e,this.detectMode)return void this.pings.push(new f(e));if(n+1==e||0==e||0==n)return;var i=u.get("ИдентификаторПользователя"),s="skip",r;if(n+1>e)s="wrong order";new a({serviceUrl:d,asyncInvoke:true}).callMethod(h,{data:{m:s,userId:i,tab:this.tabId,last:n,current:e,detected:Date.now(),connect:this.lastConnect,disconnect:this.lastDisconnect}})},n.prototype.detectAfterReconnect=function(){if(0===this.pings.length)return;for(var t=u.get("ИдентификаторПользователя"),e=this.pings.sort(f.compare),n=e.shift(),i=0,s=e;i<s.length;i++){var r=s[i];if(n.num+1===r.num){n=r;continue}var c={m:"skip",userId:t,tab:this.tabId,last:n.num,current:r.num,detected:r.timestamp,connect:this.lastConnect,disconnect:this.lastDisconnect};n=r;try{var o;new a({serviceUrl:d,asyncInvoke:true}).callMethod(h,{data:c})}catch(t){}}this.pings=[],this.lastPingNum=n.num,this.detectMode=void 0},n.generateID=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()},n}();e.Bit=n});