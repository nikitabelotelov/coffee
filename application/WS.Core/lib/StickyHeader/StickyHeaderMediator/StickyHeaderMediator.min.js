define("Lib/StickyHeader/StickyHeaderMediator/StickyHeaderMediator",["Core/Abstract","Env/Event","Env/Env","Core/helpers/Hcontrol/isElementVisible","Core/core-instance","Core/helpers/Function/runDelayed","Lib/StickyHeader/StickyHeaderManager/StickyHeaderManager"],function(e,t,c,r,l,d,f){"use strict";var o=false,u=[],a=[],s=[],b=function(t,r){return function(e,i){var n=$(i).closest(r);return!n.length||n[0]===t}},i=new(e.extend({$constructor:function(){},documentReady:function(e,i){var n=i&&i.error;if(n)c.IoC.resolve("ILogger").error("StickyHeaderMediator",n&&n.message||n);else this._subscribeCommonEvents(),this._initFixation()},_subscribeCommonEvents:function(){if(!o){var n=this,e=t.Bus.globalChannel(),i=function e(){n._resizeHandler()};$(window).bind("resize",i),this.subscribeTo(t.Bus.channel("navigation"),"onAccTransform",i),this.subscribeTo(e,"onWindowCreated",function(e,i){i.subscribe("onAfterShow",function(){n._initFixation(i.getContainer()),i.subscribe("onBeforeClose",function(e){if(false!==e.getResult())n._unfixChildren(i.getContainer(),true)})})}),this.subscribeTo(e,"onFloatAreaCreating",function(e,i){if(n.subscribeTo(i,"onAfterShow",function(){if(i.getProperty("isStack")&&1===i.getContainer().closest(".ws-sticky-header__scrollable-container").length)n._initFixation(i.getContainer()),n.subscribeTo(i,"onBeforeClose",function(e){if(false!==e.getResult())n._unfixChildren(i.getContainer().closest(".ws-sticky-header__scrollable-container"),true)}),n.subscribeTo(i,"onChangeMaximizeState",function(e){n._resizeHandler(i.getContainer())})}),i.getProperty("showOnControlsReady"))n.subscribeTo(i,"onBeforeShow",function(e){this.getContainer().find(".ws-sticky-header__scrollable-container").each(function(e,i){n._findHeaderElements($(i))})})}),this.subscribeTo(t.Bus.channel("stickyHeader"),"onForcedStickHeader",function(e,i){n._initFixation(i)}),o=true}},_initFixation:function(e){var t=this,i=function e(i,n){t._findHeaderElements($(n))};if(e){this._initChangeableAreas(e);var n=e.closest(".ws-sticky-header__scrollable-container"),r;if(n.length)i(0,n[0]);e.find(".ws-sticky-header__scrollable-container").each(i)}else this._initChangeableAreas($("body")),$(".ws-sticky-header__wrapper > .ws-sticky-header__scrollable-container").each(i)},_findHeaderElements:function(e){if(!e.hasClass("ws-sticky-header__scrollable-container"))throw new Error("Lib/StickyHeader/StickyHeaderMediator/StickyHeaderMediator::_findHeaderElements - incorrect container fixation");var a=this,i=e.find(".ws-sticky-header__block:not(.ws-sticky-header__registered), .ws-sticky-header__table:not(.ws-sticky-header__registered)"),s=function(e,i,n){e._updateTableHeaderVisibility(n),e._resizeHandler.bind(i,n)},n=b(e[0],".ws-sticky-header__scrollable-container");if((i=i.filter(n)).each(function(e,i){var n=$(i),t=n.hasClass("ws-sticky-header__table"),r=n.wsControl(),o;if(r)if(-1===u.indexOf(r)){if(a.subscribeTo(r,"onDestroy",function(){a._unfixChildren(r.getContainer(),true);var e=u.indexOf(r);u.splice(e,1)}),a.subscribeTo(r,"onAfterVisibilityChange",function(e,i){if(i)a._initFixation(r.getContainer());else a._unfixChildren(r.getContainer(),true)}),a.subscribeTo(r,"onResize",function(){if(r._runBatchDelayedFunc("stickyResize",a._resizeHandler.bind(this,r.getContainer())),l.instanceOfModule(r,"SBIS3.CONTROLS/ScrollContainer"))d(function(){a._resizeHandler(r.getContainer().children(".ws-sticky-header__scrollable-container"))})}),l.instanceOfModule(r,"SBIS3.CONTROLS/Browser"))if(o=r.getView(),l.instanceOfMixin(o,"SBIS3.CONTROLS/Mixins/TreeMixin")||l.instanceOfMixin(o,"SBIS3.CONTROLS/Mixins/hierarchyMixin"))a.subscribeTo(o,"onSetRoot",function(){a._resizeHandler(r.getContainer())});if(t&&l.instanceOfModule(r,"SBIS3.CONTROLS/DataGridView"))if(a.subscribeTo(r,"onDrawHead",function(){if(a._dataGridViewDrawHeadHandler(n),c.detection.safari)s(a,this,n);else d(function(){s(a,this,n)})}),a.subscribeTo(r,"onDrawItems",function(){if(c.detection.safari)f.synchronizeTableHeaderColumnWidth(n);else d(function(){f.synchronizeTableHeaderColumnWidth(n)})}),a.subscribeTo(r,"onChangeHeadVisibility",function(){a._initFixation(r.getContainer()),a._updateTableHeaderVisibility(n)}),l.instanceOfMixin(r,"SBIS3.CONTROLS/Mixins/CompositeViewMixin"))a.subscribeTo(r,"onViewModeChanged",function(e){if("table"===r.getViewMode())a._initFixation(r.getContainer());else a._unfixChildren(r.getContainer(),true)});u.push(r)}}),a._initChangeableAreas(e),r(e))this._fixChildren(e,i)},_initChangeableAreas:function(e){var t=this,i=b(e[0],".ws-sticky-header__scrollable-container"),n,r;e.find(".ws-SwitchableArea").filter(i).each(function(e,i){var n=$(i).wsControl();if(-1===a.indexOf(n))a.push(n),t.subscribeTo(n,"onBeforeChangeActiveArea",function(e,i){if(i)t._unfixChildren(i.getContainer(),true)}),t.subscribeTo(n,"onAfterChangeActiveArea",function(e,i){t._initFixation(i.getContainer())}),t.subscribeTo(n,"onDestroy",function(){var e=a.indexOf(n);a.splice(e,1)})}),e.find(".ws-templatedArea").filter(i).each(function(e,i){var n=$(i).wsControl();if(-1===s.indexOf(n))s.push(n),t.subscribeTo(n,"onAfterShow",function(){t._initFixation(n.getContainer())}),t.subscribeTo(n,"onDestroy",function(){var e=s.indexOf(n);s.splice(e,1)}),t.subscribeTo(n,"onBeforeChangeActiveArea",function(){t._unfixChildren(n.getContainer(),true)})})},_fixChildren:function(e,i){if(!i||!i.length||1===i.length&&$(i[0]).is("#header"))return;f.fixAllChildren(e,i)},_unfixOne:function(e,i){f.unfixOne(e,i)},_unfixChildren:function(e,i){f.unfixAllChildren(e,i)},_resizeHandler:function(e){f.checkStickyHeaderSize(e)},_dataGridViewDrawHeadHandler:function(e){f.tableHeadRedrawn(e)},_updateTableHeaderVisibility:function(e){f.updateTableHeaderVisibility(e)}}));t.Bus.globalChannel().subscribe("bootupReady",i.documentReady.bind(i))});