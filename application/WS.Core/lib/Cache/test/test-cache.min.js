define("Lib/Cache/test/test-cache",["Lib/Cache/Cache","Core/Deferred"],function(r,o){describe("Lib/Cache/Cache",function(){var n;afterEach(function(){if(n)n.destroy()}),it("getItem calls factory",function(e){(n=r.getByName("testCache",100,function(t){var e=new o;return setTimeout(function(){e.callback(t+"data")},5),e})).getItem("key1").addCallback(function(t){expect(t).toEqual("key1data"),e()})}),it("For the same key factory is not called twice",function(){var t={factory:function(t){var e=new o;return setTimeout(function(){e.callback(t+"data")},5),e}};spyOn(t,"factory").and.callThrough(),(n=r.getByName("testCache",100,t.factory)).getItem("key1"),n.getItem("key1"),expect(t.factory.calls.count()).toEqual(1)}),it("For the same key factory is not called twice unless data is expired",function(t){var e={factory:function(t){var e=new o;return setTimeout(function(){e.callback(t+"data")},5),e}};spyOn(e,"factory").and.callThrough(),(n=r.getByName("testCache",100,e.factory)).getItem("key1"),setTimeout(function(){n.getItem("key1"),expect(e.factory.calls.count()).toEqual(2),t()},1e3)}),it("Error results is not cached",function(){var a=0,t={factory:function(t){if(0===a++)return(new o).errback("xxx");var e=new o;return setTimeout(function(){e.callback(t+"data")},5),e}};spyOn(t,"factory").and.callThrough(),(n=r.getByName("testCache",100,t.factory)).getItem("key1"),n.getItem("key1"),n.getItem("key1"),expect(t.factory.calls.count()).toEqual(2)}),it("Error result can store data",function(e){var c=0,a={factory:function(t){if(0===c++){var e=new Error("xxx");return e.data="key1error",(new o).errback(e)}var a=new o;return setTimeout(function(){a.callback(t+"data")},5),a}};spyOn(a,"factory").and.callThrough(),(n=r.getByName("testCache",100,a.factory)).getItem("key1").addCallback(function(t){expect(t).toEqual("key1error"),n.getItem("key1").addCallback(function(t){expect(t).toEqual("key1data"),expect(a.factory.calls.count()).toEqual(2),e()})})}),it("If expire==-1 data is never expired",function(t){var e={factory:function(t){var e=new o;return setTimeout(function(){e.callback(t+"data")},5),e}};spyOn(e,"factory").and.callThrough(),(n=r.getByName("testCache",-1,e.factory)).getItem("key1"),setTimeout(function(){n.getItem("key1"),expect(e.factory.calls.count()).toEqual(1),t()},1e3)}),it("If expire==0 data is instantly expired",function(){var t={factory:function(t){var e=new o;return setTimeout(function(){e.callback(t+"data")},5),e}};spyOn(t,"factory").and.callThrough(),(n=r.getByName("testCache",0,t.factory)).getItem("key1"),n.getItem("key1"),expect(t.factory.calls.count()).toEqual(2)}),it("if purge()'ed, every key is removed",function(){var t={factory:function(t){var e=new o;return setTimeout(function(){e.callback(t+"data")},5),e}};spyOn(t,"factory").and.callThrough(),(n=r.getByName("testCache",1e3,t.factory)).getItem("key1"),n.getItem("key2"),n.purge(),n.getItem("key1"),n.getItem("key2"),expect(t.factory.calls.count()).toEqual(4)}),it('if purge("keyName")\'ed, only specified key is removed',function(){var t={factory:function(t){var e=new o;return setTimeout(function(){e.callback(t+"data")},5),e}};spyOn(t,"factory").and.callThrough(),(n=r.getByName("testCache",1e3,t.factory)).getItem("key1"),n.getItem("key2"),n.purge("key1"),n.getItem("key1"),n.getItem("key2"),expect(t.factory.calls.count()).toEqual(3)})})});