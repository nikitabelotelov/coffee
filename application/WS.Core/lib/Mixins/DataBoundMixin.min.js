define("Lib/Mixins/DataBoundMixin",["Core/helpers/Number/randomId","Core/IoC","Core/ConsoleLogger","i18n!Lib/Mixins/DataBoundMixin"],function(t,s){return DataBoundMixin={$protected:{_contextUpdateHandlerFunction:null,_validating:false,_defaultValue:void 0,_initialValueSetted:false,_validationErrorCount:0,_prevValidationResult:true,_vResultErrors:[],_options:{value:"",errorMessage:"",titleErrorMessage:[rk("Ошибка"),rk("Ошибки")],errorMessageFilling:rk("Введите значение"),validators:[],loadValueFromContextToConstructorOptions:false}},$constructor:function(){if(this._publishEvents(),this._contextUpdateHandlerFunction=this._contextUpdateHandler.bind(this),this.setTitleErrorMessage(this._options.titleErrorMessage),!this._options.name)this._options.name="name-"+this.getId()+"-"+t()},around:{_isCanShowExtendedTooltip:function(){return Array.prototype.shift.call(arguments).apply(this,arguments)||this.isMarked()}},instead:{_alterTooltipText:function(t){if(this.isMarked()){var e=this._options.errorMessage instanceof jQuery?this._options.errorMessage[0].outerHTML:this._options.errorMessage,i=this._validationErrorCount>1?this._options.titleErrorMessage[1]:this._options.titleErrorMessage[0];return("string"==typeof t&&t.length?"<p>"+t+"</p>":"")+'<p><span class="ws-validation-error-message">'+i+":</span> "+e+"</p>"}else return t}},before:{init:function(){if(this._context)this._context.subscribe("onDataBind",this._contextUpdateHandlerFunction),this._context.subscribe("onFieldChange",this._contextUpdateHandlerFunction);if(this._initDefaultValue(),this._contextUpdateHandler(),void 0===this.getValue())this._defaultValueHandler();if(void 0===this.getValue())this._curval=this._curValue(),this._updateSelfContextValue(this._notFormatedVal());this._markInitialValueSetted()},destroy:function(){if(this._context)this._context.unsubscribe("onDataBind",this._contextUpdateHandlerFunction),this._context.unsubscribe("onFieldChange",this._contextUpdateHandlerFunction);this._getInfobox(function(t){if(t.hasTarget()&&t.isCurrentTarget(this._getExtendedTooltipTarget()))t.hide()}.bind(this))}},_notifyOnValueChange:function(t){if(this._initialValueSetted){if(!(t instanceof Array))t=[t];else t=t.slice(0);t.unshift("onValueChange"),this._notify.apply(this,t)}},_markInitialValueSetted:function(){this._initialValueSetted=true},_contextUpdateHandler:function(t,e,i,n){var r=this._options.name;if(!!r&&this._context&&this!==n)if(e){if(this._context.isFieldSameOrSubField(r,e))this._onContextValueReceived(this._context.getValue(r))}else this._onContextValueReceived(this._context.getValue(r))},_publishEvents:function(){this._publish("onValidate","onValueChange")},_initDefaultValue:function(){this._defaultValue=this._getDefaultValue()},_updateSelfContextValue:function(t){if(this._options.name)this.getLinkedContext().setValue(this._options.name,t,void 0,this)},_defaultValueHandler:function(){var t=this.getDefaultValue();if(void 0!==t&&this.setValue)this.setValue(t,true,true)},_getDefaultValue:function(){return},getValue:function(){var t=this._options.name;return t?this.getLinkedContext().getValue(t):void 0},getDefaultValue:function(){return this._defaultValue},_curValue:function(){},_notFormatedVal:function(){},setTitleErrorMessage:function(t){this._options.titleErrorMessage=t instanceof Array?t:[t,t]},_canValidate:function(){var t=this.getValidators();return t&&t.length>0},_invokeValidation:function(){for(var t={errors:[],result:true},e=0,i=this._options.validators.length;e<i;e++){var n=this._options.validators[e],r=!(n.noFailOnError||false),o=false;try{o=n.validator.apply(this,n.params||[])}catch(t){s.resolve("ILogger").log("Control with name "+this.getName(),"Exception while validating "+t.message)}if(true!==o)if(o=n.errorMessage?n.errorMessage:o,t.errors=t.errors.concat(o),r)t.result&=false}return t},validate:function(){var e,t=this.getContainer(),i=this._prevValidationResult;if(this.clearMark(),this._validating||!this._canValidate()||!t||true===t.hasClass("ws-hidden"))return true;try{this._validating=true,e=this._invokeValidation()}catch(t){e={errors:[t.message],result:false}}finally{this._validating=false}if(e.errors.length>0)this.markControl(e.errors);return this._calcPrevValidationResult(),this._notify("onValidate",!!e.result,e.errors,i),this._vResultErrors=e.errors,e.result},_createErrorMessage:function(t){var e;if(t instanceof Array&&1==t.length)e=t[0];else if(t instanceof Array){e=$("<ul></ul>");for(var i=0,n=t.length;i<n;i++)e.append("<li>"+t[i]+"</li>")}else e=t;this._options.errorMessage=e},_handlersPath:function(t){var e=this.getEventHandlers(t),i=[];if(e)for(var n=0,r=e.length;n<r;n++)if(e[n].wsHandlerPath)i.push(e[n].wsHandlerPath);return i},_calcValidationErrorCount:function(t){this._validationErrorCount=t instanceof Array?t.length:1},_calcPrevValidationResult:function(){this._prevValidationResult=!this.isMarked()},markControl:function(t,e){var i=t&&("string"==typeof t||t instanceof Array&&t.length)?t:this._options.errorMessageFilling;if(this._calcValidationErrorCount(i),this._createErrorMessage(i),true===e)this._getInfobox(function(t){t.show(this._getExtendedTooltipTarget(),this._alterTooltipText(),"auto")}.bind(this));this._container.addClass("ws-validation-error")},clearMark:function(){if(this._validationErrorCount)this._validationErrorCount=0,this._options.errorMessage="",this._container.removeClass("ws-validation-error"),this._getInfobox(function(t){if(t.hasTarget()&&t.isCurrentTarget(this._getExtendedTooltipTarget()))if(this._isCanShowExtendedTooltip())this._showExtendedTooltip(true);else t.hide(0)}.bind(this))},isMarked:function(){return!!this._validationErrorCount},_onContextValueReceived:function(t){},getValidators:function(){return this._options.validators},setValidators:function(t){if(t&&"[object Array]"==Object.prototype.toString.apply(t))this._options.validators=t},getErrorMessage:function(){return this._options.errorMessage},setErrorMessage:function(t){this._options.errorMessage=t},getErrorMessageFilling:function(){return this._options.errorMessageFilling},setErrorMessageFilling:function(t){this._options.errorMessageFilling=t},_getInfobox:function(e){var t="Lib/Control/Infobox/Infobox";if(requirejs.defined(t))return e(requirejs(t));else requirejs([t],function(t){return e(t)})}}});