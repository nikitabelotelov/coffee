define("Lib/FloatAreaManager/FloatAreaManager",["Core/constants","Core/Deferred","Core/WindowManager","Core/EventBus","Core/helpers/Function/shallowClone","Core/core-instance","Lib/LayoutManager/LayoutManager","Core/helpers/Object/find","Core/helpers/Array/findIndex","Core/helpers/Function/memoize","Core/helpers/Hcontrol/getScrollWidth","Core/dom/wheel","Core/Abstract","css!Lib/FloatAreaManager/FloatAreaManager"],function(r,n,t,s,o,a,e,l,h,i,d,c){"use strict";var f="Lib/Control/FloatArea/FloatArea",_=r.browser.chrome&&!r.browser.isMobilePlatform,u=.05,g=50,w=50,m=10,v=1e3,p=700,b=_&&!r.browser.isMobileSafari&&r.compatibility.cssTransform&&r.compatibility.cssAnimations;function A(){return"undefined"!==typeof window&&(A.value||(A.value=$("body")))}function C(){return"undefined"!==typeof window&&(C.value||(C.value=$("#min-width")))}function S(t,e,i){if(t<e)t=e;if(t>i)t=i;return t}var y=function(){this.size={width:0,height:0}};(y.prototype={control:void 0,right:0,methods:void 0,hideSideBar:true,id:"",scrollTop:0,preparedToShow:false}).width=function(){return this.control._containerShadow.width()};var W={_areas:{},_areaInfos:{},_$content:void 0,_contentIsBody:true,_$contentParent:void 0,_$sideBar:void 0,_sideBarVisible:true,_sideBarWidth:0,_stack:[],_topFloatArea:null,_maximizedWindows:[],_scrollableContainers:{},_$floatAreaContainer:void 0,_floatAreaContainerWidth:0,_settingAreaSize:false,_$rightShadow:void 0,_maxContentWidth:0,_hasAnyFloatArea:false,_animationLength:0,_panelHideAnimationDelay:0,_minContentWidth:v,_animationQueue:void 0,_transitionEndHandler:void 0,_prevBodyMargin:void 0,_isCalculatingVariables:false,_getFloatAreaContentRoot:function(){var t=$(".ws-float-area-stack-root:first");if(0===t.length)t=$("body");return t},_getFloatAreaBodyContainerRoot:i(function(){var t;if(!$(".vdom-black-box").length)if($(".ws-focus-in").length)return $('<div class="ws-float-area-body-container-root"></div>').insertAfter(".ws-focus-in");else return $('<div class="ws-float-area-body-container-root"></div>').prependTo("body");else return $('<div class="ws-float-area-body-container-root"></div>').appendTo(".vdom-black-box")},"_getFloatAreaBodyContainerRoot"),_bodyCanScroll:function(){return 0!==this._bodyScrollWidth()},_bodyScrollWidth:i(function(){var t=A().css("overflow-y");return"hidden"!==t&&"visible"!==t?d():0},"_bodyScrollWidth"),_fixCss3TransitionEndEvent:function(t,a,n,e){function o(t){var e=""+t,i=""+n;if("matrix(1, 0, 0, 1, 0, 0)"===e)e="translateX(0px)";return e===i||"0"===e&&"0px"===i||"0px"===e&&"0"===i}var r=Math.max(3*e,p);setTimeout(function(){var e=$(t),i=+new Date,n;if(o(e.css(a)))e.trigger("transitionend");else n=setInterval(function(){if(o(e.css(a)))clearInterval(n),e.trigger("transitionend");else{var t;if(+new Date-i>r)clearInterval(n)}},50)},e)},_addToAnimationQueue:function(i,t){return t.addBoth(function(t){var e=n.fromTimer(p);return n.nearestOf([i,e])})},_init:function(){this._calcVariables(),$(window).bind("resize.wsFloatAreaManager",this._resize.bind(this)),t.subscribe("onAreaFocus",this._focusMoved.bind(this)),s.channel("navigation").subscribe("onAccTransform",this._onAccTransform.bind(this))},_calcVariables:function(){if(!this._isCalculatingVariables){if(this._animationQueue=n.success(void 0),this._$content)this._$content.unbind("transitionend");if(this._$content=this._getFloatAreaContentRoot(),this._$vdomContent=$(".controls-Popup__stack-target-container"),this._$content.bind("transitionend",function(){if(this._transitionEndHandler){var t=this._transitionEndHandler;this._transitionEndHandler=void 0,t.call(this)}}.bind(this)),this._maxContentWidth=this._$content.parents().toArray().reduce(function(t,e){var i=$(e).css("max-width"),n;if(-1===i.indexOf("%"))n=parseInt(i,10);if(!isNaN(n)&&n>0)if(n<t)t=n;return t},parseInt(this._$content.css("max-width"),10)||1/0),this._maxContentWidth===1/0)this._maxContentWidth=document.body.clientWidth;this._contentIsBody=this._$content.is("body"),this._isNewPageTemplate=$("body").hasClass("ws-new-page-template"),this._$contentParent=this._contentIsBody||this._isNewPageTemplate?this._$content:this._$content.parent(),this._$sideBar=$(".ws-float-area-stack-sidebar, .navSidebar__sideLeft, .online-Sidebar"),this._sideBarWidth=this._$sideBar.width()||0,this._$rightShadow=$(".ws-float-area-stack-right-shadow")}},_onAccTransform:function(){var t=this._$sideBar.width()||0;if(t>0)this._sideBarWidth=t,this._calcSizeParams.reset()},scrollParentFloatArea:function(e,t){function i(t,e){return t.scrollHeight>t.offsetHeight&&/auto|scroll/.test($(t).css("overflow-y"))&&(e<0&&0!==t.scrollTop||e>0&&t.scrollTop!==t.scrollHeight-t.clientHeight)}function a(t,e){if(i(t,e))return true;return t.parents().filter(function(){return!!i(this,e)}).length}function n(t){var e=$(t.target,document),i=-t.wheelDelta;if(!a(e,i)){t.stopPropagation(),t.preventDefault();var n=$(o);n.scrollTop(n.scrollTop()+i)}}if(!e||!t)return null;var o=t.parents().filter(function(){return $(this).is(".ws-float-area-stack-scroll-wrapper")});if(!o.length)return null;return c($(e),n),function(){var t=r.compatibility.wheel;$(e).unbind(t,n)}},_getPanelHideAnimationDelay:function(){return 1===this._stack.length?this._panelHideAnimationDelay:0},_useAnimation:function(){return _},_useCss3:function(){return b},_updateAreaPositions:function(){for(var t in this._areas)if(this._areas.hasOwnProperty(t)){var e=this._areas[t];if(e.isVisible()&&!e._options.isStack)e._recalcPosition()}},_resetWindowSizes:function(){this._getWindowHeight.reset(),this._calcSizeParams.reset()},_resize:function(){var t=this._$sideBar.width()||0;if(0!==t)this._sideBarWidth=t;this._recalculateShadow();var e=function(){for(var t in this._resetWindowSizes(),this._areas)if(this._areas.hasOwnProperty(t))this._areas[t]._sizeUpdated(true);this._updateSideBarVisibility()}.bind(this);this._resetEmptyPaddingState(),e(),e()},_getWindowHeight:i(function(){return r.$win.height()},"_getWindowHeight"),setContentMinWidth:function(t){this._minContentWidth=t+this._sideBarWidth+16||v,C().css("min-width",this._minContentWidth),this._resize()},_getPanelRootPaddingRight:function(t,e){if(this._$vdomContent.length)return window.innerWidth-this._$vdomContent[0].getBoundingClientRect().right;t._updateMinMaxWidthHeight();var i=A().get(0).getBoundingClientRect().right,n=this._$contentParent.get(0),a=this._needBodyRight(t)||!n,o=Math.ceil(a?i:n.getBoundingClientRect().right),r=e?this._bodyCanScroll()||d():0,s=Math.max(0,i-o-r),l=parseInt(t._container.prop("style").width,10),h=this._hasAreaWithEmptyPadding()||document.body.clientWidth<l+s,c=this._areaInfos[t.getId()];if(c)c.isEmptyPadding=h;return h?0:s},_hasAreaWithEmptyPadding:function(){var e=false,i=this._areaInfos;return Object.keys(i).forEach(function(t){if(i[t].isEmptyPadding)e=true}),e},_resetEmptyPaddingState:function(){var e=this._areaInfos;Object.keys(e).forEach(function(t){e[t].isEmptyPadding=false})},_calcSizeParams:i(function(){var t,e=S(r.$win.width()-d(),this._minContentWidth,this._maxContentWidth),i;return{contentWidth:e,minimumPanelDistance:Math.floor(e*u+this._sideBarWidth),minimumPanelDistanceNoAcc:Math.floor(e*u)}},"_calcSizeParams"),_canHideSidebar:function(){return this._sideBarWidth>0},_updateSideBarVisibility:function(){var t,e,i,n,a,o;function r(t){return s.channel("navigation").notify("accordeonVisibilityStateChange",t)}if(this._canHideSidebar())if(t=this._calcSizeParams(),e=this._stack.reduce(function(t,e){return Math.max(t,e.width())},0),(i=t.contentWidth-e>=t.minimumPanelDistance)!==this._sideBarVisible)this._sideBarVisible=i,r(this._sideBarVisible),$(window).trigger("resize")},_getMaxWidthForAreaNew:function(t,e,i){var n=t._options,a=Math.min(this._getMaxPanelWidth(i),n.maxWidth);if(a<e)return e;else if(a<w)return w;return a},_getMaxPanelWidth:function(t){var e=this._calcSizeParams();return e.contentWidth-(t?e.minimumPanelDistanceNoAcc:e.minimumPanelDistance)},_getMaxWidthForArea:function(e,t){var i=this._calcSizeParams(),n=h(this._stack,function(t){return t.control===e}),a=-1!==n?n-1:this._stack.length-1,o=-1!==a?this._stack[a].width():i.contentWidth,r=e._options,s,l;switch(a){case-1:s=i.minimumPanelDistance;break;case 0:s=g;break;default:s=m}if(r.autoWidth||r.maxWidth!==1/0){if(l=Math.max(o-s,w),-1===a&&l<t)l=Math.max(o-i.minimumPanelDistanceNoAcc,w)}else l=Math.max(i.contentWidth-i.minimumPanelDistanceNoAcc,w);return l},_hideAreaWithParents:function(t,e){var i;if(!t.isDestroyed()&&t.isVisible()){if(t.hide(true),i=t.getOpener())i=i.getParentByClass(f);else i=t.getParentByClass(f);if(i&&i.isVisible()&&i.isAutoHide()&&!i.isLockShowed()&&i.getId()in e)this._hideAreaWithParents(i,e)}},_hideUnnecessaryAreas:function(t){var e={},i=o(this._areas);for(var n in i)if(i.hasOwnProperty(n)){var a=i[n];if(a&&t!==a&&a.isVisible()&&a.isAutoHide()&&a._shouldHideByFocusMoveTo(t))e[a.getId()]=true}this._hideAreas(i,e)},_hideDependentAreas:function(t){var e={},i=o(this._areas);for(var n in i)if(i.hasOwnProperty(n)){var a=i[n];if(a&&a.getOpener()&&a.getOpener()===t)e[a.getId()]=true}this._hideAreas(i,e)},_hideAreas:function(t,e){var i=this;for(var n in e)if(e.hasOwnProperty(n))i._hideAreaWithParents(t[n],e)},_focusMoved:function(t,e){if(this._needHideAreas(e))this._hideUnnecessaryAreas(e);this._prevArea=e},_needHideAreas:function(t){if(!this._prevArea)return false;var e=a.instanceOfModule(this._prevArea,f)||this._prevArea.getParentByClass(f),i,n;if(this._prevArea.getContainer)i=this._prevArea.getContainer().closest(".ws-float-area, .controls-FloatArea").length;if(t.getContainer)n=t.getContainer().closest(".controls-FloatArea__ignoreFocus").length;return!n&&(e||i)},_beforeShowStarted:function(t){if(t._options.isStack){var e=t.getId(),i=this._areaInfos[e];if(i.preparedToShow=false,this._hideUnnecessaryAreas(i.control),r.browser.isMobilePlatform)this._setTopFloatAreaWebkitOverflowScrolling("auto");if(this._stack.push(i),r.browser.isMobilePlatform){var n=this._setTopFloatAreaWebkitOverflowScrolling("touch"),a=false===n?false:n.getContainer();this._strictOverflowScrollingOnScrollContainersUnderTopFloatArea(a)}this._checkToggleContentScroll()}},_showStarted:function(t){if(t._options.isStack){var e=t.getId(),i=this._areaInfos[e];if(1===this._stack.length)this._animationLength=i.control._options.animationLength,this._panelHideAnimationDelay=_?Math.max(10,.1*this._animationLength):0;if(_)this._updateSideBarVisibility();i.preparedToShow=true}},_finishShow:function(t){if(t._options.isStack)if(this._stack.length>1)this._hideShadow(this._areaInfos[t.getId()]);this._updateSideBarVisibility()},_hideShadow:function(t){for(var e=t.control.getContainer().width(),i=0,n=this._stack.length-1;i<n;i++){var a=this._stack[i].control;if(a!==t.control&&a.getContainer().width()===e)this._toggleAreaShadow(a,false)}},_showShadow:function(t){for(var e=t.control.getContainer().width(),i=this._stack.length-1;i>-1;i--){var n=this._stack[i].control;if(n.getContainer().width()===e)return void this._toggleAreaShadow(n,true)}},_toggleAreaShadow:function(t,e){t.getContainer().closest(".ws-float-area-stack-panel-shadow").toggleClass("ws-float-area-stack-panel-no-shadow",!e)},_beforeClose:function(t){if(t._options.isStack){var e=t.getId(),i=this._areaInfos[e];this._removeAreaFromStack(i,false),this._showShadow(i)}},_recalculateShadow:function(){for(var t=[],e=this._stack.length-1;e>-1;e--){var i=this._stack[e].control,n=i.getContainer().width(),a=t.indexOf(n)>-1;if(this._toggleAreaShadow(i,!a),!a)t.push(n)}},_afterClose:function(t){if(t._options.isStack)this._checkToggleContentScroll();if(this._prevArea===t)this._prevArea=null},_changeMaximizeMode:function(){this._recalculateShadow()},_setAreaInfo:function(t,e){var i=t.getId(),n=new y;n.control=t,n.hideSideBar=e.hideSideBar,n.id=i,this._areaInfos[i]=n},_addArea:function(t){if(this._calcVariables(),this._isCalculatingVariables=true,(this._areas[t.getId()]=t)._options.isStack)A().addClass("ws-float-area-overflow-scrolling-auto"),this._removeTouchFixClass(),t.getContainer().addClass("ws-float-area__touchScroll-fix")},_removeArea:function(t){var e=t.getId(),i=this._areaInfos[e];if(i)if(delete this._areaInfos[e],this._removeAreaFromStack(i,true),!this._stack.length)$(r.$body).removeClass("ws-float-area-overflow-scrolling-auto");else this._removeTouchFixClass(),this._getTopFloatArea().control.getContainer().addClass("ws-float-area__touchScroll-fix");delete this._areas[e]},_removeTouchFixClass:function(){for(var t=0;t<this._stack.length;t++)this._stack[t].control.getContainer().removeClass("ws-float-area__touchScroll-fix")},_useTouch:function(){return r.compatibility.touch&&0===d()},_haveMaximizedWindows:function(){return this._maximizedWindows.length>0},_needBodyRight:function(t){for(var e=-1,i=0,n=this._maximizedWindows.length;i<n;i++){if(this._maximizedWindows[i]===t)return true;if(this._maximizedWindows[i].getZIndex()>e)e=this._maximizedWindows[i].getZIndex()}return e>-1&&t.getZIndex()>e},_setWindowMaximized:function(e,t){var i=this._haveMaximizedWindows(),n=-1!==h(this._maximizedWindows,function(t){return t===e});if(t&&!n)this._maximizedWindows.push(e);else if(!t&&n)this._maximizedWindows=this._maximizedWindows.filter(function(t){return t!==e});if(i!==this._haveMaximizedWindows())this._checkToggleContentScroll(),this._resize()},_checkToggleContentScroll:function(){var t=this._stack.length+this._maximizedWindows.length>0;if(t!==this._hasAnyFloatArea)this._hasAnyFloatArea=t,e.setHasAnyFloatArea(t)},_removeAreaFromStack:function(t,e){var i=this._stack.indexOf(t),n=-1!==i;if(n){if(r.browser.isMobilePlatform)this._setTopFloatAreaWebkitOverflowScrolling("auto");if(this._stack.splice(i,1),r.browser.isMobilePlatform){var a=this._setTopFloatAreaWebkitOverflowScrolling("touch"),o=false===a?false:a.getContainer();this._strictOverflowScrollingOnScrollContainersUnderTopFloatArea(o)}if(e)this._checkToggleContentScroll();if(this._canHideSidebar())this._updateSideBarVisibility()}return n},_compareZIndex:function(t,e){if(t.control.getZIndex()<e.control.getZIndex())return-1;if(t.control.getZIndex()>e.control.getZIndex())return 1;return 0},_getMaxZIndex:function(){var i=t.getDefaultZIndex();return l(this._stack.sort(this._compareZIndex),function(t){var e=t.control.getZIndex();return i=e>i?e:i,false}),i},_getTopFloatArea:function(){if(this._stack.length>0)return this._stack.sort(this._compareZIndex),this._stack[this._stack.length-1];else return false},_setTopFloatAreaWebkitOverflowScrolling:function(t){var e=this._getTopFloatArea();if(e)return e.control._visibleRoot.css("-webkit-overflow-scrolling",t),this._topFloatArea=e.control,this._topFloatArea;else return false},_strictOverflowScrollingOnScrollContainersUnderTopFloatArea:function(t){for(var e in this._scrollableContainers)if(this._scrollableContainers.hasOwnProperty(e)){var i=this._scrollableContainers[e];if(false===t)i.css("-webkit-overflow-scrolling","touch");else if(0===t.find(i).length)i.css("-webkit-overflow-scrolling","auto");else i.css("-webkit-overflow-scrolling","touch")}},_toggleHasPopupInside:function(t,e){if(r.browser.isMobilePlatform)if(this._topFloatArea&&this._topFloatArea.getId()===t)if(e){for(var i in this._setTopFloatAreaWebkitOverflowScrolling("auto"),this._scrollableContainers)if(this._scrollableContainers.hasOwnProperty(i))this._scrollableContainers[i].css("-webkit-overflow-scrolling","auto")}else{var n=this._setTopFloatAreaWebkitOverflowScrolling("touch"),a=false===n?false:n.getContainer();this._strictOverflowScrollingOnScrollContainersUnderTopFloatArea(a)}}};if("undefined"!==typeof window)$(function(){W._init()});return W});