define("Core/Serializer",["require","Core/helpers/Object/isPlainObject","Core/helpers/Number/randomId","Core/library","Core/detection","View/Executor/Utils","Core/IoC"],function(a,o,l,s,$,t,u){var O=function(){if(void 0===r){var e="View/Executor/Markup";r=(r=t.RequireHelper.defined(e)?a(e).FunctionHeaderTemplate||"":"")?r.replace(/\r/g,""):""}return r},r,f;return(f=function(e,t,r){if(this._loader=r||a,this._functionStorage=[],this._instanceStorage={},this._linksStorage={},this._depsStorage={},this._unresolvedLinks=[],this._unresolvedInstances=[],this._unresolvedInstancesId=[],this._isServerSide=t,e)if("object"===typeof e)this._instanceStorage=e;else throw new Error("Storage must be a object");this.serialize=f.serializeWith(this),this.deserialize=f.deserializeWith(this)}).prototype._loader=null,f.prototype._functionStorage=null,f.prototype._instanceStorage=null,f.prototype._linksStorage=null,f.prototype._depsStorage=null,f.prototype._unresolvedLinks=null,f.prototype._unresolvedInstances=null,f.prototype._unresolvedInstancesId=null,f.prototype._patterns={Date:/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:[0-9\.]+Z$/,Function:/^TEMPLATEFUNCTOJSON=functio\S\s*\w+/},f.prototype.setDetectContainers=function(){},f.prototype.isDetectContainers=function(){},f.prototype.serialize=function(e,t){},f.serializeWith=function(s){return function(e,t){var r=t&&"object"===typeof t,n=r&&o(t);if(r&&!Array.isArray(t)&&!n){if(s._isServerSide)return;var i=l();return s._instanceStorage[i]=t,{$serialized$:"inst",id:i}}else if("function"===typeof t){if(s._isServerSide)return;return s._functionStorage.push(t),{$serialized$:"func",id:s._functionStorage.length-1}}else if(t===1/0)return{$serialized$:"+inf"};else if(t===-1/0)return{$serialized$:"-inf"};else if(void 0===t)return{$serialized$:"undef"};else if("number"===typeof t&&isNaN(t))return{$serialized$:"NaN"};else if(!isNaN(Number(e))&&Number(e)>=0&&void 0===t)return{$serialized$:"undef"};else{if(r)if("func"===t["$serialized$"])s._depsStorage[t.module]=true;return s._serializeLink(t)}}},f.prototype.deserialize=function(e,t){},f.deserializeWith=function(S){return function(e,t){var r=t,n=t instanceof Object;if(n&&t.hasOwnProperty("$serialized$"))switch(t.$serialized$){case"func":if("number"===typeof t.id&&S._functionStorage[t.id])r=S._functionStorage[t.id];else{var i=t.module+":"+t.path,s,o,a;try{s=S._loader(t.module)}catch(e){}if(s){try{if(r=s,t.path){o=t.path.split(".");while(a=o.shift())r=r[a]}}catch(e){throw new Error('Parsing function declaration "'+i+'" failed. Original message: '+e.message)}if("function"!==typeof r)throw new Error('Can`t transform "'+i+'" declaration to function');else r.wsHandlerPath=i}else r=i}break;case"inst":S._unresolvedInstances.push({scope:this,name:e,value:t}),S._unresolvedInstancesId.push(t.id);break;case"link":S._unresolvedLinks.push({scope:this,name:e,value:t});break;case"+inf":r=1/0;break;case"-inf":r=-1/0;break;case"undef":r=void 0;break;case"NaN":r=NaN;break;default:throw new Error('Unknown serialized type "'+t.$serialized$+'" detected')}if("string"===typeof r){var l=r;for(var u in S._patterns)if(S._patterns.hasOwnProperty(u)&&S._patterns[u].test(r))switch(u){case"Date":var f=new Date(r);if("Invalid Date"===f.toString()&&$.isIE)f=Date.fromSQL(r);return f;case"Function":var d=r.indexOf("{"),c=r.substr(0,d),p;c=(c=c.substring(c.indexOf("(")+1,c.indexOf(")"))).split(",");var h='&&(eval("var thelpers = null;"),',v=(r=O().replace(/sets/g,c[4]).replace(/context /g,c[2]).replace(/data/g,c[0])+(r=r.slice(d))).indexOf(h);if(-1===v)h=')eval("var thelpers = null;"),',v=r.indexOf(h);var g="",_=r.indexOf("=",v+h.length);if(v>-1&&_>-1)if(g=r.substring(v+h.length,_),/^\w+$/.test(g))r=r.replace(/thelpers/g,g);if(h="viewController:",_=(v=r.indexOf(h))+h.length+1,v>-1&&_>-1)if(g=r.substring(v+h.length,_),/^\w+$/.test(g))r=(r=r.replace(/viewController /g,g)).replace(/viewController=/g,g+"=");var y=","+c[2]+",";if(-1===(v=r.lastIndexOf(y)))y=c[2]+",",v=r.lastIndexOf(y);if(_=r.indexOf(",",y.length+v),v>-1&&_>-1)if(g=r.substring(v+y.length,_),/^\w+$/.test(g))r=r.replace(/depsLocal /g,g);if((v=(_=r.indexOf(".def&&("))-1)>-1&&_>-1)if(g=r.substring(v,_),/^\w+$/.test(g))r=r.replace(/defCollection /g,g);if(y="var defCollection = {id: [], def: undefined};",v=r.indexOf("var templateCount = 0;"),(_=r.indexOf(y))>-1&&v>-1)g=r.substring(v,_+y.length),r=r.replace(g,"");try{var w,m=function(e){return function(){if(this===window)return e.apply({},arguments);else return e.apply(this,arguments)}}(new Function(c,r));return m.fromSerializer=true,m}catch(e){return l}}}if(""===e&&n&&1===Object.keys(this).length)if(S._resolveLinks(),S._resolveInstances(),r===t)r=this[e];return r}},f.setToJsonForFunction=function(e,t,r){e.toJSON=function(){var e={$serialized$:"func",module:t};if(r)e.path=r;return e}},f.getFuncFromDeclaration=function e(t){var r=t.split(":"),n,i,s,o;try{s=a(r[0])}catch(e){}if(s){try{if(i=s,r[1]){n=r[1].split(".");while(o=n.shift())i=i[o];if("function"===typeof i){if(!i.toJSON)f.setToJsonForFunction(i,r[0],r[1]);i.wsHandlerPath=t}}}catch(e){throw new Error('Parsing function declaration "'+t+'" failed. Original message: '+e.message)}if("function"!==typeof i)throw new Error('Can`t transform "'+t+'" declaration to function')}else i=t;return i},f.parseDeclaration=function(e){return s.parse(e)},f.prototype._serializeLink=function(e){if(e&&"object"===typeof e&&"inst"===e.$serialized$&&e.hasOwnProperty("id")){var t=e.id;if(this._linksStorage.hasOwnProperty(t))return{$serialized$:"link",id:t};else this._linksStorage[t]=e}return e},f.prototype._resolveLinks=function(){var e,t,r;for(t=0;t<this._unresolvedLinks.length;t++){if(e=this._unresolvedLinks[t],-1===(r=this._unresolvedInstancesId.indexOf(e.value.id)))throw new Error("Can't resolve link for property \""+e.name+'" with instance id "'+e.value.id+'".');e.scope[e.name]=e.value=this._unresolvedInstances[r].value,this._unresolvedInstances.splice(1+r,0,e),this._unresolvedInstancesId.splice(1+r,0,e.value.id)}this._unresolvedLinks.length=0},f.prototype._resolveInstances=function(){for(var t,e,r,n,i=0;i<this._unresolvedInstances.length;i++){if(n=this._unresolvedInstances[i],r=null,this._instanceStorage[n.value.id])r=this._instanceStorage[n.value.id];else if(n.value.module){try{if(e=s.parse(n.value.module),!(t=this._loader(e.name)))throw new Error('The module "'+e.name+'" is not loaded yet.');if(t.__esModule&&t.default)t=t.default;if(e.path.forEach(function(e){if(!(e in t))throw new Error('The path element "'+e+'" is not found.');t=t[e]}),!t.prototype)throw new Error('The module "'+n.value.module+'" is not a constructor.');if("function"!==typeof t.prototype.fromJSON)throw new Error('The prototype of module "'+n.value.module+"\" doesn't have fromJSON() method.");r=t.prototype.fromJSON.call(t,n.value)}catch(e){u.resolve("ILogger").error("Core/Serializer",e.stack||e),r=null}this._instanceStorage[n.value.id]=r}n.scope[n.name]=n.value=r}this._unresolvedInstancesId.length=0,this._unresolvedInstances.length=0},f});