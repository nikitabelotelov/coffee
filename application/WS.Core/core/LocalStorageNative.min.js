define("Core/LocalStorageNative",["Core/UserInfo","Core/IoC","Core/constants","Core/helpers/String/format","Core/i18n","Core/_storage","Core/EventBus"],function(t,r,n,o,e,i,s){"use strict";var u="__s3su",f="ws-local-keys",a="ws-store-always-keys",c=i.getLocal(),g=1024*512,m=e.rk('Превышен максимальный размер записи ($max$d$ kb) в локальное хранилище для ключа "$key$s$" ($size$F$2$ kb)');function l(e,t){t=t||"log",r.resolve("ILogger")[t]("Core/LocalStorageNative",e)}function I(e){var t=encodeURIComponent(e).match(/%[89ABab]/g);return e.length+(t?t.length:0)}function v(e,t){if(!n.isBrowserPlatform)return true;var r=I(t);if(r<=g)return true;return l(o({max:g/1024,key:e,size:r/1024},m)),false}function h(){c.setItem(u,t.getCurrent())}var y=function(){var e=C(),t;try{t=[].concat(JSON.parse(c.getItem(a)))}catch(e){t=[]}var r=[];e.forEach(function(e){if(-1===t.indexOf(e))return c.removeItem(e);r.push(e)}),c.setItem(f,JSON.stringify(r))},C=function(){try{return JSON.parse(c.getItem(f))||[]}catch(e){return[]}},O;function S(){var e=c.getItem(u);if(!t.isValid(e))y(),h()}return s.channel("errors").subscribe("onAuthError",S),S(),{getItem:function(e){return c.getItem(e)},setItem:function(e,t){if(e===u)return false;var r=""+t;if(!v(e,r))return false;var n=c.setItem(e,r),o=C();if(-1===o.indexOf(e)&&e!==a)o.push(e),c.setItem(f,JSON.stringify(o));return n},removeItem:function(t){if(t===u)return;c.removeItem(t);var e=C(),r;e=e.filter(function(e){return t!==e}),c.setItem(f,JSON.stringify(e));try{r=JSON.parse(c.getItem(a))||[]}catch(e){r=[]}if(-1!==r.indexOf(t))r=r.filter(function(e){return t!==e}),c.setItem(a,JSON.stringify(r))},clear:function(){y(),h()},getLength:function(){return C().length},getKeys:function(){return C()}}});