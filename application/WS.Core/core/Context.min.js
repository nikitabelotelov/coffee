define("Core/Context",["Core/core-extend","Core/Abstract","Core/helpers/Object/isPlainObject","Core/helpers/Object/find","Core/helpers/Array/findIndex","Core/helpers/Function/shallowClone","Core/core-instance","Core/core-debug","Core/IoC"],function(e,t,c,u,r,h,f,d,_){function s(e){if(!Array.isArray(e))throw new TypeError("array-unique expects an array.");var t=e.length,i=-1;while(i++<t)for(var n=i+1;n<e.length;++n)if(e[i]===e[n])e.splice(n--,1);return e}var p,g={SET:"FindIntent.SET",GET:"FindIntent.GET",REMOVE:"FindIntent.REMOVE"},v={NONE:0,GET:1,SET:2,GETSET:3,UNDEFINEDS_AS_EXISTENT:4},i=function(e){return function(){return e}},b="/",y=".",n=function(){throw new Error(rk("Метод не должен вызываться"))},x=function(){},o={is:n,get:i(x),set:function(e,t,i){return 0===t.length?i:C.set({},t,i)},remove:n,setWillChange:i(true),toJSON:n},C={name:"SimpleFieldType",is:i(true),equals:function(e,t){return e===t||e&&t&&"function"===typeof e.equals&&e.equals(t)},get:function(e,t){var i,n,s;if(0===t.length)i=e;else if(null===e||"object"!==typeof e||!(t[0]in e))i=x;else n=e[t[0]],i=(s=p.getValueType(n)).get(n,t.slice(1));return i},setWillChange:function(e,t,i){var n,s,r,o;if(0===t.length)n=!C.equals(e,i);else if(e===x)n=true;else if(null===e||"object"!==typeof e)n=false;else if(!(n=!((o=t[0])in e)))s=e[o],n=(r=p.getValueType(s)).setWillChange(s,t.slice(1),i);return n},set:function(e,t,i){var n,s,r,o,a,l,c=C.equals;if(0===t.length)a=i;else if(e===x)a=C.set({},t,i);else if(null!==e&&"object"===typeof e)if(o=t[0],n=e.hasOwnProperty(o)?e[o]:x,1===t.length)if(l=o in e&&c(n,i))a=e;else if(c(n,s=(r=p.getValueType(n)).set(n,[],i)))a=e;else(a=h(e))[o]=s;else if(n===(s=(r=p.getValueType(n)).set(n,t.slice(1),i)))a=e;else a=C.set(e,[o],s);else a=e;return a},remove:function(e,t){var i,n,s,r,o,a,l,c=C.equals;if(s=0!==t.length)if(r=t[0],s=null!==e&&"object"===typeof e&&r in e)if(1===t.length)if(Array.isArray(e))if(o=e.slice(0),(l=parseInt(r,10))==r)o.splice(l,1);else delete o[r];else if(i=e[r],a=(n=p.getValueType(i)).remove(i,[]),n.isProxy)s=a.changed,o=e;else s=true,delete(o=h(e))[r];else if(i=e[r],s=(a=(n=p.getValueType(i)).remove(i,t.slice(1))).changed)if(n.isProxy||c(a.value,i))o=e;else(o=h(e))[r]=a.value;return{value:s?o:e,changed:s}},toJSON:function(e,t){var i;return t&&null!==e&&"object"===typeof e&&"function"===typeof e["toJSON"]?e.toJSON():e}},a=[C],l=e({},{$protected:{_options:{objectData:null},_isEmpty:true,_contextObject:{}},$constructor:function(){if(this._contextObject={},this._options.objectData){var e=this._options.objectData;if(!c(e))throw new Error(rk("Опция objectData должна быть простым объектом с ключами и значениями"));for(var t in e)if(e.hasOwnProperty(t)){var i=e[t],n=this._getValueType(i);this._contextObject[t]=this._createTypedValue(i,n),this._isEmpty=false}}},_getValueType:function(e){return p.getValueType(e)},getFieldType:function(e){var t=this._contextObject,i;return e in t?t[e].type:o},_getFieldValue:function(e){var t=this._contextObject,i;return e in t?t[e].value:x},isEmpty:function(){return this._isEmpty},_createTypedValue:function(e,t){return{value:e,type:t}},toObject:function(s){return Object.keys(this._contextObject).reduce(function(e,t){var i=this.getFieldType(t),n=this._getFieldValue(t);return e[t]=i.toJSON(n,s),e}.bind(this),{})},has:function(e){var t=this._getFieldDescr(e),i=t&&this.get(t.qname,t.keyPath);return!!(t&&i!==x)},set:function(e,t,i){var n,s,r=this._getFieldValue(e),o=this.getFieldType(e),a=this._contextObject,l=!(r===x&&void 0===i)?o.setWillChange(r,t,i):false;if(l)s=o.set(r,t,i),n=this._getValueType(s),a[e]=this._createTypedValue(s,n),this._isEmpty=false;return l},transaction:function(e){if(e.transaction)e.transaction()},commit:function(e){if(e.commit)e.commit()},_getFieldDescr:function(e,r,t){var i=e.split(b),n=i.map(function(e,t){return i.slice(0,i.length-t)}),o=this._contextObject,s=u(n,function(e){for(var t=e[0],i=1;i<e.length;i++)t+=b+e[i];var n=o.hasOwnProperty(t),s;if(n)s=o[t];return void 0!==s||r&&n&&void 0===s}),a,l,c;if(s)c={qname:a=s.join(b),keyPath:l=i.slice(s.length)};else if(t&&i.length>0)c={qname:i[0],keyPath:i.slice(1)};else c=null;return c},get:function(e,t){var i=this.getFieldType(e),n=this._getFieldValue(e);return i.get(n,t)},getRaw:function(e){var t=this._contextObject;return e in t?t[e].value:x},removeRaw:function(e){delete this._contextObject[e]},setRaw:function(e,t){this._contextObject[e]={value:t,type:this._getValueType(t)}},remove:function(e,t){var i=this.getFieldType(e),n=this._contextObject,s=i!==o,r;if(s)if(0===t.length)if(i.clear)r=i.clear(n[e].value),n[e].value=r.value,s=r.changed;else delete n[e];else r=i.remove(n[e].value,t),n[e].value=r.value,s=r.changed;return s}});function F(n){return function(){var e,t;if(!this.isDestroyed()){if(0===this._updateLockCnt)this._updatedEventsCnt=0;this._updateLockCnt++;try{t=n.apply(this,arguments)}finally{if(this._updateLockCnt--,0===this._updateLockCnt){if(e=this._updatedEventsCnt,this._updatedEventsCnt=0,Array.isArray(this._changedContexts)){var i=s(this._changedContexts);this._changedContexts=[],i.forEach(function(e){e._notify("onFieldsChanged")})}if(e>0)this._notify("onFieldsChanged")}}}return t}}return(p=t.extend({$protected:{_options:{isGlobal:false,restriction:""},_restrictFlags:0,_previousContext:null,_context:null,_record:null,_parentContextDataBindHandler:null,_parentContextFieldUpdateHandler:null,_updateLockCnt:0,_updatedEventsCnt:0,_fieldSubscriptions:{}},$constructor:function(){if(!this._options._createdWithWrapper&&!this._options.isGlobal)_.resolve("ILogger").error("Core/Context","Для создания контекста нужно использовать метод Context.createContext(control[, options[, previousContext]]).");switch(this._context=new l,this._options.restriction){case"setget":this._restrictFlags=this._restrictFlags|v.GETSET;case"set":this._restrictFlags=this._restrictFlags|v.SET}if(this._parentContextDataBindHandler=F(function(){if(!this._hasGetRestrictions())this._updatedEventsCnt++,this._notify("onDataBind")}).bind(this),this._parentContextFieldsChangedHandler=F(function(){if(!this._hasGetRestrictions())this._updatedEventsCnt++}).bind(this),this._parentContextFieldUpdateHandler=function(e,t,i,n){if(!this._hasGetRestrictions()){var s;if(!this._getFieldDescr(t,g.GET,v.GET))this._notify("onFieldChange",t,i,n)}}.bind(this),this._parentContextFieldRemovedHandler=function(e,t){if(!this._hasGetRestrictions()){var i;if(!this._getFieldDescr(t,g.GET,v.GET))this._notify("onFieldRemove",t)}}.bind(this),false===this._options.isGlobal)this._previousContext=p.global;this._subscribeOnParentUpdates(),this._publish("onDataBind","onFieldChange","onFieldsChanged","onFieldRemove")},_subscribeOnParentUpdates:function(){var e=this._previousContext;if(e)e.subscribe("onDataBind",this._parentContextDataBindHandler),e.subscribe("onFieldsChanged",this._parentContextFieldsChangedHandler),e.subscribe("onFieldChange",this._parentContextFieldUpdateHandler),e.subscribe("onFieldRemove",this._parentContextFieldRemovedHandler)},_unsubscribeOnParentUpdates:function(){var e=this._previousContext;if(e)e.unsubscribe("onDataBind",this._parentContextDataBindHandler),e.unsubscribe("onFieldsChanged",this._parentContextFieldsChangedHandler),e.unsubscribe("onFieldChange",this._parentContextFieldUpdateHandler),e.unsubscribe("onFieldRemove",this._parentContextFieldRemovedHandler)},_unsubscribeFromFields:function(){for(var e in this._fieldSubscriptions)if(this._fieldSubscriptions.hasOwnProperty(e))this._setFieldSubscription(e,this._context.getRaw(e),x);this._fieldSubscriptions={}},getRestriction:function(){return this._options.restriction},setRestriction:function(e){switch(this._options.restriction=e,this._restrictFlags=this._restrictFlags&~v.GETSET,e){case"setget":this._restrictFlags=this._restrictFlags|v.GET;case"set":this._restrictFlags=this._restrictFlags|v.SET}},_hasGetRestrictions:function(){return this._hasRestrictions(v.GET)},_hasSetRestrictions:function(){return this._hasRestrictions(v.SET)},_hasRestrictions:function(e){return 0!==(this._restrictFlags&e)},setPrevious:F(function(e){if(this.isGlobal())throw new Error("Attempt to set a previous context to a global context");if(null!==e&&!e instanceof p)throw new Error('"previous" argument should be instance of Core/Context');if(e!==this._previousContext)if(this._unsubscribeOnParentUpdates(),this._previousContext=e,this._subscribeOnParentUpdates(),!this._hasGetRestrictions())this._updatedEventsCnt++;return this}),getPrevious:function(){return this._previousContext},_changeContextData:F(function(e,t){var i=p.RecordFieldProxy,n,s;if(t.apply(this),f.instanceOfModule(e,"Deprecated/Record"))this._record=e,this._record.each(function(e){n=new i(this._record,e),s=this._context.getRaw(e),this._setFieldSubscription(e,s,n),this._context.setRaw(e,n)}.bind(this));else for(var r in e)if(e.hasOwnProperty(r)){var o=e[r];s=this._context.getRaw(r),this._setFieldSubscription(r,s,o),this._context.setRaw(r,o)}this._updatedEventsCnt++,this._notify("onDataBind")}),setContextData:function(e){this._unsubscribeFromFields(),this._changeContextData(e,function(){this._context=new l})},replaceRecord:function(e){if(this._record)this._record.each(function(e){this._setFieldSubscription(e,this._context.getRaw(e),null),this._context.removeRaw(e)}.bind(this));this._changeContextData(e,function(){})},isGlobal:function(){return this._options.isGlobal},isEmpty:function(){return this.isDestroyed()?true:this._context.isEmpty()},getRecord:function(){return this._record},_getValue:function(e,t,i,n){if(void 0!==t&&"function"!==typeof t)throw new Error(rk("Параметр func должен быть функцией, если он есть"));var s=v[i?"GET":"NONE"],r=this._getFieldDescr(e,g.GET,s,t),o;if(r)o=r.contextData.get(r.qname,r.keyPath);else o=x;return o===x&&!n?void 0:o},getValue:function(e,t){return e?this._getValue(e,t,false):void 0},getValueSelf:function(e){return this._getValue(e,void 0,true)},isFieldSameOrSubField:function(e,t){var i=this._getFieldDescr(e),n=this._getFieldDescr(t),s;if(s=i&&n&&i.context===n.context&&i.qname===n.qname)s=-1===r(n.keyPath,function(e,t){return i.keyPath[t]!==e});return s},_getFieldDescr:function(e,t,i,n){var s=this,r=null,o={},a=t===g.SET,l,c,u,h,f;o[g.GET]=v.GET,o[g.SET]=v.SET,o[g.REMOVE]=v.SET;while(!r&&s){if(c=0!==((l=s._restrictFlags|(i||0))&v.UNDEFINEDS_AS_EXISTENT),s.hasEventHandlers("onFieldNameResolution"))if((f=""+(s._notify("onFieldNameResolution",e,a)||"")).length>0)s=(r=s._context._getFieldDescr(f,c,a))?s:null;if(!r&&s){if((r=s._context._getFieldDescr(e,c))&&n)r=!n(h=s._context.get(r.qname,r.keyPath))?r:null;if(!r)s=0===(u=l&o[t])?s.getPrevious():null}}if(d.checkAssertion(!!r===!!s),!r&&a)r=(s=this)._context._getFieldDescr(e,false,true);if(r)r.context=s,r.contextData=s._context;return r},_setFieldSubscription:function(e,t,i){var n=this._fieldSubscriptions,s,r;function o(){this._updatedEventsCnt++,this._notify("onFieldChange",e,this.getValue(e))}if(t!==i){if(e in n)if(s=n[e],delete n[e],s)s();if(r=p.getValueType(i),i&&i!==x&&r.subscribe)s=function(){if(0===this._updateLockCnt)F(o).call(this);else this.once("onFieldsChanged",o.bind(this))}.bind(this),n[e]=r.subscribe(i,s)}},getFieldOrigin:function(e,t){var i=g[t?"SET":"GET"],n=this._getFieldDescr(e,i);return n&&n.context},hasField:function(e){var t;return this._getValue(e,void 0,true,true)!==x},hasFieldWithParents:function(e){var t;return this._getValue(e,void 0,false,true)!==x},getFieldOrigin2:function(e){var t=this._getFieldDescr(e,g.GET,v.UNDEFINEDS_AS_EXISTENT);return t&&t.context},setValue:F(function(n,e,t,i){if(!n)throw new Error(rk("Нельзя писать значения в контекст по пустому полю")+' ""');var f=[];function s(e,t,i,n,s){var r=this._getFieldDescr(e,g.SET,v[i?"SET":"NONE"]);if(!r){var o;_.resolve("ILogger").error("setValue",rk("Нельзя записывать значение в под-поле сложного поля контекста, если этого сложного поля в контексте не существует. Путь к под-полю:")+" "+e)}else{var a=r.context,l=a._context.getFieldType(r.qname),c=a._context.getRaw(r.qname),u,h;if(-1===f.indexOf(l))f.push(l),a._context.transaction(l);if(u=a._context.set(r.qname,r.keyPath,t),h=a._context.getRaw(r.qname),s)f.forEach(function(e){a._context.commit(e)}),f.length=0;if(u)a._setFieldSubscription(r.qname,c,h),a._updatedEventsCnt++,a._notify("onFieldChange",e,t,n),this._changedContexts=this._changedContexts||[],this._changedContexts.push(a)}}if("object"==typeof n){if(!c(n))throw new Error("setValue supports simple JSON objects only");var r=e,o=t;Object.keys(n).forEach(function(e,t,i){s.call(this,e,n[e],r,o,t===i.length-1)},this)}else s.call(this,n,e,t,i,true)}),runInBatchUpdate:F(function(e){return e.call(this)}),removeValue:F(function(n,e){var t=e?v.SET:v.NONE,s=this._getFieldDescr(n,g.REMOVE,t),r,i,o,a;if(s)o=s.context,i=(a=F(function(){var e=s.contextData,t=e.getRaw(s.qname),i=s.contextData.remove(s.qname,s.keyPath);if(i)r=e.getRaw(s.qname),s.context._setFieldSubscription(s.qname,t,r),this._updatedEventsCnt++,this._notify("onFieldRemove",n);return i}).bind(o))();else i=false;return i}),setValueSelf:function(e,t,i){if("object"==typeof e)this.setValue(e,true,i);else this.setValue(e,t,true,i)},insert:function(e,t){this._multiOperation(e,t,"insert")},remove:function(e,t){this._multiOperation(e,t,"remove")},_multiOperation:F(function(e,t,i){if(null!==t&&void 0!==t&&"string"!==typeof t)throw new Error(rk("Параметр link должен быть строкой - именем связи"));var n=t?t+y:"";if(f.instanceOfModule(e,"Deprecated/Record"))e=e.toObject();if("object"===typeof e){if(!c(e)&&!Array.isArray(e))throw new Error('"values" argument error: _multiOperation supports simple JSON objects only');for(var s in e)if(e.hasOwnProperty(s)){if("remove"==i)this.removeValue(n+s,true);if("insert"==i)this.setValueSelf(n+s,e[s])}}else if(false===e||null===e||void 0===e){var r=this.getRecord(),o=function(e){if(0===e.indexOf(t))this.removeValue(e,true)}.bind(this);if(r)r.getColumns().forEach(function(e){o(e)});else{var a=this.toObject(false);for(var l in a)if(a.hasOwnProperty(l))o(l)}}this._notify("onDataBind")}),destroy:function(){this._record=null,this._unsubscribeOnParentUpdates(),this._unsubscribeFromFields(),this._context=new l,p.superclass.destroy.apply(this,arguments)},createDependent:function(){var e=new p;return e.setPrevious(this),e},toObject:function(e){var t=this._context.toObject(e);if(e){var i=this.getPrevious();if(i){var n=i.toObject(true);for(var s in n)if(n.hasOwnProperty(s)&&!(s in t))t[s]=n[s]}}return t}})).createContext=function(e,t,i){var n;if(!e||!f.instanceOfMixin(e,"Lib/Control/Control.compatible")&&!f.instanceOfModule(e,"Core/Deferred"))_.resolve("ILogger").info("Для создания контекста необходимо передать контрол, которому он будет принадлежать, или Deffered, который выстрелит, когда контекст перестанет быть нужным.");if(t=t||{},i&&!(i instanceof p))throw new Error("Родительский контекст должен иметь тип Core/Context");if(t._createdWithWrapper=true,n=new p(t),i)n.setPrevious(i);if(f.instanceOfMixin(e,"Lib/Control/Control.compatible"))e.addOwnedContext(n);else if(f.instanceOfModule(e,"Core/Deferred"))e.addCallback(function(){n.destroy()});return n},p.registerFieldType=function(e){a.unshift(e)},p.getValueType=function(t){return u(a,function(e){return e.is(t)})},p.NonExistentValue=x,p.SimpleFieldType=C,p.RecordFieldProxy=null,p.STRUCTURE_SEPARATOR=b,p.global=new p({isGlobal:true}),p});