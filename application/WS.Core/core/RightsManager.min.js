define("Core/RightsManager",["require","Core/constants","Core/helpers/Object/isEmpty","Core/helpers/Object/find","Core/Deferred","Core/IoC","Core/core-instance"],function(g,f,d,n,u,o,A){var e;return{ALLOW_MASK:1,READ_MASK:1<<1,WRITE_MASK:1<<2,ADMIN_MASK:1<<3,rightsNeeded:function(){if("undefined"!==typeof process){var e;try{e=process.application.getCurrentService()}catch(e){}return e&&e.rightsNeeded()}else if(window)return window.rights&&!d(window.rights)||f.rights||false},getRights:function(e,t,s){var i,r={};if(t)i=t;else if(this.rightsNeeded())if(process&&process.domain&&process.domain.req&&process.domain.req.rights&&!d(process.domain.req.rights))i=process.domain.req.rights;else if(window&&window.rights&&!d(window.rights))i=window.rights;else if(process||f.rights)i=this.readUserRights();if(i=i||{},e&&!(i instanceof u)){var n=!d(i);if(!(e instanceof Array))e=[e];for(var a in e)if(e.hasOwnProperty(a)){var o=e[a];if(n)r[o]=s?i[o]||{flags:0,restrictions:{}}:i[o]&&i[o].flags||i[o]||0;else{var c=this.ALLOW_MASK|this.WRITE_MASK|this.READ_MASK|this.ADMIN_MASK;r[o]=s?i[o]||{flags:c,restrictions:{}}:c}}}else if(!s&&!(i instanceof u)){for(var h in i)if(i.hasOwnProperty(h)){var l=i[h];if("object"===typeof l)r[h]=l.flags;else r[h]=l}}else r=i;return r},checkRights:function(e){if(f.isBrowserPlatform)o.resolve("ILogger").info("$ws.single.RightsManager.checkRights","Метод будет удален в 3.18. "+"Для получения объекта с правами используйте .getRights([zones]). "+"Для плучения значения allow вызовите getRights([zones]) и используйте логическое И для полей объекта с RightsManager.ALLOW_MASK");var t=this.getRights(null,null,true),s=t&&!d(t),i={};if(!(e instanceof Array))e=[e];for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];if(s){var a=this._parseZoneName(n).zone;i[n]={},i[n].access=t&&this.checkAccessRights([n])||0,i[n].allow=t[a]&&t[a].flags>0||false}else i[n]={allow:true,access:2}}return i},checkAccessRights:function(e,t){var s=2,i=0;if(void 0===t)t=this.getRights(null,null,true);if(this.rightsNeeded()&&Object.keys(t).length)for(var r=s=0,n=e.length;r<n;r++){var a=e[r],o,c,h;if(a="string"===typeof a?a.trim():a,o=(a=this._parseZoneName(a)).zone,c=a.restriction,h=t[o]){var l,f,d=this.READ_MASK|this.WRITE_MASK;if(f=h.flags||h,c)if(h.restrictions)d=h.restrictions[c];else d=0;if(i<(l=this._applyMasks(f,d)).access)i=l.access}}return s||i},hasDataAccess:function(e){if("data-access"in e.attributes)return true;var t=this;return!!n(e.childNodes,function(e){if("options"===e.nodeName||"opts"===e.nodeName)return t.hasDataAccess(e);else return false})},_getAccessibleColumns:function(e){var t=this,s=[];for(var i in e)if(e.hasOwnProperty(i)){var r=e[i],n=r.getAttribute("data-access");if(!n||t.checkAccessRights(n.split(","))>0)s.push(r)}return s},_checkRightsForColumns:function(e){var t=this,s=e.getAttribute("data-component"),i,r;if(!s)return false;if(r=(i=g(s)).prototype,"SBIS3.CONTROLS/DataGridView"!==s&&!A.instanceOfModule(r,"SBIS3.CONTROLS/DataGridView"))return false;for(var n in e.childNodes)if(e.childNodes.hasOwnProperty(n)){var a=e.childNodes[n];if(("options"===a.nodeName||"opts"===a.nodeName)&&"columns"===a.getAttribute("name"))a.childNodes=t._getAccessibleColumns(a.childNodes)}return true},_checkRightsForTabs:function(e){var t=e.getAttribute("data-component"),s,i,r="";if(!t)return false;function n(e){return A.instanceOfMixin(i,e)}if(s=g(t),i=s.prototype,n("Lib/Mixins/HasItemsMixin"))r="items";else if(n("SBIS3.CONTROLS/Mixins/ItemsControlMixin"))r="items";else if(n("SBIS3.CONTROLS/Mixins/DSMixin"))r="items";else if(n("Lib/Mixins/HasTabsMixin"))r="tabs";var a=this,o,c;if(r){for(var h in e.childNodes)if(e.childNodes.hasOwnProperty(h)){var l=e.childNodes[h];if("options"===l.nodeName||"opts"===l.nodeName)if(o=l.getAttribute("name"),c=l.getAttribute("type"),o===r&&c&&"array"===c.toLowerCase()){var f=[];for(var d in l.childNodes)if(l.childNodes.hasOwnProperty(d)){var u=l.childNodes[d],p=u.getAttribute("data-access");if(p){if(0!==a.checkAccessRights(p.split(",")))f.push(u)}else f.push(u)}l.childNodes=f}}return true}return false},_operationsName:{markOperations:1,massOperations:1,selectedOperations:1},_checkRightsForOperationsPanel:function(e){var n=this,t;function a(e){var t=[];for(var s in e.childNodes)if(e.childNodes.hasOwnProperty(s)){var i=e.childNodes[s];if("userOperations"===i.getAttribute("name"))a(i),t.push(i);else{var r=i.getAttribute("data-access");if(r){if(2===n.checkAccessRights(r.split(",")))t.push(i)}else t.push(i)}}e.childNodes=t}if("Deprecated/Controls/OperationsPanel/OperationsPanel"===e.getAttribute("data-component")){for(var s in e.childNodes)if(e.childNodes.hasOwnProperty(s)){var i=e.childNodes[s];if("options"===i.nodeName||"opts"===i.nodeName)if(i.getAttribute("name")in n._operationsName)a(i)}return true}return false},_findDisplayNode:function(e){return n(e.childNodes,function(e){return 1==e.nodeType&&("options"===e.nodeName||"opts"===e.nodeName)&&"display"===e.getAttribute("name")})},_changeOption:function(e,t,s,i){var r=n(e.childNodes,function(e){return 1==e.nodeType&&("option"===e.nodeName||"opt"===e.nodeName)&&e.getAttribute("name")===t});if(r)r.childNodes=[],r.setAttribute("value",s);else e.childNodes=i.parse('<option name="'+t+'" value="'+s+'"></option>').childNodes.concat(e.childNodes)},applyRights:function(e,t){var s=e.getAttribute("data-access");if(!s){if(!this._checkRightsForTabs(e))this._checkRightsForOperationsPanel(e);return this._checkRightsForColumns(e),e}if(s)switch(this.checkAccessRights(s.split(","))){case 0:return null;case 1:var i=this._findDisplayNode(e);if(i)this._changeOption(i,"readOnly",true,t),this._changeOption(e,"enabled",true,t),this._changeOption(e,"allowChangeEnable",false,t);else this._changeOption(e,"enabled",false,t),this._changeOption(e,"allowChangeEnable",false,t);case 2:return this._checkRightsForTabs(e),this._checkRightsForColumns(e),e}return e},readUserRights:function(t){var s=new u;return s.addErrback(function(e){return e}),g(["Types/source"],function(e){(t=t||new e.SbisService({endpoint:"CheckRights"})).call("AccessAreasJSON",{}).addCallback(function(e){s.callback(e.getRawData())}).addErrback(function(e){o.resolve("ILogger").error("User rights","Transport error",e),s.errback(e)})},function(){if(!t)throw new Error("Для проверки прав необходим модуль Types/source")}),s},_applyMasks:function(e,t){if("object"===typeof e)e=e.flags;if(!t)t=0;var s=this._checkMask(e,this.ALLOW_MASK),i=this._checkMask(e,this.READ_MASK)&&this._checkMask(t,this.READ_MASK)?1:0,r=this._checkMask(e,this.WRITE_MASK)&&this._checkMask(t,this.WRITE_MASK)?2:0,n=this._checkMask(e,this.ADMIN_MASK)?Math.max(i,r):0;return{access:Math.max(i,r,n),allow:s,flags:e}},_checkMask:function(e,t){return(e&t)===t},_parseZoneName:function(e){var t=e.split("|");return{zone:t[0],restriction:t[1]}}}});