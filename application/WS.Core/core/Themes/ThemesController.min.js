define("Core/Themes/ThemesController",["Core/core-extend","Env/Env","View/Request","Core/CssLoader/CssLoader","Core/LinkResolver/LinkResolver"],function(e,h,r,n,o){"use strict";var i=this||(0,eval)("this"),s=null;function d(e,t){return e.replace(/url\(.+?\)/g,function(e){if(~e.indexOf("data:")||/^url\(('|")\//.test(e)||/^url\(\//.test(e))return e;var s=e.slice(4,-1);if(/^('|").+('|")$/.test(s))s=s.slice(1,-1);return'url("'+t.split("/").slice(0,-1).join("/").concat("/"+s)+'")'})}var t=e.extend([],{constructor:function(){this.css={},this.css.themedCss=[],this.css.simpleCss=[],this.themedCssCommon={},this.resolvedCss={themed:{},simple:{}};var e=i.contents&&i.contents.buildMode||"debug",s="true"===h.cookie.get("s3debug")||"debug"===e;this.linkResolver=new o(s,h.constants.buildnumber,h.constants.wsRoot,h.constants.appRoot,h.constants.resourceRoot),this.cssLoader=new n(this.linkResolver),this.themes={default:{}},this.resolvedCss.themed["default"]={};var t=r.getCurrent().stateReceiver;if(t)t.register("ThemesController",this);if("undefined"!==typeof window)this.collectThemedCssFromDOM()},collectThemedCssFromDOM:function(){for(var e=document.getElementsByClassName("css-bundles"),s=[],t=0;t<e.length;t++)if(0===e[t].getAttribute("key").indexOf("themed-css")){var r=e[t].getAttribute("css-name");this.themedCssCommon[r]=true,this.resolvedCss.themed[this.getCurrentTheme()][r]=e[t]}},setState:function(e){if(e.themes)for(var s in this.themes={},e.themes)if(e.themes.hasOwnProperty(s))return void this.setTheme(s)},getCurrentTheme:function(){return this.themes[0]||"default"},getState:function(){if(!this.themes||""===Object.keys(this.themes)[0])return{};return{themes:this.themes}},getSimpleResolved:function(){return this.resolvedCss.simple},getReqCbArray:function(){var e=this.requireCbArray;return this.requireCbArray=[],e},getThemedResolved:function(){return this.resolvedCss.themed},setTheme:function(i){var l=this;l.themes[i]=true,l.resolvedCss.themed[i]={};var t=[],e;for(var s in l.themedCssCommon)(function(s){var e=l.cssLoader.loadCssThemedAsync(s,i);t.push(e.then(function(e){return{name:s,style:e}}))})(s);Promise.all(t).then(function(e){for(var s=0;s<e.length;s++){var t=d(e[s].style,l.linkResolver.resolveLink(e[s].name,"css")),r=l.addStyle(t,e[s].name,i);l.resolvedCss.themed[i][e[s].name]=r}for(var n in l.themes)if(n!==i){for(var o in l.resolvedCss.themed[n])l.resolvedCss.themed[n][o].remove();delete l.resolvedCss.themed[n],delete l.themes[n]}})},addStyle:function(e,s,t){var r=document.createElement("style");if(r.setAttribute("data-vdomignore",true),r.setAttribute("css-name",s),t)r.setAttribute("theme-name",t);return r.innerHTML=e,window.document.head.appendChild(r),r},pushCssAsync:function(t,r){var n=this,o=n.linkResolver.fixOld(t);if("undefined"!==typeof n.resolvedCss.simple[o])return;n.resolvedCss.simple[o]="",n.cssLoader.loadCssAsync(t).then(function(e){e=d(e,n.linkResolver.resolveLink(t,"css"));var s=n.addStyle(e,o);n.resolvedCss.simple[o]=s,r()}).catch(function(){h.IoC.resolve("ILogger").error("Css load","Can't load css for: "+t),r()})},pushCssThemedAsyncAllThemes:function(r,n){var o=this,i=o.linkResolver.fixOld(r);if("undefined"!==typeof o.themedCssCommon[i])return;o.themedCssCommon[i]=true;var l=Object.keys(o.themes);o.cssLoader.loadCssThemedAllThemes(r,l).then(function(e){for(var s=0;s<e.length;s++){e[s]=d(e[s],o.linkResolver.resolveCssWithTheme(r,l[s]));var t=o.addStyle(e[s],i,l[s]);o.resolvedCss.themed[l[s]][r]=t}n()}).catch(function(){h.IoC.resolve("ILogger").error("Css load","Can't load css for: "+r),n()})},getCss:function(){return this.css},initCss:function(e){this.css.themedCss=this.css.themedCss.concat(e.themedCss),this.css.simpleCss=this.css.simpleCss.concat(e.simpleCss)}});return t.getInstance=function e(){if(process&&process.domain&&process.domain.req){if(!process.domain.req._$ThemesController)process.domain.req._$ThemesController=new t;return process.domain.req._$ThemesController}if("undefined"!==typeof window){if(!s)s=new t;return s}if(i){if(!i._$ThemesController)i._$ThemesController=new t;return i._$ThemesController}h.IoC.resolve("ILogger").error("Cannot create themes controller")},t});