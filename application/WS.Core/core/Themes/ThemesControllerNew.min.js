define("Core/Themes/ThemesControllerNew",["Core/core-extend","Env/Env","View/Request","Core/CssLoader/CssLoader","Core/LinkResolver/LinkResolver"],function(e,n,s,t,r){"use strict";var o=this||(0,eval)("this"),i=null,d=e.extend([],{constructor:function(){this.css={},this.resolvedCss={themed:{},simple:{}};var e=o.contents&&o.contents.buildMode||"debug",s="true"===n.cookie.get("s3debug")||"debug"===e;if(this.simpleCssLinks={},this.themedCssLinks={},this.linkResolver=new r(s,n.constants.buildnumber,n.constants.wsRoot,n.constants.appRoot,n.constants.resourceRoot),this.cssLoader=new t(this.linkResolver),"undefined"!==typeof window)this.collectThemedCssFromDOM()},collectThemedCssFromDOM:function(){var e=document.getElementsByClassName("new-styles");this._parseLinks(e)},_parseLinks:function(e){for(var s=0;s<e.length;s++){var t=e[s].getAttribute("theme-name");if(t){var r=e[s].getAttribute("css-name");if(!this.resolvedCss.themed[t])this.resolvedCss.themed[t]={};this.resolvedCss.themed[t][r]={data:e[s],count:0}}else{var r=e[s].getAttribute("css-name");this.resolvedCss.simple[r]={data:e[s],count:0}}}},isCssLoaded:function(e){var s=this.resolveModule(e),t=this.resolvedCss.simple[s];return!!(t&&!t.data.then)},isThemedCssLoaded:function(e,s){var t=this.resolveModule(e),r;if(this.resolvedCss.themed[s])r=this.resolvedCss.themed[s][t];return!!(r&&!r.data.then)},pushCssThemedLoaded:function(e,s){var t=this.resolveModule(e);if(this.resolvedCss.themed[s]&&this.resolvedCss.themed[s][e]){var r;this.resolvedCss.themed[s][t].count++}else n.IoC.resolve("ILogger").error("Css is not loaded yet: "+e+" with theme "+s)},pushCssLoaded:function(e){var s=this.resolveModule(e);if(this.resolvedCss.simple[e]){var t;this.resolvedCss.simple[s].count++}else n.IoC.resolve("ILogger").error("Css is not loaded yet: "+e)},getSimpleCssList:function(){return this.simpleCssLinks},getThemedCssList:function(){return this.themedCssLinks},_createEmptyStyle:function(){return document.createElement("style")},_mountStyleInHead:function(e){window.document.head.appendChild(e)},addStyle:function(e,s,t){var r=this._createEmptyStyle();if(r.setAttribute("data-vdomignore",true),r.setAttribute("css-name",s),r.setAttribute("from-new-tc","true"),t)r.setAttribute("theme-name",t);return r.innerHTML=e,this._mountStyleInHead(r),r},pushCss:function(e){return this.simpleCssLinks[e]=true},pushThemedCss:function(e,s){if(!this.themedCssLinks[s])this.themedCssLinks[s]={};return this.themedCssLinks[s][e]=true},customLoadCssAsync:function(e,s){var t=this.resolveModule(e);return this.cssLoader.loadCssThemedAsync(t,s)},pushCssAsync:function(s){var t=this,r=t.resolveModule(s);if("undefined"!==typeof t.resolvedCss.simple[r])return t.resolvedCss.simple[r].count++,t.resolvedCss.simple[r].data;var e=t.cssLoader.loadCssAsync(s);return t.resolvedCss.simple[r]={data:e,count:1},e.then(function(e){e=t.fixCssUrls(e,t.linkResolver.resolveLink(s,"css")),t.resolvedCss.simple[r].data=t.addStyle(e,r)}),e},pushCssThemedAsync:function(s,t){var r=this;r.resolvedCss.themed[t]=r.resolvedCss.themed[t]||{};var o=r.resolveModule(s);if("undefined"!==typeof r.resolvedCss.themed[t][o])return r.resolvedCss.themed[t][o].count++,r.resolvedCss.themed[t][o].data;var e=r.cssLoader.loadCssThemedAsync(s,t);return r.resolvedCss.themed[t][o]={data:e,count:1},e.then(function(e){e=r.fixCssUrls(e,r.linkResolver.resolveCssWithTheme(s,t)),r.resolvedCss.themed[t][o].data=r.addStyle(e,o,t)}),e},removeCssThemed:function(e,s){var t=this,r=this.resolveModule(e),o;if(this.resolvedCss.themed[s]&&this.resolvedCss.themed[s][r])if((o=this.resolvedCss.themed[s][r]).data.then)o.data.then(function(){t.removeCssThemed(e,s)});else if(o.count<=1)o.data.remove(),delete this.resolvedCss.themed[s][r];else o.count--;else n.IoC.resolve("ILogger").error("Trying to remove not registered css: "+e+" with theme "+s)},removeCss:function(e){var s=this,t=this.resolveModule(e),r=this.resolvedCss.simple[t];if(r)if(r.data.then)r.data.then(function(){s.removeCss(e)});else if(r.count<=1)r.data.remove(),delete this.resolvedCss.simple[t];else r.count--;else n.IoC.resolve("ILogger").error("Trying to remove not registered css: "+e)},getCss:function(){return this.css},resolveModule:function(e){return this.linkResolver.fixOld(e)},fixCssUrls:function(e,t){return e.replace(/url\(.+?\)/g,function(e){if(~e.indexOf("data:")||/^url\((['"])\//.test(e)||/^url\(\//.test(e)||~e.indexOf("#"))return e;var s=e.slice(4,-1);if(/^(['"]).+(['"])$/.test(s))s=s.slice(1,-1);return'url("'+t.split("/").slice(0,-1).join("/")+"/"+s+'")'})}});return d.getInstance=function e(){if(process&&process.domain&&process.domain.req){if(!process.domain.req._$ThemesControllerNew)process.domain.req._$ThemesControllerNew=new d;return process.domain.req._$ThemesControllerNew}if("undefined"!==typeof window){if(!i)i=new d;return i}if(o){if(!o._$ThemesControllerNew)o._$ThemesControllerNew=new d;return o._$ThemesControllerNew}n.IoC.resolve("ILogger").error("Cannot create themes controller")},d});