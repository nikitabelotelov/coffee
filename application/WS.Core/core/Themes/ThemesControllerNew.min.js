define("Core/Themes/ThemesControllerNew",["Core/IoC","Core/core-extend","Core/constants","View/Request","Core/CssLoader/CssLoader","Core/LinkResolver/LinkResolver","Core/cookie"],function(o,e,t,s,r,n,i){"use strict";var d=this||(0,eval)("this"),l=null;function u(e,t){return e.replace(/url\(.+?\)/g,function(e){if(~e.indexOf("data:")||/^url\((['"])\//.test(e)||/^url\(\//.test(e))return e;var s=e.slice(4,-1);if(/^(['"]).+(['"])$/.test(s))s=s.slice(1,-1);return'url("'+t.split("/").slice(0,-1).join("/")+"/"+s+'")'})}var h=e.extend([],{constructor:function(){this.css={},this.resolvedCss={themed:{},simple:{}};var e=d.contents&&d.contents.buildMode||"debug",s="true"===i.get("s3debug")||"debug"===e;if(this.simpleCssLinks={},this.themedCssLinks={},this.linkResolver=new n(s,t.buildnumber,t.wsRoot,t.appRoot,t.resourceRoot),this.cssLoader=new r(this.linkResolver),"undefined"!==typeof window)this.collectThemedCssFromDOM()},collectThemedCssFromDOM:function(){for(var e=document.getElementsByClassName("new-styles"),s=0;s<e.length;s++){var t=e[s].getAttribute("theme-name");if(t){var r=e[s].getAttribute("css-name");if(!this.resolvedCss.themed[t])this.resolvedCss.themed[t]={};this.resolvedCss.themed[t][r]={data:e[s],count:1}}else{var r=e[s].getAttribute("css-name");this.resolvedCss.simple[r]={data:e[s],count:1}}}},isCssLoaded:function(e){var s=this.resolveModule(e),t=this.resolvedCss.simple[s];return!!(t&&!t.data.then)},isThemedCssLoaded:function(e,s){var t=this.resolveModule(e),r;if(this.resolvedCss.themed[s])r=this.resolvedCss.themed[s][t];return!!(r&&!r.data.then)},getSimpleCssList:function(){return this.simpleCssLinks},getThemedCssList:function(){return this.themedCssLinks},addStyle:function(e,s,t){var r=document.createElement("style");if(r.setAttribute("data-vdomignore",true),r.setAttribute("css-name",s),r.setAttribute("from-new-tc","true"),t)r.setAttribute("theme-name",t);return r.innerHTML=e,window.document.head.appendChild(r),r},pushCss:function(e){if(void 0!==typeof window)return this.simpleCssLinks[e]=true},pushThemedCss:function(e,s){if(void 0!==typeof window){if(!this.themedCssLinks[s])this.themedCssLinks[s]={};return this.themedCssLinks[s][e]=true}},pushCssAsync:function(s){var t=this,r=t.resolveModule(s);if("undefined"!==typeof t.resolvedCss.simple[r])return t.resolvedCss.simple[r].count++,t.resolvedCss.simple[r].data;var e=t.cssLoader.loadCssAsync(s);return t.resolvedCss.simple[r]={data:e,count:1},e.then(function(e){e=u(e,t.linkResolver.resolveLink(s,"css")),t.resolvedCss.simple[r].data=t.addStyle(e,r)}),e},pushCssThemedAsync:function(s,t){var r=this;r.resolvedCss.themed[t]=r.resolvedCss.themed[t]||{};var o=r.resolveModule(s);if("undefined"!==typeof r.resolvedCss.themed[t][o])return r.resolvedCss.themed[t][o].count++,r.resolvedCss.themed[t][o].data;var e=r.cssLoader.loadCssThemedAsync(s,t);return r.resolvedCss.themed[t][o]={data:e,count:1},e.then(function(e){e=u(e,r.linkResolver.resolveCssWithTheme(s,t)),r.resolvedCss.themed[t][o].data=r.addStyle(e,o,t)}),e},removeCssThemed:function(e,s){var t=this.resolveModule(e),r=this.resolvedCss.themed[s][t];if(r)if(r.data.then)o.resolve("ILogger").error("Trying to remove loading css");else if(1===r.count)r.data.remove(),delete this.resolvedCss.themed[s][t];else r.count--;else o.resolve("ILogger").error("Trying to remove not registered css")},removeCss:function(e){var s=this.resolveModule(e),t=this.resolvedCss.simple[s];if(t)if(t.data.then)o.resolve("ILogger").error("Trying to remove loading css");else if(1===t.count)t.data.remove(),delete this.resolvedCss.simple[s];else t.count--;else o.resolve("ILogger").error("Trying to remove not registered css")},getCss:function(){return this.css},resolveModule:function(e){return this.linkResolver.fixOldAndBundles(e)}});return h.getInstance=function e(){if(process&&process.domain&&process.domain.req){if(!process.domain.req._$ThemesControllerNew)process.domain.req._$ThemesControllerNew=new h;return process.domain.req._$ThemesControllerNew}if("undefined"!==typeof window){if(!l)l=new h;return l}if(d){if(!d._$ThemesControllerNew)d._$ThemesControllerNew=new h;return d._$ThemesControllerNew}o.resolve("ILogger").error("Cannot create themes controller")},h});