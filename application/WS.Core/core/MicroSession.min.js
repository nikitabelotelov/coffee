define("Core/MicroSession",["Core/cookie","Core/helpers/Object/isEmpty","Core/constants","Core/detection"],function(a,t){var e={_available:true,_ms:{},_msid:"",_storage:null,_sessionsLimit:5,_storageChangeHandler:function(t){if(!t)t=window.event;if("key"in t){if(t.key==this._msid&&null===t.newValue)try{localStorage.setItem(this._msid,JSON.stringify(this._ms))}catch(t){}}else if(!localStorage.getItem(this._msid))try{localStorage.setItem(this._msid,JSON.stringify(this._ms))}catch(t){}},syncMsid:function(){this._set("ws-msid",this._msid)},init:function(){var s=this;function t(t){var e=(t=t||window.event).target||t.srcElement;if(e.hasAttribute&&e.hasAttribute("href"))s.syncMsid()}if(this._prepareStorage(),!this._available)return;this._msid=this._getId();var e=this._get("ws-msid"),i=e?this._get(e):"",n;if(this._ms=i?JSON.parse(i):{},this._ms.sid=a.get("s3su"),this._set("ws-msid",""),this._set(this._msid,JSON.stringify(this._ms)),window.addEventListener)window.addEventListener("storage",this._storageChangeHandler.bind(this),false);else window.attachEvent("onstorage",this._storageChangeHandler.bind(this));if(window.addEventListener("unload",function(){s._garbageCollector(),s.syncMsid()}),window.addEventListener)document.addEventListener("click",t,true);else document.attachEvent("onclick",t);n=window.open,window.open=function(){var t;switch(s.syncMsid(),arguments.length){case 1:t=n(arguments[0]);break;case 2:t=n(arguments[0],arguments[1]);break;case 3:t=n(arguments[0],arguments[1],arguments[2])}return t}},_prepareStorage:function(){if("undefined"!==typeof localStorage)this._storage=window.localStorage;else this._available=false},_get:function(t){var e;return(e="undefined"===(e=this._storage.getItem(t))?void 0:e)?e.toString():void 0},_set:function(t,e){try{this._storage.setItem(t,e)}catch(t){}},_garbageCollector:function(){var t=[],e=a.get("s3su"),s,i,n,r;for(i in this._storage)if(this._storage.hasOwnProperty?this._storage.hasOwnProperty(i):true)if(/^s\d+$/.exec(i))t.push(parseInt(i.substr(1),10));t.sort();while(t.length>this._sessionsLimit){try{this._storage.removeItem("s"+t[0])}catch(t){}t.shift()}for(i=0,n=t.length;i<n-1;++i){if(r=this._get("s"+t[i]))try{s=JSON.parse(r)}catch(t){s=null}else s=null;if(s&&(!s.hasOwnProperty("sid")||e!==s.sid))this._storage.removeItem("s"+t[i])}},_clear:function(){this._storage.clear()},clearCurrentSession:function(){if(this._available)this._ms={},this._set(this._msid,"{}");else return false},isEmpty:function(){return t(this.toObject())},_getId:function(){if(this._available)return["s",""+(new Date).getTime()].join("");else return""},set:function(t,e){if(this._available)this._ms[t]=e,this._set(this._msid,JSON.stringify(this._ms));else return false},get:function(t){if(this._available)return this._ms[t];else return false},setPermanently:function(t,e){this._set(t,e)},getPermanently:function(t){return this._get(t)},remove:function(t){if(this._available)delete this._ms[t],this._set(this._msid,JSON.stringify(this._ms));else return false},toObject:function(){return this._ms}};return e.init(),e});