define("Core/xslt-async",["Env/Env","Core/core-extend","Core/helpers/axo","Core/Deferred","Core/ParallelDeferred"],function(m,e,a,h,p){var n={TRANSFORM_TO_TEXT:1,TRANSFORM_TO_DOC:2,TRANSFORM_TO_FRAGMENT:4,LOAD_URL:8,LOAD_TEXT:16};function r(e){if("string"==typeof e)e=e.replace(/[^\x09\x0A\x0D\x20-\uD7FF\uE000-\uFFFD\u10000-\u10FFFF]*/g,"");return e}function _(e,t){var n=/(document\('[0-9A-z\/)(.,-]+'\))/gi,r,o;if(e.length>0){var i=t.createElement("xsl:template");i.setAttribute("match","ws-foreign-documents-namespace"),t.documentElement.appendChild(i);for(var s=0,a=e.length;s<a;s++)if((o=(r=e[s][0].getAttribute("select")).split(n))&&o[2])e[s][0].setAttribute("select",e[s][1]+o[2]);else e[s][0].setAttribute("select",e[s][1])}}function o(e){var t=null;if(e)if(e.parseError){if(0!==e.parseError.errorCode)t=e.parseError.reason}else{var n=e.getElementsByTagName("parsererror");if(n.length)t=n[0].textContent}else t="Empty document";return t}var t=e.extend({},{$protected:{_xmlDoc:"",_xslDoc:"",_loadedFiles:[],_loadedDefs:[],_options:{xml:"",xsl:"",errback:void 0},_nsResolver:null},$constructor:function(){var e=new s({name:this._options.xml,errback:this._options.errback}).getDocument(),t=new s({name:this._options.xsl}).getDocument(),n=e instanceof h?e:(new h).callback(e),r=t instanceof h?t:(new h).callback(t);if(this._mainDef=new p,this._mainDef.push(n),this._mainDef.push(r),this._xmlDoc=null,this._xslDoc=null,m.detection.webkit||m.detection.chrome)this._nsResolver=function(e){switch(e){case"xsl":return"http://www.w3.org/1999/XSL/Transform";default:return null}}},checkDocument:function(e){var t=o(e);if(t)return t;return null},execute:function(){var t=this,n=new h;return t._mainDef.done().getResult().addCallback(function(e){if(t._xmlDoc=t._xmlDoc||e[0],t._xslDoc=t._xslDoc||e[1],m.detection.webkit||m.detection.chrome)t._chromeWorkaround().addCallback(function(){n.callback(t)});else{if(m.detection.firefox)t._xslDoc=t.preparseIncludeNames(t._xslDoc);n.callback()}}),n},_loadDoc:function(e){if(-1==this._loadedFiles.indexOf(e)){var t=new s({name:e}).getDocument();return this._loadedFiles.push(e),this._loadedDefs.push(t),t}else return this._loadedDefs[this._loadedFiles.indexOf(e)]},_chromeWorkaround:function(){var e=this,t=new p,n=new h,r=new h,o;if(this._preparseImports(this._xslDoc).done().getResult().addCallback(function(){e._preparseImportAppliance(e._xslDoc),n.callback()}),this._preparseIncludes(this._xslDoc).done().getResult().addCallback(function(){r.callback()}),(o=this._preparseDocumentFunction(this._xmlDoc,this._xslDoc))instanceof h)t.push(o);return t.push(n),t.push(r),t.done().getResult()},_xslIEWorkaround:function(e){var t=new p,n=new h,r=this;if(e.selectNodes("//xsl:import").length){var o=new h;t.push(o),this._xslIEImports(e,"//xsl:import").addCallback(function(e){e=r._preparseImportApplianceIE(e),o.callback(e)})}if(e.selectNodes("//xsl:include").length){var i=new h;t.push(i),this._xslIEIncludes(e,"//xsl:include").addCallback(function(e){i.callback(e)})}if(e.selectNodes("//include").length){var s=new h;t.push(s),this._xslIEIncludes(e,"//include").addCallback(function(e){return s.callback(e),e})}return t.done().getResult().addCallback(function(){if(e instanceof h)e.addCallbacks(function(e){n.callback(e)},function(e){throw e});else n.callback(e)}),n},_preparseImportApplianceIE:function(e){var t=e.selectNodes("//xsl:apply-imports");if(t.length>0){var n=t[0],r=n.parentNode,o=e.createElement("xsl:apply-templates");o.setAttribute("select","."),o.setAttribute("mode","imports"),r.replaceChild(o,n)}return e},_moveChildrenIE:function e(t,n){if(n.childNodes.length>0)for(var r=0;r<t.length;r++)n.insertBefore(t[r],n.childNodes[0]);else for(var r=0;r<t.length;r++)n.appendChild(t[r]);return n},_checkTemplates:function e(t,n){if(t.getAttribute("match"))for(var r=0;r<n.length;r++)if(t.getAttribute("match"))if(n[r].getAttribute("match")===t.getAttribute("match"))this._moveChildrenIE(t.childNodes,n[r]),t.setAttribute("mode","imports")},_xslIEImports:function e(t,n){var r=new p,o=new h,i=t.selectNodes(n),s=t.selectNodes("//xsl:template"),a=t.documentElement,l=this,c;if(i.length>0)for(var u=0;u<i.length;u++)(function(n){var e=i[n].getAttribute("href"),t=new d({name:e}).getDocument();if(t)r.push(t.addCallback(function(e){if(e)l._xslIEWorkaround(e).addCallback(function(e){var t=e.documentElement.childNodes;while(t.length>0){if("xsl:template"===(c=t.nextNode()).nodeName)l._checkTemplates(c,s);a.insertBefore(c,i[n])}a.removeChild(i[n])});else a.removeChild(i[n])}));else a.removeChild(i[n])})(u);return r.done().getResult().addCallback(function(){o.callback(t)}),o},_xslIEIncludes:function e(t,n){var r=new p,o=new h,i=t.selectNodes(n),s=t.documentElement,a=this,l;if(i.length>0)for(var c=0;c<i.length;c++)(function(n){var e=i[n].getAttribute("href"),t=new d({name:e}).getDocument();if(t)r.push(t.addCallback(function(e){if(e){var t=e.documentElement.childNodes;while(t.length>0)l=t.nextNode(),s.insertBefore(l,i[n]);s.removeChild(i[n])}else s.removeChild(i[n])}));else s.removeChild(i[n])})(c);return r.done().getResult().addCallback(function(){if(t instanceof h)t.addCallbacks(function(e){o.callback(e)},function(e){throw e});else o.callback(t)}),o},_convertAbsolutePath:function(e,t){if("/"!==e.charAt(0)){if(""===t)t=window.location.protocol+"//"+window.location.hostname;else if(t.lastIndexOf("/")>t.indexOf("//")+1)t=t.substring(0,t.lastIndexOf("/"));while(/^\.\.\//.test(e)){if(t.lastIndexOf("/")>t.indexOf("//")+1)t=t.substring(0,t.lastIndexOf("/"));e=e.substring(3)}if(window.location.origin){if(m.constants.resourceRoot)e=window.location.origin+e.replace("resources/",m.constants.resourceRoot)}else e=t+"/"+e;e=e.replace("./","")}else if(m.constants.resourceRoot&&-1===e.indexOf(m.constants.resourceRoot))e=e.replace("/resources/",m.constants.resourceRoot);return e},preparseIncludeNames:function e(t){var n=t.getElementsByTagName("xsl:include");if(n.length>0)for(var r=0;r<n.length;r++)n[r].setAttribute("href",this._convertAbsolutePath(n[r].getAttribute("href"),t.URL));return t},_preparseIncludes:function(s){var r=new p,a=s.getElementsByTagName("include"),e=a.length,l=this;if(0===e)e=(a=s.getElementsByTagName("xsl:include")).length;for(var t=0;t<e;t++)(function(e){var o=a[e],t=l._convertAbsolutePath(o.getAttribute("href"),s.URL),n=l._loadDoc(t),i=o.parentNode;if(n)r.push(n.addCallback(function(e){if(e)for(var t=e.documentElement.childNodes,n=0,r=t.length;n<r;n++)i.insertBefore(s.importNode(t[n],true),o);i.removeChild(o)}));else i.removeChild(o)})(t);return r},_preparseImportAppliance:function(e){var t=e.getElementsByTagName("apply-imports");while(t.length>0){var n=t[0],r=n.parentNode,o=e.createElement("xsl:apply-templates");o.setAttribute("select","."),o.setAttribute("mode","imports"),r.replaceChild(o,n)}},_preparseImports:function(d){var r=new p,o,e,f=this;if(m.detection.isMac)o=d.getElementsByTagName("xsl:import");else o=d.getElementsByTagName("import");e=o.length;for(var t=0;t<e;t++)(function(e){var c=o[e],t=f._convertAbsolutePath(c.getAttribute("href"),d.URL),n=f._loadDoc(t),u=c.parentNode;if(n)r.push(n.addCallback(function(e){if(e)for(var t=e.documentElement.childNodes,n=0,r=t.length;n<r;n++){var o=t[n];if("xsl:template"==o.nodeName){if(o.hasAttribute("name")){var i=o.getAttribute("name"),s=d.evaluate("count(//xsl:template[@name='"+i+"'])",d,f._nsResolver,XPathResult.NUMBER_TYPE,null);if(s&&s.numberValue>0){m.IoC.resolve("ILogger").log("xslt","Ignored duplicate named template: "+i);continue}}if(o.hasAttribute("match")){var a=o.getAttribute("match"),l=d.evaluate("count(//xsl:template[@match='"+a+"'])",d,f._nsResolver,XPathResult.NUMBER_TYPE,null);if(l&&l.numberValue>0)o.setAttribute("mode","imports")}}u.insertBefore(d.importNode(o,true),c)}u.removeChild(c)}));else u.removeChild(c)})(t);return r},handleForeignDoc:function(e,t,n,r,o,i,s){var a="x"+e.replace(/[\/)(:]/g,"-")+"-document",l=t.createElement(a),c;if(this._getForeignDocContainer(t).appendChild(l),l.appendChild(t.importNode(i.documentElement,true)),s)n="//ws-foreign-documents-namespace/"+a;else n="//ws-foreign-documents-namespace/"+a+n.substring(e.length+12);r.push([o,n])},_preparseDocumentFunction:function(n,e){var t=e.evaluate("//*[contains(@select, 'document(')]",e,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null),r,o=[],i=this,s=false,a=new h,l=new p;while(null!==(r=t.iterateNext())){var c=r.getAttribute("select"),u=c.match(/document\('([^]+)'\)/);if(u&&u.length>0){var d=this._convertAbsolutePath(u[1],e.URL),f=this._loadDoc(d);if(f)if(s=f instanceof h)(function(t,e){f.addCallback(function(e){return i.handleForeignDoc.call(this.xslt,t,n,c,o,this.doc,e,true),e}.bind({xslt:i,doc:e}))})(d,r),l.push(f);else i.handleForeignDoc.call(this,d,n,c,o,r,f)}}if(s)return l.done().getResult().addCallback(function(){_(o,e),a.callback(true)}),a;else _(o,e)},_getForeignDocContainer:function(e){var t=e.getElementsByTagName("ws-foreign-documents-namespace")[0];if(!t)t=e.createElement("ws-foreign-documents-namespace"),e.documentElement.appendChild(t);return t},_insertForeignDoc:function(e,t){var n=new s({name:t}),r="xxx",o=this._getForeignDocContainer(e),i=e.createElement(r);i.appendChild(i.importNode(n.getDocument(),true)),o.appendChild(i)},_ieAddParams:function(e,t){if(!t)return e;for(var n in t)try{var r=t[n];if("boolean"===typeof r||isNaN(parseInt(r,10))&&("string"!==typeof r||"'"!==r.charAt(0)))r="'"+r+"'"}catch(e){throw new Error("Problems with setting parameter "+n+" in the xsl transform")}return e},transformToText:function(t){var n=new h,r;if(window.XMLSerializer&&(!m.detection.isIE||m.detection.isIE12))return r=this.transformToDocument(t),this.includeCss(r,function(e){n.callback((new XMLSerializer).serializeToString(e))}),n;else if(a){var o=this;return this._xslIEWorkaround(this._xslDoc).addCallback(function(e){o._xslDoc=e,r=o._ieAddParams(o._xslDoc,t),o.includeCss(r,function(e){try{n.callback(o._xmlDoc.transformNode(e))}catch(e){n.errback(e)}},true)}),n}throw new Error("Transform to text is not supported in your environment")},includeCss:function(o,i,s){var a=$(o).find("head"),e=a.find("link"),n=[],t=new p;if(e.length)(e=e.toArray()).forEach(function(e){var t=$(e);n.push(t.attr("href")),t.remove()}),n.forEach(function(n){t.push(function(){var e=new XMLHttpRequest,t=new h;return e.open("GET",n,true),e.send(""),e.onreadystatechange=function(){if(4==e.readyState)t.callback(e)},t})});t.done().getResult().addCallback(function(e){for(var t in e){if(!e.hasOwnProperty(t))continue;var n=e[t];if(s){var r=o.createElement("style");if(r.text=n.responseText,a&&a[0])a[0].appendChild(r)}else a.append($("<style>"+n.responseText+"</style>"))}i(o)})},transformToDocument:function(e){if(window.XSLTProcessor){var t=new XSLTProcessor;for(var n in e)if(null!==e[n])t.setParameter(null,n,e[n]);if(t.transformToDocument)return t.importStylesheet(this._xslDoc),t.transformToDocument(this._xmlDoc)}else if(a){var r=a("Microsoft.XMLDOM");if(this._ieAddParams(r,e),"transformNodeToObject"in this._xmlDoc)return this._xslDoc=this._xslIEWorkaround(this._xslDoc),this._xmlDoc.transformNodeToObject(this._ieAddParams(this._xslDoc,e),r),r}throw new Error("Transform to document is not supported in your environment")},transformToFragment:function(e,t){if(window.XSLTProcessor){var n=new XSLTProcessor;for(var r in t)n.setParameter(null,r,t[r]);if(n.transformToFragment)return n.importStylesheet(this._xslDoc),n.transformToFragment(this._xmlDoc,e)}else if(a){var o=e.createDocumentFragment(),i=this._xmlDoc.transformNode(this._ieAddParams(this._xslDoc,t)),s=e.createElement("div");s.innerHTML=i;while(s.hasChildNodes())o.appendChild(s.firstChild);return o}throw new Error("Transform to fragment is not supported in your environment")},getCapabilities:function(){var e=n.LOAD_URL,t;if(window.DOMParser)e|=n.LOAD_TEXT;if(window.XSLTProcessor){if((t=new XSLTProcessor).transformToDocument)e|=n.TRANSFORM_TO_DOC;if(t.transformToFragment)e|=n.TRANSFORM_TO_FRAGMENT}else if(a){if("transformNodeToObject"in(t=a("Microsoft.XMLDOM")))e|=n.TRANSFORM_TO_DOC;if("transformNode"in t)e|=n.TRANSFORM_TO_TEXT;if("loadXML"in t)e|=n.LOAD_TEXT}if(window.XMLSerializer)e|=n.TRANSFORM_TO_TEXT;return e},destroy:function(){this._xmlDoc=null,this._xslDoc=null,this._options=null}}),s=function(e){return m.IoC.resolve("IXMLDocument",e)},d=e.extend({},{$protected:{_options:{name:"",errback:void 0},_doc:null},$constructor:function(){this._doc=this._loadDocument(this._options.name)},getDocument:function(){return this._doc},checkDocument:function(e){var t=o(e);if(null!==t&&!this._options.errback)throw new EvalError("Parse error: "+t);return e},_loadDocument:function(e){var t=null,n=this,r;if(e.documentElement)t=e;else t=this["_loadDocumentFrom"+(this._isUrl(e)?"Url":"String")](e);if(t instanceof h){if(t.addCallback(function(e){return n.checkDocument(e)}),this._options.errback)t.addErrback(this._options.errback);r=t}else(r=new h).callback(this.checkDocument(t));return r},_loadDocumentFromString:function(e){var t=null,n=new h;if(e=r(e),a)(t=a("Microsoft.XMLDOM")).async=false,t.loadXML(e);else if(window.DOMParser)t=(new DOMParser).parseFromString(e,"text/xml");if(null!==t)return n.callback(t),n;throw new Error("Your environment is not able to parse XML documents from string")},_loadDocumentUsingXHR:function(e){var t=new XMLHttpRequest,n=new h;if(m.detection.chrome&&/\.(xml|xsl)$/.test(e))e+="?_="+Math.random();return t.open("GET",e,true),t.send(""),t.onreadystatechange=function(){if(4==t.readyState)n.callback(t)},n},_loadDocumentFromUrl:function(e){var t;if(a){var n=a("Microsoft.XMLDOM");if(window.XMLHttpRequest)(t=this._loadDocumentUsingXHR(e)).addCallback(function(e){return n.loadXML(r(e.responseText)),n});else n.async=false,n.load(e),t.callback(n);return t}else return(t=this._loadDocumentUsingXHR(e)).addCallback(function(e){return e.responseXML}),t},_isUrl:function(e){if(void 0===e.substr||""===e||!e)return false;if(!/^http[s]?:/.test(e)){var t=e.substr(0,1);if("/"!=t&&"."!=t)if("<"==t)return false}return true},destroy:function(){this._doc=null,this._options=null}});return m.IoC.bind("IXMLDocument",d),m.constants.XSLTCaps=n,t});