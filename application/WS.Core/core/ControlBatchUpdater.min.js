define("Core/ControlBatchUpdater",["Core/core-extend","Core/IoC","Core/Deferred","Core/ParallelDeferred","Core/core-instance","Core/helpers/Object/isEmpty","Core/helpers/Function/runDelayed"],function(e,h,u,f,i,O,t){var a=new(e({},{$protected:{_applyUpdateInProcess:false,_batchUpdateSpanHint:null,_batchUpdateCount:0,_batchUpdateControls:{},_delayedEventsHash:{},_delayedActionsHash:{},_delayedActionsHashLastOrder:0,_con:null,_debugEnabled:false,_delayedEvents:[],_uids:{},_batches:{}},$constructor:function(){this._setDebugEnabled(this._debugEnabled)},_dummyUpdate:{},_nop:function(){},_setDebugEnabled:function(e){this._debugEnabled=e;var o=this;if(this._con=window&&window.console,!this._con||!this._debugEnabled)this._con={log:this._nop,info:this._nop,group:this._nop,groupEnd:this._nop,profile:this._nop,profileEnd:this._nop};if(!this._con.group){this._con.groupLevel=0,this._con.group=function(e,t,n){o._con.log(e," ",t," ",n),o._con.groupLevel++};var s=this._con.log;this._con.log=function(e,t,n){for(var a="",i=2*(o._con.groupLevel+1),r=0;r<i;r++)a+="_";if(s.call)s.call(o._con,a," ",e," ",t," ",n);else s(a," ",e," ",t," ",n)},this._con.groupEnd=function(){o._con.groupLevel--}}if(!this._con.profile)this._con.profile=this._nop;if(!this._con.profileEnd)this._con.profileEnd=this._nop;this.addComment=this._debugEnabled?this._addComment:this._nop,this.getType=this._debugEnabled?this._getType:this._nop},ensureBatchUpdate:function(e){if(!this.haveBatchUpdate()&&!this.haveApplyUpdateInProcess())this.beginBatchUpdate(e),t(this.endBatchUpdate.bind(this,e))},beginBatchUpdate:function(e){if(!(e in this._batches))this._batches[e]=0;if(this._batches[e]++,0===this._batchUpdateCount)this._batchUpdateSpanHint=e;this._batchUpdateCount++},_endBatchUpdateFinish:function(){this._con.group("endBatchUpdateFinish ",this._batchUpdateSpanHint);try{this._applyBatchUpdate(this._batchUpdateSpanHint,true)}finally{try{this._batchUpdateSpanHint=null;var e=this._delayedEvents,t=function(e){return e&&(!e.control||!e.control.isDestroyed())};this._delayedEvents=[],this._delayedEventsHash={},this._runDelayedActions(),e.filter(t).forEach(function(e){if(e.event)e.control._notify.apply(e.control,e.args);else if(e.func)e.func.apply(e.control)})}finally{this._con.groupEnd()}}},endBatchUpdate:function(e){var t;if(this._batches[e])t=true,this._batches[e]--;if(0===this._batches[e])delete this._batches[e];if(t)this._batchUpdateCount--;if(0===this._batchUpdateCount)this._endBatchUpdateFinish(e)},createBatchUpdateWrapper:function(e,t,n){return this._createBatchUpdateWrapperOpts({hint:e,callback:t,thisObject:n})},createBatchUpdateWrapperNoWaitDeferred:function(e,t,n){return a._createBatchUpdateWrapperOpts({hint:e,waitDeferredResult:false,callback:t,thisObject:n})},_createBatchUpdateWrapperOpts:function(n){var e=this,t=Object.keys(n).reduce(function(e,t){return e[t]=n[t],e}.bind(this),{});if("string"===typeof t.callback){var a=t.callback;t.callback=function(){return this[a].apply(this,arguments)}}if(t.thisObject)return function(){t.args=arguments;try{return e._runInBatchUpdateOpts(t)}finally{t.args=null}};else return function(){t.args=arguments,t.thisObject=this;try{return e._runInBatchUpdateOpts(t)}finally{t.thisObject=null,t.args=null}}},runInBatchUpdate:function(e,t,n){return this._runInBatchUpdate("",t,e,n)},_runInBatchUpdate:function(e,t,n,a){return this._runInBatchUpdateOpts({hint:e,thisObject:t,callback:n,args:a})},_runInBatchUpdateOpts:function(e){var t=e||{},o=t.hint,s=t.thisObject,l=t.callback,c=t.args,d=void 0!==t.waitDeferredResult?t.waitDeferredResult:true,n;function a(){var t=this,e=true,n=false;function a(){return function(e){return t.endBatchUpdate(o),e}}function i(e){h.resolve("ILogger").error("ControlBatchUpdater","_runInBatchUpdate: "+rk("нельзя добавить обработчик в")+" "+e+": "+rk("обработчики заблокированы")+". hint: "+o)}this.beginBatchUpdate(o);try{var r=l.apply(s,c||[]);if(r instanceof u){if(e=false,d)if(r.isCallbacksLocked())i("Deferred");else r.addCallbacks(a("Deferred"),a("Deferred Error")),n=true}else if(r instanceof f)if(e=false,d)if(r.getResult().isCallbacksLocked())i("ParallelDeferred");else r.getResult().addCallbacks(a("Parallel Deferred"),a("Parallel Deferred Error")),n=true}finally{if(e)this.endBatchUpdate(o);else if(!d)this.endBatchUpdate(o);else if(!n)this.endBatchUpdate(o)}return r}function i(){return l.apply(s,c||[])}return(this._applyUpdateInProcess?i:a).apply(this)},getType:null,_getType:function(e){var t=e.getContainer()&&e.getContainer().attr("type");if(!t)if(i.instanceOfModule(e,"Deprecated/Controls/ToolBar/ToolBar"))t="@Control/ToolBar";else if(i.instanceOfModule(e,"Deprecated/Controls/OperationsPanel/OperationsPanel"))t="@Control/OperationsPanel";else if(i.instanceOfModule(e,"Lib/Control/Window/Window"))t="@Control/Window";else if(i.instanceOfModule(e,"Lib/Control/Dialog/Dialog"))t="@Control/Dialog";else if(i.instanceOfModule(e,"Deprecated/Controls/SimpleDialogAbstract/SimpleDialogAbstract"))t="@Control/SimpleDialogAbstract";else if(i.instanceOfModule(e,"Deprecated/Controls/Tabs/Tabs"))t="@Control/Tabs";else if(i.instanceOfModule(e,"Lib/Control/HTMLView/HTMLView"))t="@Control/HTMLView";else if(i.instanceOfModule(e,"Deprecated/Controls/FiltersArea/FiltersArea"))t="@Control/FiltersArea";else if(i.instanceOfModule(e,"Lib/Control/TemplatedArea/TemplatedArea"))t="@Control/TemplatedArea";else if(i.instanceOfModule(e,"Lib/Control/TemplatedAreaAbstract/TemplatedAreaAbstract"))t="@Control/TemplatedAreaAbstract";else if(i.instanceOfModule(e,"Lib/Control/AreaAbstract/AreaAbstract"))t="@Control/AreaAbstract";return t},addComment:null,_addComment:function(e,t){if(!e.comments)e.comments=[t];else e.comments.push(t)},_ensureGetBatchUpdateData:function(e){var t=e._getBatchUpdateData();if(void 0===t)t={},e._setBatchUpdateData(t);return t},_getUID:function(e){var t=this._ensureGetBatchUpdateData(e);if(void 0===t.uid){var n=e.getId(),a;if(void 0===this._uids[n]){if(this._uids[n]=0,t.uid=n,!e.isDestroyed())e.once("onDestroy",function(){delete this._uids[n]}.bind(this))}else a=this._uids[n]+1,this._uids[n]=a,t.uid=n+"_"+a}return t.uid},_checkDelayedEventName:function(e,t,n){var a=e+":"+this._getUID(n),i=this._delayedEventsHash[a],r=this._delayedEvents.length;if(!i)i=this._delayedEventsHash[a]={last:void 0};if(void 0!==i.last&&t)this._delayedEvents[i.last]=null;i.last=r},addDelayedFunc:function(e,t,n){if(e)this._checkDelayedEventName(e,true,t);this._delayedEvents.push({func:n,control:t})},addDelayedEvent:function(e,t,n,a){if(n.getEventHandlers(e))this._checkDelayedEventName(e,t,n),this._delayedEvents.push({event:e,control:n,args:a})},registerDelayedAction:function(e,t,n){this._delayedActionsHash[e]={actionFunc:t,uniqueInGroup:n||"DefaultActions",delayed:false,args:[],order:0}},_addDelayedAction:function(e,t){var n=this._delayedActionsHash[e];if(n)for(var a in this._delayedActionsHashLastOrder++,n.delayed=true,n.args=t,n.order=this._delayedActionsHashLastOrder,this._delayedActionsHash)if(this._delayedActionsHash.hasOwnProperty(a)){var i=this._delayedActionsHash[a];if(n!==i&&i.uniqueInGroup===n.uniqueInGroup)i.delayed=false}},runBatchedDelayedAction:function(e,t){if(this.haveBatchUpdate())this._addDelayedAction(e,t);else this._runInBatchUpdate("runBatchedDelayedAction."+e,this,function(){this._addDelayedAction(e,t)})},addBatchSizeChanged:function(e,t){var n=this._getUID(e),a=this._batchUpdateControls,i=a[n];if(!i)i=a[n]={control:e,sizeChanged:true};if(t)i.recalculateOwnSize=true},_runDelayedActions:function(){this._delayedActionsHashLastOrder=0;var e=Object.keys(this._delayedActionsHash).reduce(function(e,t){var n=this._delayedActionsHash[t];if(n.delayed)e.push([t,n.args,n.order]);return n.delayed=false,n.args=[],e}.bind(this),[]);for(var t in e.sort(function(e,t){return e[2]-t[2]}),e)if(e.hasOwnProperty(t)){var n=e[t],a=n[0],i=n[1]||[],r=this._delayedActionsHash[a];if(r)r.actionFunc.apply(this,i)}},applyBatchUpdateIntermediate:function(e){this._con.group("applyBatchUpdateIntermediate ",e);try{this._applyBatchUpdate(e,false)}finally{this._con.groupEnd()}},_applyBatchUpdate:function(l,p){var c,d,_=this,y=this.addComment,h=this.getType,g=this._debugEnabled;function n(e){return!!i.instanceOfMixin(e,"Lib/Mixins/LikeWindowMixin")}function a(e){return!!i.instanceOfModule(e,"SBIS3.CONTROLS/ScrollContainer")}function r(e){if(n(e))return true;if(a(e)){var t=e.getParent();while(t){if(n(t))return false;if(a(t))return false;t=t.getParent()}return true}}function u(e){var t=e.getParent(),n=t&&_._getUID(t),a,i;if(n&&!r(e)){if(!(a=d[n]))i=u(t),a={control:t,type:h(t),children:{}},i.children[n]=a,d[n]=a}else a=c;return a}function b(e){return e.control._haveAutoSize()}function v(e){return e.map(function(e){return e.control})}function C(e,t){var n=e.isVisible(),a;if(n){a=e.getContainer();do{n=!a.hasClass("ws-hidden"),a=a.parent()}while(n&&0!==a.length&&a.get(0)!==t)}return n}function o(e,t){var n=e.children||{};for(var a in n)if(n.hasOwnProperty(a)){var i;o(n[a],t),t(e)}}function U(e){var i=e.control,r=0;function t(e){var t=e.update,n,a;if(t&&t.sizeChanged){if(void 0===(a=(n=_._ensureGetBatchUpdateData(i)).delayedRecalkData))a=[],n.delayedRecalkData=a;a.push({control:e.control,recalculateOwnSize:!!t.recalculateOwnSize}),r++}}if(o(e,t),t(e),y(e,"невидимый"),0!==r&&g)y(e,"отложено "+r+" элементов")}function D(n,a,i){var e=n.update||_._dummyUpdate,t=!n.children||O(n.children),r=e.sizeChanged,o=n.control,s=a||C(o,i),l=!s&&o._needRecalkInvisible(),c,d,h,u,f;if(s||l){if(!s)y(n,"невидимый - всё равно пересчитываем"),U(n);u=b(n),o._beforeChildrenBatchCalc&&o._beforeChildrenBatchCalc();try{if(f=(f=o.getContainer())&&f.get(0),c=Object.keys(n.children).reduce(function(e,t){if(D(n.children[t],l||a,f||i))e.push(n.children[t]);return e},[]),!t&&g)y(n,u?"прозрачный":"непрозрачный"),y(n,c.length+" изм.");if(d=r||c.length>0&&u,c.length>0||e.recalculateOwnSize){if(!(h=o._onSizeChangedBatch&&o._onSizeChangedBatch(v(c))))d=false;if(p&&o.hasEventHandlers("onBatchFinished"))o._notifyBatchDelayed("onBatchFinished");if(n.needSendOnResize=!!o._onResizeHandlerBatch,g)if(n.needSendOnResize)y(n,"пакетный - есть изм. узлы! - "+(h?"есть изм.":"нет изм."));else y(n,"пакетный - пересчёт себя (нет изм. дочерних)")}else if(g)y(n,t?"пакетный - листовой":"пакетный - нет изм. узлов")}finally{o._afterChildrenBatchCalc&&o._afterChildrenBatchCalc()}}else U(n),d=r;return d}function f(e,t){if(e.needSendOnResize&&!t){if(t=true,!e.control.isDestroyed())if(e.control._template){if(false!==e.control._mounted)e.control._onResizeHandlerBatch()}else e.control._onResizeHandlerBatch();y(e,"*")}if(!t)for(var n in e.children)if(e.children.hasOwnProperty(n)){var a;f(e.children[n],t)}}function B(e){var t,n,a,i;for(a=e.type+" ("+(e.control?_._getUID(e.control)+" - ":"")+") ",t=0,n=(i=e.comments||[]).length;t<n;t++)a+=i[t]+(t<n-1?", ":"");if(!O(e.children)){for(var r in _._con.group(a,e.control&&e.control.getContainer()),e.children)if(e.children.hasOwnProperty(r))B(e.children[r]);_._con.groupEnd()}else _._con.log(a,e.control&&e.control.getContainer())}function e(){for(var e in c={control:null,children:{}},d={},this._con.group("_applyBatchUpdate: "+l),this._batchUpdateControls)if(this._batchUpdateControls.hasOwnProperty(e)){var t=this._batchUpdateControls[e],n=t.control;if(n&&!n.isDestroyed()){var a=h(n),i=u(n),r;if(i!==c||t.recalculateOwnSize){if(r=i.children[e])r.control=n,r.type=a;else r={control:n,type:a,children:{}},i.children[e]=r,d[e]=r;r.update=t}}}if(p)this._batchUpdateControls={};var o=$("html").get(0);for(var s in c.children)if(c.children.hasOwnProperty(s)){var r;D(r=c.children[s],false,o)}if(f(c,false),this._debugEnabled)B(c);this._con.groupEnd()}this._applyUpdateInProcess=true;try{if(e.call(this),p&&!O(this._batchUpdateControls))e.call(this)}finally{if(p)this._batchUpdateControls={};this._applyUpdateInProcess=false}},haveBatchUpdate:function(){return this._batchUpdateCount>0},haveApplyUpdateInProcess:function(){return this._applyUpdateInProcess},_needDelayedRecalk:function(e){var t=e._getBatchUpdateData();return t&&t.delayedRecalkData},_doDelayedRecalk:function(n){var i=this,e=n._getBatchUpdateData(),t=e&&e.delayedRecalkData,a=t.reduce(function(e,t){if(n!==t.control)e.push(t);return e},[]);if(e)delete e.delayedRecalkData;function r(e){var t;if(i._debugEnabled)t="_doDelayedRecalk: "+e+i.getType(n)+": "+i._getUID(n);else t="_doDelayedRecalk "+e;return t}function o(e,a){function t(){for(var e in a)if(a.hasOwnProperty(e)){var t=a[e],n=t.control;if(n&&!n.isDestroyed())n._notifyOnSizeChanged(n,n,t.recalculateOwnSize)}}i._runInBatchUpdate(r(e),i,t)}o("-1 step-",t),this.addDelayedFunc("doDelayedReCalc -2 step-",n,function(){o("-2 step-",a)})}}));return a});