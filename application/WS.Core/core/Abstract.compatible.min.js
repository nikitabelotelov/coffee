define("Core/Abstract.compatible",["Core/EventBus","Core/helpers/Object/find","Core/IoC","Core/helpers/Object/isPlainObject"],function(r,h,s,n){"use strict";function c(t,n,e){if(e._getChannel)e._getChannel().once(t,n,e);else e.once(t,n,e)}function l(t,n,e){if(e._getChannel)e._getChannel().subscribe(t,n,e);else e.subscribe(t,n,e)}function u(t,n,e){if(e._getChannel)e._getChannel().unsubscribe(t,n);else e.unsubscribe(t,n)}function f(t,e,i,s,r,o){return t._subscriptions.filter(function(t){var n=(void 0===e||e===t.control)&&(void 0===i||i===t.event)&&(void 0===s||s===t.handler)&&(void 0===r||r===t.onceWrapper);return o?n:!n})}function a(e,t,n,i,s,r){return e._subDestroyControls.filter(function(n){var t=!h(e._subscriptions,function(t){return t.control===n.control});return r?t:!t})}function i(t){return t.length<=3&&"string"===typeof t[0]&&(!t[1]||Array.isArray(t[1]))&&(!t[2]||n(t[2]))}function _(t){if(i(t))return t;var n,e;return[t[0],Array.prototype.slice.call(t,1)]}var b={_getOptions:function(){return this._options||{}},_setOptions:function(t,n){if(t instanceof Object){var e=Object.keys(t),i;for(i=0;i<e.length;i++)this._setOption(e[i],t[e[i]],n)}},_getOption:function(t){if(this._options&&t in this._options)return this["_$"+t]=this._options[t];if("_$"+t in this)return this["_$"+t];if("enabled"===t)return true;s.resolve("ILogger").info(this._moduleName||"Abstract",'Метод _getOption вызвали для несуществующей опции "'+t+'"')},_setOption:function(t,n,e){var i=this._options&&t in this._options||"_$"+t in this;if(!e&&!i)s.resolve("ILogger").info(this._moduleName||"Abstract",'Метод _setOption вызвали для несуществующей опции "'+t+'"');if(i)if(this["_$"+t]=n,this._options)this._options[t]=n},_hasOption:function(t){if(this._options&&t in this._options)return true;return"_$"+t in this},subscribeTo:function(t,n,e){return this._subscribeTo(t,n,e,false)},subscribeOnceTo:function(t,n,e){return this._subscribeTo(t,n,e,true)},_subscribeTo:function(n,e,i,t){if(!n.isDestroyed||!n.isDestroyed()&&!this.isDestroyed()){if(!this._notifyOriginCompat&&this._notify._isVdomNotify)this._notifyOriginCompat=this._notify,this._notify=function(){var t;if(this._mounted||!this._destroyed)t=this._notifyOriginCompat.apply(this,_(arguments));return t=b._notify.apply(this,arguments)||t}.bind(this);if("function"!==typeof i)throw new Error(rk("Аргумент handler у метода subscribeTo должен быть функцией"));var s,r,o;if(t)c(e,i,n);else l(e,i,n);if(t)r=function(){this._unsubscribeFrom(n,e,i,r)}.bind(this),this._subscriptions.push({handler:i,control:n,event:e,onceWrapper:r}),c(e,r,n);else if(!(s=h(this._subscriptions,function(t){return t.control===n&&t.handler===i&&t.event===e&&void 0===t.onceWrapper})))this._subscriptions.push({handler:i,control:n,event:e});if(!n.hasEvent||!n.hasEvent("onDestroy"))return;if(!(o=h(this._subDestroyControls,function(t){return t.control===n}))){var u=function(t){if(t.getTarget()===n){if(r)n.unsubscribe(t,r);this.unsubscribeFrom(n)}}.bind(this);this._subDestroyControls.push({control:n,handler:u}),l("onDestroy",u,n)}}return this},unsubscribeFrom:function(t,n,e){return this._unsubscribeFrom(t,n,e)},_unsubscribeFrom:function(t,n,e,i){var s=this,r=f(s,t,n,e,i,true);if(this._subscriptions=f(s,t,n,e,i,false),!i)r.forEach(function(t){if(!t.control.isDestroyed||!t.control.isDestroyed())if(u(t.event,t.handler,t.control),t.onceWrapper)u(t.event,t.onceWrapper,t.control)});var o=a(s,t,n,e,i,true);return this._subDestroyControls=a(s,t,n,e,i,false),o.forEach(function(t){if(!t.control.isDestroyed||!t.control.isDestroyed())u("onDestroy",t.handler,t.control)}),this},_allowEvents:function(){this._getChannel().allowEvents()},_eventsAllowed:function(){return this._getChannel().eventsAllowed()},_getChannel:function(){if(!this._eventBusChannel)this._eventBusChannel=r.channel(this._getOption("eventBusId"),{waitForPermit:true,subscribeOnPS:this._options&&this._options.subscribeOnPS});return this._eventBusChannel},isDestroyed:function(){return this._isDestroyed},_publish:function(){for(var t=0,n=arguments.length;t<n;t++){var e=arguments[t],i=this._handlers[e],s,r;if(i)if("function"===typeof i)this.subscribe(e,i),this._handlers[e]=null;else if(r=i.length){for(s=0;s<r;s++)this.subscribe(e,i[s]);this._handlers[e]=null}}},_notify:function(t){var n=this._getChannel(),e=Array.prototype.slice.call(arguments,1),i=n._notifyWithTarget(t,this,e),s;return r.globalChannel()._notifyWithTarget(t,this,e),i},once:function(t,n){this.subscribeOnceTo(this,t,n)},subscribe:function(t,n){return this.subscribeTo(this,t,n),this},unsubscribe:function(t,n){return this._getChannel().unsubscribe(t,n),this.unsubscribeFrom(this,t,n),this},unbind:function(t){return this._getChannel().unbind(t),this},destroy:function(){if(this._eventBusChannel)this._notify("onDestroy"),this._eventBusChannel.unsubscribeAll(),this._eventBusChannel.destroy();this.unsubscribeFrom(),this._handlers={},this._isDestroyed=true},hasEvent:function(t){return this._getChannel().hasEvent(t)},hasEventHandlers:function(t){return this._getChannel().hasEventHandlers(t)},isInitialized:function(){return this._isInitialized},getEvents:function(){return this._getChannel().getEvents()},getEventHandlers:function(t){return this._getChannel().getEventHandlers(t)}};return b});