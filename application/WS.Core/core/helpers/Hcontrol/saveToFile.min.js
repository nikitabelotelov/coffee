define("Core/helpers/Hcontrol/saveToFile",["Core/constants","Core/cookie","Transport/RPCJSON","Core/Deferred","Transport/prepareGetRPCInvocationURL"],function(c,m,u,w,h){return function(e,r,a,n,o){var l=new w;if(l.addErrback(function(e){return e}),e&&r&&a){if(!a["fileDownloadToken"])a["fileDownloadToken"]=Math.floor(1e16*Math.random());if(o)window.open(h(e,r,a)),l.callback();else{var t=$("body"),i="fileDownloadToken_"+a["fileDownloadToken"],s,d,f=$(".ws-upload-form"),p=$(".ws-upload-iframe");if(!f.length&&!p.length)t.append(f=$('<form enctype="multipart/form-data" target="ws-upload-iframe" '+'action="'+(n?n:c.defaultServiceUrl)+'?raw_file_result" method="POST" class="ws-upload-form ws-hidden">'+'<input type="hidden" name="Запрос"></form>')),t.append(p=$('<iframe class="ws-upload-iframe ws-hidden" name="ws-upload-iframe"></iframe>'));f.find("[name=Запрос]").val(u.jsonRpcPreparePacket(e+"."+r,a,parseInt((""+Math.random()).substr(2),10)).reqBody),f.submit(),s=setInterval(function(){var e=p.contents().find("pre");if(d=m.get(i),parseInt(d,10)===a["fileDownloadToken"])if(clearInterval(s),m.set(i,null),e.length)l.errback(new Error(JSON.parse(e.html()).error.details)),e.remove("pre");else l.callback();else if(e.length){var r=JSON.parse(e.html());if(r.error)clearInterval(s),m.set(i,null),l.errback(new Error(r.error.details)),e.remove("pre")}},1e3)}}else l.errback();return l}});