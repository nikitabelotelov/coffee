define("Core/CompoundContainer",["require","Core/Control","tmpl!Core/CompoundContainer","Env/Env","Core/Deferred","Core/moduleStubs","Env/Event","Core/ControlBatchUpdater","Core/helpers/Hcontrol/makeInstanceCompatible","Lib/Control/AreaAbstract/AreaAbstract.compatible","Core/Abstract.compatible","Lib/Control/Control.compatible","Lib/Control/BaseCompatible/BaseCompatible"],function(n,t,e,i,r,l,_,s,o){var a={areBothTemplates:function(n,t){return n&&n.isDataArray&&t&&t.isDataArray},isChangedConfig:function(n,t){var e;for(e in n)if(n.hasOwnProperty(e))if(!t.hasOwnProperty(e)||n[e]!==t[e]&&!a.areBothTemplates(n[e],t[e]))return true;for(e in t)if(t.hasOwnProperty(e)&&!n.hasOwnProperty(e))return true;return false},createChildContainer:function(){var n=document.createElement("div");return this._children.compoundBlock.appendChild(n),n},destroyChildControl:function(){var n=this,t=n._childControl;n._childControl=null,n._childCreatedDfr=null,t.unsubscribe("onCommandCatch",n._handleCommandCatch),t.destroy(),t._container.remove()},createChildControl:function(){var o=this;if(o._childControl)a.destroyChildControl.call(o);return o._childCreatedDfr=new r,l.require([o._childControlName]).addCallback(function(n){var t=n[0],e=o._childConfig&&o._childConfig.element||a.createChildContainer.call(o);o._notifyCompound("onInit"),o._notifyCompound("onBeforeControlsLoad");var i=Object.assign({element:$(e),enabled:o._setChildEnabled},o._childConfig);if((i.parent=o)._isWaitingForChild=true,s.beginBatchUpdate("CompoundContainer.constructingChildControl"),o._childControl=new t(i),s.endBatchUpdate("CompoundContainer.constructingChildControl"),o._isWaitingForChild=false,o._notifyCompound("onBeforeShow"),o._notifyCompound("onShow"),!o._childCreatedDfr.isReady())o._childCreatedDfr.callback(o._childControl);o._notifyCompound("onAfterLoad"),o._notifyCompound("onInitComplete"),o._notifyCompound("onAfterShow"),o._notifyCompound("onReady"),o._childControl.subscribe("onCommandCatch",o._handleCommandCatch)}).addErrback(function(n){i.IoC.resolve("ILogger").error("Core/CompoundContainer",'Could not load "'+o._childControlName+'"'),o._childCreatedDfr.errback(n)}),o._childCreatedDfr},getChildCommandHandler:function(n){var t=null,e=this._childControl.getUserData("commandStorage");if(e)t=e[n];return t},handleCommandCatch:function(n,t){var e=Array.prototype.slice.call(arguments,2);n.setResult(this.handleCommand(t,e))}},h=t.extend({_template:e,_record:null,_childControlName:"",_childConfig:null,_childControl:null,_childCreatedDfr:null,_setChildEnabled:true,_isWaitingForChild:false,_eventHandlers:null,_eventSubscriptions:null,_handleCommandCatch:null,_notifyVDOM:null,_isEnabled:true,_beforeMount:function(n){if(!this._options.__$config)this._options.__$config=n.__$config;this._childControlName=n.component,this._childConfig=n.componentOptions,this._handleCommandCatch=a.handleCommandCatch.bind(this),this._eventHandlers={},this._eventSubscriptions=[]},_afterMount:function(n){if(this._options=n,o(this),this._options.parent){if(!this._parent)this._parent=this._options.parent;this._options.parent=null}this.detectNextActiveChildControl=this._oldDetectNextActiveChildControl,this._notifyVDOM=this._notify,this._notify=this._notifyCompound,this.rebuildChildControl()},_shouldUpdate:function(n){if(false!==this._options.redrawOnOptionsChange&&(this._childControlName!==n.component||a.isChangedConfig.call(this,this._childConfig,n.componentOptions)))this._childControlName=n.component,this._childConfig=n.componentOptions,this._options=n,this.rebuildChildControl();return false},destroy:function(){if(this.isDestroyed())return;if(this._childControl)a.destroyChildControl.call(this);if(this._childConfig=null,this._parent)this._parent._childsMapId=this._parent._childsMapId||{},this._parent._childsMapName=this._parent._childsMapName||{},this._parent._childsTabindex=this._parent._childsTabindex||{};if(h.superclass.destroy.apply(this,arguments),this._parent=null,this._eventSubscriptions)for(var n=0;n<this._eventSubscriptions.length;n++){var t=this._eventSubscriptions[n];t.control.unsubscribe(t.eventName,t.handler)}this._eventSubscriptions=null,this._eventHandlers=null,this._handleCommandCatch=null},rebuildChildControl:function(){return a.createChildControl.call(this)},handleCommand:function(n,t){var e,i=this.getParent(),o=a.getChildCommandHandler.call(this,n);if(o)e=o.apply(this._childControl,t);if(!e)e=this._notifyVDOM("commandCatch",[n].concat(t));if(!e&&i&&i.sendCommand)e=i.sendCommand.apply(i,[n].concat(t));return e||true},_notifyCompound:function(n){var t=this,e=Array.prototype.slice.call(arguments,1),i,o=(t._eventHandlers||{})[n]||[],r,l=(t._options.handlers||{})[n]||[],s=new _.Object(n,t),a=[s].concat(e),h;if("function"===typeof l)l=[l];for(var d=[],c=0;c<l.length;c++)if(!o.find(function(n){return n===l[c]}))d.push(l[c]);for(o=o.concat(d),h=0;h<o.length&&false!==s.getResult();h++)o[h].apply(t,a);if(false!==s.getResult()){var C=this._getChannel(),u=C.notify.apply(C,[n].concat(e));if(void 0!==u)s.setResult(u)}return s.getResult()},subscribe:function(n,t){if(this._eventHandlers=this._eventHandlers||{},!this._eventHandlers[n])this._eventHandlers[n]=[];else if("function"===typeof this._eventHandlers[n])this._eventHandlers[n]=[this._eventHandlers[n]];this._eventHandlers[n].push(t)},once:function(n,t){var e=this,i=function(){t.apply(this,arguments),e.unsubscribe(n,i)};e.subscribe(n,i)},subscribeTo:function(n,t,e){n.subscribe(t,e),this._eventSubscriptions.push({control:n,eventName:t,handler:e})},unsubscribe:function(n,t){this._unsubscribe(n,t,this._eventHandlers||{}),this._unsubscribe(n,t,this._options.handlers||{})},_unsubscribe:function(n,t,e){if(e[n]){var i=e[n];if("function"===typeof i)i=[i];var o=i.findIndex(function(n){return n===t});if(o>=0)i.splice(o,1),e[n]=i}},getParent:function(){return null},sendCommand:function(n){var t=Array.prototype.slice.call(arguments,1);return this.handleCommand(n,t)},setEnabled:function(n){if(this._isEnabled=n,this._childControl)this._childControl.setEnabled(n);else if(this._isWaitingForChild){var t=this;t.once("onBeforeShow",function(){t._childControl.setEnabled(n)})}else this._setChildEnabled=n},isEnabled:function(){return this._isEnabled},getContainer:function(){return $(this._container)},isDestroyed:function(){return this._destroyed},getImmediateChildControls:function(){for(var n=[],t=0;t<this._childControls.length;t++)if(this._childControls[t])n.push(this._childControls[t]);return n},getRecord:function(){return this._record||this._options.record||this._childConfig&&this._childConfig.record},setRecord:function(n){this._record=n}});return h});