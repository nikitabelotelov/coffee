define("Core/CompoundContainer",["require","Core/Control","tmpl!Core/CompoundContainer","Core/IoC","Core/Deferred","Core/moduleStubs","Core/EventObject","Core/ControlBatchUpdater","Core/helpers/Hcontrol/makeInstanceCompatible","Lib/Control/AreaAbstract/AreaAbstract.compatible","Core/Abstract.compatible","Lib/Control/Control.compatible","Lib/Control/BaseCompatible/BaseCompatible"],function(t,n,e,o,r,l,_,s,i){var a={areBothTemplates:function(t,n){return t&&t.isDataArray&&n&&n.isDataArray},isChangedConfig:function(t,n){var e;for(e in t)if(t.hasOwnProperty(e))if(!n.hasOwnProperty(e)||t[e]!==n[e]&&!a.areBothTemplates(t[e],n[e]))return true;for(e in n)if(n.hasOwnProperty(e)&&!t.hasOwnProperty(e))return true;return false},createChildContainer:function(){var t=document.createElement("div");return this._children.compoundBlock.appendChild(t),t},destroyChildControl:function(){var t=this,n=t._childControl;t._childControl=null,t._childCreatedDfr=null,n.unsubscribe("onCommandCatch",t._handleCommandCatch),n.destroy(),n._container.remove()},createChildControl:function(){var i=this;if(i._childControl)a.destroyChildControl.call(i);return i._childCreatedDfr=new r,l.require([i._childControlName]).addCallback(function(t){var n=t[0],e=i._childConfig&&i._childConfig.element||a.createChildContainer.call(i);i._notifyCompound("onInit"),i._notifyCompound("onBeforeControlsLoad");var o=Object.assign({element:$(e),enabled:i._setChildEnabled},i._childConfig);if((o.parent=i)._isWaitingForChild=true,s.beginBatchUpdate("CompoundContainer.constructingChildControl"),i._childControl=new n(o),s.endBatchUpdate("CompoundContainer.constructingChildControl"),i._isWaitingForChild=false,i._notifyCompound("onBeforeShow"),i._notifyCompound("onShow"),!i._childCreatedDfr.isReady())i._childCreatedDfr.callback(i._childControl);i._notifyCompound("onAfterLoad"),i._notifyCompound("onInitComplete"),i._notifyCompound("onAfterShow"),i._notifyCompound("onReady"),i._childControl.subscribe("onCommandCatch",i._handleCommandCatch)}).addErrback(function(t){o.resolve("ILogger").error("Core/CompoundContainer",'Could not load "'+i._childControlName+'"'),i._childCreatedDfr.errback(t)}),i._childCreatedDfr},getChildCommandHandler:function(t){var n=null,e=this._childControl.getUserData("commandStorage");if(e)n=e[t];return n},handleCommandCatch:function(t,n){var e=Array.prototype.slice.call(arguments,2);t.setResult(this.handleCommand(n,e))}},h=n.extend({_template:e,_record:null,_childControlName:"",_childConfig:null,_childControl:null,_childCreatedDfr:null,_setChildEnabled:true,_isWaitingForChild:false,_eventHandlers:null,_eventSubscriptions:null,_handleCommandCatch:null,_notifyVDOM:null,_isEnabled:true,_beforeMount:function(t){if(!this._options.__$config)this._options.__$config=t.__$config;this._childControlName=t.component,this._childConfig=t.componentOptions,this._handleCommandCatch=a.handleCommandCatch.bind(this),this._eventHandlers={},this._eventSubscriptions=[]},_afterMount:function(t){if(this._options=t,i(this),this._options.parent){if(!this._parent)this._parent=this._options.parent;this._options.parent=null}this.detectNextActiveChildControl=this._oldDetectNextActiveChildControl,this._notifyVDOM=this._notify,this._notify=this._notifyCompound,this.rebuildChildControl()},_shouldUpdate:function(t){if(false!==this._options.redrawOnOptionsChange&&(this._childControlName!==t.component||a.isChangedConfig.call(this,this._childConfig,t.componentOptions)))this._childControlName=t.component,this._childConfig=t.componentOptions,this._options=t,this.rebuildChildControl();return false},destroy:function(){if(this.isDestroyed())return;if(this._childControl)a.destroyChildControl.call(this);if(this._childConfig=null,this._parent)this._parent._childsMapId=this._parent._childsMapId||{},this._parent._childsMapName=this._parent._childsMapName||{},this._parent._childsTabindex=this._parent._childsTabindex||{};h.superclass.destroy.apply(this,arguments),this._parent=null;for(var t=0;t<this._eventSubscriptions.length;t++){var n=this._eventSubscriptions[t];n.control.unsubscribe(n.eventName,n.handler)}this._eventSubscriptions=null,this._eventHandlers=null,this._handleCommandCatch=null},rebuildChildControl:function(){return a.createChildControl.call(this)},handleCommand:function(t,n){var e,o=this.getParent(),i=a.getChildCommandHandler.call(this,t);if(i)e=i.apply(this._childControl,n);if(!e)e=this._notifyVDOM("commandCatch",[t].concat(n));if(!e&&o&&o.sendCommand)e=o.sendCommand.apply(o,[t].concat(n));return e||true},_notifyCompound:function(t){var n=this,e=Array.prototype.slice.call(arguments,1),o,i=(n._eventHandlers||{})[t]||[],r,l=(n._options.handlers||{})[t]||[],s=new _(t,n),a=[s].concat(e),h;if("function"===typeof l)l=[l];for(var d=[],c=0;c<l.length;c++)if(!i.find(function(t){return t===l[c]}))d.push(l[c]);for(i=i.concat(d),h=0;h<i.length&&false!==s.getResult();h++)i[h].apply(n,a);if(false!==s.getResult()){var C=this._getChannel(),u=C.notify.apply(C,[t].concat(e));if(void 0!==u)s.setResult(u)}return s.getResult()},subscribe:function(t,n){if(this._eventHandlers=this._eventHandlers||{},!this._eventHandlers[t])this._eventHandlers[t]=[];else if("function"===typeof this._eventHandlers[t])this._eventHandlers[t]=[this._eventHandlers[t]];this._eventHandlers[t].push(n)},once:function(t,n){var e=this,o=function(){n.apply(this,arguments),e.unsubscribe(t,o)};e.subscribe(t,o)},subscribeTo:function(t,n,e){t.subscribe(n,e),this._eventSubscriptions.push({control:t,eventName:n,handler:e})},unsubscribe:function(t,n){this._unsubscribe(t,n,this._eventHandlers||{}),this._unsubscribe(t,n,this._options.handlers||{})},_unsubscribe:function(t,n,e){if(e[t]){var o=e[t];if("function"===typeof o)o=[o];var i=o.findIndex(function(t){return t===n});if(i>=0)o.splice(i,1),e[t]=o}},getParent:function(){return null},sendCommand:function(t){var n=Array.prototype.slice.call(arguments,1);return this.handleCommand(t,n)},setEnabled:function(t){if(this._isEnabled=t,this._childControl)this._childControl.setEnabled(t);else if(this._isWaitingForChild){var n=this;n.once("onBeforeShow",function(){n._childControl.setEnabled(t)})}else this._setChildEnabled=t},isEnabled:function(){return this._isEnabled},getContainer:function(){return $(this._container)},isDestroyed:function(){return this._destroyed},getImmediateChildControls:function(){for(var t=[],n=0;n<this._childControls.length;n++)if(this._childControls[n])t.push(this._childControls[n]);return t},getRecord:function(){return this._record||this._options.record||this._childConfig&&this._childConfig.record},setRecord:function(t){this._record=t}});return h});