define("Core/Control",["require","tmpl!Core/Control","Core/core-extend","Vdom/Vdom","Core/IoC","Core/constants","Core/helpers/Hcontrol/doAutofocus","View/Executor/Expressions","View/Executor/Utils","View/Logger"],function(i,t,e,c,f,n,h,r,s,a){"use strict";var u=1,_=function(t,e,n){var o=t||n&&n.control;if(o&&!o._mounted)o._$needForceUpdate=true;else e&&e.forceRebuild(n.id)},d=function(t,e,n,o){return e&&e.startEvent(n,o)},l=e.extend({_controlName:"Core/Control",_context:null,VDOMReady:false,_logicParent:null,_mounted:false,_unmounted:false,_template:t,_decOptions:null,_$tooltip:"",getInstanceId:function(){return this._instId},mountToDom:function(t,e,n){if(!this.VDOMReady)this.VDOMReady=true,this._container=t,c.Synchronizer.mountControlToDOM(this,n,e,this._container);if(e)this.saveOptions(e)},saveOptions:function(t,e){if(this._options=t,e)this._container=e.element;return true},isCompatibleLayout:function(){return false},saveFullContext:null,_saveEnvironment:null,_saveContextObject:null,saveInheritOptions:null,_getEnvironment:null,_notify:null,_forceUpdate:null,_getMarkup:null,_options:null,context:null,_internalOptions:null,_children:null,fixBaseCompatible:false,_instId:false,constructor:function(t){if(!t)t={};var l=null,n=null,c=null,o=null,i=null;if(this.saveFullContext=function t(e){l=e},this._saveContextObject=function t(e){o=e,this._context=e},this.saveInheritOptions=function t(e){c=e},this._saveEnvironment=function(t,e){n=e,i=t},this._getEnvironment=function(){return i},this._notify=function(){return d(this,i,n,arguments)},this._notify._isVdomNotify=true,this._forceUpdate=function(){_(this,i,n)},this._getMarkup=function t(e,n,o,i){if(!this._template.stable)return f.resolve("ILogger").error(this._moduleName,"Check what you put in _template"),"";var r;if(void 0===i)i=true;if(!o)o={};for(var s in o.context=l,o.inheritOptions=c,o.events)if(o.events.hasOwnProperty(s))for(var a=0;a<o.events[s].length;a++)if(o.events[s][a].fn.isControlEvent&&!o.events[s][a].fn.controlDestination)o.events[s][a].fn.controlDestination=this;if(r=this._template(this,o,e,i)){if(i)for(var u=0;u<r.length;u++)if(r[u])return r[u]}else r="";return r},this.render=function(t,e){var n=this._getMarkup(null,true,e,false);return this._isRendered=true,n},this._logicParent=t._logicParent,this._options={},this.context={get:function(t){if(o&&o.hasOwnProperty(t))return o[t];throw new Error("You trying to get unrequired field "+t)},set:function(){throw new Error("Can't set data to context. Context is readonly!")},has:function(){return true}},this._internalOptions={},this._children={},t.fixBaseCompatible)this.fixBaseCompatible=true;this._instId="inst_"+u++,this._savedOptions=t,this._options={},this._afterCreate&&this._afterCreate(t)},_setInternalOption:function(t,e){if(!this._internalOptions)this._internalOptions={},f.resolve("ILogger").error("Component with "+(this._options?"name "+this._options.name+" config "+this._options.__$config:"maybe id "+this._$id),"Control.constructor wasn't called");this._internalOptions[t]=e},_setInternalOptions:function(t){for(var e in t)if(t.hasOwnProperty(e))this._setInternalOption(e,t[e])},destroy:function(){this._destroyed=true;try{var t=this.constructor.contextTypes?this.constructor.contextTypes():{};for(var e in t)if(t.hasOwnProperty(e))this.context.get(e).unregisterConsumer(this);if(this._mounted)this._beforeUnmount(),c.Synchronizer.cleanControlDomLink(this._container)}catch(t){a.catchLifeCircleErrors("_beforeUnmount",t)}},_blur:function(){var t=this._container[0]?this._container[0]:this._container,e=document.activeElement,n;if(!r.Focus.closest(document.activeElement,t))return;if(-1===document.body.tabIndex)n=document.body.tabIndex,document.body.tabIndex=1;if(document.body.focus(),this._active){var o;t.controlNodes[0].environment._handleFocusEvent({target:document.body,relatedTarget:e})}if(void 0!==n)document.body.tabIndex=n},activate:function(){function t(t){while(t){var e=t._getEnvironment();if(e)return e;t=t._logicParent}throw new Error("environment не был найден среди предков")}function e(t){var e=false,n=document.activeElement;if(t.wsControl&&t.wsControl.setActive)if(t.wsControl.canAcceptFocus())t.wsControl.setActive(true),e=t.wsControl.isActive();else e=false;else{if(c.TabIndex.getElementProps(t).tabStop)c.TabIndex.focus(t);if(e=t===document.activeElement,t=this._container[0]?this._container[0]:this._container,e&&!this._active){var o;t.controlNodes[0].environment._handleFocusEvent({target:t,relatedTarget:n})}}return e}for(var n=false,o=this._container[0]?this._container[0]:this._container,i=h.findAutofocusForVDOM(o),r,s,a=0;a<i.length;a++)if(r=i[a],!s)if(r&&r.controlNodes&&r.controlNodes.length)s=n=r.controlNodes[0].control.activate();if(!s){var u=c.TabIndex.getElementProps,l=c.TabIndex.findFirstInContext(o,false,u);if(l)n=e.call(this,l);else n=e.call(this,o)}return n},_beforeMount:function(){},_beforeMountLimited:function(){if("undefined"!==typeof window)return this._beforeMount.apply(this,arguments);var s=this,t=this._beforeMount.apply(this,arguments);if(t&&t.callback)return new Promise(function(e,n){var o=0;t.then(function(t){if(!o)o=1,e(t);return t},function(t){if(!o)o=1,n(t);return t}),setTimeout(function(){if(!o)f.resolve("ILogger").error("_beforeMount","Wait 20000 ms "+s._moduleName),o=1,i(["View/Executor/TClosure"],function(r){s._originTemplate=s._template,s._template=function(t,e,n,o,i){try{return s._originTemplate.apply(s,arguments)}catch(t){return r.getMarkupGenerator(o).createText("")}},s._template.stable=true,s._afterMount=function(){},e(false)})},2e4)});return t},_afterMount:function(){},_beforeUpdate:function(){},_shouldUpdate:function(){return true},_afterUpdate:function(){},_beforeUnmount:function(){}});return l.createControl=function(t,e,n){if(s.OptionsResolver.resolveOptions(t,e)){var o={inheritOptions:{}},i;s.OptionsResolver.resolveInheritOptions(t,o,e,true);try{i=new t(e)}catch(t){i=new l({}),a.catchLifeCircleErrors("constructor",t)}return i.saveInheritOptions(o.inheritOptions),i._container=n,r.Focus.patchDom(n,e),i.saveFullContext(r.ContextResolver.wrapContext(i,{asd:123})),i.mountToDom(i._container,e,t),i}return null},l._getInheritOptions=function(t){var e=t.getInheritOptions&&t.getInheritOptions()||{};if(!e.hasOwnProperty("readOnly"))e.readOnly=false;if(!e.hasOwnProperty("theme"))e.theme="";return e},l.isWasaby=true,l});