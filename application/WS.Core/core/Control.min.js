define("Core/Control",["require","tmpl!Core/Control","Core/core-extend","Vdom/Vdom","Core/IoC","Core/helpers/Hcontrol/doAutofocus","Core/Themes/ThemesControllerNew","Core/PromiseLib/PromiseLib","View/Executor/Expressions","View/Executor/Utils","View/Logger"],function(i,t,e,h,f,d,s,a,l,u,c){"use strict";var _=1,m=function(t,e,n){var o=t||n&&n.control;if(o&&!o._mounted)o._$needForceUpdate=true;else e&&e.forceRebuild(n.id)},p=function(t,e,n,o){return e&&e.startEvent(n,o)},v=function(t){if(t._theme&&!t._theme.forEach||t._style&&!t._style.forEach)return false;return true},C=e.extend({_controlName:"Core/Control",_context:null,VDOMReady:false,_logicParent:null,_mounted:false,_unmounted:false,_template:t,_decOptions:null,_$tooltip:"",getInstanceId:function(){return this._instId},mountToDom:function(t,e,n){if(!this.VDOMReady)this.VDOMReady=true,this._container=t,h.Synchronizer.mountControlToDOM(this,n,e,this._container);if(e)this.saveOptions(e)},saveOptions:function(t,e){if(this._options=t,e)this._container=e.element;return true},isCompatibleLayout:function(){return false},saveFullContext:null,_saveEnvironment:null,_saveContextObject:null,saveInheritOptions:null,_getEnvironment:null,_notify:null,_forceUpdate:null,_getMarkup:null,_options:null,context:null,_internalOptions:null,_children:null,fixBaseCompatible:false,_instId:false,constructor:function(t){if(!t)t={};var u=null,n=null,c=null,o=null,r=null;if(this.saveFullContext=function t(e){u=e},this._saveContextObject=function t(e){o=e,this._context=e},this.saveInheritOptions=function t(e){c=e},this._saveEnvironment=function(t,e){n=e,r=t},this._getEnvironment=function(){return r},this._notify=function(){return p(this,r,n,arguments)},this._notify._isVdomNotify=true,this._forceUpdate=function(){m(this,r,n)},this._getMarkup=function t(e,n,o,r){if(!this._template.stable)return f.resolve("ILogger").error(this._moduleName,"Check what you put in _template"),"";var i;if(void 0===r)r=true;if(!o)o={};for(var s in o.context=u,o.inheritOptions=c,o.events)if(o.events.hasOwnProperty(s))for(var a=0;a<o.events[s].length;a++)if(o.events[s][a].fn.isControlEvent&&!o.events[s][a].fn.controlDestination)o.events[s][a].fn.controlDestination=this;if(i=this._template(this,o,e,r)){if(r)for(var l=0;l<i.length;l++)if(i[l])return i[l]}else i="";return i},this.render=function(t,e){var n=this._getMarkup(null,true,e,false);return this._isRendered=true,n},this._logicParent=t._logicParent,this._options={},this.context={get:function(t){if(o&&o.hasOwnProperty(t))return o[t];return null},set:function(){throw new Error("Can't set data to context. Context is readonly!")},has:function(){return true}},this._internalOptions={},this._children={},t.fixBaseCompatible)this.fixBaseCompatible=true;this._instId="inst_"+_++,this._savedOptions=t,this._options={},this._afterCreate&&this._afterCreate(t)},_setInternalOption:function(t,e){if(!this._internalOptions)this._internalOptions={},f.resolve("ILogger").error("Component with "+(this._options?"name "+this._options.name+" config "+this._options.__$config:"maybe id "+this._$id),"Control.constructor wasn't called");this._internalOptions[t]=e},_setInternalOptions:function(t){for(var e in t)if(t.hasOwnProperty(e))this._setInternalOption(e,t[e])},destroy:function(){this._destroyed=true;try{var t=this.constructor.contextTypes?this.constructor.contextTypes():{};for(var e in t)if(t.hasOwnProperty(e)){var n=this.context.get(e);if(n)n.unregisterConsumer(this)}if(this._mounted)this._beforeUnmount(),h.Synchronizer.cleanControlDomLink(this._container)}catch(t){c.catchLifeCircleErrors("_beforeUnmount",t)}},_blur:function(){var t=this._container[0]?this._container[0]:this._container,e=document.activeElement,n;if(!l.Focus.closest(document.activeElement,t))return;if(-1===document.body.tabIndex)n=document.body.tabIndex,document.body.tabIndex=1;if(document.body.focus(),this._active){var o;t.controlNodes[0].environment._handleFocusEvent({target:document.body,relatedTarget:e})}if(void 0!==n)document.body.tabIndex=n},activate:function(){function t(t){while(t){var e=t._getEnvironment();if(e)return e;t=t._logicParent}throw new Error("environment не был найден среди предков")}function e(t){var e=false,n=document.activeElement;if(t.wsControl&&t.wsControl.setActive)if(t.wsControl.canAcceptFocus())t.wsControl.setActive(true),e=t.wsControl.isActive();else e=false;else{if(h.TabIndex.getElementProps(t).tabStop)h.TabIndex.focus(t);if(e=t===document.activeElement,t=this._container[0]?this._container[0]:this._container,e&&!this._active){var o;t.controlNodes[0].environment._handleFocusEvent({target:t,relatedTarget:n})}}return e}for(var n=false,o=this._container[0]?this._container[0]:this._container,r=d.findAutofocusForVDOM(o),i,s,a=0;a<r.length;a++)if(i=r[a],!s)if(i&&i.controlNodes&&i.controlNodes.length)s=n=i.controlNodes[0].control.activate();if(!s){var l=h.TabIndex.getElementProps,u=h.TabIndex.findFirstInContext(o,false,l);if(u){var c="vdom-focus-in",f="vdom-focus-out";if(u.classList.contains(c))u=h.TabIndex.findWithContexts(o,u,false,l);if(u.classList.contains(f))u=null}if(u)n=e.call(this,u);else n=e.call(this,o)}return n},_beforeMount:function(){},_manageStyles:function(n){var o=this;if(!v(o))return true;var r=s.getInstance(),t=this._styles||[],e=this._theme||[],i=[];if("undefined"===typeof window)return t.forEach(function(t){r.pushCss(t)}),e.forEach(function(t){r.pushThemedCss(t,n)}),true;else if(t.forEach(function(e){if(!r.isCssLoaded(e)){var t=a.reflect(a.wrapTimeout(r.pushCssAsync(e),2e3));t.then(function(t){if("rejected"===t.status)f.resolve("ILogger").error("Styles loading error","Could not load style "+e+" for control "+o._moduleName)}),i.push(t)}}),e.forEach(function(e){if(!r.isThemedCssLoaded(e,n)){var t=a.reflect(a.wrapTimeout(r.pushCssThemedAsync(e,n),2e3));t.then(function(t){if("rejected"===t.status)f.resolve("ILogger").error("Styles loading error","Could not load style "+e+" for control "+o._moduleName+" with theme "+n)}),i.push(t)}}),i.length)return Promise.all(i);else return true},_beforeMountLimited:function(t){var r=this._beforeMount.apply(this,arguments);if("undefined"===typeof window){var s=this;if(r&&r.callback)r=new Promise(function(e,n){var o=0;r.then(function(t){if(!o)o=1,e(t);return t},function(t){if(!o)o=1,n(t);return t}),setTimeout(function(){if(!o)f.resolve("ILogger").error("_beforeMount","Wait 20000 ms "+s._moduleName),o=1,i(["View/Runner/tclosure"],function(i){s._originTemplate=s._template,s._template=function(t,e,n,o,r){try{return s._originTemplate.apply(s,arguments)}catch(t){return i.getMarkupGenerator(o).createText("")}},s._template.stable=true,s._afterMount=function(){},e(false)})},2e4)})}var e=this._manageStyles(t.theme);if(e.then)r=Promise.all([e,r]);return r},_afterMount:function(){},_beforeUpdate:function(){},_shouldUpdate:function(){return true},_afterUpdate:function(){},_beforeUnmount:function(){}});return C.createControl=function(t,e,n){var o=u.OptionsResolver.getDefaultOptions(t);u.OptionsResolver.resolveOptions(t,o,e);var r={inheritOptions:{}},i;u.OptionsResolver.resolveInheritOptions(t,r,e,true);try{i=new t(e)}catch(t){i=new C({}),c.catchLifeCircleErrors("constructor",t)}return i.saveInheritOptions(r.inheritOptions),i._container=n,l.Focus.patchDom(n,e),i.saveFullContext(l.ContextResolver.wrapContext(i,{asd:123})),i.mountToDom(i._container,e,t),i},C._getInheritOptions=function(t){var e=t.getInheritOptions&&t.getInheritOptions()||{};if(!e.hasOwnProperty("readOnly"))e.readOnly=false;if(!e.hasOwnProperty("theme"))e.theme="";return e},C.isWasaby=true,C});