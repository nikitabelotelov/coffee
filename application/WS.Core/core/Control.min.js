define("Core/Control",["require","tmpl!Core/Control","Core/core-extend","Vdom/Vdom","Env/Env","Core/helpers/Hcontrol/doAutofocus","Core/Themes/ThemesControllerNew","Core/PromiseLib/PromiseLib","View/Executor/Expressions","View/Executor/Utils","View/Logger"],function(r,t,e,h,f,_,s,a,l,u,c){"use strict";var d=1,m={_forceUpdate:function(t,e,n){var o=t||n&&n.control;if(o&&!o._mounted)o._$needForceUpdate=true;else e&&e.forceRebuild(n.id)},_notify:function(t,e,n,o){return e&&e.startEvent(n,o)},_checkNewStyles:function(t){if(t._theme&&!t._theme.forEach||t._style&&!t._style.forEach)return false;return true},_loadNewStyles:function(n,o,i,t,e){var r=[];if("undefined"===typeof window)e.forEach(function(t){o.pushCss(t)}),t.forEach(function(t){o.pushThemedCss(t,i)});else if(e.forEach(function(e){if(o.isCssLoaded(e))o.pushCssLoaded(e);else{var t=a.reflect(a.wrapTimeout(o.pushCssAsync(e),2e3));t.then(function(t){if("rejected"===t.status)f.IoC.resolve("ILogger").error("Styles loading error","Could not load style "+e+" for control "+n._moduleName)}),r.push(t)}}),t.forEach(function(e){if(o.isThemedCssLoaded(e,i))o.pushCssThemedLoaded(e,i);else{var t=a.reflect(a.wrapTimeout(o.pushCssThemedAsync(e,i),2e3));t.then(function(t){if("rejected"===t.status)f.IoC.resolve("ILogger").error("Styles loading error","Could not load style "+e+" for control "+n._moduleName+" with theme "+i)}),r.push(t)}}),r.length)return Promise.all(r);return true},_removeOldStyles:function(e,n,t,o){o.forEach(function(t){e.removeCss(t)}),t.forEach(function(t){e.removeCssThemed(t,n)})}},p=e.extend({_controlName:"Core/Control",_context:null,VDOMReady:false,_logicParent:null,_mounted:false,_unmounted:false,_template:t,_decOptions:null,_$tooltip:"",getInstanceId:function(){return this._instId},mountToDom:function(t,e,n){if(!this.VDOMReady)this.VDOMReady=true,this._container=t,h.Synchronizer.mountControlToDOM(this,n,e,this._container);if(e)this.saveOptions(e)},saveOptions:function(t,e){if(this._options=t,e)this._container=e.element;return true},isCompatibleLayout:function(){return false},saveFullContext:null,_saveEnvironment:null,_saveContextObject:null,saveInheritOptions:null,_getEnvironment:null,_notify:null,_forceUpdate:null,_getMarkup:null,_options:null,context:null,_internalOptions:null,_children:null,fixBaseCompatible:false,_instId:false,constructor:function(t){if(!t)t={};var u=null,n=null,c=null,o=null,i=null;if(this.saveFullContext=function t(e){u=e},this._saveContextObject=function t(e){o=e,this._context=e},this.saveInheritOptions=function t(e){c=e},this._saveEnvironment=function(t,e){n=e,i=t},this._getEnvironment=function(){return i},this._notify=function(){return m._notify(this,i,n,arguments)},this._notify._isVdomNotify=true,this._forceUpdate=function(){m._forceUpdate(this,i,n)},this._getMarkup=function t(e,n,o,i){if(!this._template.stable)return f.IoC.resolve("ILogger").error(this._moduleName,"Check what you put in _template"),"";var r;if(void 0===i)i=true;if(!o)o={};for(var s in o.context=u,o.inheritOptions=c,o.events)if(o.events.hasOwnProperty(s))for(var a=0;a<o.events[s].length;a++)if(o.events[s][a].fn.isControlEvent&&!o.events[s][a].fn.controlDestination)o.events[s][a].fn.controlDestination=this;if(r=this._template(this,o,e,i)){if(i)for(var l=0;l<r.length;l++)if(r[l])return r[l]}else r="";return r},this.render=function(t,e){var n=this._getMarkup(null,true,e,false);return this._isRendered=true,n},this._logicParent=t._logicParent,this._options={},this.context={get:function(t){if(o&&o.hasOwnProperty(t))return o[t];return null},set:function(){throw new Error("Can't set data to context. Context is readonly!")},has:function(){return true}},this._internalOptions={},this._children={},t.fixBaseCompatible)this.fixBaseCompatible=true;this._instId="inst_"+d++,this._savedOptions=t,this._options={},this._afterCreate&&this._afterCreate(t)},_setInternalOption:function(t,e){if(!this._internalOptions)this._internalOptions={},f.IoC.resolve("ILogger").error("Component with "+(this._options?"name "+this._options.name+" config "+this._options.__$config:"maybe id "+this._$id),"Control.constructor wasn't called");this._internalOptions[t]=e},_setInternalOptions:function(t){for(var e in t)if(t.hasOwnProperty(e))this._setInternalOption(e,t[e])},destroy:function(){this._destroyed=true;try{var t=this.constructor.contextTypes?this.constructor.contextTypes():{};for(var e in t)if(t.hasOwnProperty(e)){var n=this.context.get(e);if(n)n.unregisterConsumer(this)}if(this._mounted)this.__beforeUnmount(),h.Synchronizer.cleanControlDomLink(this._container)}catch(t){c.catchLifeCircleErrors("_beforeUnmount",t)}},_blur:function(){var t=this._container[0]?this._container[0]:this._container,e=document.activeElement,n;if(!l.Focus.closest(document.activeElement,t))return;if(-1===document.body.tabIndex)n=document.body.tabIndex,document.body.tabIndex=1;if(document.body.focus(),this._active){var o;t.controlNodes[0].environment._handleFocusEvent({target:document.body,relatedTarget:e})}if(void 0!==n)document.body.tabIndex=n},activate:function(){function t(t){while(t){var e=t._getEnvironment();if(e)return e;t=t._logicParent}throw new Error("environment не был найден среди предков")}function e(t){var e=false,n=document.activeElement;if(t.wsControl&&t.wsControl.setActive)if(t.wsControl.canAcceptFocus())t.wsControl.setActive(true),e=t.wsControl.isActive();else e=false;else{if(h.TabIndex.getElementProps(t).tabStop)h.TabIndex.focus(t);if(e=t===document.activeElement,t=this._container[0]?this._container[0]:this._container,e&&!this._active){var o;t.controlNodes[0].environment._handleFocusEvent({target:t,relatedTarget:n})}}return e}for(var n=false,o=this._container[0]?this._container[0]:this._container,i=_.findAutofocusForVDOM(o),r,s,a=0;a<i.length;a++)if(r=i[a],!s)if(r&&r.controlNodes&&r.controlNodes.length)s=n=r.controlNodes[0].control.activate();if(!s){var l=h.TabIndex.getElementProps,u=h.TabIndex.findFirstInContext(o,false,l);if(u){var c="vdom-focus-in",f="vdom-focus-out";if(u.classList.contains(c))u=h.TabIndex.findWithContexts(o,u,false,l);if(u.classList.contains(f))u=null}if(u)n=e.call(this,u);else n=e.call(this,o)}return n},_beforeMount:function(){},_manageStyles:function(t,e){if(!m._checkNewStyles(this))return true;var n=s.getInstance(),o=this.constructor._styles||this._styles||[],i=this.constructor._theme||this._theme||[];if(e)m._removeOldStyles(n,e,i,[]);return m._loadNewStyles(this,n,t,i,o)},_beforeMountLimited:function(t){var i=this._beforeMount.apply(this,arguments);if("undefined"===typeof window){var s=this;if(i&&i.callback)i=new Promise(function(e,n){var o=0;i.then(function(t){if(!o)o=1,e(t);return t},function(t){if(!o)o=1,n(t);return t}),setTimeout(function(){if(!o)f.IoC.resolve("ILogger").error("_beforeMount","Wait 20000 ms "+s._moduleName),o=1,r(["View/Executor/TClosure"],function(r){s._originTemplate=s._template,s._template=function(t,e,n,o,i){try{return s._originTemplate.apply(s,arguments)}catch(t){return r.getMarkupGenerator(o).createText("")}},s._template.stable=true,s._afterMount=function(){},e(false)})},2e4)})}var e=this._manageStyles(t.theme);if(e.then)i=Promise.all([e,i]);return i},_afterMount:function(){},_beforeUpdate:function(){},__beforeUpdate:function(t){if(t.theme!==this._options.theme)this._manageStyles(t.theme,this._options.theme);this._beforeUpdate.apply(this,arguments)},_shouldUpdate:function(){return true},_afterUpdate:function(){},_removeStyles:function(t){if(!m._checkNewStyles(self))return true;var e=s.getInstance(),n=this._styles||[],o=this._theme||[];m._removeOldStyles(e,t,o,n)},__beforeUnmount:function(){this._removeStyles(this._options.theme),this._beforeUnmount.apply(this,arguments)},_beforeUnmount:function(){}});return p.createControl=function(t,e,n){var o=u.OptionsResolver.getDefaultOptions(t);u.OptionsResolver.resolveOptions(t,o,e);var i={inheritOptions:{}},r;u.OptionsResolver.resolveInheritOptions(t,i,e,true);try{r=new t(e)}catch(t){r=new p({}),c.catchLifeCircleErrors("constructor",t)}return r.saveInheritOptions(i.inheritOptions),r._container=n,l.Focus.patchDom(n,e),r.saveFullContext(l.ContextResolver.wrapContext(r,{asd:123})),r.mountToDom(r._container,e,t),r._$createdFromCode=true,r},p._getInheritOptions=function(t){var e=t.getInheritOptions&&t.getInheritOptions()||{};if(!e.hasOwnProperty("readOnly"))e.readOnly=false;if(!e.hasOwnProperty("theme"))e.theme="default";return e},p.isWasaby=true,p._private=m,p});