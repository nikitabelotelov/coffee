define("Core/WindowManager",["Core/Abstract","Core/ControlBatchUpdater","Core/core-instance","Env/Env","is!browser?jquery"],function(i,n,s,e){var o,t,o;return o=new(t=i.extend({_windows:[],_tabEventEnable:true,_focusIn:void 0,_focusOut:void 0,_focusControlled:false,_acquireIndex:1e3,_acquiredIndexes:[],_modalIndexes:[],_maximizedIndexes:[],_hintIndexes:[],_visibleIndexes:[],_windowsStack:[],_currentVisibleIndicator:null,_zIndexChangedFlag:false,_zIndexChanged:0,pushUp:function(i){var t=i.isMovableToTop(),e=false,n,s,o=[];if(true===t)return this.popBack(i),this._windowsStack.push({visible:function(){return i.isVisible()},window:i}),true;else if(null===t){for(n=this._windowsStack.length-1;n>=0&&!e;--n)if(s=this._windowsStack[n],!e&&s.window._isIndicator)o.push(s),e=s.window===i,this._windowsStack.splice(n,1);for(n=o.length-1;n>=0;--n)this._windowsStack.push(o[n]);return true}else if(false===t){if(!i._isIndicator)return false;n=0;while(n<this._windowsStack.length&&null!==e){if(s=this._windowsStack[n],false===e)e=s.window===i;if(true===e&&s.window._isIndicator)if(s.window!==i&&s.visible())e=null,Array.prototype.splice.apply(this._windowsStack,[n,0].concat(o));else o.push(this._windowsStack.splice(n,1)[0]),n--;n++}}return false},popBack:function(t){this._windowsStack=this._windowsStack.filter(function(i){return i.window!==t})},popAndShowNext:function(i){if(!i._isIndicator)this.popBack(i);for(var t=false,e=this._windowsStack,n=e.length-1;n>=0;n--){var s=e[n];if(s.window._isIndicator&&s.window._isIndicatorVisible){if(s.window!==i)if(!t){if(s.window._myIndicator)s.window._myIndicator.show()}else if(this._pendingIndicator===s.window._myIndicator);else s.window.show(true),this.setCurrentVisibleIndicator(s.window._myIndicator),s.window._myIndicator._isVisible=true;return}else if(s.visible())if(t=true,!i._isIndicator)break}},getStack:function(){return this._windowsStack},getCurrentVisibleIndicator:function(){return this._currentVisibleIndicator},setCurrentVisibleIndicator:function(i){this._currentVisibleIndicator=i},acquireZIndex:function(i,t,e){this._acquireIndex+=10;var n=this._acquireIndex;if(this._acquiredIndexes.push(n),i)this._modalIndexes.push(n);if(t)this._maximizedIndexes.push(n);if(e)this._hintIndexes.push(n);return this._notifyZIndexChanged(),n},_notifyZIndexChanged:function(){function n(i){return e._visibleIndexes&&-1!==e._visibleIndexes.indexOf(i)}function t(){var t=o.getDefaultZIndex(),e;return e=this._modalIndexes.concat(this._maximizedIndexes).concat(this._hintIndexes).reduce(function(i,t){return n(t)?Math.min(t,i):i},1/0),this._acquiredIndexes.forEach(function(i){if(n(i))if(i>t&&i<e)t=i}),t}var e=this;if(!this._zIndexChangedFlag)this._zIndexChangedFlag=true,setTimeout(function(){e._zIndexChangedFlag=false;var i=t.apply(e);if(i!=e._zIndexChanged)e._zIndexChanged=i,e._notify("zIndexChanged",i)},0)},setVisible:function(i){if(-1==this._visibleIndexes.indexOf(i))this._visibleIndexes.push(i),this._notifyZIndexChanged()},setHidden:function(i){var t=this._visibleIndexes.indexOf(i);if(t>=0)this._visibleIndexes.splice(t,1),this._notifyZIndexChanged()},getDefaultZIndex:function(){return 1e3},releaseZIndex:function(n){["acquired","visible","modal","maximized","hint"].forEach(function(i){var t=this["_"+i+"Indexes"]||[],e=t.indexOf(n);if(e>=0)t.splice(e,1)}.bind(this)),this._acquireIndex=Math.max.apply(Math,[this.getDefaultZIndex()].concat(this._acquiredIndexes)),this._notifyZIndexChanged()},getMaxVisibleZIndex:function(){var t=0;return this._visibleIndexes.forEach(function(i){if(i>t&&-1!=this._modalIndexes.indexOf(i))t=i},this),t},isMaximizedWindowExists:function(){return!!o._maximizedIndexes.length},init:function(){if(t.superclass.init.call(this),"undefined"!==typeof $)$(document).ready(this.postInit.bind(this));this._publish("onAreaFocus","zIndexChanged")},postInit:function(){$(function(){this._createFirstElementToFocus(),this._createLastElementToFocus()}.bind(this))},_findActiveWindow:function(){var i=o.getActiveWindow(true);if(i)return i=i.findParent(function(i){return s.instanceOfModule(i,"Lib/Control/FloatArea/FloatArea")})||i.getTopParent();return},_createFirstElementToFocus:function(){if(this._focusIn)this._focusIn.remove();var t=this,i=function(){if(!t._focusControlled){var i=t._findActiveWindow();if(i){if(e.constants.browser.yandex)if(i.getContainer()&&!i.getContainer().closest("body").length)return;i.activateFirstControl()}}};if(e.constants.compat)this._focusIn=$('<a class="ws-focus-in" tabindex="1"></a>').prependTo("body").bind("focusin",i)},_createLastElementToFocus:function(){if(this._focusOut)this._focusOut.remove();var i=this;if(e.constants.compat)this._focusOut=$('<a class="ws-focus-out" tabindex="0"></a>').appendTo("body")},focusToFirstElement:function(){if(this._focusIn)this._focusControlled=true,this._focusIn.focus(),this._focusControlled=false},focusToLastElement:function(){if(this._focusOut){if(this._focusControlled=true,e.constants.compat)$("body").append(this._focusOut);this._focusOut.focus(),this._focusControlled=false}},_findWindowIndex:function(i){var t,e=this._windows,n=e.length;for(t=0;t!==n;t++)if(e[t]===i)return t;return-1},_checkRegisterBatchUpdaterActions:function(){this._checkRegisterBatchUpdaterActions=function(){};var e=this;n.registerDelayedAction("WindowManager.activateControl",function(){var i=$(document.activeElement).wsControl();if(e._doActivateControl||!document.activeElement||$(document.activeElement).is(document.body)||i&&!i.isVisibleWithParents()){e._doActivateControl=false;var t=e.getActiveWindow(true);if(t)t.onBringToFront()}})},addWindow:function(i){if(-1===this._findWindowIndex(i)){var t=this;if(this._checkRegisterBatchUpdaterActions(),this._windows.push(i),s.instanceOfMixin(i,"Lib/Control/AreaAbstract/AreaAbstract.compatible"))i.subscribe("onActivate",function(i){if(i.getTarget()===this)t.onActivateWindow(this)})}},removeWindow:function(i){this.deactivateWindow(i,function(i){if(-1!==i)this._windows.splice(i,1)}.bind(this))},deactivateWindow:function(i,t){var e=this._findWindowIndex(i);if(-1!==e)t(e),n.runBatchedDelayedAction("WindowManager.activateControl");else t(-1)},onActivateWindow:function(i){if(i)i.setActivationIndex(this.getMaxActivisionIndex()+1),this._notify("onAreaFocus",i)},disableTabEvent:function(){this._tabEventEnable=false},enableTabEvent:function(){this._tabEventEnable=true},getTabEvent:function(){return this._tabEventEnable},getMaxZWindow:function(i){var t=-1,e,n,s,o=this._windows,a=o.length,c;for(n=0;n!==a;n++)if(c=o[n],(!i||i(c))&&c.isShow())if((s=c.getZIndex())>t)t=s,e=c;return e},getMaxZModalWindow:function(){return this.getMaxZWindow(function(i){return i.isModal()})},getMaxZIndex:function(){var i=this.getMaxZWindow();return i&&i.getZIndex()||1e3},_isWindowAcceptFocus:function(i){var t=i;while(t){var e,n=!t.isVisible||t.isVisible();if(true===this._getCalculatingState()&&t.getId())if(void 0!==this._canAcceptFocusCache[t.getId()])e=this._canAcceptFocusCache[t.getId()];else if(t.canAcceptFocus)e=t.canAcceptFocus(),this._canAcceptFocusCache[t.getId()]=e;else return false;else e=t.canAcceptFocus();if(!e||!n)return false;if(s.instanceOfMixin(t,"Lib/Mixins/LikeWindowMixin"))break;t=t.getParent()}return true},_isWindowActivable:function(i){return i.isVisibleWithParents()},_setCalculatingState:function(i){this._activeWindowCalculating=i,this._canAcceptFocusCache={}},_getCalculatingState:function(){return this._activeWindowCalculating},_getActiveWindow:function(i){var t=-1,e,n,s,o,a=this._windows,c=a.length;for(this._setCalculatingState(true),n=0;n!==c;n++)if(o=a[n],!i||i(o))if((s=o.getActivationIndex())>t)t=s,e=o;return this._setCalculatingState(false),e},getActiveWindow:function(i,t){var e=i?this._isWindowAcceptFocus:t?function(){return true}:this._isWindowActivable;return this._getActiveWindow(e.bind(this))},getMaxActivisionIndex:function(){var i=this.getActiveWindow(false,true);return i&&i.getActivationIndex()||0},disableLastActiveControl:function(i){var t=this.getActiveWindow();if(t){var e=t.getActiveChildControl();if(e){if(e.getParent()===t&&e!==i)e.setActive(false,void 0,void 0,i)}else t.setActive(false,void 0,void 0,i)}}}))});