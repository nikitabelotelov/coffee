define("Core/ParallelDeferred",["Core/core-extend","Core/Deferred"],function(s,u){var t;return t=s({},{$protected:{_successResult:void 0,_ready:false,_locked:false,_stepsCount:0,_stepsFinish:0,_stepsSuccess:0,_dResult:null,_errors:[],_results:{},_lazyQueue:[],_options:{stopOnFirstError:true,maxRunningCount:10}},$constructor:function(s){if(this._dResult=new u({silent:true}),s&&s.steps)for(var t in s.steps)if(s.steps.hasOwnProperty(t))this.push(s.steps[t],t)},_successHandler:function(s,t){return this._stepsFinish++,this._stepsSuccess++,this._results[s]=t,this._check(),t},_errorHandler:function(s,t){if(this._stepsFinish++,this._errors.push(t),!this._options.stopOnFirstError)this._results[s]=t;return this._check(),t},_isFinishedByError:function(){return this._options.stopOnFirstError&&this._errors.length>0},_runDfr:function(s,t,e){var i;if(t)try{i=s()}catch(s){(i=new u({silent:true})).errback(s)}else i=s;i.addCallbacks(this._successHandler.bind(this,e),this._errorHandler.bind(this,e))},push:function(s,t){if(this._locked)return this;var e=this,i=s instanceof u||s instanceof Promise,r="function"==typeof s;function n(){if(void 0===t)t=e._stepsCount;if(e._stepsCount++,e._results.hasOwnProperty(t))throw new Error(rk("Действие с")+' id="'+t+'" '+rk("уже есть в этом объекте ParallelDeferred"));e._results[t]=void 0}if(i||r){if(this._locked)throw new Error(rk("Нельзя вызывать push после done"));else if(!this._isFinishedByError())if(i)n(),this._runDfr(s,false,t);else if(r)if(n(),this._stepsCount-this._stepsFinish-this._lazyQueue.length<=this._options.maxRunningCount)this._runDfr(s,true,t);else this._lazyQueue.push([s,t])}else throw new Error(rk("Неверный параметр dOperation: требуется Deferred или функция, возвращающая его"));return this},done:function(s){return this._locked=true,this._successResult=s,this._check(),this},_check:function(){function s(){var s,t=this._lazyQueue.length,e=this._stepsCount-this._stepsFinish-t,i=t>0&&e<this._options.maxRunningCount;if(i)s=this._lazyQueue.shift(),this._runDfr(s[0],true,s[1]);return i}if(!this._ready)if(this._ready=this._locked&&(this._stepsFinish===this._stepsCount||this._isFinishedByError()),this._ready)if(this._lazyQueue=[],this._isFinishedByError())this._dResult.errback(this._errors[0]);else this._dResult.callback(void 0!==this._successResult?this._successResult:this._results);else{var t=s.call(this);while(t)t=s.call(this)}},getResult:function(){return this._dResult},getStepsCount:function(){return this._stepsCount},getStepsDone:function(){return this._stepsFinish},getStepsSuccess:function(){return this._stepsSuccess}})});