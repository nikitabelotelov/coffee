define("Core/Deferred",["require","exports","Core/constants","Core/core-debug","Core/IoC"],function(e,r,i,c,s){"use strict";function n(e){this.message=e,this.canceled=true}var t;n.prototype=Object.create(Error.prototype),(function(){return this||(0,eval)("this")}()).DeferredCanceledError=n;var o=-1,a=0,u=1,f=2,l=[0,1,1],h={};h[o]="waiting",h[a]="success",h[u]="failed",h[f]="canceled";var d=function(){function t(e){if(e){if(e.cancelCallback)this._cancelCallback=e.cancelCallback;this._logCallbackExecutionTime=!!e.logCallbackExecutionTime}this._chained=false,this._chain=[],this._fired=o,this._paused=0,this._results=[null,null],this._running=false}return t.prototype.logCallbackExecutionTime=function(e){this._logCallbackExecutionTime=!!e},t.prototype.cancel=function(){if(this._fired===o){if(this._fired=f,this._results[l[this._fired]]=new n("Cancel"),this.__parentPromise&&this.__parentPromise.abort)this.__parentPromise.abort();if(this._cancelCallback){var e=this._cancelCallback;this._cancelCallback=null;try{e()}catch(e){s.resolve("ILogger").error("Deferred","Cancel function throwing an error: "+e.message,e)}}this._fire()}return this},t.prototype.callback=function(e){if(!p(this))this._resback(this._check(e));return this},t.prototype.errback=function(e,r){if(!p(this))this._resback(this._check(e,true,r));return this},t.prototype._resback=function(e){this._cancelCallback=null,this._fired=g(e),this._results[l[this._fired]]=e,this._fire()},t.prototype._check=function(e,r,t){var n=e;if(this._fired!==o)throw new Error('Deferred is already fired with state "'+h[this._fired]+'"');if(k(n))throw new Error("Deferred instances can only be chained if they are the result of a callback");if(r){if(!b(n))if(void 0!==(n=new Error(n)).number&&!Number.isNaN(n.number)&&!n.message)n.message=""+n.number;if(false!==t&&i.isNodePlatform&&!this._chain.some(function(e){return"function"===typeof e[1]}))s.resolve("ILogger").error("Deferred","There is no callbacks attached to handle error"),s.resolve("ILogger").error("Deferred","Unhandled error:",n)}return n},t.prototype.addBoth=function(e){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(e,e)},t.prototype.finally=function(e){var t,n,r=new Promise(function(e,r){t=e,n=r}).then(e,e);return this.addCallbacks(function(e){return t(),e},function(e){return n(),e}),r},t.prototype.addCallback=function(e){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(e,null)},t.prototype.then=function(e,r){var t,n,i=new Promise(function(e,r){t=e,n=r}).then(e,r);return this.addCallbacks(function(e){return t(e),e},function(e){return n(e),e}),i},t.prototype.addErrback=function(e){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(null,e)},t.prototype.catch=function(e){var t,r=new Promise(function(e,r){t=r}).catch(e);return this.addErrback(function(e){return t(e),e}),r},t.prototype.addCallbacks=function(e,r){if(this._chained)throw new Error("Chained Deferreds can not be re-used");if(null!==e&&"function"!==typeof e||null!==r&&"function"!==typeof r)throw new Error("Both arguments required in addCallbacks");var t=this._fired,n=t===o||this._running||this._paused>0;if(n||e&&t===a||r&&(t===u||t===f))if(this._chain.push([e,r]),!n)this._fire();return this},t.prototype._fire=function(){var e=this._chain,r=this._fired,t=this._results[l[r]],n=this,i=null;while(e.length>0&&0===this._paused){var o,a=e.shift()[l[r]];if(null===a)continue;try{if(this._running=true,this._logCallbackExecutionTime)t=c.methodExecutionTime(a,this,[t]);else t=a(t);if(r=g(t),k(t))i=function(e){n._paused--,n._resback(e)},this._paused++}catch(e){r=u,t=b(e)?e:new Error(e),s.resolve("ILogger").error("Deferred","Callback function throwing an error: "+e.message,e)}finally{this._running=false}}if(this._fired=r,this._results[l[r]]=t,i&&this._paused)t.addBoth(i),t._chained=true},t.prototype.dependOn=function(e){var r=this;return e.addCallbacks(function(e){return r.callback(e),e},function(e){return r.errback(e),e}),this},t.prototype.createDependent=function(){var e;return(new t).dependOn(this)},t.prototype.isReady=function(e){return this._fired!==o&&(e?!this._paused:true)},t.prototype.isCallbacksLocked=function(){return this._chained},t.prototype.isSuccessful=function(){return this._fired===a},t.prototype.getResult=function(){if(this.isReady())return this._results[l[this._fired]];throw new Error("No result at this moment. Deferred is still not ready")},t.fromTimer=function(e){var r=new t;return setTimeout(r.callback.bind(r),e),r},t.success=function(e){return(new t).callback(e)},t.fail=function(e){var r=e instanceof Error?e:new Error(e?String(e):"");return(new t).errback(r,false)},t.nearestOf=function(e){var n=new t;if(e.forEach(function(e,t){e.addBoth(function(e){if(!n.isReady())if(e instanceof Error){var r=new Error;r.from=t,r.data=e,n.errback(r)}else n.callback({from:t,data:e});return e})}),0===e.length)n.callback();return n},t.callbackWrapper=function(e,r){if(e&&e instanceof t)return e.addCallback(r);return r(e)},t.fromPromise=function(e){var r=new t;return(r.__parentPromise=e).then(function(e){r.callback(e)}).catch(function(e){r.errback(e)}),r},t.toPromise=function(e){return new Promise(function(r,t){e.createDependent().addCallbacks(function(e){r(e)},function(e){t(e)})})},t}();function p(e){return e._fired===f}function _(e){return e instanceof n}function b(e){return e instanceof Error}function k(e){return e instanceof d}function g(e){return _(e)?f:b(e)?u:a}return d});