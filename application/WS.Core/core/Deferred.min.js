define("Core/Deferred",["require","exports","Env/Env"],function(r,e,c){"use strict";function n(r){this.message=r,this.canceled=true}var t;n.prototype=Object.create(Error.prototype),(function(){return this||(0,eval)("this")}()).DeferredCanceledError=n;var o=-1,i=0,s=1,a=2,u=[0,1,1],l={},f;function h(r){return r._fired===a}function d(r){return r instanceof n}function p(r){return r instanceof Error}function _(r){return r&&!!(r.addCallback&&r.addErrback)}function b(r){return d(r)?a:p(r)?s:i}return l[o]="waiting",l[i]="success",l[s]="failed",l[a]="canceled",function(){function t(r){if(r){if(r.cancelCallback)this._cancelCallback=r.cancelCallback;this._logCallbackExecutionTime=!!r.logCallbackExecutionTime}this._chained=false,this._chain=[],this._fired=o,this._paused=0,this._results=[null,null],this._running=false,this._hasErrback=false,this._logger=r&&r.logger,this._loggerAwait=r&&r.loggerAwait||setTimeout}return Object.defineProperty(t.prototype,"logger",{get:function(){return this._logger||c.IoC.resolve("ILogger")},enumerable:true,configurable:true}),t.prototype.logCallbackExecutionTime=function(r){this._logCallbackExecutionTime=!!r},t.prototype.cancel=function(){if(this._fired===o){if(this._fired=a,this._results[u[this._fired]]=new n("Cancel"),this.__parentPromise&&this.__parentPromise.abort)this.__parentPromise.abort();if(this._cancelCallback){var r=this._cancelCallback;this._cancelCallback=null;try{r()}catch(r){this.logger.error("Deferred","Cancel function throwing an error: "+r.message,r)}}this._fire()}return this},t.prototype.callback=function(r){if(!h(this))this._resback(this._check(r));return this},t.prototype.errback=function(r){if(!h(this))this._resback(this._check(r,true));return this},t.prototype._resback=function(r){this._cancelCallback=null,this._fired=b(r),this._results[u[this._fired]]=r,this._fire()},t.prototype._check=function(r,e){var t=this,n=r;if(this._fired!==o)throw new Error('Deferred is already fired with state "'+l[this._fired]+'"');if(_(n))throw new Error("DeferredLike instances can only be chained if they are the result of a callback");if(e){if(!p(n))if(void 0!==(n=new Error(n)).number&&!Number.isNaN(n.number)&&!n.message)n.message=""+n.number;if(!c.constants.isBrowserPlatform){var i=new Error('"'+n.message+'"'),a;(0,this._loggerAwait)(function(){if(!t._hasErrback)t.logger.error("Deferred","There is no callbacks attached to handle error",i),t.logger.error("Deferred","Unhandled error",n)})}}return n},t.prototype.addBoth=function(r){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(r,r)},t.prototype.finally=function(r){var t,n,e=new Promise(function(r,e){t=r,n=e}).then(r,r);return this.addCallbacks(function(r){return t(),r},function(r){return n(),r}),e},t.prototype.addCallback=function(r){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(r,null)},t.prototype.then=function(r,e){var t,n,i=new Promise(function(r,e){t=r,n=e}).then(r,e);return this.addCallbacks(function(r){return t(r),r},function(r){return n(r),r}),i},t.prototype.addErrback=function(r){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(null,r)},t.prototype.catch=function(r){var t,e=new Promise(function(r,e){t=e}).catch(r);return this.addErrback(function(r){return t(r),r}),e},t.prototype.addCallbacks=function(r,e){if(this._chained)throw new Error("Chained Deferreds can not be re-used");if(null!==r&&"function"!==typeof r||null!==e&&"function"!==typeof e)throw new Error("Both arguments required in addCallbacks");if(e)this._hasErrback=true;var t=this._fired,n=t===o||this._running||this._paused>0;if(n||r&&t===i||e&&(t===s||t===a))if(this._chain.push([r,e]),!n)this._fire();return this},t.prototype._fire=function(){var r=this._chain,e=this._fired,t=this._results[u[e]],n=this,i=null;while(r.length>0&&0===this._paused){var a,o=r.shift()[u[e]];if(null===o)continue;try{if(this._running=true,this._logCallbackExecutionTime)t=c.coreDebug.methodExecutionTime(o,this,[t]);else t=o(t);if(e=b(t),_(t))i=function(r){n._paused--,n._resback(r)},this._paused++}catch(r){e=s,t=p(r)?r:new Error(r),this.logger.error("Deferred","Callback function throwing an error: "+r.message,r)}finally{this._running=false}}if(this._fired=e,this._results[u[e]]=t,i&&this._paused)t.addBoth(i),t._chained=true},t.prototype.dependOn=function(r){var e=this;return r.addCallbacks(function(r){return e.callback(r),r},function(r){return e.errback(r),r}),this},t.prototype.createDependent=function(){var r;return(new t).dependOn(this)},t.prototype.isReady=function(r){return this._fired!==o&&(r?!this._paused:true)},t.prototype.isCallbacksLocked=function(){return this._chained},t.prototype.isSuccessful=function(){return this._fired===i},t.prototype.getResult=function(){if(this.isReady())return this._results[u[this._fired]];throw new Error("No result at this moment. Deferred is still not ready")},t.fromTimer=function(r){var e=new t;return setTimeout(e.callback.bind(e),r),e},t.success=function(r){return(new t).callback(r)},t.fail=function(r){var e=r instanceof Error?r:new Error(r?String(r):"");return(new t).errback(e)},t.nearestOf=function(r){var n=new t;if(r.forEach(function(r,t){r.addBoth(function(r){if(!n.isReady())if(r instanceof Error){var e=new Error;e.from=t,e.data=r,n.errback(e)}else n.callback({from:t,data:r});return r})}),0===r.length)n.callback();return n},t.callbackWrapper=function(r,e){if(r&&r instanceof t)return r.addCallback(e);return e(r)},t.fromPromise=function(r){var e=new t;return(e.__parentPromise=r).then(function(r){e.callback(r)}).catch(function(r){e.errback(r)}),e},t.toPromise=function(r){return new Promise(function(e,t){r.createDependent().addCallbacks(function(r){e(r)},function(r){t(r)})})},t}()});