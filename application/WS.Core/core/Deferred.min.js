define("Core/Deferred",["require","exports","Core/constants","Core/core-debug","Core/IoC"],function(r,e,i,s,c){"use strict";function n(r){this.message=r,this.canceled=true}var t;n.prototype=Object.create(Error.prototype),(function(){return this||(0,eval)("this")}()).DeferredCanceledError=n;var a=-1,o=0,u=1,f=2,l=[0,1,1],h={};h[a]="waiting",h[o]="success",h[u]="failed",h[f]="canceled";var d=function(){function t(r){if(r)if(r.cancelCallback)this._cancelCallback=r.cancelCallback;this._chained=false,this._chain=[],this._fired=a,this._paused=0,this._results=[null,null],this._running=false}return t.prototype.cancel=function(){if(this._fired===a){if(this._fired=f,this._results[l[this._fired]]=new n("Cancel"),this.__parentPromise&&this.__parentPromise.abort)this.__parentPromise.abort();if(this._cancelCallback){var r=this._cancelCallback;this._cancelCallback=null;try{r()}catch(r){c.resolve("ILogger").error("Deferred","Cancel function throwing an error: "+r.message,r)}}this._fire()}return this},t.prototype.callback=function(r){if(!p(this))this._resback(this._check(r));return this},t.prototype.errback=function(r,e){if(!p(this))this._resback(this._check(r,true,e));return this},t.prototype._resback=function(r){this._cancelCallback=null,this._fired=w(r),this._results[l[this._fired]]=r,this._fire()},t.prototype._check=function(r,e,t){var n=r;if(this._fired!==a)throw new Error('Deferred is already fired with state "'+h[this._fired]+'"');if(k(n))throw new Error("Deferred instances can only be chained if they are the result of a callback");if(e){if(!b(n))if(void 0!==(n=new Error(n)).number&&!Number.isNaN(n.number)&&!n.message)n.message=""+n.number;if(false!==t&&i.isNodePlatform&&!this._chain.some(function(r){return"function"===typeof r[1]}))c.resolve("ILogger").error("Deferred","There is no callbacks attached to handle error"),c.resolve("ILogger").error("Deferred","Unhandled error:",n)}return n},t.prototype.addBoth=function(r){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(r,r)},t.prototype.finally=function(r){var t,n,e=new Promise(function(r,e){t=r,n=e}).then(r,r);return this.addCallbacks(function(r){return t(),r},function(r){return n(),r}),e},t.prototype.addCallback=function(r){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(r,null)},t.prototype.then=function(r,e){var t,n,i=new Promise(function(r,e){t=r,n=e}).then(r,e);return this.addCallbacks(function(r){return t(r),r},function(r){return n(r),r}),i},t.prototype.addErrback=function(r){if(1!==arguments.length)throw new Error("No extra args supported");return this.addCallbacks(null,r)},t.prototype.catch=function(r){var t,e=new Promise(function(r,e){t=e}).catch(r);return this.addErrback(function(r){return t(r),r}),e},t.prototype.addCallbacks=function(r,e){if(this._chained)throw new Error("Chained Deferreds can not be re-used");if(null!==r&&"function"!==typeof r||null!==e&&"function"!==typeof e)throw new Error("Both arguments required in addCallbacks");var t=this._fired,n=t===a||this._running||this._paused>0;if(n||r&&t===o||e&&(t===u||t===f))if(this._chain.push([r,e]),!n)this._fire();return this},t.prototype._fire=function(){var r=this._chain,e=this._fired,t=this._results[l[e]],n=this,i=null;while(r.length>0&&0===this._paused){var a,o=r.shift()[l[e]];if(null===o)continue;try{if(this._running=true,e=w(t=s.methodExecutionTime(o,this,[t])),k(t))i=function(r){n._paused--,n._resback(r)},this._paused++}catch(r){e=u,t=b(r)?r:new Error(r),c.resolve("ILogger").error("Deferred","Callback function throwing an error: "+r.message,r)}finally{this._running=false}}if(this._fired=e,this._results[l[e]]=t,i&&this._paused)t.addBoth(i),t._chained=true},t.prototype.dependOn=function(r){var e=this;return r.addCallbacks(function(r){return e.callback(r),r},function(r){return e.errback(r),r}),this},t.prototype.createDependent=function(){var r;return(new t).dependOn(this)},t.prototype.isReady=function(r){return this._fired!==a&&(r?!this._paused:true)},t.prototype.isCallbacksLocked=function(){return this._chained},t.prototype.isSuccessful=function(){return this._fired===o},t.prototype.getResult=function(){if(this.isReady())return this._results[l[this._fired]];throw new Error("No result at this moment. Deferred is still not ready")},t.fromTimer=function(r){var e=new t;return setTimeout(e.callback.bind(e),r),e},t.success=function(r){return(new t).callback(r)},t.fail=function(r){var e=r instanceof Error?r:new Error(r?String(r):"");return(new t).errback(e,false)},t.nearestOf=function(r){var n=new t;if(r.forEach(function(r,t){r.addBoth(function(r){if(!n.isReady())if(r instanceof Error){var e=new Error;e.from=t,e.data=r,n.errback(e)}else n.callback({from:t,data:r});return r})}),0===r.length)n.callback();return n},t.callbackWrapper=function(r,e){if(r&&r instanceof t)return r.addCallback(e);return e(r)},t.fromPromise=function(r){var e=new t;return(e.__parentPromise=r).then(function(r){e.callback(r)}).catch(function(r){e.errback(r)}),e},t.toPromise=function(r){return new Promise(function(e,t){r.createDependent().addCallbacks(function(r){e(r)},function(r){t(r)})})},t}();function p(r){return r._fired===f}function _(r){return r instanceof n}function b(r){return r instanceof Error}function k(r){return r instanceof d}function w(r){return _(r)?f:b(r)?u:o}return d});