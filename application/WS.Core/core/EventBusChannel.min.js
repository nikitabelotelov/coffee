define("Core/EventBusChannel",["Core/EventObject","Core/IoC","Core/constants"],function(a,s,t){"use strict";var l=!(t.isBrowserPlatform||!t.isBuildOnServer);function e(t){t=t||{},this._events={},this._eventQueue=[],this._eventsAllowed=false,this._isDestroyed=false,this._onceEvents={},this._notificationQueue={},this._queueSize={},this._waitForPermit=t.waitForPermit||false,this._strictMode=t.strictMode||false,this._name=t.name||"",this.__EbDestroyCallback=t.destroyCallback||function(){},this._subscribeOnPS=t.subscribeOnPS||false,this.publish("onDestroy")}function _(t){if("string"!==typeof t)return t;return t.toLowerCase()}return e.prototype.isDestroyed=function(){return this._isDestroyed},e.prototype.publish=function(){for(var t=0,e=arguments.length;t<e;t++){var i=arguments[t];if(i&&!i.charAt)throw new Error(rk("Аргументами функции publish должно быть несколько строк - имён событий"));i=_(i),this._events[i]=this._events[i]||[],this._notificationQueue[i]=this._notificationQueue[i]||[]}return this},e.prototype.setEventQueueSize=function(t,e){var i;if("number"==typeof t)e=t,t="*";if("object"==typeof t){for(var n in t)if(t.hasOwnProperty(n)){var s=t[n];this.setEventQueueSize(n,s)}return}if(t=_(t),this._queueSize[t]=e,"*"==t)i=Object.keys(this._notificationQueue);else i=[t];i.forEach(function(t){if(this._notificationQueue[t]&&this._notificationQueue[t].length>e)this._notificationQueue[t].slice(0,e)},this)},e.prototype._notifyToHandler=function(e,t,i,n){try{if(n=[t].concat(n),i&&(!i.ctx||!i.ctx.isDestroyed||!i.ctx.isDestroyed()))i.fn.apply(i.ctx,n);if(!t.isBubbling()||!this._events)return false}catch(t){s.resolve("ILogger").error(i.ctx&&i.ctx.describe?i.ctx.describe():"Unknown Object",'Event handler for "'+e+'" returned error: '+t.message,t)}},e.prototype.notify=function(t){for(var e=new Array(arguments.length-1),i=1;i<arguments.length;i++)e[i-1]=arguments[i];return this._notifyWithTarget(t,void 0,e)},e.prototype.notifyWithTarget=function(t,e){for(var i=new Array(arguments.length-2),n=2;n<arguments.length;n++)i[n-2]=arguments[n];return this._notifyWithTarget(t,e,i)},e.prototype._notifyWithTarget=function(t,e,i){var n=_(t),s,r,o,u,h,f;if(this._waitForPermit&&!this._eventsAllowed)return void this._eventQueue.push(arguments);if(!(f=this._events[n])){if(this._strictMode)throw new Error('Event "'+n+'" have not published yet');f=[],this._events[n]=f}if(0!==(h=f.length)){for(r=new a(o=n,e),u=0;u<h;u++)if(false===this._notifyToHandler(o,r,f[u],i))break;s=r.getResult()}return this._saveNotification(n,e,i),s},e.prototype._saveNotification=function(t,e,i){var n=this._queueSize[t]||this._queueSize["*"]||0;if(n){var s=this._notificationQueue[t]=this._notificationQueue[t]||[];if(s.length>=n)s.shift();s.push([e,i])}},e.prototype.eventsAllowed=function(){return this._eventsAllowed},e.prototype.allowEvents=function(){if(false===this._eventsAllowed){this._eventsAllowed=true;for(var t=0,e=this._eventQueue.length;t<e;t++)this._notifyWithTarget.apply(this,this._eventQueue[t]);this._eventQueue.length=0}},e.prototype.once=function(t,e,i,n,s){if(l&&!this._subscribeOnPS)return this;function r(){o._unsubscribeFromOnce(t,e,i,r),e.apply(this,arguments)}if(t=_(t),"function"===typeof i)s=n,n=i,i=null;var o=this,u={handler:r.originalFn=e,ctx:i,wrapper:r,fallback:n};if(!this._onceEvents[t])this._onceEvents[t]=[];return this._onceEvents[t].push(u),this.subscribe(t,r,i,n,s)},e.prototype.subscribe=function(s,e,i,n,t){if(l&&!this._subscribeOnPS)return this;var r,o;if(s=_(s),this._isDestroyed)throw new Error("Trying to subscribe event '"+s+"', but EventBusChannel is destroyed");else if(this._strictMode&&!(s in this._events))throw new Error("Event '"+s+"' is not registered");else if("function"===typeof e){if("function"===typeof i)t=n,n=i,i=null;if(n&&"function"===typeof n){var u=this,h=function(){clearTimeout(c)},f=function(t){if(o)return;if(o=true,u.unsubscribe(s,h,i),"function"==typeof e.originalFn)u.unsubscribe(s,e.originalFn,i,n);else u.unsubscribe(s,e,i,n);return t?h():n(),true},c=setTimeout(f,t||2e4);this.once(s,h,i)}if(r={fn:e,ctx:i,fb:n,killFb:f},this._events[s]=this._events[s]||[],this._events[s].push(r),this._notificationQueue[s]&&this._notificationQueue[s].length)this._notificationQueue[s].forEach(function(t){var e=t[0],i=t[1],n=new a(s,e);this._notifyToHandler(s,n,r,i)},this);return this}else throw new TypeError("Event '"+s+"' has unexpected handler")},e.prototype._unsubscribeFromOnce=function(t,e,i,n,s){t=_(t);var r,o,u=this._onceEvents[t],h=[];if(!u)return;for(r=0;r<u.length;++r)if((o=u[r]).handler===e&&(!i||o.ctx===i)&&(!n||n===o.wrapper)&&(!s||s===o.fallback))h.push(r);for(r=h.length-1;r>=0;--r)this.unsubscribe(t,u[h[r]].wrapper,i,s),this._onceEvents[t].splice(h[r],1)},e.prototype.unsubscribe=function(t,e,i,n){if(l&&!this._subscribeOnPS)return this;if(t=_(t),!e||"function"!==typeof e)throw new TypeError("Unsubscribe: second argument is not a function");var s=this._strictMode?this._events[t]:this._events[t]=this._events[t]||[];if(s){if("function"===typeof i)n=i,i=null;var r,o,u,h;for(this._unsubscribeFromOnce(t,e,i,null,n),o=0,h=(s=this._events[t]).length;o!==h;o++)if(s[o]["fn"]===e&&(s[o]["ctx"]&&i?s[o]["ctx"]===i:true)&&(s[o]["fb"]&&n?s[o]["fb"]===n:true)){if(s[o]["killFb"]&&s[o]["killFb"](true))continue;for(r=s.slice(0,o),u=++o;o!==h;o++)if(s[o]["fn"]===e&&(s[o]["ctx"]&&i?s[o]["ctx"]===i:true)&&(s[o]["fb"]&&n?s[o]["fb"]===n:true)){if(u!==o)r=r.concat(s.slice(u,o));u=o+1}if(u!==h)r=r.concat(s.slice(u,h));this._events[t]=r;break}return this}else throw new Error("Event '"+t+"' is not registered")},e.prototype.unsubscribeAll=function(){for(var t in this._events)if(this._events.hasOwnProperty(t)&&this._events[t])this._events[t].length=0;this._onceEvents={}},e.prototype.getName=function(){return this._name},e.prototype.destroy=function(){if(this.notifyWithTarget("onDestroy",this),this.unsubscribeAll(),this._name)this.__EbDestroyCallback(this);this._isDestroyed=true},e.prototype.unbind=function(t){return t=_(t),this._events[t]=[],this},e.prototype.hasEvent=function(t){return t=_(t),!this._strictMode||this._events&&!!this._events[t]},e.prototype.getEvents=function(){return Object.keys(this._events)},e.prototype.hasEventHandlers=function(t){return t=_(t),!!this._events[t]&&this._events[t].length>0},e.prototype.getEventHandlers=function(t){return t=_(t),(this._events[t]||[]).map(function(t){return t.fn})},e});