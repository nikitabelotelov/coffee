define("Core/markup/ParserUtilities",["require","Core/htmlparser2","Core/helpers/Number/randomId","Core/markup/parse","Core/helpers/Hcontrol/variableStorage","Core/helpers/Hcontrol/configStorage","Core/core-extend-initializer","Core/RightsManager","Core/ContextBinder","Core/IoC","Core/helpers/Function/shallowClone","Core/Abstract","Core/constants","Core/Deferred"],function(m,t,H,g,h,P,O,p,I,e,_,n,r,o){"use strict";var s=/&quot;/g,i=/^(\[[\s\S]*?\])$/i,a=/^WS-EXPERT([\s\S]+?)WS-EXPERT$/,l=/\{\{([\s\S]*?(}?)+)}}/gi,u=/<!-#\/EVAL#(\d+)#->/gi,d=function(e){if("&quot;"===e)return'"';else return""},E=/"/g,f=/\/>$/,b={},c=e.resolve("ILogger"),v=0;function y(e,t){return e.replace(l,function(e){return t.push(e),"<!-#/EVAL#"+(t.length-1)+"#->"})}function C(e,n){return n.length?e.replace(u,function(e,t){return n[+t]}):e}var T=function(e){var i=this;if(this.startTag=e.startTag||"",this.closeTag=e.closeTag||"",this.nodeType=e.nodeType,this.nodeName=e.nodeName,this.attributes=e.attributes||{},this.childNodes=e.childNodes,this.parentNode=e.parentNode,this.text=e.text||e.nodeValue,this.sequence=e.sequence||[],this._junk=e._junk||[],r.isNodePlatform)Object.defineProperty(this,"firstChild",{get:function(){if(i.childNodes)for(var e=0;e<i.childNodes.length;e++)if(8!==i.childNodes[e].nodeType&&10!==i.childNodes[e].nodeType)return i.childNodes[e];return null}}),Object.defineProperty(this,"nextSibling",{get:function(){for(var e=i.parentNode.childNodes||[],t,n=e.indexOf(i)+1;n<e.length;n++)if(8!==e[n].nodeType&&10!==e[n].nodeType)return e[n];return null}}),Object.defineProperty(this,"nodeValue",{get:function(){return i.text},set:function(e){i.text=e}})};function w(e){return new t(e,{recognizeSelfClosing:true,lowerCaseAttributeNames:false,lowerCaseTags:false})}function N(e){return i.test(e)||a.test(e)}T.prototype.getAttribute=function(e){var t=this.attributes[e];return t?t.value:null},T.prototype.setAttribute=function(e,t,n){var i=this.attributes[e];if(t=""+t,i)i.value=t,i.quote=void 0===n?i.quote:n;else this.attributes[e]={value:t,quote:void 0===n?'"':n},this.sequence.push(e)},T.prototype.innerHTML=function(e){var t="",n;if(void 0!==e){if("string"!==typeof e)throw new Error("Invalid parameter format");if(1!==this.nodeType)throw new Error("Only element node can change the innerHTML property");return t=e,n=b.parse(t),this.childNodes=n.childNodes,t}if(3===this.nodeType||8===this.nodeType)t+=this.text;else if(10===this.nodeType)t+="<"+this.text+">";else for(var i=0,r=this.childNodes.length;i<r;i++)t+=3===(n=this.childNodes[i]).nodeType?n.text:n.outerHTML();return t},T.prototype.outerHTML=function(){var e="",t="";if(1==this.nodeType){t=this.closeTag?this.closeTag:"",e+="<"+this.nodeName;for(var n=0;n<this.sequence.length;n++){var i=this.sequence[n];if("{"===i[0])e+=" "+i;else{var r=this.attributes[i];if(r){var o=r.value;if(""!==o||""!==r.quote){var s=[];o=C(o=(o=y(o,s))?(o+"").replace(E,"&quot;"):"",s),e+=" "+i+"="+r.quote+o+r.quote}else e+=" "+i}}}e+=-1!=this.startTag.indexOf("/>")?"/>":">"}else if(8===this.nodeType)e="\x3c!--",t="--\x3e";return e+this.innerHTML()+t},T.prototype.getElementsByTagName=function(e){var t=[];if(3!==this.nodeType&&8!==this.nodeType&&10!==this.nodeType)for(var n=0,i=this.childNodes.length;n<i;n++){if(this.childNodes[n].nodeName==e)t.push(this.childNodes[n]);t=t.concat(this.childNodes[n].getElementsByTagName(e))}return t},T.prototype.hasAttribute=function(e){return!!this.attributes[e]};var k=function(e,t){if(!e)c.log("ParserUtilities",t)},x=n.extend({$constructor:function(e){if(this.onreset(),this._markup=e.markup,this._buildHtml=!!e.buildHtml,this._tag=e.tag||"component",this._rootNode=new T({childNodes:[],parentNode:null}),this._replacer=e.replacer,"function"===typeof e.firstTagHandler)this._firstTagHandler=e.firstTagHandler;if("function"===typeof e.callback)this._callback=e.callback},_tagStackLast:function(){var e=this._tagStack.length;return e?this._tagStack[e-1]:null},setParser:function(e){this._parser=e},onparserinit:function(e){e._tokenizer.ignoreAttrib(true)},onreset:function(){if(this._buildHtml)this.html="";this._curPos=0,this._isFirstTag=true,this._tagStack=[],this._componentCount=0,this._componentNode=null},onend:function(){if(this._buildHtml)this.html+=this._markup.slice(this._curPos);this.handleCallback(null)},onopentagname:function(){if(this._isFirstTag)this._parser._tokenizer.ignoreAttrib(false)},onopentag:function(e,t,n,i){var r="/"===this._markup[this._parser.endIndex-1],o=this._parser.endIndex,s=r?o-1:o,a=this._parser.startIndex;if(k(this._componentCount>=0,"ParserUtilities: _componentCount < 0"),0===this._componentCount){if(e===this._tag)this._componentNode=this._foundComponentHandler({name:e,raw:this._markup.slice(a,s),rawStart:a,attribs:t,quotes:n,attribSequence:i,selfclosing:r}),this._componentCount++,this._tagStack.push(this._componentNode);else if(this._isFirstTag&&this._firstTagHandler){if(this._firstTagHandler)this._foundFirstTag({name:e,rawStart:a+1,rawEnd:this._parser.endIndex,attribs:t,quotes:n,attribSequence:i,selfclosing:r});this._isFirstTag=false,this._parser._tokenizer.ignoreAttrib(false)}}else{var l=this._foundComponentInnerHandler({name:e,raw:this._markup.slice(a,this._parser.endIndex),rawStart:a,attribs:t,quotes:n,attribSequence:i,selfclosing:r});if(l.nodeName===this._tag)this._componentCount++;this._tagStack.push(l)}},onclosetag:function(e,t){function n(e){return""===e||null===e}function i(e){return e&&e.startTag&&f.test(e.startTag)}var r=this._markup,o=this._parser.endIndex,s,a,l;if(this._componentCount>0)if(l=this._tagStack.pop())if(t||n(e)||i(l))l.closeTag="";else l.closeTag="</"+e+">";if(l&&l.nodeName===this._tag)if(this._componentCount--,k(this._componentCount>=0,"ParserUtilities: _componentCount < 0"),0===this._componentCount){if(a=r.slice(this._componentNode.rawStart,S(r,o)+1),s=this._replacer(this._componentNode,a),this._buildHtml)this.html+=s;this._curPos=o+1}},ontext:function(e){if(this._componentCount>0){var t=this._tagStackLast();t.childNodes.push(new T({nodeType:3,text:e,parentNode:t}))}},onprocessinginstruction:function(e,t){if(this._componentCount>0){var n=this._tagStackLast();n.childNodes.push(new T({nodeType:10,text:t,parentNode:n}))}},oncomment:function(e){if(N(e)&&this._componentCount>0){var t=this._tagStackLast();t.childNodes.push(new T({nodeType:8,text:e,parentNode:t}))}},onerror:function(e){this.handleCallback(e)},handleCallback:function(e){if(e)throw e;else if("function"===typeof this._callback)this._callback(this.html)},_createElement:function(e,t){var n,i={};for(var r in e.attribs)if(e.attribs.hasOwnProperty(r)){var o=e.attribs[r];i[r]={value:(o||"").replace(s,d),quote:e.quotes&&void 0!==e.quotes[r]?e.quotes[r]:'"'}}return(n=new T({nodeType:1,nodeName:e.name,startTag:T._forTest?"":e.raw+(e.selfclosing?"/>":">"),closeTag:T._forTest?"":e.selfclosing?"":"</"+e.name+">",attributes:i,sequence:T._forTest?[]:e.attribSequence,childNodes:[],parentNode:t})).rawStart=e.rawStart,t.childNodes.push(n),n},_foundComponentHandler:function(e){if(this._buildHtml)this.html+=this._markup.slice(this._curPos,e.rawStart);return this._createElement(e,this._rootNode)},_foundFirstTag:function(e){if(this._buildHtml)this.html+=this._markup.slice(0,e.rawStart-1)+this._firstTagHandler(e);this._curPos=e.rawEnd+1},_foundComponentInnerHandler:function(e){var t=this._tagStackLast();return this._createElement(e,t)}});function S(e,t){var n=t,i=e.length,r=t;while(">"!==e[n]&&n!==i)n++;return n===i?r:n}function q(r,e){var o=null,t,s=w({onopentag:function(e,t,n,i){s.pause(),o={name:e,attribs:t,quotes:n,attribSequence:i,raw:r.slice(s.startIndex+1,S(r,s.endIndex)),rawStart:s.startIndex+1,selfclosing:"/"===r[s.endIndex-1]}}});return s.end(r),o?e(o):r}var A=function(){var o=/\s+/;function h(e){var t={},n,i,r;if(e)for(n=0,i=(r=e.split(o)).length;n!==i;n++)if(r[n].trim())t[r[n]]=true;return t}return function(e,t,n,i){var r,o,s,a,l,u,d;if(void 0!==e.enable)e.enabled=!!e.enable;if(void 0!==e.hidden)e.visible=!e.hidden;if(a=i.attribs?_(i.attribs):{},t)l=t();if(l)for(var f in l)if(l.hasOwnProperty(f)){var c=l[f];if("class"!==f)a[f]=c}if(e.name)if(a.sbisname=""+e.name,!a.name)a.name=""+e.name;if(!a.id&&e.hasOwnProperty("id"))a.id=""+e.id;if(a.tabindex=e.enabled?"0":"-1",a.hidefocus="true",a.hasmarkup="true",a.wasbuildmarkup="true",(r=h((a["class"]?a["class"]+" ":"")+e["className"]+" "+e["cssClassName"]+" "+(l&&l["class"]?l["class"]:"")))["ws-control-inactive"]=true,r["ws-component"]=true,e.visible)delete r["ws-hidden"];else r["ws-hidden"]=true;return delete r[e.enabled?"ws-disabled":"ws-enabled"],r[e.enabled?"ws-enabled":"ws-disabled"]=true,a["class"]=Object.keys(r).join(" "),o=Object.keys(a).reduce(function(e,t){var n=a[t],i;return e+t+'="'+("config"===t?n:"string"===typeof n?n.replace(E,"&quot;"):n)+'" '},""),n(i,s=i.name+" "+o+(i.selfclosing?"/":""))}}();function M(e){var t="maintag",n="<"+t+">"+e+"</"+t+">",i=new x({markup:n,replacer:function(){},buildHtml:false,tag:t}),r=w(i);i.setParser(r),r.parseComplete(n);var o=i._componentNode;return o.closeTag="",o.nodeName=void 0,o.nodeType=9,o.parentNode=null,o.startTag="",o.text=void 0,o}function L(e,t,n,i,r,o,s,a){var l="";if(!r)r={};else if("string"===typeof r)r={id:r};if(e){var u,d=r.parentId||r.id,f=t,c=e.prototype,h=c._modifyOptions&&c._modifyOptions.bind(c),p=c._buildMarkup&&c._buildMarkup.bind(c),m,g,_,b,v,y=O.call(e),C=y._options||{},T="buildMarkupWithContext"in f?f.buildMarkupWithContext:C.buildMarkupWithContext,w;if(n&&T)b=I.initBinderForControlConfig(f),f=b.getConstructorOptions(n,e,f);if(c._template)u=O.getInstanceOptionsByDefaults(e,f,{_options:y});else u=O.getInstanceOptionsByDefaults(e,f,y);if(r&&!("enabled"in f)&&"enabled"in r&&!r.enabled&&(u.allowChangeEnable||void 0===u.allowChangeEnable))u.enabled=r.enabled,u.enable=r.enabled;if(h)if(!(u=h(u,f,s)))throw w=c._moduleName||"???",new Error("Метод _modifyOptions модуля '"+w+"' выдал null или undefined! Проверьте результат, возвращаемый методом _modifyOptions. Встаньте на точку этого исключения, и ");if(!u.id)if("undefined"!==typeof process&&o)u.id=""+o;else u.id=""+H();if(g=function(e){var t={config:e||P.pushValue(f)};if(d)t["data-pid"]=""+d;for(var n in s)if(s.hasOwnProperty(n)){var i=s[n];if("data-pid"!==n&&"config"!==n){if(-1!==n.indexOf("attr:"))n=n.split("attr:")[1];if(t[n]=i,"name"===n)t["sbisname"]=i}}return t},c._template){var b;if(u.container=a,n)u.linkedContext=n,b=I.initBinderForControlConfig(u);var N=new e(u),k={};if(window)k[u.__$config]=N;else k[u.__$config]=u;if(P.merge(k),n)b.bindControl(N,n,"syncControl");l=N.render(void 0,{attributes:g(u.__$config)})}else if("function"===typeof c._dotTplFn)l=p(c._dotTplFn,u,null,g,u.buildMarkupWithContext?n:null);else{var x=true,S;if(s&&s.config)if(S=P.getData()[s.config])x=false;if((m=x?g():g(s.config)).id=""+u.id,false===f.visible)m["class"]+=" ws-hidden";l="<component "+(_=Object.keys(m).reduce(function(e,t){var n=m[t],i;return e+t+'="'+("config"===t?n:"string"===typeof n?n.replace(E,"&quot;"):n)+'" '},""))+"></component>"}if(c._modifyOptionsAfter)if(c._modifyOptionsAfter(f),u&&u.__$config){var q={};q[u.__$config]=f,P.merge(q)}}return l}function F(t,e,n,i,r){var o="",s="",a=null;if("string"===typeof t)for(var l=0,u=(t=M(t)).childNodes.length;l<u;l++)if(1==t.childNodes[l].nodeType){t=t.childNodes[l];break}try{o=t.getAttribute("data-component"),a=m(o)}catch(e){var d=t.getAttribute("data-optional");if(d&&"false"!==d)return"";else throw e.message="Не удалось определить тип компонента. Тип: \n"+o+"\n"+e.message,e}if(a){var f=g(t),c={};for(var h in t.attributes)if(t.attributes.hasOwnProperty(h)){var p=t.attributes[h];c[h]=p.value}if(c.hasOwnProperty("data-component")&&a&&a.prototype._moduleName)c["data-component"]=a.prototype._moduleName;s=L(a,f,r,void 0,e,i,c,t)}else if("undefined"===typeof window)s=t.outerHTML();return s}function j(e){if("string"===typeof e)return-1!==e.indexOf("<component");else if(e instanceof o)c.error("ParserUtilities","Can't perform an asynchronous build inside of a CompoundControl");return false}function $(e,t,n){if("string"===typeof e){var i=-1!==e.indexOf("data-component");return{hasComponents:i,markup:i?B(e,t,n):e}}else if(e instanceof o)c.error("ParserUtilities","Can't perform an asynchronous build inside of a CompoundControl");return{hasComponents:false,markup:e}}function B(e,t,n){var i=p.rightsNeeded(),r=new x({markup:e,buildHtml:true,tag:"component",replacer:function(e){if(!e)return;if(i&&p.hasDataAccess(e))e=p.applyRights(e,b);if(!e)return"";return F(e,t,void 0,void 0,n)}}),o=w(r);return r.setParser(o),o.parseComplete(e),r.html}function D(e,t,n){var i=new x({markup:t,buildHtml:true,tag:e,replacer:n}),r=w(i);return i.setParser(r),r.parseComplete(t),i.html}function U(e,t,n){var i=new x({markup:t,buildHtml:false,tag:e,replacer:n}),r=w(i);i.setParser(r),r.parseComplete(t)}function V(e,t,n,i,r,o){var s,a={config:H("cfg-"),hasmarkup:"true"},l;if(a.attributes={config:a.config,hasmarkup:a.hasmarkup},j(s=e.apply(h.getValue(),[t,a,r]))){var u=1,d=p.rightsNeeded(),f=new x({markup:s,buildHtml:true,tag:"component",replacer:function(e){if(!e)return;if(d&&p.hasDataAccess(e))e=p.applyRights(e,b);if(!e)return"";return F(e,t,null,t&&t.sequenceId,r)},firstTagHandler:o?null:A.bind(void 0,t,i,function(e,t){return"<"+t+">"})}),c=w(f);f.setParser(c),c.parseComplete(s),l=f.html}else if(o)l=s;else l=q(s,A.bind(void 0,t,i,function(e,t){return s.substr(0,e.rawStart)+t+s.substr(e.rawStart+e.raw.length)}));return l}return b={parse:M,forEachTag:U,mapTag:D,buildMarkup:V,prepareMarkupForNode:F,buildMarkupForClass:L,buildInnerComponents:B,buildInnerComponentsExtended:$,Node:T}});