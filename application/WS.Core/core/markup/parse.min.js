define("Core/markup/parse",["require","Core/Serializer","Core/ConsoleLogger","Core/detection","Core/core-merge","Core/helpers/Hcontrol/configStorage","Core/helpers/Hcontrol/variableStorage","Core/IoC"],function(o,N,l,k,s,r,e){var x=/^(option|opt)$/i,T=/^(options|opts)$/i,w=/^name|bind|nonexistent|type|direction$/i,L=/^array$/i,O=e.getValue(),a=",";function u(e){return e.substr(0,1).toLowerCase()+e.substr(1)}function S(t){var e=t.split(":"),n;try{if(n=o(e[0]),e[1]){var i;n={readerParams:{adapterType:"TransportAdapterStatic",adapterParams:{data:n.contents&&n.contents[e[1]]}}}}}catch(e){throw new Error('Parsing datasource declaration "'+t+'" failed. Message:'+e.massage)}return n}function H(e,t){var n=t+"HTML";if("function"==typeof e[n])return e[n]();else return e[n]}function M(e){var t;if(e.childNodes.length>0)for(var n=0,i=e.childNodes.length;n<i;n++)if(3!==(t=e.childNodes[n]).nodeType)return true;return false}function P(e){return!isNaN(parseFloat(e))&&isFinite(e)}function F(e){var t;function f(e,t,n){var i,r,a,o;if(n&&n.length)a=n.trim();else if(null!==e)a=e;else a=void 0;switch(i=void 0!==a,t){case"function":if(i)r=N.getFuncFromDeclaration(a);break;case"ref":if(i)o=a,r=O.storage[o],delete O.storage[o];break;case"null":r=null,i=true;break;case"date":if("string"===typeof a)if("Invalid Date"===(r=new Date(a)).toString()&&k.isIE)r=Date.fromSQL(a);i=true;break;case"undefined":r=void 0,i=true;break;case"string":if(i)r=a;break;default:if(i)if(P(a))r=a.length>1&&"0"===a[0]&&-1===a.indexOf(".")?a:parseFloat(a);else if("false"===a)r=false;else if("true"===a)r=true;else if("null"===a)r=null;else if("undefined"===a)r=void 0;else if(/^datasource!/.test(a))r=S(a);else r=a}return{ok:i,value:r}}function n(e,t,n){var i=e.getAttribute("bind"),r=e.getAttribute("nonexistent"),a=e.getAttribute("nonexistentType"),o;if(i||n.length>0){o=f(r,a,void 0);var u="true"===e.getAttribute("oneWay");if(!u)if(null!==e.getAttribute("oneway"))u="true"===e.getAttribute("oneway");if(t.binding={fieldName:i,nonExistentValue:o.ok?o.value:void 0,bindNonExistent:o.ok,propName:t.name,oneWay:u,direction:e.getAttribute("direction")||"fromContext"},n.length>0)t.binding.subBindings=n}}if(3===e.nodeType)t=/\S/.test(e.text||e.textContent)?{name:"content",value:e.text||e.textContent}:false;else if(x.test(e.nodeName)){var i={},r,a=e.getAttribute("value"),o=e.getAttribute("type"),u=e.getAttribute("spreadOptions"),l;if(r=H(e,"inner"),i.name=e.getAttribute("name"),(l=f(a,o,r)).ok)i.value=l.value;i.spread="true"===u,n(e,i,[]),t=i}else if(T.test(e.nodeName)){var s=L.test(e.getAttribute("type")),d=s?[]:{},c,g=[],p,b=e.childNodes;if(!s&&!M(e))for(var v=0,m=e.attributes,h=m.length;v<h;v++)if(c=m[v],!w.test(c.name))d[c.name]=c.value;for(var y=0,A=0,C=b.length;A<C;A++)if(p=F(b[A]))if(s){if(p.binding)p.binding.index=d.length+y,g.push(p.binding);if("value"in p)d.push(p.value);else y++}else if("content"==p.name&&d.content)d.content+=p.value;else{if("value"in p)d[p.name]=p.value;if(p.binding)g.push(p.binding)}n(e,t={name:e.getAttribute("name")||"Object",value:d,spread:"true"===e.getAttribute("spreadOptions")},g)}else if("outerHTML"in e)t={name:"content",value:H(e,"outer")};return t}function d(e){var t="Lib/Control/AttributeCfgParser/AttributeCfgParser",n=o.defined(t)?o(t):null,i=n&&e.getAttribute("data-bind"),r;if(i){var a=n(i);r=Object.keys(a).map(function(e){return{fieldName:a[e],propName:u(e),oneWay:false}})}else r=[];return r}function n(e,t){var n=t.childNodes,i=[],r=d(t),a;if(n.length)for(var o=0,u=n.length;o<u;o++){var f=F(n[o]);if(f)if("content"===f.name){if("function"!==typeof e.content){if(e.content&&"function"===typeof e.content[0])continue;e.content=e.content||"",e.content+=f.value}}else{if(f.hasOwnProperty("value"))if(f.spread)s(e,f.value);else e[f.name]=f.value;if(f.binding)if(!f.spread)i.push(f.binding);else{if("function"===typeof(a=n[o].outerHTML))a=n[o].outerHTML();l.error("markup-helpers","Атрибут binding нельзя использовать вместе с атрибутом spreadOptions: "+a)}}}if(i.length+r.length>0)e.bindings=i.concat(r);return e}function f(e,t){var n=r.getValue(e),i;if(!("name"in n))if(i=t.getAttribute("name"))n.name=i;return n}function i(t){var e=t.getAttribute("config"),n,i;if(e)if((n=e.split(a)).length>1)return(i=n.map(function(e){return f(e,t)})).__doubleconfig=true,i;return f(e,t)}return function(t){var e=i(t);if(t.cloneNode){if("true"!=t.getAttribute("hasMarkup"))e=n(e,t);if(e)if(e.length)(e=e.map(function(e){return e.element=t,e})).__doubleconfig=true;else e.element=t}else e=n(e,t);return e}});