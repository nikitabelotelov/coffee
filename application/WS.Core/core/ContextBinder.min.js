define("Core/ContextBinder",["Core/Context","Core/Abstract","Core/helpers/Object/isPlainObject","Core/helpers/Object/isEmpty","Core/helpers/Array/findIndex","Core/IoC","Core/core-merge","Core/core-clone","Core/helpers/Function/shallowClone","Core/core-instance","Core/core-debug","Core/ConsoleLogger"],function(v,e,f,p,h,n,t,i,o,r,x){"use strict";var c=v.STRUCTURE_SEPARATOR,P=v.NonExistentValue,d={},m=false,g="trace",N="log",s=[],b=n.resolve("ILogger"),a=t,l=i,V=o,E="fromProperty",B="fromContext",_=[],u,C=function(){return this||(0,eval)("this")}()["console"],D=C&&C.log?Function.prototype.bind.call(C.log,C):function(){},O=C&&C.trace?Function.prototype.bind.call(C.trace,C):D;function S(e,n,t,i,o,r){s.push({control:e,binder:n,context:t,synchronize:i,getSynchData:o,getConstructorOptions:r})}function w(n,t,i){s=s.filter(function(e){return e.control!==n&&e.binder!==t&&e.context!==i})}function y(e){var n;return s.filter(e).map(function(e){return{bindings:i(e.binder._bindings),context:e.context,synchronize:e.synchronize,getSynchData:e.getSynchData,getConstructorOptions:e.getConstructorOptions}})}function A(e){if(m)b.error("Core/ContextBinder","string"===typeof e?e:e())}function F(e,n,t,i,o){if(m){if(!e.comment)e.comment={};var r="function"===typeof t?t():t,s=e.comment[n],a;if(s)if(Array.isArray(s))s.push(r);else e.comment[n]=[s,r];else e.comment[n]=r;if(o)A(a="Проблема в синхронизации контрола "+i.getName()+"/"+i.getId()+": "+r)}}var W=e.extend({$protected:{_options:{bindings:null},_bindings:[{fieldName:"",propName:"",propPath:[],oneWay:false,lastValues:{fromContext:d,fromProperty:d}}],_isBound:false},$constructor:function(e){function i(e){var n;if("index"in e)n=""+e.index;else n=e.propName||"";return n}function o(e,n){if(f(n))if(n.fieldName&&""!==i(n))this.defineBinding(e+i(n),n.fieldName,n.oneWay,n.direction,n.nonExistentValue,n.bindNonExistent);else if(n.subBindings&&""!==i(n)){for(var t in n.subBindings)if(n.subBindings.hasOwnProperty(t))o.call(this,e+i(n)+c,n.subBindings[t])}else throw new Error("плохой формат элемента binding");else if(Array.isArray(n))this.defineBinding.apply(this,n);else throw new Error("плохой формат элемента binding")}this._bindings=[];var n=this._options.bindings;if(n&&n.length){var t=this;n.forEach(function(e){if(!e.propName||-1===e.propName.indexOf("__dirtyCheckingVars_"))o.call(t,"",e)})}},_reduceBindings:function(n,o,e){return this._bindings.filter(function(e){return!e.oneWay||e.oneWay&&e.direction===n}).reduce(function(e,n,t,i){return e=o.call(this,e,n,t===i.length-1)},e,this)},getConstructorOptions:function(u,e,n){var t=function(e,n){var t=u.hasFieldWithParents(n.fieldName),i,a,o,r,s,l;if(t)i=u.getValue(n.fieldName);else if(t=n.bindNonExistent)i=n.nonExistentValue;else A(function(){return"Невозможно прочитать из контекста опцию (начальное значение свойства) для конструктора: "+n.propName+", поскольку в контексте нет соответствующего ей поля "+n.fieldName+", и у привязки не установлены параметры bindNonExistent или bindNonExistentType"});if(t)o=(a=[n.propName].concat(n.propPath)).slice(0,a.length-1),r=a[a.length-1],s=parseInt(r,10),(l=o.reduce(function(e,n,t){var i=a[t+1],o=parseInt(i,10),r,s;if(!isNaN(o)){if(!(s=n in e&&Array.isArray(e[n])))e[n]=[]}else if(!(s=n in e&&f(e[n])))e[n]={};return e[n]},e))[isNaN(s)?r:s]=i;return e}.bind(this),i=this._reduceBindings(B,t,{}),o;if(e&&n){if((o=n.name)&&n.loadValueFromContextToConstructorOptions&&r.classOfMixin(e,"Lib/Mixins/DataBoundMixin"))i=t(i,{fieldName:o,propName:"value",propPath:[],oneWay:true,direction:B,bindNonExistent:false});i=a(n,i)}return i},bindControl:function(C,y,e){function t(n,e){function t(n){return h(_,function(e){return e.control===C&&e.context===y&&e.direction===n})}function i(){var e=t(n);if(-1!==e)_.splice(e,1)}if(!C.isDestroyed()&&!y.isDestroyed()){var o;if(-1===t(n)){_.push({control:C,context:y,direction:n});try{e.call(this)}finally{i()}}}}function i(e,n){var t,i,o;if(m===g||m===N)t=C.getContainer(),(i=m===g?O:D)(o=e===B?"Синхронизация контрола из контекста ":"Синхронизация контрола в контекст ",t&&t[0],n.comment,C,y,n)}function o(){var e=s.call(this),n=e.value;if(i(B,e),e.lastValues.forEach(function(e){e.binding.lastValues[B]=e.value}),!p(n))C.setProperties(n)}function r(){var e=n.call(this);i(E,e),e.lastValues.forEach(function(e){e.binding.lastValues[E]=e.value}),y.runInBatchUpdate(function(){if(e.toRemove.forEach(function(e){y.removeValue(e)}),!p(e.toSet))y.setValue(e.toSet)})}function s(){var g=function(e){if(-1===N.indexOf(e)){if(e.transaction)e.transaction();N.push(e)}},N=[],e,n,b;if(!y.isDestroyed()&&!C.isDestroyed())n=this._reduceBindings(B,function(e,n){if(n.propName&&!(n.propName in e))if(n.propName.indexOf("__dirtyCheckingVars_")>-1)delete n.propName;else e[n.propName]=C.getProperty(n.propName);return e},{}),b=V(n),e=this._reduceBindings(B,function(e,n,t){var i,o,r,s,a,l,u,f,c,d,p,h=e.value,m=n.lastValues[B];if(f=y.hasFieldWithParents(n.fieldName))i=y.getValue(n.fieldName);else if(f=n.bindNonExistent)i=n.nonExistentValue;else i=P;if(d=n.propPath,r=((o=n.propName)in h?h:b)[o],s=v.getValueType(r),g(s),e.lastValues.push({binding:n,value:i,lastValue:m}),m!==i)if(f)if(a=s.setWillChange(r,d,i))u=s.set(r,d,i),h[o]=u,F(e,o,"Свойство "+n.fullPropName+" синхронизировано с полем контекста "+n.fieldName);else if(d.length>0)if(!(p=(c=s.get(r,d))===i||s.equals&&s.equals(c,i)))if(x.checkAssertion(c===P),null===r||void 0===r)if(C.initializeProperty(o),null!==(r=C.getProperty(o))&&void 0!==r)if(s=v.getValueType(r),g(s),a=s.setWillChange(r,d,i))u=s.set(r,d,i),h[o]=u,F(e,o,"Свойство "+n.fullPropName+" успешно инициализировано из значения null или undefined, и синхронизировано с полем контекста "+n.fieldName);else F(e,o,"Свойство "+n.fullPropName+" не синхронизируется, потому что не отличается от значения поля контекста "+n.fieldName);else F(e,o,"Свойство "+n.fullPropName+" не синхронизируется, поскольку его инициализация из null/undefined не прошла, "+"оно всё так же равно null или undefined, и в него невозможна запись по пути "+ +n.propPathStr,C,true);else F(e,o,"Свойство "+n.fullPropName+" не синхронизируется, потому что в его текущее значение невозможна запись по пути "+n.propPathStr,C,true);else F(e,o,"Свойство "+n.fullPropName+" не синхронизируется, потому что не отличается от значения поля контекста "+n.fieldName);else F(e,o,"Свойство "+n.fullPropName+" не синхронизируется, потому что не отличается от значения поля контекста "+n.fieldName);else if(d.length>0)if((l=s.remove(r,d)).changed)h[o]=l.value,F(e,o,"В свойстве "+n.propName+" значение по пути "+n.propPathStr+" удаляется, потому что в контексте нет соответствующего ему поля "+n.fieldName);else F(e,o,"В свойстве "+n.propName+" значение по пути "+n.propPathStr+" нужно удалить, поскольку в контексте нет соответствующего ему поля "+n.fieldName+", но удаление невозможно, поскольку значения в свойстве по этому пути нет, или типом значения не поддерживается удаление",C,true);else F(e,o,"Свойство "+n.propName+" нужно удалить, поскольку в контексте нет соответствующего ему поля "+n.fieldName+", но удаление невозможно, поскольку контрол не умеет удалять свойства (только под-свойства - значения внутри свойств)",C,true);else F(e,o,"В свойстве "+n.propName+" значение по пути "+n.propPathStr+" не синхронизируется, потому что при прошлой синхронизации соотв. ему поле контекста "+n.fieldName+" было таким же, как и в эту синхронизацию",C,true);if(t)N.forEach(function(e){if(e.commit)e.commit()}),N.length=0;return e},{value:{},comment:{},lastValues:[]});else e={value:{},comment:{},lastValues:[]};return e}function n(){if(!y.isDestroyed()&&!C.isDestroyed()){var s=function(e){try{return C.getProperty(e)}catch(e){b.error("Control",e.message)}},e;return this._reduceBindings(E,function(e,n){var t=s(n.propName),i,o=v.getValueType(t).get(t,n.propPath),r=n.lastValues[E];if(e.lastValues.push({binding:n,value:o,lastValue:r}),r!==o)if(o!==P&&o!==n.nonExistentValue)e.toSet[n.fieldName]=o,F(e,n.fieldName,"Поле контекста "+n.fieldName+" записывается, потому что соответствующее ему свойство "+n.fullPropName+" существует в свойствах контрола, и не равно параметру nonExistentValue");else if(e.toRemove.push(n.fieldName),o===P)F(e,n.fieldName,"Поле контекста "+n.fieldName+" удаляется, потому что соответствующее ему св-во контрола "+n.fullPropName+" не существует в свойствах контрола");else F(e,n.fieldName,"Поле контекста "+n.fieldName+" удаляется, потому что соответствующее ему св-во контрола "+n.fullPropName+" равно параметру nonExistentValue");else F(e,n.fieldName,"Поле контекста "+n.fieldName+" не меняется (не записывается и не удаляется), потому что при прошлой синхронизации значение соотв. (под)свойства контрола было таким же");return e},{toSet:{},toRemove:[],comment:{},lastValues:[]})}}function a(e){var n;t.call(u,e,e===E?r:o)}function l(e){if(e===E)return n.call(u);else if(e===B)return s.call(u)}var u=this,f,c,d;if(this._isBound)throw new Error("На этом экземпляре класса Core/ContextBinder bindControl уже был вызван (из метода createBoundControl, или bindControl). Второй раз bindControl вызывать нельзя.");if(this._isBound=true,this._bindings.length>0)if(f=t.bind(this,B,o),c=t.bind(this,E,r),d=function(){y.unsubscribe("onFieldsChanged",f),C.unsubscribe("onPropertiesChanged",c),u.unsubscribe("onDestroy",d),C.unsubscribe("onDestroy",d),y.unsubscribe("onDestroy",d),w(C,u,y)},y.subscribe("onFieldsChanged",f),C.subscribe("onPropertiesChanged",c),this.subscribe("onDestroy",d),C.subscribe("onDestroy",d),y.subscribe("onDestroy",d),S(C,this,y,a,l.bind(this),this.getConstructorOptions.bind(this,y)),"syncContext"===e)r.call(this);else if("syncControl"===e)o.call(this)},defineBinding:function(e,n,t,i,o,r){var s=e.split(c),a=s[0],l=s.slice(1),u=l.join(c),f={fieldName:n,propName:a,propPath:l,fullPropName:e,propPathStr:u,oneWay:t,direction:i||B,nonExistentValue:o,bindNonExistent:r,lastValues:{}};f.lastValues[B]=d,f.lastValues[E]=d,this._bindings.push(f)}});return W.createBoundControl=function(e,n,t,i){var o=new W({bindings:i}),r,s=new e(o.getConstructorOptions(t,e,l(n)));return o.bindControl(s,t),s},W.getBindingsForControl=function(n){return y(function(e){return e.control===n})},W.getBindingsForContext=function(n){return y(function(e){return e.context===n})},W.initBinderForControlConfig=function(e){return new W({bindings:e.bindings||[]})},W.setDebugMode=function(e){m=e},W});