define("Core/ContextBinder",["Core/Context","Core/Abstract","Core/helpers/Object/isPlainObject","Core/helpers/Object/isEmpty","Core/helpers/Array/findIndex","Env/Env","Core/core-merge","Core/core-clone","Core/helpers/Function/shallowClone","Core/core-instance"],function(v,e,f,p,h,x,n,t,i,o){"use strict";var c=v.STRUCTURE_SEPARATOR,P=v.NonExistentValue,d={},m=false,g="trace",N="log",s=[],b=x.IoC.resolve("ILogger"),a=n,l=t,V=i,E="fromProperty",B="fromContext",_=[],r,u=function(){return this||(0,eval)("this")}()["console"],D=u&&u.log?Function.prototype.bind.call(u.log,u):function(){},O=u&&u.trace?Function.prototype.bind.call(u.trace,u):D;function S(e,n,t,i,r,o){s.push({control:e,binder:n,context:t,synchronize:i,getSynchData:r,getConstructorOptions:o})}function w(n,t,i){s=s.filter(function(e){return e.control!==n&&e.binder!==t&&e.context!==i})}function y(e){var n;return s.filter(e).map(function(e){return{bindings:t(e.binder._bindings),context:e.context,synchronize:e.synchronize,getSynchData:e.getSynchData,getConstructorOptions:e.getConstructorOptions}})}function C(e){if(m)b.error("Core/ContextBinder","string"===typeof e?e:e())}function A(e,n,t,i,r){if(m){if(!e.comment)e.comment={};var o="function"===typeof t?t():t,s=e.comment[n],a;if(s)if(Array.isArray(s))s.push(o);else e.comment[n]=[s,o];else e.comment[n]=o;if(r)C(a="Проблема в синхронизации контрола "+i.getName()+"/"+i.getId()+": "+o)}}var F=e.extend({$protected:{_options:{bindings:null},_bindings:[{fieldName:"",propName:"",propPath:[],oneWay:false,lastValues:{fromContext:d,fromProperty:d}}],_isBound:false},$constructor:function(e){function i(e){var n;if("index"in e)n=""+e.index;else n=e.propName||"";return n}function r(e,n){if(f(n))if(n.fieldName&&""!==i(n))this.defineBinding(e+i(n),n.fieldName,n.oneWay,n.direction,n.nonExistentValue,n.bindNonExistent);else if(n.subBindings&&""!==i(n)){for(var t in n.subBindings)if(n.subBindings.hasOwnProperty(t))r.call(this,e+i(n)+c,n.subBindings[t])}else throw new Error("плохой формат элемента binding");else if(Array.isArray(n))this.defineBinding.apply(this,n);else throw new Error("плохой формат элемента binding")}this._bindings=[];var n=this._options.bindings;if(n&&n.length){var t=this;n.forEach(function(e){if(!e.propName||-1===e.propName.indexOf("__dirtyCheckingVars_"))r.call(t,"",e)})}},_reduceBindings:function(n,r,e){return this._bindings.filter(function(e){return!e.oneWay||e.oneWay&&e.direction===n}).reduce(function(e,n,t,i){return e=r.call(this,e,n,t===i.length-1)},e,this)},getConstructorOptions:function(u,e,n){var t=function(e,n){var t=u.hasFieldWithParents(n.fieldName),i,a,r,o,s,l;if(t)i=u.getValue(n.fieldName);else if(t=n.bindNonExistent)i=n.nonExistentValue;else C(function(){return"Невозможно прочитать из контекста опцию (начальное значение свойства) для конструктора: "+n.propName+", поскольку в контексте нет соответствующего ей поля "+n.fieldName+", и у привязки не установлены параметры bindNonExistent или bindNonExistentType"});if(t)r=(a=[n.propName].concat(n.propPath)).slice(0,a.length-1),o=a[a.length-1],s=parseInt(o,10),(l=r.reduce(function(e,n,t){var i=a[t+1],r=parseInt(i,10),o,s;if(!isNaN(r)){if(!(s=n in e&&Array.isArray(e[n])))e[n]=[]}else if(!(s=n in e&&f(e[n])))e[n]={};return e[n]},e))[isNaN(s)?o:s]=i;return e}.bind(this),i=this._reduceBindings(B,t,{}),r;if(e&&n){if((r=n.name)&&n.loadValueFromContextToConstructorOptions&&o.classOfMixin(e,"Lib/Mixins/DataBoundMixin"))i=t(i,{fieldName:r,propName:"value",propPath:[],oneWay:true,direction:B,bindNonExistent:false});i=a(n,i)}return i},bindControl:function(y,C,e){function t(n,e){function t(n){return h(_,function(e){return e.control===y&&e.context===C&&e.direction===n})}function i(){var e=t(n);if(-1!==e)_.splice(e,1)}if(!y.isDestroyed()&&!C.isDestroyed()){var r;if(-1===t(n)){_.push({control:y,context:C,direction:n});try{e.call(this)}finally{i()}}}}function i(e,n){var t,i,r;if(m===g||m===N)t=y.getContainer(),(i=m===g?O:D)(r=e===B?"Синхронизация контрола из контекста ":"Синхронизация контрола в контекст ",t&&t[0],n.comment,y,C,n)}function r(){var e=s.call(this),n=e.value;if(i(B,e),e.lastValues.forEach(function(e){e.binding.lastValues[B]=e.value}),!p(n))y.setProperties(n)}function o(){var e=n.call(this);i(E,e),e.lastValues.forEach(function(e){e.binding.lastValues[E]=e.value}),C.runInBatchUpdate(function(){if(e.toRemove.forEach(function(e){C.removeValue(e)}),!p(e.toSet))C.setValue(e.toSet)})}function s(){var g=function(e){if(-1===N.indexOf(e)){if(e.transaction)e.transaction();N.push(e)}},N=[],e,n,b;if(!C.isDestroyed()&&!y.isDestroyed())n=this._reduceBindings(B,function(e,n){if(n.propName&&!(n.propName in e))if(n.propName.indexOf("__dirtyCheckingVars_")>-1)delete n.propName;else e[n.propName]=y.getProperty(n.propName);return e},{}),b=V(n),e=this._reduceBindings(B,function(e,n,t){var i,r,o,s,a,l,u,f,c,d,p,h=e.value,m=n.lastValues[B];if(f=C.hasFieldWithParents(n.fieldName))i=C.getValue(n.fieldName);else if(f=n.bindNonExistent)i=n.nonExistentValue;else i=P;if(d=n.propPath,o=((r=n.propName)in h?h:b)[r],s=v.getValueType(o),g(s),e.lastValues.push({binding:n,value:i,lastValue:m}),m!==i)if(f)if(a=s.setWillChange(o,d,i))u=s.set(o,d,i),h[r]=u,A(e,r,"Свойство "+n.fullPropName+" синхронизировано с полем контекста "+n.fieldName);else if(d.length>0)if(!(p=(c=s.get(o,d))===i||s.equals&&s.equals(c,i)))if(x.coreDebug.checkAssertion(c===P),null===o||void 0===o)if(y.initializeProperty(r),null!==(o=y.getProperty(r))&&void 0!==o)if(s=v.getValueType(o),g(s),a=s.setWillChange(o,d,i))u=s.set(o,d,i),h[r]=u,A(e,r,"Свойство "+n.fullPropName+" успешно инициализировано из значения null или undefined, и синхронизировано с полем контекста "+n.fieldName);else A(e,r,"Свойство "+n.fullPropName+" не синхронизируется, потому что не отличается от значения поля контекста "+n.fieldName);else A(e,r,"Свойство "+n.fullPropName+" не синхронизируется, поскольку его инициализация из null/undefined не прошла, "+"оно всё так же равно null или undefined, и в него невозможна запись по пути "+ +n.propPathStr,y,true);else A(e,r,"Свойство "+n.fullPropName+" не синхронизируется, потому что в его текущее значение невозможна запись по пути "+n.propPathStr,y,true);else A(e,r,"Свойство "+n.fullPropName+" не синхронизируется, потому что не отличается от значения поля контекста "+n.fieldName);else A(e,r,"Свойство "+n.fullPropName+" не синхронизируется, потому что не отличается от значения поля контекста "+n.fieldName);else if(d.length>0)if((l=s.remove(o,d)).changed)h[r]=l.value,A(e,r,"В свойстве "+n.propName+" значение по пути "+n.propPathStr+" удаляется, потому что в контексте нет соответствующего ему поля "+n.fieldName);else A(e,r,"В свойстве "+n.propName+" значение по пути "+n.propPathStr+" нужно удалить, поскольку в контексте нет соответствующего ему поля "+n.fieldName+", но удаление невозможно, поскольку значения в свойстве по этому пути нет, или типом значения не поддерживается удаление",y,true);else A(e,r,"Свойство "+n.propName+" нужно удалить, поскольку в контексте нет соответствующего ему поля "+n.fieldName+", но удаление невозможно, поскольку контрол не умеет удалять свойства (только под-свойства - значения внутри свойств)",y,true);else A(e,r,"В свойстве "+n.propName+" значение по пути "+n.propPathStr+" не синхронизируется, потому что при прошлой синхронизации соотв. ему поле контекста "+n.fieldName+" было таким же, как и в эту синхронизацию",y,true);if(t)N.forEach(function(e){if(e.commit)e.commit()}),N.length=0;return e},{value:{},comment:{},lastValues:[]});else e={value:{},comment:{},lastValues:[]};return e}function n(){if(!C.isDestroyed()&&!y.isDestroyed()){var s=function(e){try{return y.getProperty(e)}catch(e){b.error("Control",e.message)}},e;return this._reduceBindings(E,function(e,n){var t=s(n.propName),i,r=v.getValueType(t).get(t,n.propPath),o=n.lastValues[E];if(e.lastValues.push({binding:n,value:r,lastValue:o}),o!==r)if(r!==P&&r!==n.nonExistentValue)e.toSet[n.fieldName]=r,A(e,n.fieldName,"Поле контекста "+n.fieldName+" записывается, потому что соответствующее ему свойство "+n.fullPropName+" существует в свойствах контрола, и не равно параметру nonExistentValue");else if(e.toRemove.push(n.fieldName),r===P)A(e,n.fieldName,"Поле контекста "+n.fieldName+" удаляется, потому что соответствующее ему св-во контрола "+n.fullPropName+" не существует в свойствах контрола");else A(e,n.fieldName,"Поле контекста "+n.fieldName+" удаляется, потому что соответствующее ему св-во контрола "+n.fullPropName+" равно параметру nonExistentValue");else A(e,n.fieldName,"Поле контекста "+n.fieldName+" не меняется (не записывается и не удаляется), потому что при прошлой синхронизации значение соотв. (под)свойства контрола было таким же");return e},{toSet:{},toRemove:[],comment:{},lastValues:[]})}}function a(e){var n;t.call(u,e,e===E?o:r)}function l(e){if(e===E)return n.call(u);else if(e===B)return s.call(u)}var u=this,f,c,d;if(this._isBound)throw new Error("На этом экземпляре класса Core/ContextBinder bindControl уже был вызван (из метода createBoundControl, или bindControl). Второй раз bindControl вызывать нельзя.");if(this._isBound=true,this._bindings.length>0)if(f=t.bind(this,B,r),c=t.bind(this,E,o),d=function(){C.unsubscribe("onFieldsChanged",f),y.unsubscribe("onPropertiesChanged",c),u.unsubscribe("onDestroy",d),y.unsubscribe("onDestroy",d),C.unsubscribe("onDestroy",d),w(y,u,C)},C.subscribe("onFieldsChanged",f),y.subscribe("onPropertiesChanged",c),this.subscribe("onDestroy",d),y.subscribe("onDestroy",d),C.subscribe("onDestroy",d),S(y,this,C,a,l.bind(this),this.getConstructorOptions.bind(this,C)),"syncContext"===e)o.call(this);else if("syncControl"===e)r.call(this)},defineBinding:function(e,n,t,i,r,o){var s=e.split(c),a=s[0],l=s.slice(1),u=l.join(c),f={fieldName:n,propName:a,propPath:l,fullPropName:e,propPathStr:u,oneWay:t,direction:i||B,nonExistentValue:r,bindNonExistent:o,lastValues:{}};f.lastValues[B]=d,f.lastValues[E]=d,this._bindings.push(f)}});return F.createBoundControl=function(e,n,t,i){var r=new F({bindings:i}),o,s=new e(r.getConstructorOptions(t,e,l(n)));return r.bindControl(s,t),s},F.getBindingsForControl=function(n){return y(function(e){return e.control===n})},F.getBindingsForContext=function(n){return y(function(e){return e.context===n})},F.initBinderForControlConfig=function(e){return new F({bindings:e.bindings||[]})},F.setDebugMode=function(e){m=e},F});