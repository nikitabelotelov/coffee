define("Transport/XHRTransport",["Transport/ITransport","Core/Deferred","Core/EventBus","Core/UserInfo","Core/constants","Transport/Errors","Core/IoC","Core/detection","Transport/ajax-emulator"],function(r,l,t,e,n,d,i,o,s){var a,p=t.channel("Transport"),h=t.channel("errors");function T(e,n){if(a.isOfflineError(e)){var o;try{(o=JSON.parse(n).method.split(".")).push(e)}catch(r){o=[n,e]}return!!a.notifyOfflineError(o)}}var E=false;if("undefined"!==typeof window)if(o.firefox)window.addEventListener("beforeunload",function(){E=true,setTimeout(function(){E=false},600)});else window.addEventListener("unload",function(){E=true});if((a=r.extend({$protected:{_options:{method:"GET",dataType:"text",contentType:"application/x-www-form-urlencoded",url:"",async:true},_xhr:void 0},$constructor:function(){if(""===this._options.url)throw new Error("Request with no URL is ambiguous")},execute:function(a,r){var c=new l({cancelCallback:this.abort.bind(this)}),f=this;if(n.checkSessionCookie&&!e.isValid())return c.errback(d.ERROR_TEXT[401]),h.notify("onAuthError"),c;var u=this._options.url;try{this._xhr=s({type:this._options.method,dataType:this._options.dataType,contentType:this._options.contentType,url:u,headers:r||{},data:a,async:this._options.async,beforeSend:function(r,e){return p.notify("onBeforeSend",r,e)},success:function(r,e,n){if(T(r.error,a))return void c.errback(new d.Connection(u));var o=l.success(r);return p.notify("onResponseSuccess",n,o,f._options.url),c.dependOn(o),r},error:function(r,e){if(r.responseJSON&&T(r.responseJSON.error,a))return void c.errback(new d.Connection(u));if("abort"===e)return void c.cancel();var n=r.status,o=d.ERROR_TEXT[n]||d.ERROR_TEXT[e]||d.ERROR_TEXT.unknown||"";if(0===n&&""===r.getAllResponseHeaders()){var t="/"===f._options.url.charAt(0)?window.location.hostname:f._options.url;o=d.ERROR_TEXT.lossOfConnection+" "+t}var i=new d.HTTP(o,n,f._options.url,r.responseText);if(h.notify("onHTTPError",i),"401"==n)if(true===h.notify("onAuthError"))return;var s=new l;if(p.notify("onResponseError",f._xhr,s),s.addCallback(function(r){c.callback(r)}).addErrback(function(r){c.errback(r)}),E)s.cancel();else s.errback(i)}})}catch(r){c.errback("JavaScript exception while trying to execute request: "+r.message)}return c},setUrl:function(r){if("string"==typeof r)this._options.url=r},abort:function(){if(this._xhr)this._xhr.abort()}})).ERRORS_TEXT=d.ERROR_TEXT,a.isOfflineError=function(r){var e;return 300==(e=r&&(r.data&&r.data.error_code||r.httpError||r.code))||405==e},a.notifyOfflineError=function(r){var e,n,o;if(e=t.globalChannel(),n=["onOfflineModeError"].concat(r),o=e.notify.apply(e,n))i.resolve("ILogger").info("XHRTransport","Работа в offline-режиме");return o},a.getServiceByName=function(r){return n.services[r]||n.defaultServiceUrl},!i.has("ITransport"))i.bind("ITransport",a);return a});