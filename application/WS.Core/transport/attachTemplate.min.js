define("Transport/attachTemplate",["Core/constants","Core/cookie","Core/Deferred","Core/IoC","Core/Storage","Transport/nodeType","Transport/Templates/EmptyTemplate"],function(i,l,s,o,c,d){var e;function f(e){var t=$("#xmlContent");if(!t.length)t=$('<div id="xmlContent" style="display:none; visibility: hidden;"></div>'),$("body").append(t);if(!t.data(e))t.data(e,true),t.append('<div name="'+e+'">')}function p(r,n){function e(t){if(!n&&t instanceof Array)for(var e=0,a=t.length;e<a;e++)if(c.isStored("resfile://"+t[e])||e==a-1){t=t[e];break}var r="undefined"!==typeof document&&(l.get("s3rh")||l.get("rightshash"))||0;return c.store("resfile://"+t,function(e){e.dependOn(o.resolve("ITransport",{dataType:n?"text":"xml",url:function(){var e=t+(n?".fast.xml":".xml");if(r)e=e.replace(/(\.fast)?(\.v[0-9a-f]+)?(\.l[\S-]+)?(\.xml)$/,"$1.r"+r+"$2$3$4");return e}()}).execute(null))})}if(i.xmlPackages[r]&&!n)return(new s).dependOn(e(i.xmlPackages[r])).addCallback(function(e){for(var t=e.documentElement,a=t.childNodes.length-1;a>=0;--a){if(t.childNodes[a].nodeType!=d.ELEMENT_NODE)continue;if(t.childNodes[a].getAttribute("id")==r)return t.childNodes[a]}return new Error(r+" is not found in the package "+i.xmlPackages[r])});var t=r.charAt(0),a="";if("/"!==t&&"."!==t)if(r in i.xmlContents){if("/"!==(t=(r=i.xmlContents[r]).charAt(0)))a=i.resourceRoot}else a=i.wsRoot+"res/xml/";return e(a+r)}function t(n,e){var t,l=false,o="",r=new s;if(e&&"object"==typeof e)l=e.fast||false,o=e.html||"";else l=e,o=arguments[2];return c.store("res://"+n,function(r){function a(e,t,a){r.callback({transportTemplate:e,templateXML:t,template:t,templateName:a})}var e=["Deprecated","Lib"],t=n.indexOf("/")>0?n.split("/")[0]:false;if(e.indexOf(t)>-1||i.modules.hasOwnProperty(t)||"."!==n[0]&&-1===n.indexOf("SBIS3.")&&n.indexOf("/")>-1)require([n,"Transport/Templates/CompoundControlTemplate"],function(e,t){a(t,e,n)},function(e){r.errback(e)});else if(l&&o)a("Deprecated/Templates/FastTemplate",o,n);else if(n)p(n,l).addCallbacks(function(e){return a(l?"Deprecated/Templates/FastTemplate":"Deprecated/Templates/XMLTemplate",e,n),f(n),e},function(e){return r.errback(e),e});else a("Transport/Templates/EmptyTemplate","","")}).addCallbacks(function(e){var t=e.transportTemplate;if("string"==typeof t)t=require(t);var a=new t(e);return a.getRenderResult().addCallback(function(){r.callback(a)}).addErrback(function(e){r.errback(new Error("attachTemplate: "+e.message))}),e},function(e){return r.errback(e),e}),r}return{attachTemplate:t,loadTemplateFile:p}});