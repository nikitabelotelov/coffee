define("old-bootup",["require","Env/Env","Core/core-merge","SBIS3.CONTROLS/Utils/InformationPopupManager","Core/Context","Core/Deferred","Core/ParallelDeferred","Env/Event","Core/CommandDispatcher","Core/HashManager","Core/WindowManager","Browser/Transport","Deprecated/Record","Deprecated/RecordSet","Browser/TransportOld","Lib/Control/Control","bootup"],function(h,r,s,i,v,b,l,d,t,o,g,c,w,f,C,y,R){"use strict";var m={};function u(){$("#closePage").click(function(){window.onbeforeunload=function(){},window.close()})}function k(e){if($("body").toggleClass("ws-progress",false),e instanceof c.fetch.Errors.HTTP&&0!==e.httpError)i.showMessageDialog({status:"error",message:e.message});return r.IoC.resolve("ILogger").error("bootup",e&&e.message||e),e}function S(){if(r.detection.isMobileSafari)setTimeout(window.close,301);else window.close()}function B(e){t.declareCommand(e,"close",e.close?e.close:function(){S()})}function P(){return o.get("usedId")}function M(e){return o.set("usedId",e,true)}function p(e,t,o,r,n,a){var i=new C.ReportPrinter({columns:r,titleColumn:n}),s=a._eventBusChannel.notify("onSelectReportTransform",a.idR,e,t,a.list);i.prepareReport(e,s||t,o).addCallback(function(t){return y.ControlStorage.waitChildByName("ws-dataview-print-report").addCallback(function(e){e.subscribe("onContentSet",function(){$("body").toggleClass("ws-progress",false)}),e.setHTML(t)})}).addErrback(k)}function T(t){var e;if(t.idR&&!t.list){if(t.keys.length>0){var o=new l,r=[];e=new f(s({readerType:"ReaderUnifiedSBIS",firstRequest:false},t.dS));for(var n=0,a=t.keys.length;n<a;n++)o.push(e.readRecord(t.keys[n]).addCallback(function(e){r.push(e)}));o.done(),o.getResult().addCallback(function(){var e=t._eventBusChannel.notify("onPrepareReportData",t.idR,r);if(e instanceof b)e.addCallback(function(e){if(e instanceof w||e instanceof f||e instanceof Array)r=e;p(r,t.xsl,t.root,t.cols,t.tCol,t)}).addErrback(k);else{if(e instanceof w||e instanceof f||e instanceof Array)r=e;p(r,t.xsl,t.root,t.cols,t.tCol,t)}}).addErrback(k)}}else(e=new f(s({readerType:"ReaderUnifiedSBIS"},t.dS))).subscribe("onAfterLoad",function(){p(e,t.xsl,t.root,t.cols,t.tCol,t)})}function D(e,s,l,d,c,f){var u=void 0!==l&&l instanceof w,p="string"==typeof s?$("#"+s):s,t=p.attr("data-template-name")||"",o="true"==p.attr("hasMarkup");if(p.get(0).wsControl)return;if(o&&t&&t!==e)p.attr("hasMarkup","false"),o=false;if(u&&null!==l.getKey())M(l.getKey());C.attachTemplate.attachTemplate(e,{fast:o||r.constants.fasttemplate,html:o?p.get(0).outerHTML:""}).addCallback(function(t){var o=new b,r=v.createContext(o),n=B;if(f)T(d);if(u)r.setContextData(l),n=function(a){if(B(a),a.isNewRecord())a.subscribe("onRecordUpdate",function(e,t){if(void 0===P()&&null!==t)M(t)}),a.subscribe("onBeforeClose",function(e){if(!this.isRecordSaved())this.getRecord().destroy().addBoth(function(){if(false!==e.getResult())a.destroy(true)})});a.destroy=function(e){var t=g.getActiveWindow(),o=t&&t.getActiveChildControl();if(o)o.setActive(false,void 0,void 0,null);if(true===e||!(a.isNewRecord()&&!this.isRecordSaved()))if(!c){if(!d.history&&!!window.opener){var r=false;try{r=window.opener.wsConfig}catch(e){}if(r){try{var n=y.ControlStorage.get(d.id);if(!n.isReadOnly())n.reload()}catch(e){}return window.opener.focus(),void S()}}if(void 0===window.previousPageURL)S();else window.location.href=window.previousPageURL}else R(c)}};function a(){this.unsubscribe("onReady",a),m[e]&&m[e].callback()}if(p.empty(),t.isPage()){var i={template:t,horizontalAlignment:"Stretch",verticalAlignment:"Stretch",autoWidth:true,autoHeight:true,context:r,zIndex:0,element:s,newRecord:d&&(void 0===d.pk||true===d.copy),enabled:d&&void 0!==d.readOnly?!d.readOnly:true,page:true,reports:d&&d.reports||{},handlers:{onBeforeShowPrintReports:d?d._events["onBeforeShowPrintReports"]:[],onSelectReportTransform:d?d._events["onSelectReportTransform"]:[],onPrepareReportData:d?d._events["onPrepareReportData"]:[],onReady:a,onDestroy:function(){o.callback()}}};if(d&&d.readOnly)i.enable=false;h([d?"Deprecated/Controls/RecordArea/RecordArea":"Lib/Control/TemplatedArea/TemplatedArea"],function(e){n(new e(i))})}else h(["Lib/Control/Dialog/Dialog"],function(e){n(new e({context:r,template:t,enabled:d&&void 0!==d.readOnly?!d.readOnly:true,handlers:{onReady:a,onDestroy:function(){o.callback()}}}))})}).addErrback(k)}function a(n){var a=new l;for(var e in n._eventBusChannel=d.Bus.channel(),n._events){if(!n._events.hasOwnProperty(e))continue;for(var i=n._events[e],t=0,o=i.length;t<o;t++)(function(t,e){var o=i[e].split(":"),r=new b;h([o[0]],function(e){if(o[1])r.callback(e[o[1]]);else r.callback(e);a.push(r.addCallback(function(e){n._eventBusChannel.subscribe(t,e,n)}))})})(e,t)}return a.done().getResult()}function _(t,o){var e=P();if(void 0===o.pk&&void 0===e){var r=o.filter||{};if(o.hierMode)r[o.pIdCol]={hierarchy:[o.pId,o.branch?true:null]};var n=o._eventBusChannel.notify("onBeforeCreate",o.pId,o.branch?true:null,r);if(n instanceof b){var a=new b;return a.addErrback(function(e){return e}),n.addCallbacks(function(e){if(e instanceof w)a.callback(e);else{if(e&&"[object Object]"==Object.prototype.toString.call(e))r=s(e,r);if(!!o.id)r["ВызовИзБраузера"]=true;t.createRecord(r).addCallbacks(function(e){a.callback(e)},function(e){a.errback(e)})}},function(e){a.errback(e)}),a}else if(n instanceof w)return(new b).callback(n);else if(false===n)return(new b).callback(n);else{if(!!o.id)r["ВызовИзБраузера"]=true;return t.createRecord(r,o.format||o.obj+"."+o.method)}}else if(true===o.copy)return t.copyRecord(o.pk);else{var i=o._eventBusChannel.notify("onBeforeRead",o.pk||e);if(i instanceof b)return i;else if(i instanceof w)return(new b).callback(i);else if(false===i)return(new b).callback(i);else return t.readRecord(o.pk||e,o.format||o.obj+"."+o.method)}}function O(e,t,o,r,n){if(e instanceof w){if(n.changedRecordValues)for(var a in n.changedRecordValues)if(n.changedRecordValues.hasOwnProperty(a))e.set(a,n.changedRecordValues[a]);var i=n._eventBusChannel.notify("onBefore"+(void 0===n.pk?"Insert":"Update"),e);if(n.pk=n.pk?n.pk:P(),"boolean"!==typeof i)D("string"==typeof i?i:t,o,e,n,r);else if(void 0===n.pk&&false===i)e.destroy()}else if(e instanceof b)e.addCallback(function(e){O(e,t,o,r,n)});else u()}function E(o,r,n,a){var e;a.method=a.method||"Список",_(new f({readerType:a.type||"ReaderUnifiedSBIS",filterParams:a.filter||{},readerParams:{dbScheme:"",queryName:a.method,readMethodName:a.readMethod||"Прочитать",createMethodName:a.createMethod||"Создать",updateMethodName:a.updateMethod||"Записать",destroyMethodName:a.destroyMethod||"Удалить",linkedObject:a.obj,format:a.format},firstRequest:false,requiredParams:[],usePages:""}),a).addCallbacks(function(e){if(e&&a._events.hasOwnProperty("onBeforeShowRecord")){var t=a._eventBusChannel.notify("onBeforeShowRecord",e);if(void 0!==t)e=t}O(e,o,r,n,a)},function(e){var t=a.obj+".";if(void 0===a.pk)t+=a.createMethod||"Создать";else t+=a.readMethod||"Прочитать";if(e instanceof c.fetch.Errors.HTTP&&!e.processed&&0!==e.httpError&&true!==a._eventBusChannel.notify("onLoadError",e,t))i.showMessageDialog({status:"error",message:e.message}),$(".gt-loader-indicator").addClass("ws-hidden"),e.processed=true;u()})}return function(e,t,o,r){m[e]=r,t=t||"ctr";var n=v.global.getValue("editParams");if(void 0!==n)a(n=c.URL.deserializeData(n)).addCallback(function(){E(e,t,o,n)});else if(void 0!==(n=v.global.getValue("printParams")))a(n=c.URL.deserializeData(n)).addCallback(function(){D(e,t,void 0,n,void 0,true)});else D(e,t,void 0)}});