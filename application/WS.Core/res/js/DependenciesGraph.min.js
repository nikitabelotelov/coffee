(function(){"use strict";var f=requirejs("Env/Env").IoC.resolve("ILogger");function e(){this._nodes={},this._links={},this._path=[],this._n=0,this.smartNodes=[]}function d(e){if(e.indexOf("SBIS")>-1)return".";else return"/"}function o(e,t){for(var i=d(t),n=e.split(i),o=t.split(i),s=true,r=0;r<Math.min(n.length,o.length);r++){var h=n[r],f=o[r];if(-1==f.indexOf("!"))h=h.split("!").pop();if("*"!==f&&h!==f)s=false}return s}e.prototype._visitNode=function t(i,e,n){var o=this;if(this._path.length>=i)return;this._path.push(e);var s=this._nodes,r=this._links,h=s[e];if(!n&&o.firstLevelReached||n&&h&&o.firstLevelReached)delete o.firstLevelReached;if(n&&!h)o.smartNodes.push(e),s[e]=Object.create(null),h=s[e],o.firstLevelReached=true;if(h){if(h.mark>0){if(1==h.mark)f.log("WARNING! Cycle dependency detected: "+this._path.join(", "));return void this._path.pop()}h.mark=1,(o.firstLevelReached?[]:r[e]||[]).forEach(function(e){t.call(o,i,e,n)}),h.mark=2,h.weight=this._n++}else if(e&&e.indexOf("is!")>-1)s[e]={mark:2,weight:this._n++,path:""};else if(e&&e.indexOf("browser!")>-1)t.call(this,i,e.replace("browser!",""));this._path.pop()},e.prototype.getLoadOrder=function(e,t,i){var n=this;if(t=t||1/0,this._n=0,!e||!e.length)return[];return Object.keys(this._nodes).forEach(function(e){n._nodes[e].mark=0,n._nodes[e].weight=-1}),e.forEach(function(e){n._visitNode.call(n,t,e,i)}),Object.keys(this._nodes).map(function(e){var t=n._nodes[e];return t.module=e,t}).filter(function(e){return e.weight>=0}).sort(function(e,t){return e.weight-t.weight})},e.prototype.addDependencyFor=function(e,t){if(this.hasNode(e))this._links[e]=t},e.prototype.registerNode=function(e,t){this._nodes[e]=t},e.prototype.hasNode=function(e){return e in this._nodes},e.prototype.toJSON=function(){return JSON.stringify({nodes:this._nodes,links:this._links},null,2)},e.prototype.fromJSON=function(e){var t="string"==typeof e?JSON.parse(e):e;this._nodes=t.nodes,this._links=t.links},e.prototype.getDependenciesFor=function(e){if(this.hasNode(e))return(this._links[e]||[]).slice();else return[]},e.prototype.getNodes=function(){return Object.keys(this._nodes)},e.prototype.getNodeMeta=function(e){return this._nodes[e]||{}},e.prototype._deleteNodes=function(i,e){var t=this.getNodes(),n=this;t.forEach(function(t){e.forEach(function(e){if(-1==i.indexOf(t))if(e.indexOf("*")>-1){if(o(t,e))delete n._nodes[t]}else if(t==e)delete n._nodes[t]})})},e.prototype.getNodesToLoad=function(e,t){var i=this.getNodes(),n=[];return i.forEach(function(t){e.forEach(function(e){if(e.indexOf("*")>-1){if(o(t,e))n.push(t)}else if(t==e)n.push(t)})}),this._deleteNodes(n,t),n},module.exports=e})();