define("Types/_display/Ladder",["require","exports","tslib","Types/_display/Collection","Types/entity","Types/collection","Types/util","Types/shim"],function(t,e,o,i,l,_,a,f){"use strict";function r(t){if(t.getInstanceId instanceof Function)return t.getInstanceId();else if(t.getId instanceof Function)return t.getId();else if(t.get instanceof Function)return t.get("id");return t&&t.id}function p(t){return r(t.getContents())}Object.defineProperty(e,"__esModule",{value:true});var n=function(n){function t(t){var e=n.call(this)||this;if(e._collection=null,e._collectionItems=null,e._offset=0,e._converters=null,e._columnNames=[],e._column2primaryId=null,e._onCollectionChangeHandler=null,e._onAfterCollectionChangeHandler=null,e._onEventRaisingChangeHandler=null,l.SerializableMixin.constructor.call(e),e._onCollectionChangeHandler=e._onCollectionChange.bind(e),e._onAfterCollectionChangeHandler=e._onAfterCollectionChange.bind(e),e._onEventRaisingChangeHandler=e._onEventRaisingChange.bind(e),t)e.setCollection(t);else e.reset();return e}return o.__extends(t,n),t.prototype.destroy=function(){this.setCollection(null),n.prototype.destroy.call(this)},t.prototype._getSerializableState=function(t){if(t=l.SerializableMixin.prototype._getSerializableState.call(this,t),this._collection)t.$options=this._collection;else delete t.$options;if(this._offset)t._offset=this._offset;if(this._columnNames.length)t._columnNames=this._columnNames;return t},t.prototype._setSerializableState=function(t){var e=l.SerializableMixin.prototype._setSerializableState(t);return function(){if(e.call(this),t._offset)this._offset=t._offset;if(t._columnNames)if(this._columnNames=t._columnNames,this._collection)this._checkRange(0,this._collectionItems.length)}},t.prototype.getCollection=function(){return this._collection},t.prototype.setCollection=function(t){if(null!==t&&!(t instanceof i.default))throw new TypeError('Argument "collection" should be an instance of Types/_display/Collection');var e=t!==this._collection;if(this._collection&&!this._collection.destroyed)this._collection.unsubscribe("onCollectionChange",this._onCollectionChangeHandler),this._collection.unsubscribe("onAfterCollectionChange",this._onAfterCollectionChangeHandler),this._collection.unsubscribe("onEventRaisingChange",this._onEventRaisingChangeHandler);if(t&&!t.destroyed)t.subscribe("onCollectionChange",this._onCollectionChangeHandler),t.subscribe("onAfterCollectionChange",this._onAfterCollectionChangeHandler),t.subscribe("onEventRaisingChange",this._onEventRaisingChangeHandler);if(this._collection=t,e)this._applyCollection(),this._columnNames=[],this.reset()},t.prototype.setOffset=function(t){t=parseInt(t,10);var e=this._offset;this._offset=t;var n=this._checkRange(this._offset,2);if(this._notifyPrimaryChanges(n),Math.abs(e-t)>1)n=this._checkRange(e,1),this._notifyPrimaryChanges(n)},t.prototype.reset=function(){this._column2primaryId=new f.Map},t.prototype.setConverter=function(t,e){this._converters=this._converters||{},this._converters[t]=e},t.prototype.get=function(t,e){return this.isPrimary(t,e)?a.object.getPropertyValue(t,e):""},t.prototype.isPrimary=function(t,e){if(!this._collection)return true;this._applyColumn(e);var n=r(t),o=this._getColumnData(e),i=o.has(n),l=i?o.get(n):void 0,s=this._collection.getIndexBySourceItem(t);if(!i||l[1]!==s)this._checkRange(s,1,true),l=(i=o.has(n))?o.get(n):void 0;return i?!!l[0]:true},t.prototype.isLadderColumn=function(t){return this._column2primaryId.has(t)},t.prototype._applyCollection=function(){if(!this._collection)return void(this._collectionItems=null);var e=this._collectionItems=[];this._collection.each(function(t){e.push(t)})},t.prototype._spliceCollection=function(t,e,n){var o;if(!this._collectionItems)return;(o=this._collectionItems).splice.apply(o,[t,e].concat(n))},t.prototype._applyColumn=function(t){var e=this._columnNames;if(e.indexOf(t)>-1)return;e.push(t)},t.prototype._getColumnData=function(t){var e=this._column2primaryId;if(e.has(t))return e.get(t);var n=new f.Map;return e.set(t,n),n},t.prototype._onCollectionChange=function(t,e,n,o,i,l){var c=this,s=Array.prototype.push,r=[],a=function(t,e){if(t.length){var n=c._columnNames,o=new f.Set,i=void 0,l=void 0,s=void 0,r=void 0;for(e.forEach(function(t){o.add(p(t))}),i=0;i<n.length;i++)for(l=c._getColumnData(n[i]),s=0;s<t.length;++s)if(r=p(t[s]),!o.has(r))l.delete(r)}},h=function(t,e,n){return e>0?c._checkRange(n-1,t.length+2):[]};switch(e){case _.IObservable.ACTION_ADD:this._spliceCollection(o,0,n),s.apply(r,h(n,n.length,o));break;case _.IObservable.ACTION_REMOVE:this._spliceCollection(l,i.length,[]),a(i,n),s.apply(r,h([],i.length,l));break;case _.IObservable.ACTION_CHANGE:r=this._checkRange(o-1,3);break;case _.IObservable.ACTION_MOVE:this._spliceCollection(l,i.length,[]),this._spliceCollection(o,0,n);var u=o>l?l:l+n.length;s.apply(r,h([],i.length,u)),s.apply(r,h(n,n.length,o));break;default:if(this._applyCollection(),e===_.IObservable.ACTION_RESET&&this._collectionItems&&this._collectionItems.length!==n.length)n=this._collectionItems;a(i,n),s.apply(r,h(n,n.length,o))}this._notifyPrimaryChanges(r)},t.prototype._onEventRaisingChange=function(t,e,n){if(e&&!n)this._applyCollection()},t.prototype._onAfterCollectionChange=function(){if(this._collectionItems&&this._collection.getCount()!==this._collectionItems.length)this._applyCollection()},t.prototype._notifyPrimaryChanges=function(t){var n=this,e=this._collection,o=this._collectionItems,i,l,s,r=t.reduce(function(t,e){if(null!==e)i=e[0],l=e[1],s=o[i],t[i]=t[i]||{},t[i][l]=n.get(s.getContents(),l);return t},{});for(i in r)if(r.hasOwnProperty(i))e.notifyItemChange(o[i],{contents:r[i]})},t.prototype._checkRange=function(t,e,n){var o=[],i=this._collection,l=this._collectionItems,s=this._columnNames,r,c,a,h=Math.min(t+e,n?i.getCount():l.length);for(t=Math.max(0,t),r=0;r<s.length;r++)for(c=t;c<h;++c)if(null!==(a=this._adjustPrimary(c,n?i.at(c):l[c],s[r],n)))o.push(a);return o},t.prototype._adjustPrimary=function(t,e,n,o){if(!e)return null;var i=p(e),l,s,r;if(void 0!==i)if(l=this._getColumnData(n),(s=this._isPrimaryIndex(t,n,o))!==(r=(r=l.get(i))?r[0]:r))return l.set(i,[s,t]),[t,n];return null},t.prototype._isPrimaryIndex=function(t,e,n){if(0===t||t===this._offset)return true;var o=this._collection,i=this._collectionItems,l=(n?o.at(t-1):i[t-1]).getContents(),s=(n?o.at(t):i[t]).getContents(),r=a.object.getPropertyValue(l,e),c=a.object.getPropertyValue(s,e);if(this._converters&&this._converters.hasOwnProperty(e))r=this._converters[e](r,l),c=this._converters[e](c,s);if(r instanceof Object&&c instanceof Object)r=r.valueOf(),c=c.valueOf();return r!==c},t}(a.mixin(l.DestroyableMixin,l.SerializableMixin));(e.default=n).prototype._moduleName="Types/display:Ladder",n.prototype["[Types/_display/Ladder]"]=true});