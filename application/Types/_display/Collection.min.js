define("Types/_display/Collection",["require","exports","tslib","Types/_display/IBind","Types/_display/Abstract","Types/_display/CollectionEnumerator","Types/_display/CollectionItem","Types/_display/GroupItem","Types/_display/itemsStrategy/Composer","Types/_display/itemsStrategy/Direct","Types/_display/itemsStrategy/User","Types/_display/itemsStrategy/Group","Types/entity","Types/collection","Types/di","Types/util","Types/shim"],function(t,e,o,_,i,n,s,v,a,l,u,h,p,c,f,y,S){"use strict";Object.defineProperty(e,"__esModule",{value:true});var r,g=(0,eval)("this").console,d="The Display is read only. You should modify the source collection instead.";function m(t){var e=[];return t.each(function(t){e.push(t)}),e}function C(t){if("function"===typeof t)t=[t];return t instanceof Array?t.filter(function(t){return"function"===typeof t}):[]}function I(t,e,i,r,o,n){var s;switch(e){case _.default.ACTION_RESET:var a=m(this),l=void 0;return this._reBuild(true),l=m(this),this._notifyBeforeCollectionChange(),this._notifyCollectionChange(e,l,0,a,0),void this._notifyAfterCollectionChange();case _.default.ACTION_CHANGE:return s=this._startUpdateSession(),this._reGroup(r,i.length),this._reSort(),this._reFilter(),this._finishUpdateSession(s,false),void this._notifyCollectionItemsChange(i,r,s)}switch(s=this._startUpdateSession(),e){case _.default.ACTION_ADD:this._addItems(r,i),this._reGroup(r,i.length),this._reSort(),this._reFilter();break;case _.default.ACTION_REMOVE:if(this._removeItems(n,o.length),this._reSort(),this._isFiltered()&&this._isFilteredByIndex())this._reFilter();break;case _.default.ACTION_REPLACE:this._replaceItems(r,i),this._reGroup(r,i.length),this._reSort(),this._reFilter();break;case _.default.ACTION_MOVE:this._moveItems(r,n,i),this._reSort(),this._reFilter()}this._finishUpdateSession(s)}function E(t,e,i,r){if(!this.isEventRaising())return;if(this._sourceCollectionSynchronized)this._notifySourceCollectionItemChange(t,e,i,r);else this._sourceCollectionDelayedCallbacks=this._sourceCollectionDelayedCallbacks||[],this._sourceCollectionDelayedCallbacks.push([this._notifySourceCollectionItemChange,arguments])}function x(t,e,i){if(!i&&e)this._reBuild(true);this._sourceCollectionSynchronized=e;var r=this._sourceCollectionDelayedCallbacks;if(this._sourceCollectionSynchronized&&r){var o=void 0;while(r.length>0)(o=r[0])[0].apply(this,o[1]),r.shift()}}var $=function(i){function r(t){var e=i.call(this,t)||this;if(e["[Types/_collection/IEnumerable]"]=true,e["[Types/_collection/IList]"]=true,e._itemToUid=new S.Map,e._itemsUid=new S.Set,e._filterMap=[],e._sortMap=[],p.SerializableMixin.constructor.call(e),c.EventRaisingMixin.constructor.call(e,t),e._$filter=e._$filter||[],e._$sort=e._$sort||[],e._$importantItemProperties=e._$importantItemProperties||[],!e._$collection)throw new Error(e._moduleName+": source collection is empty");if(e._$collection instanceof Array)e._$collection=f.create("Types/collection:List",{items:e._$collection});if(!e._$collection["[Types/_collection/IEnumerable]"])throw new TypeError(e._moduleName+": source collection should implement Types/collection:IEnumerable");if(e._$sort=C(e._$sort),e._$filter=C(e._$filter),e._$idProperty)e._setImportantProperty(e._$idProperty);if(e._publish("onCurrentChange","onCollectionChange","onBeforeCollectionChange","onAfterCollectionChange"),e._switchImportantPropertiesByUserSort(true),e._switchImportantPropertiesByGroup(true),e._reBuild(),e._bindHandlers(),e._$collection["[Types/_collection/IObservable]"])e._$collection.subscribe("onCollectionChange",e._onCollectionChange),e._$collection.subscribe("onCollectionItemChange",e._onCollectionItemChange);if(e._$collection["[Types/_entity/EventRaisingMixin]"])e._$collection.subscribe("onEventRaisingChange",e._oEventRaisingChange);return e}return o.__extends(r,i),Object.defineProperty(r.prototype,"localize",{get:function(){return this._localize},enumerable:true,configurable:true}),r._functorToImportantProperties=function(t,e,i){if(p.functor.Compute.isFunctor(t))for(var r=t.properties,o=0;o<r.length;o++)if(i)e._setImportantProperty(r[o]);else e._unsetImportantProperty(r[o])},r.prototype.destroy=function(){if(!this._$collection.destroyed){if(this._$collection["[Types/_collection/IObservable]"])this._$collection.unsubscribe("onCollectionChange",this._onCollectionChange),this._$collection.unsubscribe("onCollectionItemChange",this._onCollectionItemChange);if(this._$collection["[Types/_entity/EventRaisingMixin]"])this._$collection.unsubscribe("onEventRaisingChange",this._oEventRaisingChange)}this._unbindHandlers(),this._composer=null,this._filterMap=[],this._sortMap=[],this._itemToUid=null,this._itemsUid=null,this._cursorEnumerator=null,this._utilityEnumerator=null,i.prototype.destroy.call(this)},r.prototype.getByInstanceId=function(t){return this.at(this._getUtilityEnumerator().getIndexByValue("instanceId",t))},r.prototype.getIndexByInstanceId=function(t){return this._getUtilityEnumerator().getIndexByValue("instanceId",t)},r.prototype.getEnumerator=function(t){return this._getEnumerator()},r.prototype.each=function(t,e){var i=this.getEnumerator(),r;while(i.moveNext())r=i.getCurrentIndex(),t.call(e,i.getCurrent(),r)},r.prototype.assign=function(){throw new Error(d)},r.prototype.append=function(){throw new Error(d)},r.prototype.prepend=function(){throw new Error(d)},r.prototype.clear=function(){throw new Error(d)},r.prototype.add=function(){throw new Error(d)},r.prototype.at=function(t){return this._getUtilityEnumerator().at(t)},r.prototype.remove=function(){throw new Error(d)},r.prototype.removeAt=function(){throw new Error(d)},r.prototype.replace=function(){throw new Error(d)},r.prototype.move=function(){throw new Error(d)},r.prototype.getIndex=function(t){if(!(t instanceof s.default))return-1;return this.getIndexByInstanceId(t.getInstanceId())},r.prototype.getCount=function(t){var e=0;if(t&&this._isGrouped())this.each(function(t){if(!(t instanceof v.default))e++});else e=this._getUtilityEnumerator().getCount();return e},r.prototype.getCollection=function(){return this._$collection},r.prototype.getCollectionCount=function(){var t=this.getCollection();if(t["[Types/_collection/IList]"])return t.getCount();var e=t.getEnumerator(),i=0;e.reset();while(e.moveNext())i++;return i},r.prototype.getItems=function(){return this._getItems().slice()},r.prototype.createItem=function(t){if(!this._itemsFactory)this._itemsFactory=this._getItemsFactory().bind(this);return this._itemsFactory(t)},r.prototype.getItemUid=function(t){var e=this._itemToUid;if(e.has(t))return e.get(t);var i=this._exctractItemId(t);return i=this._searchItemUid(t,i),e.set(t,i),i},r.prototype.getCurrent=function(){return this._getCursorEnumerator().getCurrent()},r.prototype.setCurrent=function(t,e){var i=this.getCurrent();if(i!==t){var r=this._getCursorEnumerator(),o=this.getCurrentPosition();if(r.setCurrent(t),!e)this._notifyCurrentChange(this.getCurrent(),i,r.getPosition(),o)}},r.prototype.getCurrentPosition=function(){return this._getCursorEnumerator().getPosition()},r.prototype.setCurrentPosition=function(t,e){var i=this.getCurrentPosition();if(t!==i){var r=this.getCurrent();if(this._getCursorEnumerator().setPosition(t),!e)this._notifyCurrentChange(this.getCurrent(),r,t,i)}},r.prototype.getFirst=function(){var t=this._getUtilityEnumerator();t.setPosition(0);var e=t.getCurrent();if(e instanceof v.default)return this._getNearbyItem(t,e,true,true);return e},r.prototype.getLast=function(){var t=this._getUtilityEnumerator(),e=t.getCount()-1;t.setPosition(e);var i=t.getCurrent();if(i instanceof v.default)return this._getNearbyItem(t,void 0,false,true);return i},r.prototype.getNext=function(t){return this._getNearbyItem(this._getUtilityEnumerator(),t,true,true)},r.prototype.getPrevious=function(t){return this._getNearbyItem(this._getUtilityEnumerator(),t,false,true)},r.prototype.moveToNext=function(){var t=this.getCurrent(),e=this.getCurrentPosition(),i=this._getCursorEnumerator().moveNext();if(i)this._notifyCurrentChange(this.getCurrent(),t,this.getCurrentPosition(),e);return i},r.prototype.moveToPrevious=function(){var t=this.getCurrent(),e=this.getCurrentPosition(),i=this._getCursorEnumerator().movePrevious();if(i)this._notifyCurrentChange(this.getCurrent(),t,this.getCurrentPosition(),e);return i},r.prototype.moveToFirst=function(){if(0===this.getCurrentPosition())return false;return this.setCurrentPosition(0),0===this._getCursorEnumerator().getPosition()},r.prototype.moveToLast=function(){var t=this.getCount()-1;if(this.getCurrentPosition()===t)return false;return this.setCurrentPosition(t),this.getCurrentPosition()===t},r.prototype.getSourceIndexByIndex=function(t){var e=this._getUtilityEnumerator().getSourceByInternal(t);return e=void 0===e||null===e?-1:e,this._getSourceIndex(e)},r.prototype.getSourceIndexByItem=function(t){var e=this.getIndex(t);return-1===e?-1:this.getSourceIndexByIndex(e)},r.prototype.getIndexBySourceIndex=function(t){t=this._getItemIndex(t);var e=this._getUtilityEnumerator().getInternalBySource(t);return void 0===e||null===e?-1:e},r.prototype.getIndexBySourceItem=function(e){var t=this.getCollection(),i=-1;if(t&&t["[Types/_collection/IList]"])i=t.getIndex(e);else{var r=0;t.each(function(t){if(-1===i&&t===e)i=r;r++},this,this._localize)}return-1===i?-1:this.getIndexBySourceIndex(i)},r.prototype.getItemBySourceIndex=function(t){return-1===(t=this.getIndexBySourceIndex(t))?void 0:this.at(t)},r.prototype.getItemBySourceItem=function(t){var e=this.getIndexBySourceItem(t);return-1===e?void 0:this.at(e)},r.prototype.getFilter=function(){return this._$filter.slice()},r.prototype.setFilter=function(){for(var t=[],e=0,i;e<arguments.length;e++)t[e]=arguments[e];if(t[0]instanceof Array)i=t[0];else i=t;if(this._$filter.length===i.length){for(var r=false,o=0;o<i.length;o++)if(this._$filter[o]!==i[o]){r=true;break}if(!r)return}this._$filter=i.filter(function(t){return"function"===typeof t});var n=this._startUpdateSession();this._reFilter(),this._finishUpdateSession(n)},r.prototype.addFilter=function(t,e){if(this._$filter.indexOf(t)>-1)return;if(void 0===e)this._$filter.push(t);else this._$filter.splice(e,0,t);var i=this._startUpdateSession();this._reFilter(),this._finishUpdateSession(i)},r.prototype.removeFilter=function(t){var e=this._$filter.indexOf(t);if(-1===e)return false;this._$filter.splice(e,1);var i=this._startUpdateSession();return this._reFilter(),this._finishUpdateSession(i),true},r.prototype.getGroup=function(){return this._$group},r.prototype.setGroup=function(t){if(this._$group===t)return;if(this._switchImportantPropertiesByGroup(false),!this._composer)return this._$group=t,void this._switchImportantPropertiesByGroup(true);var e=this._startUpdateSession(),i=this._composer.getInstance(h.default);this._$group=i.handler=t,this._switchImportantPropertiesByGroup(true),this._getItemsStrategy().invalidate(),this._reSort(),this._reFilter(),this._finishUpdateSession(e)},r.prototype.getGroupItems=function(e){var i=[],r;return this.each(function(t){if(t instanceof v.default)return void(r=t.getContents());if(r===e)i.push(t)}),i},r.prototype.getGroupByIndex=function(t){var e,i=this.getEnumerator(),r,o=0;while(i.moveNext()){if((r=i.getCurrent())instanceof v.default)e=r.getContents();if(o===t)break;o++}return e},r.prototype.getSort=function(){return this._$sort.slice()},r.prototype.setSort=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=this._startUpdateSession(),r=t[0]instanceof Array?t[0]:t;if(this._$sort.length===r.length){for(var o=false,n=0;n<r.length;n++)if(this._$sort[n]!==r[n]){o=true;break}if(!o)return}if(this._switchImportantPropertiesByUserSort(false),this._$sort.length=0,this._$sort.push.apply(this._$sort,C(r)),this._switchImportantPropertiesByUserSort(true),this._getItemsStrategy().invalidate(),this._reSort(),this._isFiltered())this._reFilter();this._finishUpdateSession(i)},r.prototype.addSort=function(t,e){if(this._$sort.indexOf(t)>-1)return;var i=this._startUpdateSession();if(this._switchImportantPropertiesByUserSort(false),void 0===e)this._$sort.push(t);else this._$sort.splice(e,0,t);if(this._switchImportantPropertiesByUserSort(true),this._getItemsStrategy().invalidate(),this._reSort(),this._isFiltered())this._reFilter();this._finishUpdateSession(i)},r.prototype.removeSort=function(t){var e=this._$sort.indexOf(t);if(-1===e)return false;var i=this._startUpdateSession();if(this._switchImportantPropertiesByUserSort(false),this._$sort.splice(e,1),this._switchImportantPropertiesByUserSort(true),this._getItemsStrategy().invalidate(),this._reSort(),this._isFiltered())this._reFilter();return this._finishUpdateSession(i),true},r.prototype.getIdProperty=function(){return this._$idProperty},r.prototype.isUnique=function(){return this._$unique},r.prototype.setUnique=function(t){if(this._$unique===t)return;var e=this._startUpdateSession();this._$unique=t,this._composer.getInstance(l.default).unique=t,this._getItemsStrategy().invalidate(),this._reSort(),this._finishUpdateSession(e)},r.prototype.notifyItemChange=function(t,e){var i=this._isFiltered(),r=this._isGrouped();if(i||r){var o=this._startUpdateSession();if(r)this._reGroup(),this._reSort();if(i)this._reFilter();this._finishUpdateSession(o)}if(!this.isEventRaising())return;var n=this.getIndex(t),s=[t];s.properties=e,this._notifyBeforeCollectionChange(),this._notifyCollectionChange(_.default.ACTION_CHANGE,s,n,s,n),this._notifyAfterCollectionChange()},r.prototype.getSelectedItems=function(){for(var t=this._getItems(),e=[],i=t.length-1;i>=0;i--)if(t[i].isSelected())e.push(t[i]);return e},r.prototype.setSelectedItems=function(t,e){for(var i=[],r=0,o=t.length;r<o;r++)i.push(this.getItemBySourceItem(t[r]));this._setSelectedItems(i,e)},r.prototype.setSelectedItemsAll=function(t){this._setSelectedItems(this._getItems(),t)},r.prototype.invertSelectedItemsAll=function(){for(var t=this._getItems(),e=t.length-1;e>=0;e--)t[e].setSelected(!t[e].isSelected(),true);this._notifyBeforeCollectionChange(),this._notifyCollectionChange(_.default.ACTION_RESET,t,0,t,0),this._notifyAfterCollectionChange()},r.prototype._getSerializableState=function(t){return(t=p.SerializableMixin.prototype._getSerializableState.call(this,t))._composer=this._composer,t},r.prototype._setSerializableState=function(o){var n=p.SerializableMixin.prototype._setSerializableState(o);return function(){if(n.call(this),this._composer=o._composer,this._composer){var t=this._composer.getInstance(u.default);if(t)t.handlers=this._$sort;var e=this._composer.getInstance(h.default);if(e)e.handler=this._$group;if(this._composer){var i=function(t,e){t.forEach(function(t){if(void 0!==t._contentsIndex)t._$owner=e,t.getContents()})};try{var r=this._composer.getResult();do{if(r._items)i(r._items,this);r=r.source}while(r)}catch(t){if(void 0!==typeof g)g.error(t)}}}}},r.prototype._exctractItemId=function(t){var e=t.getContents(),i;if(e["[Types/_entity/Model]"])i=e.getId();else if(this._$idProperty)i=y.object.getPropertyValue(e,this._$idProperty);else throw new Error('Option "idProperty" must be defined to extract item unique id.');return String(i)},r.prototype._searchItemUid=function(t,e){var i=e,r=this._itemsUid,o=0;while(r.has(i))i=e.concat("-",String(++o));return r.add(i),i},r.prototype._analizeUpdateSession=function(t){if(t)this._notifyBeforeCollectionChange();if(c.EventRaisingMixin._analizeUpdateSession.call(this,t),t)this._notifyAfterCollectionChange()},r.prototype._notifyCollectionChange=function(i,r,o,n,s,t){var a=this;if(!this._isNeedNotifyCollectionChange())return;if(!t||i===_.default.ACTION_RESET||!this._isGrouped())return void this._notifyLater("onCollectionChange",i,r,o,n,s);for(var e=function(t,e){if(t<e)a._notifyLater("onCollectionChange",i,r.slice(t,e),r.length?o+t:0,n.slice(t,e),n.length?s+t:0)},l=i===_.default.ACTION_REMOVE,u=l?n.length:r.length,h=0,p,c=0;c<u;c++){if((p=l?n[c]:r[c])instanceof v.default)e(h,c),h=c;if(c===u-1)e(h,c+1)}},r.prototype._setSelectedItems=function(t,e){var i=[];e=!!e;for(var r=t.length-1;r>=0;r--)if(t[r].isSelected()!==e)t[r].setSelected(e,true),i.push(t[r]);if(i.length>0){var o=this.getIndex(i[0]);this._notifyBeforeCollectionChange(),this._notifyCollectionChange(_.default.ACTION_REPLACE,i,o,i,o),this._notifyAfterCollectionChange()}},r.prototype._setImportantProperty=function(t){var e;if(-1===this._$importantItemProperties.indexOf(t))this._$importantItemProperties.push(t)},r.prototype._unsetImportantProperty=function(t){var e=this._$importantItemProperties.indexOf(t);if(-1!==e)this._$importantItemProperties.splice(e,1)},r.prototype._switchImportantPropertiesByUserSort=function(t){for(var e=0;e<this._$sort.length;e++)r._functorToImportantProperties(this._$sort[e],this,t)},r.prototype._switchImportantPropertiesByGroup=function(t){r._functorToImportantProperties(this._$group,this,t)},r.prototype._bindHandlers=function(){this._onCollectionChange=I.bind(this),this._onCollectionItemChange=E.bind(this),this._oEventRaisingChange=x.bind(this)},r.prototype._unbindHandlers=function(){this._onCollectionChange=null,this._onCollectionItemChange=null,this._oEventRaisingChange=null},r.prototype._getItems=function(){return this._getItemsStrategy().items},r.prototype._getItemsFactory=function(){return function t(e){return e.owner=this,f.resolve(this._itemModule,e)}},r.prototype._getItemsStrategy=function(){if(!this._composer)this._composer=this._createComposer();return this._composer.getResult()},r.prototype._resetItemsStrategy=function(){this._composer=null},r.prototype._createComposer=function(){var t=new a.default;return t.append(l.default,{display:this,localize:this._localize,idProperty:this._$idProperty,unique:this._$unique}).append(u.default,{handlers:this._$sort}).append(h.default,{handler:this._$group}),t},r.prototype._getEnumerator=function(t){return this._buildEnumerator(t?this._getItems().slice():this._getItems.bind(this),t?this._filterMap.slice():this._filterMap,t?this._sortMap.slice():this._sortMap)},r.prototype._buildEnumerator=function(t,e,i){return new n.default({items:t,filterMap:e,sortMap:i})},r.prototype._getCursorEnumerator=function(){return this._cursorEnumerator||(this._cursorEnumerator=this._getEnumerator())},r.prototype._getUtilityEnumerator=function(){return this._utilityEnumerator||(this._utilityEnumerator=this._getEnumerator())},r.prototype._getNearbyItem=function(t,e,i,r){var o=i?"moveNext":"movePrevious",n;t.setCurrent(e);while(t[o]()){if(n=t.getCurrent(),r&&n instanceof v.default){n=void 0;continue}break}return n},r.prototype._getItemIndex=function(t){return this._getItemsStrategy().getDisplayIndex(t)},r.prototype._getSourceIndex=function(t){return this._getItemsStrategy().getCollectionIndex(t)},r.prototype._reBuild=function(t){var e=this._getItemsStrategy();if(this._reIndex(),t)e.reset();if(this._reGroup(),this._reSort(),this._resetFilter(e.count),this._isFiltered())this._reFilter()},r.prototype._reAnalize=function(t,e){t=t||0;var i=this._getItemsStrategy(),r=this._startUpdateSession(),o=i.getDisplayIndex(t);i.invalidate();var n=i.getDisplayIndex(t);if(void 0===e)e=i.count-n;if(this._reGroup(t,e),this._reSort(),o!==n||this._isFilteredByIndex())this._reFilter();else this._reFilter(n,e);this._finishUpdateSession(r)},r.prototype._reIndex=function(){this._getCursorEnumerator().reIndex(),this._getUtilityEnumerator().reIndex()},r.prototype._resetFilter=function(t){for(var e=this._filterMap.length=0;e<t;e++)this._filterMap.push(true);this._reIndex()},r.prototype._reFilter=function(t,e){t=t||0,e=e||this._getItemsStrategy().count-t;var a=this._$filter,l=a.length,i=this._getItems(),r=this._sortMap,o=r.length,n=this._filterMap,s=new S.Set,u=t+e,h=false,p,c,_,f,y=-1,g=-1,d=false,m,C=function(t,e,i,r){for(var o=true,n,s=0;s<l;s++)if(!(o=(n=a[s])(t.getContents(),e,t,i,r)))break;return o},I=function(t,e){var i=n[e];if(t===i)return false;if(t)return n[e]=t,true;else if(void 0!==i)return n[e]=t,true;return false};for(c=0;c<o;c++){if(void 0===(_=r[c])||_<t||_>=u)continue;if(s.add(_),m=true,(p=i[_])instanceof v.default){if(f)h=I(m=C(f,y,g,d),y)||h;f=p,y=_,g=c,d=false}else if(h=I(m=C(p,_,c),_)||h,m)d=true}for(_=t;_<u;_++)if(!s.has(_))n[_]=void 0;if(f)h=I(m=C(f,y,g,d),y)||h;if(h)this._reIndex()},r.prototype._reSort=function(){var t;this._sortMap.length=0;var e=this._buildSortMap();(t=this._sortMap).push.apply(t,e),this._reIndex()},r.prototype._buildSortMap=function(){return this._getItems().map(function(t,e){return e})},r.prototype._reGroup=function(t,e){if(!this._composer)return;var i;this._composer.getInstance(h.default).invalidate()},r.prototype._isFiltered=function(){return this._$filter.length>0},r.prototype._isFilteredByIndex=function(){var e=this;return this._$filter.some(function(t){return e._isFilterUseIndex(t)})},r.prototype._isFilterUseIndex=function(t){return t.length>3},r.prototype._isGrouped=function(){return!!this._$group},r.prototype._addItems=function(t,e){var i,r,o=this._isFiltered(),n=this._getItemsStrategy(),s,a=[],l=[],u=[];return n.splice(t,0,e),s=n.getDisplayIndex(t),e.forEach(function(t,e){a.push(!o),l.push(s+e),u.push(void 0)}),(i=this._filterMap).splice.apply(i,[s,0].concat(a)),(r=this._sortMap).splice.apply(r,[s,0].concat(l)),s},r.prototype._removeItems=function(t,e){t=t||0;var i=this._getItemsStrategy(),r,o;return e=void 0===e?i.count-t:e,r=(o=i.splice(t,e)).start=i.getDisplayIndex(t),this._filterMap.splice(r,e),this._removeFromSortMap(r,e),o},r.prototype._replaceItems=function(t,e){var i=this._getItemsStrategy(),r=i.splice(t,e.length,e);return r.start=i.getDisplayIndex(t),r},r.prototype._moveItems=function(t,e,i){var r=i.length,o=this._getItemsStrategy(),n;return n=o.splice(e,r),o.splice(t,0,n),n.oldIndex=o.getDisplayIndex(e),n},r.prototype._removeFromSortMap=function(t,e){var i=(t=t||0)+(e=e||0),r,o,n=[],s={};for(r=t;r<i;r++)if((o=this._sortMap.indexOf(r))>-1)n.push(o),s[o]=this._sortMap[o];for(n.sort(function(t,e){return t-e}),r=n.length-1;r>=0;r--)this._sortMap.splice(n[r],1);for(r=0;r<this._sortMap.length;r++)if(this._sortMap[r]>=t)this._sortMap[r]-=e;return this._reIndex(),s},r.prototype._getItemState=function(t){return{item:t,selected:t.isSelected()}},r.prototype._getItemsState=function(t){return t.map(this._getItemState)},r.prototype._getItemsDiff=function(r,t){return t.filter(function(e,t){var i=r[t];return Object.keys(e).some(function(t){return e[t]!==i[t]})}).map(function(t){return t.item})},r.prototype._checkItemsDiff=function(i,t,e,r){var o=this,n=e?this._getItemsDiff(e,this._getItemsState(t)):[];if(r)r(n,t);if(n.length)this._notifyBeforeCollectionChange(),c.EventRaisingMixin._extractPacksByList(this,n,function(t,e){o._notifyCollectionChange(_.default.ACTION_CHANGE,t,e,t,e,i)}),this._notifyAfterCollectionChange()},r.prototype._notifyCurrentChange=function(t,e,i,r){if(!this.isEventRaising())return;this._removeFromQueue("onCurrentChange"),this._notify("onCurrentChange",t,e,i,r)},r.prototype._notifyCollectionItemsChange=function(t,e,i){for(var r=this,o=this._getItems(),n=e+t.length,s=[],a=e;a<n;a++)s.push(o[this._getItemIndex(a)]);this._notifyBeforeCollectionChange(),c.EventRaisingMixin._extractPacksByList(this,s,function(t,e){r._notifyCollectionChange(_.default.ACTION_CHANGE,t,e,t,e,i)}),this._notifyAfterCollectionChange()},r.prototype._notifySourceCollectionItemChange=function(t,e,i,r){var o=this._getUtilityEnumerator(),n=this._getItems(),s=this._getItemIndex(i),a,l=n[s],u=o.getInternalBySource(s),h,p=this.isEventRaising(),c=this._startUpdateSession(),_,f;for(var y in r)if(r.hasOwnProperty(y))if(this._$importantItemProperties.indexOf(y)>-1){if(p)f=this._getItemsState(n);this._reAnalize(i,1);break}if(!p)return;this._finishUpdateSession(c,false),a=this._getItemIndex(i),h=o.getInternalBySource(a),_=u!==h,this._checkItemsDiff(c,n,f,function(t){var e=t.indexOf(l);if(_){if(e>-1&&u>h)t.splice(e,1);else if(-1===e&&u<h)t.push(l)}else if(!_&&-1===e)t.push(l)})},r.prototype._notifyBeforeCollectionChange=function(){if(!this.isEventRaising())return;this._notifyLater("onBeforeCollectionChange")},r.prototype._notifyAfterCollectionChange=function(){if(!this.isEventRaising())return;this._notify("onAfterCollectionChange")},r}(y.mixin(i.default,p.SerializableMixin,c.EventRaisingMixin));e.default=$,Object.assign($.prototype,{"[Types/_display/Collection]":true,_moduleName:"Types/display:Collection",_$collection:null,_$filter:null,_$group:null,_$sort:null,_$idProperty:"",_$unique:false,_$importantItemProperties:null,_localize:false,_itemModule:"Types/display:CollectionItem",_itemsFactory:null,_composer:null,_sourceCollectionSynchronized:true,_sourceCollectionDelayedCallbacks:null,_cursorEnumerator:null,_utilityEnumerator:null,_onCollectionChange:null,_onCollectionItemChange:null,_oEventRaisingChange:null}),$.prototype["[WS.Data/Display/Collection]"]=true,f.register("Types/display:Collection",$)});