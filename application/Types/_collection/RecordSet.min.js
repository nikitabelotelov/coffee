define("Types/_collection/RecordSet",["require","exports","tslib","Types/_collection/IObservable","Types/_collection/ObservableList","Types/_collection/enumerator/Arraywise","Types/_collection/Indexer","Types/entity","Types/di","Types/util","Types/object"],function(t,e,u,i,a,r,o,l,p,h,c){"use strict";Object.defineProperty(e,"__esModule",{value:true});var n="Types/entity:Model",d=l.Record.RecordState,s=false;function f(t,e){if(s&&e)if(t&&t["[Types/_entity/Record]"]&&null===t.get(e))h.logger.info("Types/_collection/RecordSet: Id propery must not be null");else if(t instanceof _)t.each(function(t){f(t,e)})}var _=function(n){function s(t){var e=this;if(t)if("items"in t)h.logger.stack('Types/_collection/RecordSet: option "items" give no effect, use "rawData" instead',1);if(e=n.call(this,t)||this,t)if("meta"in t)e._$metaData=t.meta;if(!e._$format&&e._$model&&"function"===typeof e._$model&&e._$model.prototype._$format)e._$format=e._$model.prototype._$format;if(l.FormattableMixin.constructor.call(e,t),!e._$idProperty)e._$idProperty=e._getAdapter().getKeyField(e._getRawData());if(e._$rawData)e._assignRawData(e._getRawData(true),true),e._initByRawData();return e._publish("onPropertyChange"),e}return u.__extends(s,n),s.produceInstance=function(t,e){var a={rawData:t};if(e){if(e.adapter)a.adapter=e.adapter;if(e.model)a.model=e.model}return new this(a)},s.patch=function(a,t){t=t||["changed","added","removed"];var e=function(t){var e=new s({adapter:a.getAdapter(),idProperty:a.getIdProperty()});return a.each(function(t){e.add(t)},t),e},i=function(t){var e=[],a=t.getIdProperty();return t.each(function(t){e.push(t.get(a))}),e},r=new l.Record({format:[{name:t[0],type:"recordset"},{name:t[1],type:"recordset"},{name:t[2],type:"array",kind:"string"}],adapter:a.getAdapter()});return r.set(t[0],e(d.CHANGED)),r.set(t[1],e(d.ADDED)),r.set(t[2],i(e(d.DELETED))),r.acceptChanges(),r},s.prototype.destroy=function(){this._$model="",this._$metaData=null,this._metaData=null,n.prototype.destroy.call(this)},s.prototype.relationChanged=function(t,e){var a=this.getIndex(t.target);if(a>-1){var i,r=this._getRawDataAdapter().at(a),o=t.target.getRawData(true);if(r!==o)this._getRawDataAdapter().replace(o,a)}return n.prototype.relationChanged.call(this,t,e)},s.prototype.clone=function(t){var e=n.prototype.clone.call(this,t);if(t)e._$items=this._$items.slice();return e},s.prototype.isEqual=function(t){if(t===this)return true;if(!t)return false;if(!(t instanceof s))return false;return c.isEqual(this._getRawData(),t.getRawData(true))},s.prototype.getEnumerator=function(e){var a=this,t=new r.default(this._$items);if(t.setResolver(function(t){return a.at(t)}),e)t.setFilter(function(t){return t.getState()===e});return t},s.prototype.each=function(t,e,a){if(e instanceof Object)a=e,e=void 0;a=a||this;for(var i=this.getCount(),r=0,o,n,s=0;s<i;s++){if(n=this.at(s),e)o=n.getState()===e;else o=true;if(o)t.call(a,n,r++,this)}},s.prototype.clear=function(){for(var t,e=0,a=this._$items.length;e<a;e++)if(t=this._$items[e])t.detach();this._getRawDataAdapter().clear(),n.prototype.clear.call(this)},s.prototype.add=function(t,e){return t=this._normalizeItems([t],d.ADDED)[0],this._getRawDataAdapter().add(t.getRawData(true),e),n.prototype.add.call(this,t,e),t},s.prototype.at=function(t){return this._getRecord(t)},s.prototype.remove=function(t){return this._checkItem(t),n.prototype.remove.call(this,t)},s.prototype.removeAt=function(t){this._getRawDataAdapter().remove(t);var e=this._$items[t],a=n.prototype.removeAt.call(this,t);if(e)e.detach();return a},s.prototype.replace=function(t,e){t=this._normalizeItems([t],d.CHANGED)[0],this._getRawDataAdapter().replace(t.getRawData(true),e);var a=this._$items[e];if(n.prototype.replace.call(this,t,e),a)a.detach();return t},s.prototype.move=function(t,e){this._getRecord(t),this._getRawDataAdapter().move(t,e),n.prototype.move.call(this,t,e)},s.prototype.assign=function(t){if(t===this)return[];var e=this._$items.slice(),a,i;if(t instanceof s)this._$adapter=t.getAdapter(),this._assignRawData(t.getRawData(),this._hasFormat()),a=new Array(t.getCount()),n.prototype.assign.call(this,a);else{if((t=this._itemsToArray(t)).length&&t[0]&&t[0]["[Types/_entity/Record]"])this._$adapter=t[0].getAdapter();t=this._normalizeItems(t,d.ADDED),this._assignRawData(null,this._hasFormat()),t=this._addItemsToRawData(t),n.prototype.assign.call(this,t),a=t}for(var r=0,o=e.length;r<o;r++)if(i=e[r])i.detach();return a},s.prototype.append=function(t){return t=this._itemsToArray(t),t=this._normalizeItems(t,d.ADDED),t=this._addItemsToRawData(t),n.prototype.append.call(this,t),t},s.prototype.prepend=function(t){return t=this._itemsToArray(t),t=this._normalizeItems(t,d.ADDED),t=this._addItemsToRawData(t,0),n.prototype.prepend.call(this,t),t},s.prototype._getIndexer=function(){var a=this,t;if(this._indexer)return this._indexer;if(this._$model===this._defaultModel){var i=this._getAdapter(),r=this._getRawDataAdapter();t=new o.default(this._getRawData(),function(){return r.getCount()},function(t,e){return r.at(e)},function(t,e){return i.forRecord(t).get(e)})}else t=new o.default(this._$items,function(t){return t.length},function(t,e){return a.at(e)},function(t,e){return t.get(e)});return this._indexer=t},s.prototype._itemsSlice=function(t,e){if(this._isNeedNotifyCollectionChange()){if(void 0===t)t=0;if(void 0===e)e=this._$items.length;for(var a=t;a<e;a++)this._getRecord(a)}return n.prototype._itemsSlice.call(this,t,e)},s.prototype._getSerializableState=function(t){return t=a.default.prototype._getSerializableState.call(this,t),(t=l.FormattableMixin._getSerializableState.call(this,t))._instanceId=this.getInstanceId(),delete t.$options.items,t},s.prototype._setSerializableState=function(t){var e=n.prototype._setSerializableState.call(this,t),a=l.FormattableMixin._setSerializableState(t);return function(){e.call(this),a.call(this),this._instanceId=t._instanceId}},s.prototype.setRawData=function(t){var e=this._$items.slice(),a=this._eventRaising;this._eventRaising=false,this.clear(),this._eventRaising=a,this._assignRawData(t),this._initByRawData(),this._notifyCollectionChange(i.default.ACTION_RESET,this._$items,0,e,0)},s.prototype.addField=function(t,e,a){if(t=this._buildField(t),l.FormattableMixin.addField.call(this,t,e),this._parentChanged(l.Record.prototype.addField),void 0!==a){var i=t.getName();this.each(function(t){t.set(i,a)})}this._nextVersion()},s.prototype.removeField=function(t){l.FormattableMixin.removeField.call(this,t),this._nextVersion(),this._parentChanged(l.Record.prototype.removeField)},s.prototype.removeFieldAt=function(t){l.FormattableMixin.removeFieldAt.call(this,t),this._nextVersion(),this._parentChanged(l.Record.prototype.removeFieldAt)},s.prototype._createRawDataAdapter=function(){return this._getAdapter().forTable(this._getRawData(true))},s.prototype._assignRawData=function(t,e){if(l.FormattableMixin.setRawData.call(this,t),this._clearIndexer(),!e)this._clearFormat();this._nextVersion()},s.prototype.getModel=function(){return this._$model},s.prototype.acceptChanges=function(t){var a=[];this.each(function(t,e){if(t.getState()===d.DELETED)a.push(e);t.acceptChanges()});for(var e=a.length-1;e>=0;e--)this.removeAt(a[e]);if(t)this._childChanged(l.Record.prototype.acceptChanges)},s.prototype.isChanged=function(){for(var t=false,e=this._$items,a=e.length,i=0;i<a;i++)if(e[i].isChanged()){t=true;break}return t},s.prototype.getIdProperty=function(){return this._$idProperty},s.prototype.setIdProperty=function(e){if(this._$idProperty===e)return;this._$idProperty=e,this.each(function(t){if(t.setIdProperty)t.setIdProperty(e)}),this._notify("onPropertyChange",{idProperty:this._$idProperty})},s.prototype.getRecordById=function(t){return this.at(this.getIndexByValue(this._$idProperty,t))},s.prototype.getMetaData=function(){var r=this;if(this._metaData)return this._metaData;var o=function(t,e){return l.factory.cast(t,e,{format:e,adapter:r._getAdapter(),idProperty:r._$idProperty})},n=this._$metaFormat?l.FormattableMixin._buildFormat(this._$metaFormat):null,s={};if(this._$metaData)if(this._$metaData instanceof Object&&Object.getPrototypeOf(this._$metaData)===Object.prototype)Object.keys(this._$metaData).forEach(function(t){var e=r._$metaData[t];if(n){var a=void 0,i=n.getFieldIndex(t);if(i>-1)a=n.at(i),e=o(e,a.getType())}s[t]=e});else s=this._$metaData;else{var p=this._getRawDataAdapter();if(p["[Types/_entity/adapter/IDecorator]"])p=p.getOriginal();if(p["[Types/_entity/adapter/IMetaData]"])p.getMetaDataDescriptor().forEach(function(t){var e=t.getName(),a;if(n){var i=n.getFieldIndex(e);if(i>-1)a=n.at(i)}s[e]=o(p.getMetaData(e),a?a.getType():r._getFieldType(t))})}return this._metaData=s,this._metaData},s.prototype.setMetaData=function(i){var r=this;if(this._metaData=this._$metaData=i,i instanceof Object){var o=this._getRawDataAdapter();if(o["[Types/_entity/adapter/IMetaData]"])o.getMetaDataDescriptor().forEach(function(t){var e=t.getName(),a=l.factory.serialize(i[e],{format:t,adapter:r.getAdapter()});o.setMetaData(e,a)})}this._notify("onPropertyChange",{metaData:i})},s.prototype.merge=function(t,e){if(e instanceof Object&&e.hasOwnProperty("merge")&&!e.hasOwnProperty("replace"))e.replace=e.merge;e=u.__assign({add:true,remove:true,replace:true,inject:false},e||{});var a=t.getCount(),i=this._$idProperty,r={},o={},n=[],s=[],p=[],l,h,c;this.each(function(t,e){r[t.get(i)]=e});for(var d=0;d<a;d++){if(h=(l=t.at(d)).get(i),0===d)this._checkItem(l);if(r.hasOwnProperty(h)){if(e.inject){if(c=r[h],!l.isEqual(this.at(c)))p.push([l,c])}else if(e.replace)if(c=r[h],!l.isEqual(this.at(c)))s.push([l,c])}else if(e.add)n.push(l);if(e.remove)o[h]=true}if(s.length)for(var d=0;d<s.length;d++)this.replace(s[d][0],s[d][1]);if(p.length)for(var d=0;d<p.length;d++)(l=this.at(p[d][1])).setRawData(p[d][0].getRawData());if(n.length)this.append(n);if(e.remove){var f=[];this.each(function(t,e){if(!o.hasOwnProperty(t.get(i)))f.push(e)});for(var d=f.length-1;d>=0;d--)this.removeAt(f[d])}},s.prototype._addItemsToRawData=function(t,e){for(var a=this._getRawDataAdapter(),i,r=0,o=(t=this._itemsToArray(t)).length;r<o;r++)i=t[r],a.add(i.getRawData(true),void 0===e?void 0:e+r);return t},s.prototype._normalizeItems=function(t,e){for(var a=this._hasFormat(),i,r=[],o,n,s=0;s<t.length;s++){if(n=t[s],this._checkItem(n),!a&&0===this.getCount())i=n.getFormat(true),this._clearFormat(),this._resetRawDataFields();else if(!i)i=this._getFormat(true);if(o=this._normalizeItemData(n,i),e)o.setState(e);r.push(o)}return r},s.prototype._normalizeItemData=function(t,e){var a=t.getFormat(true),i;if(e.isEqual(a))i=this._buildRecord(t.getRawData());else{var r=this.getAdapter().forRecord(null,this._getRawData()),o=t.getAdapter().forRecord(t.getRawData(true));e.each(function(t,e){var a=t.getName();r.addField(t,e),r.set(a,o.get(a))}),i=this._buildRecord(r.getData())}return i},s.prototype._checkItem=function(t){if(!t||!t["[Types/_entity/Record]"])throw new TypeError("Item should be an instance of Types/entity:Record");f(t,this.getIdProperty()),this._checkAdapterCompatibility(t.getAdapter())},s.prototype._buildRecord=function(t){var e;return p.create(this._$model,{owner:this,writable:this.writable,state:d.UNCHANGED,adapter:this.getAdapter(),rawData:t,idProperty:this._$idProperty})},s.prototype._getRecord=function(t){var e=this;if(t<0||t>=this._$items.length)return;var a=this._$items[t];if(!a){var i=this._getRawDataAdapter();a=this._$items[t]=this._buildRecord(function(){return i.at(a?e.getIndex(a):t)}),this._addChild(a),f(a,this.getIdProperty())}return a},s.prototype._initByRawData=function(){var t=this._getRawDataAdapter();this._$items.length=0,this._$items.length=t.getCount()},s}(h.mixin(a.default,l.FormattableMixin,l.InstantiableMixin));e.default=_,Object.assign(_.prototype,{"[Types/_collection/RecordSet]":true,"[Types/_entity/IInstantiable]":true,"[Types/_entity/IObservableObject]":true,"[Types/_entity/IProducible]":true,_moduleName:"Types/collection:RecordSet",_instancePrefix:"recordset-",_defaultModel:n,_$model:n,_$idProperty:"",_$metaData:null,_$metaFormat:null,_metaData:null}),_.prototype.forEach=_.prototype.each,_.prototype["[WS.Data/Collection/RecordSet]"]=true,p.register("Types/collection:RecordSet",_,{instantiate:false})});