define("Types/_entity/Record",["require","exports","tslib","Types/_entity/DestroyableMixin","Types/_entity/OptionsToPropertyMixin","Types/_entity/ObservableMixin","Types/_entity/SerializableMixin","Types/_entity/CloneableMixin","Types/_entity/ManyToManyMixin","Types/_entity/ReadWriteMixin","Types/_entity/FormattableMixin","Types/_entity/VersionableMixin","Types/_entity/factory","Types/di","Types/util","Types/shim"],function(i,e,t,a,n,r,o,s,l,d,c,h,u,f,p,_){"use strict";Object.defineProperty(e,"__esModule",{value:true});var y=p.protect("fieldsCache"),g=p.protect("fieldsClone"),C=p.protect("changedFields"),F={ADDED:"Added",DELETED:"Deleted",CHANGED:"Changed",UNCHANGED:"Unchanged",DETACHED:"Detached"},b="field.",m=p.protect("objects"),v=p.protect("all");function w(e){return e&&"object"===typeof e?false:true}function T(e){if(e&&"object"===typeof e&&e!==e.valueOf())return e.valueOf();return e}function D(e,t){return T(e)===T(t)}function E(e){switch(typeof e){case"boolean":return"boolean";case"number":if(e%1===0)return"integer";return"real";case"object":if(null===e)return"string";else if(e instanceof R)return"record";else if(e&&e["[Types/_collection/RecordSet]"])return"recordset";else if(e instanceof Date){if(e.hasOwnProperty("_serializeMode"))switch(e.getSQLSerializationMode()){case Date.SQL_SERIALIZE_MODE_DATE:return"date";case Date.SQL_SERIALIZE_MODE_TIME:return"time"}return"datetime"}else if(e instanceof Array)return{type:"array",kind:E(e.find(function(e){return null!==e&&void 0!==e}))};return"object";default:return"string"}}var R=function(r){function l(e){var t=this;if(e&&e.owner&&!e.owner["[Types/_collection/RecordSet]"])throw new TypeError("Records owner should be an instance of Types/collection:RecordSet");return t=r.call(this,e)||this,n.default.call(t,e),o.default.constructor.call(t),c.default.constructor.call(t,e),d.default.constructor.call(t,e),t._publish("onPropertyChange"),t._clearChangedFields(),t._acceptedState=t._$state,t}return t.__extends(l,r),Object.defineProperty(l.prototype,"_fieldsCache",{get:function(){return this[y]||(this[y]=new _.Map)},enumerable:true,configurable:true}),Object.defineProperty(l.prototype,"_fieldsClone",{get:function(){return this[g]||(this[g]=new _.Map)},enumerable:true,configurable:true}),Object.defineProperty(l.prototype,"_changedFields",{get:function(){var t=this,r={},i=this[C],a,n,o;if(!i)return r;return Object.keys(i).forEach(function(e){if(a=i[e],o=a[0],n=a[1],o&&n&&o["[Types/_entity/Record]"]&&!o.isChanged())return;r[e]=t._haveToClone(o)&&t._fieldsClone.has(e)?t._fieldsClone.get(e):o}),r},enumerable:true,configurable:true}),l.prototype.destroy=function(){this[C]=null,this._clearFieldsCache(),d.default.destroy.call(this),a.default.prototype.destroy.call(this)},l.prototype.get=function(e){if(this._fieldsCache.has(e))return this._fieldsCache.get(e);var t=this._getRawDataValue(e);if(this._isFieldValueCacheable(t))if(this._addChild(t,this._getRelationNameForField(e)),this._fieldsCache.set(e,t),this._haveToClone(t))this._fieldsClone.set(e,t.clone());return t},l.prototype.set=function(e,t){var r=this,i=this._getHashMap(e,t),a=[],n=this._setPairs(Object.keys(i).map(function(e){return[e,i[e],r.get(e)]}),a);if(n)this._notifyChange(n);this._checkErrors(a)},l.prototype.has=function(e){return this._getRawDataFields().indexOf(e)>-1},l.prototype._setPairs=function(e,n){var o=this,s=null;return e.forEach(function(e){var t=e[0],r=e[1],i=e[2],a=r;if(D(a,i)){if("object"===typeof a)o._setRawDataValue(t,a)}else try{if(o._removeChild(i),w(a))a=o._setRawDataValue(t,a);else o._setRawDataValue(t,a);if(o._addChild(a,o._getRelationNameForField(t)),a!==i){if(!o.has(t))o._addRawDataField(t);if(!s)s={};if(s[t]=a,o._hasChangedField(t)&&T(o._getChangedFieldValue(t))===T(a))o._unsetChangedField(t);else o._setChangedField(t,i);if(o._isFieldValueCacheable(a)){if(o._fieldsCache.set(t,a),o._haveToClone(a))o._fieldsClone.set(t,a.clone())}else o._fieldsCache.delete(t),o._fieldsClone.delete(t)}}catch(e){n.push(e)}}),s},l.prototype.getEnumerator=function(){return f.create("Types/collection:enumerator.Arraywise",this._getRawDataFields())},l.prototype.each=function(e,t){var r=this.getEnumerator(),i;while(r.moveNext())i=r.getCurrent(),e.call(t||this,i,this.get(i))},l.prototype.isEqual=function(e){if(e===this)return true;if(!e)return false;if(!(e instanceof l))return false;return JSON.stringify(this._getRawData())===JSON.stringify(e.getRawData(true))},l.prototype.relationChanged=function(e,t){var n=this,r=function(e,t){var r={},i,a;if(n._getRawDataAdapter().has(e))n._setRawDataValue(e,t,true);return n._setChangedField(e,t,true),r[e]=t,n._notify("onPropertyChange",r),r},i=t[0],a=this._getFieldFromRelationName(i),o=e.target;switch(e.original){case l.prototype.acceptChanges:if(a&&(o["[Types/_entity/Record]"]&&!o.isChanged()||o["[Types/_collection/RecordSet]"]&&!o.isChanged()))this.acceptChanges([a]);break;case l.prototype.rejectChanges:if(a&&(o["[Types/_entity/Record]"]&&!o.isChanged()||o["[Types/_collection/RecordSet]"]&&!o.isChanged()))this.rejectChanges([a]);break;case l.prototype.addField:case l.prototype.removeField:case l.prototype.removeFieldAt:if(this._resetRawDataAdapter(),this._resetRawDataFields(),a)r(a,o);break;default:if(a){var s;return{target:o,data:r(a,o)}}}},l.prototype._getRelationNameForField=function(e){return b+e},l.prototype._getFieldFromRelationName=function(e){if((e+="").substr(0,b.length)===b)return e.substr(b.length)},l.produceInstance=function(e,t){var r={rawData:e};if(t&&t.adapter)r.adapter=t.adapter;return new this(r)},l.prototype._getSerializableState=function(e){var t=o.default.prototype._getSerializableState.call(this,e);if((t=c.default._getSerializableState.call(this,t))._changedFields=this[C],t.$options.owner&&t.$options.owner._hasFormat())t._format=t.$options.owner.getFormat();return delete t.$options.owner,t},l.prototype._setSerializableState=function(e){var t=o.default.prototype._setSerializableState(e),r=c.default._setSerializableState(e);return function(){if(t.call(this),r.call(this),this[C]=e._changedFields,e._format)this._$format=e._format}},l.prototype.setRawData=function(e){c.default.setRawData.call(this,e),this._nextVersion(),this._clearFieldsCache(),this._notifyChange()},l.prototype.addField=function(e,t,r){if(this._checkFormatIsWritable(),e=this._buildField(e),c.default.addField.call(this,e,t),void 0!==r)this.set(e.getName(),r);this._childChanged(l.prototype.addField),this._nextVersion()},l.prototype.removeField=function(e){this._checkFormatIsWritable(),this._nextVersion(),this._fieldsCache.delete(e),this._fieldsClone.delete(e),c.default.removeField.call(this,e),this._childChanged(l.prototype.removeField)},l.prototype.removeFieldAt=function(e){this._checkFormatIsWritable(),this._nextVersion();var t=this._getFormat(true).at(e);if(t)this._fieldsCache.delete(t.getName()),this._fieldsClone.delete(t.getName());c.default.removeFieldAt.call(this,e),this._childChanged(l.prototype.removeFieldAt)},l.prototype._hasFormat=function(){var e=this.getOwner();if(e)return e._hasFormat();else return c.default._hasFormat.call(this)},l.prototype._getFormat=function(e){var t=this.getOwner();if(t)return t._getFormat(e);else return c.default._getFormat.call(this,e)},l.prototype._getFieldFormat=function(e,t){var r=this.getOwner();if(r)return r._getFieldFormat(e,t);else return c.default._getFieldFormat.call(this,e,t)},l.prototype._createRawDataAdapter=function(){return this._getAdapter().forRecord(this._getRawData(true))},l.prototype._checkFormatIsWritable=function(){var e;if(this.getOwner())throw new Error("Record format has read only access if record belongs to recordset. "+"You should change recordset format instead.")},l.prototype.isChanged=function(e){return e?this._hasChangedField(e):this.getChanged().length>0},l.prototype.getOwner=function(){return this._$owner},l.prototype.detach=function(){this._$owner=null,this.setState(F.DETACHED)},l.prototype.getState=function(){return this._$state},l.prototype.setState=function(e){this._$state=e},l.prototype.getChanged=function(){return Object.keys(this._changedFields)},l.prototype.acceptChanges=function(e,t){var r=this;if(void 0===t&&"boolean"===typeof e)t=e,e=void 0;if(void 0===e)this._clearChangedFields();else{if(!(e instanceof Array))throw new TypeError('Argument "fields" should be an instance of Array');e.forEach(function(e){r._unsetChangedField(e)})}if(0===this.getChanged().length)switch(this._$state){case F.ADDED:case F.CHANGED:this._$state=F.UNCHANGED;break;case F.DELETED:this._$state=F.DETACHED}if(this._acceptedState=this._$state,t)this._childChanged(l.prototype.acceptChanges)},l.prototype.rejectChanges=function(e,t){var r=this;if(void 0===t&&"boolean"===typeof e)t=e,e=void 0;var i={};if(void 0===e)e=this.getChanged();else if(!(e instanceof Array))throw new TypeError('Argument "fields" should be an instance of Array');for(var a in e.forEach(function(e){if(r._hasChangedField(e))i[e]=r._getChangedFieldValue(e)}),this.set(i),i)if(i.hasOwnProperty(a))this._unsetChangedField(a);if(0===this.getChanged().length)this._$state=this._acceptedState;if(t)this._childChanged(l.prototype.rejectChanges)},l.prototype.toString=function(){var r={};return this.each(function(e,t){r[e]=t}),JSON.stringify(r)},l.prototype._checkErrors=function(e){if(e.length){for(var t=e[0],r=e.length;r>0;r--)if(t>e[r])t=e[r];throw t}},l.prototype._getHashMap=function(e,t){var r=e;if(!(r instanceof Object))(r={})[e]=t;return r},l.prototype._clearFieldsCache=function(){this[y]=null,this[g]=null},l.prototype._isFieldValueCacheable=function(e){switch(this._$cacheMode){case m:return e instanceof Object;case v:return true}return false},l.prototype._haveToClone=function(e){return this._$cloneChanged&&e&&e["[Types/_entity/ICloneable]"]},l.prototype._getRawDataValue=function(e){var t=this._getRawDataAdapter();if(!t.has(e))return;var r=t.get(e),i=this._getFieldFormat(e,t);return u.default.cast(r,this._getFieldType(i),{format:i,adapter:this._getAdapter()})},l.prototype._setRawDataValue=function(e,t,r){if(!r&&t&&t["[Types/_entity/FormattableMixin]"])this._checkAdapterCompatibility(t.getAdapter());var i=this._getRawDataAdapter();return t=u.default.serialize(t,{format:this._getFieldFormat(e,i),adapter:this.getAdapter()}),i.set(e,t),t},l.prototype._notifyChange=function(e){e=e||{},this._childChanged(e),this._nextVersion(),this._notify("onPropertyChange",e)},l.prototype._clearChangedFields=function(){this[C]={}},l.prototype._hasChangedField=function(e){return this._changedFields.hasOwnProperty(e)},l.prototype._getChangedFieldValue=function(e){return this._changedFields[e]},l.prototype._setChangedField=function(e,t,r){if(!this[C].hasOwnProperty(e))this[C][e]=[t,Boolean(r)];switch(this._$state){case F.UNCHANGED:this._$state=F.CHANGED}},l.prototype._unsetChangedField=function(e){delete this[C][e]},l.extend=function(e,t){if(p.logger.info("Types/_entity/Record","Method extend is deprecated, use ES6 extends or Core/core-extend"),!i.defined("Core/core-extend"))throw new ReferenceError('You should require module "Core/core-extend" to use old-fashioned "Types/_entity/Record::extend()" method.');var r;return i("Core/core-extend")(this,e,t)},Object.defineProperty(l,"RecordState",{get:function(){return F},enumerable:true,configurable:true}),Object.defineProperty(l,"CACHE_MODE_OBJECTS",{get:function(){return m},enumerable:true,configurable:true}),Object.defineProperty(l,"CACHE_MODE_ALL",{get:function(){return v},enumerable:true,configurable:true}),l.addFieldTo=function(e,t,r,i){if(!i){var a=E(r);if("string"===typeof a)a={name:"",type:a};a.name=t,i=a}e.addField(i,void 0,r)},l.fromObject=function(e,t){if(null===e)return e;if(e&&e instanceof l)return e;var r=new l({adapter:t||"Types/entity:adapter.Json",format:[]}),i=[];for(var a in e)if(e.hasOwnProperty(a))i.push(a);for(var n=0,o=(i=i.sort()).length;n<o;n++){var a,s=e[a=i[n]];if(void 0===s)continue;l.addFieldTo(r,a,s)}return r},l.filter=function(i,a){var n=new l({adapter:i.getAdapter()}),e;return i.getFormat().each(function(e){var t=e.getName(),r=i.get(t);if(!a||a(t,r))n.addField(e),n.set(t,r)}),n.acceptChanges(),n},l.filterFields=function(e,t){if(!(t instanceof Array))throw new TypeError('Argument "fields" should be an instance of Array');return l.filter(e,function(e){return t.indexOf(e)>-1})},l}(p.mixin(a.default,n.default,r.default,o.default,s.default,l.default,d.default,c.default,h.default));e.default=R,Object.assign(R.prototype,{"[Types/_entity/Record]":true,"[Types/_collection/IEnumerable]":true,"[Types/_entity/ICloneable]":true,"[Types/_entity/IEquatable]":true,"[Types/_entity/IObject]":true,"[Types/_entity/IObservableObject]":true,"[Types/_entity/IProducible]":true,"[Types/_entity/IVersionable]":true,"[Types/_entity/relation/IReceiver]":true,_moduleName:"Types/entity:Record",_$state:F.DETACHED,_$cacheMode:m,_$cloneChanged:false,_$owner:null,_acceptedState:void 0}),R.prototype[C]=null,R.prototype["[WS.Data/Entity/Record]"]=true,R.prototype["[WS.Data/Collection/IEnumerable]"]=true,R.prototype["[WS.Data/Entity/ICloneable]"]=true,f.register("Types/entity:Record",R,{instantiate:false})});