define("Types/_entity/Record",["require","exports","tslib","Types/util","Types/_entity/DestroyableMixin","Types/_entity/OptionsToPropertyMixin","Types/_entity/ObservableMixin","Types/_entity/SerializableMixin","Types/_entity/CloneableMixin","Types/_entity/ManyToManyMixin","Types/_entity/ReadWriteMixin","Types/_entity/FormattableMixin","Types/_entity/VersionableMixin","Types/_entity/factory","Types/di","Types/util","Types/shim","Types/util","Core/core-extend"],function(e,t,i,r,a,n,o,s,l,c,d,h,u,p,f,y,_,g,C){"use strict";function F(e){return e&&"object"===typeof e?false:true}function b(e){if(e&&"object"===typeof e&&e!==e.valueOf())return e.valueOf();return e}function m(e,t){return b(e)===b(t)}function v(e){switch(typeof e){case"boolean":return"boolean";case"number":if(e%1===0)return"integer";return"real";case"object":if(null===e)return"string";else if(e instanceof S)return"record";else if(e&&e["[Types/_collection/RecordSet]"])return"recordset";else if(e instanceof Date){if(e.hasOwnProperty("_serializeMode"))switch((e=e).getSQLSerializationMode()){case Date.SQL_SERIALIZE_MODE_DATE:return"date";case Date.SQL_SERIALIZE_MODE_TIME:return"time"}return"datetime"}else if(e instanceof Array)return{type:"array",kind:v(e.find(function(e){return null!==e&&void 0!==e}))};return"object";default:return"string"}}Object.defineProperty(t,"__esModule",{value:true});var w=r.protect("fieldsCache"),T=r.protect("fieldsClone"),D=r.protect("changedFields"),E={ADDED:"Added",DELETED:"Deleted",CHANGED:"Changed",UNCHANGED:"Unchanged",DETACHED:"Detached"},R="field.",A=r.protect("objects"),O=r.protect("all"),S=function(r){function l(e){var t=this;if(e&&e.owner&&!e.owner["[Types/_collection/RecordSet]"])throw new TypeError("Records owner should be an instance of Types/collection:RecordSet");return t=r.call(this,e)||this,n.default.call(t,e),s.default.constructor.call(t),h.default.constructor.call(t,e),d.default.constructor.call(t,e),t._publish("onPropertyChange"),t._clearChangedFields(),t._acceptedState=t._$state,t}return i.__extends(l,r),Object.defineProperty(l.prototype,"_fieldsCache",{get:function(){return this[w]||(this[w]=new _.Map)},enumerable:true,configurable:true}),Object.defineProperty(l.prototype,"_fieldsClone",{get:function(){return this[T]||(this[T]=new _.Map)},enumerable:true,configurable:true}),Object.defineProperty(l.prototype,"_changedFields",{get:function(){var t=this,r={},i=this[D],a,n,o;if(!i)return r;return Object.keys(i).forEach(function(e){if(a=i[e],o=a[0],n=a[1],o&&n&&o["[Types/_entity/Record]"]&&!o.isChanged())return;r[e]=t._haveToClone(o)&&t._fieldsClone.has(e)?t._fieldsClone.get(e):o}),r},enumerable:true,configurable:true}),l.prototype.destroy=function(){this[D]=null,this._clearFieldsCache(),d.default.destroy.call(this),a.default.prototype.destroy.call(this)},l.prototype.get=function(e){if(this._fieldsCache.has(e))return this._fieldsCache.get(e);var t=this._getRawDataValue(e);if(this._isFieldValueCacheable(t))if(this._addChild(t,this._getRelationNameForField(e)),this._fieldsCache.set(e,t),this._haveToClone(t))this._fieldsClone.set(e,t.clone());return t},l.prototype.set=function(e,t){var r=this,i=this._getHashMap(e,t),a=[],n=this._setPairs(Object.keys(i).map(function(e){return[e,i[e],r.get(e)]}),a);if(n)this._notifyChange(n);this._checkErrors(a)},l.prototype.has=function(e){return this._getRawDataFields().indexOf(e)>-1},l.prototype._setPairs=function(e,a){var n=this,o=null;return e.forEach(function(e){var t=e[0],r=e[1],i=e[2];if(m(r,i)){if("object"===typeof r)n._setRawDataValue(t,r)}else try{if(n._removeChild(i),F(r))r=n._setRawDataValue(t,r);else n._setRawDataValue(t,r);if(n._addChild(r,n._getRelationNameForField(t)),r!==i){if(!n.has(t))n._addRawDataField(t);if(!o)o={};if(o[t]=r,n._hasChangedField(t)&&b(n._getChangedFieldValue(t))===b(r))n._unsetChangedField(t);else n._setChangedField(t,i);if(n._isFieldValueCacheable(r)){if(n._fieldsCache.set(t,r),n._haveToClone(r))n._fieldsClone.set(t,r.clone())}else n._fieldsCache.delete(t),n._fieldsClone.delete(t)}}catch(e){a.push(e)}}),o},l.prototype.getEnumerator=function(){var e;return new(f.resolve("Types/collection:enumerator.Arraywise"))(this._getRawDataFields())},l.prototype.each=function(e,t){var r=this.getEnumerator(),i;while(r.moveNext())i=r.getCurrent(),e.call(t||this,i,this.get(i))},l.prototype.isEqual=function(e){if(e===this)return true;if(!e)return false;if(!(e instanceof l))return false;return JSON.stringify(this._getRawData())===JSON.stringify(e.getRawData(true))},l.prototype.relationChanged=function(e,t){var n=this,r=function(e,t){var r={},i,a;if(n._getRawDataAdapter().has(e))n._setRawDataValue(e,t,true);return n._setChangedField(e,t,true),r[e]=t,n._notify("onPropertyChange",r),r},i=t[0],a=this._getFieldFromRelationName(i),o=e.target;switch(e.original){case l.prototype.acceptChanges:if(a&&(o["[Types/_entity/Record]"]&&!o.isChanged()||o["[Types/_collection/RecordSet]"]&&!o.isChanged()))this.acceptChanges([a]);break;case l.prototype.rejectChanges:if(a&&(o["[Types/_entity/Record]"]&&!o.isChanged()||o["[Types/_collection/RecordSet]"]&&!o.isChanged()))this.rejectChanges([a]);break;case l.prototype.addField:case l.prototype.removeField:case l.prototype.removeFieldAt:if(this._resetRawDataAdapter(),this._resetRawDataFields(),a)r(a,o);break;default:if(a){var s;return{target:o,data:r(a,o)}}}},l.produceInstance=function(e,t){var r={rawData:e};if(t&&t.adapter)r.adapter=t.adapter;return new this(r)},l.prototype._getSerializableState=function(e){if(e=s.default.prototype._getSerializableState.call(this,e),(e=h.default._getSerializableState.call(this,e))._changedFields=this[D],e.$options.owner&&e.$options.owner._hasFormat())e._format=e.$options.owner.getFormat();return delete e.$options.owner,e},l.prototype._setSerializableState=function(e){var t=s.default.prototype._setSerializableState(e),r=h.default._setSerializableState(e);return function(){if(t.call(this),r.call(this),this[D]=e._changedFields,e._format)this._$format=e._format}},l.prototype.setRawData=function(e){h.default.setRawData.call(this,e),this._nextVersion(),this._clearFieldsCache(),this._notifyChange()},l.prototype.addField=function(e,t,r){if(this._checkFormatIsWritable(),e=this._buildField(e),h.default.addField.call(this,e,t),void 0!==r)this.set(e.getName(),r);this._childChanged(l.prototype.addField),this._nextVersion()},l.prototype.removeField=function(e){this._checkFormatIsWritable(),this._nextVersion(),this._fieldsCache.delete(e),this._fieldsClone.delete(e),h.default.removeField.call(this,e),this._childChanged(l.prototype.removeField)},l.prototype.removeFieldAt=function(e){this._checkFormatIsWritable(),this._nextVersion();var t=this._getFormat(true).at(e);if(t)this._fieldsCache.delete(t.getName()),this._fieldsClone.delete(t.getName());h.default.removeFieldAt.call(this,e),this._childChanged(l.prototype.removeFieldAt)},l.prototype._hasFormat=function(){var e=this.getOwner();if(e)return e._hasFormat();else return h.default._hasFormat.call(this)},l.prototype._getFormat=function(e){var t=this.getOwner();if(t)return t._getFormat(e);else return h.default._getFormat.call(this,e)},l.prototype._getFieldFormat=function(e,t){var r=this.getOwner();if(r)return r._getFieldFormat(e,t);else return h.default._getFieldFormat.call(this,e,t)},l.prototype._createRawDataAdapter=function(){return this._getAdapter().forRecord(this._getRawData(true))},l.prototype._checkFormatIsWritable=function(){var e;if(this.getOwner())throw new Error("Record format has read only access if record belongs to recordset. You should change recordset format instead.")},l.prototype.isChanged=function(e){return e?this._hasChangedField(e):this.getChanged().length>0},l.prototype.getOwner=function(){return this._$owner},l.prototype.detach=function(){this._$owner=null,this.setState(E.DETACHED)},l.prototype.getState=function(){return this._$state},l.prototype.setState=function(e){this._$state=e},l.prototype.getChanged=function(){return Object.keys(this._changedFields)},l.prototype.acceptChanges=function(e,t){var r=this;if(void 0===t&&"boolean"===typeof e)t=e,e=void 0;if(void 0===e)this._clearChangedFields();else{if(!(e instanceof Array))throw new TypeError('Argument "fields" should be an instance of Array');e.forEach(function(e){r._unsetChangedField(e)})}if(0===this.getChanged().length)switch(this._$state){case E.ADDED:case E.CHANGED:this._$state=E.UNCHANGED;break;case E.DELETED:this._$state=E.DETACHED}if(this._acceptedState=this._$state,t)this._childChanged(l.prototype.acceptChanges)},l.prototype.rejectChanges=function(e,t){var r=this;if(void 0===t&&"boolean"===typeof e)t=e,e=void 0;var i={};if(void 0===e)e=this.getChanged();else if(!(e instanceof Array))throw new TypeError('Argument "fields" should be an instance of Array');for(var a in e.forEach(function(e){if(r._hasChangedField(e))i[e]=r._getChangedFieldValue(e)}),this.set(i),i)if(i.hasOwnProperty(a))this._unsetChangedField(a);if(0===this.getChanged().length)this._$state=this._acceptedState;if(t)this._childChanged(l.prototype.rejectChanges)},l.prototype.toString=function(){var r={};return this.each(function(e,t){r[e]=t}),JSON.stringify(r)},l.prototype._getRelationNameForField=function(e){return R+e},l.prototype._getFieldFromRelationName=function(e){if((e+="").substr(0,R.length)===R)return e.substr(R.length)},l.prototype._checkErrors=function(e){if(e.length){for(var t=e[0],r=e.length;r>0;r--)if(t>e[r])t=e[r];throw t}},l.prototype._getHashMap=function(e,t){var r=e;if(!(r instanceof Object))(r={})[e]=t;return r},l.prototype._clearFieldsCache=function(){this[w]=null,this[T]=null},l.prototype._isFieldValueCacheable=function(e){switch(this._$cacheMode){case A:return e instanceof Object;case O:return true}return false},l.prototype._haveToClone=function(e){return this._$cloneChanged&&e&&e["[Types/_entity/ICloneable]"]},l.prototype._getRawDataValue=function(e){var t=this._getRawDataAdapter();if(!t.has(e))return;var r=t.get(e),i=this._getFieldFormat(e,t);return p.default.cast(r,this._getFieldType(i),{format:i,adapter:this._getAdapter()})},l.prototype._setRawDataValue=function(e,t,r){if(!r&&t&&t["[Types/_entity/FormattableMixin]"])this._checkAdapterCompatibility(t.getAdapter());var i=this._getRawDataAdapter();return t=p.default.serialize(t,{format:this._getFieldFormat(e,i),adapter:this.getAdapter()}),i.set(e,t),t},l.prototype._notifyChange=function(e){e=e||{},this._childChanged(e),this._nextVersion(),this._notify("onPropertyChange",e)},l.prototype._clearChangedFields=function(){this[D]={}},l.prototype._hasChangedField=function(e){return this._changedFields.hasOwnProperty(e)},l.prototype._getChangedFieldValue=function(e){return this._changedFields[e]},l.prototype._setChangedField=function(e,t,r){if(!this[D].hasOwnProperty(e))this[D][e]=[t,Boolean(r)];switch(this._$state){case E.UNCHANGED:this._$state=E.CHANGED}},l.prototype._unsetChangedField=function(e){delete this[D][e]},Object.defineProperty(l,"RecordState",{get:function(){return E},enumerable:true,configurable:true}),Object.defineProperty(l,"CACHE_MODE_OBJECTS",{get:function(){return A},enumerable:true,configurable:true}),Object.defineProperty(l,"CACHE_MODE_ALL",{get:function(){return O},enumerable:true,configurable:true}),l.addFieldTo=function(e,t,r,i){if(!i){if(!((i=v(r))instanceof Object))i={type:i};i.name=t}e.addField(i,void 0,r)},l.fromObject=function(e,t){if(null===e)return e;if(e&&e instanceof l)return e;var r=new l({adapter:t||"Types/entity:adapter.Json",format:[]}),i=[];for(var a in e)if(e.hasOwnProperty(a))i.push(a);for(var n=0,o=(i=i.sort()).length;n<o;n++){var a,s=e[a=i[n]];if(void 0===s)continue;l.addFieldTo(r,a,s)}return r},l.filter=function(i,a){var n=new l({adapter:i.getAdapter()}),e;return i.getFormat().each(function(e){var t=e.getName(),r=i.get(t);if(!a||a(t,r))n.addField(e),n.set(t,r)}),n.acceptChanges(),n},l.filterFields=function(e,t){if(!(t instanceof Array))throw new TypeError('Argument "fields" should be an instance of Array');return l.filter(e,function(e){return t.indexOf(e)>-1})},l.extend=function(e,t){return g.logger.info("Types/entity:Record","Method extend is deprecated, use ES6 extends or Core/core-extend"),C(this,e,t)},l}(y.mixin(a.default,n.default,o.default,s.default,l.default,c.default,d.default,h.default,u.default));(t.default=S).prototype["[Types/_entity/Record]"]=true,S.prototype["[Types/_collection/IEnumerable]"]=true,S.prototype["[Types/_entity/ICloneable]"]=true,S.prototype["[Types/_entity/IEquatable]"]=true,S.prototype["[Types/_entity/IObject]"]=true,S.prototype["[Types/_entity/IObservableObject]"]=true,S.prototype["[Types/_entity/IProducible]"]=true,S.prototype["[Types/_entity/IVersionable]"]=true,S.prototype["[Types/_entity/relation/IReceiver]"]=true,S.prototype._moduleName="Types/entity:Record",S.prototype[D]=null,S.prototype._$state=E.DETACHED,S.prototype._$cacheMode=A,S.prototype._$cloneChanged=false,S.prototype._$owner=null,S.prototype._acceptedState=void 0,S.prototype["[WS.Data/Entity/Record]"]=true,S.prototype["[WS.Data/Collection/IEnumerable]"]=true,S.prototype["[WS.Data/Entity/ICloneable]"]=true,f.register("Types/entity:Record",S,{instantiate:false})});