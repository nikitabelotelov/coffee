define("Types/_entity/factory",["require","exports","Types/_entity/format","Types/_entity/TimeInterval","Types/di","Types/formatter","Core/defaultRenders"],function(e,t,r,c,o,u,f){"use strict";Object.defineProperty(t,"__esModule",{value:true});var l=/[+-][:0-9]+$/;function n(e){return(e instanceof r.DictionaryField?e.getDictionary():e.meta&&e.meta.dictionary)||[]}function a(e,t){var r=n(t.format);if(null===e&&!r.hasOwnProperty(e))return true;else if(void 0===e)return true;return false}function d(e,t,r){if(void 0===t||null===t){switch(e){case"identity":return false;case"enum":return a(t,r)}if("function"===typeof e){var n=Object.create(e.prototype);if(n&&n["[Types/_collection/IEnum]"])return a(t,r)}return true}return false}function y(e){if(Array.isArray(e)&&e.length<2)return e.length?e[0]:null;return e}function p(e){var t;if("object"===typeof e)t=e instanceof r.Field?e.getType():e.type;else t=e;return(""+t).toLowerCase()}function m(e){if(!e)return false;return e instanceof r.DateTimeField?e.isWithoutTimeZone():e.meta&&e.meta.withoutTimeZone}function T(e){if(!e)return false;return e instanceof r.MoneyField?e.isLarge():e.meta&&e.meta.large}function _(e){if(!e)return 0;return(e.getPrecision?e.getPrecision():e.meta&&e.meta.precision)||0}function D(e){return(e.getKind?e.getKind():e.meta&&e.meta.kind)||""}function E(t){var r=[];return t.each(function(e){r.push(t.get(e))}),r}function g(e){for(var t="Types/entity:adapter.Json",r=e.getCount(),n,a=0;a<r;a++)if((n=e.at(a))&&n["[Types/_entity/IObject]"]&&n["[Types/_entity/FormattableMixin]"]){t=n.getAdapter();break}for(var i=o.create("Types/collection:RecordSet",{adapter:t}),a=0;a<r;a++)i.add(e.at(a));return i.getRawData(true)}var i={"[Types/_entity/factory]":true,cast:function(e,t,r){var n=this;if(d(t,e,r=r||{}))return e;if("string"===typeof t)switch(t=t.toLowerCase()){case"recordset":t=o.resolve(o.isRegistered("collection.$recordset")?"collection.$recordset":"Types/collection:RecordSet");break;case"record":t=o.resolve(o.isRegistered("entity.$model")?"entity.$model":"Types/entity:Model");break;case"enum":t=o.resolve("Types/collection:Enum");break;case"flags":t=o.resolve("Types/collection:Flags");break;case"link":case"integer":return"number"===typeof e?e:isNaN(parseInt(e,10))?null:parseInt(e,10);case"real":case"double":return"number"===typeof e?e:isNaN(parseFloat(e))?null:parseFloat(e);case"boolean":return!!e;case"money":if(!T(r.format)){var a=_(r.format);if(a>3)return f.real(e,a,false,true)}return void 0===e?null:e;case"date":case"time":case"datetime":if(e instanceof Date)return e;else if("infinity"===e)return 1/0;else if("-infinity"===e)return-1/0;if((e=u.dateFromSql(""+e)).setSQLSerializationMode)switch(t){case"date":e.setSQLSerializationMode(Date.SQL_SERIALIZE_MODE_DATE);break;case"time":e.setSQLSerializationMode(Date.SQL_SERIALIZE_MODE_TIME);break;case"datetime":e.setSQLSerializationMode(Date.SQL_SERIALIZE_MODE_DATETIME)}return e;case"timeinterval":if(e instanceof c.default)return e.toString();return c.default.toString(e);case"array":var i=D(r.format);if(!(e instanceof Array))e=[e];return e.map(function(e){return n.cast(e,i,r)},this);default:return e}if("function"===typeof t){if(e instanceof t)return e;if(t.prototype["[Types/_entity/IProducible]"])return t.produceInstance(e,r);return new t(e)}throw new TypeError("Unknown type "+t)},serialize:function(e,t){var r=this,n=p((t=t||{}).format);if(d(n,e,t))return e;if(e&&"object"===typeof e)if(e["[Types/_entity/FormattableMixin]"])e=e.getRawData(true);else if(e["[Types/_collection/IFlags]"])e=E(e);else if(e["[Types/_collection/IEnum]"])e=e.get();else if(e["[Types/_collection/IList]"]&&"recordset"===n)e=g(e);else if("Deprecated/Record"===e._moduleName)throw new TypeError('Deprecated/Record can\'t be used with "Data"');else if("Deprecated/RecordSet"===e._moduleName)throw new TypeError('Deprecated/RecordSet can\'t be used with "Data"');else if("Deprecated/Enum"===e._moduleName)throw new TypeError('Deprecated/Enum can\'t be used with "Data"');switch(n){case"integer":return"number"===typeof(e=y(e))?e:isNaN(e-=0)?null:parseInt(e,10);case"real":case"double":return y(e);case"link":return parseInt(e,10);case"money":if(e=y(e),!T(t.format)){var a=_(t.format);if(a>3)return f.real(e,a,false,true)}return e;case"date":case"time":case"datetime":e=y(e);var i=u.TO_SQL_MODE.DATE,o=false;switch(n){case"datetime":i=u.TO_SQL_MODE.DATETIME,o=m(t.format);break;case"time":i=u.TO_SQL_MODE.TIME}if(!e)e=u.dateFromSql(""+e);if(e instanceof Date){if(e=u.dateToSql(e,i),o)e=e.replace(l,"")}else if(e===1/0)return"infinity";else if(e===-1/0)return"-infinity";return e;case"timeinterval":if((e=y(e))instanceof c.default)return e.toString();return c.default.toString(e);case"array":var s=D(t.format);if(!(e instanceof Array))e=[e];return e.map(function(e){return r.serialize(e,{format:s})},this);default:return e}}};t.default=i});