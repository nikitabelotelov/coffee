define("Types/_entity/adapter/SbisFormatMixin",["require","exports","Types/_entity/adapter/SbisFieldType","Types/_entity/factory","Types/_entity/format","Types/shim","Types/util"],function(e,t,s,a,n,r,d){"use strict";Object.defineProperty(t,"__esModule",{value:true});var i=Object.keys(s.default).reduce(function(e,t){return e[s.default[t]]=t,e},{}),o="undefined"===typeof Symbol?void 0:Symbol("fieldIndices");function l(e){return i[e]||"string"}function f(e){return s.default[(e+"").toLowerCase()]}var h={"[Types/_entity/adapter/SbisFormatMixin]":true,_data:null,_type:"",_fieldIndices:null,_format:null,_sharedFieldFormat:null,_sharedFieldMeta:null,constructor:function(e){if(e&&e._type&&e._type!==this._type)throw new TypeError('Argument "data" has "'+e._type+'" type signature but "'+this._type+'" expected.');if(o&&e&&e.s)e.s[o]=null;this._data=e,this._format={}},getData:function(){return this._data},getFields:function(){var e=[];if(this._isValidData())for(var t=0,i=this._data.s.length;t<i;t++)e.push(this._data.s[t].n);return e},clear:function(){this._touchData(),this._data.d.length=0},getFormat:function(e){if(!this._has(e))throw new ReferenceError(this._moduleName+'::getFormat(): field "'+e+"\" doesn't exist");if(!this._format.hasOwnProperty(e))this._format[e]=this._buildFormat(e);return this._format[e]},getSharedFormat:function(e){var t=this._sharedFieldFormat||(this._sharedFieldFormat=new n.UniversalField),i=this._getFieldIndex(e);if(-1===i)throw new ReferenceError(this._moduleName+'::getSharedFormat(): field "'+e+"\" doesn't exist");return t.name=e,t.type=this._getFieldType(i),t.meta=this._getFieldMeta(i,t.type,true),t},addField:function(e,t){if(!e||!(e instanceof n.Field))throw new TypeError(this._moduleName+"::addField(): format should be an instance of Types/entity:format.Field");var i=e.getName();if(this._has(i))throw new ReferenceError(this._moduleName+'::addField(): field "'+i+'" already exists');if(this._touchData(),void 0===t)t=this._data.s.length;this._checkFieldIndex(t,true),this._format[i]=e,this._resetFieldIndices(),this._data.s.splice(t,0,this._buildS(e)),this._buildD(t,a.default.serialize(e.getDefaultValue(),{format:e}))},removeField:function(e){this._touchData();var t=this._getFieldIndex(e);if(-1===t)throw new ReferenceError(this._moduleName+'::removeField(): field "'+e+"\" doesn't exist");delete this._format[e],this._resetFieldIndices(),this._data.s.splice(t,1),this._removeD(t)},removeFieldAt:function(e){this._touchData(),this._checkFieldIndex(e);var t=this._data.s[e].n;delete this._format[t],this._resetFieldIndices(),this._data.s.splice(e,1),this._removeD(e)},_touchData:function(){this._data=this._normalizeData(this._data,this._type)},_normalizeData:function(e,t){if(!(e instanceof Object))e={};if(!(e.d instanceof Array))e.d=[];if(!(e.s instanceof Array))e.s=[];return e._type=t,e},_cloneData:function(e){var t=d.object.clone(this._data);if(e&&t&&t.s)t.s=this._data.s;return t},_isValidData:function(){return this._data&&this._data.s instanceof Array},_has:function(e){return this._getFieldIndex(e)>=0},_getFieldIndex:function(e){if(!this._isValidData())return-1;var t=this._data.s,i=o?t[o]:this._fieldIndices;if(!o&&i&&this._fieldIndices["[{s}]"]!==t)i=null;if(!i){if(i=new r.Map,o)t[o]=i;else this._fieldIndices=i,this._fieldIndices["[{s}]"]=t;for(var a=0,n=t.length;a<n;a++)i.set(t[a].n,a)}return i.has(e)?i.get(e):-1},_resetFieldIndices:function(){if(this._isValidData())if(o)this._data.s[o]=null;else this._fieldIndices=null},_checkFieldIndex:function(e,t){var i=this._data.s.length-1;if(t)i++;if(!(e>=0&&e<=i))throw new RangeError(this._moduleName+': field index "'+e+'" is out of bounds.')},_getFieldType:function(e){var t,i=this._data.s[e].t;if(i&&i instanceof Object)i=i.n;return l(i)},_getFieldMeta:function(e,t,i){if(i&&null===this._sharedFieldMeta)this._sharedFieldMeta={};var a=this._data.s[e],n=i?this._sharedFieldMeta:{};switch(t){case"real":n.precision=a.t.p;break;case"money":if(n.precision=void 0,"object"===typeof a.t&&"p"in a.t)n.precision=a.t.p;n.large=!!a.t.l;break;case"enum":case"flags":n.dictionary=a.t.s,n.localeDictionary=a.t.sl;break;case"datetime":n.withoutTimeZone=a.t&&a.t.n&&"tz"in a.t?!a.t.tz:false;break;case"identity":n.separator=",";break;case"array":n.kind=l(a.t.t),Object.assign(n,this._getFieldMeta(e,n.kind))}return n},_checkFormat:function(e,t){var i=this._isValidData()?this._data.s:[],a=e?e.s||[]:[],n=i.length,s;if(i===a)return;if(t=t||"",n!==a.length)s=n+" columns expected instead of "+a.length;else for(var r=0;r<n;r++)if(s=this._checkFormatColumns(i[r],a[r]||{},r))break;if(s)d.logger.info(this._moduleName+t+": the formats are not equal ("+s+")")},_checkFormatColumns:function(e,t,i){if(e.n!==t.n)return'field with name "'+e.n+'" at position '+i+' expected instead of "'+t.n+'"';var a=e.t,n;if(a&&a.n)a=a.n;if((n=t.t)&&n.n)n=n.n;if(a!==n)return'expected field type for "'+e.n+'" at position '+i+' is "'+a+'" instead of "'+n+'"'},_buildFormatDeclaration:function(e){var t=this._getFieldIndex(e),i=this._getFieldType(t),a=this._getFieldMeta(t,i);return a.name=e,a.type=i,a},_buildFormat:function(e){return n.fieldsFactory(this._buildFormatDeclaration(e))},_buildS:function(e){var t={n:e.getName()};return this._buildSType(t,e),t},_buildSType:function(e,t){var i=(t.getTypeName()+"").toLowerCase();switch(i){case"money":if(t.isLarge())e.t={n:s.default[i],l:true};else e.t=s.default[i];break;case"enum":case"flags":var a=t.getDictionary();if(a instanceof Array)a=a.reduce(function(e,t,i){return e[i]=t,e},{});e.t={n:s.default[i],s:a};break;case"datetime":var n=t.isWithoutTimeZone();if(n)e.t={n:s.default[i],tz:!n};else e.t=s.default[i];break;case"array":e.t={n:s.default[i],t:f(t.getKind())};break;default:e.t=s.default[i]}},_buildD:function(){throw new Error("Method must be implemented")},_removeD:function(){throw new Error("Method must be implemented")}};t.default=h});