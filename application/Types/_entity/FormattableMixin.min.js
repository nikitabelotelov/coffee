define("Types/_entity/FormattableMixin",["require","exports","Types/_entity/format","Types/_entity/adapter","Types/di","Types/util"],function(t,e,o,a,n,i){"use strict";Object.defineProperty(e,"__esModule",{value:true});var r="Types/entity:adapter.Json";function s(t,e){var a,r;for(var i in t){if(!t.hasOwnProperty(i))continue;if("object"!==typeof(a=t[i]))a={type:a};if(!(a instanceof o.Field))a=o.fieldsFactory(a);if(a.setName(i),-1===(r=e.getFieldIndex(i)))e.add(a);else e.replace(a,r)}return e}function f(){for(var t=n.create("Types/collection:format.Format"),e=this._getRawDataAdapter(),a=this._getRawDataFields(),r=a.length,i=0;i<r;i++)t.add(e.getFormat(a[i]));return t}function _(){var e=this;if(this._hasFormat()){var a=this._getRawDataAdapter(),r=a.getFields();if(a["[Types/_entity/adapter/IDecorator]"])a=a.getOriginal();if(a._touchData)a._touchData();this._getFormat().each(function(t){try{if(-1===r.indexOf(t.getName()))a.addField(t)}catch(t){i.logger.info(e._moduleName+"::constructor(): can't add raw data field ("+t.message+")")}})}}var l={"[Types/_entity/FormattableMixin]":true,"[WS.Data/Entity/FormattableMixin]":true,_$rawData:null,_$cow:false,_$adapter:r,_$format:null,_format:null,_formatClone:null,_rawDataAdapter:null,_rawDataFields:null,constructor:function(){if(!this._$format&&this._options&&this._options.format)this._$format=this._options.format;_.call(this)},_getSerializableState:function(t){return t.$options.rawData=this._getRawData(),t},_setSerializableState:function(t){return function(){}},getRawData:function(t){return t?this._getRawData():i.object.clone(this._getRawData())},setRawData:function(t){this._resetRawDataAdapter(t),this._resetRawDataFields(),this._clearFormatClone(),_.call(this)},getAdapter:function(){var t=this._getAdapter();if(t["[Types/_entity/adapter/IDecorator]"])t=t.getOriginal();return t},getFormat:function(t){if(t)return this._getFormat(true);if(!this._formatClone)this._formatClone=this._getFormat(true).clone(true);return this._formatClone},addField:function(t,e){t=this._buildField(t),this._$format=this._getFormat(true),this._$format.add(t,e),this._getRawDataAdapter().addField(t,e),this._resetRawDataFields(),this._clearFormatClone()},removeField:function(t){this._$format=this._getFormat(true),this._$format.removeField(t),this._getRawDataAdapter().removeField(t),this._resetRawDataFields(),this._clearFormatClone()},removeFieldAt:function(t){this._$format=this._getFormat(true),this._$format.removeAt(t),this._getRawDataAdapter().removeFieldAt(t),this._resetRawDataFields(),this._clearFormatClone()},_getRawData:function(t){if(!t&&this._rawDataAdapter)return this._rawDataAdapter.getData();return"function"===typeof this._$rawData?this._$rawData():this._$rawData},_getDefaultAdapter:function(){return r},_getAdapter:function(){if(this._$adapter===r&&l._getDefaultAdapter!==this._getDefaultAdapter)this._$adapter=this._getDefaultAdapter();if(this._$adapter&&!(this._$adapter instanceof Object))this._$adapter=n.create(this._$adapter);if(this._$cow&&!this._$adapter["[Types/_entity/adapter/IDecorator]"])this._$adapter=new a.Cow(this._$adapter);return this._$adapter},_getRawDataAdapter:function(){if(!this._rawDataAdapter)this._rawDataAdapter=this._createRawDataAdapter();return this._rawDataAdapter},_createRawDataAdapter:function(){throw new Error("Method must be implemented")},_resetRawDataAdapter:function(t){if(void 0===t){if(this._rawDataAdapter&&"function"!==typeof this._$rawData)this._$rawData=this._rawDataAdapter.getData()}else this._$rawData=t;this._rawDataAdapter=null},_checkAdapterCompatibility:function(t){var e=this._getAdapter(),a;if(t["[Types/_entity/adapter/IDecorator]"])t=t.getOriginal();if(e["[Types/_entity/adapter/IDecorator]"])e=e.getOriginal();if(!Object.getPrototypeOf(e).isPrototypeOf(t))throw new TypeError('The foreign adapter "'+t._moduleName+'" is incompatible with the internal adapter "'+e._moduleName+'"')},_getRawDataFields:function(){return this._rawDataFields||(this._rawDataFields=this._getRawDataAdapter().getFields())},_addRawDataField:function(t){this._getRawDataFields().push(t)},_resetRawDataFields:function(){this._rawDataFields=null},_getFormat:function(t){var e=this;if(!this._format)if(this._hasFormat())this._format=this._$format=l._buildFormat(this._$format,function(){return f.call(e)});else if(t)this._format=f.call(this);return this._format},_clearFormat:function(){if(this._hasFormat())throw new Error(this._moduleName+": format can't be cleared because it's defined directly");this._format=null,this._clearFormatClone()},_clearFormatClone:function(){this._formatClone=null},_hasFormat:function(){return!!this._$format},_getFieldFormat:function(t,e){if(this._hasFormat()){var a=this._getFormat(),r=a.getFieldIndex(t);if(r>-1)return a.at(r)}return e.getSharedFormat(t)},_getFieldType:function(t){var e=t.getType?t.getType():t.type;if(e&&"string"===typeof e)if(n.isRegistered(e))e=n.resolve(e);return e},_buildField:function(t){if("string"===typeof t||Object.getPrototypeOf(t)===Object.prototype)t=o.fieldsFactory(t);if(!t||!(t instanceof o.Field))throw new TypeError(this._moduleName+": format should be an instance of Types/entity:format.Field");return t},_buildFormat:function(t,e){var a=n.resolve("Types/collection:format.Format");if(t){var r=Object.getPrototypeOf(t);if(r===Array.prototype){var i;t=n.resolve("Types/collection:format.factory")(t)}else if(r===Object.prototype)t=s(t,e?e():new a)}if(!t||!(t instanceof a))t=new a;return t}};e.default=l});