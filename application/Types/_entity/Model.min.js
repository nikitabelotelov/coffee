define("Types/_entity/Model",["require","exports","tslib","Types/_entity/Record","Types/_entity/InstantiableMixin","Types/_entity/functor","Types/di","Types/util","Types/shim"],function(s,e,t,n,r,h,o,a,c){"use strict";Object.defineProperty(e,"__esModule",{value:true});var p=".",i=function(d){function i(e){var t=d.call(this,e)||this;if(t._propertiesInjected=e&&"properties"in e,t._options){if(t._options.properties){var r={};Object.assign(r,t._$properties),Object.assign(r,t._options.properties),t._$properties=r}if(t._options.idProperty)t._$idProperty=t._options.idProperty}if(!t._$idProperty)t._$idProperty=t._getAdapter().getKeyField(t._getRawData())||"";return t}return t.__extends(i,d),i.fromObject=function(e,t){var r=n.default.fromObject(e,t);if(!r)return r;return new i({rawData:r.getRawData(true),adapter:r.getAdapter(),format:r._getFormat(true)})},i.extend=function(e,t){if(a.logger.info("Types/_entity/Model","Method extend is deprecated, use ES6 extends or Core/core-extend"),!s.defined("Core/core-extend"))throw new ReferenceError('You should require module "Core/core-extend" to use old-fashioned "Types/_entity/Model::extend()" method.');var r;return s("Core/core-extend")(this,e,t)},i.prototype.destroy=function(){this._defaultPropertiesValues=null,this._propertiesDependency=null,this._calculatingProperties=null,this._deepChangedProperties=null,d.prototype.destroy.call(this)},i.prototype.get=function(e){if(this._pushDependency(e),this._fieldsCache.has(e))return this._fieldsCache.get(e);var t=this._$properties&&this._$properties[e],r=d.prototype.get.call(this,e);if(!t)return r;var i=r;if("def"in t&&!this._getRawDataAdapter().has(e))i=this.getDefault(e);if(!t.get)return i;var s=this._processCalculatedValue(e,i,t,true);if(s!==r)this._removeChild(r),this._addChild(s,this._getRelationNameForField(e));if(this._isFieldValueCacheable(s))this._fieldsCache.set(e,s);else if(this._fieldsCache.has(e))this._fieldsCache.delete(e);return s},i.prototype.set=function(e,t){var i=this;if(!this._$properties)return void d.prototype.set.call(this,e,t);var s=this._getHashMap(e,t),n=[],o=[],r=this._calculatingProperties?this._calculatingProperties.size>0:false;Object.keys(s).forEach(function(e){i._deleteDependencyCache(e);var t=s[e];try{var r=i._$properties&&i._$properties[e];if(r)if(r.set){if(i._fieldsCache.has(e))i._removeChild(i._fieldsCache.get(e)),i._fieldsCache.delete(e);if(void 0===(t=i._processCalculatedValue(e,t,r,false)))return}else if(r.get)return void o.push(new ReferenceError('Property "'+e+'" is read only'));n.push([e,t,i._getRawDataValue(e)])}catch(e){o.push(e)}});var a=[],p=d.prototype._setPairs.call(this,n,a);if(r&&p)this._deepChangedProperties=this._deepChangedProperties||{},Object.assign(this._deepChangedProperties,p);else if(!r&&this._deepChangedProperties){if(p)Object.assign(this._deepChangedProperties,p);p=this._deepChangedProperties,this._deepChangedProperties=null}if(!r&&p){var l=Object.keys(p).reduce(function(e,t){return e[t]=i.get(t),e},{});this._notifyChange(l)}this._checkErrors(o.concat(a))},i.prototype.has=function(e){return this._$properties&&this._$properties.hasOwnProperty(e)||d.prototype.has.call(this,e)},i.prototype.getEnumerator=function(){return o.create("Types/collection:enumerator.Arraywise",this._getAllProperties())},i.prototype.each=function(e,t){return d.prototype.each.call(this,e,t)},i.prototype.relationChanged=function(i,e){var s=this,n=[],o=e.length-1;return e.forEach(function(e,t){var r=s._getFieldFromRelationName(e);if(n.push(r),r)if(s._deleteDependencyCache(n.join(p)),t===o&&i.data instanceof Object)Object.keys(i.data).forEach(function(e){s._deleteDependencyCache(n.concat([e]).join(p))})}),d.prototype.relationChanged.call(this,i,e)},i.prototype._getSerializableState=function(e){if(e=d.prototype._getSerializableState.call(this,e),!this._propertiesInjected)delete e.$options.properties;if(e._instanceId=this.getInstanceId(),e._isDeleted=this._isDeleted,this._defaultPropertiesValues)e._defaultPropertiesValues=this._defaultPropertiesValues;return e},i.prototype._setSerializableState=function(e){var t=d.prototype._setSerializableState.call(this,e);return function(){if(t.call(this),this._instanceId=e._instanceId,this._isDeleted=e._isDeleted,e._defaultPropertiesValues)this._defaultPropertiesValues=e._defaultPropertiesValues}},i.prototype.rejectChanges=function(e,t){if(d.prototype.rejectChanges.call(this,e,t),!(e instanceof Array))this._isChanged=false},i.prototype.acceptChanges=function(e,t){if(d.prototype.acceptChanges.call(this,e,t),!(e instanceof Array))this._isChanged=false},i.prototype.isChanged=function(e){if(!e&&this._isChanged)return true;return d.prototype.isChanged.call(this,e)},i.prototype.getProperties=function(){return this._$properties},i.prototype.getDefault=function(e){var t=this._defaultPropertiesValues;if(!t)t=this._defaultPropertiesValues={};if(!t.hasOwnProperty(e)){var r=this._$properties[e];if(r&&"def"in r)t[e]=[r.def instanceof Function?r.def.call(this):r.def];else t[e]=[]}return t[e][0]},i.prototype.merge=function(e){try{var r={};e.each(function(e,t){r[e]=t}),this.set(r)}catch(e){if(e instanceof ReferenceError)a.logger.info(this._moduleName+"::merge(): "+e.toString());else throw e}},i.prototype.getId=function(){var e=this.getIdProperty();if(!e)return void a.logger.info(this._moduleName+"::getId(): idProperty is not defined");return this.get(e)},i.prototype.getIdProperty=function(){return this._$idProperty},i.prototype.setIdProperty=function(e){if(e&&!this.has(e))return void a.logger.info(this._moduleName+'::setIdProperty(): property "'+e+'" is not defined');this._$idProperty=e},i.prototype._getAllProperties=function(){var e=this._getRawDataFields();if(!this._$properties)return e;var t=this._$properties,r;return Object.keys(t).concat(e.filter(function(e){return!t.hasOwnProperty(e)}))},i.prototype._processCalculatedValue=function(t,e,r,i){var s=this,n=this._calculatingProperties;if(!n)n=this._calculatingProperties=new c.Set;var o=t+"|"+i;if(n.has(o))throw new Error("Recursive value "+(i?"reading":"writing")+' detected for property "'+t+'"');var a=i?r.get:r.set,p=i&&h.Compute.isFunctor(a),l=i&&!p,d;if(i)d=this._propertiesDependencyGathering,this._propertiesDependencyGathering=l?t:"";if(p)a.properties.forEach(function(e){s._pushDependencyFor(e,t)});try{n.add(o),e=a.call(this,e)}finally{if(i)this._propertiesDependencyGathering=d;n.delete(o)}return e},i.prototype._pushDependency=function(e){if(this._propertiesDependencyGathering&&this._propertiesDependencyGathering!==e)this._pushDependencyFor(e,this._propertiesDependencyGathering)},i.prototype._pushDependencyFor=function(e,t){var r=this._propertiesDependency,i;if(!r)r=this._propertiesDependency=new c.Map;if(r.has(e))i=r.get(e);else i=new c.Set,r.set(e,i);if(!i.has(t))i.add(t)},i.prototype._deleteDependencyCache=function(e){var t=this,r=this._propertiesDependency;if(r&&r.has(e))r.get(e).forEach(function(e){t._removeChild(t._fieldsCache.get(e)),t._fieldsCache.delete(e),t._fieldsClone.delete(e),t._deleteDependencyCache(e)})},i}(a.mixin(n.default,r.default));e.default=i,Object.assign(i.prototype,{"[Types/_entity/Model]":true,"[Types/_entity/IInstantiable]":true,_moduleName:"Types/entity:Model",_instancePrefix:"model-",_$properties:null,_$idProperty:"",_isDeleted:false,_defaultPropertiesValues:null,_propertiesDependency:null,_propertiesDependencyGathering:"",_calculatingProperties:null,_deepChangedProperties:null}),i.prototype["[WS.Data/Entity/Model]"]=true,i.produceInstance=n.default.produceInstance,o.register("Types/entity:Model",i,{instantiate:false}),o.register("entity.model",i)});