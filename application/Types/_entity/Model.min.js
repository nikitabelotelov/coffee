define("Types/_entity/Model",["require","exports","tslib","Types/_entity/Record","Types/_entity/InstantiableMixin","Types/_entity/functor","Types/di","Types/util","Types/shim","Core/core-extend"],function(e,t,r,d,i,u,o,s,f,n){"use strict";Object.defineProperty(t,"__esModule",{value:true});var p=".",a=function(c){function i(e){var t=c.call(this,e)||this;if(t._propertiesInjected=e&&"properties"in e,t._options){if(t._options.properties){var r={};Object.assign(r,t._$properties),Object.assign(r,t._options.properties),t._$properties=r}if(t._options.idProperty)t._$idProperty=t._options.idProperty}if(!t._$idProperty)t._$idProperty=t._getAdapter().getKeyField(t._getRawData())||"";return t}return r.__extends(i,c),i.prototype.destroy=function(){this._defaultPropertiesValues=null,this._propertiesDependency=null,this._calculatingProperties=null,this._deepChangedProperties=null,c.prototype.destroy.call(this)},i.prototype.get=function(e){this._pushDependency(e);var t=this._calculatingProperties?this._calculatingProperties.has(e):false;if(!t&&this._fieldsCache.has(e))return this._fieldsCache.get(e);var r=this._$properties&&this._$properties[e],i=c.prototype.get.call(this,e);if(!r)return i;var o=i;if("def"in r&&!this._getRawDataAdapter().has(e))o=this.getDefault(e);if(!r.get)return o;var s=this._processCalculatedValue(e,o,r,true);if(s!==i)this._removeChild(i),this._addChild(s,this._getRelationNameForField(e));if(!t&&this._isFieldValueCacheable(s))this._fieldsCache.set(e,s);else if(this._fieldsCache.has(e))this._fieldsCache.delete(e);return s},i.prototype.set=function(e,t){var i=this,r;if(!this._$properties)return void c.prototype.set.call(this,e,t);var o=this._getHashMap(e,t),s=[],n=[],p=this._calculatingProperties?this._calculatingProperties.size>0:false;if(Object.keys(o).forEach(function(e){i._deleteDependencyCache(e);var t=o[e];try{var r=i._$properties&&i._$properties[e];if(r)if(r.set){if(i._fieldsCache.has(e))i._removeChild(i._fieldsCache.get(e)),i._fieldsCache.delete(e);if(void 0===(t=i._processCalculatedValue(e,t,r,false)))return}else if(r.get)return void n.push(new ReferenceError('Property "'+e+'" is read only'));s.push([e,t,d.default.prototype.get.call(i,e)])}catch(e){n.push(e)}}),p&&s.length)this._deepChangedProperties=this._deepChangedProperties||[],(r=this._deepChangedProperties).push.apply(r,s);else if(!p&&this._deepChangedProperties)s.push.apply(s,this._deepChangedProperties),this._deepChangedProperties.length=0;var a=[];if(!p){var l=c.prototype._setPairs.call(this,s,a);if(l){var h=Object.keys(l).reduce(function(e,t){return e[t]=i.get(t),e},{});this._notifyChange(h)}}this._checkErrors(n.concat(a))},i.prototype.has=function(e){return this._$properties&&this._$properties.hasOwnProperty(e)||c.prototype.has.call(this,e)},i.prototype.getEnumerator=function(){var e;return new(o.resolve("Types/collection:enumerator.Arraywise"))(this._getAllProperties())},i.prototype.each=function(e,t){return c.prototype.each.call(this,e,t)},i.prototype.relationChanged=function(i,e){var o=this,s=[],n=e.length-1;return e.forEach(function(e,t){var r=o._getFieldFromRelationName(e);if(s.push(r),r)if(o._deleteDependencyCache(s.join(p)),t===n&&i.data instanceof Object)Object.keys(i.data).forEach(function(e){o._deleteDependencyCache(s.concat([e]).join(p))})}),c.prototype.relationChanged.call(this,i,e)},i.prototype._getSerializableState=function(e){if(e=c.prototype._getSerializableState.call(this,e),!this._propertiesInjected)delete e.$options.properties;if(e._instanceId=this.getInstanceId(),e._isDeleted=this._isDeleted,this._defaultPropertiesValues)e._defaultPropertiesValues=this._defaultPropertiesValues;return e},i.prototype._setSerializableState=function(e){var t=c.prototype._setSerializableState.call(this,e);return function(){if(t.call(this),this._instanceId=e._instanceId,this._isDeleted=e._isDeleted,e._defaultPropertiesValues)this._defaultPropertiesValues=e._defaultPropertiesValues}},i.prototype.rejectChanges=function(e,t){if(c.prototype.rejectChanges.call(this,e,t),!(e instanceof Array))this._isChanged=false},i.prototype.acceptChanges=function(e,t){if(c.prototype.acceptChanges.call(this,e,t),!(e instanceof Array))this._isChanged=false},i.prototype.isChanged=function(e){if(!e&&this._isChanged)return true;return c.prototype.isChanged.call(this,e)},i.prototype.getProperties=function(){return this._$properties},i.prototype.getDefault=function(e){var t=this._defaultPropertiesValues;if(!t)t=this._defaultPropertiesValues={};if(!t.hasOwnProperty(e)){var r=this._$properties[e];if(r&&"def"in r)t[e]=[r.def instanceof Function?r.def.call(this):r.def];else t[e]=[]}return t[e][0]},i.prototype.merge=function(e){try{var r={};e.each(function(e,t){r[e]=t}),this.set(r)}catch(e){if(e instanceof ReferenceError)s.logger.info(this._moduleName+"::merge(): "+e.toString());else throw e}},i.prototype.getId=function(){var e=this.getIdProperty();if(!e)return void s.logger.info(this._moduleName+"::getId(): idProperty is not defined");return this.get(e)},i.prototype.getIdProperty=function(){return this._$idProperty},i.prototype.setIdProperty=function(e){if(e&&!this.has(e))return void s.logger.info(this._moduleName+'::setIdProperty(): property "'+e+'" is not defined');this._$idProperty=e},i.prototype._getAllProperties=function(){var e=this._getRawDataFields();if(!this._$properties)return e;var t=this._$properties,r;return Object.keys(t).concat(e.filter(function(e){return!t.hasOwnProperty(e)}))},i.prototype._processCalculatedValue=function(t,e,r,i){var o=this,s=this._calculatingProperties;if(!s)s=this._calculatingProperties=new f.Set;var n=t+"|"+i;if(s.has(n))throw new Error("Recursive value "+(i?"reading":"writing")+' detected for property "'+t+'"');var p=i?r.get:r.set,a=i&&u.Compute.isFunctor(p),l=i&&!a,h;if(i)h=this._propertiesDependencyGathering,this._propertiesDependencyGathering=l?t:"";if(a)p.properties.forEach(function(e){o._pushDependencyFor(e,t)});try{s.add(n),e=p.call(this,e)}finally{if(i)this._propertiesDependencyGathering=h;s.delete(n)}return e},i.prototype._pushDependency=function(e){if(this._propertiesDependencyGathering&&this._propertiesDependencyGathering!==e)this._pushDependencyFor(e,this._propertiesDependencyGathering)},i.prototype._pushDependencyFor=function(e,t){var r=this._propertiesDependency,i;if(!r)r=this._propertiesDependency=new f.Map;if(r.has(e))i=r.get(e);else i=new f.Set,r.set(e,i);if(!i.has(t))i.add(t)},i.prototype._deleteDependencyCache=function(e){var t=this,r=this._propertiesDependency;if(r&&r.has(e))r.get(e).forEach(function(e){t._removeChild(t._fieldsCache.get(e)),t._fieldsCache.delete(e),t._fieldsClone.delete(e),t._deleteDependencyCache(e)})},i.fromObject=function(e,t){var r=d.default.fromObject(e,t);if(!r)return r;return new i({rawData:r.getRawData(true),adapter:r.getAdapter(),format:r._getFormat(true)})},i.extend=function(e,t){return n(this,e,t)},i}(s.mixin(d.default,i.default));(t.default=a).prototype["[Types/_entity/Model]"]=true,a.prototype["[Types/_entity/IInstantiable]"]=true,a.prototype._moduleName="Types/entity:Model",a.prototype._instancePrefix="model-",a.prototype._$properties=null,a.prototype._$idProperty="",a.prototype._isDeleted=false,a.prototype._defaultPropertiesValues=null,a.prototype._propertiesDependency=null,a.prototype._propertiesDependencyGathering="",a.prototype._calculatingProperties=null,a.prototype._deepChangedProperties=null,a.prototype["[WS.Data/Entity/Model]"]=true,a.produceInstance=d.default.produceInstance,o.register("Types/entity:Model",a,{instantiate:false}),o.register("entity.model",a)});