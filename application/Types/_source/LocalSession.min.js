define("Types/_source/LocalSession",["require","exports","tslib","Types/_source/Query","Types/entity","Types/collection","Types/di","Types/util","Types/object","Browser/Storage","Core/Deferred"],function(e,t,n,i,u,f,a,r,s,o,p){"use strict";Object.defineProperty(t,"__esModule",{value:true});var c="d",d="i",h="k";function l(e,t){for(var r,n,o,i=0;i<t.length;i++)o=void 0===(n=(r=t[i])[e.getIdProperty()])?e.rawManager.reserveId():n,e.rawManager.set(o,r)}function y(e){if("string"===typeof e)return e.indexOf("Types/entity:adapter.Json")>-1||e.indexOf("adapter.json")>-1;return e instanceof u.adapter.Json}function g(e,t){if(!e)return{};var r=e,n=e&&e instanceof u.Record;if(!n&&y(t))return e;if(!n)r=new u.Record({adapter:t,rawData:e});var o={},i=r.getEnumerator();while(i.moveNext()){var a=i.getCurrent();o[a]=r.get(a)}return o}var v=function(){function o(){this.query=/(\w+)([!><=]*)/}return o.prototype.tokinize=function(e){var t=e.match(this.query),r,n;if(t.shift(),t.length>1)r=t.pop();switch(r){case"<":n=o.lt;break;case"<=":n=o.le;break;case">":n=o.gt;break;case">=":n=o.ge;break;case"!=":case"<>":n=o.ne;break;default:n=o.eq}return{field:t[0],op:n}},o.eq=function(e,t){if(!(t instanceof Array))return e==t;return-1!==t.indexOf(e)},o.ne=function(e,t){return e!=t},o.lt=function(e,t){return e<t},o.le=function(e,t){return e<=t},o.gt=function(e,t){return e>t},o.ge=function(e,t){return e>=t},o}(),w=function(){function r(e){this.tokenizer=new v,this.query=e}return r.prototype.select=function(e){var o=this.query.getSelect();if(0===Object.keys(o).length)return e;return e.map(function(e){for(var t={},r,n=0;n<o.length;n++)t[r=o[n]]=e[r];return t})},r.prototype.where=function(e){var r=this.query.getWhere(),a=[],n=new u.adapter.Json;if("function"===typeof r)return e.filter(function(e,t){return r(n.forRecord(e),t)});for(var t in r){if(!r.hasOwnProperty(t))continue;if(void 0===r[t])continue;var o=this.tokenizer.tokinize(t);if(void 0===o)return[];a.push({field:o.field,op:o.op,value:r[t]})}return e.filter(function(e){for(var t=0;t<a.length;t++){var r=a[t];if(e[r.field]instanceof Array){for(var n=false,o=0,i=e[r.field];o<i.length;o++)n=r.op(i,r.value);return n}if(!r.op(e[r.field],r.value))return false}return true})},r.prototype.order=function(e){var t=this.query.getOrderBy();if(t.length>0)return r.orderBy(e,t);return e},r.prototype.offset=function(e){if(!this.query.getOffset())return e;return e.slice(this.query.getOffset())},r.prototype.limit=function(e){if(void 0===this.query.getLimit())return e;return e.slice(0,this.query.getLimit())},r.orderBy=function(e,s){var t=e;function u(e,t){if(null===e&&null!==t)return-1;if(null!==e&&null===t)return 1;if(e===t)return 0;return e>t?1:-1}return t.sort(function(e,t){for(var r=0,n=0;n<s.length;n++){var o=s[n],i=o.getOrder()?-1:1,a=o.getSelector();if(0!==(r=i*u(e[a],t[a])))break}return r}),t},r}(),m=function(){function e(e){var t,r;if(this.ls=e,null===this.getCount())this.setCount(0);if(null===this.getKeys())this.setKeys([])}return e.prototype.get=function(e){return this.ls.getItem(c+e)},e.prototype.set=function(e,t){var r=this.getCount()+1,n=this.getKeys();if(-1===n.indexOf(e))n.push(e),this.setKeys(n),this.setCount(r);return this.ls.setItem(c+e,t)},e.prototype.move=function(e,t,r){var n=this.getKeys(),o;if(e.forEach(function(e){var t=n.indexOf(e);n.splice(t,1)}),null!==t)if(-1===(o=n.indexOf(t)))return p.fail('Record "to" with key '+t+" is not found.");var i=r&&(r.before||"before"===r.position)?0:1;e.forEach(function(e,t){n.splice(o+i+t,0,e)}),this.setKeys(n)},e.prototype.remove=function(e){var t;if(!(e instanceof Array))return t=this.getCount(),this.removeFromKeys(e),this.setCount(t-1),this.ls.removeItem(c+e);for(var r=0;r<e.length;r++){var n=e[r];t=this.getCount(),this.setCount(t-1),this.ls.removeItem(c+n)}return this.removeFromKeys(e),true},e.prototype.removeFromKeys=function(e){var t;if(e instanceof Array)t=e;else t=[e];for(var r=this.getKeys(),n=0;n<t.length;n++){var o=t[n],i=r.indexOf(o);if(-1===i)continue;r.splice(i,1)}this.setKeys(r)},e.prototype.getCount=function(){return this.ls.getItem(h)},e.prototype.setCount=function(e){this.ls.setItem(h,e)},e.prototype.getKeys=function(){return this.ls.getItem(d)},e.prototype.setKeys=function(e){this.ls.setItem(d,e)},e.prototype.existKeys=function(e){var t=this.getKeys();if(0===t.length)return false;if(e instanceof Array){for(var r=0;r<e.length;r++)if(t.indexOf(e[r])<=-1)return false;return true}return t.indexOf(e)>-1},e.prototype.reserveId=function(){function e(){function e(){return Math.floor(1903264*(1+Math.random())).toString(32).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()}var t;do{t=e()}while(this.existKeys(t));return t},e}(),M=function(){function e(e,t){this.adapter=e,this.idProperty=t}return e.prototype.get=function(e){switch(e=r.object.clonePlain(e,true),this.adapter){case"Types/entity:adapter.RecordSet":case"adapter.recordset":return new u.Model({rawData:new u.Record({rawData:e}),adapter:a.create(this.adapter),idProperty:this.idProperty});case"Types/entity:adapter.Sbis":case"adapter.sbis":return this.sbis(e);default:return new u.Model({rawData:e,adapter:a.create(this.adapter),idProperty:this.idProperty})}},e.prototype.sbis=function(e){var t=new u.Record({rawData:e}),r=t.getFormat(),n=t.getEnumerator(),o=new u.Model({format:r,adapter:a.create(this.adapter),idProperty:this.idProperty});while(n.moveNext()){var i=n.getCurrent();o.set(i,t.get(i))}return o},e}(),_=function(){function e(e,t,r){this.adapter=e,this.idProperty=t,this.modelManager=r}return e.prototype.get=function(e){switch(e=r.object.clonePlain(e,true),this.adapter){case"Types/entity:adapter.RecordSet":case"adapter.recordset":return this.recordSet(e);case"Types/entity:adapter.Sbis":case"adapter.sbis":return this.sbis(e);default:return e}},e.prototype.recordSet=function(e){var t=[];if(0===e.length)return new f.RecordSet({rawData:t,idProperty:this.idProperty});for(var r=0;r<e.length;r++){var n=e[r],o=this.modelManager.get(n);t.push(o)}return new f.RecordSet({rawData:t,idProperty:this.idProperty})},e.prototype.sbis=function(e){if(0===e.length)return e;for(var t=new f.RecordSet({adapter:this.adapter}),r=new u.Record({rawData:e[0]}).getFormat(),n=0;n<e.length;n++){var o=e[n],i=new u.Record({format:r,adapter:this.adapter}),a=i.getEnumerator();while(a.moveNext()){var s=a.getCurrent();i.set(s,o[s])}t.add(i)}return t.getRawData()},e}(),P=function(r){function e(e){var t=r.call(this)||this;if(t["[Types/_source/ICrud]"]=true,t["[Types/_source/ICrudPlus]"]=true,t["[Types/_source/IData]"]=true,!("prefix"in e))throw new Error('"prefix" not found in options.');if(!("idProperty"in e))throw new Error('"idProperty" not found in options.');return u.OptionsToPropertyMixin.call(t,e),t.rawManager=new m(new o.LocalStorage(e.prefix)),t.modelManager=new M(t._$adapter,t._$idProperty),t.converter=new _(t._$adapter,t._$idProperty,t.modelManager),t._initData(e.data),t}return n.__extends(e,r),e.prototype.create=function(e){var t=g(e,this._$adapter);if(void 0===t[this.getIdProperty()])this.rawManager.reserveId();return p.success(this.modelManager.get(t))},e.prototype.read=function(e,t){var r=this.rawManager.get(e);if(r)return p.success(this.modelManager.get(r));return p.fail('Record with key "'+e+'" does not exist')},e.prototype.update=function(e,t){var o=this,r=function(e){var t,r=e.getIdProperty?e.getIdProperty():o.getIdProperty();try{t=e.get(r)}catch(e){return p.fail("Record idProperty doesn't exist")}if(void 0===t)t=o.rawManager.reserveId();e.set(r,t);var n=g(e,o._$adapter);return o.rawManager.set(t,n),e.acceptChanges(),t},n=[];if(e instanceof f.RecordSet)e.each(function(e){n.push(r(e))});else n.push(r(e));return p.success(n)},e.prototype.destroy=function(e,t){var r;if(!this.rawManager.existKeys(e))return p.fail("Not all keys exist");return this.rawManager.remove(e),p.success(true)},e.prototype.query=function(e){if(void 0===e)e=new i.default;for(var t=[],r=this.rawManager.getKeys(),n=0;n<r.length;n++)t.push(this.rawManager.get(r[n]));var o=new w(e);return t=o.order(t),t=o.where(t),t=o.offset(t),t=o.limit(t),t=o.select(t),p.success(this._getDataSet({items:this.converter.get(t),meta:{total:t.length}}))},e.prototype.merge=function(e,t){var r=this.rawManager.get(e),n=this.rawManager.get(t);if(null===r||null===n)return p.fail("Record with key "+e+" or "+t+" isn't exists");var o=s.merge(r,n);return this.rawManager.set(e,o),this.rawManager.remove(t),p.success(true)},e.prototype.copy=function(e,t){var r=this.rawManager.reserveId(),n=this.rawManager.get(e);if(null===n)return p.fail("Record with key "+n+" isn't exists");var o=s.merge({},n);return this.rawManager.set(r,o),p.success(this.modelManager.get(o))},e.prototype.move=function(r,e,t){var n=this.rawManager.getKeys(),o=[];if(!(r instanceof Array))r=[r];if(r.forEach(function(e){var t;if(-1===n.indexOf(e))return p.fail('Record "items" with key "'+r+'" is not found.');o.push(e)}),"on"===t.position)return p.success(this._hierarchyMove(o,e,t,n));return p.success(this.rawManager.move(o,e,t))},e.prototype.getIdProperty=function(){return this._$idProperty},e.prototype.setIdProperty=function(e){throw new Error("Method is not supported")},e.prototype.getAdapter=function(){return a.create(this._$adapter)},e.prototype.getListModule=function(){return this._$listModule},e.prototype.setListModule=function(e){this._$listModule=e},e.prototype.getModel=function(){return this._$model},e.prototype.setModel=function(e){this._$model=e},e.prototype._initData=function(e){var t=this;if(!e)return;if(y(this._$adapter))return void l(this,e);for(var r=this.getAdapter().forTable(e),n=function(e){t.update(e)},o=0;o<r.getCount();o++){var i=r.at(o);this.create(i).addCallback(n)}},e.prototype._getDataSet=function(e){return a.create(this._dataSetModule,n.__assign({writable:this._writable,adapter:this.getAdapter(),model:this.getModel(),listModule:this.getListModule(),idProperty:this.getIdProperty()},{rawData:e,itemsProperty:this._dataSetItemsProperty,metaProperty:this._dataSetMetaProperty}))},e.prototype._hierarchyMove=function(e,t,r,n){var o=this,i,a;if(!r.parentProperty)return p.fail("Parent property is not defined");if(t){if(-1===(i=n.indexOf(t)))return p.fail('Record "to" with key '+t+" is not found.");var s=this.rawManager.get(n[i]);a=s[r.parentProperty]}else a=null;e.forEach(function(e){var t=o.rawManager.get(e);t[r.parentProperty]=a,o.rawManager.set(e,t)})},e.prototype._reorderMove=function(e,t,r,n){var o;if(e.forEach(function(e){var t=n.indexOf(e);n.splice(t,1)}),null!==t)if(-1===(o=n.indexOf(t)))return p.fail('Record "to" with key '+t+" is not found.");var i=r&&(r.before||"before"===r.position)?0:1;e.forEach(function(e,t){n.splice(o+i+t,0,e)}),this.rawManager.setKeys(n)},e}(r.mixin(u.DestroyableMixin,u.OptionsToPropertyMixin));t.default=P,Object.assign(P.prototype,{"[Types/_source/LocalSession]":true,_moduleName:"Types/source:LocalSession",_writable:u.ReadWriteMixin.writable,_dataSetModule:"Types/source:DataSet",_$adapter:"Types/entity:adapter.Json",_$listModule:"Types/collection:RecordSet",_$model:"Types/entity:Model",_$idProperty:"",_dataSetItemsProperty:"items",_dataSetMetaProperty:"meta",_options:{prefix:"",model:u.Model,data:[]}}),a.register("Types/source:LocalSession",P,{instantiate:false})});