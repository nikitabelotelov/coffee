define("Types/_source/LocalSession",["require","exports","tslib","Types/_source/Query","Types/entity","Types/collection","Types/di","Types/util","Core/core-merge","Core/Deferred","Lib/Storage/LocalStorage"],function(e,t,o,i,u,p,a,r,s,f,n){"use strict";Object.defineProperty(t,"__esModule",{value:true});var c="d",d="i",y="k";function l(e,t){for(var r,o,n,i=0;i<t.length;i++)n=void 0===(o=(r=t[i])[e.getIdProperty()])?e.rawManager.reserveId():o,e.rawManager.set(n,r)}function h(e){if("string"===typeof e)return e.indexOf("Types/entity:adapter.Json")>-1||e.indexOf("adapter.json")>-1;return e instanceof u.adapter.Json}function g(e,t){if(!e)return{};var r=e,o=e&&e instanceof u.Record;if(!o&&h(t))return e;if(!o)r=new u.Record({adapter:t,rawData:e});var n={},i=r.getEnumerator();while(i.moveNext()){var a=i.getCurrent();n[a]=r.get(a)}return n}var v=function(){function n(){this.query=/(\w+)([!><=]*)/}return n.prototype.tokinize=function(e){var t=e.match(this.query),r,o;if(t.shift(),t.length>1)r=t.pop();switch(r){case"<":o=n.lt;break;case"<=":o=n.le;break;case">":o=n.gt;break;case">=":o=n.ge;break;case"!=":case"<>":o=n.ne;break;default:o=n.eq}return{field:t[0],op:o}},n.eq=function(e,t){if(!(t instanceof Array))return e==t;return-1!==t.indexOf(e)},n.ne=function(e,t){return e!=t},n.lt=function(e,t){return e<t},n.le=function(e,t){return e<=t},n.gt=function(e,t){return e>t},n.ge=function(e,t){return e>=t},n}(),w=function(){function r(e){this.tokenizer=new v,this.query=e}return r.prototype.select=function(e){var n=this.query.getSelect();if(0===Object.keys(n).length)return e;return e.map(function(e){for(var t={},r,o=0;o<n.length;o++)t[r=n[o]]=e[r];return t})},r.prototype.where=function(e){var r=this.query.getWhere(),a=[],o=new u.adapter.Json;if("function"===typeof r)return e.filter(function(e,t){return r(o.forRecord(e),t)});for(var t in r){if(!r.hasOwnProperty(t))continue;if(void 0===r[t])continue;var n=this.tokenizer.tokinize(t);if(void 0===n)return[];a.push({field:n.field,op:n.op,value:r[t]})}return e.filter(function(e){for(var t=0;t<a.length;t++){var r=a[t];if(e[r.field]instanceof Array){for(var o=false,n=0,i=e[r.field];n<i.length;n++)o=r.op(i,r.value);return o}if(!r.op(e[r.field],r.value))return false}return true})},r.prototype.order=function(e){var t=this.query.getOrderBy();if(t.length>0)return r.orderBy(e,t);return e},r.prototype.offset=function(e){if(!this.query.getOffset())return e;return e.slice(this.query.getOffset())},r.prototype.limit=function(e){if(void 0===this.query.getLimit())return e;return e.slice(0,this.query.getLimit())},r.orderBy=function(e,s){var t=e;function u(e,t){if(null===e&&null!==t)return-1;if(null!==e&&null===t)return 1;if(e===t)return 0;return e>t?1:-1}return t.sort(function(e,t){for(var r=0,o=0;o<s.length;o++){var n=s[o],i=n.getOrder()?-1:1,a=n.getSelector();if(0!==(r=i*u(e[a],t[a])))break}return r}),t},r}(),m=function(){function e(e){var t,r;if(this.ls=e,null===this.getCount())this.setCount(0);if(null===this.getKeys())this.setKeys([])}return e.prototype.get=function(e){return this.ls.getItem(c+e)},e.prototype.set=function(e,t){var r=this.getCount()+1,o=this.getKeys();if(-1===o.indexOf(e))o.push(e),this.setKeys(o),this.setCount(r);return this.ls.setItem(c+e,t)},e.prototype.move=function(e,t,r){var o=this.getKeys(),n;if(e.forEach(function(e){var t=o.indexOf(e);o.splice(t,1)}),null!==t)if(-1===(n=o.indexOf(t)))return f.fail('Record "to" with key '+t+" is not found.");var i=r&&(r.before||"before"===r.position)?0:1;e.forEach(function(e,t){o.splice(n+i+t,0,e)}),this.setKeys(o)},e.prototype.remove=function(e){var t;if(!(e instanceof Array))return t=this.getCount(),this.removeFromKeys(e),this.setCount(t-1),this.ls.removeItem(c+e);for(var r=0;r<e.length;r++){var o=e[r];t=this.getCount(),this.setCount(t-1),this.ls.removeItem(c+o)}return this.removeFromKeys(e),true},e.prototype.removeFromKeys=function(e){var t;if(e instanceof Array)t=e;else t=[e];for(var r=this.getKeys(),o=0;o<t.length;o++){var n=t[o],i=r.indexOf(n);if(-1===i)continue;r.splice(i,1)}this.setKeys(r)},e.prototype.getCount=function(){return this.ls.getItem(y)},e.prototype.setCount=function(e){this.ls.setItem(y,e)},e.prototype.getKeys=function(){return this.ls.getItem(d)},e.prototype.setKeys=function(e){this.ls.setItem(d,e)},e.prototype.existKeys=function(e){var t=this.getKeys();if(0===t.length)return false;if(e instanceof Array){for(var r=0;r<e.length;r++)if(t.indexOf(e[r])<=-1)return false;return true}return t.indexOf(e)>-1},e.prototype.reserveId=function(){function e(){function e(){return Math.floor(1903264*(1+Math.random())).toString(32).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()}var t;do{t=e()}while(this.existKeys(t));return t},e}(),M=function(){function e(e,t){this.adapter=e,this.idProperty=t}return e.prototype.get=function(e){switch(e=r.object.clonePlain(e,true),this.adapter){case"Types/entity:adapter.RecordSet":case"adapter.recordset":return new u.Model({rawData:new u.Record({rawData:e}),adapter:a.create(this.adapter),idProperty:this.idProperty});case"Types/entity:adapter.Sbis":case"adapter.sbis":return this.sbis(e);default:return new u.Model({rawData:e,adapter:a.create(this.adapter),idProperty:this.idProperty})}},e.prototype.sbis=function(e){var t=new u.Record({rawData:e}),r=t.getFormat(),o=t.getEnumerator(),n=new u.Model({format:r,adapter:a.create(this.adapter),idProperty:this.idProperty});while(o.moveNext()){var i=o.getCurrent();n.set(i,t.get(i))}return n},e}(),P=function(){function e(e,t,r){this.adapter=e,this.idProperty=t,this.modelManager=r}return e.prototype.get=function(e){switch(e=r.object.clonePlain(e,true),this.adapter){case"Types/entity:adapter.RecordSet":case"adapter.recordset":return this.recordSet(e);case"Types/entity:adapter.Sbis":case"adapter.sbis":return this.sbis(e);default:return e}},e.prototype.recordSet=function(e){var t=[];if(0===e.length)return new p.RecordSet({rawData:t,idProperty:this.idProperty});for(var r=0;r<e.length;r++){var o=e[r],n=this.modelManager.get(o);t.push(n)}return new p.RecordSet({rawData:t,idProperty:this.idProperty})},e.prototype.sbis=function(e){if(0===e.length)return e;for(var t=new p.RecordSet({adapter:this.adapter}),r=new u.Record({rawData:e[0]}).getFormat(),o=0;o<e.length;o++){var n=e[o],i=new u.Record({format:r,adapter:this.adapter}),a=i.getEnumerator();while(a.moveNext()){var s=a.getCurrent();i.set(s,n[s])}t.add(i)}return t.getRawData()},e}(),_=function(r){function e(e){var t=r.call(this)||this;if(t["[Types/_source/ICrud]"]=true,t["[Types/_source/ICrudPlus]"]=true,t["[Types/_source/IData]"]=true,!("prefix"in e))throw new Error('"prefix" not found in options.');if(!("idProperty"in e))throw new Error('"idProperty" not found in options.');return u.OptionsToPropertyMixin.call(t,e),t.rawManager=new m(new n(e.prefix)),t.modelManager=new M(t._$adapter,t._$idProperty),t.converter=new P(t._$adapter,t._$idProperty,t.modelManager),t._initData(e.data),t}return o.__extends(e,r),e.prototype.create=function(e){var t=g(e,this._$adapter);if(void 0===t[this.getIdProperty()])this.rawManager.reserveId();return f.success(this.modelManager.get(t))},e.prototype.read=function(e){var t=this.rawManager.get(e);if(t)return f.success(this.modelManager.get(t));return f.fail('Record with key "'+e+'" does not exist')},e.prototype.update=function(e){var n=this,t=function(e){var t,r=e.getIdProperty?e.getIdProperty():n.getIdProperty();try{t=e.get(r)}catch(e){return f.fail("Record idProperty doesn't exist")}if(void 0===t)t=n.rawManager.reserveId();e.set(r,t);var o=g(e,n._$adapter);return n.rawManager.set(t,o),e.acceptChanges(),t},r=[];if(e instanceof p.RecordSet)e.each(function(e){r.push(t(e))});else r.push(t(e));return f.success(r)},e.prototype.destroy=function(e){var t;if(!this.rawManager.existKeys(e))return f.fail("Not all keys exist");return this.rawManager.remove(e),f.success(true)},e.prototype.query=function(e){if(void 0===e)e=new i.default;for(var t=[],r=this.rawManager.getKeys(),o=0;o<r.length;o++)t.push(this.rawManager.get(r[o]));var n=new w(e);return t=n.order(t),t=n.where(t),t=n.offset(t),t=n.limit(t),t=n.select(t),f.success(this._getDataSet({items:this.converter.get(t),meta:{total:t.length}}))},e.prototype.merge=function(e,t){var r=this.rawManager.get(e),o=this.rawManager.get(t);if(null===r||null===o)return f.fail("Record with key "+e+" or "+t+" isn't exists");var n=s(r,o);return this.rawManager.set(e,n),this.rawManager.remove(t),f.success(true)},e.prototype.copy=function(e){var t=this.rawManager.reserveId(),r=this.rawManager.get(e);if(null===r)return f.fail("Record with key "+r+" isn't exists");var o=s({},r);return this.rawManager.set(t,o),f.success(this.modelManager.get(o))},e.prototype.move=function(r,e,t){var o=this.rawManager.getKeys(),n=[];if(!(r instanceof Array))r=[r];if(r.forEach(function(e){var t;if(-1===o.indexOf(e))return f.fail('Record "from" with key '+r+" is not found.");n.push(e)}),"on"===t.position)return f.success(this._hierarchyMove(n,e,t,o));return f.success(this.rawManager.move(n,e,t))},e.prototype.getIdProperty=function(){return this._$idProperty},e.prototype.setIdProperty=function(e){throw new Error("Method is not supported")},e.prototype.getAdapter=function(){return a.create(this._$adapter)},e.prototype.getListModule=function(){return this._$listModule},e.prototype.setListModule=function(e){this._$listModule=e},e.prototype.getModel=function(){return this._$model},e.prototype.setModel=function(e){this._$model=e},e.prototype._initData=function(e){var t=this;if(!e)return;if(h(this._$adapter))return void l(this,e);for(var r=this.getAdapter().forTable(e),o=function(e){t.update(e)},n=0;n<r.getCount();n++){var i=r.at(n);this.create(i).addCallback(o)}},e.prototype._getDataSet=function(e){return a.create(this._dataSetModule,s({writable:this._writable,adapter:this.getAdapter(),model:this.getModel(),listModule:this.getListModule(),idProperty:this.getIdProperty()},{rawData:e,itemsProperty:this._dataSetItemsProperty,metaProperty:this._dataSetMetaProperty},{rec:false}))},e.prototype._hierarchyMove=function(e,t,r,o){var n=this,i,a;if(!r.parentProperty)return f.fail("Parent property is not defined");if(t){if(-1===(i=o.indexOf(t)))return f.fail('Record "to" with key '+t+" is not found.");var s=this.rawManager.get(o[i]);a=s[r.parentProperty]}else a=null;e.forEach(function(e){var t=n.rawManager.get(e);t[r.parentProperty]=a,n.rawManager.set(e,t)})},e.prototype._reorderMove=function(e,t,r,o){var n;if(e.forEach(function(e){var t=o.indexOf(e);o.splice(t,1)}),null!==t)if(-1===(n=o.indexOf(t)))return f.fail('Record "to" with key '+t+" is not found.");var i=r&&(r.before||"before"===r.position)?0:1;e.forEach(function(e,t){o.splice(n+i+t,0,e)}),this.rawManager.setKeys(o)},e}(r.mixin(u.DestroyableMixin,u.OptionsToPropertyMixin));(t.default=_).prototype._moduleName="Types/source:LocalSession",_.prototype["[Types/_source/LocalSession]"]=true,_.prototype._writable=u.ReadWriteMixin.writable,_.prototype._dataSetModule="Types/source:DataSet",_.prototype._$adapter="Types/entity:adapter.Json",_.prototype._$listModule="Types/collection:RecordSet",_.prototype._$model="Types/entity:Model",_.prototype._$idProperty="",_.prototype._dataSetItemsProperty="items",_.prototype._dataSetMetaProperty="meta",_.prototype._options={prefix:"",model:u.Model,data:[]},a.register("Types/source:LocalSession",_,{instantiate:false})});