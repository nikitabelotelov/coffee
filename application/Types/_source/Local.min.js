define("Types/_source/Local",["require","exports","tslib","Types/_source/Base","Types/_source/DataMixin","Types/_source/DataCrudMixin","Types/util","Core/Deferred","Core/helpers/Number/randomId"],function(e,t,n,r,i,o,a,p,u){"use strict";Object.defineProperty(t,"__esModule",{value:true});var l="on",s="before",d="after";function f(e,t,r){if(t instanceof Array){for(var n=0;n<t.length;n++)if(f(e,t[n],r))return true;return false}if(e instanceof Array){for(var n=0;n<e.length;n++)if(!f(e[n],t,r))return false;return true}return e==t}var c=function(r){function e(e){var t=r.call(this,e)||this;return t["[Types/_source/ICrud]"]=true,t["[Types/_source/ICrudPlus]"]=true,t._reIndex(),t}return n.__extends(e,r),Object.defineProperty(e.prototype,"data",{get:function(){return this._getTableAdapter().getData()},enumerable:true,configurable:true}),e.prototype.create=function(e){var t=this;return e=a.object.clonePlain(e,true),this._loadAdditionalDependencies().addCallback(function(){return t._prepareCreateResult(e)})},e.prototype.read=function(e,t){var r=this,n=this._getRecordByKey(e);if(n)return this._loadAdditionalDependencies().addCallback(function(){return r._prepareReadResult(n)});else return p.fail('Record with key "'+e+'" does not exist')},e.prototype.update=function(e,t){var o=this,r=function(e){var t=o.getIdProperty(),r=t?e.get(t):void 0;if(void 0===r)r=u("k"),e.set(t,r);var n=o._getTableAdapter(),i=o._getIndexByKey(r);if(-1===i){if(n.add(e.getRawData()),o._index)o._index[r]=n.getCount()-1}else n.replace(e.getRawData(),i);return r},n=[];if(i.default.isListInstance(e))e.each(function(e){n.push(r(e))});else n=r(e);return this._loadAdditionalDependencies().addCallback(function(){return o._prepareUpdateResult(e,n)})},e.prototype.destroy=function(e,t){var r=this,n=function(e){var t=r._getIndexByKey(e);if(-1!==t)return r._getTableAdapter().remove(t),r._reIndex(),true;else return false};if(!(e instanceof Array))e=[e];for(var i=0,o=e.length;i<o;i++)if(!n(e[i]))return p.fail('Record with key "'+e[i]+'" does not exist');return p.success(true)},e.prototype.query=function(e){var t=this,r=this._applyFrom(e?e.getFrom():void 0),n=this.getAdapter(),i;if(e)r=this._applyJoin(r,e.getJoin()),r=this._applyWhere(r,e.getWhere(),e.getMeta()),r=this._applyOrderBy(r,e.getOrderBy()),i=n.forTable(r).getCount(),r=this._applyPaging(r,e.getOffset(),e.getLimit());else if(this._$filter)r=this._applyWhere(r);else i=n.forTable(r).getCount();return this._loadAdditionalDependencies().addCallback(function(){return t._prepareQueryResult({items:r,meta:{total:i}},e)})},e.prototype.merge=function(e,t){var r=this._getIndexByKey(e),n=this._getIndexByKey(t);if(-1===r||-1===n)return p.fail('Record with key "'+e+'" or "'+t+'" does not exist');else return this._getTableAdapter().merge(r,n,this.getIdProperty()),this._reIndex(),p.success(true)},e.prototype.copy=function(e,t){var r=this,n=this._getIndexByKey(e);if(-1===n)return p.fail('Record with key "'+e+'" does not exist');else{var i=this._getTableAdapter().copy(n);return this._reIndex(),this._loadAdditionalDependencies().addCallback(function(){return r._prepareReadResult(i)})}},e.prototype.move=function(e,t,i){var o=this;i=i||{};var r=[];if(!(e instanceof Array))e=[e];var n=this._getTableAdapter(),a=this.getAdapter();e.sort(function(e,t){var r=o._getIndexByKey(e),n=o._getIndexByKey(t);return i.position===d?n-r:r-n}).forEach(function(e){var t=o._getIndexByKey(e);r.push(a.forRecord(n.at(t)))});var u=-1,s=null;if(null!==t)if(u=this._getIndexByKey(t),s=a.forRecord(n.at(u)),-1===u)return p.fail("Can't find target position");if(i.position===l)return this._hierarchyMove(r,s,i);return this._reorderMove(r,s,i)},e.prototype._wrapToDataSet=function(e){return r.prototype._wrapToDataSet.call(this,a.object.clonePlain(e,true))},e.prototype._prepareCreateResult=function(e){return o.default._prepareCreateResult.call(this,a.object.clonePlain(e,true))},e.prototype._prepareReadResult=function(e){return o.default._prepareReadResult.call(this,a.object.clonePlain(e,true))},e.prototype._getRecordByKey=function(e){return this._getTableAdapter().at(this._getIndexByKey(e))},e.prototype._getIndexByKey=function(e){var t=this._index[e];return void 0===t?-1:t},e.prototype._reIndex=function(){var n=this;this._index={};var i=this.getAdapter();this._each(this.data,function(e,t){var r=i.forRecord(e).get(n._$idProperty);n._index[r]=t})},e.prototype._applyWhere=function(e,n,t){var i=this;if(n=n||{},!this._$filter&&"object"===typeof n&&!Object.keys(n).length)return e;var o=function(e,t){var r=true;for(var n in e){if(!e.hasOwnProperty(n))continue;if(!(r=f(t.get(n),e[n],"=")))break}return r},a=this.getAdapter(),u=a.forTable(),s="function"===typeof n;return this._each(e,function(e,t){e=a.forRecord(e);var r=true;if(i._$filter)r=i._$filter(e,n);else r=s?n(e,t):o(n,e);if(r)u.add(e.getData())}),u.getData()},e.prototype._applyOrderBy=function(e,t){if(!(t=t||[]).length)return e;for(var o=[],r=0;r<t.length;r++)o.push({field:t[r].getSelector(),order:t[r].getOrder()});var a=this.getAdapter(),u=[];this._each(e,function(e,t){for(var r,n=[],i=0;i<o.length;i++)r=a.forRecord(e).get(o[i].field),n.push(void 0===r?null:r);u.push({index:t,values:n})});var i=function(e,t){if(null===e&&null!==t)return-1;if(null!==e&&null===t)return 1;if(e==t)return 0;return e>t?1:-1};u.sort(function(e,t){for(var r=0,n=0;n<o.length;n++)if(0!==(r=(o[n].order?-1:1)*i(e.values[n],t.values[n])))break;return r});for(var n=a.forTable(e),s=a.forTable(),r=0,p=u.length;r<p;r++)s.add(n.at(u[r].index));return s.getData()},e.prototype._applyPaging=function(e,t,r){if(0===(t=t||0)&&void 0===r)return e;var n=this.getAdapter().forTable(e);if(void 0===r)r=n.getCount();else r=r||0;for(var i=this.getAdapter().forTable(),o=0,a=t,u=Math.min(n.getCount(),a+r),s=a;s<u;s++,o++)i.add(n.at(s));return i.getData()},e.prototype._reorderMove=function(e,t,n){var i=this,o;if(n.parentProperty)o=t.get(n.parentProperty);if(!n.position&&n.hasOwnProperty("before"))n.position=n.before?s:d;var a=this._getTableAdapter(),u=t.get(this._$idProperty);return e.forEach(function(e){if(n.parentProperty)e.set(n.parentProperty,o);var t=i._getIndexByKey(e.get(i._$idProperty)),r=i._getIndexByKey(u);if(n.position===s&&r>t)r--;else if(n.position===d&&r<t)r++;a.move(t,r),i._reIndex()}),(new p).callback()},e.prototype._hierarchyMove=function(e,t,r){if(!r.parentProperty)return p.fail("Parent property is not defined");var n=t?t.get(this._$idProperty):null;return e.forEach(function(e){e.set(r.parentProperty,n)}),(new p).callback()},e}(a.mixin(r.default,o.default));t.default=c,Object.assign(c.prototype,{"[Types/_source/Local]":true,_moduleName:"Types/source:Local",_$filter:null,_index:null})});