define("Types/_source/Local",["require","exports","tslib","Types/_source/Base","Types/_source/DataMixin","Types/_source/DataCrudMixin","Types/util","Core/Deferred","Core/helpers/Number/randomId"],function(e,t,n,r,o,i,a,s,u){"use strict";Object.defineProperty(t,"__esModule",{value:true});var l="on",p="before",d="after";function f(e,t,r){if(t instanceof Array){for(var n=0;n<t.length;n++)if(f(e,t[n],r))return true;return false}if(e instanceof Array){for(var n=0;n<e.length;n++)if(!f(e[n],t,r))return false;return true}return e==t}var c=function(r){function e(e){var t=r.call(this,e)||this;return t["[Types/_source/ICrud]"]=true,t["[Types/_source/ICrudPlus]"]=true,t._reIndex(),t}return n.__extends(e,r),Object.defineProperty(e.prototype,"_data",{get:function(){return this._getTableAdapter().getData()},enumerable:true,configurable:true}),e.prototype.create=function(e){var t=this;return e=a.object.clonePlain(e,true),this._loadAdditionalDependencies().addCallback(function(){return t._prepareCreateResult(e)})},e.prototype.read=function(e,t){var r=this,n=this._getRecordByKey(e);if(n)return this._loadAdditionalDependencies().addCallback(function(){return r._prepareReadResult(n)});else return s.fail('Record with key "'+e+'" does not exist')},e.prototype.update=function(e,t){var i=this,r=function(e){var t=i.getIdProperty(),r=t?e.get(t):void 0;if(void 0===r)r=u("k"),e.set(t,r);var n=i._getTableAdapter(),o=i._getIndexByKey(r);if(-1===o){if(n.add(e.getRawData()),i._index)i._index[r]=n.getCount()-1}else n.replace(e.getRawData(),o);return r},n=[];if(o.default.isListInstance(e))e.each(function(e){n.push(r(e))});else n=r(e);return this._loadAdditionalDependencies().addCallback(function(){return i._prepareUpdateResult(e,n)})},e.prototype.destroy=function(e,t){var r=this,n=function(e){var t=r._getIndexByKey(e);if(-1!==t)return r._getTableAdapter().remove(t),r._reIndex(),true;else return false};if(!(e instanceof Array))e=[e];for(var o=0,i=e.length;o<i;o++)if(!n(e[o]))return s.fail('Record with key "'+e[o]+'" does not exist');return s.success(true)},e.prototype.query=function(e){var t=this,r=this._applyFrom(e?e.getFrom():void 0),n=this.getAdapter(),o;if(e)r=this._applyJoin(r,e.getJoin()),r=this._applyWhere(r,e.getWhere()),r=this._applyOrderBy(r,e.getOrderBy()),o=n.forTable(r).getCount(),r=this._applyPaging(r,e.getOffset(),e.getLimit());else if(this._$filter)r=this._applyWhere(r);else o=n.forTable(r).getCount();return this._loadAdditionalDependencies().addCallback(function(){return t._prepareQueryResult({items:r,meta:{total:o}},e)})},e.prototype.merge=function(e,t){var r=this._getIndexByKey(e),n=this._getIndexByKey(t);if(-1===r||-1===n)return s.fail('Record with key "'+e+'" or "'+t+'" does not exist');else return this._getTableAdapter().merge(r,n,this.getIdProperty()),this._reIndex(),s.success(true)},e.prototype.copy=function(e,t){var r=this,n=this._getIndexByKey(e);if(-1===n)return s.fail('Record with key "'+e+'" does not exist');else{var o=this._getTableAdapter().copy(n);return this._reIndex(),this._loadAdditionalDependencies().addCallback(function(){return r._prepareReadResult(o)})}},e.prototype.move=function(e,t,o){var i=this;o=o||{};var r=[];if(!(e instanceof Array))e=[e];var n=this._getTableAdapter(),a=this.getAdapter();e.sort(function(e,t){var r=i._getIndexByKey(e),n=i._getIndexByKey(t);return o.position==d?n-r:r-n}).forEach(function(e){var t=i._getIndexByKey(e);r.push(a.forRecord(n.at(t)))});var u=-1,p=null;if(null!==t)if(u=this._getIndexByKey(t),p=a.forRecord(n.at(u)),-1===u)return s.fail("Can't find target position");if(o.position===l)return this._hierarchyMove(r,p,o);return this._reorderMove(r,p,o)},e.prototype._wrapToDataSet=function(e){return r.prototype._wrapToDataSet.call(this,a.object.clonePlain(e,true))},e.prototype._prepareCreateResult=function(e){return i.default._prepareCreateResult.call(this,a.object.clonePlain(e,true))},e.prototype._prepareReadResult=function(e){return i.default._prepareReadResult.call(this,a.object.clonePlain(e,true))},e.prototype._getRecordByKey=function(e){return this._getTableAdapter().at(this._getIndexByKey(e))},e.prototype._getIndexByKey=function(e){var t=this._index[e];return void 0===t?-1:t},e.prototype._reIndex=function(){var n=this;this._index={};var o=this.getAdapter();this._each(this._data,function(e,t){var r=o.forRecord(e).get(n._$idProperty);n._index[r]=t})},e.prototype._applyWhere=function(e,n){var o=this;if(n=n||{},!this._$filter&&"object"===typeof n&&!Object.keys(n).length)return e;var i=function(e,t){var r=true;for(var n in e){if(!e.hasOwnProperty(n))continue;if(!(r=f(t.get(n),e[n],"=")))break}return r},a=this.getAdapter(),u=a.forTable(),p="function"===typeof n;return this._each(e,function(e,t){e=a.forRecord(e);var r=true;if(o._$filter)r=o._$filter(e,n);else r=p?n(e,t):i(n,e);if(r)u.add(e.getData())}),u.getData()},e.prototype._applyOrderBy=function(e,t){if(!(t=t||[]).length)return e;for(var i=[],r=0;r<t.length;r++)i.push({field:t[r].getSelector(),order:t[r].getOrder()});var a=this.getAdapter(),u=[];this._each(e,function(e,t){for(var r,n=[],o=0;o<i.length;o++)r=a.forRecord(e).get(i[o].field),n.push(void 0===r?null:r);u.push({index:t,values:n})});var o=function(e,t){if(null===e&&null!==t)return-1;if(null!==e&&null===t)return 1;if(e==t)return 0;return e>t?1:-1};u.sort(function(e,t){for(var r=0,n=0;n<i.length;n++)if(0!==(r=(i[n].order?-1:1)*o(e.values[n],t.values[n])))break;return r});for(var n=a.forTable(e),p=a.forTable(),r=0,s=u.length;r<s;r++)p.add(n.at(u[r].index));return p.getData()},e.prototype._applyPaging=function(e,t,r){if(0===(t=t||0)&&void 0===r)return e;var n=this.getAdapter().forTable(e);if(void 0===r)r=n.getCount();else r=r||0;for(var o=this.getAdapter().forTable(),i=0,a=t,u=Math.min(n.getCount(),a+r),p=a;p<u;p++,i++)o.add(n.at(p));return o.getData()},e.prototype._reorderMove=function(e,t,n){var o=this,i;if(n.parentProperty)i=t.get(n.parentProperty);if(!n.position&&n.hasOwnProperty("before"))n.position=n.before?p:d;var a=this._getTableAdapter(),u=t.get(this._$idProperty);return e.forEach(function(e){if(n.parentProperty)e.set(n.parentProperty,i);var t=o._getIndexByKey(e.get(o._$idProperty)),r=o._getIndexByKey(u);if(n.position===p&&r>t)r--;else if(n.position===d&&r<t)r++;a.move(t,r),o._reIndex()}),(new s).callback()},e.prototype._hierarchyMove=function(e,t,r){if(!r.parentProperty)return s.fail("Parent property is not defined");var n=t?t.get(this._$idProperty):null;return e.forEach(function(e){e.set(r.parentProperty,n)}),(new s).callback()},e}(a.mixin(r.default,i.default));(t.default=c).prototype._moduleName="Types/source:Local",c.prototype["[Types/_source/Local]"]=true,c.prototype._$filter=null,c.prototype._index=null});