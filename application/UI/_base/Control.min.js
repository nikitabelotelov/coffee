define("UI/_base/Control",["require","exports","wml!UI/_base/Control","Core/IoC","Core/helpers/Hcontrol/doAutofocus","Vdom/Vdom","View/Executor/Utils","View/Executor/Expressions","Core/Themes/ThemesControllerNew","Core/PromiseLib/PromiseLib","View/Logger"],function(a,t,e,h,f,p,l,u,r,c,_){"use strict";Object.defineProperty(t,"__esModule",{value:true});var d=1,n=function(){function s(t){var e=this;if(this._mounted=false,this._unmounted=false,this._destroyed=false,this._active=false,this._options=null,this._internalOptions=null,this._container=null,this._context=null,this.context=null,this.saveFullContext=null,this._saveContextObject=null,this._saveEnvironment=null,this.saveInheritOptions=null,this._getEnvironment=null,this._notify=null,this._forceUpdate=null,this._getMarkup=null,this.render=null,this._children=null,this._styles=[],this._theme=[],!t)t={};var u=null,n=null;this.saveFullContext=function(t){u=t},this._saveContextObject=function(t){n=t,e._context=t},this.context={get:function(t){if(n&&n.hasOwnProperty(t))return n[t];return null},set:function(){throw new Error("Can't set data to context. Context is readonly!")},has:function(){return true}};var o=null,c=null,i=null;this.saveInheritOptions=function(t){c=t},this._saveEnvironment=function(t,e){o=e,i=t},this._getEnvironment=function(){return i},this._notify=function(){return i&&i.startEvent(o,arguments)},this._forceUpdate=function(){var t=e||o&&o.control;if(t&&!t._mounted)t._$needForceUpdate=true;else i&&i.forceRebuild(o.id)},this._getMarkup=function t(e,n,o,i){if(!this._template.stable)return h.resolve("ILogger").error(this._moduleName,"Check what you put in _template"),"";var r;if(void 0===i)i=true;if(!o)o={};for(var s in o.context=u,o.inheritOptions=c,o.events)if(o.events.hasOwnProperty(s))for(var a=0;a<o.events[s].length;a++)if(o.events[s][a].fn.isControlEvent&&!o.events[s][a].fn.controlDestination)o.events[s][a].fn.controlDestination=this;if(r=this._template(this,o,e,i)){if(i)for(var l=0;l<r.length;l++)if(r[l])return r[l]}else r="";return r},this.render=function(t,e){var n=this._getMarkup(null,true,e,false);return this._isRendered=true,n},this._options={},this._internalOptions={},this._children={},this._instId="inst_"+d++,this._afterCreate&&this._afterCreate(t)}return s.prototype.getInstanceId=function(){return this._instId},s.prototype.mountToDom=function(t,e,n){if(!this._mounted)this._mounted=true,this._container=t,p.Synchronizer.mountControlToDOM(this,n,e,this._container);if(e)this.saveOptions(e)},s.prototype.saveOptions=function(t,e){if(void 0===e)e=null;if(this._options=t,e)this._container=e.element;return true},s._getInheritOptions=function(t){var e=t.getInheritOptions&&t.getInheritOptions()||{};if(!e.hasOwnProperty("readOnly"))e.readOnly=false;if(!e.hasOwnProperty("theme"))e.theme="";return e},s.createControl=function(t,e,n){var o=l.OptionsResolver.getDefaultOptions(t);l.OptionsResolver.resolveOptions(t,o,e);var i={inheritOptions:{}},r;l.OptionsResolver.resolveInheritOptions(t,i,e,true);try{r=new t(e)}catch(t){r=new s({}),_.default.catchLifeCircleErrors("constructor",t)}return r.saveInheritOptions(i.inheritOptions),r._container=n,u.Focus.patchDom(n,e),r.saveFullContext(u.ContextResolver.wrapContext(r,{asd:123})),r.mountToDom(r._container,e,t),r},s.prototype._setInternalOption=function(t,e){if(!this._internalOptions)this._internalOptions={},h.resolve("ILogger").error("Component with "+(this._options?"name "+this._options.name+" config "+this._options.__$config:"maybe id "+this._$id),"Control.constructor wasn't called");this._internalOptions[t]=e},s.prototype._setInternalOptions=function(t){for(var e in t)if(t.hasOwnProperty(e))this._setInternalOption(e,t[e])},s.prototype._manageStyles=function(t,e){if(!this._checkNewStyles())return true;var n=r.getInstance(),o=this._styles||[],i=this._theme||[];if(e)this._removeOldStyles(n,e,i,[]);return this._loadNewStyles(n,t,i,o)},s.prototype._checkNewStyles=function(){if(this._theme&&!this._theme.forEach||this._style&&!this._style.forEach)return false;return true},s.prototype._loadNewStyles=function(n,o,t,e){var i=this,r=[];if("undefined"===typeof window)e.forEach(function(t){n.pushCss(t)}),t.forEach(function(t){n.pushThemedCss(t,o)});else if(e.forEach(function(e){if(n.isCssLoaded(e))n.pushCssLoaded(e);else{var t=c.reflect(c.wrapTimeout(n.pushCssAsync(e),2e3));t.then(function(t){if("rejected"===t.status)h.resolve("ILogger").error("Styles loading error","Could not load style "+e+" for control "+i._moduleName)}),r.push(t)}}),t.forEach(function(e){if(n.isThemedCssLoaded(e,o))n.pushCssThemedLoaded(e,o);else{var t=c.reflect(c.wrapTimeout(n.pushCssThemedAsync(e,o),2e3));t.then(function(t){if("rejected"===t.status)h.resolve("ILogger").error("Styles loading error","Could not load style "+e+" for control "+i._moduleName+" with theme "+o)}),r.push(t)}}),r.length)return Promise.all(r);return true},s.prototype._removeOldStyles=function(e,n,t,o){o.forEach(function(t){e.removeCss(t)}),t.forEach(function(t){e.removeCssThemed(t,n)})},s.prototype._removeStyles=function(t){if(!this._checkNewStyles())return true;var e=r.getInstance(),n=this._styles||[],o=this._theme||[];this._removeOldStyles(e,t,o,n)},s.prototype.destroy=function(){this._destroyed=true;try{var t=this.constructor.contextTypes?this.constructor.contextTypes():{};for(var e in t)if(t.hasOwnProperty(e))this.context.get(e).unregisterConsumer(this);if(this._mounted)this.__beforeUnmount(),p.Synchronizer.cleanControlDomLink(this._container)}catch(t){_.default.catchLifeCircleErrors("_beforeUnmount",t)}},s.prototype._blur=function(){var t=this._container[0]?this._container[0]:this._container,e=document.activeElement,n;if(!u.Focus.closest(document.activeElement,t))return;if(-1===document.body.tabIndex)n=document.body.tabIndex,document.body.tabIndex=1;if(document.body.focus(),this._active){var o;t.controlNodes[0].environment._handleFocusEvent({target:document.body,relatedTarget:e})}if(void 0!==n)document.body.tabIndex=n},s.prototype.activate=function(){function t(t){var e=false,n=document.activeElement;if(t.wsControl&&t.wsControl.setActive)if(t.wsControl.canAcceptFocus())t.wsControl.setActive(true),e=t.wsControl.isActive();else e=false;else{if(p.TabIndex.getElementProps(t).tabStop)p.TabIndex.focus(t);if(e=t===document.activeElement,t=this._container[0]?this._container[0]:this._container,e&&!this._active){var o;t.controlNodes[0].environment._handleFocusEvent({target:t,relatedTarget:n})}}return e}for(var e=false,n=this._container[0]?this._container[0]:this._container,o=f.findAutofocusForVDOM(n),i,r,s=0;s<o.length;s++)if(i=o[s],!r)if(i&&i.controlNodes&&i.controlNodes.length)r=e=i.controlNodes[0].control.activate();if(!r){var a=p.TabIndex.getElementProps,l=p.TabIndex.findFirstInContext(n,false,a);if(l){var u="vdom-focus-in",c="vdom-focus-out";if(l.classList.contains(u))l=p.TabIndex.findWithContexts(n,l,false,a);if(l.classList.contains(c))l=null}if(l)e=t.call(this,l);else e=t.call(this,n)}return e},s.prototype._afterCreate=function(t){},s.prototype._beforeMount=function(){return Promise.resolve()},s.prototype._beforeMountLimited=function(t){var i=this,r=this._beforeMount.apply(this,arguments);if("undefined"===typeof window)if(r&&r.callback)r=new Promise(function(e,n){var o=0;r.then(function(t){if(!o)o=1,e(t);return t},function(t){if(!o)o=1,n(t);return t}),setTimeout(function(){if(!o)h.resolve("ILogger").error("_beforeMount","Wait 20000 ms "+i._moduleName),o=1,a(["View/Runner/tclosure"],function(r){this._originTemplate=this._template,this._template=function(t,e,n,o,i){try{return this._originTemplate.apply(self,arguments)}catch(t){return r.getMarkupGenerator(o).createText("")}},this._template.stable=true,this._afterMount=function(){},e(false)})},2e4)});var e=this._manageStyles(t.theme);if(e.then)r=Promise.all([e,r]);return r},s.prototype._afterMount=function(){},s.prototype.__beforeUpdate=function(t){if(t.theme!==this._options.theme)this._manageStyles(t.theme,this._options.theme);this._beforeUpdate.apply(this,arguments)},s.prototype._beforeUpdate=function(){},s.prototype._shouldUpdate=function(){return true},s.prototype._afterUpdate=function(){},s.prototype.__beforeUnmount=function(){this._removeStyles(this._options.theme),this._beforeUnmount.apply(this,arguments)},s.prototype._beforeUnmount=function(){},s.isWasaby=true,s}();n.prototype._template=e,t.default=n});