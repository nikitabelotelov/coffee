define("UI/_base/DepsCollector",["require","exports","View/Logger","Env/Env"],function(e,s,o,r){"use strict";Object.defineProperty(s,"__esModule",{value:true});var a={BUNDLE:1,SINGLE:2},t={tmpl:{type:"tmpl",plugin:"tmpl",hasDeps:true,hasPacket:false,canBePackedInParent:true},js:{type:"js",plugin:"",hasDeps:true,hasPacket:true,packOwnDeps:true},wml:{type:"wml",plugin:"wml",hasDeps:true,hasPacket:false,canBePackedInParent:true},css:{type:"css",plugin:"css",hasDeps:false,hasPacket:true},default:{hasDeps:false}};function n(e){var s;if((s=e.split("!")[0])===e)s="";return s}function i(e){var s=n(e);for(var r in t)if(t[r].plugin===s)return t[r];return null}function l(e){return e.replace(/^(\/resources\/|resources\/)+/,"").replace(/\.min\.(css|js)$/,"")}function p(e){var s=e.match(/\.\w+$/);if(s&&s.length)return s[0].slice(1);return r.IoC.resolve("ILogger").error("Incorrect extension: "+e),""}function f(e){return!!~e.indexOf("theme?")}function u(e){var s=i(e),r;if(null===s)return o.log("Wrong type",["Can not process module: "+e]),null;if(s.plugin)r=e.split(s.plugin+"!")[1];else r=e;return{moduleName:r,fullName:e,typeInfo:s}}function c(){var e={};for(var s in t)if(t.hasOwnProperty(s))e[s]={};return e}function h(e,s){var r=c();for(var t in e)if(e.hasOwnProperty(t)){var n=s[t];if(n){var i;o.log("Custom packets logs",["Module "+t+" in bundle "+n]),delete e[t],r[i=p(n)][l(n)]=a.BUNDLE}}for(var t in e)if(e.hasOwnProperty(t)){var i=e[t].typeInfo.type;if(e[t].typeInfo.plugin)r[i][t.split(e[t].typeInfo.plugin+"!")[1]]=a.SINGLE;else r[i][t]=a.SINGLE}return r}function m(e,s,r){var t={themedCss:{},simpleCss:{}};for(var n in e)if(e.hasOwnProperty(n)){var i=s[n];if(i)if(o.log("Custom packets logs",["Module "+n+" in bundle "+i]),delete e[n],f(n)&&r)t.themedCss[l(i)]=a.BUNDLE;else t.simpleCss[l(i)]=a.BUNDLE}for(var n in e)if(e.hasOwnProperty(n))if(f(n))t.themedCss[n.split("theme?")[1]]=a.SINGLE;else t.simpleCss[n.split("css!")[1]]=a.SINGLE;return t}function v(e,s,r){var t=c();return d(t,h(e.js,s)),d(t,h(e.tmpl,s)),d(t,h(e.wml,s)),t.css=m(e.css,s,r),t}function d(e,s){for(var r in s)if(s.hasOwnProperty(r)){if(void 0===e[r])e[r]={};for(var t in s[r])if(s[r].hasOwnProperty(t))e[r][t]=s[r][t]}}function y(e,s,r,t,n){if(s&&s.length)for(var i=0;i<s.length;i++){var o=s[i],a=o.split("!");if("optional"===a[0]&&a.length>1)if(a.shift(),!t[o=a.join("!")])return;var l=u(o);if(l){var p=l.typeInfo.type;if(!e[p])e[p]={};if(!e[p][o]){if(!(n&&!!l.typeInfo.canBePackedInParent))e[p][l.fullName]=l;if(l.typeInfo.hasDeps){var f;y(e,r[o],r,t,!!l.typeInfo.packOwnDeps)}}}}}var w=function(){function e(e,s,r,t){this.modDeps=e,this.modInfo=s,this.bundlesRoute=r,this.themesActive=t}return e.prototype.collectDependencies=function(e){var s={js:[],css:{themedCss:[],simpleCss:[]},tmpl:[],wml:[]},r={};y(r,e,this.modDeps,this.modInfo);var t=v(r,this.bundlesRoute,this.themesActive);for(var n in t.js)if(t.js.hasOwnProperty(n))s.js.push(n);for(var n in t.tmpl)if(t.tmpl.hasOwnProperty(n))s.tmpl.push(n);for(var n in t.wml)if(t.wml.hasOwnProperty(n))s.wml.push(n);for(var n in t.css.themedCss)if(t.css.themedCss.hasOwnProperty(n)){if(!t.js[n]&&t.css.themedCss[n]===a.BUNDLE)s.js.push(n);s.css.themedCss.push(n)}for(var n in t.css.simpleCss)if(t.css.simpleCss.hasOwnProperty(n)){if(!t.js[n]&&t.css.simpleCss[n]===a.BUNDLE)s.js.push(n);s.css.simpleCss.push(n)}return s},e}();s.default=w});