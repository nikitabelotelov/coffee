define("Env/Event",["Env/Constants","Env/Env","require","exports"],function(i,r,s,t){Object.defineProperty(t,"__esModule",{value:true}),t["Env/_Event/Object"]=true;var o=function(){"use strict";var t={},e=function(t,e){Object.defineProperty(e,"__esModule",{value:true});var n=function(){function t(t,e){this._isBubbling=true,this._eventName=null,this._target=null,this.name=this._eventName=t,this._target=e}return t.prototype.cancelBubble=function(){this._isBubbling=false},t.prototype.isBubbling=function(){return this._isBubbling},t.prototype.getResult=function(){return this._result},t.prototype.setResult=function(t){this._result=t},t.prototype.getTarget=function(){return this._target},t}();e.default=n}(s,t);if(e instanceof Function)return e;else for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n];return t}(),e=o;t["Env/_Event/Channel"]=true;var u=function(){"use strict";var t={},e=function(t,e,c,r,n){Object.defineProperty(e,"__esModule",{value:true});var l=!(n.constants.isBrowserPlatform||!n.constants.isBuildOnServer),i=function(){function t(t){if(void 0===t)t={};this._events={},this._eventQueue=[],this._eventsAllowed=false,this._isDestroyed=false,this._onceEvents={},this._notificationQueue={},this._queueSize={},this._waitForPermit=t.waitForPermit||false,this._strictMode=t.strictMode||false,this._name=t.name||"",this.__EbDestroyCallback=t.destroyCallback||function(){},this._subscribeOnPS=t.subscribeOnPS||false,this.publish("onDestroy")}return t.prototype.isDestroyed=function(){return this._isDestroyed},t.prototype.publish=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0,i=arguments.length;n<i;n++){var r=arguments[n];if(r&&!r.charAt)throw new Error(rk("Аргументами функции publish должно быть несколько строк - имён событий"));r=v(r),this._events[r]=this._events[r]||[],this._notificationQueue[r]=this._notificationQueue[r]||[]}return this},t.prototype.setEventQueueSize=function(t,e){var n;if("number"==typeof t)e=t,t="*";if("object"==typeof t){for(var i in t)if(t.hasOwnProperty(i)){var r=t[i];this.setEventQueueSize(i,r)}return}if(t=v(t),this._queueSize[t]=e,"*"==t)n=Object.keys(this._notificationQueue);else n=[t];n.forEach(function(t){if(this._notificationQueue[t]&&this._notificationQueue[t].length>e)this._notificationQueue[t].slice(0,e)},this)},t.prototype._notifyToHandler=function(e,t,n,i){try{if(i=[t].concat(i),n&&(!n.ctx||!n.ctx.isDestroyed||!n.ctx.isDestroyed()))n.fn.apply(n.ctx,i);if(!t.isBubbling()||!this._events)return false}catch(t){r.IoC.resolve("ILogger").error(n.ctx&&n.ctx.describe?n.ctx.describe():"Unknown Object",'Event handler for "'+e+'" returned error: '+t.message,t)}},t.prototype.notify=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var e=new Array(arguments.length-1),i=1;i<arguments.length;i++)e[i-1]=arguments[i];return this._notifyWithTarget(t,void 0,e)},t.prototype.notifyWithTarget=function(t,e){for(var n=new Array(arguments.length-2),i=2;i<arguments.length;i++)n[i-2]=arguments[i];return this._notifyWithTarget(t,e,n)},t.prototype._notifyWithTarget=function(t,e,n){var i=v(t),r,s,o,u,f,h;if(this._waitForPermit&&!this._eventsAllowed)return void this._eventQueue.push(arguments);if(!(h=this._events[i])){if(this._strictMode)throw new Error('Event "'+i+'" have not published yet');h=[],this._events[i]=h}if(0!==(f=h.length)){for(o=i,s=new c.default(i,e),u=0;u<f;u++)if(false===this._notifyToHandler(o,s,h[u],n))break;r=s.getResult()}return this._saveNotification(i,e,n),r},t.prototype._saveNotification=function(t,e,n){var i=this._queueSize[t]||this._queueSize["*"]||0;if(i){var r=this._notificationQueue[t]=this._notificationQueue[t]||[];if(r.length>=i)r.shift();r.push([e,n])}},t.prototype.eventsAllowed=function(){return this._eventsAllowed},t.prototype.allowEvents=function(){if(false===this._eventsAllowed){this._eventsAllowed=true;for(var t=0,e=this._eventQueue.length;t<e;t++)this._notifyWithTarget.apply(this,this._eventQueue[t]);this._eventQueue.length=0}},t.prototype.once=function(t,e,n,i,r){if(l&&!this._subscribeOnPS)return this;function s(){o._unsubscribeFromOnce(t,e,n,s),e.apply(this,arguments)}if(t=v(t),"function"===typeof n)r=i,i=n,n=null;var o=this,u={handler:s.originalFn=e,ctx:n,wrapper:s,fallback:i};if(!this._onceEvents[t])this._onceEvents[t]=[];return this._onceEvents[t].push(u),this.subscribe(t,s,n,i,r)},t.prototype.subscribe=function(r,e,n,i,t){if(l&&!this._subscribeOnPS)return this;var s,o;if(r=v(r),this._isDestroyed)throw new Error("Trying to subscribe event '"+r+"', but EventBusChannel is destroyed");else if(this._strictMode&&!(r in this._events))throw new Error("Event '"+r+"' is not registered");else if("function"===typeof e){if("function"===typeof n)t=i,i=n,n=null;if(i&&"function"===typeof i){var u=this,f=function(){clearTimeout(a)},h=function(t){if(o)return;if(o=true,u.unsubscribe(r,f,n),"function"==typeof e.originalFn)u.unsubscribe(r,e.originalFn,n,i);else u.unsubscribe(r,e,n,i);return t?f():i(),true},a=setTimeout(h,t||2e4);this.once(r,f,n)}if(s={fn:e,ctx:n,fb:i,killFb:h},this._events[r]=this._events[r]||[],this._events[r].push(s),this._notificationQueue[r]&&this._notificationQueue[r].length)this._notificationQueue[r].forEach(function(t){var e=t[0],n=t[1],i=new c.default(r,e);this._notifyToHandler(r,i,s,n)},this);return this}else throw new TypeError("Event '"+r+"' has unexpected handler")},t.prototype._unsubscribeFromOnce=function(t,e,n,i,r){t=v(t);var s,o,u=this._onceEvents[t],f=[];if(!u)return;for(s=0;s<u.length;++s)if((o=u[s]).handler===e&&(!n||o.ctx===n)&&(!i||i===o.wrapper)&&(!r||r===o.fallback))f.push(s);for(s=f.length-1;s>=0;--s)this.unsubscribe(t,u[f[s]].wrapper,n,r),this._onceEvents[t].splice(f[s],1)},t.prototype.unsubscribe=function(t,e,n,i){if(l&&!this._subscribeOnPS)return this;if(t=v(t),!e||"function"!==typeof e)throw new TypeError("Unsubscribe: second argument is not a function");var r=this._strictMode?this._events[t]:this._events[t]=this._events[t]||[];if(r){if("function"===typeof n)i=n,n=null;var s,o,u,f;for(this._unsubscribeFromOnce(t,e,n,null,i),o=0,f=(r=this._events[t]).length;o!==f;o++)if(r[o]["fn"]===e&&(r[o]["ctx"]&&n?r[o]["ctx"]===n:true)&&(r[o]["fb"]&&i?r[o]["fb"]===i:true)){if(r[o]["killFb"]&&r[o]["killFb"](true))continue;for(s=r.slice(0,o),u=++o;o!==f;o++)if(r[o]["fn"]===e&&(r[o]["ctx"]&&n?r[o]["ctx"]===n:true)&&(r[o]["fb"]&&i?r[o]["fb"]===i:true)){if(u!==o)s=s.concat(r.slice(u,o));u=o+1}if(u!==f)s=s.concat(r.slice(u,f));this._events[t]=s;break}return this}else throw new Error("Event '"+t+"' is not registered")},t.prototype.unsubscribeAll=function(){for(var t in this._events)if(this._events.hasOwnProperty(t)&&this._events[t])this._events[t].length=0;this._onceEvents={}},t.prototype.getName=function(){return this._name},t.prototype.destroy=function(){if(this.notifyWithTarget("onDestroy",this),this.unsubscribeAll(),this._name)this.__EbDestroyCallback(this);this._isDestroyed=true},t.prototype.unbind=function(t){return t=v(t),this._events[t]=[],this},t.prototype.hasEvent=function(t){return t=v(t),!this._strictMode||this._events&&!!this._events[t]},t.prototype.getEvents=function(){return Object.keys(this._events)},t.prototype.hasEventHandlers=function(t){return t=v(t),!!this._events[t]&&this._events[t].length>0},t.prototype.getEventHandlers=function(t){return t=v(t),(this._events[t]||[]).map(function(t){return t.fn})},t}();function v(t){if("string"!==typeof t)return t;return t.toLowerCase()}e.default=i}(s,t,o,r,i);if(e instanceof Function)return e;else for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n];return t}(),n=u;t["Env/_Event/Bus"]=true;var f,h=function(){"use strict";var t={},e=function(t,e,n,i,r){var s;function o(t){s.removeChannel(t.getName())}function u(){var e=Date.now(),t,n=2*60*1e3;if(setInterval(function(){var t=Date.now();if(t-e>=n)s.globalChannel().notify("onWakeUp",e);e=t},1260),i.detection.isMobilePlatform)document.addEventListener("visibilitychange",function(){if(!document.hidden)s.globalChannel().notify("onWakeUp",e),e=Date.now()},false)}if(Object.defineProperty(e,"__esModule",{value:true}),e.default=s={_channels:{},channel:function(t,e){if(1==arguments.length&&"object"==typeof t)e=t,t="";if(!t)return new n.default(e);if(t=t.toLowerCase(),!(((e=e||{}).name=t)in this._channels))e["destroyCallback"]=o,this._channels[t]=new n.default(e);return this._channels[t]},removeChannel:function(t){delete this._channels[t.toLowerCase()]},hasChannel:function(t){return void 0!==this._channels[t.toLowerCase()]},globalChannel:function(){return s.channel("global")}},r.constants.isBrowserPlatform)u()}(s,t,u,r,i);if(e instanceof Function)return e;else for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n];return t}();return t.Bus=h.default,t.Channel=n.default,t.Object=e.default,t});